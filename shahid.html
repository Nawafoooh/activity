<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخالفات السلوكية - متوسطة المنذر بن عمرو الأنصاري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        /* ---------- Teachers ---------- */
        const teachersList = [
            'عبدالله بن مطر بن مصلح العمري','محمد بن عماري راضي الزهراني','موفق مرزوق سويرح السحيمي','فواز زايد لافي المهيمزي الرشيدي','فيصل عطالله حويمد الصاعدي','ابراهيم عياد عيد العلوي','عبدالله حمود حامد الحربي','ساير فيصل سعد الله العضيله المطيري','نافع شعوي نافع المطيري','اسامه منور مشعل العوفي','محمد عياد عليثه العوفي','أحمد إبراهيم فخري التركي','أحمد حامد هلال الحربي','نميان علي نميان الحربي','عبدالله صلاح صالح الرحيلى','مشعل بن هليل بن غالب العمري الحربي','علي متعب ناصر العلوي الحربي','سيف عبدالمنعم حمدان العارضي','محمد بن ذعار بن صالح العوفي','فؤاد بن محمد بن حماد العتيبي','حمزة صدقة حمزة اسلام','سلمان صالح أحمد الحارثي','عبيد بن دخيل بن دويهيس العياضي الحربي','عبدالعزيز مفلح نويعم الرويثي','فيصل عواد محمد أبو سلمي','عبدالله بن محمد بن سعيد ال بحران القرني','كاتب مفلح سليمان الرشيدى','حبيب علي نعيس العمري الحربي','ابراهيم عايض عوض الجابري','سلطان عويض معيض السحيمي','عبدالهادي معيض معلا الشاماني','عبدالعزيز عبدالرحمن غلاب المخلفي','سعد طالع حمود الحربي','ناهر مشعل عويد المطيري','موسى غازي سفر الحربي','موسى مسعود عايض الحيسوني','نواف منصور عواد الصبحي','بدر عبدالعزيز شائد السحيمي','فهد عويض عوض الشاماني الحربي','عبدالمجيد عايد خضران الرشيدي','أحمد مطر سليمان الرشيدي'
        ];

        /* ---------- Config ---------- */
        const config = {
            passwords: { principal:'A2030', assistant:'B2030', counselor:'C2030' },
            schoolInfo: { name:'متوسطة المنذر بن عمرو الأنصاري', principal:'خالد المطيري', assistant:'محمد الجابري', counselor:'محمد القحطاني', type:'بنين' },
            grades: ['أول متوسط','ثاني متوسط','ثالث متوسط'],
            sections: ['1','2','3','4','5','6'],
            violationTypes: {
                first:  { label:'مخالفات الدرجة الأولى (درجة واحدة)', items:['التأخر عن الدخول للحصة','إعاقة سير الحصص الدراسية (تناول الأطعمة والمشروبات)','المشروبات أثناء الدرس - المقاطعة المستمرة لشرح المعلمة','النوم داخل الصف','تكرار خروج ودخول الطلابة من البوابة قبل وقت الحضور والانصراف','التجهز أمام بوابة المدرسة'] },
                second: { label:'مخالفات الدرجة الثانية (درجتين)',     items:['عدم حضور الحصة أو الهروب منها','الدخول أو الخروج من الفصل دون استئذان','دخول فصل آخر دون استئذان','إثارة الفوضى داخل الصف'] },
                third:  { label:'مخالفات الدرجة الثالثة (ثلاث درجات)', items:['عدم التقيد بالزي المدرسي','إلحاق الضرر المتعمد بممتلكات الطالبات','العبث بتجهيزات المدرسة (المعمل - أجهزة الحاسب)','امتهان الكتب الدراسية'] }
            }
        };

        /* ---------- Application State ---------- */
        let state = {
            currentUser: { role:'teacher', name:teachersList[0], id:1 },
            authenticated: { principal:false, assistant:false, counselor:false },
            violations: [
                {id:1, studentName:'أحمد محمد علي', grade:'أول متوسط', section:'1', violationType:'first',  violationDetails:'التأخر عن الدخول للحصة',     teacherName:teachersList[0], teacherId:1, date:'2025-10-13', time:'08:30', documentation:'تأخر 15 دقيقة عن الحصة الأولى', status:'active', createdAt:'2025-10-13T08:30:00'},
                {id:2, studentName:'أحمد محمد علي', grade:'أول متوسط', section:'1', violationType:'first',  violationDetails:'النوم داخل الصف',            teacherName:teachersList[1], teacherId:2, date:'2025-10-14', time:'10:15', documentation:'نام أثناء الحصة الثالثة',        status:'active', createdAt:'2025-10-14T10:15:00'},
                {id:3, studentName:'أحمد محمد علي', grade:'أول متوسط', section:'1', violationType:'second', violationDetails:'عدم حضور الحصة أو الهروب منها', teacherName:teachersList[2], teacherId:3, date:'2025-10-14', time:'11:30', documentation:'غاب عن حصة الرياضيات بدون عذر', status:'active', createdAt:'2025-10-14T11:30:00'},
                {id:4, studentName:'خالد عبدالله سعيد', grade:'ثاني متوسط', section:'3', violationType:'first', violationDetails:'إعاقة سير الحصص الدراسية', teacherName:teachersList[3], teacherId:1, date:'2025-10-14', time:'09:00', documentation:'تحدث مع زميله أثناء الشرح', status:'active', createdAt:'2025-10-14T09:00:00'},
                {id:5, studentName:'محمد سعد القحطاني', grade:'ثالث متوسط', section:'2', violationType:'third', violationDetails:'عدم التقيد بالزي المدرسي', teacherName:teachersList[4], teacherId:4, date:'2025-10-12', time:'07:45', documentation:'حضر بدون الزي المدرسي الرسمي', status:'resolved', resolvedBy:'محمد الجابري', resolutionReason:'التزم بالزي المدرسي لمدة أسبوع كامل', resolvedAt:'2025-10-13T12:00:00', createdAt:'2025-10-12T07:45:00'}
            ],
            studentActions: [],
            filters: { selectedTab:'all', searchStudent:'', filterGrade:'', filterSection:'', dateFrom:'', dateTo:'' },
            modals: { showAddForm:false, showDetailsModal:false, selectedViolation:null, showActionModal:false, selectedStudent:null },
            newViolation: { studentName:'', grade:'', section:'', violationType:'first', violationDetails:'', documentation:'', date:new Date().toISOString().split('T')[0], time:new Date().toTimeString().slice(0,5) }
        };

        /* ========== ✅ Absence Data with LocalStorage ========== */
        let absenceRecords = [];

        // ✅ تحميل بيانات الغياب من LocalStorage
        function loadAbsenceFromStorage() {
            try {
                const saved = localStorage.getItem('absenceRecords');
                if (saved) {
                    absenceRecords = JSON.parse(saved);
                    console.log('✅ تم تحميل', absenceRecords.length, 'سجل غياب من LocalStorage');
                    return true;
                }
            } catch (e) {
                console.error('❌ خطأ في تحميل الغياب:', e);
            }
            return false;
        }

        // ✅ تحميل البيانات عند فتح الصفحة
        loadAbsenceFromStorage();

        // ✅ تحديث تلقائي كل 3 ثواني للوكيل فقط
        setInterval(() => {
            if (state.currentUser.role === 'assistant') {
                const updated = loadAbsenceFromStorage();
                if (updated) {
                    render();
                }
            }
        }, 3000);

        window.addEventListener('message', e => {
            if (e.data && e.data.type === 'absenceData') {
                absenceRecords = e.data.payload || [];
                if (state.currentUser.role === 'assistant') render();
            }
        });

        /* ---------- Utility ---------- */
        function getStudentViolationCount(studentName, teacherId = null, status = 'active') {
            return state.violations.filter(v => v.studentName === studentName && (teacherId === null || v.teacherId === teacherId) && (status === 'all' || v.status === status)).length;
        }
        function getStudentsByViolationCount() {
            const map = {};
            state.violations.filter(v => v.status === 'active').forEach(v => {
                const key = `${v.studentName}_${v.teacherId}`;
                if (!map[key]) map[key] = { name:v.studentName, grade:v.grade, section:v.section, teacherId:v.teacherId, teacherName:v.teacherName, count:0, violations:[] };
                map[key].count++; map[key].violations.push(v);
            });
            return Object.values(map).filter(s => s.count >= 3).sort((a,b) => b.count - a.count);
        }
        function getDegreeLabel(type) { const m = {first:'درجة أولى', second:'درجة ثانية', third:'درجة ثالثة'}; return m[type] || type; }
        function getDegreeColor(type) { const m = {first:'bg-green-100 text-green-800 border-green-200', second:'bg-yellow-100 text-yellow-800 border-yellow-200', third:'bg-red-100 text-red-800 border-red-200'}; return m[type] || 'bg-gray-100 text-gray-800'; }
        function getRoleLabel(role) { const m = {teacher:'المعلم', assistant:'الوكيل', counselor:'الموجه الطلابي', principal:'المدير'}; return m[role]; }

        function getFilteredViolations() {
            let f = [...state.violations];
            if (state.currentUser.role === 'teacher') f = f.filter(v => v.teacherId === state.currentUser.id);
            else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                const sw = getStudentsByViolationCount(); const stp = sw.map(s => `${s.name}_${s.teacherId}`);
                f = f.filter(v => stp.includes(`${v.studentName}_${v.teacherId}`));
            }
            if (state.filters.selectedTab === 'active')   f = f.filter(v => v.status === 'active');
            if (state.filters.selectedTab === 'resolved') f = f.filter(v => v.status === 'resolved');
            if (state.filters.searchStudent.trim())       f = f.filter(v => v.studentName.includes(state.filters.searchStudent.trim()));
            if (state.filters.filterGrade)                f = f.filter(v => v.grade === state.filters.filterGrade);
            if (state.filters.filterSection)              f = f.filter(v => v.section === state.filters.filterSection);
            if (state.filters.dateFrom)                   f = f.filter(v => v.date >= state.filters.dateFrom);
            if (state.filters.dateTo)                     f = f.filter(v => v.date <= state.filters.dateTo);
            return f;
        }
        function getStats() {
            let v = [...state.violations];
            if (state.currentUser.role === 'teacher') v = v.filter(i => i.teacherId === state.currentUser.id);
            else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                const sw = getStudentsByViolationCount(); const stp = sw.map(s => `${s.name}_${s.teacherId}`);
                v = v.filter(i => stp.includes(`${i.studentName}_${i.teacherId}`));
            }
            const active = v.filter(i => i.status === 'active').length;
            const resolved = v.filter(i => i.status === 'resolved').length;
            const today = v.filter(i => i.date === new Date().toISOString().split('T')[0]).length;
            let suw = 0;
            if (state.currentUser.role === 'teacher') suw = getMyStudentsUnderWatch().length;
            else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') suw = getStudentsByViolationCount().length;
            else suw = getStudentsByViolationCount().length;
            return { active, resolved, studentsUnderWatch: suw, today };
        }
        function getMyStudentsUnderWatch() {
            const m = {};
            state.violations.filter(i => i.status === 'active' && i.teacherId === state.currentUser.id).forEach(v => {
                if (!m[v.studentName]) m[v.studentName] = { name:v.studentName, grade:v.grade, section:v.section, count:0, violations:[] };
                m[v.studentName].count++; m[v.studentName].violations.push(v);
            });
            return Object.values(m).filter(s => s.count >= 3).sort((a,b) => b.count - a.count);
        }
        function canResolveViolation(violation) {
            if (state.currentUser.role === 'principal') return true;
            if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') return getStudentViolationCount(violation.studentName, violation.teacherId) >= 3;
            if (state.currentUser.role === 'teacher') return violation.teacherId === state.currentUser.id;
            return false;
        }

        /* ---------- Actions ---------- */
        function setCurrentUser(role, name, id) {
            if (role === 'principal' || role === 'assistant' || role === 'counselor') {
                if (!state.authenticated[role]) {
                    const pw = prompt(`🔒 يرجى إدخال كلمة السر لصفحة ${getRoleLabel(role)}:`);
                    if (pw !== config.passwords[role]) { alert('❌ كلمة السر غير صحيحة!'); return; }
                    state.authenticated[role] = true; alert(`✅ تم تسجيل الدخول بنجاح إلى صفحة ${getRoleLabel(role)}`);
                }
            }
            if (role === 'teacher' && !name) name = teachersList[0];
            state.currentUser = { role, name, id }; 
            
            // ✅ تحديث بيانات الغياب عند تغيير المستخدم
            if (role === 'assistant') {
                loadAbsenceFromStorage();
            }
            
            render();
        }
        function setFilter(k, v) { state.filters[k] = v; render(); }
        function clearFilters() {
            state.filters = { selectedTab: state.filters.selectedTab, searchStudent:'', filterGrade:'', filterSection:'', dateFrom:'', dateTo:'' };
            render();
        }
        function openAddForm() { state.modals.showAddForm = true; render(); }
        function closeAddForm() {
            state.modals.showAddForm = false;
            state.newViolation = { studentName:'', grade:'', section:'', violationType:'first', violationDetails:'', documentation:'', date:new Date().toISOString().split('T')[0], time:new Date().toTimeString().slice(0,5) };
            render();
        }
        function addViolation() {
            const {studentName, grade, section, violationType, violationDetails, documentation, date, time} = state.newViolation;
            if (!studentName.trim() || !grade || !section || !violationDetails || !documentation.trim()) { alert('⚠️ يرجى ملء جميع الحقول المطلوبة'); return false; }
            state.violations.unshift({ id:Math.max(0, ...state.violations.map(i=>i.id)) + 1, studentName:studentName.trim(), grade, section, violationType, violationDetails, documentation:documentation.trim(), date, time, teacherName:state.currentUser.name, teacherId:state.currentUser.id, status:'active', createdAt:new Date().toISOString() });
            const c = getStudentViolationCount(studentName.trim(), state.currentUser.id);
            alert(`✅ تم إضافة المخالفة بنجاح!\n👤 الطالب: ${studentName}\n📚 الصف: ${grade} - الشعبة ${section}\n⚠️ المخالفة: ${violationDetails}\n📝 الإجراء المتبع: ${documentation}${c >= 3 ? `\n\n🚨 تنبيه: هذا الطالب لديه ${c} مخالفات منك!\nسيتم إحالته للوكيل/المرشد الطلابي للمتابعة.` : ''}`);
            closeAddForm(); return true;
        }
        function resolveViolation(violationId) {
            const reason = prompt('أدخل سبب حل المخالفة (السلوك الإيجابي الذي قام به الطالب):');
            if (reason && reason.trim()) {
                state.violations = state.violations.map(v => v.id === violationId ? {...v, status:'resolved', resolutionReason:reason.trim(), resolvedBy:state.currentUser.name, resolvedAt:new Date().toISOString()} : v);
                render();
            }
        }
        function openDetailsModal(v) { state.modals.selectedViolation = v; state.modals.showDetailsModal = true; render(); }
        function closeDetailsModal() { state.modals.showDetailsModal = false; state.modals.selectedViolation = null; render(); }
        function openActionModal(studentData) { state.modals.showActionModal = true; state.modals.selectedStudent = studentData; render(); }
        function closeActionModal() { state.modals.showActionModal = false; state.modals.selectedStudent = null; render(); }
        function saveStudentAction() {
            const details = document.getElementById('actionDetailsInput')?.value.trim();
            if (!details) { alert('⚠️ يرجى إدخال تفاصيل الإجراء المتخذ'); return; }
            const student = state.modals.selectedStudent;
            state.studentActions.push({ id:Math.max(0, ...state.studentActions.map(a=>a.id||0)) + 1, studentName:student.name, actionBy:state.currentUser.role, actionByName:state.currentUser.name, actionDate:new Date().toISOString(), actionDetails:details, violationsIncluded:student.violations.map(v=>v.id) });
            alert('✅ تم حفظ الإجراء بنجاح!'); closeActionModal();
        }

        function printStudentReport(studentData) {
            const student = studentData; const action = state.studentActions.find(a => a.studentName === student.name && a.actionBy === state.currentUser.role);
            const pw = window.open('', '_blank');
            pw.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head><meta charset="UTF-8"><title>تقرير مخالفات - ${student.name}</title>
                <style>@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
                body{font-family:'Cairo',sans-serif;padding:40px;direction:rtl}
                .header{text-align:center;border-bottom:3px solid #2563eb;padding-bottom:20px;margin-bottom:30px}
                .header h1{color:#1e40af;margin:10px 0}.info-box{background:#f3f4f6;padding:20px;border-radius:8px;margin-bottom:20px}
                .info-row{display:flex;justify-content:space-between;margin-bottom:10px}
                .violation-item{border:2px solid #e5e7eb;padding:15px;margin-bottom:15px;border-radius:8px}
                .action-box{background:#dbeafe;border:2px solid #2563eb;padding:20px;border-radius:8px;margin-top:30px}
                .signature-area{margin-top:50px;display:flex;justify-content:space-between}
                .signature-box{text-align:center;width:200px}.signature-line{border-top:2px solid #000;margin-top:60px;padding-top:10px}
                @media print{body{padding:20px}.no-print{display:none}}
                </style></head><body>
                <div class="header"><h1>📚 ${config.schoolInfo.name}</h1><h2>تقرير المخالفات السلوكية</h2><p>التاريخ: ${new Date().toLocaleDateString('ar-SA')}</p></div>
                <div class="info-box"><h3 style="color:#1e40af;margin-bottom:15px">معلومات الطالب</h3>
                <div class="info-row"><strong>الاسم:</strong><span>${student.name}</span></div>
                <div class="info-row"><strong>الصف:</strong><span>${student.grade}</span></div>
                <div class="info-row"><strong>الشعبة:</strong><span>${student.section}</span></div>
                <div class="info-row"><strong>عدد المخالفات:</strong><span style="color:#dc2626;font-weight:bold">${student.count} مخالفات</span></div></div>
                <h3 style="color:#1e40af;margin-top:30px;margin-bottom:15px">تفاصيل المخالفات:</h3>
                ${student.violations.map((v,i)=>`
                <div class="violation-item">
                    <div style="font-weight:bold;margin-bottom:10px">${i+1}. ${v.violationDetails}
                    <span style="background:${v.violationType==='first'?'#dcfce7':v.violationType==='second'?'#fef3c7':'#fee2e2'};padding:4px 12px;border-radius:20px;font-size:12px;margin-right:10px">${getDegreeLabel(v.violationType)}</span></div>
                    <div style="color:#6b7280;font-size:14px"><div>📅 التاريخ: ${v.date} | 🕐 الوقت: ${v.time}</div><div>👨‍🏫 المعلم: ${v.teacherName}</div>${v.documentation?`<div style="margin-top:8px">📝 ${v.documentation}</div>`:''}</div>
                </div>`).join('')}
                ${action?`
                <div class="action-box"><h3 style="color:#1e40af;margin-bottom:15px">الإجراء المتخذ من قبل ${getRoleLabel(action.actionBy)}</h3>
                <div style="margin-bottom:10px"><strong>المسؤول:</strong> ${action.actionByName}</div>
                <div style="margin-bottom:10px"><strong>التاريخ:</strong> ${new Date(action.actionDate).toLocaleString('ar-SA')}</div>
                <div style="margin-top:15px;padding:15px;background:white;border-radius:4px"><strong>تفاصيل الإجراء:</strong><p style="margin-top:10px;line-height:1.8">${action.actionDetails}</p></div></div>`:''}
                <div class="signature-area">
                    <div class="signature-box"><div class="signature-line">${state.currentUser.role==='assistant'?'الوكيل':'المرشد الطلابي'}</div></div>
                    <div class="signature-box"><div class="signature-line">ولي الأمر</div></div>
                    <div class="signature-box"><div class="signature-line">مدير المدرسة</div></div>
                </div>
                <div class="no-print" style="text-align:center;margin-top:30px">
                    <button onclick="window.print()" style="background:#2563eb;color:white;padding:12px 30px;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-family:'Cairo',sans-serif">🖨️ طباعة التقرير</button>
                    <button onclick="window.close()" style="background:#6b7280;color:white;padding:12px 30px;border:none;border-radius:8px;font-size:16px;cursor:pointer;margin-right:10px;font-family:'Cairo',sans-serif">إغلاق</button>
                </div>
                </body></html>`);
            pw.document.close();
        }
        function exportToCSV() {
            const filtered = getFilteredViolations();
            const headers = ['#', 'الطالب', 'الصف', 'الشعبة', 'الدرجة', 'المخالفة', 'المعلم', 'التاريخ', 'الوقت', 'الحالة'];
            const rows = filtered.map((v, i) => [i + 1, v.studentName, v.grade, v.section, getDegreeLabel(v.violationType), v.violationDetails, v.teacherName, v.date, v.time, v.status === 'active' ? 'نشط' : 'محلول']);
            const csvContent = [headers, ...rows].map(r => r.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `مخالفات_${new Date().toISOString().split('T')[0]}.csv`; link.click();
        }

        /* ---------- Render ---------- */
        function render() {
            const stats = getStats();
            const filtered = getFilteredViolations();
            document.getElementById('app').innerHTML = `
                ${renderHeader()}
                ${renderUserTabs()}
                ${renderMainContent(stats, filtered)}
                ${state.modals.showAddForm ? renderAddModal() : ''}
                ${state.modals.showDetailsModal ? renderDetailsModal() : ''}
                ${state.modals.showActionModal ? renderActionModal() : ''}
            `;
        }
        
        function renderHeader() {
            return `<div class="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 text-white shadow-2xl">
                <div class="max-w-7xl mx-auto px-6 py-8">
                    <div class="flex items-center justify-between mb-6">
                        <div><h1 class="text-4xl font-bold mb-2">📚 ${config.schoolInfo.name}</h1><p class="text-blue-100 text-lg">نظام إدارة المخالفات السلوكية - ${config.schoolInfo.type}</p></div>
                        <div class="text-left bg-blue-800 bg-opacity-50 rounded-lg p-4 backdrop-blur-sm">
                            <p class="text-sm text-blue-100 mb-1">👤 مدير المدرسة: ${config.schoolInfo.principal}</p>
                            <p class="text-sm text-blue-100 mb-1">👤 الوكيل: ${config.schoolInfo.assistant}</p>
                            <p class="text-sm text-blue-100">👤 الموجه الطلابي: ${config.schoolInfo.counselor}</p>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        function renderUserTabs() {
            const isActive = r => state.currentUser.role === r;
            const btn = (role, icon, label) => `<button onclick="setCurrentUser('${role}', '${config.schoolInfo[role]}', ${role==='teacher'?1:role==='assistant'?2:role==='counselor'?3:4})" class="flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${isActive(role)?'bg-blue-600 text-white shadow-lg scale-105':'bg-gray-100 text-gray-700 hover:bg-gray-200'}">${icon} ${label}</button>`;
            return `<div class="bg-white border-b shadow-sm sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-6 py-4">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex gap-2 flex-wrap items-center">
                            ${state.currentUser.role==='teacher'?`
                                <select onchange="setCurrentUser('teacher', this.value, 1)" class="px-4 py-3 border-2 border-blue-600 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium text-blue-900 bg-blue-50">
                                    ${teachersList.map(t=>`<option ${state.currentUser.name===t?'selected':''}>👨‍🏫 ${t}</option>`).join('')}
                                </select>
                            `:btn('teacher','👨‍🏫','صفحة المعلم')}
                            ${btn('assistant','📋','صفحة الوكيل')} ${btn('counselor','📢','الموجه الطلابي')} ${btn('principal','🛡️','صفحة المدير')}
                            <a href="https://nawafoooh.github.io/activity/absent.html" class="px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">📋 تسجيل الغياب</a>
                        </div>
                        <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200"><p class="text-sm text-blue-900"><span class="font-bold">المستخدم الحالي:</span> ${state.currentUser.name} - ${getRoleLabel(state.currentUser.role)}</p></div>
                    </div>
                </div>
            </div>`;
        }
        
        function renderMainContent(stats, filtered) {
            return `<div class="max-w-7xl mx-auto px-6 py-6">
                ${renderStats(stats)}
                ${renderViolationsSection(stats, filtered)}
                ${renderStudentsUnderWatch()}
                ${renderAbsenceBlock()}
            </div>`;
        }
        
        function renderStats({active, resolved, studentsUnderWatch, today}) {
            return `<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500"><div class="flex items-center justify-between mb-3"><span class="text-4xl">⚠️</span><div class="text-3xl font-bold text-blue-600">${active}</div></div><div class="text-gray-600 font-medium">المخالفات النشطة</div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500"><div class="flex items-center justify-between mb-3"><span class="text-4xl">✅</span><div class="text-3xl font-bold text-green-600">${resolved}</div></div><div class="text-gray-600 font-medium">المخالفات المحلولة</div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-orange-500"><div class="flex items-center justify-between mb-3"><span class="text-4xl">👁️</span><div class="text-3xl font-bold text-orange-600">${studentsUnderWatch}</div></div><div class="text-gray-600 font-medium">طلاب تحت المراقبة</div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500"><div class="flex items-center justify-between mb-3"><span class="text-4xl">📅</span><div class="text-3xl font-bold text-purple-600">${today}</div></div><div class="text-gray-600 font-medium">مخالفات اليوم</div></div>
            </div>`;
        }
        
        function renderViolationsSection(stats, filtered) {
            const tabClass = tab => `px-5 py-2.5 rounded-lg font-medium transition-all ${state.filters.selectedTab===tab?'bg-blue-600 text-white shadow-md':'text-gray-600 hover:bg-gray-100'}`;
            const hasFilters = state.filters.searchStudent||state.filters.filterGrade||state.filters.filterSection||state.filters.dateFrom||state.filters.dateTo;
            return `<div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="border-b px-6 py-4">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex gap-3">
                            <button onclick="setFilter('selectedTab', 'all')" class="${tabClass('all')}">جميع المخالفات (${state.violations.length})</button>
                            <button onclick="setFilter('selectedTab', 'active')" class="${tabClass('active')}">النشطة (${stats.active})</button>
                            <button onclick="setFilter('selectedTab', 'resolved')" class="${tabClass('resolved')}">المحلولة (${stats.resolved})</button>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportToCSV()" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-md">📥 تصدير Excel</button>
                            ${state.currentUser.role==='teacher'?`<button onclick="openAddForm()" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">➕ إضافة مخالفة جديدة</button>`:''}
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 border-b">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">🔍 بحث بالاسم</label><input type="text" value="${state.filters.searchStudent}" onchange="setFilter('searchStudent', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="اسم الطالب..."></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">📊 الصف</label><select onchange="setFilter('filterGrade', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">الكل</option>${config.grades.map(g=>`<option value="${g}" ${state.filters.filterGrade===g?'selected':''}>${g}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">الشعبة</label><select onchange="setFilter('filterSection', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">الكل</option>${config.sections.map(s=>`<option value="${s}" ${state.filters.filterSection===s?'selected':''}>${s}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">من تاريخ</label><input type="date" value="${state.filters.dateFrom}" onchange="setFilter('dateFrom', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">إلى تاريخ</label><input type="date" value="${state.filters.dateTo}" onchange="setFilter('dateTo', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                    </div>
                    ${hasFilters?`<button onclick="clearFilters()" class="mt-4 text-sm text-blue-600 hover:text-blue-800 font-medium">مسح جميع الفلاتر</button>`:''}
                </div>
                <div class="divide-y">${filtered.map(v=>renderViolationItem(v)).join('')}</div>
                <div class="p-4 bg-gray-50 border-t text-center text-sm text-gray-600">عرض ${filtered.length} من أصل ${state.violations.length} مخالفة</div>
            </div>`;
        }
        
        function renderViolationItem(v) {
            const count = getStudentViolationCount(v.studentName, v.teacherId); const high = count >= 3;
            return `
                <div class="p-6 hover:bg-gray-50 transition-all duration-200 ${high && v.status==='active'?'bg-red-50 border-r-4 border-red-500':''}">
                    <div class="flex justify-between items-start gap-6">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3 flex-wrap">
                                <h3 class="text-xl font-bold text-gray-900">${v.studentName}</h3>
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">${v.grade}</span>
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">الشعبة ${v.section}</span>
                                <span class="px-3 py-1 rounded-full text-xs font-bold border-2 ${getDegreeColor(v.violationType)}">${getDegreeLabel(v.violationType)}</span>
                                ${high && v.status==='active'?`<span class="flex items-center gap-1 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md animate-pulse">⚠️ تحت المراقبة (${count} مخالفات من ${v.teacherName})</span>`:''}
                                ${v.status==='resolved'?`<span class="flex items-center gap-1 bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">✅ تم الحل</span>`:''}
                            </div>
                            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3"><p class="text-gray-800 mb-2 font-semibold text-lg">${v.violationDetails}</p>${v.documentation?`<div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg"><p class="text-sm text-blue-900"><span class="font-bold">📝 الإجراء المتبع:</span><br>${v.documentation}</p></div>`:''}</div>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-600"><span>👤 <strong>المعلم:</strong> ${v.teacherName}</span><span>📅 <strong>التاريخ:</strong> ${v.date}</span><span>🕐 <strong>الوقت:</strong> ${v.time}</span></div>
                            ${v.status==='resolved'&&v.resolutionReason?`
                                <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-start gap-2 mb-2"><span class="text-2xl">🏆</span><div class="flex-1">
                                        <p class="text-sm font-bold text-green-900 mb-1">سبب حل المخالفة (السلوك الإيجابي):</p>
                                        <p class="text-sm text-green-800 mb-2">${v.resolutionReason}</p>
                                        <div class="flex gap-4 text-xs text-green-700"><span>تم الحل بواسطة: ${v.resolvedBy}</span><span>في: ${new Date(v.resolvedAt).toLocaleString('ar-SA')}</span></div>
                                    </div></div>
                                </div>
                            `:''}
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick='openDetailsModal(${JSON.stringify(v).replace(/'/g, "\\'")})'class="flex items-center gap-2 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors whitespace-nowrap">👁️ التفاصيل</button>
                            ${v.status==='active'&&canResolveViolation(v)?`<button onclick="resolveViolation(${v.id})" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md whitespace-nowrap">🏆 حل المخالفة</button>`:''}
                        </div>
                    </div>
                </div>`;
        }
        
        function renderStudentsUnderWatch() {
            if (!['assistant','counselor','principal'].includes(state.currentUser.role)) return '';
            const students = getStudentsByViolationCount().filter(s => s.count >= 3);
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-red-700">⚠️ الطلاب تحت المراقبة (3 مخالفات فأكثر)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${students.length?students.map((s,i)=>{
                            const hasAction = state.studentActions.find(a => a.studentName === s.name && a.actionBy === state.currentUser.role);
                            return `
                                <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-900">${s.name}</h3><span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold">${s.count} مخالفات</span></div>
                                    <div class="text-sm text-gray-600 mb-2">${s.grade} - الشعبة ${s.section}</div>
                                    <div class="text-xs text-gray-500 mb-3">آخر مخالفة: ${s.violations[s.violations.length-1].date}</div>
                                    ${hasAction?`<div class="bg-blue-100 border border-blue-300 rounded p-2 mb-3 text-xs"><div class="font-bold text-blue-900 mb-1">✅ تم اتخاذ إجراء</div><div class="text-blue-800">${new Date(hasAction.actionDate).toLocaleDateString('ar-SA')}</div></div>`:''}
                                    <div class="flex gap-2 mt-3">
                                        <button onclick='openActionModal(${JSON.stringify(s).replace(/'/g, "\\'")})'class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors">${hasAction?'📝 تعديل الإجراء':'📋 اتخاذ إجراء'}</button>
                                        <button onclick='printStudentReport(${JSON.stringify(s).replace(/'/g, "\\'")})'class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm font-medium transition-colors">🖨️ طباعة</button>
                                    </div>
                                </div>`;
                        }).join(''):`<div class="col-span-full text-center py-8 text-gray-500"><div class="text-5xl mb-2">✅</div><p>لا يوجد طلاب تحت المراقبة حالياً</p></div>`}
                    </div>
                </div>`;
        }

        /* ========== ✅ Absence Block with LocalStorage Sync ========== */
        function renderAbsenceBlock() {
            if (state.currentUser.role !== 'assistant') return '';
            
            const filtered = absenceRecords.filter(a => {
                if (state.filters.filterGrade && a.grade !== state.filters.filterGrade) return false;
                if (state.filters.filterSection && a.section !== state.filters.filterSection) return false;
                if (state.filters.dateFrom && a.date < state.filters.dateFrom) return false;
                if (state.filters.dateTo && a.date > state.filters.dateTo) return false;
                return true;
            });
            
            const lastUpdate = localStorage.getItem('lastUpdate');
            const syncStatus = lastUpdate ? `
                <div class="flex items-center gap-2 text-sm text-green-700 bg-green-50 px-3 py-1 rounded-lg">
                    <span class="text-lg">✅</span>
                    <span>متزامن - آخر تحديث: ${new Date(lastUpdate).toLocaleTimeString('ar-SA')}</span>
                </div>
            ` : '<div class="text-sm text-gray-500">لا توجد بيانات محفوظة</div>';
            
            const printHandler = () => {
                const pw = window.open('', '_blank');
                pw.document.write(buildAbsencePrintPage(filtered));
                pw.document.close();
                pw.focus();
                pw.print();
            };
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">📋 سجل الغياب (${filtered.length} سجلات)</h2>
                            ${syncStatus}
                        </div>
                        <button onclick="(${printHandler})()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow">🖨️ طباعة</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-right">#</th>
                                    <th class="px-3 py-2 text-right">الصف</th>
                                    <th class="px-3 py-2 text-right">الشعبة</th>
                                    <th class="px-3 py-2 text-right">الحصة</th>
                                    <th class="px-3 py-2 text-right">التاريخ</th>
                                    <th class="px-3 py-2 text-right">عدد الغياب</th>
                                    <th class="px-3 py-2 text-right">أسماء الغائبين</th>
                                    <th class="px-3 py-2 text-right">المعلم</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${filtered.map((a, i) => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-3 py-2">${i + 1}</td>
                                        <td class="px-3 py-2 font-medium">${a.grade}</td>
                                        <td class="px-3 py-2">${a.section}</td>
                                        <td class="px-3 py-2"><span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">الحصة ${a.period}</span></td>
                                        <td class="px-3 py-2">${a.date}</td>
                                        <td class="px-3 py-2 text-red-600 font-bold">${a.absentCount}</td>
                                        <td class="px-3 py-2 max-w-xs">
                                            <div class="bg-yellow-50 border border-yellow-200 rounded p-2 text-xs">
                                                ${a.absentStudents && a.absentStudents.length > 0 ? 
                                                    a.absentStudents.slice(0, 3).map((s, j) => `${j + 1}. ${s}`).join('<br>') +
                                                    (a.absentStudents.length > 3 ? `<div class="text-blue-600 font-bold mt-1">... و ${a.absentStudents.length - 3} آخرون</div>` : '')
                                                : 'لا يوجد'}
                                            </div>
                                        </td>
                                        <td class="px-3 py-2">${a.teacherName}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${filtered.length === 0 ? '<p class="text-center py-8 text-gray-500">لا توجد سجلات غياب ضمن الفلاتر المحددة</p>' : ''}
                    </div>
                </div>`;
        }
        
        function buildAbsencePrintPage(list) {
            const today = new Date().toLocaleDateString('ar-SA');
            return `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير الغياب - ${today}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                        body { font-family: 'Cairo', sans-serif; padding: 40px; color: #111; }
                        h1 { text-align: center; margin-bottom: 30px; color: #1e40af; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: right; }
                        th { background: #f3f4f6; }
                        .foot { display: flex; justify-content: space-between; margin-top: 50px; }
                        .sign { width: 200px; text-align: center; border-top: 2px solid #000; padding-top: 10px; }
                        @media print { button.no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>📋 تقرير الغياب اليومي<br><small>${config.schoolInfo.name} - ${today}</small></h1>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الصف</th>
                                <th>الشعبة</th>
                                <th>الحصة</th>
                                <th>التاريخ</th>
                                <th>عدد الغياب</th>
                                <th>أسماء الغائبين</th>
                                <th>المعلم</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map((a, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${a.grade}</td>
                                    <td>${a.section}</td>
                                    <td>الحصة ${a.period}</td>
                                    <td>${a.date}</td>
                                    <td>${a.absentCount}</td>
                                    <td>${a.absentStudents && a.absentStudents.length > 0 ? a.absentStudents.join(' ، ') : 'لا يوجد'}</td>
                                    <td>${a.teacherName}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="foot">
                        <div class="sign">الوكيل</div>
                        <div class="sign">مدير المدرسة</div>
                    </div>
                    <button class="no-print" onclick="window.print()" style="margin:30px auto;display:block;padding:10px 30px;background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer">🖨️ طباعة</button>
                </body>
                </html>
            `;
        }

        /* ========== Modals Implementation ========== */
        
        function renderAddModal() {
            const {studentName, grade, section, violationType, violationDetails, documentation, date, time} = state.newViolation;
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeAddForm()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">➕ إضافة مخالفة جديدة</h2>
                            <p class="text-blue-100 text-sm mt-1">يرجى ملء البيانات المطلوبة</p>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">اسم الطالب <span class="text-red-500">*</span></label>
                                <input type="text" value="${studentName}" 
                                    onchange="state.newViolation.studentName=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                    placeholder="أدخل اسم الطالب...">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">الصف <span class="text-red-500">*</span></label>
                                    <select onchange="state.newViolation.grade=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">اختر الصف</option>
                                        ${config.grades.map(g => `<option value="${g}" ${grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">الشعبة <span class="text-red-500">*</span></label>
                                    <select onchange="state.newViolation.section=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">اختر الشعبة</option>
                                        ${config.sections.map(s => `<option value="${s}" ${section === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">درجة المخالفة <span class="text-red-500">*</span></label>
                                <select onchange="state.newViolation.violationType=this.value;state.newViolation.violationDetails='';render()" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="first" ${violationType === 'first' ? 'selected' : ''}>مخالفات الدرجة الأولى (درجة واحدة)</option>
                                    <option value="second" ${violationType === 'second' ? 'selected' : ''}>مخالفات الدرجة الثانية (درجتين)</option>
                                    <option value="third" ${violationType === 'third' ? 'selected' : ''}>مخالفات الدرجة الثالثة (ثلاث درجات)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">نوع المخالفة <span class="text-red-500">*</span></label>
                                <select onchange="state.newViolation.violationDetails=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">اختر المخالفة</option>
                                    ${config.violationTypes[violationType].items.map(item => `
                                        <option value="${item}" ${violationDetails === item ? 'selected' : ''}>${item}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">الإجراء المتبع <span class="text-red-500">*</span></label>
                                <textarea onchange="state.newViolation.documentation=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[100px]" 
                                    placeholder="اكتب الإجراء المتخذ...">${documentation}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">التاريخ</label>
                                    <input type="date" value="${date}" 
                                        onchange="state.newViolation.date=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">الوقت</label>
                                    <input type="time" value="${time}" 
                                        onchange="state.newViolation.time=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeAddForm()" 
                                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                                إلغاء
                            </button>
                            <button onclick="if(addViolation())render()" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                                ✓ حفظ المخالفة
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderDetailsModal() {
            const v = state.modals.selectedViolation;
            if (!v) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeDetailsModal()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">👁️ تفاصيل المخالفة</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <h3 class="font-bold text-xl text-gray-900 mb-2">${v.studentName}</h3>
                                <div class="flex gap-2 flex-wrap">
                                    <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm font-medium">${v.grade}</span>
                                    <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm font-medium">الشعبة ${v.section}</span>
                                    <span class="px-3 py-1 ${getDegreeColor(v.violationType)} rounded-full text-sm font-bold">${getDegreeLabel(v.violationType)}</span>
                                </div>
                            </div>
                            
                            <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-1">نوع المخالفة:</p>
                                <p class="text-lg font-bold text-gray-900">${v.violationDetails}</p>
                            </div>
                            
                            ${v.documentation ? `
                                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                                    <p class="text-sm font-bold text-yellow-900 mb-2">📝 الإجراء المتبع:</p>
                                    <p class="text-gray-800">${v.documentation}</p>
                                </div>
                            ` : ''}
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">👨‍🏫 المعلم</p>
                                    <p class="font-bold text-gray-900">${v.teacherName}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">📅 التاريخ</p>
                                    <p class="font-bold text-gray-900">${v.date}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">🕐 الوقت</p>
                                    <p class="font-bold text-gray-900">${v.time}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">📊 الحالة</p>
                                    <p class="font-bold ${v.status === 'active' ? 'text-orange-600' : 'text-green-600'}">
                                        ${v.status === 'active' ? 'نشط' : 'محلول'}
                                    </p>
                                </div>
                            </div>
                            
                            ${v.status === 'resolved' && v.resolutionReason ? `
                                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                                    <p class="text-sm font-bold text-green-900 mb-2">🏆 سبب حل المخالفة:</p>
                                    <p class="text-gray-800 mb-3">${v.resolutionReason}</p>
                                    <div class="flex gap-4 text-xs text-green-700">
                                        <span>تم الحل بواسطة: ${v.resolvedBy}</span>
                                        <span>في: ${new Date(v.resolvedAt).toLocaleString('ar-SA')}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeDetailsModal()" 
                                class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderActionModal() {
            const student = state.modals.selectedStudent;
            if (!student) return '';
            
            const existingAction = state.studentActions.find(
                a => a.studentName === student.name && a.actionBy === state.currentUser.role
            );
            
            // ✅ حفظ النص الحالي في المتغير بدلاً من render
            const currentText = existingAction ? existingAction.actionDetails : '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeActionModal()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">📋 ${existingAction ? 'تعديل' : 'اتخاذ'} إجراء تجاه الطالب</h2>
                            <p class="text-orange-100 text-sm mt-1">${student.name} - ${student.grade} الشعبة ${student.section}</p>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                                <h3 class="font-bold text-red-900 mb-3">⚠️ ملخص المخالفات (${student.count} مخالفة)</h3>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${student.violations.map((v, i) => `
                                        <div class="bg-white border border-red-300 rounded-lg p-3">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm font-bold text-gray-900">${i + 1}. ${v.violationDetails}</span>
                                                <span class="px-2 py-1 ${getDegreeColor(v.violationType)} rounded-full text-xs font-bold">
                                                    ${getDegreeLabel(v.violationType)}
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-600">📅 ${v.date} | 🕐 ${v.time}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">الإجراء المتخذ <span class="text-red-500">*</span></label>
                                <textarea id="actionDetailsInput" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 min-h-[150px]" 
                                    placeholder="اكتب الإجراء المتخذ تجاه الطالب (مثال: تم استدعاء ولي الأمر، إحالة للمرشد الطلابي، الخ...)">${currentText}</textarea>
                            </div>
                            
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <h4 class="font-bold text-blue-900 mb-2">💡 اقتراحات للإجراءات:</h4>
                                <ul class="text-sm text-blue-800 space-y-1">
                                    <li>• استدعاء ولي الأمر للمناقشة</li>
                                    <li>• إحالة الطالب للمرشد الطلابي</li>
                                    <li>• وضع خطة متابعة سلوكية</li>
                                    <li>• عقد جلسة إرشادية فردية</li>
                                    <li>• التواصل مع المعلمين لمتابعة السلوك</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeActionModal()" 
                                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                                إلغاء
                            </button>
                            <button onclick="saveStudentAction()" 
                                class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium">
                                ✓ حفظ الإجراء
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /* ---------- Initial ---------- */
        render();
    </script>
</body>
</html>
                
