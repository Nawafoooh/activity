import React, { useState } from 'react';
import { UserCircle, FileText, Bell, LayoutDashboard, Plus, Search, Filter, Trash2, Award, AlertCircle } from 'lucide-react';

const BehaviorTrackingSystem = () => {
  const [currentUser, setCurrentUser] = useState({ role: 'teacher', name: 'معلم تجريبي' });
  const [violations, setViolations] = useState([
    {
      id: 1,
      studentName: 'أحمد محمد علي',
      grade: 'أول متوسط',
      section: '1',
      violationType: 'first',
      violationDetails: 'التأخر عن الدخول للحصة',
      teacherName: 'علي السعيد',
      date: '2025-10-13',
      time: '08:30',
      documentation: 'تأخر 15 دقيقة عن الحصة الأولى',
      status: 'active'
    },
    {
      id: 2,
      studentName: 'أحمد محمد علي',
      grade: 'أول متوسط',
      section: '1',
      violationType: 'first',
      violationDetails: 'النوم داخل الصف',
      teacherName: 'خالد الأحمد',
      date: '2025-10-14',
      time: '10:15',
      documentation: 'نام أثناء الحصة الثالثة',
      status: 'active'
    }
  ]);
  
  const [showAddForm, setShowAddForm] = useState(false);
  const [filterGrade, setFilterGrade] = useState('');
  const [filterSection, setFilterSection] = useState('');
  const [searchStudent, setSearchStudent] = useState('');
  const [selectedTab, setSelectedTab] = useState('all');

  const schoolInfo = {
    name: 'متوسطة المنذر بن عمرو الأنصاري',
    principal: 'خالد المطيري',
    assistant: 'محمد الجابري',
    counselor: 'محمد القحطاني'
  };

  const grades = ['أول متوسط', 'ثاني متوسط', 'ثالث متوسط'];
  const sections = ['1', '2', '3', '4', '5', '6'];

  const violationTypes = {
    first: [
      'التأخر عن الدخول للحصة',
      'إعاقة سير الحصص الدراسية',
      'المشروبات أثناء الدرس',
      'النوم داخل الصف',
      'تكرار خروج ودخول الطلابة من البوابة قبل وقت الحضور والانصراف',
      'التجهز أمام بوابة المدرسة'
    ],
    second: [
      'عدم حضور الحصة أو الهروب منها',
      'الدخول أو الخروج من الفصل دون استئذان',
      'دخول فصل آخر دون استئذان',
      'إثارة الفوضى داخل الصف'
    ],
    third: [
      'عدم التقيد بالزي المدرسي',
      'إلحاق الضرر المتعمد بممتلكات الطالبات',
      'العبث بتجهيزات المدرسة',
      'امتهان الكتب الدراسية'
    ]
  };

  const [newViolation, setNewViolation] = useState({
    studentName: '',
    grade: '',
    section: '',
    violationType: 'first',
    violationDetails: '',
    documentation: '',
    date: new Date().toISOString().split('T')[0],
    time: new Date().toTimeString().slice(0, 5)
  });

  const handleAddViolation = () => {
    if (newViolation.studentName && newViolation.grade && newViolation.section && newViolation.violationDetails) {
      const violation = {
        id: violations.length + 1,
        ...newViolation,
        teacherName: currentUser.name,
        status: 'active'
      };
      setViolations([...violations, violation]);
      setNewViolation({
        studentName: '',
        grade: '',
        section: '',
        violationType: 'first',
        violationDetails: '',
        documentation: '',
        date: new Date().toISOString().split('T')[0],
        time: new Date().toTimeString().slice(0, 5)
      });
      setShowAddForm(false);
    }
  };

  const handleDeleteViolation = (id, reason) => {
    if (reason && reason.trim()) {
      setViolations(violations.map(v => 
        v.id === id ? { ...v, status: 'resolved', resolutionReason: reason, resolvedBy: currentUser.name } : v
      ));
    }
  };

  const getStudentViolationCount = (studentName) => {
    return violations.filter(v => v.studentName === studentName && v.status === 'active').length;
  };

  const filteredViolations = violations.filter(v => {
    if (currentUser.role === 'teacher') return v.status === 'active';
    if (currentUser.role === 'assistant' || currentUser.role === 'counselor') {
      return getStudentViolationCount(v.studentName) >= 3;
    }
    return true;
  }).filter(v => {
    if (filterGrade && v.grade !== filterGrade) return false;
    if (filterSection && v.section !== filterSection) return false;
    if (searchStudent && !v.studentName.includes(searchStudent)) return false;
    if (selectedTab === 'active' && v.status !== 'active') return false;
    if (selectedTab === 'resolved' && v.status !== 'resolved') return false;
    return true;
  });

  const getDegreeLabel = (type) => {
    if (type === 'first') return 'درجة أولى';
    if (type === 'second') return 'درجة ثانية';
    return 'درجة ثالثة';
  };

  const getDegreeColor = (type) => {
    if (type === 'first') return 'bg-green-100 text-green-800';
    if (type === 'second') return 'bg-yellow-100 text-yellow-800';
    return 'bg-red-100 text-red-800';
  };

  return (
    <div className="min-h-screen bg-gray-50" dir="rtl">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 shadow-lg">
        <div className="max-w-7xl mx-auto">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold mb-2">{schoolInfo.name}</h1>
              <p className="text-blue-100">نظام إدارة المخالفات السلوكية</p>
            </div>
            <div className="text-left">
              <p className="text-sm text-blue-100">مدير المدرسة: {schoolInfo.principal}</p>
              <p className="text-sm text-blue-100">الوكيل: {schoolInfo.assistant}</p>
              <p className="text-sm text-blue-100">الموجه الطلابي: {schoolInfo.counselor}</p>
            </div>
          </div>
        </div>
      </div>

      {/* User Selection */}
      <div className="bg-white border-b shadow-sm">
        <div className="max-w-7xl mx-auto p-4">
          <div className="flex gap-2">
            <button
              onClick={() => setCurrentUser({ role: 'teacher', name: 'معلم تجريبي' })}
              className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition ${
                currentUser.role === 'teacher' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <UserCircle size={20} />
              صفحة المعلم
            </button>
            <button
              onClick={() => setCurrentUser({ role: 'assistant', name: schoolInfo.assistant })}
              className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition ${
                currentUser.role === 'assistant' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <FileText size={20} />
              صفحة الوكيل
            </button>
            <button
              onClick={() => setCurrentUser({ role: 'counselor', name: schoolInfo.counselor })}
              className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition ${
                currentUser.role === 'counselor' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <Bell size={20} />
              الموجه الطلابي
            </button>
            <button
              onClick={() => setCurrentUser({ role: 'principal', name: schoolInfo.principal })}
              className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition ${
                currentUser.role === 'principal' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <LayoutDashboard size={20} />
              صفحة المدير
            </button>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto p-6">
        {/* Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-white p-6 rounded-lg shadow">
            <div className="text-gray-600 mb-2">إجمالي المخالفات النشطة</div>
            <div className="text-3xl font-bold text-blue-600">
              {violations.filter(v => v.status === 'active').length}
            </div>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <div className="text-gray-600 mb-2">المخالفات المحلولة</div>
            <div className="text-3xl font-bold text-green-600">
              {violations.filter(v => v.status === 'resolved').length}
            </div>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <div className="text-gray-600 mb-2">طلاب تحت المراقبة</div>
            <div className="text-3xl font-bold text-orange-600">
              {new Set(violations.filter(v => v.status === 'active' && getStudentViolationCount(v.studentName) >= 3).map(v => v.studentName)).size}
            </div>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <div className="text-gray-600 mb-2">اليوم</div>
            <div className="text-3xl font-bold text-gray-700">
              {violations.filter(v => v.date === new Date().toISOString().split('T')[0]).length}
            </div>
          </div>
        </div>

        {/* Tabs */}
        <div className="bg-white rounded-lg shadow mb-6">
          <div className="border-b">
            <div className="flex gap-4 p-4">
              <button
                onClick={() => setSelectedTab('all')}
                className={`px-4 py-2 rounded-lg font-medium transition ${
                  selectedTab === 'all' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                جميع المخالفات
              </button>
              <button
                onClick={() => setSelectedTab('active')}
                className={`px-4 py-2 rounded-lg font-medium transition ${
                  selectedTab === 'active' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                المخالفات النشطة
              </button>
              <button
                onClick={() => setSelectedTab('resolved')}
                className={`px-4 py-2 rounded-lg font-medium transition ${
                  selectedTab === 'resolved' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                المخالفات المحلولة
              </button>
            </div>
          </div>

          {/* Filters */}
          <div className="p-4 bg-gray-50 border-b">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  <Search size={16} className="inline ml-1" />
                  بحث بالاسم
                </label>
                <input
                  type="text"
                  value={searchStudent}
                  onChange={(e) => setSearchStudent(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="ابحث عن طالب..."
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  <Filter size={16} className="inline ml-1" />
                  الصف
                </label>
                <select
                  value={filterGrade}
                  onChange={(e) => setFilterGrade(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">جميع الصفوف</option>
                  {grades.map(g => <option key={g} value={g}>{g}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">الشعبة</label>
                <select
                  value={filterSection}
                  onChange={(e) => setFilterSection(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">جميع الشعب</option>
                  {sections.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              {currentUser.role === 'teacher' && (
                <div className="flex items-end">
                  <button
                    onClick={() => setShowAddForm(true)}
                    className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2"
                  >
                    <Plus size={20} />
                    إضافة مخالفة
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* Violations List */}
          <div className="divide-y">
            {filteredViolations.map(v => {
              const count = getStudentViolationCount(v.studentName);
              return (
                <div key={v.id} className={`p-4 hover:bg-gray-50 transition ${count >= 3 ? 'bg-red-50' : ''}`}>
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <h3 className="text-lg font-bold text-gray-900">{v.studentName}</h3>
                        <span className="text-sm text-gray-600">{v.grade} - الشعبة {v.section}</span>
                        <span className={`px-3 py-1 rounded-full text-xs font-medium ${getDegreeColor(v.violationType)}`}>
                          {getDegreeLabel(v.violationType)}
                        </span>
                        {count >= 3 && (
                          <span className="flex items-center gap-1 bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-medium">
                            <AlertCircle size={14} />
                            تحت المراقبة ({count} مخالفات)
                          </span>
                        )}
                        {v.status === 'resolved' && (
                          <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-medium">
                            تم الحل
                          </span>
                        )}
                      </div>
                      <p className="text-gray-700 mb-2 font-medium">{v.violationDetails}</p>
                      {v.documentation && (
                        <p className="text-sm text-gray-600 mb-2">
                          <strong>التوثيق:</strong> {v.documentation}
                        </p>
                      )}
                      <div className="flex gap-4 text-sm text-gray-500">
                        <span>المعلم: {v.teacherName}</span>
                        <span>التاريخ: {v.date}</span>
                        <span>الوقت: {v.time}</span>
                      </div>
                      {v.status === 'resolved' && v.resolutionReason && (
                        <div className="mt-2 p-3 bg-green-50 rounded-lg">
                          <p className="text-sm text-green-800">
                            <strong>سبب الحل:</strong> {v.resolutionReason}
                          </p>
                          <p className="text-xs text-green-600 mt-1">تم الحل بواسطة: {v.resolvedBy}</p>
                        </div>
                      )}
                    </div>
                    {v.status === 'active' && (currentUser.role === 'teacher' || currentUser.role === 'assistant' || currentUser.role === 'counselor') && (
                      <button
                        onClick={() => {
                          const reason = prompt('أدخل سبب حذف المخالفة (السلوك الإيجابي):');
                          if (reason) handleDeleteViolation(v.id, reason);
                        }}
                        className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                      >
                        <Award size={16} />
                        حل المخالفة
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
            {filteredViolations.length === 0 && (
              <div className="p-12 text-center text-gray-500">
                <p className="text-lg">لا توجد مخالفات للعرض</p>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Add Violation Modal */}
      {showAddForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b">
              <h2 className="text-2xl font-bold">إضافة مخالفة سلوكية</h2>
            </div>
            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">اسم الطالب *</label>
                <input
                  type="text"
                  value={newViolation.studentName}
                  onChange={(e) => setNewViolation({ ...newViolation, studentName: e.target.value })}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="أدخل اسم الطالب الثلاثي"
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">الصف *</label>
                  <select
                    value={newViolation.grade}
                    onChange={(e) => setNewViolation({ ...newViolation, grade: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">اختر الصف</option>
                    {grades.map(g => <option key={g} value={g}>{g}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">الشعبة *</label>
                  <select
                    value={newViolation.section}
                    onChange={(e) => setNewViolation({ ...newViolation, section: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">اختر الشعبة</option>
                    {sections.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">درجة المخالفة *</label>
                <select
                  value={newViolation.violationType}
                  onChange={(e) => setNewViolation({ ...newViolation, violationType: e.target.value, violationDetails: '' })}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="first">درجة أولى</option>
                  <option value="second">درجة ثانية</option>
                  <option value="third">درجة ثالثة</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">نوع المخالفة *</label>
                <select
                  value={newViolation.violationDetails}
                  onChange={(e) => setNewViolation({ ...newViolation, violationDetails: e.target.value })}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">اختر المخالفة</option>
                  {violationTypes[newViolation.violationType].map(v => (
                    <option key={v} value={v}>{v}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">توثيق المخالفة</label>
                <textarea
                  value={newViolation.documentation}
                  onChange={(e) => setNewViolation({ ...newViolation, documentation: e.target.value })}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  rows="3"
                  placeholder="أدخل تفاصيل إضافية عن المخالفة..."
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">التاريخ</label>
                  <input
                    type="date"
                    value={newViolation.date}
                    onChange={(e) => setNewViolation({ ...newViolation, date: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">الوقت</label>
                  <input
                    type="time"
                    value={newViolation.time}
                    onChange={(e) => setNewViolation({ ...newViolation, time: e.target.value })}
                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
            </div>
            <div className="p-6 border-t flex gap-3 justify-end">
              <button
                onClick={() => setShowAddForm(false)}
                className="px-6 py-2 border rounded-lg hover:bg-gray-50 transition"
              >
                إلغاء
              </button>
              <button
                onClick={handleAddViolation}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
              >
                إضافة المخالفة
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default BehaviorTrackingSystem;     
