<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخالفات السلوكية - متوسطة المنذر بن عمرو الأنصاري</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-TileColor" content="#2563eb">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-152x152.png">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="المخالفات السلوكية">
    
    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="نظام إدارة المخالفات السلوكية للطلاب - متوسطة المنذر بن عمرو الأنصاري">
    <meta name="keywords" content="مخالفات، سلوكية، مدرسة، طلاب، إدارة">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f9fafb;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* PWA Install Button Animation */
        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .install-button {
            animation: slideInUp 0.5s ease-out;
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        .bounce-animation {
            animation: bounce 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-white text-lg">جاري التحميل...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app"></div>

    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, orderBy, query } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB5pU4C0OamFsZ_bSo649zhKV36Wycpn_g",
            authDomain: "shahid-b3b9d.firebaseapp.com",
            projectId: "shahid-b3b9d",
            storageBucket: "shahid-b3b9d.firebasestorage.app",
            messagingSenderId: "28532023353",
            appId: "1:28532023353:web:37e380f875a4482cf3ede8",
            measurementId: "G-32145C7GYW"
        };

        // Initialize Firebase
        let app;
        let db;
        let isFirebaseInitialized = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            isFirebaseInitialized = true;
            console.log('✅ Firebase initialized successfully');
            window.db = db;
            window.isFirebaseInitialized = true;
            window.firestoreModules = { collection, getDocs, addDoc, updateDoc, doc, orderBy, query };
        } catch (error) {
            console.error('❌ Firebase initialization error:', error);
            window.isFirebaseInitialized = false;
        }
    </script>

    <script>
        'use strict';

        // ==========================================
        // Firebase Configuration (loaded from module script)
        // ==========================================
        let db;
        let isFirebaseInitialized = false;
        
        // Wait for Firebase to initialize
        setTimeout(() => {
            if (window.isFirebaseInitialized) {
                db = window.db;
                isFirebaseInitialized = true;
                initApp();
            } else {
                console.error('Firebase failed to initialize');
                initApp(); // Continue without Firebase
            }
        }, 1000);

        // ==========================================
        // Constants & Configuration
        // ==========================================
        const COLLECTIONS = {
            violations: 'violations',
            studentActions: 'studentActions',
            notificationsSent: 'notificationsSent'
        };

        const teachersList = [
            'عبدالله بن مطر بن مصلح العمري',
            'محمد بن عماري راضي الزهراني',
            'موفق مرزوق سويرح السحيمي',
            'فواز زايد لافي المهيمزي الرشيدي',
            'فيصل عطالله حويمد الصاعدي',
            'ابراهيم عياد عيد العلوي',
            'عبدالله حمود حامد الحربي',
            'ساير فيصل سعد الله العضيله المطيري',
            'نافع شعوي نافع المطيري',
            'اسامه منور مشعل العوفي',
            'محمد عياد عليثه العوفي',
            'أحمد إبراهيم فخري التركي',
            'أحمد حامد هلال الحربي',
            'نميان علي نميان الحربي',
            'عبدالله صلاح صالح الرحيلى',
            'مشعل بن هليل بن غالب العمري الحربي',
            'علي متعب ناصر العلوي الحربي',
            'سيف عبدالمنعم حمدان العارضي',
            'محمد بن ذعار بن صالح العوفي',
            'فؤاد بن محمد بن حماد العتيبي',
            'حمزة صدقة حمزة اسلام',
            'سلمان صالح أحمد الحارثي',
            'عبيد بن دخيل بن دويهيس العياضي الحربي',
            'عبدالعزيز مفلح نويعم الرويثي',
            'فيصل عواد محمد أبو سلمي',
            'عبدالله بن محمد بن سعيد ال بحران القرني',
            'كاتب مفلح سليمان الرشيدى',
            'حبيب علي نعيس العمري الحربي',
            'ابراهيم عايض عوض الجابري',
            'سلطان عويض معيض السحيمي',
            'عبدالهادي معيض معلا الشاماني',
            'عبدالعزيز عبدالرحمن غلاب المخلفي',
            'سعد طالع حمود الحربي',
            'ناهر مشعل عويد المطيري',
            'موسى غازي سفر الحربي',
            'موسى مسعود عايض الحيسوني',
            'نواف منصور عواد الصبحي',
            'بدر عبدالعزيز شائد السحيمي',
            'فهد عويض عوض الشاماني الحربي',
            'عبدالمجيد عايد خضران الرشيدي',
            'أحمد مطر سليمان الرشيدي'
        ];

        const config = {
            passwords: {
                principal: 'A2030',
                assistant: 'B2030',
                counselor: 'C2030',
                admin_assistant: 'D2030'
            },
            schoolInfo: {
                name: 'متوسطة المنذر بن عمرو الأنصاري',
                principal: 'خالد المطيري',
                assistant: 'محمد الجابري',
                counselor: 'محمد القحطاني',
                adminAssistant: 'المساعد الإداري',
                type: 'بنين'
            },
            grades: ['أول متوسط', 'ثاني متوسط', 'ثالث متوسط'],
            sections: ['1', '2', '3', '4', '5', '6'],
            violationTypes: {
                first: {
                    label: 'مخالفات الدرجة الأولى (درجة واحدة)',
                    items: [
                        'التأخر عن الدخول للحصة',
                        'إعاقة سير الحصص الدراسية',
                        'المقاطعة المستمرة لشرح المعلم ومنها الأكل والشرب والحديث الجانبي',
                        'النوم داخل الصف',
                        'تكرار الخروج والدخول من البوابة',
                        'التجمهر أمام بوابة المدرسة'
                    ]
                },
                second: {
                    label: 'مخالفات الدرجة الثانية (درجتين)',
                    items: [
                        'عدم حضور الحصة أو الهروب منها',
                        'الدخول أو الخروج من الفصل دون استئذان',
                        'دخول فصل آخر دون استئذان',
                        'إثارة الفوضى داخل الصف'
                    ]
                },
                third: {
                    label: 'مخالفات الدرجة الثالثة (ثلاث درجات)',
                    items: [
                        'عدم التقيد بالزي المدرسي',
                        'إلحاق الضرر المتعمد بممتلكات الطلاب',
                        'العبث بتجهيزات المدرسة',
                        'امتهان الكتب الدراسية'
                    ]
                }
            }
        };

        // ==========================================
        // Application State
        // ==========================================
        let state = {
            currentUser: { 
                role: 'teacher', 
                name: teachersList[0],
                id: 1
            },
            authenticated: {
                principal: false,
                assistant: false,
                counselor: false,
                admin_assistant: false
            },
            violations: [],
            studentActions: [],
            notificationsSent: [],
            filters: {
                selectedTab: 'all',
                searchStudent: '',
                filterGrade: '',
                filterSection: '',
                dateFrom: '',
                dateTo: ''
            },
            modals: {
                showAddForm: false,
                showDetailsModal: false,
                selectedViolation: null,
                showActionModal: false,
                selectedStudent: null
            },
            newViolation: {
                studentName: '',
                grade: '',
                section: '',
                violationType: 'first',
                violationDetails: '',
                documentation: '',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().slice(0, 5)
            }
        };

        // ==========================================
        // Utility Functions
        // ==========================================
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sanitizeForJson(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        // [بقية الكود الأصلي - سأضيف فقط كود PWA في النهاية]
        // ... (جميع الدوال الأصلية من getStudentViolationCount حتى initApp)
        
        // ملاحظة: احتفظ بكل الكود الأصلي كما هو، وأضف التالي قبل </script>
    </script>
    
    <!-- ==========================================
         PWA Service Worker Registration
         ========================================== -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then((registration) => {
                        console.log('✅ Service Worker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateNotification();
                                }
                            });
                        });
                        
                        // Request notification permission
                        if ('Notification' in window && Notification.permission === 'default') {
                            setTimeout(() => {
                                Notification.requestPermission().then((permission) => {
                                    if (permission === 'granted') {
                                        console.log('✅ Notifications enabled');
                                    }
                                });
                            }, 5000);
                        }
                    })
                    .catch((error) => {
                        console.error('❌ Service Worker registration failed:', error);
                    });
            });
        }

        // Install button
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            if (document.getElementById('pwa-install-btn')) return;
            
            const btn = document.createElement('button');
            btn.id = 'pwa-install-btn';
            btn.className = 'install-button fixed bottom-6 left-6 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-full shadow-2xl hover:shadow-3xl hover:scale-105 transition-all duration-300 z-50 font-bold text-base flex items-center gap-2';
            btn.innerHTML = `
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
                </svg>
                تثبيت التطبيق
            `;
            
            btn.onclick = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    btn.style.opacity = '0';
                    setTimeout(() => btn.remove(), 300);
                }
                deferredPrompt = null;
            };
            
            document.body.appendChild(btn);
        }

        window.addEventListener('appinstalled', () => {
            const btn = document.getElementById('pwa-install-btn');
            if (btn) {
                btn.style.opacity = '0';
                setTimeout(() => btn.remove(), 300);
            }
            showSuccessMessage('تم تثبيت التطبيق بنجاح! 🎉');
        });

        // Network status
        window.addEventListener('online', () => {
            showNetworkStatus('متصل بالإنترنت ✓', 'success');
        });

        window.addEventListener('offline', () => {
            showNetworkStatus('غير متصل - وضع دون اتصال', 'warning');
        });

        function showNetworkStatus(message, type) {
            const div = document.createElement('div');
            div.className = `fixed top-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl z-50 font-bold ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-orange-600 text-white'
            }`;
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transition = 'opacity 0.3s';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        function showSuccessMessage(message) {
            const div = document.createElement('div');
            div.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white px-8 py-6 rounded-xl shadow-2xl z-[60] text-center';
            div.innerHTML = `<div class="text-6xl mb-4">✅</div><div class="text-xl font-bold text-gray-900">${message}</div>`;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transition = 'opacity 0.3s';
                setTimeout(() => div.remove(), 300);
            }, 2500);
        }

        function showUpdateNotification() {
            const div = document.createElement('div');
            div.className = 'fixed bottom-24 left-6 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 max-w-sm';
            div.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="text-2xl">🔄</div>
                    <div class="flex-1">
                        <div class="font-bold mb-1">تحديث جديد متاح!</div>
                        <div class="text-sm text-blue-100 mb-3">يوجد إصدار جديد من التطبيق</div>
                        <button onclick="window.location.reload()" class="bg-white text-blue-600 px-4 py-2 rounded font-bold text-sm hover:bg-blue-50">
                            تحديث الآن
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.opacity = '0';
                div.style.transition = 'opacity 0.3s';
                setTimeout(() => div.remove(), 300);
            }, 10000);
        }
    </script>
</body>
</html>
