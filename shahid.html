function renderViolationsSection(filtered) {
            const stats = getStats();
            const tabClass = (tab) => `px-5 py-2.5 rounded-lg font-medium transition-all duration-200 ${
                state.filters.selectedTab === tab 
                    ? 'bg-blue-600 text-white shadow-md' 
                    : 'text-gray-600 hover:bg-gray-100'
            }`;

            return `
                <div class="bg-white rounded-xl shadow-lg mb-6">
                    <div class="border-b px-6 py-4">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex gap-3">
                                <button onclick="setFilter('selectedTab', 'all')" class="${tabClass('all')}">
                                    جميع المخالفات (${state.violations.length})
                                </button>
                                <button onclick="setFilter('selectedTab', 'active')" class="${tabClass('active')}">
                                    النشطة (${stats.active})
                                </button>
                                <button onclick="setFilter('selectedTab', 'resolved')" class="${tabClass('resolved')}">
                                    المحلولة (${stats.resolved})
                                </button>
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="exportToCSV()" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-md">
                                    📥 تصدير Excel
                                </button>
                                ${state.currentUser.role === 'teacher' ? `
                                    <button onclick="openAddForm()" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                        ➕ إضافة مخالفة جديدة
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    ${renderFilters()}
                    ${renderViolationsList(filtered)}
                </div>
            `;
        }

        function renderFilters() {
            const hasFilters = state.filters.searchStudent || state.filters.filterGrade || 
                              state.filters.filterSection || 
                              state.filters.dateFrom || state.filters.dateTo;

            return `
                <div class="p-6 bg-gray-50 border-b">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">🔍 بحث بالاسم</label>
                            <input type="text" value="${state.filters.searchStudent}" 
                                   onchange="setFilter('searchStudent', this.value)"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="اسم الطالب...">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">📊 الصف</label>
                            <select onchange="setFilter('filterGrade', this.value)" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">الكل</option>
                                ${config.grades.map(g => `<option value="${g}" ${state.filters.filterGrade === g ? 'selected' : ''}>${g}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الشعبة</label>
                            <select onchange="setFilter('filterSection', this.value)"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">الكل</option>
                                ${config.sections.map(s => `<option value="${s}" ${state.filters.filterSection === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">من تاريخ</label>
                            <input type="date" value="${state.filters.dateFrom}"
                                   onchange="setFilter('dateFrom', this.value)"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">إلى تاريخ</label>
                            <input type="date" value="${state.filters.dateTo}"
                                   onchange="setFilter('dateTo', this.value)"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    ${hasFilters ? `
                        <button onclick="clearFilters()" class="mt-4 text-sm text-blue-600 hover:text-blue-800 font-medium">
                            مسح جميع الفلاتر
                        </button>
                    ` : ''}
                </div>
            `;
        }

        function renderViolationsList(filtered) {
            if (filtered.length === 0) {
                return `
                    <div class="p-16 text-center">
                        <div class="text-6xl mb-4">⚠️</div>
                        <p class="text-xl text-gray-500 mb-2">لا توجد مخالفات للعرض</p>
                        <p class="text-sm text-gray-400">جرب تغيير الفلاتر أو إضافة مخالفة جديدة</p>
                    </div>
                `;
            }

            return `
                <div class="divide-y">
                    ${filtered.map(v => renderViolationItem(v)).join('')}
                </div>
                <div class="p-4 bg-gray-50 border-t text-center text-sm text-gray-600">
                    عرض ${filtered.length} من أصل ${state.violations.length} مخالفة
                </div>
            `;
        }

        function renderViolationItem(v) {
            const violationCount = getStudentViolationCount(v.studentName, v.teacherId);
            const isHighPriority = violationCount >= 3;
            
            return `
                <div class="p-6 hover:bg-gray-50 transition-all duration-200 ${
                    isHighPriority && v.status === 'active' ? 'bg-red-50 border-r-4 border-red-500' : ''
                }">
                    <div class="flex justify-between items-start gap-6">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3 flex-wrap">
                                <h3 class="text-xl font-bold text-gray-900">${v.studentName}</h3>
                                
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">
                                    ${v.grade}
                                </span>
                                
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">
                                    الشعبة ${v.section}
                                </span>
                                
                                <span class="px-3 py-1 rounded-full text-xs font-bold border-2 ${getDegreeColor(v.violationType)}">
                                    ${getDegreeLabel(v.violationType)}
                                </span>
                                
                                ${isHighPriority && v.status === 'active' ? `
                                    <span class="flex items-center gap-1 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md animate-pulse">
                                        ⚠️ تحت المراقبة (${violationCount} مخالفات من ${v.teacherName})
                                    </span>
                                ` : ''}
                                
                                ${v.status === 'resolved' ? `
                                    <span class="flex items-center gap-1 bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                        ✅ تم الحل
                                    </span>
                                ` : ''}
                            </div>

                            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
                                <p class="text-gray-800 mb-2 font-semibold text-lg">
                                    ${v.violationDetails}
                                </p>
                                
                                ${v.documentation ? `
                                    <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                        <p class="text-sm text-blue-900">
                                            <span class="font-bold">📝 الإجراء المتبع:</span>
                                            <br>
                                            ${v.documentation}
                                        </p>
                                    </div>
                                ` : ''}
                            </div>

                            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                                <span>👤 <strong>المعلم:</strong> ${v.teacherName}</span>
                                <span>📅 <strong>التاريخ:</strong> ${v.date}</span>
                                <span>🕐 <strong>الوقت:</strong> ${v.time}</span>
                            </div>

                            ${v.status === 'resolved' && v.resolutionReason ? `
                                <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-start gap-2 mb-2">
                                        <span class="text-2xl">🏆</span>
                                        <div class="flex-1">
                                            <p class="text-sm font-bold text-green-900 mb-1">
                                                سبب حل المخالفة (السلوك الإيجابي):
                                            </p>
                                            <p class="text-sm text-green-800 mb-2">
                                                ${v.resolutionReason}
                                            </p>
                                            <div class="flex gap-4 text-xs text-green-700">
                                                <span>تم الحل بواسطة: ${v.resolvedBy}</span>
                                                <span>في: ${new Date(v.resolvedAt).toLocaleString('ar-SA')}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex flex-col gap-2">
                            <button onclick='openDetailsModal(${JSON.stringify(v).replace(/'/g, "\\'")})'
                                    class="flex items-center gap-2 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors whitespace-nowrap">
                                👁️ التفاصيل
                            </button>
                            
                            ${v.status === 'active' && canResolveViolation(v) ? `
                                <button onclick="resolveViolation(${v.id})"
                                        class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md whitespace-nowrap">
                                    🏆 حل المخالفة
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStudentsUnderWatch() {
            if (state.currentUser.role !== 'assistant' && 
                state.currentUser.role !== 'counselor' && 
                state.currentUser.role !== 'principal') {
                return '';
            }

            const studentsUnderWatch = getStudentsByViolationCount().filter(s => s.count >= 3);

            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-red-700">
                        ⚠️ الطلاب تحت المراقبة (3 مخالفات فأكثر)
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${studentsUnderWatch.length > 0 ? studentsUnderWatch.map((student, index) => {
                            const hasAction = state.studentActions.find(a => 
                                a.studentName === student.name && 
                                a.actionBy === state.currentUser.role
                            );
                            
                            return `
                            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-bold text-gray-900">${student.name}</h3>
                                    <span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                        ${student.count} مخالفات
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">
                                    ${student.grade} - الشعبة ${student.section}
                                </div>
                                <div class="text-xs text-gray-500 mb-3">
                                    آخر مخالفة: ${student.violations[student.violations.length - 1].date}
                                </div>
                                
                                ${hasAction ? `
                                    <div class="bg-blue-100 border border-blue-300 rounded p-2 mb-3 text-xs">
                                        <div class="font-bold text-blue-900 mb-1">✅ تم اتخاذ إجراء</div>
                                        <div class="text-blue-800">${new Date(hasAction.actionDate).toLocaleDateString('ar-SA')}</div>
                                    </div>
                                ` : ''}
                                
                                <div class="flex gap-2 mt-3">
                                    <button onclick='openActionModal(${JSON.stringify(student).replace(/'/g, "\\'")})' 
                                            class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors">
                                        ${hasAction ? '📝 تعديل الإجراء' : '📋 اتخاذ إجراء'}
                                    </button>
                                    <button onclick='printStudentReport(${JSON.stringify(student).replace(/'/g, "\\'")})' 
                                            class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm font-medium transition-colors">
                                        🖨️ طباعة
                                    </button>
                                </div>
                            </div>
                        `}).join('') : `
                            <div class="col-span-full text-center py-8 text-gray-500">
                                <div class="text-5xl mb-2">✅</div>
                                <p>لا يوجد طلاب تحت المراقبة حالياً</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderAddModal() {
            const isDisabled = !state.newViolation.studentName.trim() || 
                              !state.newViolation.grade || 
                              !state.newViolation.section || 
                              !state.newViolation.violationDetails;

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target === this) closeAddForm()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold flex items-center gap-2">
                                ➕ إضافة مخالفة سلوكية جديدة
                            </h2>
                            <p class="text-blue-100 text-sm mt-1">يرجى ملء جميع البيانات المطلوبة</p>
                        </div>
                        
                        <form onsubmit="event.preventDefault(); addViolation();" class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    اسم الطالب <span class="text-red-500">*</span>
                                </label>
                                <input type="text" 
                                       id="studentNameInput"
                                       value="${state.newViolation.studentName}" 
                                       oninput="state.newViolation.studentName = this.value;"
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="أدخل اسم الطالب الثلاثي الكامل"
                                       required
                                       autocomplete="off">
                                <p class="text-xs text-gray-500 mt-1">مثال: أحمد محمد علي</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">
                                        الصف <span class="text-red-500">*</span>
                                    </label>
                                    <select id="gradeSelect" 
                                            onchange="state.newViolation.grade = this.value; render();"
                                            required
                                            class="w-full px-4 py-3 border-2 ${state.newViolation.grade ? 'border-green-500' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">اختر الصف</option>
                                        ${config.grades.map(g => `
                                            <option value="${g}" ${state.newViolation.grade === g ? 'selected' : ''}>${g}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">
                                        الشعبة <span class="text-red-500">*</span>
                                    </label>
                                    <select id="sectionSelect" 
                                            onchange="state.newViolation.section = this.value; render();"
                                            required
                                            class="w-full px-4 py-3 border-2 ${state.newViolation.section ? 'border-green-500' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">اختر الشعبة</option>
                                        ${config.sections.map(s => `
                                            <option value="${s}" ${state.newViolation.section === s ? 'selected' : ''}>${s}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    درجة المخالفة <span class="text-red-500">*</span>
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <button type="button" 
                                            onclick="state.newViolation.violationType = 'first'; state.newViolation.violationDetails = ''; render();"
                                            class="p-4 border-2 rounded-lg font-medium transition-all ${
                                                state.newViolation.violationType === 'first'
                                                    ? 'border-green-500 bg-green-50 text-green-800'
                                                    : 'border-gray-300 hover:border-green-300'
                                            }">
                                        <div class="text-lg mb-1">درجة أولى</div>
                                        <div class="text-xs text-gray-600">(درجة واحدة)</div>
                                    </button>
                                    
                                    <button type="button"
                                            onclick="state.newViolation.violationType = 'second'; state.newViolation.violationDetails = ''; render();"
                                            class="p-4 border-2 rounded-lg font-medium transition-all ${
                                                state.newViolation.violationType === 'second'
                                                    ? 'border-yellow-500 bg-yellow-50 text-yellow-800'
                                                    : 'border-gray-300 hover:border-yellow-300'
                                            }">
                                        <div class="text-lg mb-1">درجة ثانية</div>
                                        <div class="text-xs text-gray-600">(درجتين)</div>
                                    </button>
                                    
                                    <button type="button"
                                            onclick="state.newViolation.violationType = 'third'; state.newViolation.violationDetails = ''; render();"
                                            class="p-4 border-2 rounded-lg font-medium transition-all ${
                                                state.newViolation.violationType === 'third'
                                                    ? 'border-red-500 bg-red-50 text-red-800'
                                                    : 'border-gray-300 hover:border-red-300'
                                            }">
                                        <div class="text-lg mb-1">درجة ثالثة</div>
                                        <div class="text-xs text-gray-600">(ثلاث درجات)</div>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    نوع المخالفة <span class="text-red-500">*</span>
                                </label>
                                <select id="violationDetailsSelect" 
                                        onchange="state.newViolation.violationDetails = this.value; render();"
                                        required
                                        class="w-full px-4 py-3 border-2 ${state.newViolation.violationDetails ? 'border-green-500' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">اختر نوع المخالفة</option>
                                    ${config.violationTypes[state.newViolation.violationType].items.map(item => `
                                        <option value="${item}" ${state.newViolation.violationDetails === item ? 'selected' : ''}>${item}</option>
                                    `).join('')}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    توثيق المخالفة (اختياري)
                                </label>
                                <textarea id="documentationInput" 
                                          oninput="state.newViolation.documentation = this.value;"
                                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none"
                                          rows="4"
                                          placeholder="أضف تفاصيل إضافية عن المخالفة، الظروف المحيطة، أو أي معلومات مهمة...">${state.newViolation.documentation}</textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">التاريخ</label>
                                    <input id="dateInput" 
                                           type="date" 
                                           value="${state.newViolation.date}"
                                           onchange="state.newViolation.date = this.value;"
                                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">الوقت</label>
                                    <input id="timeInput" 
                                           type="time" 
                                           value="${state.newViolation.time}"
                                           onchange="state.newViolation.time = this.value;"
                                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </form>

                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t rounded-b-xl flex gap-3 justify-end">
                            <button type="button"
                                    onclick="closeAddForm()"
                                    class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">
                                إلغاء
                            </button>
                            <button type="button"
                                    onclick="addViolation()"
                                    ${isDisabled ? 'disabled title="يرجى ملء جميع الحقول المطلوبة"' : ''}
                                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-lg ${
                                        isDisabled ? 'opacity-50 cursor-not-allowed' : ''
                                    }">
                                ${isDisabled ? '⚠️ يرجى ملء جميع البيانات' : '✓ حفظ المخالفة'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetailsModal() {
            const v = state.modals.selectedViolation;
            if (!v) return '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold flex items-center gap-2">
                                👁️ تفاصيل المخالفة
                            </h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="font-bold text-lg text-gray-900 mb-3">معلومات الطالب</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <span class="text-gray-600">الاسم:</span>
                                        <span class="font-bold mr-2">${v.studentName}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">الصف:</span>
                                        <span class="font-bold mr-2">${v.grade}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">الشعبة:</span>
                                        <span class="font-bold mr-2">${v.section}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">عدد المخالفات:</span>
                                        <span class="font-bold mr-2">${getStudentViolationCount(v.studentName)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="font-bold text-lg text-gray-900 mb-3">تفاصيل المخالفة</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="px-3 py-1 rounded-full text-xs font-bold ${getDegreeColor(v.violationType)}">
                                            ${getDegreeLabel(v.violationType)}
                                        
        function renderMainContent() {
            const stats = getStats();
            const filtered = getFilteredViolations();

            return `
                <div class="max-w-7xl mx-auto px-6 py-6">
                    ${renderStats(stats)}
                    ${renderViolationsSection(filtered)}
                    ${renderStudentsUnderWatch()}
                </div>
            `;
        }

        function renderStats(stats) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-blue-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">⚠️</span>
                            <div class="text-3xl font-bold text-blue-600">${stats.active}</div>
                        </div>
                        <div class="text-gray-600 font-medium">المخالفات النشطة</div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-green-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">✅</span>
                            <div class="text-3xl font-bold text-green-600">${stats.resolved}</div>
                        </div>
                        <div class="text-gray-600 font-medium">المخالفات المحلولة</div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-orange-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">👁️</span>
                            <div class="text-3xl font-bold text-orange-600">${stats.studentsUnderWatch}</div>
                        </div>
                        <div class="text-gray-600 font-medium">طلاب تحت المراقبة</div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-purple-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">📅</span>
                            <div class="text-3xl font-bold text-purple-600">${stats.today}</div>
                        </div>
                        <div class="text-gray-600 font-medium">مخالفات اليوم</div>
                    </div>
                </div>
            `;
        }

        function renderViolationsSection(filtered) {
            const stats = getStats();
            const tabClass = (tab) => `px-5 py-2.5 rounded-lg font-medium transition-all duration-200 ${
                state.filters.selectedTab === tab 
                    ? 'bg-blue-600 text-white shadow-md' 
                    : 'text-gray-600 hover:bg-gray-100'
            }`;

            return `
                <div class="bg-white rounded-xl shadow-lg mb-6">
                    <div class="border-b px-6 py-4">
                        <div class="flex items-center<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخالفات السلوكية - متوسطة المنذر بن عمرو الأنصاري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        
        .hidden {
            display: none;
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Teachers List
        const teachersList = [
            'عبدالله بن مطر بن مصلح العمري',
            'محمد بن عماري راضي الزهراني',
            'موفق مرزوق سويرح السحيمي',
            'فواز زايد لافي المهيمزي الرشيدي',
            'فيصل عطالله حويمد الصاعدي',
            'ابراهيم عياد عيد العلوي',
            'عبدالله حمود حامد الحربي',
            'ساير فيصل سعد الله العضيله المطيري',
            'نافع شعوي نافع المطيري',
            'اسامه منور مشعل العوفي',
            'محمد عياد عليثه العوفي',
            'أحمد إبراهيم فخري التركي',
            'أحمد حامد هلال الحربي',
            'نميان علي نميان الحربي',
            'عبدالله صلاح صالح الرحيلى',
            'مشعل بن هليل بن غالب العمري الحربي',
            'علي متعب ناصر العلوي الحربي',
            'سيف عبدالمنعم حمدان العارضي',
            'محمد بن ذعار بن صالح العوفي',
            'فؤاد بن محمد بن حماد العتيبي',
            'حمزة صدقة حمزة اسلام',
            'سلمان صالح أحمد الحارثي',
            'عبيد بن دخيل بن دويهيس العياضي الحربي',
            'عبدالعزيز مفلح نويعم الرويثي',
            'فيصل عواد محمد أبو سلمي',
            'عبدالله بن محمد بن سعيد ال بحران القرني',
            'كاتب مفلح سليمان الرشيدى',
            'حبيب علي نعيس العمري الحربي',
            'ابراهيم عايض عوض الجابري',
            'سلطان عويض معيض السحيمي',
            'عبدالهادي معيض معلا الشاماني',
            'عبدالعزيز عبدالرحمن غلاب المخلفي',
            'سعد طالع حمود الحربي',
            'ناهر مشعل عويد المطيري',
            'موسى غازي سفر الحربي',
            'موسى مسعود عايض الحيسوني',
            'نواف منصور عواد الصبحي',
            'بدر عبدالعزيز شائد السحيمي',
            'فهد عويض عوض الشاماني الحربي',
            'عبدالمجيد عايد خضران الرشيدي',
            'أحمد مطر سليمان الرشيدي'
        ];

        // Users Database with Passwords (4 digits + letter)
        const usersDatabase = {
            // الإدارة
            'principal': { 
                password: '1234A', 
                role: 'principal', 
                name: 'خالد المطيري',
                id: 999
            },
            // الوكيل
            'assistant': { 
                password: '5678B', 
                role: 'assistant', 
                name: 'محمد الجابري',
                id: 998
            },
            // الموجه الطلابي
            'counselor': { 
                password: '9012C', 
                role: 'counselor', 
                name: 'محمد القحطاني',
                id: 997
            },
            // المعلمين (كل معلم له رقم سري فريد)
            'teacher_1': { password: '1111A', role: 'teacher', name: 'عبدالله بن مطر بن مصلح العمري', id: 1 },
            'teacher_2': { password: '2222B', role: 'teacher', name: 'محمد بن عماري راضي الزهراني', id: 2 },
            'teacher_3': { password: '3333C', role: 'teacher', name: 'موفق مرزوق سويرح السحيمي', id: 3 },
            'teacher_4': { password: '4444D', role: 'teacher', name: 'فواز زايد لافي المهيمزي الرشيدي', id: 4 },
            'teacher_5': { password: '5555E', role: 'teacher', name: 'فيصل عطالله حويمد الصاعدي', id: 5 },
            'teacher_6': { password: '6666F', role: 'teacher', name: 'ابراهيم عياد عيد العلوي', id: 6 },
            'teacher_7': { password: '7777G', role: 'teacher', name: 'عبدالله حمود حامد الحربي', id: 7 },
            'teacher_8': { password: '8888H', role: 'teacher', name: 'ساير فيصل سعد الله العضيله المطيري', id: 8 },
            'teacher_9': { password: '9999I', role: 'teacher', name: 'نافع شعوي نافع المطيري', id: 9 },
            'teacher_10': { password: '1010J', role: 'teacher', name: 'اسامه منور مشعل العوفي', id: 10 },
            'teacher_11': { password: '1212K', role: 'teacher', name: 'محمد عياد عليثه العوفي', id: 11 },
            'teacher_12': { password: '1313L', role: 'teacher', name: 'أحمد إبراهيم فخري التركي', id: 12 },
            'teacher_13': { password: '1414M', role: 'teacher', name: 'أحمد حامد هلال الحربي', id: 13 },
            'teacher_14': { password: '1515N', role: 'teacher', name: 'نميان علي نميان الحربي', id: 14 },
            'teacher_15': { password: '1616O', role: 'teacher', name: 'عبدالله صلاح صالح الرحيلى', id: 15 },
            'teacher_16': { password: '1717P', role: 'teacher', name: 'مشعل بن هليل بن غالب العمري الحربي', id: 16 },
            'teacher_17': { password: '1818Q', role: 'teacher', name: 'علي متعب ناصر العلوي الحربي', id: 17 },
            'teacher_18': { password: '1919R', role: 'teacher', name: 'سيف عبدالمنعم حمدان العارضي', id: 18 },
            'teacher_19': { password: '2020S', role: 'teacher', name: 'محمد بن ذعار بن صالح العوفي', id: 19 },
            'teacher_20': { password: '2121T', role: 'teacher', name: 'فؤاد بن محمد بن حماد العتيبي', id: 20 },
            'teacher_21': { password: '2222U', role: 'teacher', name: 'حمزة صدقة حمزة اسلام', id: 21 },
            'teacher_22': { password: '2323V', role: 'teacher', name: 'سلمان صالح أحمد الحارثي', id: 22 },
            'teacher_23': { password: '2424W', role: 'teacher', name: 'عبيد بن دخيل بن دويهيس العياضي الحربي', id: 23 },
            'teacher_24': { password: '2525X', role: 'teacher', name: 'عبدالعزيز مفلح نويعم الرويثي', id: 24 },
            'teacher_25': { password: '2626Y', role: 'teacher', name: 'فيصل عواد محمد أبو سلمي', id: 25 },
            'teacher_26': { password: '2727Z', role: 'teacher', name: 'عبدالله بن محمد بن سعيد ال بحران القرني', id: 26 },
            'teacher_27': { password: '2828A', role: 'teacher', name: 'كاتب مفلح سليمان الرشيدى', id: 27 },
            'teacher_28': { password: '2929B', role: 'teacher', name: 'حبيب علي نعيس العمري الحربي', id: 28 },
            'teacher_29': { password: '3030C', role: 'teacher', name: 'ابراهيم عايض عوض الجابري', id: 29 },
            'teacher_30': { password: '3131D', role: 'teacher', name: 'سلطان عويض معيض السحيمي', id: 30 },
            'teacher_31': { password: '3232E', role: 'teacher', name: 'عبدالهادي معيض معلا الشاماني', id: 31 },
            'teacher_32': { password: '3333F', role: 'teacher', name: 'عبدالعزيز عبدالرحمن غلاب المخلفي', id: 32 },
            'teacher_33': { password: '3434G', role: 'teacher', name: 'سعد طالع حمود الحربي', id: 33 },
            'teacher_34': { password: '3535H', role: 'teacher', name: 'ناهر مشعل عويد المطيري', id: 34 },
            'teacher_35': { password: '3636I', role: 'teacher', name: 'موسى غازي سفر الحربي', id: 35 },
            'teacher_36': { password: '3737J', role: 'teacher', name: 'موسى مسعود عايض الحيسوني', id: 36 },
            'teacher_37': { password: '3838K', role: 'teacher', name: 'نواف منصور عواد الصبحي', id: 37 },
            'teacher_38': { password: '3939L', role: 'teacher', name: 'بدر عبدالعزيز شائد السحيمي', id: 38 },
            'teacher_39': { password: '4040M', role: 'teacher', name: 'فهد عويض عوض الشاماني الحربي', id: 39 },
            'teacher_40': { password: '4141N', role: 'teacher', name: 'عبدالمجيد عايد خضران الرشيدي', id: 40 },
            'teacher_41': { password: '4242O', role: 'teacher', name: 'أحمد مطر سليمان الرشيدي', id: 41 }
        };

        // Application State
        let state = {
            isLoggedIn: false,
            currentUser: null,
            violations: [
                {
                    id: 1,
                    studentName: 'أحمد محمد علي',
                    grade: 'أول متوسط',
                    section: '1',
                    violationType: 'first',
                    violationDetails: 'التأخر عن الدخول للحصة',
                    teacherName: teachersList[0],
                    teacherId: 1,
                    date: '2025-10-13',
                    time: '08:30',
                    documentation: 'تأخر 15 دقيقة عن الحصة الأولى',
                    status: 'active',
                    createdAt: '2025-10-13T08:30:00'
                },
                {
                    id: 2,
                    studentName: 'أحمد محمد علي',
                    grade: 'أول متوسط',
                    section: '1',
                    violationType: 'first',
                    violationDetails: 'النوم داخل الصف',
                    teacherName: teachersList[1],
                    teacherId: 2,
                    date: '2025-10-14',
                    time: '10:15',
                    documentation: 'نام أثناء الحصة الثالثة',
                    status: 'active',
                    createdAt: '2025-10-14T10:15:00'
                },
                {
                    id: 3,
                    studentName: 'أحمد محمد علي',
                    grade: 'أول متوسط',
                    section: '1',
                    violationType: 'second',
                    violationDetails: 'عدم حضور الحصة أو الهروب منها',
                    teacherName: teachersList[2],
                    teacherId: 3,
                    date: '2025-10-14',
                    time: '11:30',
                    documentation: 'غاب عن حصة الرياضيات بدون عذر',
                    status: 'active',
                    createdAt: '2025-10-14T11:30:00'
                },
                {
                    id: 4,
                    studentName: 'خالد عبدالله سعيد',
                    grade: 'ثاني متوسط',
                    section: '3',
                    violationType: 'first',
                    violationDetails: 'إعاقة سير الحصص الدراسية',
                    teacherName: teachersList[3],
                    teacherId: 1,
                    date: '2025-10-14',
                    time: '09:00',
                    documentation: 'تحدث مع زميله أثناء الشرح',
                    status: 'active',
                    createdAt: '2025-10-14T09:00:00'
                },
                {
                    id: 5,
                    studentName: 'محمد سعد القحطاني',
                    grade: 'ثالث متوسط',
                    section: '2',
                    violationType: 'third',
                    violationDetails: 'عدم التقيد بالزي المدرسي',
                    teacherName: teachersList[4],
                    teacherId: 4,
                    date: '2025-10-12',
                    time: '07:45',
                    documentation: 'حضر بدون الزي المدرسي الرسمي',
                    status: 'resolved',
                    resolvedBy: 'محمد الجابري',
                    resolutionReason: 'التزم بالزي المدرسي لمدة أسبوع كامل',
                    resolvedAt: '2025-10-13T12:00:00',
                    createdAt: '2025-10-12T07:45:00'
                }
            ],
            studentActions: [],
            filters: {
                selectedTab: 'all',
                searchStudent: '',
                filterGrade: '',
                filterSection: '',
                dateFrom: '',
                dateTo: ''
            },
            modals: {
                showAddForm: false,
                showDetailsModal: false,
                selectedViolation: null,
                showActionModal: false,
                selectedStudent: null
            },
            newViolation: {
                studentName: '',
                grade: '',
                section: '',
                violationType: 'first',
                violationDetails: '',
                documentation: '',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().slice(0, 5)
            }
        };

        // Configuration
        const config = {
            schoolInfo: {
                name: 'متوسطة المنذر بن عمرو الأنصاري',
                principal: 'خالد المطيري',
                assistant: 'محمد الجابري',
                counselor: 'محمد القحطاني',
                type: 'بنين'
            },
            grades: ['أول متوسط', 'ثاني متوسط', 'ثالث متوسط'],
            sections: ['1', '2', '3', '4', '5', '6'],
            violationTypes: {
                first: {
                    label: 'مخالفات الدرجة الأولى (درجة واحدة)',
                    items: [
                        'التأخر عن الدخول للحصة',
                        'إعاقة سير الحصص الدراسية (تناول الأطعمة والمشروبات)',
                        'المشروبات أثناء الدرس - المقاطعة المستمرة لشرح المعلمة',
                        'النوم داخل الصف',
                        'تكرار خروج ودخول الطلابة من البوابة قبل وقت الحضور والانصراف',
                        'التجهز أمام بوابة المدرسة'
                    ]
                },
                second: {
                    label: 'مخالفات الدرجة الثانية (درجتين)',
                    items: [
                        'عدم حضور الحصة أو الهروب منها',
                        'الدخول أو الخروج من الفصل دون استئذان',
                        'دخول فصل آخر دون استئذان',
                        'إثارة الفوضى داخل الصف'
                    ]
                },
                third: {
                    label: 'مخالفات الدرجة الثالثة (ثلاث درجات)',
                    items: [
                        'عدم التقيد بالزي المدرسي',
                        'إلحاق الضرر المتعمد بممتلكات الطالبات',
                        'العبث بتجهيزات المدرسة (المعمل - أجهزة الحاسب)',
                        'امتهان الكتب الدراسية'
                    ]
                }
            }
        };

        // Authentication Functions
        function login(username, password) {
            const user = usersDatabase[username];
            
            if (!user) {
                alert('❌ اسم المستخدم غير صحيح');
                return false;
            }
            
            if (user.password !== password) {
                alert('❌ الرقم السري غير صحيح');
                return false;
            }
            
            state.isLoggedIn = true;
            state.currentUser = {
                username: username,
                role: user.role,
                name: user.name,
                id: user.id
            };
            
            render();
            return true;
        }

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                state.isLoggedIn = false;
                state.currentUser = null;
                render();
            }
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value.toUpperCase();
            
            if (!username) {
                alert('⚠️ يرجى اختيار اسم المستخدم');
                return;
            }
            
            if (!password) {
                alert('⚠️ يرجى إدخال الرقم السري');
                return;
            }
            
            login(username, password);
        }

        // Helper Functions
        function getStudentViolationCount(studentName, teacherId = null, status = 'active') {
            return state.violations.filter(v => 
                v.studentName === studentName && 
                (teacherId === null || v.teacherId === teacherId) &&
                (status === 'all' || v.status === status)
            ).length;
        }

        function getStudentsByViolationCount() {
            const studentMap = {};
            
            state.violations.filter(v => v.status === 'active').forEach(v => {
                const key = `${v.studentName}_${v.teacherId}`;
                
                if (!studentMap[key]) {
                    studentMap[key] = {
                        name: v.studentName,
                        grade: v.grade,
                        section: v.section,
                        teacherId: v.teacherId,
                        teacherName: v.teacherName,
                        count: 0,
                        violations: []
                    };
                }
                studentMap[key].count++;
                studentMap[key].violations.push(v);
            });
            
            return Object.values(studentMap)
                .filter(s => s.count >= 3)
                .sort((a, b) => b.count - a.count);
        }

        function getMyStudentsUnderWatch() {
            const studentMap = {};
            
            state.violations
                .filter(v => v.status === 'active' && v.teacherId === state.currentUser.id)
                .forEach(v => {
                    if (!studentMap[v.studentName]) {
                        studentMap[v.studentName] = {
                            name: v.studentName,
                            grade: v.grade,
                            section: v.section,
                            count: 0,
                            violations: []
                        };
                    }
                    studentMap[v.studentName].count++;
                    studentMap[v.studentName].violations.push(v);
                });
            
            return Object.values(studentMap)
                .filter(s => s.count >= 3)
                .sort((a, b) => b.count - a.count);
        }

        function getDegreeLabel(type) {
            const labels = {
                first: 'درجة أولى',
                second: 'درجة ثانية',
                third: 'درجة ثالثة'
            };
            return labels[type] || type;
        }

        function getDegreeColor(type) {
            const colors = {
                first: 'bg-green-100 text-green-800 border-green-200',
                second: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                third: 'bg-red-100 text-red-800 border-red-200'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        function getRoleLabel(role) {
            const labels = {
                teacher: 'المعلم',
                assistant: 'الوكيل',
                counselor: 'الموجه الطلابي',
                principal: 'المدير'
            };
            return labels[role];
        }

        function getFilteredViolations() {
            let filtered = [...state.violations];

            if (state.currentUser.role === 'teacher') {
                filtered = filtered.filter(v => v.teacherId === state.currentUser.id);
            } else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                const studentsUnderWatch = getStudentsByViolationCount();
                const studentTeacherPairs = studentsUnderWatch.map(s => `${s.name}_${s.teacherId}`);
                
                filtered = filtered.filter(v => 
                    studentTeacherPairs.includes(`${v.studentName}_${v.teacherId}`)
                );
            }

            if (state.filters.selectedTab === 'active') {
                filtered = filtered.filter(v => v.status === 'active');
            } else if (state.filters.selectedTab === 'resolved') {
                filtered = filtered.filter(v => v.status === 'resolved');
            }

            if (state.filters.searchStudent.trim()) {
                filtered = filtered.filter(v => 
                    v.studentName.includes(state.filters.searchStudent.trim())
                );
            }

            if (state.filters.filterGrade) {
                filtered = filtered.filter(v => v.grade === state.filters.filterGrade);
            }

            if (state.filters.filterSection) {
                filtered = filtered.filter(v => v.section === state.filters.filterSection);
            }

            if (state.filters.dateFrom) {
                filtered = filtered.filter(v => v.date >= state.filters.dateFrom);
            }

            if (state.filters.dateTo) {
                filtered = filtered.filter(v => v.date <= state.filters.dateTo);
            }

            return filtered;
        }

        function getStats() {
            let violations = [...state.violations];
            
            if (state.currentUser.role === 'teacher') {
                violations = violations.filter(v => v.teacherId === state.currentUser.id);
            } else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                const studentsUnderWatch = getStudentsByViolationCount();
                const studentTeacherPairs = studentsUnderWatch.map(s => `${s.name}_${s.teacherId}`);
                violations = violations.filter(v => 
                    studentTeacherPairs.includes(`${v.studentName}_${v.teacherId}`)
                );
            }
            
            const active = violations.filter(v => v.status === 'active').length;
            const resolved = violations.filter(v => v.status === 'resolved').length;
            
            let studentsUnderWatch = 0;
            if (state.currentUser.role === 'teacher') {
                studentsUnderWatch = getMyStudentsUnderWatch().length;
            } else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                studentsUnderWatch = getStudentsByViolationCount().length;
            } else {
                studentsUnderWatch = getStudentsByViolationCount().length;
            }
            
            const today = violations.filter(v => 
                v.date === new Date().toISOString().split('T')[0]
            ).length;

            return { active, resolved, studentsUnderWatch, today };
        }

        function canResolveViolation(violation) {
            if (state.currentUser.role === 'principal') return true;
            if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                return getStudentViolationCount(violation.studentName, violation.teacherId) >= 3;
            }
            if (state.currentUser.role === 'teacher') {
                return violation.teacherId === state.currentUser.id;
            }
            return false;
        }

        // Actions
        function setCurrentUser(role, name, id) {
            if (state.currentUser.role !== 'principal') {
                alert('⚠️ غير مصرح لك بهذا الإجراء');
                return;
            }
            
            if (role === 'teacher' && !name) {
                name = teachersList[0];
            }
            state.currentUser = { ...state.currentUser, role, name, id };
            render();
        }

        function setFilter(key, value) {
            state.filters[key] = value;
            render();
        }

        function clearFilters() {
            state.filters = {
                selectedTab: state.filters.selectedTab,
                searchStudent: '',
                filterGrade: '',
                filterSection: '',
                filterTeacher: '',
                dateFrom: '',
                dateTo: ''
            };
            render();
        }

        function openAddForm() {
            state.modals.showAddForm = true;
            render();
        }

        function closeAddForm() {
            state.modals.showAddForm = false;
            state.newViolation = {
                studentName: '',
                grade: '',
                section: '',
                violationType: 'first',
                violationDetails: '',
                documentation: '',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().slice(0, 5)
            };
            render();
        }

        function updateNewViolation(key, value) {
            state.newViolation[key] = value;
        }

        function addViolation() {
            const studentName = state.newViolation.studentName.trim();
            const grade = state.newViolation.grade;
            const section = state.newViolation.section;
            const violationType = state.newViolation.violationType;
            const violationDetails = state.newViolation.violationDetails;
            const documentation = state.newViolation.documentation.trim();
            const date = state.newViolation.date;
            const time = state.newViolation.time;
            
            if (!studentName) {
                alert('⚠️ يرجى إدخال اسم الطالب');
                return false;
            }
            
            if (!grade) {
                alert('⚠️ يرجى اختيار الصف');
                return false;
            }
            
            if (!section) {
                alert('⚠️ يرجى اختيار الشعبة');
                return false;
            }
            
            if (!violationDetails) {
                alert('⚠️ يرجى اختيار نوع المخالفة');
                return false;
            }
            
            if (!documentation) {
                alert('⚠️ يرجى كتابة توثيق المخالفة (الإجراء المتبع)\n\nهذا الحقل إلزامي لتوثيق الإجراء الذي اتخذته مع الطالب');
                return false;
            }
            
            const violation = {
                id: Math.max(...state.violations.map(v => v.id), 0) + 1,
                studentName: studentName,
                grade: grade,
                section: section,
                violationType: violationType,
                violationDetails: violationDetails,
                documentation: documentation,
                date: date,
                time: time,
                teacherName: state.currentUser.name,
                teacherId: state.currentUser.id,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            state.violations.unshift(violation);
            
            const studentViolationsCount = getStudentViolationCount(studentName, state.currentUser.id);
            
            let alertMessage = '✅ تم إضافة المخالفة بنجاح!\n\n' +
                  '👤 الطالب: ' + studentName + '\n' +
                  '📚 الصف: ' + grade + ' - الشعبة ' + section + '\n' +
                  '⚠️ المخالفة: ' + violationDetails + '\n' +
                  '📝 الإجراء المتبع: ' + documentation;
            
            if (studentViolationsCount >= 3) {
                alertMessage += '\n\n🚨 تنبيه: هذا الطالب لديه ' + studentViolationsCount + ' مخالفات منك!\n' +
                               'سيتم إحالته للوكيل/المرشد الطلابي للمتابعة.';
            }
            
            alert(alertMessage);
            closeAddForm();
            return true;
        }

        function resolveViolation(violationId) {
            const reason = prompt('أدخل سبب حل المخالفة (السلوك الإيجابي الذي قام به الطالب):');
            
            if (reason && reason.trim()) {
                state.violations = state.violations.map(v => 
                    v.id === violationId ? {
                        ...v,
                        status: 'resolved',
                        resolutionReason: reason.trim(),
                        resolvedBy: state.currentUser.name,
                        resolvedAt: new Date().toISOString()
                    } : v
                );
                render();
            }
        }

        function openDetailsModal(violation) {
            state.modals.selectedViolation = violation;
            state.modals.showDetailsModal = true;
            render();
        }

        function closeDetailsModal() {
            state.modals.showDetailsModal = false;
            state.modals.selectedViolation = null;
            render();
        }

        function openActionModal(studentData) {
            state.modals.showActionModal = true;
            state.modals.selectedStudent = studentData;
            render();
        }

        function closeActionModal() {
            state.modals.showActionModal = false;
            state.modals.selectedStudent = null;
            render();
        }

        function saveStudentAction() {
            const actionDetails = document.getElementById('actionDetailsInput')?.value.trim();
            
            if (!actionDetails) {
                alert('⚠️ يرجى إدخال تفاصيل الإجراء المتخذ');
                return;
            }

            const student = state.modals.selectedStudent;
            const violationIds = student.violations.map(v => v.id);

            const action = {
                id: Math.max(...state.studentActions.map(a => a.id || 0), 0) + 1,
                studentName: student.name,
                actionBy: state.currentUser.role,
                actionByName: state.currentUser.name,
                actionDate: new Date().toISOString(),
                actionDetails: actionDetails,
                violationsIncluded: violationIds
            };

            state.studentActions.push(action);

            alert('✅ تم حفظ الإجراء بنجاح!\n\n' +
                  '👤 الطالب: ' + student.name + '\n' +
                  '📋 الإجراء: ' + actionDetails);

            closeActionModal();
        }

        function printStudentReport(studentData) {
            const student = studentData;
            const action = state.studentActions.find(a => 
                a.studentName === student.name && 
                a.actionBy === state.currentUser.role
            );

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير مخالفات - ${student.name}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
                        body {
                            font-family: 'Cairo', sans-serif;
                            padding: 40px;
                            direction: rtl;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #2563eb;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            color: #1e40af;
                            margin: 10px 0;
                        }
                        .info-box {
                            background: #f3f4f6;
                            padding: 20px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                        }
                        .violation-item {
                            border: 2px solid #e5e7eb;
                            padding: 15px;
                            margin-bottom: 15px;
                            border-radius: 8px;
                        }
                        .action-box {
                            background: #dbeafe;
                            border: 2px solid #2563eb;
                            padding: 20px;
                            border-radius: 8px;
                            margin-top: 30px;
                        }
                        .signature-area {
                            margin-top: 50px;
                            display: flex;
                            justify-content: space-between;
                        }
                        .signature-box {
                            text-align: center;
                            width: 200px;
                        }
                        .signature-line {
                            border-top: 2px solid #000;
                            margin-top: 60px;
                            padding-top: 10px;
                        }
                        @media print {
                            body { padding: 20px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>📚 ${config.schoolInfo.name}</h1>
                        <h2>تقرير المخالفات السلوكية</h2>
                        <p>التاريخ: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>

                    <div class="info-box">
                        <h3 style="color: #1e40af; margin-bottom: 15px;">معلومات الطالب</h3>
                        <div class="info-row">
                            <strong>الاسم:</strong>
                            <span>${student.name}</span>
                        </div>
                        <div class="info-row">
                            <strong>الصف:</strong>
                            <span>${student.grade}</span>
                        </div>
                        <div class="info-row">
                            <strong>الشعبة:</strong>
                            <span>${student.section}</span>
                        </div>
                        <div class="info-row">
                            <strong>عدد المخالفات:</strong>
                            <span style="color: #dc2626; font-weight: bold;">${student.count} مخالفات</span>
                        </div>
                    </div>

                    <h3 style="color: #1e40af; margin-top: 30px; margin-bottom: 15px;">تفاصيل المخالفات:</h3>
                    ${student.violations.map((v, index) => `
                        <div class="violation-item">
                            <div style="font-weight: bold; margin-bottom: 10px;">
                                ${index + 1}. ${v.violationDetails}
                                <span style="background: ${v.violationType === 'first' ? '#dcfce7' : v.violationType === 'second' ? '#fef3c7' : '#fee2e2'}; 
                                      padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-right: 10px;">
                                    ${getDegreeLabel(v.violationType)}
                                </span>
                            </div>
                            <div style="color: #6b7280; font-size: 14px;">
                                <div>📅 التاريخ: ${v.date} | 🕐 الوقت: ${v.time}</div>
                                <div>👨‍🏫 المعلم: ${v.teacherName}</div>
                                ${v.documentation ? `<div style="margin-top: 8px;">📝 ${v.documentation}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}

                    ${action ? `
                        <div class="action-box">
                            <h3 style="color: #1e40af; margin-bottom: 15px;">
                                الإجراء المتخذ من قبل ${getRoleLabel(action.actionBy)}
                            </h3>
                            <div style="margin-bottom: 10px;">
                                <strong>المسؤول:</strong> ${action.actionByName}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>التاريخ:</strong> ${new Date(action.actionDate).toLocaleString('ar-SA')}
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 4px;">
                                <strong>تفاصيل الإجراء:</strong>
                                <p style="margin-top: 10px; line-height: 1.8;">${action.actionDetails}</p>
                            </div>
                        </div>
                    ` : ''}

                    <div class="signature-area">
                        <div class="signature-box">
                            <div class="signature-line">
                                ${state.currentUser.role === 'assistant' ? 'الوكيل' : 'المرشد الطلابي'}
                            </div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">
                                ولي الأمر
                            </div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">
                                مدير المدرسة
                            </div>
                        </div>
                    </div>

                    <div class="no-print" style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="background: #2563eb; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-family: 'Cairo', sans-serif;">
                            🖨️ طباعة التقرير
                        </button>
                        <button onclick="window.close()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-right: 10px; font-family: 'Cairo', sans-serif;">
                            إغلاق
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function exportToCSV() {
            const filtered = getFilteredViolations();
            const headers = ['#', 'الطالب', 'الصف', 'الشعبة', 'الدرجة', 'المخالفة', 'المعلم', 'التاريخ', 'الوقت', 'الحالة'];
            const rows = filtered.map((v, i) => [
                i + 1,
                v.studentName,
                v.grade,
                v.section,
                getDegreeLabel(v.violationType),
                v.violationDetails,
                v.teacherName,
                v.date,
                v.time,
                v.status === 'active' ? 'نشط' : 'محلول'
            ]);

            const csvContent = [headers, ...rows]
                .map(row => row.join(','))
                .join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `مخالفات_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Render Functions
        function render() {
            const app = document.getElementById('app');
            
            if (!state.isLoggedIn) {
                app.innerHTML = renderLoginPage();
                return;
            }
            
            app.innerHTML = `
                ${renderHeader()}
                ${renderUserTabs()}
                ${renderMainContent()}
                ${state.modals.showAddForm ? renderAddModal() : ''}
                ${state.modals.showDetailsModal ? renderDetailsModal() : ''}
                ${state.modals.showActionModal ? renderActionModal() : ''}
            `;
            attachEventListeners();
        }

        function renderLoginPage() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-8 text-center">
                            <div class="text-6xl mb-4">🔐</div>
                            <h1 class="text-3xl font-bold mb-2">نظام إدارة المخالفات</h1>
                            <p class="text-blue-100">متوسطة المنذر بن عمرو الأنصاري</p>
                        </div>
                        
                        <form onsubmit="event.preventDefault(); handleLogin();" class="p-8 space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    👤 اسم المستخدم
                                </label>
                                <select id="loginUsername" 
                                        required
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">اختر المستخدم</option>
                                    <optgroup label="الإدارة">
                                        <option value="principal">🏛️ المدير - خالد المطيري</option>
                                        <option value="assistant">📋 الوكيل - محمد الجابري</option>
                                        <option value="counselor">📢 الموجه الطلابي - محمد القحطاني</option>
                                    </optgroup>
                                    <optgroup label="المعلمين">
                                        ${Object.entries(usersDatabase)
                                            .filter(([key, user]) => user.role === 'teacher')
                                            .map(([key, user]) => `
                                                <option value="${key}">👨‍🏫 ${user.name}</option>
                                            `).join('')}
                                    </optgroup>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    🔑 الرقم السري (4 أرقام + حرف)
                                </label>
                                <input type="password" 
                                       id="loginPassword"
                                       required
                                       maxlength="5"
                                       pattern="[0-9]{4}[A-Za-z]{1}"
                                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center text-2xl tracking-widest"
                                       placeholder="0000A"
                                       autocomplete="off">
                                <p class="text-xs text-gray-500 mt-2 text-center">مثال: 1234A</p>
                            </div>

                            <button type="submit"
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-bold text-lg shadow-lg">
                                🔓 تسجيل الدخول
                            </button>

                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 text-center">
                                <p class="text-sm text-yellow-800">
                                    <strong>⚠️ تنبيه:</strong> الرقم السري خاص بك فقط.<br>
                                    لا تشاركه مع أحد!
                                </p>
                            </div>
                        </form>
                        
                        <div class="bg-gray-50 px-8 py-4 text-center text-xs text-gray-600 border-t">
                            تم إعداد هذا النظام لخدمة المدرسة فقط
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            return `
                <div class="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 text-white shadow-2xl">
                    <div class="max-w-7xl mx-auto px-6 py-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h1 class="text-4xl font-bold mb-2">📚 ${config.schoolInfo.name}</h1>
                                <p class="text-blue-100 text-lg">نظام إدارة المخالفات السلوكية - ${config.schoolInfo.type}</p>
                            </div>
                            <div class="text-left">
                                <div class="bg-blue-800 bg-opacity-50 rounded-lg p-4 backdrop-blur-sm mb-3">
                                    <p class="text-sm text-blue-100 mb-1">👤 مدير المدرسة: ${config.schoolInfo.principal}</p>
                                    <p class="text-sm text-blue-100 mb-1">👤 الوكيل: ${config.schoolInfo.assistant}</p>
                                    <p class="text-sm text-blue-100">👤 الموجه الطلابي: ${config.schoolInfo.counselor}</p>
                                </div>
                                <button onclick="logout()" 
                                        class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors font-medium shadow-lg flex items-center justify-center gap-2">
                                    🚪 تسجيل الخروج
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUserTabs() {
            if (state.currentUser.role === 'teacher') {
                return `
                    <div class="bg-white border-b shadow-sm sticky top-0 z-40">
                        <div class="max-w-7xl mx-auto px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium shadow-lg flex items-center gap-2">
                                    👨‍🏫 صفحة المعلم
                                </div>
                                <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                                    <p class="text-sm text-blue-900">
                                        <span class="font-bold">المستخدم الحالي:</span> ${state.currentUser.name}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (state.currentUser.role === 'principal') {
                const isActive = (role) => state.currentUser.role === role;
                const btnClass = (role) => `flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all duration-200 ${
                    isActive(role) 
                        ? 'bg-blue-600 text-white shadow-lg transform scale-105' 
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`;

                return `
                    <div class="bg-white border-b shadow-sm sticky top-0 z-40">
                        <div class="max-w-7xl mx-auto px-6 py-4">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div class="flex gap-2 flex-wrap items-center">
                                    <button onclick="setCurrentUser('principal', '${config.schoolInfo.principal}', 999)" class="${btnClass('principal')}">
                                        🏛️ صفحة المدير
                                    </button>
                                    
                                    <button onclick="setCurrentUser('assistant', '${config.schoolInfo.assistant}', 998)" class="${btnClass('assistant')}">
                                        📋 صفحة الوكيل
                                    </button>
                                    
                                    <button onclick="setCurrentUser('counselor', '${config.schoolInfo.counselor}', 997)" class="${btnClass('counselor')}">
                                        📢 الموجه الطلابي
                                    </button>
                                    
                                    <select onchange="if(this.value) setCurrentUser('teacher', usersDatabase[this.value].name, usersDatabase[this.value].id)" 
                                            class="px-4 py-3 border-2 border-blue-600 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium text-blue-900 bg-blue-50">
                                        <option value="">👨‍🏫 عرض صفحة معلم</option>
                                        ${Object.entries(usersDatabase)
                                            .filter(([key, user]) => user.role === 'teacher')
                                            .map(([key, user]) => `
                                                <option value="${key}">${user.name}</option>
                                            `).join('')}
                                    </select>
                                </div>
                                <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                                    <p class="text-sm text-blue-900">
                                        <span class="font-bold">المستخدم الحالي:</span> ${state.currentUser.name} - ${getRoleLabel(state.currentUser.role)}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="bg-white border-b shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium shadow-lg flex items-center gap-2">
                                ${state.currentUser.role === 'assistant' ? '📋 صفحة الوكيل' : '📢 صفحة الموجه الطلابي'}
                            </div>
                            <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                                <p class="text-sm text-blue-900">
                                    <span class="font-bold">المستخدم الحالي:</span> ${state.currentUser.name} - ${getRoleLabel(state.currentUser.role)}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
