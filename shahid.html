<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخالفات السلوكية - متوسطة المنذر بن عمرو الأنصاري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        /* ========== قائمة المعلمين ========== */
        const teachersList = [
            'عبدالله بن مطر بن مصلح العمري','محمد بن عماري راضي الزهراني','موفق مرزوق سويرح السحيمي',
            'فواز زايد لافي المهيمزي الرشيدي','فيصل عطالله حويمد الصاعدي','ابراهيم عياد عيد العلوي',
            'عبدالله حمود حامد الحربي','ساير فيصل سعد الله العضيله المطيري','نافع شعوي نافع المطيري',
            'اسامه منور مشعل العوفي','محمد عياد عليثه العوفي','أحمد إبراهيم فخري التركي',
            'أحمد حامد هلال الحربي','نميان علي نميان الحربي','عبدالله صلاح صالح الرحيلى',
            'مشعل بن هليل بن غالب العمري الحربي','علي متعب ناصر العلوي الحربي','سيف عبدالمنعم حمدان العارضي',
            'محمد بن ذعار بن صالح العوفي','فؤاد بن محمد بن حماد العتيبي','حمزة صدقة حمزة اسلام',
            'سلمان صالح أحمد الحارثي','عبيد بن دخيل بن دويهيس العياضي الحربي','عبدالعزيز مفلح نويعم الرويثي',
            'فيصل عواد محمد أبو سلمي','عبدالله بن محمد بن سعيد ال بحران القرني','كاتب مفلح سليمان الرشيدى',
            'حبيب علي نعيس العمري الحربي','ابراهيم عايض عوض الجابري','سلطان عويض معيض السحيمي',
            'عبدالهادي معيض معلا الشاماني','عبدالعزيز عبدالرحمن غلاب المخلفي','سعد طالع حمود الحربي',
            'ناهر مشعل عويد المطيري','موسى غازي سفر الحربي','موسى مسعود عايض الحيسوني',
            'نواف منصور عواد الصبحي','بدر عبدالعزيز شائد السحيمي','فهد عويض عوض الشاماني الحربي',
            'عبدالمجيد عايد خضران الرشيدي','أحمد مطر سليمان الرشيدي'
        ];

        /* ========== الإعدادات الأساسية ========== */
        const config = {
            passwords: { 
                principal: 'A2030', 
                assistant: 'B2030', 
                counselor: 'C2030' 
            },
            schoolInfo: { 
                name: 'متوسطة المنذر بن عمرو الأنصاري', 
                principal: 'خالد المطيري', 
                assistant: 'محمد الجابري', 
                counselor: 'محمد القحطاني', 
                type: 'بنين' 
            },
            grades: ['أول متوسط', 'ثاني متوسط', 'ثالث متوسط'],
            sections: ['1', '2', '3', '4', '5', '6'],
            violationTypes: {
                first: { 
                    label: 'مخالفات الدرجة الأولى (درجة واحدة)', 
                    items: [
                        'التأخر عن الدخول للحصة',
                        'إعاقة سير الحصص الدراسية (تناول الأطعمة والمشروبات)',
                        'المشروبات أثناء الدرس - المقاطعة المستمرة لشرح المعلمة',
                        'النوم داخل الصف',
                        'تكرار خروج ودخول الطلابة من البوابة قبل وقت الحضور والانصراف',
                        'التجهز أمام بوابة المدرسة'
                    ] 
                },
                second: { 
                    label: 'مخالفات الدرجة الثانية (درجتين)', 
                    items: [
                        'عدم حضور الحصة أو الهروب منها',
                        'الدخول أو الخروج من الفصل دون استئذان',
                        'دخول فصل آخر دون استئذان',
                        'إثارة الفوضى داخل الصف'
                    ] 
                },
                third: { 
                    label: 'مخالفات الدرجة الثالثة (ثلاث درجات)', 
                    items: [
                        'عدم التقيد بالزي المدرسي',
                        'إلحاق الضرر المتعمد بممتلكات الطالبات',
                        'العبث بتجهيزات المدرسة (المعمل - أجهزة الحاسب)',
                        'امتهان الكتب الدراسية'
                    ] 
                }
            }
        };
        /* ========== حالة التطبيق ========== */
        let state = {
            currentUser: { role: 'teacher', name: teachersList[0], id: 1 },
            authenticated: { principal: false, assistant: false, counselor: false },
            violations: [
                {
                    id: 1, 
                    studentName: 'أحمد محمد علي', 
                    grade: 'أول متوسط', 
                    section: '1', 
                    violationType: 'first',
                    violationDetails: 'التأخر عن الدخول للحصة',
                    teacherName: teachersList[0], 
                    teacherId: 1, 
                    date: '2025-10-13', 
                    time: '08:30',
                    documentation: 'تأخر 15 دقيقة عن الحصة الأولى',
                    status: 'active',
                    createdAt: '2025-10-13T08:30:00'
                },
                {
                    id: 2,
                    studentName: 'أحمد محمد علي',
                    grade: 'أول متوسط',
                    section: '1',
                    violationType: 'first',
                    violationDetails: 'النوم داخل الصف',
                    teacherName: teachersList[1],
                    teacherId: 2,
                    date: '2025-10-14',
                    time: '10:15',
                    documentation: 'نام أثناء الحصة الثالثة',
                    status: 'active',
                    createdAt: '2025-10-14T10:15:00'
                },
                {
                    id: 3,
                    studentName: 'أحمد محمد علي',
                    grade: 'أول متوسط',
                    section: '1',
                    violationType: 'second',
                    violationDetails: 'عدم حضور الحصة أو الهروب منها',
                    teacherName: teachersList[2],
                    teacherId: 3,
                    date: '2025-10-14',
                    time: '11:30',
                    documentation: 'غاب عن حصة الرياضيات بدون عذر',
                    status: 'active',
                    createdAt: '2025-10-14T11:30:00'
                },
                {
                    id: 4,
                    studentName: 'خالد عبدالله سعيد',
                    grade: 'ثاني متوسط',
                    section: '3',
                    violationType: 'first',
                    violationDetails: 'إعاقة سير الحصص الدراسية',
                    teacherName: teachersList[3],
                    teacherId: 1,
                    date: '2025-10-14',
                    time: '09:00',
                    documentation: 'تحدث مع زميله أثناء الشرح',
                    status: 'active',
                    createdAt: '2025-10-14T09:00:00'
                },
                {
                    id: 5,
                    studentName: 'محمد سعد القحطاني',
                    grade: 'ثالث متوسط',
                    section: '2',
                    violationType: 'third',
                    violationDetails: 'عدم التقيد بالزي المدرسي',
                    teacherName: teachersList[4],
                    teacherId: 4,
                    date: '2025-10-12',
                    time: '07:45',
                    documentation: 'حضر بدون الزي المدرسي الرسمي',
                    status: 'resolved',
                    resolvedBy: 'محمد الجابري',
                    resolutionReason: 'التزم بالزي المدرسي لمدة أسبوع كامل',
                    resolvedAt: '2025-10-13T12:00:00',
                    createdAt: '2025-10-12T07:45:00'
                }
            ],
            studentActions: [],
            filters: { 
                selectedTab: 'all', 
                searchStudent: '', 
                filterGrade: '', 
                filterSection: '', 
                dateFrom: '', 
                dateTo: '' 
            },
            modals: { 
                showAddForm: false, 
                showDetailsModal: false, 
                selectedViolation: null, 
                showActionModal: false, 
                selectedStudent: null 
            },
            newViolation: { 
                studentName: '', 
                grade: '', 
                section: '', 
                violationType: 'first', 
                violationDetails: '', 
                documentation: '', 
                date: new Date().toISOString().split('T')[0], 
                time: new Date().toTimeString().slice(0, 5) 
            }
        };

        /* ========== بيانات الغياب ========== */
        let absenceRecords = [];
        
        // استقبال بيانات الغياب من صفحة absent.html
        window.addEventListener('message', e => {
            if (e.data && e.data.type === 'absenceData') {
                absenceRecords = e.data.payload || [];
                if (state.currentUser.role === 'assistant') render();
            }
        });

        // تحميل بيانات غياب تجريبية
        function loadSampleAbsenceData() {
            const today = new Date().toISOString().split('T')[0];
            absenceRecords = [
                {
                    id: 1,
                    grade: 'أول متوسط',
                    section: '1',
                    period: '1',
                    date: today,
                    absentCount: 3,
                    absentStudents: ['أحمد محمد علي', 'خالد عبدالله سعيد', 'فيصل إبراهيم الحربي'],
                    totalStudents: 30,
                    teacherName: teachersList[0],
                    recordedAt: new Date().toISOString()
                },
                {
                    id: 2,
                    grade: 'ثاني متوسط',
                    section: '3',
                    period: '1',
                    date: today,
                    absentCount: 2,
                    absentStudents: ['محمد سعد القحطاني', 'عبدالرحمن الشمري'],
                    totalStudents: 27,
                    teacherName: teachersList[1],
                    recordedAt: new Date().toISOString()
                },
                {
                    id: 3,
                    grade: 'ثالث متوسط',
                    section: '2',
                    period: '1',
                    date: today,
                    absentCount: 4,
                    absentStudents: ['سعود العتيبي', 'ماجد الدوسري', 'طارق المطيري', 'ناصر الحارثي'],
                    totalStudents: 29,
                    teacherName: teachersList[2],
                    recordedAt: new Date().toISOString()
                }
            ];
        }
        
        loadSampleAbsenceData();

        /* ========== الدوال المساعدة ========== */
        function getStudentViolationCount(studentName, teacherId = null, status = 'active') {
            return state.violations.filter(v => 
                v.studentName === studentName && 
                (teacherId === null || v.teacherId === teacherId) && 
                (status === 'all' || v.status === status)
            ).length;
        }

        function getStudentsByViolationCount() {
            const map = {};
            state.violations.filter(v => v.status === 'active').forEach(v => {
                const key = `${v.studentName}_${v.teacherId}`;
                if (!map[key]) {
                    map[key] = { 
                        name: v.studentName, 
                        grade: v.grade, 
                        section: v.section, 
                        teacherId: v.teacherId, 
                        teacherName: v.teacherName, 
                        count: 0, 
                        violations: [] 
                    };
                }
                map[key].count++;
                map[key].violations.push(v);
            });
            return Object.values(map).filter(s => s.count >= 3).sort((a, b) => b.count - a.count);
        }

        function getDegreeLabel(type) {
            const map = {
                first: 'درجة أولى',
                second: 'درجة ثانية',
                third: 'درجة ثالثة'
            };
            return map[type] || type;
        }

        function getDegreeColor(type) {
            const map = {
                first: 'bg-green-100 text-green-800 border-green-200',
                second: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                third: 'bg-red-100 text-red-800 border-red-200'
            };
            return map[type] || 'bg-gray-100 text-gray-800';
        }

        function getRoleLabel(role) {
            const map = {
                teacher: 'المعلم',
                assistant: 'الوكيل',
                counselor: 'الموجه الطلابي',
                principal: 'المدير'
            };
            return map[role];
        }

        function getFilteredViolations() {
            let filtered = [...state.violations];
            
            // فلتر حسب دور المستخدم
            if (state.currentUser.role === 'teacher') {
                filtered = filtered.filter(v => v.teacherId === state.currentUser.id);
            } else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                const studentsWatch = getStudentsByViolationCount();
                const studentTeacherPairs = studentsWatch.map(s => `${s.name}_${s.teacherId}`);
                filtered = filtered.filter(v => studentTeacherPairs.includes(`${v.studentName}_${v.teacherId}`));
            }
            
            // فلتر حسب التبويب
            if (state.filters.selectedTab === 'active') {
                filtered = filtered.filter(v => v.status === 'active');
            }
            if (state.filters.selectedTab === 'resolved') {
                filtered = filtered.filter(v => v.status === 'resolved');
            }
            
            // فلاتر البحث
            if (state.filters.searchStudent.trim()) {
                filtered = filtered.filter(v => v.studentName.includes(state.filters.searchStudent.trim()));
            }
            if (state.filters.filterGrade) {
                filtered = filtered.filter(v => v.grade === state.filters.filterGrade);
            }
            if (state.filters.filterSection) {
                filtered = filtered.filter(v => v.section === state.filters.filterSection);
            }
            if (state.filters.dateFrom) {
                filtered = filtered.filter(v => v.date >= state.filters.dateFrom);
            }
            if (state.filters.dateTo) {
                filtered = filtered.filter(v => v.date <= state.filters.dateTo);
            }
            
            return filtered;
        }

        function getStats() {
            let violations = [...state.violations];
            
            if (state.currentUser.role === 'teacher') {
                violations = violations.filter(v => v.teacherId === state.currentUser.id);
            } else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                const studentsWatch = getStudentsByViolationCount();
                const studentTeacherPairs = studentsWatch.map(s => `${s.name}_${s.teacherId}`);
                violations = violations.filter(v => studentTeacherPairs.includes(`${v.studentName}_${v.teacherId}`));
            }
            
            const active = violations.filter(v => v.status === 'active').length;
            const resolved = violations.filter(v => v.status === 'resolved').length;
            const today = violations.filter(v => v.date === new Date().toISOString().split('T')[0]).length;
            
            let studentsUnderWatch = 0;
            if (state.currentUser.role === 'teacher') {
                studentsUnderWatch = getMyStudentsUnderWatch().length;
            } else {
                studentsUnderWatch = getStudentsByViolationCount().length;
            }
            
            return { active, resolved, studentsUnderWatch, today };
        }

        function getMyStudentsUnderWatch() {
            const map = {};
            state.violations
                .filter(v => v.status === 'active' && v.teacherId === state.currentUser.id)
                .forEach(v => {
                    if (!map[v.studentName]) {
                        map[v.studentName] = {
                            name: v.studentName,
                            grade: v.grade,
                            section: v.section,
                            count: 0,
                            violations: []
                        };
                    }
                    map[v.studentName].count++;
                    map[v.studentName].violations.push(v);
                });
            return Object.values(map).filter(s => s.count >= 3).sort((a, b) => b.count - a.count);
        }

        function canResolveViolation(violation) {
            if (state.currentUser.role === 'principal') return true;
            if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                return getStudentViolationCount(violation.studentName, violation.teacherId) >= 3;
            }
            if (state.currentUser.role === 'teacher') {
                return violation.teacherId === state.currentUser.id;
            }
            return false;
        }

        /* ========== دوال الأحداث ========== */
        function setCurrentUser(role, name, id) {
            if (role === 'principal' || role === 'assistant' || role === 'counselor') {
                if (!state.authenticated[role]) {
                    const password = prompt(`🔒 يرجى إدخال كلمة السر لصفحة ${getRoleLabel(role)}:`);
                    if (password !== config.passwords[role]) {
                        alert('❌ كلمة السر غير صحيحة!');
                        return;
                    }
                    state.authenticated[role] = true;
                    alert(`✅ تم تسجيل الدخول بنجاح إلى صفحة ${getRoleLabel(role)}`);
                }
            }
            if (role === 'teacher' && !name) name = teachersList[0];
            state.currentUser = { role, name, id };
            render();
        }

        function setFilter(key, value) {
            state.filters[key] = value;
            render();
        }

        function clearFilters() {
            state.filters = {
                selectedTab: state.filters.selectedTab,
                searchStudent: '',
                filterGrade: '',
                filterSection: '',
                dateFrom: '',
                dateTo: ''
            };
            render();
        }

        function openAddForm() {
            state.modals.showAddForm = true;
            render();
        }

        function closeAddForm() {
            state.modals.showAddForm = false;
            state.newViolation = {
                studentName: '',
                grade: '',
                section: '',
                violationType: 'first',
                violationDetails: '',
                documentation: '',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().slice(0, 5)
            };
            render();
        }

        function addViolation() {
            const { studentName, grade, section, violationType, violationDetails, documentation, date, time } = state.newViolation;
            
            if (!studentName.trim() || !grade || !section || !violationDetails || !documentation.trim()) {
                alert('⚠️ يرجى ملء جميع الحقول المطلوبة');
                return false;
            }
            
            const newId = Math.max(0, ...state.violations.map(v => v.id)) + 1;
            state.violations.unshift({
                id: newId,
                studentName: studentName.trim(),
                grade,
                section,
                violationType,
                violationDetails,
                documentation: documentation.trim(),
                date,
                time,
                teacherName: state.currentUser.name,
                teacherId: state.currentUser.id,
                status: 'active',
                createdAt: new Date().toISOString()
            });
            
            const count = getStudentViolationCount(studentName.trim(), state.currentUser.id);
            alert(`✅ تم إضافة المخالفة بنجاح!\n👤 الطالب: ${studentName}\n📚 الصف: ${grade} - الشعبة ${section}\n⚠️ المخالفة: ${violationDetails}\n📝 الإجراء المتبع: ${documentation}${count >= 3 ? `\n\n🚨 تنبيه: هذا الطالب لديه ${count} مخالفات منك!\nسيتم إحالته للوكيل/المرشد الطلابي للمتابعة.` : ''}`);
            
            closeAddForm();
            return true;
        }

        function resolveViolation(violationId) {
            const reason = prompt('أدخل سبب حل المخالفة (السلوك الإيجابي الذي قام به الطالب):');
            if (reason && reason.trim()) {
                state.violations = state.violations.map(v =>
                    v.id === violationId
                        ? {
                            ...v,
                            status: 'resolved',
                            resolutionReason: reason.trim(),
                            resolvedBy: state.currentUser.name,
                            resolvedAt: new Date().toISOString()
                        }
                        : v
                );
                render();
            }
        }

        function openDetailsModal(violation) {
            state.modals.selectedViolation = violation;
            state.modals.showDetailsModal = true;
            render();
        }

        function closeDetailsModal() {
            state.modals.showDetailsModal = false;
            state.modals.selectedViolation = null;
            render();
        }

        function openActionModal(studentData) {
            state.modals.showActionModal = true;
            state.modals.selectedStudent = studentData;
            render();
        }

        function closeActionModal() {
            state.modals.showActionModal = false;
            state.modals.selectedStudent = null;
            render();
        }

        function saveStudentAction() {
            const details = document.getElementById('actionDetailsInput')?.value.trim();
            if (!details) {
                alert('⚠️ يرجى إدخال تفاصيل الإجراء المتخذ');
                return;
            }
            
            const student = state.modals.selectedStudent;
            const existingActionIndex = state.studentActions.findIndex(
                a => a.studentName === student.name && a.actionBy === state.currentUser.role
            );
            
            if (existingActionIndex !== -1) {
                state.studentActions[existingActionIndex] = {
                    ...state.studentActions[existingActionIndex],
                    actionDetails: details,
                    actionDate: new Date().toISOString()
                };
            } else {
                state.studentActions.push({
                    id: Math.max(0, ...state.studentActions.map(a => a.id || 0)) + 1,
                    studentName: student.name,
                    actionBy: state.currentUser.role,
                    actionByName: state.currentUser.name,
                    actionDate: new Date().toISOString(),
                    actionDetails: details,
                    violationsIncluded: student.violations.map(v => v.id)
                });
            }
            
            alert('✅ تم حفظ الإجراء بنجاح!');
            closeActionModal();
        }

        /* ========== دوال الطباعة ========== */
        function printStudentReport(studentData) {
            const student = studentData;
            const action = state.studentActions.find(
                a => a.studentName === student.name && a.actionBy === state.currentUser.role
            );
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير مخالفات - ${student.name}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
                        body { font-family: 'Cairo', sans-serif; padding: 40px; direction: rtl; }
                        .header { text-align: center; border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { color: #1e40af; margin: 10px 0; }
                        .info-box { background: #f3f4f6; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
                        .violation-item { border: 2px solid #e5e7eb; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
                        .action-box { background: #dbeafe; border: 2px solid #2563eb; padding: 20px; border-radius: 8px; margin-top: 30px; }
                        .signature-area { margin-top: 50px; display: flex; justify-content: space-between; }
                        .signature-box { text-align: center; width: 200px; }
                        .signature-line { border-top: 2px solid #000; margin-top: 60px; padding-top: 10px; }
                        @media print { body { padding: 20px; } .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>📚 ${config.schoolInfo.name}</h1>
                        <h2>تقرير المخالفات السلوكية</h2>
                        <p>التاريخ: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                    
                    <div class="info-box">
                        <h3 style="color:#1e40af;margin-bottom:15px">معلومات الطالب</h3>
                        <div class="info-row"><strong>الاسم:</strong><span>${student.name}</span></div>
                        <div class="info-row"><strong>الصف:</strong><span>${student.grade}</span></div>
                        <div class="info-row"><strong>الشعبة:</strong><span>${student.section}</span></div>
                        <div class="info-row"><strong>عدد المخالفات:</strong><span style="color:#dc2626;font-weight:bold">${student.count} مخالفات</span></div>
                    </div>
                    
                    <h3 style="color:#1e40af;margin-top:30px;margin-bottom:15px">تفاصيل المخالفات:</h3>
                    ${student.violations.map((v, i) => `
                        <div class="violation-item">
                            <div style="font-weight:bold;margin-bottom:10px">
                                ${i + 1}. ${v.violationDetails}
                                <span style="background:${v.violationType === 'first' ? '#dcfce7' : v.violationType === 'second' ? '#fef3c7' : '#fee2e2'};padding:4px 12px;border-radius:20px;font-size:12px;margin-right:10px">
                                    ${getDegreeLabel(v.violationType)}
                                </span>
                            </div>
                            <div style="color:#6b7280;font-size:14px">
                                <div>📅 التاريخ: ${v.date} | 🕐 الوقت: ${v.time}</div>
                                <div>👨‍🏫 المعلم: ${v.teacherName}</div>
                                ${v.documentation ? `<div style="margin-top:8px">📝 ${v.documentation}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                    
                    ${action ? `
                        <div class="action-box">
                            <h3 style="color:#1e40af;margin-bottom:15px">الإجراء المتخذ من قبل ${getRoleLabel(action.actionBy)}</h3>
                            <div style="margin-bottom:10px"><strong>المسؤول:</strong> ${action.actionByName}</div>
                            <div style="margin-bottom:10px"><strong>التاريخ:</strong> ${new Date(action.actionDate).toLocaleString('ar-SA')}</div>
                            <div style="margin-top:15px;padding:15px;background:white;border-radius:4px">
                                <strong>تفاصيل الإجراء:</strong>
                                <p style="margin-top:10px;line-height:1.8">${action.actionDetails}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="signature-area">
                        <div class="signature-box">
                            <div class="signature-line">${state.currentUser.role === 'assistant' ? 'الوكيل' : 'المرشد الطلابي'}</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">ولي الأمر</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">مدير المدرسة</div>
                        </div>
                    </div>
                    
                    <div class="no-print" style="text-align:center;margin-top:30px">
                        <button onclick="window.print()" style="background:#2563eb;color:white;padding:12px 30px;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-family:'Cairo',sans-serif">
                            🖨️ طباعة التقرير
                        </button>
                        <button onclick="window.close()" style="background:#6b7280;color:white;padding:12px 30px;border:none;border-radius:8px;font-size:16px;cursor:pointer;margin-right:10px;font-family:'Cairo',sans-serif">
                            إغلاق
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function printClassAbsence(record) {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>قائمة الغياب - ${record.grade} - ${record.section}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Cairo', sans-serif; padding: 40px; background: white; color: #000; }
                        .header { text-align: center; border-bottom: 4px solid #059669; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { color: #059669; font-size: 28px; margin-bottom: 10px; }
                        .header .date { color: #666; font-size: 16px; }
                        .info-box { background: #f3f4f6; border: 2px solid #d1d5db; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
                        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #d1d5db; }
                        .info-row:last-child { border-bottom: none; }
                        .info-label { font-weight: bold; color: #374151; }
                        .info-value { color: #059669; font-weight: bold; }
                        .students-section { margin: 30px 0; }
                        .students-section h2 { color: #dc2626; border-bottom: 3px solid #dc2626; padding-bottom: 10px; margin-bottom: 20px; }
                        .student-item { background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
                        .student-number { background: #f59e0b; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
                        .student-name { flex: 1; font-size: 18px; font-weight: bold; color: #000; }
                        .signature-section { display: flex; justify-content: space-between; margin-top: 60px; page-break-inside: avoid; }
                        .signature-box { text-align: center; width: 200px; }
                        .signature-line { border-top: 2px solid #000; margin-top: 60px; padding-top: 10px; font-weight: bold; }
                        @media print {
                            body { padding: 20px; }
                            .no-print { display: none; }
                            @page { margin: 2cm; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🏫 ${config.schoolInfo.name}</h1>
                        <p class="date">📋 قائمة الغياب اليومية - الحصة الأولى</p>
                        <p class="date">${new Date().toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>

                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">📚 الصف:</span>
                            <span class="info-value">${record.grade}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">🔢 الشعبة:</span>
                            <span class="info-value">${record.section}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">👥 إجمالي الطلاب:</span>
                            <span class="info-value">${record.totalStudents} طالب</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">⚠️ عدد الغياب:</span>
                            <span class="info-value" style="color: #dc2626;">${record.absentCount} طالب</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">✅ نسبة الحضور:</span>
                            <span class="info-value">${((record.totalStudents - record.absentCount) / record.totalStudents * 100).toFixed(1)}%</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">👨‍🏫 المعلم:</span>
                            <span class="info-value" style="color: #000;">${record.teacherName}</span>
                        </div>
                    </div>

                    ${record.absentCount > 0 ? `
                        <div class="students-section">
                            <h2>⚠️ قائمة الطلاب الغائبين (${record.absentCount})</h2>
                            ${record.absentStudents.map((student, i) => `
                                <div class="student-item">
                                    <div class="student-number">${i + 1}</div>
                                    <div class="student-name">${student}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 40px; background: #d1fae5; border: 2px solid #059669; border-radius: 8px;">
                            <div style="font-size: 60px; margin-bottom: 20px;">✅</div>
                            <h2 style="color: #059669; font-size: 24px;">لا يوجد غياب في هذا الفصل</h2>
                            <p style="color: #047857; margin-top: 10px;">جميع الطلاب حاضرون</p>
                        </div>
                    `}

                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line">وكيل المدرسة</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">مدير المدرسة</div>
                        </div>
                    </div>

                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                            }, 500);
                        };
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function printDailyAbsenceReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayAbsence = absenceRecords.filter(a => a.date === today && a.period === '1');
            
            if (todayAbsence.length === 0) {
                alert('⚠️ لا يوجد غياب مسجل للطباعة');
                return;
            }

            const totalAbsent = todayAbsence.reduce((sum, a) => sum + a.absentCount, 0);
            const totalStudents = todayAbsence.reduce((sum, a) => sum + a.totalStudents, 0);
            const attendanceRate = ((totalStudents - totalAbsent) / totalStudents * 100).toFixed(1);

            const printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>التقرير اليومي الشامل للغياب</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Cairo', sans-serif; padding: 30px; background: white; color: #000; }
                        .header { text-align: center; background: linear-gradient(135deg, #059669, #047857); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
                        .header h1 { font-size: 32px; margin-bottom: 10px; }
                        .header .subtitle { font-size: 18px; opacity: 0.9; }
                        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
                        .stat-card { background: #f3f4f6; border: 2px solid #d1d5db; border-radius: 8px; padding: 20px; text-align: center; }
                        .stat-card .value { font-size: 32px; font-weight: bold; color: #059669; margin: 10px 0; }
                        .stat-card .label { color: #666; font-size: 14px; }
                        .class-section { background: #fff; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; }
                        .class-header { background: #059669; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
                        .class-title { font-size: 20px; font-weight: bold; }
                        .class-stats { font-size: 14px; }
                        .students-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
                        .student-item { background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 10px; display: flex; align-items: center; gap: 10px; }
                        .student-number { background: #f59e0b; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0; }
                        .student-name { font-size: 14px; font-weight: bold; }
                        .no-absence { text-align: center; padding: 20px; background: #d1fae5; border: 2px solid #059669; border-radius: 8px; color: #047857; }
                        .teacher-info { margin-top: 10px; padding-top: 10px; border-top: 1px solid #d1d5db; font-size: 12px; color: #666; }
                        .signature-section { display: flex; justify-content: space-around; margin-top: 50px; page-break-inside: avoid; }
                        .signature-box { text-align: center; width: 200px; }
                        .signature-line { border-top: 2px solid #000; margin-top: 50px; padding-top: 10px; font-weight: bold; }
                        @media print {
                            body { padding: 15px; }
                            .no-print { display: none; }
                            @page { margin: 1.5cm; size: A4; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🏫 ${config.schoolInfo.name}</h1>
                        <p class="subtitle">📋 التقرير اليومي الشامل للغياب - الحصة الأولى</p>
                        <p class="subtitle">${new Date().toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <div class="label">إجمالي الفصول</div>
                            <div class="value">${todayAbsence.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">إجمالي الطلاب</div>
                            <div class="value">${totalStudents}</div>
                        </div>
                        <div class="stat-card" style="border-color: #dc2626;">
                            <div class="label">إجمالي الغياب</div>
                            <div class="value" style="color: #dc2626;">${totalAbsent}</div>
                        </div>
                        <div class="stat-card" style="border-color: #059669;">
                            <div class="label">نسبة الحضور</div>
                            <div class="value" style="color: #059669;">${attendanceRate}%</div>
                        </div>
                    </div>

                    ${todayAbsence.map((record, index) => {
                        const classAttendanceRate = ((record.totalStudents - record.absentCount) / record.totalStudents * 100).toFixed(1);
                        return `
                            <div class="class-section">
                                <div class="class-header">
                                    <div class="class-title">${record.grade} - الشعبة ${record.section}</div>
                                    <div class="class-stats">
                                        الحضور: ${record.totalStudents - record.absentCount}/${record.totalStudents} 
                                        (${classAttendanceRate}%)
                                    </div>
                                </div>
                                
                                ${record.absentCount > 0 ? `
                                    <h3 style="color: #dc2626; margin-bottom: 15px; font-size: 16px;">
                                        ⚠️ الطلاب الغائبون (${record.absentCount})
                                    </h3>
                                    <div class="students-grid">
                                        ${record.absentStudents.map((student, i) => `
                                            <div class="student-item">
                                                <div class="student-number">${i + 1}</div>
                                                <div class="student-name">${student}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="no-absence">
                                        <strong>✅ لا يوجد غياب - جميع الطلاب حاضرون</strong>
                                    </div>
                                `}
                                
                                <div class="teacher-info">
                                    <strong>المعلم:</strong> ${record.teacherName} | 
                                    <strong>وقت التسجيل:</strong> ${new Date(record.recordedAt).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            </div>
                        `;
                    }).join('')}

                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line">المرشد الطلابي<br>${config.schoolInfo.counselor}</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">وكيل المدرسة<br>${config.schoolInfo.assistant}</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">مدير المدرسة<br>${config.schoolInfo.principal}</div>
                        </div>
                    </div>

                    <script>
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                            }, 500);
                        };
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function exportToCSV() {
            const filtered = getFilteredViolations();
            const headers = ['#', 'الطالب', 'الصف', 'الشعبة', 'الدرجة', 'المخالفة', 'المعلم', 'التاريخ', 'الوقت', 'الحالة'];
            const rows = filtered.map((v, i) => [
                i + 1,
                v.studentName,
                v.grade,
                v.section,
                getDegreeLabel(v.violationType),
                v.violationDetails,
                v.teacherName,
                v.date,
                v.time,
                v.status === 'active' ? 'نشط' : 'محلول'
            ]);
            const csvContent = [headers, ...rows].map(r => r.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `مخالفات_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

/* ========== دوال العرض ========== */
        function render() {
            const stats = getStats();
            const filtered = getFilteredViolations();
            document.getElementById('app').innerHTML = `
                ${renderHeader()}
                ${renderUserTabs()}
                ${renderMainContent(stats, filtered)}
                ${state.modals.showAddForm ? renderAddModal() : ''}
                ${state.modals.showDetailsModal ? renderDetailsModal() : ''}
                ${state.modals.showActionModal ? renderActionModal() : ''}
            `;
        }

        function renderHeader() {
            return `
                <div class="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 text-white shadow-2xl">
                    <div class="max-w-7xl mx-auto px-6 py-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h1 class="text-4xl font-bold mb-2">📚 ${config.schoolInfo.name}</h1>
                                <p class="text-blue-100 text-lg">نظام إدارة المخالفات السلوكية - ${config.schoolInfo.type}</p>
                            </div>
                            <div class="text-left bg-blue-800 bg-opacity-50 rounded-lg p-4 backdrop-blur-sm">
                                <p class="text-sm text-blue-100 mb-1">👤 مدير المدرسة: ${config.schoolInfo.principal}</p>
                                <p class="text-sm text-blue-100 mb-1">👤 الوكيل: ${config.schoolInfo.assistant}</p>
                                <p class="text-sm text-blue-100">👤 الموجه الطلابي: ${config.schoolInfo.counselor}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUserTabs() {
            const isActive = role => state.currentUser.role === role;
            const btn = (role, icon, label) => `
                <button onclick="setCurrentUser('${role}', '${config.schoolInfo[role] || ''}', ${role === 'teacher' ? 1 : role === 'assistant' ? 2 : role === 'counselor' ? 3 : 4})" 
                    class="flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${isActive(role) ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                    ${icon} ${label}
                </button>
            `;

            return `
                <div class="bg-white border-b shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex gap-2 flex-wrap items-center">
                                ${state.currentUser.role === 'teacher' ? `
                                    <select onchange="setCurrentUser('teacher', this.value, 1)" 
                                        class="px-4 py-3 border-2 border-blue-600 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium text-blue-900 bg-blue-50">
                                        ${teachersList.map(t => `<option ${state.currentUser.name === t ? 'selected' : ''}>👨‍🏫 ${t}</option>`).join('')}
                                    </select>
                                ` : btn('teacher', '👨‍🏫', 'صفحة المعلم')}
                                ${btn('assistant', '📋', 'صفحة الوكيل')}
                                ${btn('counselor', '📢', 'الموجه الطلابي')}
                                ${btn('principal', '🛡️', 'صفحة المدير')}
                                <a href="https://nawafoooh.github.io/activity/absent.html" 
                                    class="px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                                    📋 تسجيل الغياب
                                </a>
                            </div>
                            <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                                <p class="text-sm text-blue-900">
                                    <span class="font-bold">المستخدم الحالي:</span> ${state.currentUser.name} - ${getRoleLabel(state.currentUser.role)}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainContent(stats, filtered) {
            return `
                <div class="max-w-7xl mx-auto px-6 py-6">
                    ${renderStats(stats)}
                    ${renderViolationsSection(stats, filtered)}
                    ${renderStudentsUnderWatch()}
                </div>
            `;
        }

        function renderStats({ active, resolved, studentsUnderWatch, today }) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">⚠️</span>
                            <div class="text-3xl font-bold text-blue-600">${active}</div>
                        </div>
                        <div class="text-gray-600 font-medium">المخالفات النشطة</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">✅</span>
                            <div class="text-3xl font-bold text-green-600">${resolved}</div>
                        </div>
                        <div class="text-gray-600 font-medium">المخالفات المحلولة</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-orange-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">👁️</span>
                            <div class="text-3xl font-bold text-orange-600">${studentsUnderWatch}</div>
                        </div>
                        <div class="text-gray-600 font-medium">طلاب تحت المراقبة</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">📅</span>
                            <div class="text-3xl font-bold text-purple-600">${today}</div>
                        </div>
                        <div class="text-gray-600 font-medium">مخالفات اليوم</div>
                    </div>
                </div>
            `;
        }

function renderViolationsSection(stats, filtered) {
            const tabClass = tab => `px-5 py-2.5 rounded-lg font-medium transition-all ${state.filters.selectedTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}`;
            const hasFilters = state.filters.searchStudent || state.filters.filterGrade || state.filters.filterSection || state.filters.dateFrom || state.filters.dateTo;
            
            return `
                <div class="bg-white rounded-xl shadow-lg mb-6">
                    <div class="border-b px-6 py-4">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex gap-3">
                                <button onclick="setFilter('selectedTab', 'all')" class="${tabClass('all')}">
                                    جميع المخالفات (${state.violations.length})
                                </button>
                                <button onclick="setFilter('selectedTab', 'active')" class="${tabClass('active')}">
                                    النشطة (${stats.active})
                                </button>
                                <button onclick="setFilter('selectedTab', 'resolved')" class="${tabClass('resolved')}">
                                    المحلولة (${stats.resolved})
                                </button>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="exportToCSV()" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-md">
                                    📥 تصدير Excel
                                </button>
                                ${state.currentUser.role === 'teacher' ? `
                                    <button onclick="openAddForm()" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                        ➕ إضافة مخالفة جديدة
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 bg-gray-50 border-b">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">🔍 بحث بالاسم</label>
                                <input type="text" value="${state.filters.searchStudent}" 
                                    onchange="setFilter('searchStudent', this.value)" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                    placeholder="اسم الطالب...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">📊 الصف</label>
                                <select onchange="setFilter('filterGrade', this.value)" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">الكل</option>
                                    ${config.grades.map(g => `<option value="${g}" ${state.filters.filterGrade === g ? 'selected' : ''}>${g}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الشعبة</label>
                                <select onchange="setFilter('filterSection', this.value)" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">الكل</option>
                                    ${config.sections.map(s => `<option value="${s}" ${state.filters.filterSection === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">من تاريخ</label>
                                <input type="date" value="${state.filters.dateFrom}" 
                                    onchange="setFilter('dateFrom', this.value)" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">إلى تاريخ</label>
                                <input type="date" value="${state.filters.dateTo}" 
                                    onchange="setFilter('dateTo', this.value)" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        ${hasFilters ? `
                            <button onclick="clearFilters()" class="mt-4 text-sm text-blue-600 hover:text-blue-800 font-medium">
                                مسح جميع الفلاتر
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="divide-y">
                        ${filtered.map(v => renderViolationItem(v)).join('')}
                    </div>
                    
                    <div class="p-4 bg-gray-50 border-t text-center text-sm text-gray-600">
                        عرض ${filtered.length} من أصل ${state.violations.length} مخالفة
                    </div>
                </div>
            `;
        }

        function renderViolationItem(v) {
            const count = getStudentViolationCount(v.studentName, v.teacherId);
            const isHighRisk = count >= 3;
            
            return `
                <div class="p-6 hover:bg-gray-50 transition-all duration-200 ${isHighRisk && v.status === 'active' ? 'bg-red-50 border-r-4 border-red-500' : ''}">
                    <div class="flex justify-between items-start gap-6">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3 flex-wrap">
                                <h3 class="text-xl font-bold text-gray-900">${v.studentName}</h3>
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">${v.grade}</span>
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">الشعبة ${v.section}</span>
                                <span class="px-3 py-1 rounded-full text-xs font-bold border-2 ${getDegreeColor(v.violationType)}">
                                    ${getDegreeLabel(v.violationType)}
                                </span>
                                ${isHighRisk && v.status === 'active' ? `
                                    <span class="flex items-center gap-1 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md animate-pulse">
                                        ⚠️ تحت المراقبة (${count} مخالفات من ${v.teacherName})
                                    </span>
                                ` : ''}
                                ${v.status === 'resolved' ? `
                                    <span class="flex items-center gap-1 bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                        ✅ تم الحل
                                    </span>
                                ` : ''}
                            </div>
                            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
                                <p class="text-gray-800 mb-2 font-semibold text-lg">${v.violationDetails}</p>
                                ${v.documentation ? `
                                    <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                        <p class="text-sm text-blue-900">
                                            <span class="font-bold">📝 الإجراء المتبع:</span><br>${v.documentation}
                                        </p>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                                <span>👤 <strong>المعلم:</strong> ${v.teacherName}</span>
                                <span>📅 <strong>التاريخ:</strong> ${v.date}</span>
                                <span>🕐 <strong>الوقت:</strong> ${v.time}</span>
                            </div>
                            ${v.status === 'resolved' && v.resolutionReason ? `
                                <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-start gap-2 mb-2">
                                        <span class="text-2xl">🏆</span>
                                        <div class="flex-1">
                                            <p class="text-sm font-bold text-green-900 mb-1">سبب حل المخالفة (السلوك الإيجابي):</p>
                                            <p class="text-sm text-green-800 mb-2">${v.resolutionReason}</p>
                                            <div class="flex gap-4 text-xs text-green-700">
                                                <span>تم الحل بواسطة: ${v.resolvedBy}</span>
                                                <span>في: ${new Date(v.resolvedAt).toLocaleString('ar-SA')}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick='openDetailsModal(${JSON.stringify(v).replace(/'/g, "\\'")})'
                                class="flex items-center gap-2 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors whitespace-nowrap">
                                👁️ التفاصيل
                            </button>
                            ${v.status === 'active' && canResolveViolation(v) ? `
                                <button onclick="resolveViolation(${v.id})" 
                                    class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md whitespace-nowrap">
                                    🏆 حل المخالفة
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

function renderStudentsUnderWatch() {
            if (!['assistant', 'counselor', 'principal'].includes(state.currentUser.role)) return '';
            
            const students = getStudentsByViolationCount().filter(s => s.count >= 3);
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-red-700">
                        ⚠️ الطلاب تحت المراقبة (3 مخالفات فأكثر)
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${students.length ? students.map((s, i) => {
                            const hasAction = state.studentActions.find(a => a.studentName === s.name && a.actionBy === state.currentUser.role);
                            return `
                                <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="font-bold text-gray-900">${s.name}</h3>
                                        <span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                            ${s.count} مخالفات
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600 mb-2">${s.grade} - الشعبة ${s.section}</div>
                                    <div class="text-xs text-gray-500 mb-3">آخر مخالفة: ${s.violations[s.violations.length - 1].date}</div>
                                    ${hasAction ? `
                                        <div class="bg-blue-100 border border-blue-300 rounded p-2 mb-3 text-xs">
                                            <div class="font-bold text-blue-900 mb-1">✅ تم اتخاذ إجراء</div>
                                            <div class="text-blue-800">${new Date(hasAction.actionDate).toLocaleDateString('ar-SA')}</div>
                                        </div>
                                    ` : ''}
                                    <div class="flex gap-2 mt-3">
                                        <button onclick='openActionModal(${JSON.stringify(s).replace(/'/g, "\\'")})'
                                            class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors">
                                            ${hasAction ? '📝 تعديل الإجراء' : '📋 اتخاذ إجراء'}
                                        </button>
                                        <button onclick='printStudentReport(${JSON.stringify(s).replace(/'/g, "\\'")})'
                                            class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm font-medium transition-colors">
                                            🖨️ طباعة
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div class="col-span-full text-center py-8 text-gray-500">
                                <div class="text-5xl mb-2">✅</div>
                                <p>لا يوجد طلاب تحت المراقبة حالياً</p>
                            </div>
                        `}
                    </div>
                </div>
                
                ${state.currentUser.role === 'assistant' ? renderAbsenceBlock() : ''}
            `;
        }

        function renderAbsenceBlock() {
            if (state.currentUser.role !== 'assistant') return '';
            
            const today = new Date().toISOString().split('T')[0];
            const todayAbsence = absenceRecords.filter(a => a.date === today && a.period === '1');
            
            const totalAbsentToday = todayAbsence.reduce((sum, a) => sum + a.absentCount, 0);
            const classesWithAbsence = todayAbsence.length;
            const totalStudents = todayAbsence.reduce((sum, a) => sum + a.totalStudents, 0);
            const attendanceRate = totalStudents > 0 ? ((totalStudents - totalAbsentToday) / totalStudents * 100).toFixed(1) : 0;

            let filtered = todayAbsence;
            if (state.filters.filterGrade) filtered = filtered.filter(a => a.grade === state.filters.filterGrade);
            if (state.filters.filterSection) filtered = filtered.filter(a => a.section === state.filters.filterSection);

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-hidden mt-6">
                    <div class="bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-6">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-white bg-opacity-20 backdrop-blur-sm p-3 rounded-lg">
                                    <span class="text-3xl">📋</span>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold">قوائم الغياب اليومية</h2>
                                    <p class="text-emerald-100 text-sm mt-1">الحصة الأولى - ${new Date().toLocaleDateString('ar-SA')}</p>
                                </div>
                            </div>
                            <button onclick="printDailyAbsenceReport()" 
                                class="flex items-center gap-2 px-6 py-3 bg-white text-emerald-700 rounded-lg hover:bg-emerald-50 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 font-bold">
                                <span class="text-xl">🖨️</span>
                                طباعة التقرير اليومي
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 p-6 bg-gray-50">
                        <div class="bg-white p-4 rounded-lg shadow border-r-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">إجمالي الغياب</p>
                                    <p class="text-2xl font-bold text-blue-600">${totalAbsentToday}</p>
                                </div>
                                <span class="text-3xl">👥</span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow border-r-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">نسبة الحضور</p>
                                    <p class="text-2xl font-bold text-green-600">${attendanceRate}%</p>
                                </div>
                                <span class="text-3xl">✅</span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow border-r-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">الفصول المسجلة</p>
                                    <p class="text-2xl font-bold text-purple-600">${classesWithAbsence}</p>
                                </div>
                                <span class="text-3xl">🏫</span>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow border-r-4 border-orange-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">إجمالي الطلاب</p>
                                    <p class="text-2xl font-bold text-orange-600">${totalStudents}</p>
                                </div>
                                <span class="text-3xl">📊</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-6">
                        ${filtered.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${filtered.map((record, index) => {
                                    const attendancePercentage = ((record.totalStudents - record.absentCount) / record.totalStudents * 100).toFixed(1);
                                    const statusColor = attendancePercentage >= 90 ? 'green' : attendancePercentage >= 80 ? 'yellow' : 'red';
                                    
                                    return `
                                        <div class="bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 rounded-xl p-5 hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02]">
                                            <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-gray-200">
                                                <div class="flex items-center gap-3">
                                                    <div class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold">
                                                        ${record.grade}
                                                    </div>
                                                    <div class="bg-purple-100 text-purple-700 px-3 py-2 rounded-lg font-bold">
                                                        ${record.section}
                                                    </div>
                                                </div>
                                                <button onclick='printClassAbsence(${JSON.stringify(record).replace(/'/g, "\\'")})'
                                                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition-colors" title="طباعة">
                                                    🖨️
                                                </button>
                                            </div>

                                            <div class="grid grid-cols-2 gap-3 mb-4">
                                                <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                                                    <p class="text-xs text-red-700 mb-1">الغياب</p>
                                                    <p class="text-2xl font-bold text-red-600">${record.absentCount}</p>
                                                </div>
                                                <div class="bg-${statusColor}-50 border border-${statusColor}-200 rounded-lg p-3 text-center">
                                                    <p class="text-xs text-${statusColor}-700 mb-1">نسبة الحضور</p>
                                                    <p class="text-2xl font-bold text-${statusColor}-600">${attendancePercentage}%</p>
                                                </div>
                                            </div>

                                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                                                <p class="text-sm font-bold text-yellow-900 mb-3 flex items-center gap-2">
                                                    <span>⚠️</span>
                                                    الطلاب الغائبون (${record.absentCount})
                                                </p>
                                                ${record.absentCount > 0 ? `
                                                    <div class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                                                        ${record.absentStudents.map((student, i) => `
                                                            <div class="flex items-center gap-2 bg-white border border-yellow-300 rounded-lg px-3 py-2">
                                                                <span class="flex-shrink-0 w-6 h-6 bg-yellow-600 text-white rounded-full flex items-center justify-center text-xs font-bold">
                                                                    ${i + 1}
                                                                </span>
                                                                <span class="text-sm text-gray-800 font-medium">${student}</span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : `
                                                    <p class="text-center text-green-600 font-medium py-3">
                                                        ✅ لا يوجد غياب
                                                    </p>
                                                `}
                                            </div>

                                            <div class="mt-4 pt-3 border-t border-gray-200">
                                                <p class="text-xs text-gray-600">
                                                    <span class="font-bold">المعلم:</span> ${record.teacherName}
                                                </p>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    <span class="font-bold">التسجيل:</span> ${new Date(record.recordedAt).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}
                                                </p>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-16">
                                <div class="text-6xl mb-4">✅</div>
                                <p class="text-xl text-gray-600 font-bold mb-2">لا يوجد غياب مسجل للحصة الأولى اليوم</p>
                                <p class="text-sm text-gray-500">جميع الفصول تنتظر تسجيل الغياب</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

/* ========== النوافذ المنبثقة ========== */
        function renderAddModal() {
            const { studentName, grade, section, violationType, violationDetails, documentation, date, time } = state.newViolation;
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeAddForm()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">➕ إضافة مخالفة جديدة</h2>
                            <p class="text-blue-100 text-sm mt-1">يرجى ملء البيانات المطلوبة</p>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">اسم الطالب <span class="text-red-500">*</span></label>
                                <input type="text" value="${studentName}" 
                                    onchange="state.newViolation.studentName=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                    placeholder="أدخل اسم الطالب...">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">الصف <span class="text-red-500">*</span></label>
                                    <select onchange="state.newViolation.grade=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">اختر الصف</option>
                                        ${config.grades.map(g => `<option value="${g}" ${grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">الشعبة <span class="text-red-500">*</span></label>
                                    <select onchange="state.newViolation.section=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">اختر الشعبة</option>
                                        ${config.sections.map(s => `<option value="${s}" ${section === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">درجة المخالفة <span class="text-red-500">*</span></label>
                                <select onchange="state.newViolation.violationType=this.value;state.newViolation.violationDetails='';render()" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="first" ${violationType === 'first' ? 'selected' : ''}>مخالفات الدرجة الأولى (درجة واحدة)</option>
                                    <option value="second" ${violationType === 'second' ? 'selected' : ''}>مخالفات الدرجة الثانية (درجتين)</option>
                                    <option value="third" ${violationType === 'third' ? 'selected' : ''}>مخالفات الدرجة الثالثة (ثلاث درجات)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">نوع المخالفة <span class="text-red-500">*</span></label>
                                <select onchange="state.newViolation.violationDetails=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">اختر المخالفة</option>
                                    ${config.violationTypes[violationType].items.map(item => `
                                        <option value="${item}" ${violationDetails === item ? 'selected' : ''}>${item}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">الإجراء المتبع <span class="text-red-500">*</span></label>
                                <textarea onchange="state.newViolation.documentation=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[100px]" 
                                    placeholder="اكتب الإجراء المتخذ...">${documentation}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">التاريخ</label>
                                    <input type="date" value="${date}" 
                                        onchange="state.newViolation.date=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">الوقت</label>
                                    <input type="time" value="${time}" 
                                        onchange="state.newViolation.time=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeAddForm()" 
                                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                                إلغاء
                            </button>
                            <button onclick="if(addViolation())render()" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                                ✓ حفظ المخالفة
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetailsModal() {
            const v = state.modals.selectedViolation;
            if (!v) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeDetailsModal()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">👁️ تفاصيل المخالفة</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <h3 class="font-bold text-xl text-gray-900 mb-2">${v.studentName}</h3>
                                <div class="flex gap-2 flex-wrap">
                                    <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm font-medium">${v.grade}</span>
                                    <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm font-medium">الشعبة ${v.section}</span>
                                    <span class="px-3 py-1 ${getDegreeColor(v.violationType)} rounded-full text-sm font-bold">${getDegreeLabel(v.violationType)}</span>
                                </div>
                            </div>
                            
                            <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-1">نوع المخالفة:</p>
                                <p class="text-lg font-bold text-gray-900">${v.violationDetails}</p>
                            </div>
                            
                            ${v.documentation ? `
                                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                                    <p class="text-sm font-bold text-yellow-900 mb-2">📝 الإجراء المتبع:</p>
                                    <p class="text-gray-800">${v.documentation}</p>
                                </div>
                            ` : ''}
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">👨‍🏫 المعلم</p>
                                    <p class="font-bold text-gray-900">${v.teacherName}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">📅 التاريخ</p>
                                    <p class="font-bold text-gray-900">${v.date}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">🕐 الوقت</p>
                                    <p class="font-bold text-gray-900">${v.time}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">📊 الحالة</p>
                                    <p class="font-bold ${v.status === 'active' ? 'text-orange-600' : 'text-green-600'}">
                                        ${v.status === 'active' ? 'نشط' : 'محلول'}
                                    </p>
                                </div>
                            </div>
                            
                            ${v.status === 'resolved' && v.resolutionReason ? `
                                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                                    <p class="text-sm font-bold text-green-900 mb-2">🏆 سبب حل المخالفة:</p>
                                    <p class="text-gray-800 mb-3">${v.resolutionReason}</p>
                                    <div class="flex gap-4 text-xs text-green-700">
                                        <span>تم الحل بواسطة: ${v.resolvedBy}</span>
                                        <span>في: ${new Date(v.resolvedAt).toLocaleString('ar-SA')}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeDetailsModal()" 
                                class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium">
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderActionModal() {
            const student = state.modals.selectedStudent;
            if (!student) return '';
            
            const existingAction = state.studentActions.find(
                a => a.studentName === student.name && a.actionBy === state.currentUser.role
            );
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeActionModal()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">📋 ${existingAction ? 'تعديل' : 'اتخاذ'} إجراء تجاه الطالب</h2>
                            <p class="text-orange-100 text-sm mt-1">${student.name} - ${student.grade} الشعبة ${student.section}</p>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                                <h3 class="font-bold text-red-900 mb-3">⚠️ ملخص المخالفات (${student.count} مخالفة)</h3>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${student.violations.map((v, i) => `
                                        <div class="bg-white border border-red-300 rounded-lg p-3">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm font-bold text-gray-900">${i + 1}. ${v.violationDetails}</span>
                                                <span class="px-2 py-1 ${getDegreeColor(v.violationType)} rounded-full text-xs font-bold">
                                                    ${getDegreeLabel(v.violationType)}
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-600">📅 ${v.date} | 🕐 ${v.time}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">الإجراء المتخذ <span class="text-red-500">*</span></label>
                                <textarea id="actionDetailsInput" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 min-h-[150px]" 
                                    placeholder="اكتب الإجراء المتخذ تجاه الطالب (مثال: تم استدعاء ولي الأمر، إحالة للمرشد الطلابي، الخ...)">${existingAction ? existingAction.actionDetails : ''}</textarea>
                            </div>
                            
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <h4 class="font-bold text-blue-900 mb-2">💡 اقتراحات للإجراءات:</h4>
                                <ul class="text-sm text-blue-800 space-y-1">
                                    <li>• استدعاء ولي الأمر للمناقشة</li>
                                    <li>• إحالة الطالب للمرشد الطلابي</li>
                                    <li>• وضع خطة متابعة سلوكية</li>
                                    <li>• عقد جلسة إرشادية فردية</li>
                                    <li>• التواصل مع المعلمين لمتابعة السلوك</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeActionModal()" 
                                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                                إلغاء
                            </button>
                            <button onclick="saveStudentAction()" 
                                class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium">
                                ✓ حفظ الإجراء
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

/* ========== التهيئة ========== */
        render();
    </script>
</body>
</html>


                
