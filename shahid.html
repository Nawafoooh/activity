<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ© - Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        /* ---------- Teachers ---------- */
        const teachersList = [
            'Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ù…Ø·Ø± Ø¨Ù† Ù…ØµÙ„Ø­ Ø§Ù„Ø¹Ù…Ø±ÙŠ','Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ù…Ø§Ø±ÙŠ Ø±Ø§Ø¶ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ','Ù…ÙˆÙÙ‚ Ù…Ø±Ø²ÙˆÙ‚ Ø³ÙˆÙŠØ±Ø­ Ø§Ù„Ø³Ø­ÙŠÙ…ÙŠ','ÙÙˆØ§Ø² Ø²Ø§ÙŠØ¯ Ù„Ø§ÙÙŠ Ø§Ù„Ù…Ù‡ÙŠÙ…Ø²ÙŠ Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ','ÙÙŠØµÙ„ Ø¹Ø·Ø§Ù„Ù„Ù‡ Ø­ÙˆÙŠÙ…Ø¯ Ø§Ù„ØµØ§Ø¹Ø¯ÙŠ','Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹ÙŠØ§Ø¯ Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ','Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø­Ù…ÙˆØ¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ø³Ø§ÙŠØ± ÙÙŠØµÙ„ Ø³Ø¹Ø¯ Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¶ÙŠÙ„Ù‡ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ','Ù†Ø§ÙØ¹ Ø´Ø¹ÙˆÙŠ Ù†Ø§ÙØ¹ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ','Ø§Ø³Ø§Ù…Ù‡ Ù…Ù†ÙˆØ± Ù…Ø´Ø¹Ù„ Ø§Ù„Ø¹ÙˆÙÙŠ','Ù…Ø­Ù…Ø¯ Ø¹ÙŠØ§Ø¯ Ø¹Ù„ÙŠØ«Ù‡ Ø§Ù„Ø¹ÙˆÙÙŠ','Ø£Ø­Ù…Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… ÙØ®Ø±ÙŠ Ø§Ù„ØªØ±ÙƒÙŠ','Ø£Ø­Ù…Ø¯ Ø­Ø§Ù…Ø¯ Ù‡Ù„Ø§Ù„ Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ù†Ù…ÙŠØ§Ù† Ø¹Ù„ÙŠ Ù†Ù…ÙŠØ§Ù† Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ ØµÙ„Ø§Ø­ ØµØ§Ù„Ø­ Ø§Ù„Ø±Ø­ÙŠÙ„Ù‰','Ù…Ø´Ø¹Ù„ Ø¨Ù† Ù‡Ù„ÙŠÙ„ Ø¨Ù† ØºØ§Ù„Ø¨ Ø§Ù„Ø¹Ù…Ø±ÙŠ Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ø¹Ù„ÙŠ Ù…ØªØ¹Ø¨ Ù†Ø§ØµØ± Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ø³ÙŠÙ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù†Ø¹Ù… Ø­Ù…Ø¯Ø§Ù† Ø§Ù„Ø¹Ø§Ø±Ø¶ÙŠ','Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø°Ø¹Ø§Ø± Ø¨Ù† ØµØ§Ù„Ø­ Ø§Ù„Ø¹ÙˆÙÙŠ','ÙØ¤Ø§Ø¯ Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø­Ù…Ø§Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ','Ø­Ù…Ø²Ø© ØµØ¯Ù‚Ø© Ø­Ù…Ø²Ø© Ø§Ø³Ù„Ø§Ù…','Ø³Ù„Ù…Ø§Ù† ØµØ§Ù„Ø­ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø­Ø§Ø±Ø«ÙŠ','Ø¹Ø¨ÙŠØ¯ Ø¨Ù† Ø¯Ø®ÙŠÙ„ Ø¨Ù† Ø¯ÙˆÙŠÙ‡ÙŠØ³ Ø§Ù„Ø¹ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ù…ÙÙ„Ø­ Ù†ÙˆÙŠØ¹Ù… Ø§Ù„Ø±ÙˆÙŠØ«ÙŠ','ÙÙŠØµÙ„ Ø¹ÙˆØ§Ø¯ Ù…Ø­Ù…Ø¯ Ø£Ø¨Ùˆ Ø³Ù„Ù…ÙŠ','Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ø¹ÙŠØ¯ Ø§Ù„ Ø¨Ø­Ø±Ø§Ù† Ø§Ù„Ù‚Ø±Ù†ÙŠ','ÙƒØ§ØªØ¨ Ù…ÙÙ„Ø­ Ø³Ù„ÙŠÙ…Ø§Ù† Ø§Ù„Ø±Ø´ÙŠØ¯Ù‰','Ø­Ø¨ÙŠØ¨ Ø¹Ù„ÙŠ Ù†Ø¹ÙŠØ³ Ø§Ù„Ø¹Ù…Ø±ÙŠ Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ø§ÙŠØ¶ Ø¹ÙˆØ¶ Ø§Ù„Ø¬Ø§Ø¨Ø±ÙŠ','Ø³Ù„Ø·Ø§Ù† Ø¹ÙˆÙŠØ¶ Ù…Ø¹ÙŠØ¶ Ø§Ù„Ø³Ø­ÙŠÙ…ÙŠ','Ø¹Ø¨Ø¯Ø§Ù„Ù‡Ø§Ø¯ÙŠ Ù…Ø¹ÙŠØ¶ Ù…Ø¹Ù„Ø§ Ø§Ù„Ø´Ø§Ù…Ø§Ù†ÙŠ','Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† ØºÙ„Ø§Ø¨ Ø§Ù„Ù…Ø®Ù„ÙÙŠ','Ø³Ø¹Ø¯ Ø·Ø§Ù„Ø¹ Ø­Ù…ÙˆØ¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ù†Ø§Ù‡Ø± Ù…Ø´Ø¹Ù„ Ø¹ÙˆÙŠØ¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ','Ù…ÙˆØ³Ù‰ ØºØ§Ø²ÙŠ Ø³ÙØ± Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ù…ÙˆØ³Ù‰ Ù…Ø³Ø¹ÙˆØ¯ Ø¹Ø§ÙŠØ¶ Ø§Ù„Ø­ÙŠØ³ÙˆÙ†ÙŠ','Ù†ÙˆØ§Ù Ù…Ù†ØµÙˆØ± Ø¹ÙˆØ§Ø¯ Ø§Ù„ØµØ¨Ø­ÙŠ','Ø¨Ø¯Ø± Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø´Ø§Ø¦Ø¯ Ø§Ù„Ø³Ø­ÙŠÙ…ÙŠ','ÙÙ‡Ø¯ Ø¹ÙˆÙŠØ¶ Ø¹ÙˆØ¶ Ø§Ù„Ø´Ø§Ù…Ø§Ù†ÙŠ Ø§Ù„Ø­Ø±Ø¨ÙŠ','Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¬ÙŠØ¯ Ø¹Ø§ÙŠØ¯ Ø®Ø¶Ø±Ø§Ù† Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ','Ø£Ø­Ù…Ø¯ Ù…Ø·Ø± Ø³Ù„ÙŠÙ…Ø§Ù† Ø§Ù„Ø±Ø´ÙŠØ¯ÙŠ'
        ];

        /* ---------- Config ---------- */
        const config = {
            passwords: { principal:'A2030', assistant:'B2030', counselor:'C2030' },
            schoolInfo: { name:'Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ', principal:'Ø®Ø§Ù„Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ', assistant:'Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ø§Ø¨Ø±ÙŠ', counselor:'Ù…Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ', type:'Ø¨Ù†ÙŠÙ†' },
            grades: ['Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·','Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·','Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·'],
            sections: ['1','2','3','4','5','6'],
            violationTypes: {
                first:  { label:'Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø¯Ø±Ø¬Ø© ÙˆØ§Ø­Ø¯Ø©)', items:['Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµØ©','Ø¥Ø¹Ø§Ù‚Ø© Ø³ÙŠØ± Ø§Ù„Ø­ØµØµ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© (ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª)','Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø³ - Ø§Ù„Ù…Ù‚Ø§Ø·Ø¹Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©','Ø§Ù„Ù†ÙˆÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ','ØªÙƒØ±Ø§Ø± Ø®Ø±ÙˆØ¬ ÙˆØ¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù‚Ø¨Ù„ ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù','Ø§Ù„ØªØ¬Ù‡Ø² Ø£Ù…Ø§Ù… Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'] },
                second: { label:'Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø¯Ø±Ø¬ØªÙŠÙ†)',     items:['Ø¹Ø¯Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø­ØµØ© Ø£Ùˆ Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù†Ù‡Ø§','Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ÙØµÙ„ Ø¯ÙˆÙ† Ø§Ø³ØªØ¦Ø°Ø§Ù†','Ø¯Ø®ÙˆÙ„ ÙØµÙ„ Ø¢Ø®Ø± Ø¯ÙˆÙ† Ø§Ø³ØªØ¦Ø°Ø§Ù†','Ø¥Ø«Ø§Ø±Ø© Ø§Ù„ÙÙˆØ¶Ù‰ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ'] },
                third:  { label:'Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø«Ù„Ø§Ø« Ø¯Ø±Ø¬Ø§Øª)', items:['Ø¹Ø¯Ù… Ø§Ù„ØªÙ‚ÙŠØ¯ Ø¨Ø§Ù„Ø²ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ','Ø¥Ù„Ø­Ø§Ù‚ Ø§Ù„Ø¶Ø±Ø± Ø§Ù„Ù…ØªØ¹Ù…Ø¯ Ø¨Ù…Ù…ØªÙ„ÙƒØ§Øª Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª','Ø§Ù„Ø¹Ø¨Ø« Ø¨ØªØ¬Ù‡ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ø§Ù„Ù…Ø¹Ù…Ù„ - Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø­Ø§Ø³Ø¨)','Ø§Ù…ØªÙ‡Ø§Ù† Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©'] }
            }
        };

        /* ---------- Application State ---------- */
        let state = {
            currentUser: { role:'teacher', name:teachersList[0], id:1 },
            authenticated: { principal:false, assistant:false, counselor:false },
            violations: [
                {id:1, studentName:'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', grade:'Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·', section:'1', violationType:'first',  violationDetails:'Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­ØµØ©',     teacherName:teachersList[0], teacherId:1, date:'2025-10-13', time:'08:30', documentation:'ØªØ£Ø®Ø± 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù† Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰', status:'active', createdAt:'2025-10-13T08:30:00'},
                {id:2, studentName:'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', grade:'Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·', section:'1', violationType:'first',  violationDetails:'Ø§Ù„Ù†ÙˆÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ',            teacherName:teachersList[1], teacherId:2, date:'2025-10-14', time:'10:15', documentation:'Ù†Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©',        status:'active', createdAt:'2025-10-14T10:15:00'},
                {id:3, studentName:'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', grade:'Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·', section:'1', violationType:'second', violationDetails:'Ø¹Ø¯Ù… Ø­Ø¶ÙˆØ± Ø§Ù„Ø­ØµØ© Ø£Ùˆ Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù†Ù‡Ø§', teacherName:teachersList[2], teacherId:3, date:'2025-10-14', time:'11:30', documentation:'ØºØ§Ø¨ Ø¹Ù† Ø­ØµØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±', status:'active', createdAt:'2025-10-14T11:30:00'},
                {id:4, studentName:'Ø®Ø§Ù„Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø³Ø¹ÙŠØ¯', grade:'Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·', section:'3', violationType:'first', violationDetails:'Ø¥Ø¹Ø§Ù‚Ø© Ø³ÙŠØ± Ø§Ù„Ø­ØµØµ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©', teacherName:teachersList[3], teacherId:1, date:'2025-10-14', time:'09:00', documentation:'ØªØ­Ø¯Ø« Ù…Ø¹ Ø²Ù…ÙŠÙ„Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø­', status:'active', createdAt:'2025-10-14T09:00:00'},
                {id:5, studentName:'Ù…Ø­Ù…Ø¯ Ø³Ø¹Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ', grade:'Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·', section:'2', violationType:'third', violationDetails:'Ø¹Ø¯Ù… Ø§Ù„ØªÙ‚ÙŠØ¯ Ø¨Ø§Ù„Ø²ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ', teacherName:teachersList[4], teacherId:4, date:'2025-10-12', time:'07:45', documentation:'Ø­Ø¶Ø± Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø²ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ', status:'resolved', resolvedBy:'Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬Ø§Ø¨Ø±ÙŠ', resolutionReason:'Ø§Ù„ØªØ²Ù… Ø¨Ø§Ù„Ø²ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ù„Ù…Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ù…Ù„', resolvedAt:'2025-10-13T12:00:00', createdAt:'2025-10-12T07:45:00'}
            ],
            studentActions: [],
            filters: { selectedTab:'all', searchStudent:'', filterGrade:'', filterSection:'', dateFrom:'', dateTo:'' },
            modals: { showAddForm:false, showDetailsModal:false, selectedViolation:null, showActionModal:false, selectedStudent:null },
            newViolation: { studentName:'', grade:'', section:'', violationType:'first', violationDetails:'', documentation:'', date:new Date().toISOString().split('T')[0], time:new Date().toTimeString().slice(0,5) }
        };

        /* ========== âœ… Absence Data with LocalStorage ========== */
        let absenceRecords = [];

        // âœ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ù…Ù† LocalStorage
        function loadAbsenceFromStorage() {
            try {
                const saved = localStorage.getItem('absenceRecords');
                if (saved) {
                    absenceRecords = JSON.parse(saved);
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„', absenceRecords.length, 'Ø³Ø¬Ù„ ØºÙŠØ§Ø¨ Ù…Ù† LocalStorage');
                    return true;
                }
            } catch (e) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨:', e);
            }
            return false;
        }

        // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        loadAbsenceFromStorage();

        // âœ… ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ Ù„Ù„ÙˆÙƒÙŠÙ„ ÙÙ‚Ø·
        setInterval(() => {
            if (state.currentUser.role === 'assistant') {
                const updated = loadAbsenceFromStorage();
                if (updated) {
                    render();
                }
            }
        }, 3000);

        window.addEventListener('message', e => {
            if (e.data && e.data.type === 'absenceData') {
                absenceRecords = e.data.payload || [];
                if (state.currentUser.role === 'assistant') render();
            }
        });

        /* ---------- Utility ---------- */
        function getStudentViolationCount(studentName, teacherId = null, status = 'active') {
            return state.violations.filter(v => v.studentName === studentName && (teacherId === null || v.teacherId === teacherId) && (status === 'all' || v.status === status)).length;
        }
        function getStudentsByViolationCount() {
            const map = {};
            state.violations.filter(v => v.status === 'active').forEach(v => {
                const key = `${v.studentName}_${v.teacherId}`;
                if (!map[key]) map[key] = { name:v.studentName, grade:v.grade, section:v.section, teacherId:v.teacherId, teacherName:v.teacherName, count:0, violations:[] };
                map[key].count++; map[key].violations.push(v);
            });
            return Object.values(map).filter(s => s.count >= 3).sort((a,b) => b.count - a.count);
        }
        function getDegreeLabel(type) { const m = {first:'Ø¯Ø±Ø¬Ø© Ø£ÙˆÙ„Ù‰', second:'Ø¯Ø±Ø¬Ø© Ø«Ø§Ù†ÙŠØ©', third:'Ø¯Ø±Ø¬Ø© Ø«Ø§Ù„Ø«Ø©'}; return m[type] || type; }
        function getDegreeColor(type) { const m = {first:'bg-green-100 text-green-800 border-green-200', second:'bg-yellow-100 text-yellow-800 border-yellow-200', third:'bg-red-100 text-red-800 border-red-200'}; return m[type] || 'bg-gray-100 text-gray-800'; }
        function getRoleLabel(role) { const m = {teacher:'Ø§Ù„Ù…Ø¹Ù„Ù…', assistant:'Ø§Ù„ÙˆÙƒÙŠÙ„', counselor:'Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ', principal:'Ø§Ù„Ù…Ø¯ÙŠØ±'}; return m[role]; }

        function getFilteredViolations() {
            let f = [...state.violations];
            if (state.currentUser.role === 'teacher') f = f.filter(v => v.teacherId === state.currentUser.id);
            else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                const sw = getStudentsByViolationCount(); const stp = sw.map(s => `${s.name}_${s.teacherId}`);
                f = f.filter(v => stp.includes(`${v.studentName}_${v.teacherId}`));
            }
            if (state.filters.selectedTab === 'active')   f = f.filter(v => v.status === 'active');
            if (state.filters.selectedTab === 'resolved') f = f.filter(v => v.status === 'resolved');
            if (state.filters.searchStudent.trim())       f = f.filter(v => v.studentName.includes(state.filters.searchStudent.trim()));
            if (state.filters.filterGrade)                f = f.filter(v => v.grade === state.filters.filterGrade);
            if (state.filters.filterSection)              f = f.filter(v => v.section === state.filters.filterSection);
            if (state.filters.dateFrom)                   f = f.filter(v => v.date >= state.filters.dateFrom);
            if (state.filters.dateTo)                     f = f.filter(v => v.date <= state.filters.dateTo);
            return f;
        }
        function getStats() {
            let v = [...state.violations];
            if (state.currentUser.role === 'teacher') v = v.filter(i => i.teacherId === state.currentUser.id);
            else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') {
                const sw = getStudentsByViolationCount(); const stp = sw.map(s => `${s.name}_${s.teacherId}`);
                v = v.filter(i => stp.includes(`${i.studentName}_${i.teacherId}`));
            }
            const active = v.filter(i => i.status === 'active').length;
            const resolved = v.filter(i => i.status === 'resolved').length;
            const today = v.filter(i => i.date === new Date().toISOString().split('T')[0]).length;
            let suw = 0;
            if (state.currentUser.role === 'teacher') suw = getMyStudentsUnderWatch().length;
            else if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') suw = getStudentsByViolationCount().length;
            else suw = getStudentsByViolationCount().length;
            return { active, resolved, studentsUnderWatch: suw, today };
        }
        function getMyStudentsUnderWatch() {
            const m = {};
            state.violations.filter(i => i.status === 'active' && i.teacherId === state.currentUser.id).forEach(v => {
                if (!m[v.studentName]) m[v.studentName] = { name:v.studentName, grade:v.grade, section:v.section, count:0, violations:[] };
                m[v.studentName].count++; m[v.studentName].violations.push(v);
            });
            return Object.values(m).filter(s => s.count >= 3).sort((a,b) => b.count - a.count);
        }
        function canResolveViolation(violation) {
            if (state.currentUser.role === 'principal') return true;
            if (state.currentUser.role === 'assistant' || state.currentUser.role === 'counselor') return getStudentViolationCount(violation.studentName, violation.teacherId) >= 3;
            if (state.currentUser.role === 'teacher') return violation.teacherId === state.currentUser.id;
            return false;
        }

        /* ---------- Actions ---------- */
        function setCurrentUser(role, name, id) {
            if (role === 'principal' || role === 'assistant' || role === 'counselor') {
                if (!state.authenticated[role]) {
                    const pw = prompt(`ğŸ”’ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„ØµÙØ­Ø© ${getRoleLabel(role)}:`);
                    if (pw !== config.passwords[role]) { alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!'); return; }
                    state.authenticated[role] = true; alert(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ØµÙØ­Ø© ${getRoleLabel(role)}`);
                }
            }
            if (role === 'teacher' && !name) name = teachersList[0];
            state.currentUser = { role, name, id }; 
            
            // âœ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (role === 'assistant') {
                loadAbsenceFromStorage();
            }
            
            render();
        }
        function setFilter(k, v) { state.filters[k] = v; render(); }
        function clearFilters() {
            state.filters = { selectedTab: state.filters.selectedTab, searchStudent:'', filterGrade:'', filterSection:'', dateFrom:'', dateTo:'' };
            render();
        }
        function openAddForm() { state.modals.showAddForm = true; render(); }
        function closeAddForm() {
            state.modals.showAddForm = false;
            state.newViolation = { studentName:'', grade:'', section:'', violationType:'first', violationDetails:'', documentation:'', date:new Date().toISOString().split('T')[0], time:new Date().toTimeString().slice(0,5) };
            render();
        }
        function addViolation() {
            const {studentName, grade, section, violationType, violationDetails, documentation, date, time} = state.newViolation;
            if (!studentName.trim() || !grade || !section || !violationDetails || !documentation.trim()) { alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'); return false; }
            state.violations.unshift({ id:Math.max(0, ...state.violations.map(i=>i.id)) + 1, studentName:studentName.trim(), grade, section, violationType, violationDetails, documentation:documentation.trim(), date, time, teacherName:state.currentUser.name, teacherId:state.currentUser.id, status:'active', createdAt:new Date().toISOString() });
            const c = getStudentViolationCount(studentName.trim(), state.currentUser.id);
            alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­!\nğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}\nğŸ“š Ø§Ù„ØµÙ: ${grade} - Ø§Ù„Ø´Ø¹Ø¨Ø© ${section}\nâš ï¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©: ${violationDetails}\nğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹: ${documentation}${c >= 3 ? `\n\nğŸš¨ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø¯ÙŠÙ‡ ${c} Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ù†Ùƒ!\nØ³ÙŠØªÙ… Ø¥Ø­Ø§Ù„ØªÙ‡ Ù„Ù„ÙˆÙƒÙŠÙ„/Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.` : ''}`);
            closeAddForm(); return true;
        }
        function resolveViolation(violationId) {
            const reason = prompt('Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø§Ù„Ø°ÙŠ Ù‚Ø§Ù… Ø¨Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨):');
            if (reason && reason.trim()) {
                state.violations = state.violations.map(v => v.id === violationId ? {...v, status:'resolved', resolutionReason:reason.trim(), resolvedBy:state.currentUser.name, resolvedAt:new Date().toISOString()} : v);
                render();
            }
        }
        function openDetailsModal(v) { state.modals.selectedViolation = v; state.modals.showDetailsModal = true; render(); }
        function closeDetailsModal() { state.modals.showDetailsModal = false; state.modals.selectedViolation = null; render(); }
        function openActionModal(studentData) { state.modals.showActionModal = true; state.modals.selectedStudent = studentData; render(); }
        function closeActionModal() { state.modals.showActionModal = false; state.modals.selectedStudent = null; render(); }
        function saveStudentAction() {
            const details = document.getElementById('actionDetailsInput')?.value.trim();
            if (!details) { alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°'); return; }
            const student = state.modals.selectedStudent;
            state.studentActions.push({ id:Math.max(0, ...state.studentActions.map(a=>a.id||0)) + 1, studentName:student.name, actionBy:state.currentUser.role, actionByName:state.currentUser.name, actionDate:new Date().toISOString(), actionDetails:details, violationsIncluded:student.violations.map(v=>v.id) });
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!'); closeActionModal();
        }

        function printStudentReport(studentData) {
            const student = studentData; const action = state.studentActions.find(a => a.studentName === student.name && a.actionBy === state.currentUser.role);
            const pw = window.open('', '_blank');
            pw.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ± Ù…Ø®Ø§Ù„ÙØ§Øª - ${student.name}</title>
                <style>@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
                body{font-family:'Cairo',sans-serif;padding:40px;direction:rtl}
                .header{text-align:center;border-bottom:3px solid #2563eb;padding-bottom:20px;margin-bottom:30px}
                .header h1{color:#1e40af;margin:10px 0}.info-box{background:#f3f4f6;padding:20px;border-radius:8px;margin-bottom:20px}
                .info-row{display:flex;justify-content:space-between;margin-bottom:10px}
                .violation-item{border:2px solid #e5e7eb;padding:15px;margin-bottom:15px;border-radius:8px}
                .action-box{background:#dbeafe;border:2px solid #2563eb;padding:20px;border-radius:8px;margin-top:30px}
                .signature-area{margin-top:50px;display:flex;justify-content:space-between}
                .signature-box{text-align:center;width:200px}.signature-line{border-top:2px solid #000;margin-top:60px;padding-top:10px}
                @media print{body{padding:20px}.no-print{display:none}}
                </style></head><body>
                <div class="header"><h1>ğŸ“š ${config.schoolInfo.name}</h1><h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©</h2><p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}</p></div>
                <div class="info-box"><h3 style="color:#1e40af;margin-bottom:15px">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <div class="info-row"><strong>Ø§Ù„Ø§Ø³Ù…:</strong><span>${student.name}</span></div>
                <div class="info-row"><strong>Ø§Ù„ØµÙ:</strong><span>${student.grade}</span></div>
                <div class="info-row"><strong>Ø§Ù„Ø´Ø¹Ø¨Ø©:</strong><span>${student.section}</span></div>
                <div class="info-row"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:</strong><span style="color:#dc2626;font-weight:bold">${student.count} Ù…Ø®Ø§Ù„ÙØ§Øª</span></div></div>
                <h3 style="color:#1e40af;margin-top:30px;margin-bottom:15px">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:</h3>
                ${student.violations.map((v,i)=>`
                <div class="violation-item">
                    <div style="font-weight:bold;margin-bottom:10px">${i+1}. ${v.violationDetails}
                    <span style="background:${v.violationType==='first'?'#dcfce7':v.violationType==='second'?'#fef3c7':'#fee2e2'};padding:4px 12px;border-radius:20px;font-size:12px;margin-right:10px">${getDegreeLabel(v.violationType)}</span></div>
                    <div style="color:#6b7280;font-size:14px"><div>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date} | ğŸ• Ø§Ù„ÙˆÙ‚Øª: ${v.time}</div><div>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…: ${v.teacherName}</div>${v.documentation?`<div style="margin-top:8px">ğŸ“ ${v.documentation}</div>`:''}</div>
                </div>`).join('')}
                ${action?`
                <div class="action-box"><h3 style="color:#1e40af;margin-bottom:15px">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° Ù…Ù† Ù‚Ø¨Ù„ ${getRoleLabel(action.actionBy)}</h3>
                <div style="margin-bottom:10px"><strong>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong> ${action.actionByName}</div>
                <div style="margin-bottom:10px"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(action.actionDate).toLocaleString('ar-SA')}</div>
                <div style="margin-top:15px;padding:15px;background:white;border-radius:4px"><strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</strong><p style="margin-top:10px;line-height:1.8">${action.actionDetails}</p></div></div>`:''}
                <div class="signature-area">
                    <div class="signature-box"><div class="signature-line">${state.currentUser.role==='assistant'?'Ø§Ù„ÙˆÙƒÙŠÙ„':'Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ'}</div></div>
                    <div class="signature-box"><div class="signature-line">ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div></div>
                    <div class="signature-box"><div class="signature-line">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div></div>
                </div>
                <div class="no-print" style="text-align:center;margin-top:30px">
                    <button onclick="window.print()" style="background:#2563eb;color:white;padding:12px 30px;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-family:'Cairo',sans-serif">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                    <button onclick="window.close()" style="background:#6b7280;color:white;padding:12px 30px;border:none;border-radius:8px;font-size:16px;cursor:pointer;margin-right:10px;font-family:'Cairo',sans-serif">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
                </body></html>`);
            pw.document.close();
        }
        function exportToCSV() {
            const filtered = getFilteredViolations();
            const headers = ['#', 'Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„ØµÙ', 'Ø§Ù„Ø´Ø¹Ø¨Ø©', 'Ø§Ù„Ø¯Ø±Ø¬Ø©', 'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©', 'Ø§Ù„Ù…Ø¹Ù„Ù…', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙˆÙ‚Øª', 'Ø§Ù„Ø­Ø§Ù„Ø©'];
            const rows = filtered.map((v, i) => [i + 1, v.studentName, v.grade, v.section, getDegreeLabel(v.violationType), v.violationDetails, v.teacherName, v.date, v.time, v.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…Ø­Ù„ÙˆÙ„']);
            const csvContent = [headers, ...rows].map(r => r.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Ù…Ø®Ø§Ù„ÙØ§Øª_${new Date().toISOString().split('T')[0]}.csv`; link.click();
        }

        /* ---------- Render ---------- */
        function render() {
            const stats = getStats();
            const filtered = getFilteredViolations();
            document.getElementById('app').innerHTML = `
                ${renderHeader()}
                ${renderUserTabs()}
                ${renderMainContent(stats, filtered)}
                ${state.modals.showAddForm ? renderAddModal() : ''}
                ${state.modals.showDetailsModal ? renderDetailsModal() : ''}
                ${state.modals.showActionModal ? renderActionModal() : ''}
            `;
        }
        
        function renderHeader() {
            return `<div class="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 text-white shadow-2xl">
                <div class="max-w-7xl mx-auto px-6 py-8">
                    <div class="flex items-center justify-between mb-6">
                        <div><h1 class="text-4xl font-bold mb-2">ğŸ“š ${config.schoolInfo.name}</h1><p class="text-blue-100 text-lg">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ© - ${config.schoolInfo.type}</p></div>
                        <div class="text-left bg-blue-800 bg-opacity-50 rounded-lg p-4 backdrop-blur-sm">
                            <p class="text-sm text-blue-100 mb-1">ğŸ‘¤ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${config.schoolInfo.principal}</p>
                            <p class="text-sm text-blue-100 mb-1">ğŸ‘¤ Ø§Ù„ÙˆÙƒÙŠÙ„: ${config.schoolInfo.assistant}</p>
                            <p class="text-sm text-blue-100">ğŸ‘¤ Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ: ${config.schoolInfo.counselor}</p>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        function renderUserTabs() {
            const isActive = r => state.currentUser.role === r;
            const btn = (role, icon, label) => `<button onclick="setCurrentUser('${role}', '${config.schoolInfo[role]}', ${role==='teacher'?1:role==='assistant'?2:role==='counselor'?3:4})" class="flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${isActive(role)?'bg-blue-600 text-white shadow-lg scale-105':'bg-gray-100 text-gray-700 hover:bg-gray-200'}">${icon} ${label}</button>`;
            return `<div class="bg-white border-b shadow-sm sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-6 py-4">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex gap-2 flex-wrap items-center">
                            ${state.currentUser.role==='teacher'?`
                                <select onchange="setCurrentUser('teacher', this.value, 1)" class="px-4 py-3 border-2 border-blue-600 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium text-blue-900 bg-blue-50">
                                    ${teachersList.map(t=>`<option ${state.currentUser.name===t?'selected':''}>ğŸ‘¨â€ğŸ« ${t}</option>`).join('')}
                                </select>
                            `:btn('teacher','ğŸ‘¨â€ğŸ«','ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…')}
                            ${btn('assistant','ğŸ“‹','ØµÙØ­Ø© Ø§Ù„ÙˆÙƒÙŠÙ„')} ${btn('counselor','ğŸ“¢','Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ')} ${btn('principal','ğŸ›¡ï¸','ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±')}
                            <a href="https://nawafoooh.github.io/activity/absent.html" class="px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</a>
                        </div>
                        <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200"><p class="text-sm text-blue-900"><span class="font-bold">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</span> ${state.currentUser.name} - ${getRoleLabel(state.currentUser.role)}</p></div>
                    </div>
                </div>
            </div>`;
        }
        
        function renderMainContent(stats, filtered) {
            return `<div class="max-w-7xl mx-auto px-6 py-6">
                ${renderStats(stats)}
                ${renderViolationsSection(stats, filtered)}
                ${renderStudentsUnderWatch()}
                ${renderAbsenceBlock()}
            </div>`;
        }
        
        function renderStats({active, resolved, studentsUnderWatch, today}) {
            return `<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500"><div class="flex items-center justify-between mb-3"><span class="text-4xl">âš ï¸</span><div class="text-3xl font-bold text-blue-600">${active}</div></div><div class="text-gray-600 font-medium">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500"><div class="flex items-center justify-between mb-3"><span class="text-4xl">âœ…</span><div class="text-3xl font-bold text-green-600">${resolved}</div></div><div class="text-gray-600 font-medium">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-orange-500"><div class="flex items-center justify-between mb-3"><span class="text-4xl">ğŸ‘ï¸</span><div class="text-3xl font-bold text-orange-600">${studentsUnderWatch}</div></div><div class="text-gray-600 font-medium">Ø·Ù„Ø§Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500"><div class="flex items-center justify-between mb-3"><span class="text-4xl">ğŸ“…</span><div class="text-3xl font-bold text-purple-600">${today}</div></div><div class="text-gray-600 font-medium">Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div></div>
            </div>`;
        }
        
        function renderViolationsSection(stats, filtered) {
            const tabClass = tab => `px-5 py-2.5 rounded-lg font-medium transition-all ${state.filters.selectedTab===tab?'bg-blue-600 text-white shadow-md':'text-gray-600 hover:bg-gray-100'}`;
            const hasFilters = state.filters.searchStudent||state.filters.filterGrade||state.filters.filterSection||state.filters.dateFrom||state.filters.dateTo;
            return `<div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="border-b px-6 py-4">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex gap-3">
                            <button onclick="setFilter('selectedTab', 'all')" class="${tabClass('all')}">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (${state.violations.length})</button>
                            <button onclick="setFilter('selectedTab', 'active')" class="${tabClass('active')}">Ø§Ù„Ù†Ø´Ø·Ø© (${stats.active})</button>
                            <button onclick="setFilter('selectedTab', 'resolved')" class="${tabClass('resolved')}">Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø© (${stats.resolved})</button>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportToCSV()" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-md">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                            ${state.currentUser.role==='teacher'?`<button onclick="openAddForm()" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>`:''}
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 border-b">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label><input type="text" value="${state.filters.searchStudent}" onchange="setFilter('searchStudent', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..."></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“Š Ø§Ù„ØµÙ</label><select onchange="setFilter('filterGrade', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">Ø§Ù„ÙƒÙ„</option>${config.grades.map(g=>`<option value="${g}" ${state.filters.filterGrade===g?'selected':''}>${g}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø´Ø¹Ø¨Ø©</label><select onchange="setFilter('filterSection', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">Ø§Ù„ÙƒÙ„</option>${config.sections.map(s=>`<option value="${s}" ${state.filters.filterSection===s?'selected':''}>${s}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" value="${state.filters.dateFrom}" onchange="setFilter('dateFrom', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" value="${state.filters.dateTo}" onchange="setFilter('dateTo', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>
                    </div>
                    ${hasFilters?`<button onclick="clearFilters()" class="mt-4 text-sm text-blue-600 hover:text-blue-800 font-medium">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</button>`:''}
                </div>
                <div class="divide-y">${filtered.map(v=>renderViolationItem(v)).join('')}</div>
                <div class="p-4 bg-gray-50 border-t text-center text-sm text-gray-600">Ø¹Ø±Ø¶ ${filtered.length} Ù…Ù† Ø£ØµÙ„ ${state.violations.length} Ù…Ø®Ø§Ù„ÙØ©</div>
            </div>`;
        }
        
        function renderViolationItem(v) {
            const count = getStudentViolationCount(v.studentName, v.teacherId); const high = count >= 3;
            return `
                <div class="p-6 hover:bg-gray-50 transition-all duration-200 ${high && v.status==='active'?'bg-red-50 border-r-4 border-red-500':''}">
                    <div class="flex justify-between items-start gap-6">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3 flex-wrap">
                                <h3 class="text-xl font-bold text-gray-900">${v.studentName}</h3>
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">${v.grade}</span>
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">Ø§Ù„Ø´Ø¹Ø¨Ø© ${v.section}</span>
                                <span class="px-3 py-1 rounded-full text-xs font-bold border-2 ${getDegreeColor(v.violationType)}">${getDegreeLabel(v.violationType)}</span>
                                ${high && v.status==='active'?`<span class="flex items-center gap-1 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md animate-pulse">âš ï¸ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (${count} Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ù† ${v.teacherName})</span>`:''}
                                ${v.status==='resolved'?`<span class="flex items-center gap-1 bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">âœ… ØªÙ… Ø§Ù„Ø­Ù„</span>`:''}
                            </div>
                            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3"><p class="text-gray-800 mb-2 font-semibold text-lg">${v.violationDetails}</p>${v.documentation?`<div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg"><p class="text-sm text-blue-900"><span class="font-bold">ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹:</span><br>${v.documentation}</p></div>`:''}</div>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-600"><span>ğŸ‘¤ <strong>Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> ${v.teacherName}</span><span>ğŸ“… <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${v.date}</span><span>ğŸ• <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${v.time}</span></div>
                            ${v.status==='resolved'&&v.resolutionReason?`
                                <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-start gap-2 mb-2"><span class="text-2xl">ğŸ†</span><div class="flex-1">
                                        <p class="text-sm font-bold text-green-900 mb-1">Ø³Ø¨Ø¨ Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ):</p>
                                        <p class="text-sm text-green-800 mb-2">${v.resolutionReason}</p>
                                        <div class="flex gap-4 text-xs text-green-700"><span>ØªÙ… Ø§Ù„Ø­Ù„ Ø¨ÙˆØ§Ø³Ø·Ø©: ${v.resolvedBy}</span><span>ÙÙŠ: ${new Date(v.resolvedAt).toLocaleString('ar-SA')}</span></div>
                                    </div></div>
                                </div>
                            `:''}
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick='openDetailsModal(${JSON.stringify(v).replace(/'/g, "\\'")})'class="flex items-center gap-2 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors whitespace-nowrap">ğŸ‘ï¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                            ${v.status==='active'&&canResolveViolation(v)?`<button onclick="resolveViolation(${v.id})" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md whitespace-nowrap">ğŸ† Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</button>`:''}
                        </div>
                    </div>
                </div>`;
        }
        
        function renderStudentsUnderWatch() {
            if (!['assistant','counselor','principal'].includes(state.currentUser.role)) return '';
            const students = getStudentsByViolationCount().filter(s => s.count >= 3);
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-red-700">âš ï¸ Ø§Ù„Ø·Ù„Ø§Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (3 Ù…Ø®Ø§Ù„ÙØ§Øª ÙØ£ÙƒØ«Ø±)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${students.length?students.map((s,i)=>{
                            const hasAction = state.studentActions.find(a => a.studentName === s.name && a.actionBy === state.currentUser.role);
                            return `
                                <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                    <div class="flex items-center justify-between mb-3"><h3 class="font-bold text-gray-900">${s.name}</h3><span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold">${s.count} Ù…Ø®Ø§Ù„ÙØ§Øª</span></div>
                                    <div class="text-sm text-gray-600 mb-2">${s.grade} - Ø§Ù„Ø´Ø¹Ø¨Ø© ${s.section}</div>
                                    <div class="text-xs text-gray-500 mb-3">Ø¢Ø®Ø± Ù…Ø®Ø§Ù„ÙØ©: ${s.violations[s.violations.length-1].date}</div>
                                    ${hasAction?`<div class="bg-blue-100 border border-blue-300 rounded p-2 mb-3 text-xs"><div class="font-bold text-blue-900 mb-1">âœ… ØªÙ… Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡</div><div class="text-blue-800">${new Date(hasAction.actionDate).toLocaleDateString('ar-SA')}</div></div>`:''}
                                    <div class="flex gap-2 mt-3">
                                        <button onclick='openActionModal(${JSON.stringify(s).replace(/'/g, "\\'")})'class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors">${hasAction?'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡':'ğŸ“‹ Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡'}</button>
                                        <button onclick='printStudentReport(${JSON.stringify(s).replace(/'/g, "\\'")})'class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm font-medium transition-colors">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                                    </div>
                                </div>`;
                        }).join(''):`<div class="col-span-full text-center py-8 text-gray-500"><div class="text-5xl mb-2">âœ…</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>`}
                    </div>
                </div>`;
        }

        /* ========== âœ… Absence Block with LocalStorage Sync ========== */
        function renderAbsenceBlock() {
            if (state.currentUser.role !== 'assistant') return '';
            
            const filtered = absenceRecords.filter(a => {
                if (state.filters.filterGrade && a.grade !== state.filters.filterGrade) return false;
                if (state.filters.filterSection && a.section !== state.filters.filterSection) return false;
                if (state.filters.dateFrom && a.date < state.filters.dateFrom) return false;
                if (state.filters.dateTo && a.date > state.filters.dateTo) return false;
                return true;
            });
            
            const lastUpdate = localStorage.getItem('lastUpdate');
            const syncStatus = lastUpdate ? `
                <div class="flex items-center gap-2 text-sm text-green-700 bg-green-50 px-3 py-1 rounded-lg">
                    <span class="text-lg">âœ…</span>
                    <span>Ù…ØªØ²Ø§Ù…Ù† - Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date(lastUpdate).toLocaleTimeString('ar-SA')}</span>
                </div>
            ` : '<div class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>';
            
            const printHandler = () => {
                const pw = window.open('', '_blank');
                pw.document.write(buildAbsencePrintPage(filtered));
                pw.document.close();
                pw.focus();
                pw.print();
            };
            
            return `
                <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ (${filtered.length} Ø³Ø¬Ù„Ø§Øª)</h2>
                            ${syncStatus}
                        </div>
                        <button onclick="(${printHandler})()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-right">#</th>
                                    <th class="px-3 py-2 text-right">Ø§Ù„ØµÙ</th>
                                    <th class="px-3 py-2 text-right">Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                                    <th class="px-3 py-2 text-right">Ø§Ù„Ø­ØµØ©</th>
                                    <th class="px-3 py-2 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="px-3 py-2 text-right">Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨</th>
                                    <th class="px-3 py-2 text-right">Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</th>
                                    <th class="px-3 py-2 text-right">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${filtered.map((a, i) => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-3 py-2">${i + 1}</td>
                                        <td class="px-3 py-2 font-medium">${a.grade}</td>
                                        <td class="px-3 py-2">${a.section}</td>
                                        <td class="px-3 py-2"><span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">Ø§Ù„Ø­ØµØ© ${a.period}</span></td>
                                        <td class="px-3 py-2">${a.date}</td>
                                        <td class="px-3 py-2 text-red-600 font-bold">${a.absentCount}</td>
                                        <td class="px-3 py-2 max-w-xs">
                                            <div class="bg-yellow-50 border border-yellow-200 rounded p-2 text-xs">
                                                ${a.absentStudents && a.absentStudents.length > 0 ? 
                                                    a.absentStudents.slice(0, 3).map((s, j) => `${j + 1}. ${s}`).join('<br>') +
                                                    (a.absentStudents.length > 3 ? `<div class="text-blue-600 font-bold mt-1">... Ùˆ ${a.absentStudents.length - 3} Ø¢Ø®Ø±ÙˆÙ†</div>` : '')
                                                : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                                            </div>
                                        </td>
                                        <td class="px-3 py-2">${a.teacherName}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${filtered.length === 0 ? '<p class="text-center py-8 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØºÙŠØ§Ø¨ Ø¶Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>' : ''}
                    </div>
                </div>`;
        }
        
        function buildAbsencePrintPage(list) {
            const today = new Date().toLocaleDateString('ar-SA');
            return `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ - ${today}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                        body { font-family: 'Cairo', sans-serif; padding: 40px; color: #111; }
                        h1 { text-align: center; margin-bottom: 30px; color: #1e40af; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: right; }
                        th { background: #f3f4f6; }
                        .foot { display: flex; justify-content: space-between; margin-top: 50px; }
                        .sign { width: 200px; text-align: center; border-top: 2px solid #000; padding-top: 10px; }
                        @media print { button.no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ<br><small>${config.schoolInfo.name} - ${today}</small></h1>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„ØµÙ</th>
                                <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                                <th>Ø§Ù„Ø­ØµØ©</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨</th>
                                <th>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†</th>
                                <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map((a, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${a.grade}</td>
                                    <td>${a.section}</td>
                                    <td>Ø§Ù„Ø­ØµØ© ${a.period}</td>
                                    <td>${a.date}</td>
                                    <td>${a.absentCount}</td>
                                    <td>${a.absentStudents && a.absentStudents.length > 0 ? a.absentStudents.join(' ØŒ ') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                                    <td>${a.teacherName}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="foot">
                        <div class="sign">Ø§Ù„ÙˆÙƒÙŠÙ„</div>
                        <div class="sign">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
                    </div>
                    <button class="no-print" onclick="window.print()" style="margin:30px auto;display:block;padding:10px 30px;background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                </body>
                </html>
            `;
        }

        /* ========== Modals Implementation ========== */
        
        function renderAddModal() {
            const {studentName, grade, section, violationType, violationDetails, documentation, date, time} = state.newViolation;
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeAddForm()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                            <p class="text-blue-100 text-sm mt-1">ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="text-red-500">*</span></label>
                                <input type="text" value="${studentName}" 
                                    onchange="state.newViolation.studentName=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨...">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ØµÙ <span class="text-red-500">*</span></label>
                                    <select onchange="state.newViolation.grade=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                                        ${config.grades.map(g => `<option value="${g}" ${grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø´Ø¹Ø¨Ø© <span class="text-red-500">*</span></label>
                                    <select onchange="state.newViolation.section=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>
                                        ${config.sections.map(s => `<option value="${s}" ${section === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© <span class="text-red-500">*</span></label>
                                <select onchange="state.newViolation.violationType=this.value;state.newViolation.violationDetails='';render()" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="first" ${violationType === 'first' ? 'selected' : ''}>Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø¯Ø±Ø¬Ø© ÙˆØ§Ø­Ø¯Ø©)</option>
                                    <option value="second" ${violationType === 'second' ? 'selected' : ''}>Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø¯Ø±Ø¬ØªÙŠÙ†)</option>
                                    <option value="third" ${violationType === 'third' ? 'selected' : ''}>Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø«Ù„Ø§Ø« Ø¯Ø±Ø¬Ø§Øª)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© <span class="text-red-500">*</span></label>
                                <select onchange="state.newViolation.violationDetails=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</option>
                                    ${config.violationTypes[violationType].items.map(item => `
                                        <option value="${item}" ${violationDetails === item ? 'selected' : ''}>${item}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹ <span class="text-red-500">*</span></label>
                                <textarea onchange="state.newViolation.documentation=this.value" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[100px]" 
                                    placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°...">${documentation}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                                    <input type="date" value="${date}" 
                                        onchange="state.newViolation.date=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ÙˆÙ‚Øª</label>
                                    <input type="time" value="${time}" 
                                        onchange="state.newViolation.time=this.value" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeAddForm()" 
                                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                            <button onclick="if(addViolation())render()" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                                âœ“ Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderDetailsModal() {
            const v = state.modals.selectedViolation;
            if (!v) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeDetailsModal()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">ğŸ‘ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <h3 class="font-bold text-xl text-gray-900 mb-2">${v.studentName}</h3>
                                <div class="flex gap-2 flex-wrap">
                                    <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm font-medium">${v.grade}</span>
                                    <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm font-medium">Ø§Ù„Ø´Ø¹Ø¨Ø© ${v.section}</span>
                                    <span class="px-3 py-1 ${getDegreeColor(v.violationType)} rounded-full text-sm font-bold">${getDegreeLabel(v.violationType)}</span>
                                </div>
                            </div>
                            
                            <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</p>
                                <p class="text-lg font-bold text-gray-900">${v.violationDetails}</p>
                            </div>
                            
                            ${v.documentation ? `
                                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                                    <p class="text-sm font-bold text-yellow-900 mb-2">ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹:</p>
                                    <p class="text-gray-800">${v.documentation}</p>
                                </div>
                            ` : ''}
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…</p>
                                    <p class="font-bold text-gray-900">${v.teacherName}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</p>
                                    <p class="font-bold text-gray-900">${v.date}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">ğŸ• Ø§Ù„ÙˆÙ‚Øª</p>
                                    <p class="font-bold text-gray-900">${v.time}</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <p class="text-xs text-gray-600 mb-1">ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©</p>
                                    <p class="font-bold ${v.status === 'active' ? 'text-orange-600' : 'text-green-600'}">
                                        ${v.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…Ø­Ù„ÙˆÙ„'}
                                    </p>
                                </div>
                            </div>
                            
                            ${v.status === 'resolved' && v.resolutionReason ? `
                                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                                    <p class="text-sm font-bold text-green-900 mb-2">ğŸ† Ø³Ø¨Ø¨ Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</p>
                                    <p class="text-gray-800 mb-3">${v.resolutionReason}</p>
                                    <div class="flex gap-4 text-xs text-green-700">
                                        <span>ØªÙ… Ø§Ù„Ø­Ù„ Ø¨ÙˆØ§Ø³Ø·Ø©: ${v.resolvedBy}</span>
                                        <span>ÙÙŠ: ${new Date(v.resolvedAt).toLocaleString('ar-SA')}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeDetailsModal()" 
                                class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium">
                                Ø¥ØºÙ„Ø§Ù‚
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderActionModal() {
            const student = state.modals.selectedStudent;
            if (!student) return '';
            
            const existingAction = state.studentActions.find(
                a => a.studentName === student.name && a.actionBy === state.currentUser.role
            );
            
            // âœ… Ø­ÙØ¸ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† render
            const currentText = existingAction ? existingAction.actionDetails : '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeActionModal()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold">ğŸ“‹ ${existingAction ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø§ØªØ®Ø§Ø°'} Ø¥Ø¬Ø±Ø§Ø¡ ØªØ¬Ø§Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                            <p class="text-orange-100 text-sm mt-1">${student.name} - ${student.grade} Ø§Ù„Ø´Ø¹Ø¨Ø© ${student.section}</p>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                                <h3 class="font-bold text-red-900 mb-3">âš ï¸ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (${student.count} Ù…Ø®Ø§Ù„ÙØ©)</h3>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${student.violations.map((v, i) => `
                                        <div class="bg-white border border-red-300 rounded-lg p-3">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm font-bold text-gray-900">${i + 1}. ${v.violationDetails}</span>
                                                <span class="px-2 py-1 ${getDegreeColor(v.violationType)} rounded-full text-xs font-bold">
                                                    ${getDegreeLabel(v.violationType)}
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-600">ğŸ“… ${v.date} | ğŸ• ${v.time}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° <span class="text-red-500">*</span></label>
                                <textarea id="actionDetailsInput" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 min-h-[150px]" 
                                    placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° ØªØ¬Ø§Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù…Ø«Ø§Ù„: ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±ØŒ Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØŒ Ø§Ù„Ø®...)">${currentText}</textarea>
                            </div>
                            
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <h4 class="font-bold text-blue-900 mb-2">ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:</h4>
                                <ul class="text-sm text-blue-800 space-y-1">
                                    <li>â€¢ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ù†Ø§Ù‚Ø´Ø©</li>
                                    <li>â€¢ Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</li>
                                    <li>â€¢ ÙˆØ¶Ø¹ Ø®Ø·Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø³Ù„ÙˆÙƒÙŠØ©</li>
                                    <li>â€¢ Ø¹Ù‚Ø¯ Ø¬Ù„Ø³Ø© Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© ÙØ±Ø¯ÙŠØ©</li>
                                    <li>â€¢ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">
                            <button onclick="closeActionModal()" 
                                class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                            <button onclick="saveStudentAction()" 
                                class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium">
                                âœ“ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /* ---------- Initial ---------- */
        render();
    </script>
</body>
</html>
                
