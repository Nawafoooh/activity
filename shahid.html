<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخالفات السلوكية - متوسطة المنذر بن عمرو الأنصاري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .modal-backdrop { backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // ---------- Teachers ----------
        const teachersList = [
            'عبدالله بن مطر بن مصلح العمري','محمد بن عماري راضي الزهراني','موفق مرزوق سويرح السحيمي','فواز زايد لافي المهيمزي الرشيدي','فيصل عطالله حويمد الصاعدي','ابراهيم عياد عيد العلوي','عبدالله حمود حامد الحربي','ساير فيصل سعد الله العضيله المطيري','نافع شعوي نافع المطيري','اسامه منور مشعل العوفي','محمد عياد عليثه العوفي','أحمد إبراهيم فخري التركي','أحمد حامد هلال الحربي','نميان علي نميان الحربي','عبدالله صلاح صالح الرحيلى','مشعل بن هليل بن غالب العمري الحربي','علي متعب ناصر العلوي الحربي','سيف عبدالمنعم حمدان العارضي','محمد بن ذعار بن صالح العوفي','فؤاد بن محمد بن حماد العتيبي','حمزة صدقة حمزة اسلام','سلمان صالح أحمد الحارثي','عبيد بن دخيل بن دويهيس العياضي الحربي','عبدالعزيز مفلح نويعم الرويثي','فيصل عواد محمد أبو سلمي','عبدالله بن محمد بن سعيد ال بحران القرني','كاتب مفلح سليمان الرشيدى','حبيب علي نعيس العمري الحربي','ابراهيم عايض عوض الجابري','سلطان عويض معيض السحيمي','عبدالهادي معيض معلا الشاماني','عبدالعزيز عبدالرحمن غلاب المخلفي','سعد طالع حمود الحربي','ناهر مشعل عويد المطيري','موسى غازي سفر الحربي','موسى مسعود عايض الحيسوني','نواف منصور عواد الصبحي','بدر عبدالعزيز شائد السحيمي','فهد عويض عوض الشاماني الحربي','عبدالمجيد عايد خضران الرشيدي','أحمد مطر سليمان الرشيدي'
        ];

        // ---------- Config ----------
        const config = {
            passwords: { principal:'A2030', assistant:'B2030', counselor:'C2030' },
            schoolInfo: { name:'متوسطة المنذر بن عمرو الأنصاري', principal:'خالد المطيري', assistant:'محمد الجابري', counselor:'محمد القحطاني', type:'بنين' },
            grades: ['أول متوسط','ثاني متوسط','ثالث متوسط'],
            sections: ['1','2','3','4','5','6'],
            violationTypes: { /* same as before */ }
        };

        // ---------- Application State ----------
        let state = {
            currentUser: { role:'teacher', name:teachersList[0], id:1 },
            authenticated: { principal:false, assistant:false, counselor:false },
            violations: [/* same initial data */],
            studentActions: [],
            filters: { selectedTab:'all', searchStudent:'', filterGrade:'', filterSection:'', dateFrom:'', dateTo:'' },
            modals: { showAddForm:false, showDetailsModal:false, selectedViolation:null, showActionModal:false, selectedStudent:null },
            newViolation: { studentName:'', grade:'', section:'', violationType:'first', violationDetails:'', documentation:'', date:new Date().toISOString().split('T')[0], time:new Date().toTimeString().slice(0,5) }
        };

        // ---------- Absence Data ----------
        let absenceRecords = [];
        window.addEventListener('message', e => {
            if (e.data && e.data.type === 'absenceData') {
                absenceRecords = e.data.payload || [];
                if (state.currentUser.role === 'assistant') render();
            }
        });

        // ---------- Utility ----------
        function getFilteredViolations() { /* same logic */ }
        function getStats() { /* same */ }
        function render() {
            document.getElementById('app').innerHTML = `
                ${renderHeader()}
                ${renderUserTabs()}
                ${renderMainContent()}
                ${state.modals.showAddForm ? renderAddModal() : ''}
                ${state.modals.showDetailsModal ? renderDetailsModal() : ''}
                ${state.modals.showActionModal ? renderActionModal() : ''}
            `;
        }

        // ---------- Header ----------
        function renderHeader() {
            return `
            <div class="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 text-white shadow-2xl">
                <div class="max-w-7xl mx-auto px-6 py-8">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="text-4xl font-bold mb-2">📚 ${config.schoolInfo.name}</h1>
                            <p class="text-blue-100 text-lg">نظام إدارة المخالفات السلوكية - ${config.schoolInfo.type}</p>
                        </div>
                        <div class="text-left bg-blue-800 bg-opacity-50 rounded-lg p-4 backdrop-blur-sm">
                            <p class="text-sm text-blue-100 mb-1">👤 مدير المدرسة: ${config.schoolInfo.principal}</p>
                            <p class="text-sm text-blue-100 mb-1">👤 الوكيل: ${config.schoolInfo.assistant}</p>
                            <p class="text-sm text-blue-100">👤 الموجه الطلابي: ${config.schoolInfo.counselor}</p>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // ---------- Top Bar ----------
        function renderUserTabs() {
            const isActive = r => state.currentUser.role === r;
            const btn = (r,icon,label) => `<button onclick="setCurrentUser('${r}', '${config.schoolInfo[r]}', ${r==='teacher'?1:r==='assistant'?2:r==='counselor'?3:4})" class="flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${isActive(r)?'bg-blue-600 text-white shadow-lg scale-105':'bg-gray-100 text-gray-700 hover:bg-gray-200'}">${icon} ${label}</button>`;

            return `
            <div class="bg-white border-b shadow-sm sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-6 py-4">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex gap-2 flex-wrap items-center">
                            ${state.currentUser.role==='teacher'?`
                                <select onchange="setCurrentUser('teacher', this.value, 1)" class="px-4 py-3 border-2 border-blue-600 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium text-blue-900 bg-blue-50">
                                    ${teachersList.map(t=>`<option ${state.currentUser.name===t?'selected':''}>👨‍🏫 ${t}</option>`).join('')}
                                </select>
                            `:btn('teacher','👨‍🏫','صفحة المعلم')}
                            ${btn('assistant','📋','صفحة الوكيل')}
                            ${btn('counselor','📢','الموجه الطلابي')}
                            ${btn('principal','🏛️','صفحة المدير')}

                            <!-- ✅ رابط صفحة الغياب -->
                            <a href="https://nawafoooh.github.io/activity/absent.html"
                               class="px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                               📋 تسجيل الغياب
                            </a>
                        </div>
                        <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                            <p class="text-sm text-blue-900"><span class="font-bold">المستخدم الحالي:</span> ${state.currentUser.name} - ${getRoleLabel(state.currentUser.role)}</p>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // ---------- Main Content ----------
        function renderMainContent() {
            const stats = getStats();
            const filtered = getFilteredViolations();
            return `
            <div class="max-w-7xl mx-auto px-6 py-6">
                ${renderStats(stats)}
                ${renderViolationsSection(filtered)}
                ${renderStudentsUnderWatch()}
                ${renderAbsenceBlock()}   <!-- ➜ ظهور الغياب للوكيل فقط -->
            </div>`;
        }

        // ---------- Absence Block (وكيل only) ----------
        function renderAbsenceBlock() {
            if (state.currentUser.role !== 'assistant') return '';
            const filtered = absenceRecords.filter(a => {
                if (state.filters.filterGrade   && a.grade   !== state.filters.filterGrade)   return false;
                if (state.filters.filterSection && a.section !== state.filters.filterSection) return false;
                if (state.filters.dateFrom      && a.date    <  state.filters.dateFrom)       return false;
                if (state.filters.dateTo        && a.date    >  state.filters.dateTo)         return false;
                return true;
            });

            const printHandler = () => {
                const pw = window.open('', '_blank');
                pw.document.write(buildAbsencePrintPage(filtered));
                pw.document.close();
                pw.focus();
                pw.print();
            };

            return `
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">📋 سجل الغياب (${filtered.length} سجلات)</h2>
                    <button onclick="(${printHandler})()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow">🖨️ طباعة</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-right">#</th>
                                <th class="px-3 py-2 text-right">الصف</th>
                                <th class="px-3 py-2 text-right">الشعبة</th>
                                <th class="px-3 py-2 text-right">الحصة</th>
                                <th class="px-3 py-2 text-right">التاريخ</th>
                                <th class="px-3 py-2 text-right">عدد الغياب</th>
                                <th class="px-3 py-2 text-right">أسماء الغائبين</th>
                                <th class="px-3 py-2 text-right">المعلم</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${filtered.map((a,i)=>`
                            <tr class="hover:bg-gray-50">
                                <td>${i+1}</td>
                                <td class="font-medium">${a.grade}</td>
                                <td>${a.section}</td>
                                <td><span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">الحصة ${a.period}</span></td>
                                <td>${a.date}</td>
                                <td class="text-red-600 font-bold">${a.absentCount}</td>
                                <td class="max-w-xs"><div class="bg-yellow-50 border border-yellow-200 rounded p-2 text-xs">${a.absentStudents?.slice(0,3).map((s,j)=>`${j+1}. ${s}`).join('<br>')}${a.absentStudents.length>3?`<div class="text-blue-600 font-bold mt-1">... و ${a.absentStudents.length-3} آخرون</div>`:''}</div></td>
                                <td>${a.teacherName}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                    ${filtered.length===0?'<p class="text-center py-8 text-gray-500">لا توجد سجلات غياب ضمن الفلاتر المحددة</p>':''}
                </div>
            </div>`;
        }

        // ---------- Print Absence ----------
        function buildAbsencePrintPage(list) {
            const today = new Date().toLocaleDateString('ar-SA');
            return `
            <!DOCTYPE html>
            <html lang="ar" dir="rtl">
            <head>
                <meta charset="UTF-8">
                <title>تقرير الغياب - ${today}</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                    body{font-family:'Cairo',sans-serif;padding:40px;color:#111}
                    h1{text-align:center;margin-bottom:30px;color:#1e40af}
                    table{width:100%;border-collapse:collapse;margin-top:20px}
                    th,td{padding:8px 12px;border:1px solid #ccc;text-align:right}
                    th{background:#f3f4f6}
                    .foot{display:flex;justify-content:space-between;margin-top:50px}
                    .sign{width:200px;text-align:center;border-top:2px solid #000;padding-top:10px}
                    @media print{button.no-print{display:none}}
                </style>
            </head>
            <body>
                <h1>📋 تقرير الغياب اليومي<br><small>${config.schoolInfo.name} - ${today}</small></h1>
                <table>
                    <thead><tr>
                        <th>#</th><th>الصف</th><th>الشعبة</th><th>الحصة</th><th>التاريخ</th>
                        <th>عدد الغياب</th><th>أسماء الغائبين</th><th>المعلم</th>
                    </tr></thead>
                    <tbody>
                    ${list.map((a,i)=>`
                        <tr>
                            <td>${i+1}</td><td>${a.grade}</td><td>${a.section}</td>
                            <td>الحصة ${a.period}</td><td>${a.date}</td>
                            <td>${a.absentCount}</td>
                            <td>${a.absentStudents?.join(' ، ')}</td>
                            <td>${a.teacherName}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                <div class="foot">
                    <div class="sign">الوكيل</div>
                    <div class="sign">مدير المدرسة</div>
                </div>
                <button class="no-print" onclick="window.print()" style="margin:30px auto;display:block;padding:10px 30px;background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer">🖨️ طباعة</button>
            </body>
            </html>`;
        }

        // ---------- Other Helpers ----------
        function getRoleLabel(r){const m={teacher:'المعلم',assistant:'الوكيل',counselor:'الموجه الطلابي',principal:'المدير'};return m[r]}
        function renderStats(s){/* same */ return ``}
        function renderViolationsSection(f){/* same */ return ``}
        function renderStudentsUnderWatch(){/* same */ return ``}
        function renderAddModal(){/* same */ return ``}
        function renderDetailsModal(){/* same */ return ``}
        function renderActionModal(){/* same */ return ``}
        function setCurrentUser(r,n,i){/* same */}

        // ---------- Initial Render ----------
        render();
    </script>
</body>
</html>
