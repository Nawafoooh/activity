('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ');
                return;
            }
            if (!v.section) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø©');
                return;
            }
            if (!v.violationDetails) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©');
                return;
            }
            if (!v.actionTaken) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©');
                return;
            }
            
            const violation = {
                studentName: v.studentName.trim(),
                grade: v.grade,
                section: v.section,
                violationType: v.violationType,
                violationDetails: v.violationDetails,
                actionTaken: v.actionTaken,
                date: v.date,
                time: v.time,
                teacherName: state.currentUser.name,
                teacherId: state.currentUser.id,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            try {
                showLoading();
                
                // Try to save to Firebase
                if (isFirebaseInitialized) {
                    try {
                        const docId = await addViolationToFirebase(violation);
                        violation.id = docId;
                    } catch (firebaseError) {
                        console.error('Firebase error:', firebaseError);
                        // Continue with local storage if Firebase fails
                        violation.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        alert('âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·. Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                    }
                } else {
                    // No Firebase - use local ID
                    violation.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                
                state.violations.unshift(violation);
                
                const count = getStudentViolationCount(violation.studentName, state.currentUser.id);
                
                let msg = 'âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­!\n\n';
                msg += `ğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨: ${violation.studentName}\n`;
                msg += `ğŸ“š Ø§Ù„ØµÙ: ${violation.grade} - Ø§Ù„Ø´Ø¹Ø¨Ø© ${violation.section}\n`;
                msg += `âš ï¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©: ${violation.violationDetails}\n`;
                msg += `ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹: ${violation.actionTaken}`;
                
                if (count >= 3) {
                    msg += `\n\nğŸš¨ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ø¯ÙŠÙ‡ ${count} Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ù†Ùƒ!\n`;
                    msg += 'Ø³ÙŠØªÙ… Ø¥Ø­Ø§Ù„ØªÙ‡ Ù„Ù„ÙˆÙƒÙŠÙ„/Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.';
                }
                
                hideLoading();
                alert(msg);
                closeAddForm();
            } catch (error) {
                hideLoading();
                console.error('Error adding violation:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©: ' + error.message);
            }
        };

        window.resolveViolation = async function(violationId) {
            const reason = prompt('Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ):');
            
            if (reason && reason.trim()) {
                try {
                    const updates = {
                        status: 'resolved',
                        resolutionReason: reason.trim(),
                        resolvedBy: state.currentUser.name,
                        resolvedAt: new Date().toISOString()
                    };
                    
                    await updateViolationInFirebase(violationId, updates);
                    
                    state.violations = state.violations.map(v => 
                        v.id === violationId ? { ...v, ...updates } : v
                    );
                    
                    render();
                    alert('âœ… ØªÙ… Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©: ' + error.message);
                }
            }
        };

        window.openDetailsModal = function(violationId) {
            const violation = state.violations.find(v => v.id === violationId);
            if (violation) {
                state.modals.selectedViolation = sanitizeForJson(violation);
                state.modals.showDetailsModal = true;
                render();
            }
        };

        window.closeDetailsModal = function() {
            state.modals.showDetailsModal = false;
            state.modals.selectedViolation = null;
            render();
        };

        window.openActionModal = function(studentIndex) {
            const students = getStudentsByViolationCount();
            const student = students[studentIndex];
            if (student) {
                state.modals.selectedStudent = sanitizeForJson(student);
                state.modals.showActionModal = true;
                render();
            }
        };

        window.closeActionModal = function() {
            state.modals.showActionModal = false;
            state.modals.selectedStudent = null;
            render();
        };

        window.saveStudentAction = async function() {
            const actionDetails = document.getElementById('actionDetailsInput')?.value.trim();
            
            if (!actionDetails) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°');
                return;
            }

            const student = state.modals.selectedStudent;
            
            const action = {
                studentName: student.name,
                teacherId: student.teacherId,
                teacherName: student.teacherName,
                actionBy: state.currentUser.role,
                actionByName: state.currentUser.name,
                actionDate: new Date().toISOString(),
                actionDetails: actionDetails,
                violationsIncluded: student.violations.map(v => v.id)
            };

            try {
                const docId = await addStudentActionToFirebase(action);
                action.id = docId;
                state.studentActions.push(action);

                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!');
                closeActionModal();
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ' + error.message);
            }
        };

        window.printStudentReport = function(studentIndex) {
            const students = getStudentsByViolationCount();
            const student = students[studentIndex];
            
            if (!student) return;
            
            const action = state.studentActions.find(a => 
                a.studentName === student.name && 
                a.teacherId === student.teacherId &&
                a.actionBy === state.currentUser.role
            );

            const printWindow = window.open('', '_blank');
            printWindow.document.write(generatePrintContent(student, action));
            printWindow.document.close();
        };

        function generatePrintContent(student, action) {
            return `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø®Ø§Ù„ÙØ§Øª - ${student.name}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
                        body { font-family: 'Cairo', sans-serif; padding: 40px; direction: rtl; }
                        .header { text-align: center; border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { color: #1e40af; margin: 10px 0; }
                        .info-box { background: #f3f4f6; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
                        .violation-item { border: 2px solid #e5e7eb; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
                        .teacher-highlight { background: #fef3c7; padding: 15px; border-radius: 8px; border: 2px solid #f59e0b; margin-bottom: 20px; }
                        .action-box { background: #dbeafe; border: 2px solid #2563eb; padding: 20px; border-radius: 8px; margin-top: 30px; }
                        .signature-area { margin-top: 50px; display: flex; justify-content: space-between; }
                        .signature-box { text-align: center; width: 200px; }
                        .signature-line { border-top: 2px solid #000; margin-top: 60px; padding-top: 10px; }
                        @media print { body { padding: 20px; } .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ğŸ“š ${config.schoolInfo.name}</h1>
                        <h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ©</h2>
                        <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>

                    <div class="teacher-highlight">
                        <h3 style="color: #92400e; margin-bottom: 10px; font-size: 18px;">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø³Ø¬Ù„ Ù„Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3>
                        <div style="font-size: 20px; font-weight: bold; color: #78350f;">${student.teacherName}</div>
                        <div style="margin-top: 5px; font-size: 14px; color: #92400e;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¯Ù†Ø§Ù‡ Ù…Ø³Ø¬Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙ‚Ø·</div>
                    </div>

                    <div class="info-box">
                        <h3 style="color: #1e40af; margin-bottom: 15px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                        <div class="info-row"><strong>Ø§Ù„Ø§Ø³Ù…:</strong><span>${student.name}</span></div>
                        <div class="info-row"><strong>Ø§Ù„ØµÙ:</strong><span>${student.grade}</span></div>
                        <div class="info-row"><strong>Ø§Ù„Ø´Ø¹Ø¨Ø©:</strong><span>${student.section}</span></div>
                        <div class="info-row"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:</strong><span style="color: #dc2626; font-weight: bold;">${student.count} Ù…Ø®Ø§Ù„ÙØ§Øª</span></div>
                    </div>

                    <h3 style="color: #1e40af; margin-top: 30px; margin-bottom: 15px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:</h3>
                    ${student.violations.map((v, i) => `
                        <div class="violation-item">
                            <div style="font-weight: bold; margin-bottom: 10px;">
                                ${i + 1}. ${v.violationDetails}
                                <span style="background: ${v.violationType === 'first' ? '#dcfce7' : v.violationType === 'second' ? '#fef3c7' : '#fee2e2'}; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-right: 10px;">
                                    ${getDegreeLabel(v.violationType)}
                                </span>
                            </div>
                            <div style="color: #6b7280; font-size: 14px;">
                                <div>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date} | ğŸ• Ø§Ù„ÙˆÙ‚Øª: ${v.time}</div>
                                ${v.actionTaken ? `<div style="margin-top: 8px;">ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹: ${v.actionTaken}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}

                    ${action ? `
                        <div class="action-box">
                            <h3 style="color: #1e40af; margin-bottom: 15px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° Ù…Ù† Ù‚Ø¨Ù„ ${getRoleLabel(action.actionBy)}</h3>
                            <div style="margin-bottom: 10px;"><strong>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong> ${action.actionByName}</div>
                            <div style="margin-bottom: 10px;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(action.actionDate).toLocaleString('ar-SA')}</div>
                            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 4px;">
                                <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</strong>
                                <p style="margin-top: 10px; line-height: 1.8;">${action.actionDetails}</p>
                            </div>
                        </div>
                    ` : ''}

                    <div class="signature-area">
                        <div class="signature-box"><div class="signature-line">Ø§Ù„Ù…Ø¹Ù„Ù…<br>${student.teacherName}</div></div>
                        <div class="signature-box"><div class="signature-line">${state.currentUser.role === 'assistant' ? 'Ø§Ù„ÙˆÙƒÙŠÙ„' : 'Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ'}</div></div>
                        <div class="signature-box"><div class="signature-line">ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div></div>
                        <div class="signature-box"><div class="signature-line">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div></div>
                    </div>

                    <div class="no-print" style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="background: #2563eb; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-family: 'Cairo', sans-serif;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                        <button onclick="window.close()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-right: 10px; font-family: 'Cairo', sans-serif;">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </body>
                </html>
            `;
        }

        window.exportToCSV = function() {
            const filtered = getFilteredViolations();
            const headers = ['#', 'Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„ØµÙ', 'Ø§Ù„Ø´Ø¹Ø¨Ø©', 'Ø§Ù„Ø¯Ø±Ø¬Ø©', 'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©', 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹', 'Ø§Ù„Ù…Ø¹Ù„Ù…', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙˆÙ‚Øª', 'Ø§Ù„Ø­Ø§Ù„Ø©'];
            const rows = filtered.map((v, i) => [
                i + 1,
                v.studentName,
                v.grade,
                v.section,
                getDegreeLabel(v.violationType),
                v.violationDetails,
                v.actionTaken || '',
                v.teacherName,
                v.date,
                v.time,
                v.status === 'active' ? 'Ù†Ø´Ø·' : 'Ù…Ø­Ù„ÙˆÙ„'
            ]);

            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Ù…Ø®Ø§Ù„ÙØ§Øª_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };

        // ==========================================
        // Render Functions
        // ==========================================
        function render() {
            console.log('ğŸ¨ Ø¨Ø¯Ø¡ Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
            console.log('ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:', state.currentUser.role, state.currentUser.name);
            console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:', state.violations.length);
            console.log('ğŸ“¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:', state.notificationsSent.length);
            
            const app = document.getElementById('app');
            app.innerHTML = `
                ${renderHeader()}
                ${renderUserTabs()}
                ${renderMainContent()}
                ${state.modals.showAddForm ? renderAddModal() : ''}
                ${state.modals.showDetailsModal ? renderDetailsModal() : ''}
                ${state.modals.showActionModal ? renderActionModal() : ''}
            `;
            
            console.log('âœ… ØªÙ… Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
        }

        function renderHeader() {
            return `
                <div class="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 text-white shadow-2xl">
                    <div class="max-w-7xl mx-auto px-6 py-8">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div>
                                <h1 class="text-4xl font-bold mb-2">ğŸ“š ${config.schoolInfo.name}</h1>
                                <p class="text-blue-100 text-lg">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ© - ${config.schoolInfo.type}</p>
                                ${isFirebaseInitialized ? 
                                    '<p class="text-green-300 text-sm mt-2">ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>' : 
                                    '<p class="text-red-300 text-sm mt-2">ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>'
                                }
                            </div>
                            <div class="text-left bg-blue-800 bg-opacity-50 rounded-lg p-4">
                                <p class="text-sm text-blue-100 mb-1">ğŸ‘¤ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${config.schoolInfo.principal}</p>
                                <p class="text-sm text-blue-100 mb-1">ğŸ‘¤ Ø§Ù„ÙˆÙƒÙŠÙ„: ${config.schoolInfo.assistant}</p>
                                <p class="text-sm text-blue-100">ğŸ‘¤ Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ: ${config.schoolInfo.counselor}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUserTabs() {
            const isActive = (role) => state.currentUser.role === role;
            const btnClass = (role) => `flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all duration-200 ${
                isActive(role) ? 'bg-blue-600 text-white shadow-lg transform scale-105' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`;
            const isLocked = (role) => (role === 'principal' || role === 'assistant' || role === 'counselor') && !state.authenticated[role];

            return `
                <div class="bg-white border-b shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex gap-2 flex-wrap items-center">
                                ${state.currentUser.role === 'teacher' ? `
                                    <select onchange="setCurrentUser('teacher', this.value)" class="px-4 py-3 border-2 border-blue-600 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium text-blue-900 bg-blue-50">
                                        ${teachersList.map(t => `<option value="${t}" ${state.currentUser.name === t ? 'selected' : ''}>ğŸ‘¨â€ğŸ« ${t}</option>`).join('')}
                                    </select>
                                ` : `
                                    <button onclick="setCurrentUser('teacher', '${teachersList[0]}', 1)" class="${btnClass('teacher')}">ğŸ‘¨â€ğŸ« ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…</button>
                                `}
                                <button onclick="setCurrentUser('assistant', '${config.schoolInfo.assistant}', 999)" class="${btnClass('assistant')}">
                                    ${isLocked('assistant') ? 'ğŸ”’' : 'ğŸ“‹'} ØµÙØ­Ø© Ø§Ù„ÙˆÙƒÙŠÙ„
                                </button>
                                <button onclick="setCurrentUser('counselor', '${config.schoolInfo.counselor}', 998)" class="${btnClass('counselor')}">
                                    ${isLocked('counselor') ? 'ğŸ”’' : 'ğŸ“¢'} Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ
                                </button>
                                <button onclick="setCurrentUser('principal', '${config.schoolInfo.principal}', 997)" class="${btnClass('principal')}">
                                    ${isLocked('principal') ? 'ğŸ”’' : 'ğŸ›ï¸'} ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
                                </button>
                                <button onclick="setCurrentUser('admin_assistant', '${config.schoolInfo.adminAssistant}', 996)" class="${btnClass('admin_assistant')}">
                                    ${isLocked('admin_assistant') ? 'ğŸ”’' : 'ğŸ“'} Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
                                </button>
                            </div>
                            <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
                                <p class="text-sm text-blue-900"><span class="font-bold">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</span> ${state.currentUser.name} - ${getRoleLabel(state.currentUser.role)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainContent() {
            const stats = getStats();
            const filtered = getFilteredViolations();

            // Show admin assistant dashboard
            if (state.currentUser.role === 'admin_assistant') {
                return renderAdminAssistantDashboard();
            }

            return `
                <div class="max-w-7xl mx-auto px-6 py-6">
                    ${renderStats(stats)}
                    ${renderViolationsSection(filtered)}
                    ${renderStudentsUnderWatch()}
                </div>
            `;
        }

        function renderAdminAssistantDashboard() {
            // Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙÙ‚Ø·
            const activeViolations = state.violations.filter(v => v.status === 'active');
            
            // Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù‡Ø§
            const pendingNotifications = activeViolations.filter(v => !isNotificationSent(v.id));
            
            // Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù‡Ø§
            const sentNotifications = activeViolations.filter(v => isNotificationSent(v.id));

            return `
                <div class="max-w-7xl mx-auto px-6 py-6">
                    <!-- Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-4xl">ğŸ“¢</span>
                                <div class="text-3xl font-bold text-red-600">${pendingNotifications.length}</div>
                            </div>
                            <div class="text-gray-600 font-medium">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-4xl">âœ…</span>
                                <div class="text-3xl font-bold text-green-600">${sentNotifications.length}</div>
                            </div>
                            <div class="text-gray-600 font-medium">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-4xl">ğŸ“Š</span>
                                <div class="text-3xl font-bold text-blue-600">${activeViolations.length}</div>
                            </div>
                            <div class="text-gray-600 font-medium">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
                        </div>
                    </div>

                    <!-- Pending Notifications -->
                    <div class="bg-white rounded-xl shadow-lg mb-6">
                        <div class="border-b px-6 py-4 bg-red-50">
                            <h2 class="text-2xl font-bold text-red-800 flex items-center gap-2">
                                ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± - ØªØ­ØªØ§Ø¬ Ø¥Ø±Ø³Ø§Ù„ (${pendingNotifications.length})
                            </h2>
                            <p class="text-sm text-red-600 mt-1">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</p>
                        </div>
                        <div class="divide-y max-h-[600px] overflow-y-auto">
                            ${pendingNotifications.length > 0 ? pendingNotifications.map(v => `
                                <div class="p-6 hover:bg-gray-50 transition-all border-r-4 border-red-400">
                                    <div class="flex justify-between items-start gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-3 flex-wrap">
                                                <h3 class="text-xl font-bold text-gray-900">${v.studentName}</h3>
                                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full">${v.grade}</span>
                                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full">Ø§Ù„Ø´Ø¹Ø¨Ø© ${v.section}</span>
                                                <span class="px-3 py-1 rounded-full text-xs font-bold ${getDegreeColor(v.violationType)}">${getDegreeLabel(v.violationType)}</span>
                                                <span class="bg-red-600 text-white px-4 py-1 rounded-full text-xs font-bold animate-pulse">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¹Ø¯</span>
                                            </div>
                                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
                                                <p class="text-gray-800 font-semibold mb-2"><strong>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</strong> ${v.violationDetails}</p>
                                                ${v.actionTaken ? `<p class="text-sm text-gray-700 mt-2"><strong>ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹:</strong> ${v.actionTaken}</p>` : ''}
                                            </div>
                                            <div class="flex gap-4 text-sm text-gray-600 mb-3">
                                                <span>ğŸ‘¨â€ğŸ« <strong>Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> ${v.teacherName}</span>
                                                <span>ğŸ“… ${v.date}</span>
                                                <span>ğŸ• ${v.time}</span>
                                            </div>
                                            <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-900">
                                                <strong>ğŸ“± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</strong> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ØŒ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <button onclick="markAsSent('${v.id}')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors shadow-lg whitespace-nowrap font-bold text-lg">
                                                âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="p-16 text-center">
                                    <div class="text-6xl mb-4">âœ…</div>
                                    <p class="text-xl text-gray-500 font-bold">Ù…Ù…ØªØ§Ø²! Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§</p>
                                    <p class="text-sm text-gray-400 mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- Sent Notifications History -->
                    <div class="bg-white rounded-xl shadow-lg">
                        <div class="border-b px-6 py-4 bg-green-50">
                            <h2 class="text-2xl font-bold text-green-800 flex items-center gap-2">
                                âœ… Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© (${sentNotifications.length})
                            </h2>
                            <p class="text-sm text-green-600 mt-1">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù‡Ø§ Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</p>
                        </div>
                        <div class="divide-y max-h-[500px] overflow-y-auto">
                            ${sentNotifications.length > 0 ? sentNotifications.map(v => {
                                const notificationInfo = getNotificationInfo(v.id);
                                return `
                                    <div class="p-4 hover:bg-gray-50 border-r-4 border-green-400">
                                        <div class="flex justify-between items-start gap-4">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2 flex-wrap">
                                                    <h4 class="font-bold text-gray-900 text-lg">${v.studentName}</h4>
                                                    <span class="text-xs bg-gray-100 px-3 py-1 rounded-full">${v.grade} - ${v.section}</span>
                                                    <span class="text-xs ${getDegreeColor(v.violationType)} px-3 py-1 rounded-full font-bold">${getDegreeLabel(v.violationType)}</span>
                                                    <span class="text-xs bg-green-600 text-white px-3 py-1 rounded-full font-bold">âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
                                                </div>
                                                <p class="text-sm text-gray-700 mb-2"><strong>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</strong> ${v.violationDetails}</p>
                                                ${v.actionTaken ? `<p class="text-xs text-gray-600 mb-2"><strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹:</strong> ${v.actionTaken}</p>` : ''}
                                                <div class="flex gap-3 text-xs text-gray-500 mb-2">
                                                    <span>ğŸ‘¨â€ğŸ« ${v.teacherName}</span>
                                                    <span>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©: ${v.date}</span>
                                                </div>
                                                ${notificationInfo ? `
                                                    <div class="bg-green-50 border border-green-200 rounded p-2 mt-2">
                                                        <div class="flex gap-3 text-xs text-green-800">
                                                            <span>ğŸ“¤ Ø£Ø±Ø³Ù„ Ø¨ÙˆØ§Ø³Ø·Ø©: ${notificationInfo.sentBy}</span>
                                                            <span>ğŸ“… ${new Date(notificationInfo.sentAt).toLocaleDateString('ar-SA')}</span>
                                                            <span>ğŸ• ${new Date(notificationInfo.sentAt).toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'})}</span>
                                                        </div>
                                                        ${notificationInfo.notes ? `<p class="text-xs text-green-700 mt-1"><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${notificationInfo.notes}</p>` : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('') : `
                                <div class="p-16 text-center">
                                    <div class="text-6xl mb-4">ğŸ“­</div>
                                    <p class="text-xl text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¨Ø¹Ø¯</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStats(stats) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-blue-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">âš ï¸</span>
                            <div class="text-3xl font-bold text-blue-600">${stats.active}</div>
                        </div>
                        <div class="text-gray-600 font-medium">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-green-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">âœ…</span>
                            <div class="text-3xl font-bold text-green-600">${stats.resolved}</div>
                        </div>
                        <div class="text-gray-600 font-medium">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-orange-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">ğŸ‘ï¸</span>
                            <div class="text-3xl font-bold text-orange-600">${stats.studentsUnderWatch}</div>
                        </div>
                        <div class="text-gray-600 font-medium">Ø·Ù„Ø§Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-purple-500">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl">ğŸ“…</span>
                            <div class="text-3xl font-bold text-purple-600">${stats.today}</div>
                        </div>
                        <div class="text-gray-600 font-medium">Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                    </div>
                </div>
            `;
        }

        function renderViolationsSection(filtered) {
            const stats = getStats();
            const tabClass = (tab) => `px-5 py-2.5 rounded-lg font-medium transition-all duration-200 ${
                state.filters.selectedTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'
            }`;

            return `
                <div class="bg-white rounded-xl shadow-lg mb-6">
                    <div class="border-b px-6 py-4">
                        <div class="flex items-center justify-between flex-wrap gap-4">
                            <div class="flex gap-3">
                                <button onclick="setFilter('selectedTab', 'all')" class="${tabClass('all')}">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (${state.violations.length})</button>
                                <button onclick="setFilter('selectedTab', 'active')" class="${tabClass('active')}">Ø§Ù„Ù†Ø´Ø·Ø© (${stats.active})</button>
                                <button onclick="setFilter('selectedTab', 'resolved')" class="${tabClass('resolved')}">Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø© (${stats.resolved})</button>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="exportToCSV()" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-md">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                                ${state.currentUser.role === 'teacher' ? '<button onclick="openAddForm()" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>' : ''}
                            </div>
                        </div>
                    </div>
                    ${renderFilters()}
                    ${renderViolationsList(filtered)}
                </div>
            `;
        }

        function renderFilters() {
            const hasFilters = state.filters.searchStudent || state.filters.filterGrade || state.filters.filterSection || state.filters.dateFrom || state.filters.dateTo;

            return `
                <div class="p-6 bg-gray-50 border-b">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" value="${state.filters.searchStudent}" onchange="setFilter('searchStudent', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“Š Ø§Ù„ØµÙ</label>
                            <select onchange="setFilter('filterGrade', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                ${config.grades.map(g => `<option value="${g}" ${state.filters.filterGrade === g ? 'selected' : ''}>${g}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
                            <select onchange="setFilter('filterSection', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                ${config.sections.map(s => `<option value="${s}" ${state.filters.filterSection === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" value="${state.filters.dateFrom}" onchange="setFilter('dateFrom', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" value="${state.filters.dateTo}" onchange="setFilter('dateTo', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    ${hasFilters ? '<button onclick="clearFilters()" class="mt-4 text-sm text-blue-600 hover:text-blue-800 font-medium">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±</button>' : ''}
                </div>
            `;
        }

        function renderViolationsList(filtered) {
            if (filtered.length === 0) {
                return `
                    <div class="p-16 text-center">
                        <div class="text-6xl mb-4">âš ï¸</div>
                        <p class="text-xl text-gray-500 mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª Ù„Ù„Ø¹Ø±Ø¶</p>
                        <p class="text-sm text-gray-400">Ø¬Ø±Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</p>
                    </div>
                `;
            }

            return `
                <div class="divide-y">
                    ${filtered.map(v => renderViolationItem(v)).join('')}
                </div>
                <div class="p-4 bg-gray-50 border-t text-center text-sm text-gray-600">
                    Ø¹Ø±Ø¶ ${filtered.length} Ù…Ù† Ø£ØµÙ„ ${state.violations.length} Ù…Ø®Ø§Ù„ÙØ©
                </div>
            `;
        }

        function renderViolationItem(v) {
            const violationCount = getStudentViolationCount(v.studentName, v.teacherId);
            const isHighPriority = violationCount >= 3;
            
            return `
                <div class="p-6 hover:bg-gray-50 transition-all duration-200 ${isHighPriority && v.status === 'active' ? 'bg-red-50 border-r-4 border-red-500' : ''}">
                    <div class="flex justify-between items-start gap-6">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3 flex-wrap">
                                <h3 class="text-xl font-bold text-gray-900">${v.studentName}</h3>
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">${v.grade}</span>
                                <span class="text-sm bg-gray-100 text-gray-700 px-3 py-1 rounded-full font-medium">Ø§Ù„Ø´Ø¹Ø¨Ø© ${v.section}</span>
                                <span class="px-3 py-1 rounded-full text-xs font-bold border-2 ${getDegreeColor(v.violationType)}">${getDegreeLabel(v.violationType)}</span>
                                ${isHighPriority && v.status === 'active' ? `<span class="flex items-center gap-1 bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md animate-pulse">âš ï¸ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (${violationCount} Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ù† ${v.teacherName})</span>` : ''}
                                ${v.status === 'resolved' ? '<span class="flex items-center gap-1 bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">âœ… ØªÙ… Ø§Ù„Ø­Ù„</span>' : ''}
                            </div>
                            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
                                <p class="text-gray-800 mb-2 font-semibold text-lg">${v.violationDetails}</p>
                                ${v.actionTaken ? `<div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg"><p class="text-sm text-blue-900"><span class="font-bold">ğŸ“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹:</span><br>${v.actionTaken}</p></div>` : ''}
                            </div>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                                <span>ğŸ‘¤ <strong>Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> ${v.teacherName}</span>
                                <span>ğŸ“… <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${v.date}</span>
                                <span>ğŸ• <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${v.time}</span>
                            </div>
                            ${v.status === 'resolved' && v.resolutionReason ? `
                                <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-start gap-2 mb-2">
                                        <span class="text-2xl">ğŸ†</span>
                                        <div class="flex-1">
                                            <p class="text-sm font-bold text-green-900 mb-1">Ø³Ø¨Ø¨ Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ):</p>
                                            <p class="text-sm text-green-800 mb-2">${v.resolutionReason}</p>
                                            <div class="flex gap-4 text-xs text-green-700">
                                                <span>ØªÙ… Ø§Ù„Ø­Ù„ Ø¨ÙˆØ§Ø³Ø·Ø©: ${v.resolvedBy}</span>
                                                <span>ÙÙŠ: ${new Date(v.resolvedAt).toLocaleString('ar-SA')}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="openDetailsModal('${v.id}')" class="flex items-center gap-2 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors whitespace-nowrap">ğŸ‘ï¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                            ${v.status === 'active' && canResolveViolation(v) ? '<button onclick="resolveViolation(\'' + v.id + '\')" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md whitespace-nowrap">ğŸ† Ø­Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</button>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStudentsUnderWatch() {
            if (state.currentUser.role !== 'assistant' && state.currentUser.role !== 'counselor' && state.currentUser.role !== 'principal') {
                return '';
            }

            const studentsUnderWatch = getStudentsByViolationCount();

            return `
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-red-700">âš ï¸ Ø§Ù„Ø·Ù„Ø§Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (3 Ù…Ø®Ø§Ù„ÙØ§Øª ÙØ£ÙƒØ«Ø± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ù„Ù…)</h2>
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                        <p class="text-sm text-yellow-900"><strong>ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</strong> ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù… Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ‚Ù„. Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠÙØ­Ø§Ù„ Ù„Ù„ÙˆÙƒÙŠÙ„/Ø§Ù„Ù…Ø±Ø´Ø¯ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ³Ø¬Ù„ <strong>Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ù„Ù…</strong> 3 Ù…Ø®Ø§Ù„ÙØ§Øª Ø£Ùˆ Ø£ÙƒØ«Ø± Ø¹Ù„ÙŠÙ‡.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${studentsUnderWatch.length > 0 ? studentsUnderWatch.map((student, index) => {
                            const hasAction = state.studentActions.find(a => 
                                a.studentName === student.name && a.teacherId === student.teacherId && a.actionBy === state.currentUser.role
                            );
                            return `
                                <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                    <div class="flex items-center justify-between mb-3">
                                        <h3 class="font-bold text-gray-900">${student.name}</h3>
                                        <span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold">${student.count} Ù…Ø®Ø§Ù„ÙØ§Øª</span>
                                    </div>
                                    <div class="text-sm text-gray-600 mb-2">${student.grade} - Ø§Ù„Ø´Ø¹Ø¨Ø© ${student.section}</div>
                                    <div class="text-xs bg-yellow-100 border border-yellow-300 rounded p-2 mb-2"><strong>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…:</strong> ${student.teacherName}</div>
                                    <div class="text-xs text-gray-500 mb-3">Ø¢Ø®Ø± Ù…Ø®Ø§Ù„ÙØ©: ${student.violations[student.violations.length - 1].date}</div>
                                    ${hasAction ? '<div class="bg-blue-100 border border-blue-300 rounded p-2 mb-3 text-xs"><div class="font-bold text-blue-900 mb-1">âœ… ØªÙ… Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡</div><div class="text-blue-800">' + new Date(hasAction.actionDate).toLocaleDateString('ar-SA') + '</div></div>' : ''}
                                    <div class="flex gap-2 mt-3">
                                        <button onclick="openActionModal(${index})" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors">${hasAction ? 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡' : 'ğŸ“‹ Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡'}</button>
                                        <button onclick="printStudentReport(${index})" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm font-medium transition-colors">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<div class="col-span-full text-center py-8 text-gray-500"><div class="text-5xl mb-2">âœ…</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>'}
                    </div>
                </div>
            `;
        }

        function renderAddModal() {
            const v = state.newViolation;
            const isDisabled = !v.studentName.trim() || !v.grade || !v.section || !v.violationDetails || !v.actionTaken;

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target === this) closeAddForm()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl z-10">
                            <h2 class="text-2xl font-bold flex items-center gap-2">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø§Ù„ÙØ© Ø³Ù„ÙˆÙƒÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                            <p class="text-blue-100 text-sm mt-1">ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</p>
                        </div>
                        
                        <form onsubmit="event.preventDefault(); addViolation();" class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ <span class="text-red-500">*</span></label>
                                <input type="text" id="studentNameInput" value="${v.studentName}" oninput="state.newViolation.studentName = this.value; updateFieldBorder(this);" class="w-full px-4 py-3 border-2 ${v.studentName.trim() ? 'border-green-500' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„" required autocomplete="off">
                                <p class="text-xs text-gray-500 mt-1">Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ØµÙ <span class="text-red-500">*</span></label>
                                    <select id="gradeSelect" onchange="state.newViolation.grade = this.value; updateSelectBorder(this); updateButtonState();" required class="w-full px-4 py-3 border-2 ${v.grade ? 'border-green-500' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                                        ${config.grades.map(g => `<option value="${g}" ${v.grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø´Ø¹Ø¨Ø© <span class="text-red-500">*</span></label>
                                    <select id="sectionSelect" onchange="state.newViolation.section = this.value; updateSelectBorder(this); updateButtonState();" required class="w-full px-4 py-3 border-2 ${v.section ? 'border-green-500' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>
                                        ${config.sections.map(s => `<option value="${s}" ${v.section === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-3 gap-3">
                                    <button type="button" onclick="state.newViolation.violationType = 'first'; state.newViolation.violationDetails = ''; state.newViolation.actionTaken = ''; updateViolationTypeUI();" class="p-4 border-2 rounded-lg font-medium transition-all ${v.violationType === 'first' ? 'border-green-500 bg-green-50 text-green-800' : 'border-gray-300 hover:border-green-300'}">
                                        <div class="text-lg mb-1">Ø¯Ø±Ø¬Ø© Ø£ÙˆÙ„Ù‰</div>
                                        <div class="text-xs text-gray-600">(Ø¯Ø±Ø¬Ø© ÙˆØ§Ø­Ø¯Ø©)</div>
                                    </button>
                                    <button type="button" onclick="state.newViolation.violationType = 'second'; state.newViolation.violationDetails = ''; state.newViolation.actionTaken = ''; updateViolationTypeUI();" class="p-4 border-2 rounded-lg font-medium transition-all ${v.violationType === 'second' ? 'border-yellow-500 bg-yellow-50 text-yellow-800' : 'border-gray-300 hover:border-yellow-300'}">
                                        <div class="text-lg mb-1">Ø¯Ø±Ø¬Ø© Ø«Ø§Ù†ÙŠØ©</div>
                                        <div class="text-xs text-gray-600">(Ø¯Ø±Ø¬ØªÙŠÙ†)</div>
                                    </button>
                                    <button type="button" onclick="state.newViolation.violationType = 'third'; state.newViolation.violationDetails = ''; state.newViolation.actionTaken = ''; updateViolationTypeUI();" class="p-4 border-2 rounded-lg font-medium transition-all ${v.violationType === 'third' ? 'border-red-500 bg-red-50 text-red-800' : 'border-gray-300 hover:border-red-300'}">
                                        <div class="text-lg mb-1">Ø¯Ø±Ø¬Ø© Ø«Ø§Ù„Ø«Ø©</div>
                                        <div class="text-xs text-gray-600">(Ø«Ù„Ø§Ø« Ø¯Ø±Ø¬Ø§Øª)</div>
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© <span class="text-red-500">*</span></label>
                                <select id="violationTypeSelect" onchange="state.newViolation.violationDetails = this.value; updateSelectBorder(this); updateButtonState();" required class="w-full px-4 py-3 border-2 ${v.violationDetails ? 'border-green-500' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</option>
                                    ${config.violationTypes[v.violationType].items.map(item => `<option value="${item}" ${v.violationDetails === item ? 'selected' : ''}>${item}</option>`).join('')}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹ (Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…) <span class="text-red-500">*</span></label>
                                <select id="actionTakenSelect" onchange="state.newViolation.actionTaken = this.value; updateSelectBorder(this); updateButtonState();" required class="w-full px-4 py-3 border-2 ${v.actionTaken ? 'border-green-500' : 'border-gray-300'} rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹</option>
                                    ${v.violationType === 'first' ? config.violationTypes.first.procedures.map(proc => `<option value="${proc}" ${v.actionTaken === proc ? 'selected' : ''}>${proc}</option>`).join('') : '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø£ÙˆÙ„Ø§Ù‹</option>'}
                                </select>
                                <p class="text-xs text-red-600 mt-1">âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹ Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                                    <input type="date" value="${v.date}" onchange="state.newViolation.date = this.value;" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„ÙˆÙ‚Øª</label>
                                    <input type="time" value="${v.time}" onchange="state.newViolation.time = this.value;" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>id="missingFieldsWarning" style="display: ${isDisabled ? 'block' : 'none'};" class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                                <p class="text-sm text-yellow-900 font-bold">âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
                                <ul class="text-xs text-yellow-800 mt-2 mr-4 list-disc" id="missingFieldsList">
                                    ${!v.studentName.trim() ? '<li>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</li>' : ''}
                                    ${!v.grade ? '<li>Ø§Ù„ØµÙ</li>' : ''}
                                    ${!v.section ? '<li>Ø§Ù„Ø´Ø¹Ø¨Ø©</li>' : ''}
                                    ${!v.violationDetails ? '<li>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</li>' : ''}
                                    ${!v.actionTaken ? '<li>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹</li>' : ''}
                                </ul>
                            </div>
                        </form>

                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t rounded-b-xl flex gap-3 justify-end">
                            <button type="button" onclick="closeAddForm()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="button" id="saveViolationBtn" onclick="addViolation()" ${isDisabled ? 'disabled' : ''} class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-lg ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                                ${isDisabled ? 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©' : 'âœ” Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper functions for dynamic updates without full render
        window.updateFieldBorder = function(element) {
            if (element.value.trim()) {
                element.classList.remove('border-gray-300');
                element.classList.add('border-green-500');
            } else {
                element.classList.remove('border-green-500');
                element.classList.add('border-gray-300');
            }
            updateButtonState();
        };

        window.updateSelectBorder = function(element) {
            if (element.value) {
                element.classList.remove('border-gray-300');
                element.classList.add('border-green-500');
            } else {
                element.classList.remove('border-green-500');
                element.classList.add('border-gray-300');
            }
        };

        window.updateViolationTypeUI = function() {
            const violationSelect = document.getElementById('violationTypeSelect');
            const actionSelect = document.getElementById('actionTakenSelect');
            
            if (violationSelect) {
                const v = state.newViolation;
                violationSelect.innerHTML = `
                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</option>
                    ${config.violationTypes[v.violationType].items.map(item => `<option value="${item}">${item}</option>`).join('')}
                `;
                violationSelect.classList.remove('border-green-500');
                violationSelect.classList.add('border-gray-300');
            }
            
            if (actionSelect) {
                const v = state.newViolation;
                if (v.violationType === 'first') {
                    actionSelect.innerHTML = `
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹</option>
                        ${config.violationTypes.first.procedures.map(proc => `<option value="${proc}">${proc}</option>`).join('')}
                    `;
                } else {
                    actionSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø£ÙˆÙ„Ø§Ù‹</option>';
                }
                actionSelect.classList.remove('border-green-500');
                actionSelect.classList.add('border-gray-300');
            }
            
            updateButtonState();
        };

        window.updateButtonState = function() {
            const v = state.newViolation;
            const isDisabled = !v.studentName.trim() || !v.grade || !v.section || !v.violationDetails || !v.actionTaken;
            
            const saveBtn = document.getElementById('saveViolationBtn');
            const warningDiv = document.getElementById('missingFieldsWarning');
            const missingList = document.getElementById('missingFieldsList');
            
            if (saveBtn) {
                if (isDisabled) {
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    saveBtn.innerHTML = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
                } else {
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    saveBtn.innerHTML = 'âœ” Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©';
                }
            }
            
            if (warningDiv) {
                warningDiv.style.display = isDisabled ? 'block' : 'none';
            }
            
            if (missingList) {
                let missingFields = '';
                if (!v.studentName.trim()) missingFields += '<li>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</li>';
                if (!v.grade) missingFields += '<li>Ø§Ù„ØµÙ</li>';
                if (!v.section) missingFields += '<li>Ø§Ù„Ø´Ø¹Ø¨Ø©</li>';
                if (!v.violationDetails) missingFields += '<li>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</li>';
                if (!v.actionTaken) missingFields += '<li>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹</li>';
                missingList.innerHTML = missingFields;
            }
        };

        function renderDetailsModal() {
            const v = state.modals.selectedViolation;
            if (!v) return '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold flex items-center gap-2">ğŸ‘ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</h2>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="font-bold text-lg text-gray-900 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><span class="text-gray-600">Ø§Ù„Ø§Ø³Ù…:</span><span class="font-bold mr-2">${v.studentName}</span></div>
                                    <div><span class="text-gray-600">Ø§Ù„ØµÙ:</span><span class="font-bold mr-2">${v.grade}</span></div>
                                    <div><span class="text-gray-600">Ø§Ù„Ø´Ø¹Ø¨Ø©:</span><span class="font-bold mr-2">${v.section}</span></div>
                                    <div><span class="text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…:</span><span class="font-bold mr-2">${getStudentViolationCount(v.studentName, v.teacherId)}</span></div>
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="font-bold text-lg text-gray-900 mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="px-3 py-1 rounded-full text-xs font-bold ${getDegreeColor(v.violationType)}">${getDegreeLabel(v.violationType)}</span>
                                    </div>
                                    <div><span class="text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</span><p class="font-bold mt-1">${v.violationDetails}</p></div>
                                    ${v.actionTaken ? `<div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg"><span class="text-gray-600">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ¨Ø¹:</span><p class="mt-1 text-gray-800 font-semibold">${v.actionTaken}</p></div>` : ''}
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <h3 class="font-bold text-lg text-gray-900 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><span class="text-gray-600">Ø§Ù„Ù…Ø¹Ù„Ù…:</span><span class="font-bold mr-2">${v.teacherName}</span></div>
                                    <div><span class="text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span class="font-bold mr-2">${v.date}</span></div>
                                    <div><span class="text-gray-600">Ø§Ù„ÙˆÙ‚Øª:</span><span class="font-bold mr-2">${v.time}</span></div>
                                    <div><span class="text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</span><span class="font-bold mr-2 ${v.status === 'active' ? 'text-orange-600' : 'text-green-600'}">${v.status === 'active' ? 'Ù†Ø´Ø·Ø©' : 'Ù…Ø­Ù„ÙˆÙ„Ø©'}</span></div>
                                </div>
                            </div>

                            ${v.status === 'resolved' && v.resolutionReason ? `
                                <div class="bg-green-50 rounded-lg p-4 border-2 border-green-200">
                                    <h3 class="font-bold text-lg text-green-900 mb-3 flex items-center gap-2">ğŸ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ù„</h3>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="text-green-700">Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ:</span><p class="font-bold mt-1 text-green-900">${v.resolutionReason}</p></div>
                                        <div class="grid grid-cols-2 gap-3 mt-3">
                                            <div><span class="text-green-700">ØªÙ… Ø§Ù„Ø­Ù„ Ø¨ÙˆØ§Ø³Ø·Ø©:</span><span class="font-bold mr-2 text-green-900">${v.resolvedBy}</span></div>
                                            <div><span class="text-green-700">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ù„:</span><span class="font-bold mr-2 text-green-900">${new Date(v.resolvedAt).toLocaleDateString('ar-SA')}</span></div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t rounded-b-xl">
                            <button onclick="closeDetailsModal()" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderActionModal() {
            const student = state.modals.selectedStudent;
            if (!student) return '';

            const existingAction = state.studentActions.find(a => 
                a.studentName === student.name && a.teacherId === student.teacherId && a.actionBy === state.currentUser.role
            );

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target === this) closeActionModal()">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">
                            <h2 class="text-2xl font-bold flex items-center gap-2">ğŸ“‹ ${existingAction ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø§ØªØ®Ø§Ø°'} Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ - ${getRoleLabel(state.currentUser.role)}</h2>
                            <p class="text-blue-100 text-sm mt-1">Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name} | Ø§Ù„Ù…Ø¹Ù„Ù…: ${student.teacherName}</p>
                        </div>
                        
                        <div class="p-6">
                            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-6">
                                <h3 class="font-bold text-lg text-red-900 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                                    <div><span class="text-gray-600">Ø§Ù„Ø§Ø³Ù…:</span><span class="font-bold mr-2">${student.name}</span></div>
                                    <div><span class="text-gray-600">Ø§Ù„ØµÙ:</span><span class="font-bold mr-2">${student.grade}</span></div>
                                    <div><span class="text-gray-600">Ø§Ù„Ø´Ø¹Ø¨Ø©:</span><span class="font-bold mr-2">${student.section}</span></div>
                                    <div><span class="text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:</span><span class="font-bold mr-2 text-red-600">${student.count} Ù…Ø®Ø§Ù„ÙØ§Øª</span></div>
                                </div>
                                <div class="bg-yellow-100 border border-yellow-300 rounded p-2 text-sm"><strong>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø³Ø¬Ù„:</strong> ${student.teacherName}</div>
                            </div>

                            <div class="mb-6">
                                <h3 class="font-bold text-lg text-gray-900 mb-3">ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª:</h3>
                                <div class="space-y-3">
                                    ${student.violations.map((v, index) => `
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="flex-1">
                                                    <div class="font-bold text-gray-900 mb-1">${index + 1}. ${v.violationDetails}</div>
                                                    <div class="text-sm text-gray-600">ğŸ“… ${v.date} | ğŸ• ${v.time}</div>
                                                    ${v.actionTaken ? `<div class="text-sm text-gray-700 mt-2 bg-white p-2 rounded border border-gray-200"><strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</strong> ${v.actionTaken}</div>` : ''}
                                                </div>
                                                <span class="px-3 py-1 rounded-full text-xs font-bold ${getDegreeColor(v.violationType)} whitespace-nowrap mr-3">${getDegreeLabel(v.violationType)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-6">
                                <h3 class="font-bold text-lg text-blue-900 mb-3">ğŸ“‹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° Ù…Ù† Ù‚Ø¨Ù„ ${getRoleLabel(state.currentUser.role)}</h3>
                                <textarea id="actionDetailsInput" class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none" rows="6" placeholder="Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° (Ù…Ø«Ø§Ù„: ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± - ØªÙˆÙ‚ÙŠØ¹ ØªØ¹Ù‡Ø¯ - ØªÙˆØ¬ÙŠÙ‡ ÙˆØ¥Ø±Ø´Ø§Ø¯...)">${existingAction ? existingAction.actionDetails : ''}</textarea>
                                <p class="text-sm text-blue-700 mt-2">ğŸ’¡ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø° Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ ÙˆÙ…ÙØµÙ„</p>
                            </div>
                        </div>

                        <div class="sticky bottom-0 bg-gray-50 p-6 border-t rounded-b-xl flex gap-3 justify-end">
                            <button type="button" onclick="closeActionModal()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors font-medium">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="button" onclick="saveStudentAction()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-lg">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</button>
                            ${existingAction ? '<button type="button" onclick="printStudentReport(' + getStudentsByViolationCount().findIndex(s => s.name === student.name && s.teacherId === student.teacherId) + ')" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium shadow-lg">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // Initialize Application
        // ==========================================
        async function initApp() {
            if (!isFirebaseInitialized) {
                console.warn('âš ï¸ ØªØ­Ø°ÙŠØ±: Firebase ØºÙŠØ± Ù…ØªØµÙ„ - ÙŠØ¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„');
                render();
                return;
            }

            try {
                await loadViolations();
                await loadStudentActions();
                await loadNotificationsSent();
            } catch (error) {
                console.error('Error initializing app:', error);
                hideLoading();
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                render();
            }
        }

        // Don't auto-start - wait for Firebase
        // initApp() will be called from the setTimeout above
    </script>
</body>
</html>
