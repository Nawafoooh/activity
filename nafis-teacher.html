<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المعلم مع Firebase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border-radius: 10px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .firebase-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .firebase-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .firebase-status.connecting {
            background: #fff3cd;
            color: #856404;
        }

        .firebase-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        textarea {
            height: 80px;
            resize: vertical;
        }

        .options {
            border: 2px solid #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .option {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .option:hover {
            background: #e9ecef;
        }

        .option.correct {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .option input[type="text"] {
            flex: 1;
            border: 1px solid #ddd;
        }

        .option input[type="radio"] {
            width: auto;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .question-list {
            margin-top: 30px;
        }

        .question-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
            transition: transform 0.3s;
        }

        .question-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .question-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .subject-badge {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .question-options {
            margin: 15px 0;
        }

        .question-option {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            background: #ffffff;
        }

        .question-option.correct {
            background: #d4edda;
            font-weight: bold;
            border-left: 3px solid #28a745;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
            font-weight: bold;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .buttons {
            text-align: center;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .option {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="sync-indicator" id="syncIndicator">تم التحديث</div>
    
    <div class="container">
        <div class="header">
            <h1>لوحة تحكم المعلم</h1>
            <p>نظام إدارة الأسئلة مع قاعدة بيانات Firebase</p>
        </div>
        
        <!-- حالة Firebase -->
        <div id="firebaseStatus" class="firebase-status connecting">
            جاري الاتصال بقاعدة البيانات...
        </div>

        <!-- الإحصائيات -->
        <div class="stats">
            <div class="stat">
                <h3 id="dailyCount">0</h3>
                <p>أسئلة يومية</p>
            </div>
            <div class="stat">
                <h3 id="weeklyCount">0</h3>
                <p>أسئلة أسبوعية</p>
            </div>
            <div class="stat">
                <h3 id="totalCount">0</h3>
                <p>إجمالي الأسئلة</p>
            </div>
            <div class="stat" style="background: linear-gradient(135deg, #28a745, #20c997);">
                <h3 id="firebaseCount">0</h3>
                <p>محفوظ في Firebase</p>
            </div>
        </div>

        <!-- رسائل التأكيد -->
        <div id="message" class="message"></div>

        <!-- نموذج إضافة سؤال -->
        <div class="form-group">
            <label>المادة:</label>
            <select id="subject">
                <option value="">اختر المادة</option>
                <option value="رياضيات">رياضيات</option>
                <option value="قراءة">قراءة</option>
                <option value="علوم">علوم</option>
                <option value="لغة عربية">لغة عربية</option>
                <option value="تاريخ">تاريخ</option>
                <option value="جغرافيا">جغرافيا</option>
            </select>
        </div>

        <div class="form-group">
            <label>نوع الاختبار:</label>
            <select id="type">
                <option value="">اختر النوع</option>
                <option value="daily">سؤال اليوم</option>
                <option value="weekly">أسئلة الأسبوع</option>
            </select>
        </div>

        <div class="form-group">
            <label>نص السؤال:</label>
            <textarea id="question" placeholder="أدخل نص السؤال..."></textarea>
        </div>

        <div class="form-group">
            <label>خيارات الإجابة:</label>
            <div class="options">
                <div class="option">
                    <span>أ)</span>
                    <input type="text" id="option1" placeholder="الخيار الأول">
                    <input type="radio" name="correct" value="0">
                </div>
                <div class="option">
                    <span>ب)</span>
                    <input type="text" id="option2" placeholder="الخيار الثاني">
                    <input type="radio" name="correct" value="1">
                </div>
                <div class="option">
                    <span>ج)</span>
                    <input type="text" id="option3" placeholder="الخيار الثالث">
                    <input type="radio" name="correct" value="2">
                </div>
                <div class="option">
                    <span>د)</span>
                    <input type="text" id="option4" placeholder="الخيار الرابع">
                    <input type="radio" name="correct" value="3">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>تفسير الإجابة:</label>
            <textarea id="explanation" placeholder="اشرح لماذا هذه الإجابة صحيحة..."></textarea>
        </div>

        <div class="buttons">
            <button class="btn btn-success" onclick="addQuestion()" id="addBtn">إضافة السؤال</button>
            <button class="btn" onclick="clearForm()">مسح النموذج</button>
            <button class="btn btn-warning" onclick="exportData()">تصدير البيانات</button>
            <button class="btn" onclick="importData()">استيراد البيانات</button>
            <button class="btn" onclick="syncToLocal()">تزامن محلي</button>
        </div>

        <!-- قائمة الأسئلة -->
        <div class="question-list">
            <h2>الأسئلة المحفوظة في Firebase:</h2>
            <div id="questionsList" class="loading">جاري تحميل الأسئلة من قاعدة البيانات...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCaobeGSq0ra52WWNHIUgVZyoTg_NME5DY",
            authDomain: "nafis-exam.firebaseapp.com",
            projectId: "nafis-exam",
            storageBucket: "nafis-exam.firebasestorage.app",
            messagingSenderId: "985354903005",
            appId: "1:985354903005:web:d0d028d80d47bd30392a34",
            measurementId: "G-MME7J94SRN"
        };

        // تهيئة Firebase
        let app, db, questionsRef;
        let isFirebaseReady = false;
        let allQuestions = [];

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            questionsRef = collection(db, 'questions');
            
            updateFirebaseStatus('connected', 'متصل بقاعدة البيانات بنجاح ✅');
            isFirebaseReady = true;
            
            // الاستماع للتغييرات المباشرة
            onSnapshot(questionsRef, (snapshot) => {
                allQuestions = [];
                snapshot.forEach((doc) => {
                    allQuestions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateUI();
                syncToLocalStorage();
                showSyncIndicator();
                console.log('تم تحديث البيانات من Firebase:', allQuestions.length, 'سؤال');
            });
            
        } catch (error) {
            console.error('خطأ في Firebase:', error);
            updateFirebaseStatus('error', 'فشل في الاتصال بقاعدة البيانات ❌');
            isFirebaseReady = false;
        }

        // تحديث حالة Firebase
        function updateFirebaseStatus(status, message) {
            const statusDiv = document.getElementById('firebaseStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'firebase-status ' + status;
        }

        // تحديث الواجهة
        function updateUI() {
            const dailyQuestions = allQuestions.filter(q => q.type === 'daily');
            const weeklyQuestions = allQuestions.filter(q => q.type === 'weekly');
            
            document.getElementById('dailyCount').textContent = dailyQuestions.length;
            document.getElementById('weeklyCount').textContent = weeklyQuestions.length;
            document.getElementById('totalCount').textContent = allQuestions.length;
            document.getElementById('firebaseCount').textContent = allQuestions.length;
            
            showQuestions();
        }

        // عرض الأسئلة
        function showQuestions() {
            const container = document.getElementById('questionsList');
            
            if (allQuestions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">لا توجد أسئلة في قاعدة البيانات</p>';
                return;
            }
            
            // ترتيب الأسئلة حسب تاريخ الإنشاء
            const sortedQuestions = [...allQuestions].sort((a, b) => {
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            let html = '';
            for (let i = 0; i < sortedQuestions.length; i++) {
                const q = sortedQuestions[i];
                const typeName = q.type === 'daily' ? 'يومي' : 'أسبوعي';
                
                html += '<div class="question-item">';
                html += '<div class="question-header">';
                html += q.question;
                html += '<span class="subject-badge">' + q.subject + '</span>';
                html += '<span class="subject-badge" style="background: ' + (q.type === 'daily' ? '#28a745' : '#dc3545') + ';">' + typeName + '</span>';
                html += '</div>';
                
                html += '<div class="question-options">';
                for (let j = 0; j < q.options.length; j++) {
                    const optionClass = (j === q.correct) ? 'question-option correct' : 'question-option';
                    html += '<div class="' + optionClass + '">';
                    html += String.fromCharCode(65 + j) + ') ' + q.options[j];
                    html += '</div>';
                }
                html += '</div>';
                
                html += '<p><strong>التفسير:</strong> ' + q.explanation + '</p>';
                html += '<p><small>تاريخ الإضافة: ' + new Date(q.createdAt).toLocaleString('ar-SA') + '</small></p>';
                html += '<button class="btn btn-danger" onclick="deleteQuestion(\'' + q.id + '\')">حذف من Firebase</button>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        // إضافة سؤال إلى Firebase
        async function addQuestion() {
            if (!isFirebaseReady) {
                showMessage('قاعدة البيانات غير متاحة حالياً', 'error');
                return;
            }

            const subject = document.getElementById('subject').value;
            const type = document.getElementById('type').value;
            const question = document.getElementById('question').value;
            const explanation = document.getElementById('explanation').value;
            
            const option1 = document.getElementById('option1').value;
            const option2 = document.getElementById('option2').value;
            const option3 = document.getElementById('option3').value;
            const option4 = document.getElementById('option4').value;
            
            const correctRadio = document.querySelector('input[name="correct"]:checked');
            
            // التحقق من البيانات
            if (!subject || !type || !question || !explanation) {
                showMessage('يرجى تعبئة جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (!option1 || !option2 || !option3 || !option4) {
                showMessage('يرجى تعبئة جميع الخيارات', 'error');
                return;
            }
            
            if (!correctRadio) {
                showMessage('يرجى اختيار الإجابة الصحيحة', 'error');
                return;
            }

            // تعطيل الزر أثناء الحفظ
            const addBtn = document.getElementById('addBtn');
            addBtn.disabled = true;
            addBtn.textContent = 'جاري الحفظ...';
            
            try {
                // إنشاء السؤال
                const newQuestion = {
                    subject: subject,
                    question: question,
                    options: [option1, option2, option3, option4],
                    correct: parseInt(correctRadio.value),
                    explanation: explanation,
                    type: type,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // حفظ في Firebase
                await addDoc(questionsRef, newQuestion);
                
                clearForm();
                showMessage('تم إضافة السؤال إلى قاعدة البيانات بنجاح!', 'success');
                
            } catch (error) {
                console.error('خطأ في إضافة السؤال:', error);
                showMessage('حدث خطأ في حفظ السؤال: ' + error.message, 'error');
            } finally {
                // إعادة تفعيل الزر
                addBtn.disabled = false;
                addBtn.textContent = 'إضافة السؤال';
            }
        }

        // حذف سؤال من Firebase
        async function deleteQuestion(questionId) {
            if (!isFirebaseReady) {
                showMessage('قاعدة البيانات غير متاحة حالياً', 'error');
                return;
            }

            if (!confirm('هل تريد حذف هذا السؤال من قاعدة البيانات نهائياً؟')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'questions', questionId));
                showMessage('تم حذف السؤال من قاعدة البيانات', 'success');
            } catch (error) {
                console.error('خطأ في حذف السؤال:', error);
                showMessage('حدث خطأ في حذف السؤال: ' + error.message, 'error');
            }
        }

        // تزامن مع localStorage
        function syncToLocalStorage() {
            const dailyQuestions = allQuestions.filter(q => q.type === 'daily');
            const weeklyQuestions = allQuestions.filter(q => q.type === 'weekly');
            
            localStorage.setItem('adminDailyQuestions', JSON.stringify(dailyQuestions));
            localStorage.setItem('adminWeeklyQuestions', JSON.stringify(weeklyQuestions));
            localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(dailyQuestions));
            localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(weeklyQuestions));
            localStorage.setItem('nafisLastUpdate', Date.now().toString());
            
            // إرسال تحديث للطلاب
            try {
                const channel = new BroadcastChannel('nafis-teacher-updates');
                channel.postMessage({
                    type: 'QUESTIONS_UPDATED',
                    timestamp: Date.now(),
                    source: 'firebase'
                });
                channel.close();
            } catch (e) {
                console.log('BroadcastChannel غير متاح');
            }
        }

        // تزامن يدوي
        function syncToLocal() {
            syncToLocalStorage();
            showMessage('تم تزامن البيانات مع التخزين المحلي', 'success');
            showSyncIndicator();
        }

        // إظهار مؤشر التزامن
        function showSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // جعل الوظائف متاحة عالمياً
        window.addQuestion = addQuestion;
        window.deleteQuestion = deleteQuestion;
        window.syncToLocal = syncToLocal;
    </script>

    <script>
        // مسح النموذج
        function clearForm() {
            document.getElementById('subject').value = '';
            document.getElementById('type').value = '';
            document.getElementById('question').value = '';
            document.getElementById('explanation').value = '';
            document.getElementById('option1').value = '';
            document.getElementById('option2').value = '';
            document.getElementById('option3').value = '';
            document.getElementById('option4').value = '';
            
            const radios = document.querySelectorAll('input[name="correct"]');
            for (let i = 0; i < radios.length; i++) {
                radios[i].checked = false;
            }
            
            // إزالة تمييز الخيارات
            const options = document.querySelectorAll('.option');
            for (let i = 0; i < options.length; i++) {
                options[i].classList.remove('correct');
            }
        }

        // تصدير البيانات
        function exportData() {
            const data = {
                questions: window.allQuestions || [],
                exportDate: new Date().toLocaleString('ar-SA'),
                source: 'firebase',
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nafis-firebase-backup-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            
            URL.revokeObjectURL(url);
            showMessage('تم تصدير النسخة الاحتياطية من Firebase', 'success');
        }

        // استيراد البيانات
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        let imported = 0;
                        
                        // معالجة التنسيقات المختلفة
                        let questionsToImport = [];
                        
                        if (data.questions && Array.isArray(data.questions)) {
                            questionsToImport = data.questions;
                        } else if (data.nafes_exam && Array.isArray(data.nafes_exam)) {
                            questionsToImport = data.nafes_exam;
                        } else if (data.daily || data.weekly) {
                            if (data.daily) questionsToImport = questionsToImport.concat(data.daily);
                            if (data.weekly) questionsToImport = questionsToImport.concat(data.weekly);
                        }
                        
                        if (questionsToImport.length === 0) {
                            showMessage('لم يتم العثور على أسئلة صالحة في الملف', 'error');
                            return;
                        }
                        
                        // استيراد كل سؤال إلى Firebase
                        questionsToImport.forEach(async (q) => {
                            try {
                                const questionData = {
                                    subject: q.subject || 'عام',
                                    question: q.question || '',
                                    options: q.options || [],
                                    correct: q.correct !== undefined ? q.correct : 0,
                                    explanation: q.explanation || '',
                                    type: q.type || 'weekly',
                                    createdAt: new Date().toISOString(),
                                    lastModified: new Date().toISOString()
                                };
                                
                                // إضافة إلى Firebase إذا كان متاحاً
                                if (window.questionsRef) {
                                    await addDoc(window.questionsRef, questionData);
                                    imported++;
                                }
                            } catch (error) {
                                console.error('خطأ في استيراد سؤال:', error);
                            }
                        });
                        
                        setTimeout(() => {
                            showMessage('تم استيراد ' + questionsToImport.length + ' سؤال إلى Firebase', 'success');
                        }, 1000);
                        
                    } catch (error) {
                        showMessage('خطأ في قراءة الملف: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // عرض رسالة
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            setTimeout(function() {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // تمييز الإجابة الصحيحة
        document.addEventListener('change', function(e) {
            if (e.target.name === 'correct') {
                const options = document.querySelectorAll('.option');
                for (let i = 0; i < options.length; i++) {
                    options[i].classList.remove('correct');
                }
                
                const selectedOption = e.target.closest('.option');
                if (selectedOption) {
                    selectedOption.classList.add('correct');
                }
            }
        });

        // جعل الوظائف متاحة عالمياً
        window.clearForm = clearForm;
        window.exportData = exportData;
        window.importData = importData;
    </script>
</body>
</html>
