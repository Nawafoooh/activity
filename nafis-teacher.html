<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التزامن المحسن - نافس</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            direction: rtl;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        .sync-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .log-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }

        .log-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .log-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .log-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }

        .test-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .option-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-input input[type="radio"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">نظام التزامن المحسن - نافس</h1>

        <!-- أزرار التحكم -->
        <div class="sync-controls">
            <button class="btn btn-success" onclick="optimizedSync.initializeSystem()">تهيئة النظام</button>
            <button class="btn" onclick="optimizedSync.syncAllQuestions()">مزامنة جميع الأسئلة</button>
            <button class="btn btn-warning" onclick="optimizedSync.testConnection()">اختبار الاتصال</button>
            <button class="btn btn-danger" onclick="optimizedSync.clearAllData()">مسح البيانات</button>
            <button class="btn" onclick="optimizedSync.generateTestQuestions()">توليد أسئلة تجريبية</button>
            <button class="btn btn-success" onclick="optimizedSync.validateSync()">التحقق من التزامن</button>
        </div>

        <!-- معلومات الحالة -->
        <div class="status-grid">
            <div class="status-card">
                <h3>الأسئلة اليومية</h3>
                <div class="value" id="dailyCount">0</div>
            </div>
            <div class="status-card">
                <h3>الأسئلة الأسبوعية</h3>
                <div class="value" id="weeklyCount">0</div>
            </div>
            <div class="status-card">
                <h3>آخر مزامنة</h3>
                <div class="value" id="lastSync">لم تتم</div>
            </div>
            <div class="status-card">
                <h3>حالة الاتصال</h3>
                <div class="value" id="connectionStatus">فحص...</div>
            </div>
        </div>

        <!-- شريط التقدم -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <!-- نموذج إضافة سؤال سريع -->
        <div class="test-form">
            <h3>إضافة سؤال تجريبي</h3>
            <div class="form-group">
                <label>نص السؤال</label>
                <textarea id="quickQuestion" placeholder="أدخل نص السؤال" rows="3"></textarea>
            </div>
            <div class="options-grid">
                <div class="option-input">
                    <input type="radio" name="correctOption" value="0" id="opt0">
                    <input type="text" id="option0" placeholder="الخيار الأول">
                </div>
                <div class="option-input">
                    <input type="radio" name="correctOption" value="1" id="opt1">
                    <input type="text" id="option1" placeholder="الخيار الثاني">
                </div>
                <div class="option-input">
                    <input type="radio" name="correctOption" value="2" id="opt2">
                    <input type="text" id="option2" placeholder="الخيار الثالث">
                </div>
                <div class="option-input">
                    <input type="radio" name="correctOption" value="3" id="opt3">
                    <input type="text" id="option3" placeholder="الخيار الرابع">
                </div>
            </div>
            <div class="form-group">
                <label>نوع الاختبار</label>
                <select id="questionType">
                    <option value="daily">سؤال اليوم</option>
                    <option value="weekly">أسئلة الأسبوع</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="optimizedSync.addQuickQuestion()">إضافة السؤال</button>
        </div>

        <!-- سجل العمليات -->
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">مرحباً بك في نظام التزامن المحسن</div>
        </div>
    </div>

    <script>
        // نظام التزامن المحسن والثابت
        class OptimizedSyncSystem {
            constructor() {
                this.lastSyncTime = 0;
                this.syncInProgress = false;
                this.retryCount = 0;
                this.maxRetries = 3;
                this.syncDelay = 2000; // 2 ثانية بدلاً من كل ثانية
                this.broadcastChannel = null;
                this.questionsCache = {
                    daily: [],
                    weekly: []
                };
                
                this.initializeBroadcastChannel();
                this.loadExistingData();
                this.updateUI();
            }

            initializeBroadcastChannel() {
                try {
                    this.broadcastChannel = new BroadcastChannel('nafis-optimized-sync');
                    this.broadcastChannel.onmessage = (event) => this.handleMessage(event);
                    this.log('تم تفعيل BroadcastChannel بنجاح', 'success');
                } catch (error) {
                    this.log('تعذر تفعيل BroadcastChannel: ' + error.message, 'warning');
                }
            }

            initializeSystem() {
                this.log('🚀 بدء تهيئة النظام المحسن...', 'info');
                
                // مسح الرسائل المتكررة القديمة
                this.clearOldSyncMessages();
                
                // تحميل البيانات
                this.loadExistingData();
                
                // تحديث الواجهة
                this.updateUI();
                
                this.log('✅ تم تهيئة النظام بنجاح', 'success');
            }

            clearOldSyncMessages() {
                // مسح جميع المفاتيح المؤقتة والمتكررة
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('nafis-sync-') || key.includes('nafisUpdate_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                this.log(`🧹 تم مسح ${keysToRemove.length} مفتاح مؤقت قديم`, 'info');
            }

            loadExistingData() {
                try {
                    // تحميل الأسئلة من مفاتيح مختلفة
                    const dailyKeys = ['adminDailyQuestions', 'nafisMainDailyQuestions'];
                    const weeklyKeys = ['adminWeeklyQuestions', 'nafisMainWeeklyQuestions'];
                    
                    for (const key of dailyKeys) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                const questions = JSON.parse(data);
                                if (Array.isArray(questions) && questions.length > 0) {
                                    this.questionsCache.daily = questions;
                                    this.log(`📋 تم تحميل ${questions.length} سؤال يومي من ${key}`, 'success');
                                    break;
                                }
                            } catch (e) {
                                this.log(`خطأ في تحليل ${key}: ${e.message}`, 'error');
                            }
                        }
                    }
                    
                    for (const key of weeklyKeys) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                const questions = JSON.parse(data);
                                if (Array.isArray(questions) && questions.length > 0) {
                                    this.questionsCache.weekly = questions;
                                    this.log(`📋 تم تحميل ${questions.length} سؤال أسبوعي من ${key}`, 'success');
                                    break;
                                }
                            } catch (e) {
                                this.log(`خطأ في تحليل ${key}: ${e.message}`, 'error');
                            }
                        }
                    }
                    
                } catch (error) {
                    this.log('خطأ في تحميل البيانات: ' + error.message, 'error');
                }
            }

            async syncAllQuestions() {
                if (this.syncInProgress) {
                    this.log('⏳ المزامنة قيد التنفيذ بالفعل', 'warning');
                    return;
                }

                this.syncInProgress = true;
                this.showProgress(0, 'بدء المزامنة...');
                
                try {
                    // الخطوة 1: التحضير
                    this.showProgress(20, 'تحضير البيانات...');
                    await this.sleep(500);
                    
                    // الخطوة 2: مزامنة الأسئلة اليومية
                    if (this.questionsCache.daily.length > 0) {
                        this.showProgress(40, 'مزامنة الأسئلة اليومية...');
                        await this.syncQuestionType('daily', this.questionsCache.daily);
                    }
                    
                    // الخطوة 3: مزامنة الأسئلة الأسبوعية
                    if (this.questionsCache.weekly.length > 0) {
                        this.showProgress(70, 'مزامنة الأسئلة الأسبوعية...');
                        await this.syncQuestionType('weekly', this.questionsCache.weekly);
                    }
                    
                    // الخطوة 4: التحقق النهائي
                    this.showProgress(90, 'التحقق من النتائج...');
                    await this.sleep(500);
                    
                    this.showProgress(100, 'اكتملت المزامنة!');
                    
                    // تحديث الطابع الزمني
                    this.lastSyncTime = Date.now();
                    localStorage.setItem('nafisLastOptimizedSync', this.lastSyncTime.toString());
                    
                    this.log('✅ تمت المزامنة بنجاح لجميع الأسئلة', 'success');
                    
                    setTimeout(() => this.hideProgress(), 2000);
                    
                } catch (error) {
                    this.log('❌ خطأ في المزامنة: ' + error.message, 'error');
                    this.hideProgress();
                } finally {
                    this.syncInProgress = false;
                    this.updateUI();
                }
            }

            async syncQuestionType(type, questions) {
                try {
                    // حفظ في المفتاح الرئيسي للطلاب
                    const studentKey = type === 'daily' ? 'nafisMainDailyQuestions' : 'nafisMainWeeklyQuestions';
                    localStorage.setItem(studentKey, JSON.stringify(questions));
                    
                    // حفظ في المفتاح الإضافي
                    const backupKey = type === 'daily' ? 'nafisBackupDailyQuestions' : 'nafisBackupWeeklyQuestions';
                    localStorage.setItem(backupKey, JSON.stringify(questions));
                    
                    // تحديث المؤشرات
                    const timestamp = Date.now();
                    localStorage.setItem('nafisLastUpdate', timestamp.toString());
                    localStorage.setItem(`nafisLast${type}Update`, timestamp.toString());
                    localStorage.setItem('nafisQuestionCount', questions.length.toString());
                    
                    // إرسال رسالة واحدة فقط
                    if (this.broadcastChannel) {
                        const message = {
                            type: 'OPTIMIZED_SYNC',
                            questionType: type,
                            count: questions.length,
                            timestamp: timestamp,
                            source: 'optimized-teacher'
                        };
                        
                        this.broadcastChannel.postMessage(message);
                    }
                    
                    // رسالة PostMessage واحدة فقط
                    window.postMessage({
                        type: 'NAFIS_OPTIMIZED_UPDATE',
                        questionType: type,
                        count: questions.length,
                        timestamp: timestamp
                    }, '*');
                    
                    this.log(`📤 تم إرسال ${questions.length} سؤال من نوع ${type}`, 'success');
                    
                    await this.sleep(1000); // انتظار لضمان الوصول
                    
                } catch (error) {
                    throw new Error(`فشل في مزامنة ${type}: ${error.message}`);
                }
            }

            testConnection() {
                this.log('🔍 اختبار الاتصال...', 'info');
                
                // اختبار BroadcastChannel
                if (this.broadcastChannel) {
                    this.broadcastChannel.postMessage({
                        type: 'CONNECTION_TEST',
                        timestamp: Date.now()
                    });
                    this.log('✅ BroadcastChannel يعمل', 'success');
                } else {
                    this.log('❌ BroadcastChannel غير متاح', 'error');
                }
                
                // اختبار localStorage
                try {
                    localStorage.setItem('nafisConnectionTest', 'test');
                    localStorage.removeItem('nafisConnectionTest');
                    this.log('✅ localStorage يعمل', 'success');
                } catch (error) {
                    this.log('❌ localStorage لا يعمل: ' + error.message, 'error');
                }
                
                document.getElementById('connectionStatus').textContent = 'تم الاختبار';
            }

            validateSync() {
                this.log('🔍 التحقق من حالة التزامن...', 'info');
                
                let errors = 0;
                
                // فحص وجود الأسئلة
                const dailyKey = localStorage.getItem('nafisMainDailyQuestions');
                const weeklyKey = localStorage.getItem('nafisMainWeeklyQuestions');
                
                if (!dailyKey) {
                    this.log('⚠️ الأسئلة اليومية غير موجودة في مفتاح الطلاب', 'warning');
                    errors++;
                }
                
                if (!weeklyKey) {
                    this.log('⚠️ الأسئلة الأسبوعية غير موجودة في مفتاح الطلاب', 'warning');
                    errors++;
                }
                
                // فحص صحة البيانات
                if (dailyKey) {
                    try {
                        const dailyQuestions = JSON.parse(dailyKey);
                        this.log(`✅ تم العثور على ${dailyQuestions.length} سؤال يومي`, 'success');
                    } catch (e) {
                        this.log('❌ بيانات الأسئلة اليومية تالفة', 'error');
                        errors++;
                    }
                }
                
                if (weeklyKey) {
                    try {
                        const weeklyQuestions = JSON.parse(weeklyKey);
                        this.log(`✅ تم العثور على ${weeklyQuestions.length} سؤال أسبوعي`, 'success');
                    } catch (e) {
                        this.log('❌ بيانات الأسئلة الأسبوعية تالفة', 'error');
                        errors++;
                    }
                }
                
                if (errors === 0) {
                    this.log('🎉 التزامن يعمل بشكل صحيح!', 'success');
                } else {
                    this.log(`⚠️ تم العثور على ${errors} مشكلة في التزامن`, 'warning');
                }
            }

            generateTestQuestions() {
                this.log('📝 توليد أسئلة تجريبية...', 'info');
                
                const testQuestions = [];
                for (let i = 1; i <= 40; i++) {
                    testQuestions.push({
                        id: Date.now() + i,
                        subject: 'رياضيات',
                        question: `السؤال التجريبي رقم ${i}: ما ناتج ${i} + ${i + 10}؟`,
                        options: [
                            (i + i + 10).toString(),
                            (i + i + 11).toString(),
                            (i + i + 9).toString(),
                            (i + i + 12).toString()
                        ],
                        correct: 0,
                        explanation: `الإجابة الصحيحة هي ${i + i + 10}`,
                        type: 'weekly',
                        createdAt: new Date().toLocaleString('ar-SA')
                    });
                }
                
                // حفظ الأسئلة
                this.questionsCache.weekly = testQuestions;
                localStorage.setItem('adminWeeklyQuestions', JSON.stringify(testQuestions));
                
                this.log(`✅ تم توليد ${testQuestions.length} سؤال تجريبي`, 'success');
                this.updateUI();
            }

            addQuickQuestion() {
                const questionText = document.getElementById('quickQuestion').value.trim();
                const option0 = document.getElementById('option0').value.trim();
                const option1 = document.getElementById('option1').value.trim();
                const option2 = document.getElementById('option2').value.trim();
                const option3 = document.getElementById('option3').value.trim();
                const correctOption = document.querySelector('input[name="correctOption"]:checked');
                const questionType = document.getElementById('questionType').value;
                
                if (!questionText || !option0 || !option1 || !option2 || !option3 || !correctOption) {
                    this.log('❌ يرجى تعبئة جميع الحقول', 'error');
                    return;
                }
                
                const newQuestion = {
                    id: Date.now(),
                    subject: 'عام',
                    question: questionText,
                    options: [option0, option1, option2, option3],
                    correct: parseInt(correctOption.value),
                    explanation: 'تم إضافة السؤال بواسطة النموذج السريع',
                    type: questionType,
                    createdAt: new Date().toLocaleString('ar-SA')
                };
                
                // إضافة للذاكرة المؤقتة
                if (questionType === 'daily') {
                    this.questionsCache.daily.push(newQuestion);
                    localStorage.setItem('adminDailyQuestions', JSON.stringify(this.questionsCache.daily));
                } else {
                    this.questionsCache.weekly.push(newQuestion);
                    localStorage.setItem('adminWeeklyQuestions', JSON.stringify(this.questionsCache.weekly));
                }
                
                // مسح النموذج
                document.getElementById('quickQuestion').value = '';
                document.getElementById('option0').value = '';
                document.getElementById('option1').value = '';
                document.getElementById('option2').value = '';
                document.getElementById('option3').value = '';
                document.querySelector('input[name="correctOption"]:checked').checked = false;
                
                this.log(`✅ تم إضافة السؤال الجديد (${questionType})`, 'success');
                this.updateUI();
            }

            clearAllData() {
                if (!confirm('هل أنت متأكد من مسح جميع البيانات؟')) {
                    return;
                }
                
                this.log('🗑️ مسح جميع البيانات...', 'warning');
                
                // مسح البيانات من الذاكرة
                this.questionsCache.daily = [];
                this.questionsCache.weekly = [];
                
                // مسح من localStorage
                const keysToRemove = [
                    'adminDailyQuestions',
                    'adminWeeklyQuestions',
                    'nafisMainDailyQuestions',
                    'nafisMainWeeklyQuestions',
                    'nafisBackupDailyQuestions',
                    'nafisBackupWeeklyQuestions',
                    'nafisLastUpdate',
                    'nafisLastOptimizedSync'
                ];
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                this.log('✅ تم مسح جميع البيانات', 'success');
                this.updateUI();
            }

            handleMessage(event) {
                // استقبال الرسائل فقط، بدون إرسال متكرر
                this.log('📨 تم استقبال رسالة: ' + event.data.type, 'info');
            }

            updateUI() {
                document.getElementById('dailyCount').textContent = this.questionsCache.daily.length;
                document.getElementById('weeklyCount').textContent = this.questionsCache.weekly.length;
                
                const lastSync = this.lastSyncTime ? 
                    new Date(this.lastSyncTime).toLocaleTimeString('ar-SA') : 
                    'لم تتم';
                document.getElementById('lastSync').textContent = lastSync;
            }

            showProgress(percent, message) {
                const container = document.getElementById('progressContainer');
                const fill = document.getElementById('progressFill');
                
                container.style.display = 'block';
                fill.style.width = percent + '%';
                fill.textContent = message;
            }

            hideProgress() {
                document.getElementById('progressContainer').style.display = 'none';
            }

            log(message, type = 'info') {
                const container = document.getElementById('logContainer');
                const entry = document.createElement('div');
                
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${timestamp}] ${message}`;
                
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
                
                // الاحتفاظ بآخر 50 رسالة فقط
                const entries = container.children;
                if (entries.length > 50) {
                    container.removeChild(entries[0]);
                }
                
                console.log(`[Nafis Optimized] ${message}`);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // تفعيل النظام المحسن
        const optimizedSync = new OptimizedSyncSystem();
        
        // تحديث دوري للواجهة (كل 30 ثانية بدلاً من كل ثانية)
        setInterval(() => {
            optimizedSync.updateUI();
        }, 30000);

        // تحديث فوري عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            optimizedSync.log('🚀 نظام التزامن المحسن جاهز', 'success');
            optimizedSync.updateUI();
        });

        // إضافة معالج للـ storage events للاستجابة للتغييرات
        window.addEventListener('storage', function(event) {
            if (event.key && (event.key.includes('Questions') || event.key.includes('nafis'))) {
                optimizedSync.log('📥 تم اكتشاف تحديث في البيانات: ' + event.key, 'info');
                optimizedSync.loadExistingData();
                optimizedSync.updateUI();
            }
        });

        console.log('✅ نظام التزامن المحسن مُفعّل ومجهز');
        console.log('المميزات:');
        console.log('- منع الرسائل المتكررة');
        console.log('- مزامنة موثوقة للأسئلة');
        console.log('- واجهة تحكم شاملة');
        console.log('- نظام سجل محسن');
        console.log('- التحقق من صحة البيانات');
    </script>
</body>
</html>
