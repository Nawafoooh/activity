<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø­Ø³Ù† - Ù†Ø§ÙØ³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            direction: rtl;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        .sync-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .log-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }

        .log-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .log-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .log-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }

        .test-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .option-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-input input[type="radio"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø­Ø³Ù† - Ù†Ø§ÙØ³</h1>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="sync-controls">
            <button class="btn btn-success" onclick="optimizedSync.initializeSystem()">ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            <button class="btn" onclick="optimizedSync.syncAllQuestions()">Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
            <button class="btn btn-warning" onclick="optimizedSync.testConnection()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
            <button class="btn btn-danger" onclick="optimizedSync.clearAllData()">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn" onclick="optimizedSync.generateTestQuestions()">ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
            <button class="btn btn-success" onclick="optimizedSync.validateSync()">Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ù†</button>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© -->
        <div class="status-grid">
            <div class="status-card">
                <h3>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                <div class="value" id="dailyCount">0</div>
            </div>
            <div class="status-card">
                <h3>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h3>
                <div class="value" id="weeklyCount">0</div>
            </div>
            <div class="status-card">
                <h3>Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©</h3>
                <div class="value" id="lastSync">Ù„Ù… ØªØªÙ…</div>
            </div>
            <div class="status-card">
                <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</h3>
                <div class="value" id="connectionStatus">ÙØ­Øµ...</div>
            </div>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠØ¹ -->
        <div class="test-form">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ</h3>
            <div class="form-group">
                <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
                <textarea id="quickQuestion" placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" rows="3"></textarea>
            </div>
            <div class="options-grid">
                <div class="option-input">
                    <input type="radio" name="correctOption" value="0" id="opt0">
                    <input type="text" id="option0" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„">
                </div>
                <div class="option-input">
                    <input type="radio" name="correctOption" value="1" id="opt1">
                    <input type="text" id="option1" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
                </div>
                <div class="option-input">
                    <input type="radio" name="correctOption" value="2" id="opt2">
                    <input type="text" id="option2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«">
                </div>
                <div class="option-input">
                    <input type="radio" name="correctOption" value="3" id="opt3">
                    <input type="text" id="option3" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹">
                </div>
            </div>
            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                <select id="questionType">
                    <option value="daily">Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</option>
                    <option value="weekly">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="optimizedSync.addQuickQuestion()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„</button>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø­Ø³Ù†</div>
        </div>
    </div>

    <script>
        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø­Ø³Ù† ÙˆØ§Ù„Ø«Ø§Ø¨Øª
        class OptimizedSyncSystem {
            constructor() {
                this.lastSyncTime = 0;
                this.syncInProgress = false;
                this.retryCount = 0;
                this.maxRetries = 3;
                this.syncDelay = 2000; // 2 Ø«Ø§Ù†ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
                this.broadcastChannel = null;
                this.questionsCache = {
                    daily: [],
                    weekly: []
                };
                
                this.initializeBroadcastChannel();
                this.loadExistingData();
                this.updateUI();
            }

            initializeBroadcastChannel() {
                try {
                    this.broadcastChannel = new BroadcastChannel('nafis-optimized-sync');
                    this.broadcastChannel.onmessage = (event) => this.handleMessage(event);
                    this.log('ØªÙ… ØªÙØ¹ÙŠÙ„ BroadcastChannel Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch (error) {
                    this.log('ØªØ¹Ø°Ø± ØªÙØ¹ÙŠÙ„ BroadcastChannel: ' + error.message, 'warning');
                }
            }

            initializeSystem() {
                this.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†...', 'info');
                
                // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                this.clearOldSyncMessages();
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                this.loadExistingData();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                this.updateUI();
                
                this.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }

            clearOldSyncMessages() {
                // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆØ§Ù„Ù…ØªÙƒØ±Ø±Ø©
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('nafis-sync-') || key.includes('nafisUpdate_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                this.log(`ğŸ§¹ ØªÙ… Ù…Ø³Ø­ ${keysToRemove.length} Ù…ÙØªØ§Ø­ Ù…Ø¤Ù‚Øª Ù‚Ø¯ÙŠÙ…`, 'info');
            }

            loadExistingData() {
                try {
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ù…ÙØ§ØªÙŠØ­ Ù…Ø®ØªÙ„ÙØ©
                    const dailyKeys = ['adminDailyQuestions', 'nafisMainDailyQuestions'];
                    const weeklyKeys = ['adminWeeklyQuestions', 'nafisMainWeeklyQuestions'];
                    
                    for (const key of dailyKeys) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                const questions = JSON.parse(data);
                                if (Array.isArray(questions) && questions.length > 0) {
                                    this.questionsCache.daily = questions;
                                    this.log(`ğŸ“‹ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${questions.length} Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ Ù…Ù† ${key}`, 'success');
                                    break;
                                }
                            } catch (e) {
                                this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ${key}: ${e.message}`, 'error');
                            }
                        }
                    }
                    
                    for (const key of weeklyKeys) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                const questions = JSON.parse(data);
                                if (Array.isArray(questions) && questions.length > 0) {
                                    this.questionsCache.weekly = questions;
                                    this.log(`ğŸ“‹ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${questions.length} Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù…Ù† ${key}`, 'success');
                                    break;
                                }
                            } catch (e) {
                                this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ${key}: ${e.message}`, 'error');
                            }
                        }
                    }
                    
                } catch (error) {
                    this.log('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
                }
            }

            async syncAllQuestions() {
                if (this.syncInProgress) {
                    this.log('â³ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø§Ù„ÙØ¹Ù„', 'warning');
                    return;
                }

                this.syncInProgress = true;
                this.showProgress(0, 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
                
                try {
                    // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„ØªØ­Ø¶ÙŠØ±
                    this.showProgress(20, 'ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                    await this.sleep(500);
                    
                    // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                    if (this.questionsCache.daily.length > 0) {
                        this.showProgress(40, 'Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©...');
                        await this.syncQuestionType('daily', this.questionsCache.daily);
                    }
                    
                    // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                    if (this.questionsCache.weekly.length > 0) {
                        this.showProgress(70, 'Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©...');
                        await this.syncQuestionType('weekly', this.questionsCache.weekly);
                    }
                    
                    // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                    this.showProgress(90, 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬...');
                    await this.sleep(500);
                    
                    this.showProgress(100, 'Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©!');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
                    this.lastSyncTime = Date.now();
                    localStorage.setItem('nafisLastOptimizedSync', this.lastSyncTime.toString());
                    
                    this.log('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'success');
                    
                    setTimeout(() => this.hideProgress(), 2000);
                    
                } catch (error) {
                    this.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message, 'error');
                    this.hideProgress();
                } finally {
                    this.syncInProgress = false;
                    this.updateUI();
                }
            }

            async syncQuestionType(type, questions) {
                try {
                    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨
                    const studentKey = type === 'daily' ? 'nafisMainDailyQuestions' : 'nafisMainWeeklyQuestions';
                    localStorage.setItem(studentKey, JSON.stringify(questions));
                    
                    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
                    const backupKey = type === 'daily' ? 'nafisBackupDailyQuestions' : 'nafisBackupWeeklyQuestions';
                    localStorage.setItem(backupKey, JSON.stringify(questions));
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
                    const timestamp = Date.now();
                    localStorage.setItem('nafisLastUpdate', timestamp.toString());
                    localStorage.setItem(`nafisLast${type}Update`, timestamp.toString());
                    localStorage.setItem('nafisQuestionCount', questions.length.toString());
                    
                    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                    if (this.broadcastChannel) {
                        const message = {
                            type: 'OPTIMIZED_SYNC',
                            questionType: type,
                            count: questions.length,
                            timestamp: timestamp,
                            source: 'optimized-teacher'
                        };
                        
                        this.broadcastChannel.postMessage(message);
                    }
                    
                    // Ø±Ø³Ø§Ù„Ø© PostMessage ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                    window.postMessage({
                        type: 'NAFIS_OPTIMIZED_UPDATE',
                        questionType: type,
                        count: questions.length,
                        timestamp: timestamp
                    }, '*');
                    
                    this.log(`ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${questions.length} Ø³Ø¤Ø§Ù„ Ù…Ù† Ù†ÙˆØ¹ ${type}`, 'success');
                    
                    await this.sleep(1000); // Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„
                    
                } catch (error) {
                    throw new Error(`ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© ${type}: ${error.message}`);
                }
            }

            testConnection() {
                this.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...', 'info');
                
                // Ø§Ø®ØªØ¨Ø§Ø± BroadcastChannel
                if (this.broadcastChannel) {
                    this.broadcastChannel.postMessage({
                        type: 'CONNECTION_TEST',
                        timestamp: Date.now()
                    });
                    this.log('âœ… BroadcastChannel ÙŠØ¹Ù…Ù„', 'success');
                } else {
                    this.log('âŒ BroadcastChannel ØºÙŠØ± Ù…ØªØ§Ø­', 'error');
                }
                
                // Ø§Ø®ØªØ¨Ø§Ø± localStorage
                try {
                    localStorage.setItem('nafisConnectionTest', 'test');
                    localStorage.removeItem('nafisConnectionTest');
                    this.log('âœ… localStorage ÙŠØ¹Ù…Ù„', 'success');
                } catch (error) {
                    this.log('âŒ localStorage Ù„Ø§ ÙŠØ¹Ù…Ù„: ' + error.message, 'error');
                }
                
                document.getElementById('connectionStatus').textContent = 'ØªÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
            }

            validateSync() {
                this.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†...', 'info');
                
                let errors = 0;
                
                // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                const dailyKey = localStorage.getItem('nafisMainDailyQuestions');
                const weeklyKey = localStorage.getItem('nafisMainWeeklyQuestions');
                
                if (!dailyKey) {
                    this.log('âš ï¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„Ø·Ù„Ø§Ø¨', 'warning');
                    errors++;
                }
                
                if (!weeklyKey) {
                    this.log('âš ï¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„Ø·Ù„Ø§Ø¨', 'warning');
                    errors++;
                }
                
                // ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (dailyKey) {
                    try {
                        const dailyQuestions = JSON.parse(dailyKey);
                        this.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${dailyQuestions.length} Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ`, 'success');
                    } catch (e) {
                        this.log('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ØªØ§Ù„ÙØ©', 'error');
                        errors++;
                    }
                }
                
                if (weeklyKey) {
                    try {
                        const weeklyQuestions = JSON.parse(weeklyKey);
                        this.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${weeklyQuestions.length} Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ`, 'success');
                    } catch (e) {
                        this.log('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ØªØ§Ù„ÙØ©', 'error');
                        errors++;
                    }
                }
                
                if (errors === 0) {
                    this.log('ğŸ‰ Ø§Ù„ØªØ²Ø§Ù…Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!', 'success');
                } else {
                    this.log(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${errors} Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ²Ø§Ù…Ù†`, 'warning');
                }
            }

            generateTestQuestions() {
                this.log('ğŸ“ ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©...', 'info');
                
                const testQuestions = [];
                for (let i = 1; i <= 40; i++) {
                    testQuestions.push({
                        id: Date.now() + i,
                        subject: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
                        question: `Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… ${i}: Ù…Ø§ Ù†Ø§ØªØ¬ ${i} + ${i + 10}ØŸ`,
                        options: [
                            (i + i + 10).toString(),
                            (i + i + 11).toString(),
                            (i + i + 9).toString(),
                            (i + i + 12).toString()
                        ],
                        correct: 0,
                        explanation: `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ ${i + i + 10}`,
                        type: 'weekly',
                        createdAt: new Date().toLocaleString('ar-SA')
                    });
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                this.questionsCache.weekly = testQuestions;
                localStorage.setItem('adminWeeklyQuestions', JSON.stringify(testQuestions));
                
                this.log(`âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${testQuestions.length} Ø³Ø¤Ø§Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ`, 'success');
                this.updateUI();
            }

            addQuickQuestion() {
                const questionText = document.getElementById('quickQuestion').value.trim();
                const option0 = document.getElementById('option0').value.trim();
                const option1 = document.getElementById('option1').value.trim();
                const option2 = document.getElementById('option2').value.trim();
                const option3 = document.getElementById('option3').value.trim();
                const correctOption = document.querySelector('input[name="correctOption"]:checked');
                const questionType = document.getElementById('questionType').value;
                
                if (!questionText || !option0 || !option1 || !option2 || !option3 || !correctOption) {
                    this.log('âŒ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
                    return;
                }
                
                const newQuestion = {
                    id: Date.now(),
                    subject: 'Ø¹Ø§Ù…',
                    question: questionText,
                    options: [option0, option1, option2, option3],
                    correct: parseInt(correctOption.value),
                    explanation: 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ø±ÙŠØ¹',
                    type: questionType,
                    createdAt: new Date().toLocaleString('ar-SA')
                };
                
                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                if (questionType === 'daily') {
                    this.questionsCache.daily.push(newQuestion);
                    localStorage.setItem('adminDailyQuestions', JSON.stringify(this.questionsCache.daily));
                } else {
                    this.questionsCache.weekly.push(newQuestion);
                    localStorage.setItem('adminWeeklyQuestions', JSON.stringify(this.questionsCache.weekly));
                }
                
                // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById('quickQuestion').value = '';
                document.getElementById('option0').value = '';
                document.getElementById('option1').value = '';
                document.getElementById('option2').value = '';
                document.getElementById('option3').value = '';
                document.querySelector('input[name="correctOption"]:checked').checked = false;
                
                this.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (${questionType})`, 'success');
                this.updateUI();
            }

            clearAllData() {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                    return;
                }
                
                this.log('ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'warning');
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                this.questionsCache.daily = [];
                this.questionsCache.weekly = [];
                
                // Ù…Ø³Ø­ Ù…Ù† localStorage
                const keysToRemove = [
                    'adminDailyQuestions',
                    'adminWeeklyQuestions',
                    'nafisMainDailyQuestions',
                    'nafisMainWeeklyQuestions',
                    'nafisBackupDailyQuestions',
                    'nafisBackupWeeklyQuestions',
                    'nafisLastUpdate',
                    'nafisLastOptimizedSync'
                ];
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                this.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
                this.updateUI();
            }

            handleMessage(event) {
                // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø¥Ø±Ø³Ø§Ù„ Ù…ØªÙƒØ±Ø±
                this.log('ğŸ“¨ ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ù„Ø©: ' + event.data.type, 'info');
            }

            updateUI() {
                document.getElementById('dailyCount').textContent = this.questionsCache.daily.length;
                document.getElementById('weeklyCount').textContent = this.questionsCache.weekly.length;
                
                const lastSync = this.lastSyncTime ? 
                    new Date(this.lastSyncTime).toLocaleTimeString('ar-SA') : 
                    'Ù„Ù… ØªØªÙ…';
                document.getElementById('lastSync').textContent = lastSync;
            }

            showProgress(percent, message) {
                const container = document.getElementById('progressContainer');
                const fill = document.getElementById('progressFill');
                
                container.style.display = 'block';
                fill.style.width = percent + '%';
                fill.textContent = message;
            }

            hideProgress() {
                document.getElementById('progressContainer').style.display = 'none';
            }

            log(message, type = 'info') {
                const container = document.getElementById('logContainer');
                const entry = document.createElement('div');
                
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${timestamp}] ${message}`;
                
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
                
                // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 50 Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·
                const entries = container.children;
                if (entries.length > 50) {
                    container.removeChild(entries[0]);
                }
                
                console.log(`[Nafis Optimized] ${message}`);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†
        const optimizedSync = new OptimizedSyncSystem();
        
        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© (ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©)
        setInterval(() => {
            optimizedSync.updateUI();
        }, 30000);

        // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            optimizedSync.log('ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø­Ø³Ù† Ø¬Ø§Ù‡Ø²', 'success');
            optimizedSync.updateUI();
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ù€ storage events Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª
        window.addEventListener('storage', function(event) {
            if (event.key && (event.key.includes('Questions') || event.key.includes('nafis'))) {
                optimizedSync.log('ğŸ“¥ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + event.key, 'info');
                optimizedSync.loadExistingData();
                optimizedSync.updateUI();
            }
        });

        console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø­Ø³Ù† Ù…ÙÙØ¹Ù‘Ù„ ÙˆÙ…Ø¬Ù‡Ø²');
        console.log('Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:');
        console.log('- Ù…Ù†Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©');
        console.log('- Ù…Ø²Ø§Ù…Ù†Ø© Ù…ÙˆØ«ÙˆÙ‚Ø© Ù„Ù„Ø£Ø³Ø¦Ù„Ø©');
        console.log('- ÙˆØ§Ø¬Ù‡Ø© ØªØ­ÙƒÙ… Ø´Ø§Ù…Ù„Ø©');
        console.log('- Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„ Ù…Ø­Ø³Ù†');
        console.log('- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    </script>
</body>
</html>
