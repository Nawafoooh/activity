<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <style>
        :root {
            --primary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 20px;
            color: var(--primary);
        }

        .container {
            max-width: 1250px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .stats-panel {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #eee;
        }

        .equity-indicator {
            font-weight: bold;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 1.1em;
        }

        .equity-green { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }
        .equity-yellow { background: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; }
        .equity-red { background: #ffebee; color: #c62828; border: 1px solid #c62828; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 12px 8px;
            text-align: center;
        }

        th { background-color: var(--primary); color: white; font-weight: 500; }

        .form-group {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: #fff;
            border: 1px dashed #ccc;
            border-radius: 8px;
        }

        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex: 1; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; background: var(--primary); color: white; font-weight: bold; }
        .reset-btn { background: var(--danger); }

        .progress-container {
            width: 100%;
            background-color: #eee;
            border-radius: 10px;
            height: 12px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-bar { height: 100%; transition: width 0.4s ease; }
        .status-low { background-color: var(--success); }
        .status-mid { background-color: var(--warning); }
        .status-high { background-color: var(--danger); }

        .alert-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            display: none;
            z-index: 9999;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-weight: bold;
        }

        select {
            width: 95%;
            padding: 5px;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #fdfdfd;
        }

        @media print {
            .no-print, .form-group, button { display: none !important; }
            body { background: white; margin: 0; }
            .container { box-shadow: none; max-width: 100%; border: none; }
        }
    </style>
</head>
<body>

<div id="alert" class="alert-box"></div>

<div class="container">
    <h1 style="margin-top:0">Ø¥Ø¯Ø§Ø±Ø© Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± - Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø¹Ø¯Ø§Ù„Ø©</h1>

    <div class="stats-panel no-print">
        <div>Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…: <span id="equityLabel" class="equity-indicator">--</span></div>
        <div>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ: <b id="avgConsumption">0%</b></div>
    </div>

    <div class="form-group no-print">
        <input type="text" id="tName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
        <input type="number" id="tLessons" placeholder="Ø§Ù„Ù†ØµØ§Ø¨ (Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ)">
        <button onclick="addTeacher()">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù… Ù„Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©</button>
        <button class="reset-btn" onclick="resetWeekly()">Ø¨Ø¯Ø¡ Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
        <button onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>

    <h2>Ø³Ø¬Ù„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
    <table id="teacherTable">
        <thead>
            <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ù†ØµØ§Ø¨</th>
                <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø±</th>
                <th>Ø§Ù„Ù…Ø³Ù†Ø¯ (ÙØ¹Ù„ÙŠ)</th>
                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø§Ù„Ø±ØµÙŠØ¯)</th>
                <th style="width: 25%;">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</th>
            </tr>
        </thead>
        <tbody id="teacherBody"></tbody>
    </table>

    <h2>Ø¬Ø¯ÙˆÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h2>
    <table id="scheduleTable">
        <thead>
            <tr>
                <th style="width: 100px;">Ø§Ù„ÙŠÙˆÙ…</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>
</div>

<script>
    let teachers = JSON.parse(localStorage.getItem('edu_teachers')) || [];
    let schedule = JSON.parse(localStorage.getItem('edu_schedule')) || {};
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³'];

    function getAutoLimit(n) {
        if (n >= 24) return 0;
        if (n >= 20) return 0;
        if (n >= 18) return 2;
        if (n >= 16) return 4;
        if (n >= 15) return 5;
        if (n <= 10) return 10;
        // Ø§Ù„Ù†ØµØ§Ø¨ Ø¨ÙŠÙ† 11 Ùˆ 14 (Ø§Ø³ØªÙ†ØªØ§Ø¬ Ù…Ù†Ø·Ù‚ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ¯Ø±Ø¬Ùƒ)
        if (n < 15) return 8; 
        return 0;
    }

    function showAlert(msg, type = 'danger') {
        const box = document.getElementById('alert');
        box.textContent = msg;
        box.style.backgroundColor = type === 'danger' ? '#e74c3c' : '#f39c12';
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 5000);
    }

    function addTeacher() {
        const name = document.getElementById('tName').value;
        const lessons = parseInt(document.getElementById('tLessons').value);
        if (!name || isNaN(lessons)) return;

        teachers.push({
            id: 'T' + Date.now(),
            name: name,
            lessons: lessons,
            max: getAutoLimit(lessons),
            assigned: 0
        });
        save();
        document.getElementById('tName').value = '';
        document.getElementById('tLessons').value = '';
    }

    function validateAssignment(teacherId, day, lesson) {
        if (!teacherId) return true;
        const t = teachers.find(x => x.id === teacherId);

        // 1. Ù‚ÙŠØ¯ Ø§Ù„Ù€ 100%
        if (t.assigned >= t.max) {
            showAlert(`Ø¹Ø°Ø±Ø§Ù‹! Ø§Ù„Ù…Ø¹Ù„Ù… ${t.name} Ø§Ø³ØªÙ‡Ù„Ùƒ ÙƒØ§Ù…Ù„ Ø±ØµÙŠØ¯Ù‡ Ø§Ù„Ù…ØªØ§Ø­ (${t.max} Ø­ØµØµ)`);
            return false;
        }

        // 2. Ù‚ÙŠØ¯: Ù„Ø§ ÙŠØ³Ù†Ø¯ Ø£ÙƒØ«Ø± Ù…Ù† Ø­ØµØ© ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ§Ø­Ø¯
        let dailyCount = 0;
        for (let l = 1; l <= 7; l++) {
            if (schedule[`${day}-${l}`] === teacherId) dailyCount++;
        }
        if (dailyCount >= 1) {
            showAlert(`Ù…Ø®Ø§Ù„ÙØ©: Ø§Ù„Ù…Ø¹Ù„Ù… ${t.name} Ù…Ø³Ù†Ø¯ Ù„Ù‡ Ø­ØµØ© Ø§Ù†ØªØ¸Ø§Ø± Ø£Ø®Ø±Ù‰ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…!`);
            return false;
        }

        // 3. Ù‚ÙŠØ¯: Ù„Ø§ ÙŠØ³Ù†Ø¯ Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø­ØµØµ ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø£Ø®ÙŠØ±)
        if (t.assigned >= 5) {
            showAlert(`ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ø¹Ù„Ù… ${t.name} ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (5 Ø­ØµØµ)`);
            return false;
        }

        // ØªØ­Ø°ÙŠØ±Ø§Øª (Ø¨Ø¯ÙˆÙ† Ù…Ù†Ø¹)
        if (lesson == 1 || lesson == 7) {
            const opp = (lesson == 1) ? 7 : 1;
            if (schedule[`${day}-${opp}`] === teacherId) showAlert(`ØªÙ†Ø¨ÙŠÙ‡: ${t.name} Ù„Ø¯ÙŠÙ‡ Ø£ÙˆÙ„ ÙˆØ¢Ø®Ø± Ø­ØµØ© Ø§Ù„ÙŠÙˆÙ…!`, 'warning');
        }

        return true;
    }

    function updateCell(day, lesson, teacherId) {
        if (teacherId !== "" && !validateAssignment(teacherId, day, lesson)) {
            render(); 
            return;
        }
        schedule[`${day}-${lesson}`] = teacherId;
        sync();
        save();
    }

    function sync() {
        teachers.forEach(t => t.assigned = 0);
        Object.values(schedule).forEach(id => {
            if (id) {
                const t = teachers.find(x => x.id === id);
                if (t) t.assigned++;
            }
        });
    }

    function save() {
        localStorage.setItem('edu_teachers', JSON.stringify(teachers));
        localStorage.setItem('edu_schedule', JSON.stringify(schedule));
        render();
    }

    function render() {
        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
        const tBody = document.getElementById('teacherBody');
        tBody.innerHTML = '';
        teachers.forEach(t => {
            const ratio = t.max > 0 ? (t.assigned / t.max) * 100 : 0;
            const barColor = ratio <= 40 ? 'status-low' : (ratio <= 70 ? 'status-mid' : 'status-high');
            tBody.innerHTML += `
                <tr>
                    <td><b>${t.name}</b></td>
                    <td>${t.lessons}</td>
                    <td>${t.max}</td>
                    <td>${t.assigned}</td>
                    <td style="color:${t.max - t.assigned <= 1 ? 'red' : 'green'}; font-weight:bold">${t.max - t.assigned}</td>
                    <td>
                        <small>${ratio.toFixed(1)}%</small>
                        <div class="progress-container"><div class="progress-bar ${barColor}" style="width:${Math.min(ratio, 100)}%"></div></div>
                    </td>
                </tr>`;
        });

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ
        const sBody = document.getElementById('scheduleBody');
        sBody.innerHTML = '';
        days.forEach(day => {
            let row = `<tr><td style="background:#f8f9fa"><b>${day}</b></td>`;
            for (let i = 1; i <= 7; i++) {
                const currentId = schedule[`${day}-${i}`] || "";
                let options = `<option value="">-- ØªÙØ±ÙŠØº --</option>`;
                teachers.forEach(t => {
                    if (t.max > 0) {
                        options += `<option value="${t.id}" ${t.id === currentId ? 'selected' : ''}>${t.name}</option>`;
                    }
                });
                row += `<td><select onchange="updateCell('${day}', ${i}, this.value)">${options}</select></td>`;
            }
            row += `</tr>`;
            sBody.innerHTML += row;
        });

        updateEquityUI();
    }

    function updateEquityUI() {
        const active = teachers.filter(t => t.max > 0);
        if (active.length === 0) return;

        const ratios = active.map(t => (t.assigned / t.max) * 100);
        const avg = ratios.reduce((a, b) => a + b, 0) / ratios.length;
        const diff = Math.max(...ratios) - Math.min(...ratios);

        const lbl = document.getElementById('equityLabel');
        document.getElementById('avgConsumption').textContent = avg.toFixed(1) + '%';

        if (diff <= 15) { lbl.textContent = 'ğŸŸ¢ Ø¹Ø§Ø¯Ù„ Ø¬Ø¯Ø§Ù‹'; lbl.className = 'equity-indicator equity-green'; }
        else if (diff <= 30) { lbl.textContent = 'ğŸŸ¡ Ù…Ù‚Ø¨ÙˆÙ„'; lbl.className = 'equity-indicator equity-yellow'; }
        else { lbl.textContent = 'ğŸ”´ ØºÙŠØ± Ø¹Ø§Ø¯Ù„'; lbl.className = 'equity-indicator equity-red'; }
    }

    function resetWeekly() {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ø¨Ø£Ø³Ø¨ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ØŸ (Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†)')) {
            schedule = {};
            sync();
            save();
        }
    }

    render();
</script>
</body>
</html>
