<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root {
            --primary: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 20px;
            color: var(--primary);
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        h1, h2 {
            text-align: center;
            color: var(--primary);
            border-bottom: 2px solid var(--light);
            padding-bottom: 10px;
        }

        .stats-panel {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .equity-indicator {
            font-weight: bold;
            font-size: 1.1em;
            padding: 6px 16px;
            border-radius: 20px;
        }

        .equity-green { background: #d4edda; color: #155724; }
        .equity-yellow { background: #fff3cd; color: #856404; }
        .equity-red { background: #f8d7da; color: #721c24; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            overflow: hidden;
        }

        th { background-color: var(--primary); color: white; }

        .form-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }

        input, select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            padding: 8px 15px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: var(--primary);
            color: white;
        }

        .reset-btn { background: var(--danger); }

        .progress-container {
            width: 100%;
            background-color: #eee;
            border-radius: 10px;
            height: 10px;
            margin-top: 5px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }

        .status-low { background-color: var(--success); }
        .status-mid { background-color: var(--warning); }
        .status-high { background-color: var(--danger); }

        .alert-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-align: center;
        }

        .waiting-cell select {
            width: 100%;
            border: 1px solid transparent;
            background: #fff;
            cursor: pointer;
        }

        @media print {
            .no-print, .form-group, button { display: none !important; }
            body { margin: 0; background: white; }
            .container { box-shadow: none; width: 100%; }
        }
    </style>
</head>
<body>

<div id="alert" class="alert-box"></div>

<div class="container">
    <h1>ØªÙˆØ²ÙŠØ¹ Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø§Ù„Ø¹Ø§Ø¯Ù„</h1>

    <div class="stats-panel no-print">
        <div>Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ: <span id="equityLabel" class="equity-indicator">--</span></div>
        <div>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ: <b id="avgConsumption">0%</b></div>
    </div>

    <div class="form-group no-print">
        <input type="text" id="tName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
        <input type="number" id="tLessons" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©">
        <button onclick="addTeacher()">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…</button>
        <button class="reset-btn" onclick="resetAll()">ØªØµÙÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        <button onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>

    <h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h2>
    <table id="teacherTable">
        <thead>
            <tr>
                <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ù†ØµØ§Ø¨</th>
                <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th>
                <th>Ø§Ù„Ù…Ø³Ù†Ø¯</th>
                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th style="width: 25%;">Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</th>
            </tr>
        </thead>
        <tbody id="teacherBody"></tbody>
    </table>

    <h2>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ØµØµ (Ø§Ù„Ø£Ø­Ø¯ - Ø§Ù„Ø®Ù…ÙŠØ³)</h2>
    <table id="scheduleTable">
        <thead>
            <tr>
                <th style="width: 100px;">Ø§Ù„ÙŠÙˆÙ…</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>
</div>

<script>
    let teachers = JSON.parse(localStorage.getItem('w_teachers')) || [];
    let schedule = JSON.parse(localStorage.getItem('w_schedule')) || {};
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³'];

    function calculateLimit(n) {
        if (n >= 20) return 0;
        if (n >= 18) return 2;
        if (n >= 16) return 4;
        if (n >= 15) return 5;
        if (n <= 10) return 5; // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø´Ø±Ø· (Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 5 Ø­ØµØµ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹)
        return 0;
    }

    function showAlert(msg, type = 'danger') {
        const box = document.getElementById('alert');
        box.textContent = msg;
        box.style.backgroundColor = type === 'danger' ? '#e74c3c' : '#f39c12';
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 5000);
    }

    function addTeacher() {
        const name = document.getElementById('tName').value;
        const lessons = parseInt(document.getElementById('tLessons').value);
        if (!name || isNaN(lessons)) return;

        teachers.push({
            id: 'id_' + Date.now(),
            name: name,
            lessons: lessons,
            max: Math.min(calculateLimit(lessons), 5), // Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 5 Ø­ØµØµ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹
            assigned: 0
        });
        save();
        document.getElementById('tName').value = '';
        document.getElementById('tLessons').value = '';
    }

    function validateAssignment(teacherId, day, lesson) {
        if (!teacherId) return true;
        const teacher = teachers.find(t => t.id === teacherId);

        // 1. Ù‚ÙŠØ¯ Ø§Ù„Ù€ 100% Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯
        if (teacher.assigned >= teacher.max) {
            showAlert(`Ø§Ù„Ù…Ø¹Ù„Ù… ${teacher.name} ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ (${teacher.max})`);
            return false;
        }

        // 2. Ù‚ÙŠØ¯: Ù„Ø§ ÙŠØ³Ù†Ø¯ Ø£ÙƒØ«Ø± Ù…Ù† Ø­ØµØ© ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ§Ø­Ø¯
        let dailyCount = 0;
        for (let l = 1; l <= 7; l++) {
            if (schedule[`${day}-${l}`] === teacherId) dailyCount++;
        }
        if (dailyCount >= 1) {
            showAlert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø³Ù†Ø§Ø¯ Ø£ÙƒØ«Ø± Ù…Ù† Ø­ØµØ© Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§Ø­Ø¯Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ù…Ø¹Ù„Ù… ${teacher.name}`);
            return false;
        }

        // 3. ØªØ­Ø°ÙŠØ±: Ø£ÙˆÙ„ ÙˆØ¢Ø®Ø± Ø­ØµØ©
        if (lesson == 1 || lesson == 7) {
            const opp = (lesson == 1) ? 7 : 1;
            if (schedule[`${day}-${opp}`] === teacherId) {
                showAlert(`ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…Ø¹Ù„Ù… ${teacher.name} Ù„Ø¯ÙŠÙ‡ Ø§Ù†ØªØ¸Ø§Ø± ÙÙŠ Ø£ÙˆÙ„ ÙˆØ¢Ø®Ø± Ø­ØµØ©!`, 'warning');
            }
        }

        // 4. ØªØ­Ø°ÙŠØ±: Ø­ØµØ© Ù…ØªØªØ§Ù„ÙŠØ© ÙÙŠ ÙŠÙˆÙ…ÙŠÙ†
        const dayIdx = days.indexOf(day);
        if (dayIdx > 0) {
            if (schedule[`${days[dayIdx-1]}-${lesson}`] === teacherId) {
                showAlert(`ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…Ø¹Ù„Ù… ${teacher.name} Ù„Ø¯ÙŠÙ‡ Ù†ÙØ³ Ø§Ù„Ø­ØµØ© Ù„ÙŠÙˆÙ…ÙŠÙ† Ù…ØªØªØ§Ù„ÙŠÙŠÙ†!`, 'warning');
            }
        }

        return true;
    }

    function updateCell(day, lesson, teacherId) {
        if (teacherId !== "" && !validateAssignment(teacherId, day, lesson)) {
            renderAll(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø§Ø·Ø¦
            return;
        }
        schedule[`${day}-${lesson}`] = teacherId;
        syncAssigned();
        save();
    }

    function syncAssigned() {
        teachers.forEach(t => t.assigned = 0);
        Object.values(schedule).forEach(id => {
            if (id) {
                const t = teachers.find(x => x.id === id);
                if (t) t.assigned++;
            }
        });
    }

    function save() {
        localStorage.setItem('w_teachers', JSON.stringify(teachers));
        localStorage.setItem('w_schedule', JSON.stringify(schedule));
        renderAll();
    }

    function renderAll() {
        // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
        const tBody = document.getElementById('teacherBody');
        tBody.innerHTML = '';
        teachers.forEach(t => {
            const ratio = t.max > 0 ? (t.assigned / t.max) * 100 : 0;
            const color = ratio <= 40 ? 'status-low' : (ratio <= 70 ? 'status-mid' : 'status-high');
            tBody.innerHTML += `
                <tr>
                    <td>${t.name}</td>
                    <td>${t.lessons}</td>
                    <td>${t.max}</td>
                    <td>${t.assigned}</td>
                    <td>${t.max - t.assigned}</td>
                    <td>
                        <small>${ratio.toFixed(0)}%</small>
                        <div class="progress-container"><div class="progress-bar ${color}" style="width:${Math.min(ratio, 100)}%"></div></div>
                    </td>
                </tr>`;
        });

        // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        const sBody = document.getElementById('scheduleBody');
        sBody.innerHTML = '';
        days.forEach(day => {
            let row = `<tr><td><b>${day}</b></td>`;
            for (let i = 1; i <= 7; i++) {
                const currentId = schedule[`${day}-${i}`] || "";
                let options = `<option value="">--</option>`;
                teachers.forEach(t => {
                    if (t.max > 0) {
                        options += `<option value="${t.id}" ${t.id === currentId ? 'selected' : ''}>${t.name}</option>`;
                    }
                });
                row += `<td class="waiting-cell"><select onchange="updateCell('${day}', ${i}, this.value)">${options}</select></td>`;
            }
            row += `</tr>`;
            sBody.innerHTML += row;
        });

        updateEquityUI();
    }

    function updateEquityUI() {
        const validTeachers = teachers.filter(t => t.max > 0);
        if (validTeachers.length === 0) return;

        const ratios = validTeachers.map(t => (t.assigned / t.max) * 100);
        const avg = ratios.reduce((a, b) => a + b, 0) / ratios.length;
        const diff = Math.max(...ratios) - Math.min(...ratios);

        const lbl = document.getElementById('equityLabel');
        document.getElementById('avgConsumption').textContent = avg.toFixed(1) + '%';

        if (diff <= 15) { lbl.textContent = 'ğŸŸ¢ Ø¹Ø§Ø¯Ù„'; lbl.className = 'equity-indicator equity-green'; }
        else if (diff <= 30) { lbl.textContent = 'ğŸŸ¡ Ù…Ù‚Ø¨ÙˆÙ„'; lbl.className = 'equity-indicator equity-yellow'; }
        else { lbl.textContent = 'ğŸ”´ ØºÙŠØ± Ø¹Ø§Ø¯Ù„'; lbl.className = 'equity-indicator equity-red'; }
    }

    function resetAll() {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØŸ')) {
            schedule = {};
            syncAssigned();
            save();
        }
    }

    renderAll();
</script>
</body>
</html>
