<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة السلوك الطلابي المحدثة | متوسطة المنذر بن عمرو الأنصاري</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --warning-color: #f39c12;
            --accent-color: #9b59b6;
            --light-bg: #f4f7f9;
            --white-bg: #ffffff;
            --border-color: #e2e8f0;
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--light-bg);
            color: var(--secondary-color);
            line-height: 1.8;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: var(--white-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px 25px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 2.5em; font-weight: 800; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }

        .school-info {
            background: rgba(255,255,255,0.95);
            padding: 20px 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        .info-item { font-size: 0.95em; display: flex; align-items: center; gap: 10px; }
        .info-item strong { color: var(--primary-color); font-weight: 700; }

        /* --- Navigation --- */
        .nav {
            background: var(--white-bg);
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav button {
            background: transparent;
            border: none;
            color: var(--secondary-color);
            padding: 12px 24px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: var(--transition);
            border-radius: 12px;
        }
        .nav button:hover { background: #f0f4f8; color: var(--primary-color); }
        .nav button.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(41, 128, 185, 0.3);
        }

        /* --- Content --- */
        .content { padding: 40px; }
        .section { display: none; animation: slideUp 0.5s ease-out; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--white-bg);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.05); }
        .card h2 { font-size: 1.8em; margin-bottom: 25px; color: var(--secondary-color); display: flex; align-items: center; gap: 15px; }
        .card h2::after { content: ''; flex: 1; height: 2px; background: linear-gradient(to left, transparent, #e2e8f0); }

        /* --- Forms --- */
        .form-group { margin-bottom: 20px; position: relative; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 700; color: #4a5568; font-size: 0.95em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #edf2f7;
            border-radius: 12px;
            font-size: 1em;
            background-color: #f8fafc;
            transition: var(--transition);
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: white;
            box-shadow: 0 0 0 4px rgba(41, 128, 185, 0.1);
        }

        .points-badge {
            position: absolute;
            left: 15px;
            top: 45px;
            background: var(--success-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            display: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); filter: brightness(1.05); }

        /* --- Dashboard --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; }
        .stat-card {
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            background: white;
            border: 1px solid #edf2f7;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100%; height: 5px; }
        .stat-card.violations::before { background: var(--danger-color); }
        .stat-card.positives::before { background: var(--success-color); }
        .stat-card.recoveries::before { background: var(--primary-color); }
        .stat-card.commitment::before { background: var(--warning-color); }
        
        .stat-card .value { font-size: 3em; font-weight: 800; margin-bottom: 5px; }
        .stat-card .label { font-size: 1em; color: #718096; font-weight: 600; }

        /* --- Alerts --- */
        .alert { padding: 20px; border-radius: 12px; margin: 25px 0; border-right: 6px solid; display: flex; align-items: center; gap: 15px; }
        .alert-info { background: #ebf8ff; border-color: #3182ce; color: #2c5282; }
        .alert-warning { background: #fffaf0; border-color: #dd6b20; color: #7b341e; }
        .alert-danger { background: #fff5f5; border-color: #e53e3e; color: #c53030; }

        /* --- Reports --- */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; padding: 18px; text-align: right; font-weight: 700; color: #4a5568; border-bottom: 2px solid #edf2f7; }
        td { padding: 18px; border-bottom: 1px solid #edf2f7; font-size: 0.95em; }
        tr:hover { background: #f7fafc; }

        /* --- Modal for Student Report --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .close { font-size: 28px; font-weight: bold; cursor: pointer; }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8em; }
            .content { padding: 20px; }
            .nav button { padding: 10px 15px; font-size: 0.9em; }
        }

        @media print {
            .nav, .btn, .form-group, .report-controls, .no-print, .close { display: none !important; }
            .container { box-shadow: none; border: none; margin: 0; width: 100%; max-width: 100%; }
            .section { display: block !important; opacity: 1 !important; }
            .modal { position: relative; display: block !important; background: none; backdrop-filter: none; }
            .modal-content { margin: 0; width: 100%; max-width: 100%; box-shadow: none; border: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>منصة السلوك الطلابي الذكية</h1>
            <p>متوسطة المنذر بن عمرو الأنصاري - المدينة المنورة</p>
        </header>

        <div class="school-info">
            <div class="info-item"><strong>مدير المدرسة:</strong> الأستاذ خالد المطيري</div>
            <div class="info-item"><strong>وكيل شؤون الطلاب:</strong> الأستاذ نواف الصبحي</div>
            <div class="info-item"><strong>العام الدراسي:</strong> 1447-1448 هـ</div>
        </div>

        <nav class="nav no-print">
            <button class="active" onclick="showSection('dashboard')">لوحة المتابعة</button>
            <button onclick="showSection('violation')">رصد مخالفة</button>
            <button onclick="showSection('positive')">رصد سلوك متميز</button>
            <button onclick="showSection('reports')">تقارير الأداء</button>
            <button onclick="showSection('governance')">الحوكمة</button>
        </nav>

        <main class="content">
            <!-- 1. Dashboard -->
            <section id="dashboard" class="section active">
                <div class="card">
                    <h2>لوحة المتابعة الذكية</h2>
                    <div class="dashboard-grid" id="dashboard-grid"></div>
                </div>
            </section>

            <!-- 2. Violation -->
            <section id="violation" class="section">
                <div class="card">
                    <h2>رصد مخالفة سلوكية</h2>
                    <form id="violationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>اسم الطالب *</label>
                                <input type="text" id="vio_student_name" list="studentList" required placeholder="ابدأ بكتابة الاسم...">
                            </div>
                            <div class="form-group">
                                <label>الصف *</label>
                                <select id="vio_grade" required>
                                    <option value="" disabled selected>اختر الصف</option>
                                    <option value="أول متوسط">أول متوسط</option>
                                    <option value="ثاني متوسط">ثاني متوسط</option>
                                    <option value="ثالث متوسط">ثالث متوسط</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>نوع المخالفة *</label>
                                <select id="vio_type" required>
                                    <option value="" disabled selected>اختر نوع المخالفة</option>
                                    <optgroup label="مخالفات الدرجة الأولى">
                                        <option value="الدخول والخروج من الصف بدون استئذان">الدخول والخروج من الصف بدون استئذان</option>
                                        <option value="التأخر عن الحصه">التأخر عن الحصه</option>
                                        <option value="اللعب في الممرات أثناء الفسحه">اللعب في الممرات أثناء الفسحه</option>
                                        <option value="التأخر عن الطابور الصباحي">التأخر عن الطابور الصباحي</option>
                                        <option value="الهروب عن الحصه">الهروب عن الحصه</option>
                                    </optgroup>
                                    <optgroup label="مخالفات أخرى">
                                        <option value="مخالفة زي مدرسي">مخالفة زي مدرسي</option>
                                        <option value="إخلال بنظام الحصة">إخلال بنظام الحصة</option>
                                        <option value="إهمال الواجبات">إهمال الواجبات المدرسية</option>
                                        <option value="أخرى">أخرى</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>تاريخ المخالفة *</label>
                                <input type="date" id="vio_date" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-danger">تسجيل المخالفة</button>
                    </form>
                </div>
            </section>

            <!-- 3. Positive Behavior -->
            <section id="positive" class="section">
                <div class="card">
                    <h2>رصد ممارسات السلوك المتميز</h2>
                    <div class="alert alert-warning">
                        <strong>تنبيه التوثيق:</strong> يجب إرفاق ما يثبت مشاركة الطالب من جهات معتمدة داخل المدرسة أو خارجها.
                    </div>
                    <form id="positiveForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>اسم الطالب *</label>
                                <input type="text" id="pos_student_name" list="studentList" required placeholder="ابدأ بكتابة الاسم...">
                            </div>
                            <div class="form-group">
                                <label>الصف *</label>
                                <select id="pos_grade" required>
                                    <option value="" disabled selected>اختر الصف</option>
                                    <option value="أول متوسط">أول متوسط</option>
                                    <option value="ثاني متوسط">ثاني متوسط</option>
                                    <option value="ثالث متوسط">ثالث متوسط</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>الفئة *</label>
                                <select id="pos_category" required onchange="updateSubCategories()">
                                    <option value="" disabled selected>اختر الفئة</option>
                                    <option value="cat1">الفئة الأولى (6 درجات)</option>
                                    <option value="cat2">الفئة الثانية (4 درجات)</option>
                                    <option value="cat3">الفئة الثالثة (2 درجة)</option>
                                    <option value="cat4">أخرى (تقديرية)</option>
                                </select>
                                <div id="points_display" class="points-badge"></div>
                            </div>
                            <div class="form-group">
                                <label>تاريخ السلوك *</label>
                                <input type="date" id="pos_date" required>
                            </div>
                        </div>

                        <div class="form-group" id="sub_category_group" style="display:none;">
                            <label>الممارسة المحددة *</label>
                            <select id="pos_sub_category" onchange="handleSubCategoryChange()">
                                <option value="" disabled selected>اختر الممارسة</option>
                            </select>
                        </div>

                        <div class="form-group" id="custom_points_group" style="display:none;">
                            <label>الدرجة المقدرة (بناءً على توصية لجنة التوجيه) *</label>
                            <input type="number" id="pos_custom_points" min="1" max="6" placeholder="من 1 إلى 6 درجات">
                        </div>

                        <div class="form-group">
                            <label>وصف الحدث وتوثيق الدليل *</label>
                            <textarea id="pos_impact" rows="3" required placeholder="اذكر تفاصيل الممارسة ونوع الدليل المرفق..."></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>جهة الترشيح/التوثيق *</label>
                                <input type="text" id="pos_nominator" required placeholder="اسم المعلم أو الجهة">
                            </div>
                            <div class="form-group">
                                <label>المعتمد *</label>
                                <input type="text" id="pos_approver" value="أ. نواف الصبحي" readonly>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">توثيق السلوك المتميز</button>
                    </form>
                </div>
            </section>

            <!-- 4. Reports -->
            <section id="reports" class="section">
                <div class="card">
                    <h2>تقارير الأداء العام</h2>
                    <div class="report-controls no-print" style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" style="width:auto" onclick="window.print()">طباعة القائمة العامة</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>الترتيب</th>
                                    <th>الطالب</th>
                                    <th>الصف</th>
                                    <th>صافي النقاط</th>
                                    <th>إجمالي الخصم</th>
                                    <th>الإجراء</th>
                                </tr>
                            </thead>
                            <tbody id="reports-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 5. Governance -->
            <section id="governance" class="section">
                <div class="card">
                    <h2>حوكمة النظام واللوائح المحدثة</h2>
                    <div class="alert alert-info">
                        <strong>نظام الاسترداد التلقائي:</strong> يتم استرداد درجة المخالفة تلقائياً بعد مرور 7 أيام في حال لم يسجل الطالب أي مخالفة جديدة خلال هذه الفترة.
                    </div>
                    <div class="alert alert-danger">
                        <strong>إشعار ولي الأمر:</strong> يتم إصدار تقرير مفصل لولي الأمر في حال تجاوز إجمالي الخصم 15 درجة.
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                        <div>
                            <h3>توزيع الدرجات</h3>
                            <ul>
                                <li><strong>6 درجات:</strong> الفئة الأولى (الانضباط) والثانية (المشاركات النوعية).</li>
                                <li><strong>4 درجات:</strong> مهارات الأنشطة (القيادة، المهارات الرقمية، إدارة الوقت).</li>
                                <li><strong>2 درجة:</strong> المشاركة المدرسية (الإذاعة، رسائل الشكر، التعاون).</li>
                                <li><strong>مخالفات الدرجة الأولى:</strong> خصم درجتين عن كل مخالفة.</li>
                            </ul>
                        </div>
                        <div>
                            <h3>متطلبات التوثيق</h3>
                            <p>لا يتم اعتماد أي درجة للسلوك المتميز إلا بوجود دليل مادي. يتم تسجيل تاريخ كل مخالفة لضمان دقة نظام الاسترداد التلقائي.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Student Report Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h2 id="modalStudentName">تقرير الطالب</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                <!-- Report content will be injected here -->
            </div>
            <div class="no-print" style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-info" onclick="window.print()">تحميل / طباعة التقرير</button>
                <button class="btn btn-danger" id="sendToParentBtn" style="display:none;">إرسال لولي الأمر</button>
            </div>
        </div>
    </div>

    <datalist id="studentList"></datalist>

    <script>
        // --- DATA ---
        const STUDENT_DATABASE = [
            {"name": "أحمد فواز بن سعدون الحربي", "grade": "أول متوسط"},
            {"name": "أسامه سعود حاجر الحربي", "grade": "أول متوسط"},
            {"name": "اسامه ماجد ضيف الله الزويكي", "grade": "أول متوسط"},
            {"name": "باسم سيف بن عبيد الرويثي", "grade": "أول متوسط"},
            {"name": "ثامر تركي النشمي الحربي", "grade": "أول متوسط"},
            {"name": "ثامر رائد مرزوق المطيري", "grade": "أول متوسط"},
            {"name": "حمد عبدالرحمن بن حمد الحربي", "grade": "أول متوسط"},
            {"name": "ساير ثامر بن سائر العتيبي", "grade": "أول متوسط"},
            {"name": "سعود عماد سعود الحازمي", "grade": "أول متوسط"},
            {"name": "سلطان ساطي سمران الحربي", "grade": "أول متوسط"},
            {"name": "سلطان فهد بن حاسن العمري", "grade": "أول متوسط"},
            {"name": "عبدالاله عوض نويفع الزويكي", "grade": "أول متوسط"},
            {"name": "عبدالرحمن خلوي بن نافع الحربي", "grade": "أول متوسط"},
            {"name": "عبدالعزيز فهد عامر الغنام", "grade": "أول متوسط"},
            {"name": "عبدالمجيد ربيع مرزوق العمري", "grade": "أول متوسط"},
            {"name": "عساف بدر بشير الحربي", "grade": "أول متوسط"},
            {"name": "عمر اسامه بن منور العوفي", "grade": "أول متوسط"},
            {"name": "عمر منصور بن سعود الحربي", "grade": "أول متوسط"},
            {"name": "فيصل فواز محمد الحربي", "grade": "أول متوسط"},
            {"name": "محمد عبدالمجيد بشير الحربي", "grade": "أول متوسط"},
            {"name": "مشاري عبدالله علي المطيري", "grade": "أول متوسط"},
            {"name": "مصعب عبدالهادي بن مرزوق العمري", "grade": "أول متوسط"},
            {"name": "نادر سعود بن حميد العمري", "grade": "أول متوسط"},
            {"name": "نايف عيد حميد العمري", "grade": "أول متوسط"},
            {"name": "هايل صالح عائض المطيري", "grade": "أول متوسط"},
            {"name": "وسام جابر عيد الحربي", "grade": "أول متوسط"},
            {"name": "وسام عبدالله حامد الحربي", "grade": "أول متوسط"},
            {"name": "ياسر خالد معجل المطيري", "grade": "أول متوسط"},
            {"name": "يزيد فواز خليوي المطيري", "grade": "أول متوسط"},
            {"name": "يعقوب محمد عايد المطيري", "grade": "أول متوسط"},
            {"name": "احمد حسين علوي حسين الحارثي", "grade": "أول متوسط"},
            {"name": "أسامه عبدالرحمن بن سعيد العوفي", "grade": "أول متوسط"},
            {"name": "البراء محمد عزيز العوفي", "grade": "أول متوسط"},
            {"name": "بتال موسى عمار المطيري", "grade": "أول متوسط"},
            {"name": "تركي محمد بن سالم الجهني", "grade": "أول متوسط"},
            {"name": "حازم عبدالهادي بن سعد الحربي", "grade": "أول متوسط"},
            {"name": "خالد عبدالرب عبد ربه الكحيلي", "grade": "أول متوسط"},
            {"name": "خالد منصور بن مناور السحيمي", "grade": "أول متوسط"},
            {"name": "ريان ماجد عيد الرشيدي", "grade": "أول متوسط"},
            {"name": "زياد فؤاد محمد العتيبي", "grade": "أول متوسط"},
            {"name": "سعد فهد مسعد العوفي", "grade": "أول متوسط"},
            {"name": "سعود فيصل محمد الخريف", "grade": "أول متوسط"},
            {"name": "سلطان ماجد بن معتاد المولد", "grade": "أول متوسط"},
            {"name": "شامخ نادر سمار الحربي", "grade": "أول متوسط"},
            {"name": "عادل محمد غازي الحربي", "grade": "أول متوسط"},
            {"name": "عبدالرحمن عبدالعزيز بن النشمي الحربي", "grade": "أول متوسط"},
            {"name": "عصام عبدالستار سالم العوفي", "grade": "أول متوسط"},
            {"name": "عقاب محمد عايد المطيري", "grade": "أول متوسط"}
        ];

        const BEHAVIOR_MAP = {
            cat1: { points: 6, items: ["انضباط الطالب وعدم غيابه بدون عذر خلال الفصل", "المشاركة في الخدمة المجتمعية خارج المدرسة", "تقديم فعالية حوارية", "المشاركة في حملة توعوية", "عرض تجارب شخصية ناجحة", "الالتحاق ببرنامج أو دورة"] },
            cat2: { points: 4, items: ["مهارات الاتصال (العمل الجماعي، التعلم بالأقران...)", "مهارات القيادة والمسؤولية (التخطيط، التحفيز...)", "المهارات الرقمية (إعداد العروض، تصميم المحتوى)", "مهارة إدارة الوقت"] },
            cat3: { points: 2, items: ["كتابة رسالة شكر (للوطن، للقيادة، للمعلم...)", "المشاركة في الإذاعة المدرسية", "تقديم مقترح لصالح المجتمع المدرسي", "التعاون مع الزملاء والمعلمين والإدارة"] },
            cat4: { points: 0, items: ["سلوك متميز آخر (يتطلب توصية لجنة التوجيه)"] }
        };

        const STORAGE_KEY = 'student_behavior_data_v6';

        // --- CORE FUNCTIONS ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = document.querySelector(`button[onclick="showSection('${id}')"]`);
            if(btn) btn.classList.add('active');
            if(id === 'dashboard') updateDashboard();
            if(id === 'reports') generateMainReport();
        }

        function updateSubCategories() {
            const cat = document.getElementById('pos_category').value;
            const subGroup = document.getElementById('sub_category_group');
            const subSelect = document.getElementById('pos_sub_category');
            const customGroup = document.getElementById('custom_points_group');
            const badge = document.getElementById('points_display');

            subSelect.innerHTML = '<option value="" disabled selected>اختر الممارسة</option>';
            
            if(cat) {
                subGroup.style.display = 'block';
                BEHAVIOR_MAP[cat].items.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.textContent = item;
                    subSelect.appendChild(opt);
                });
                
                if(cat === 'cat4') {
                    customGroup.style.display = 'block';
                    badge.style.display = 'none';
                } else {
                    customGroup.style.display = 'none';
                    badge.textContent = `+${BEHAVIOR_MAP[cat].points} درجة`;
                    badge.style.display = 'block';
                }
            }
        }

        function handleSubCategoryChange() {
            const badge = document.getElementById('points_display');
            badge.style.animation = 'none';
            badge.offsetHeight; 
            badge.style.animation = 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        }

        // --- DATA PERSISTENCE ---
        const getData = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const saveData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        // --- RECOVERY LOGIC ---
        function processRecoveries(data) {
            const now = new Date();
            const oneWeekMs = 7 * 24 * 60 * 60 * 1000;
            
            // Group violations by student
            const studentViolations = {};
            data.forEach((r, index) => {
                if (r.type === 'violation') {
                    if (!studentViolations[r.studentName]) studentViolations[r.studentName] = [];
                    studentViolations[r.studentName].push({ ...r, originalIndex: index });
                }
            });

            let changed = false;
            Object.keys(studentViolations).forEach(studentName => {
                const violations = studentViolations[studentName].sort((a, b) => new Date(a.date) - new Date(b.date));
                
                violations.forEach((v, i) => {
                    if (v.status === 'makhsouma') {
                        const vDate = new Date(v.date);
                        const timeDiff = now - vDate;
                        
                        if (timeDiff >= oneWeekMs) {
                            // Check if any NEW violation occurred after this one but before it was recovered
                            const hasNewerViolation = violations.some(otherV => {
                                const otherDate = new Date(otherV.date);
                                return otherDate > vDate && otherDate <= new Date(vDate.getTime() + oneWeekMs);
                            });

                            if (!hasNewerViolation) {
                                data[v.originalIndex].status = 'mustaradda';
                                data[v.originalIndex].points = 0;
                                changed = true;
                            }
                        }
                    }
                });
            });
            
            if (changed) saveData(data);
            return data;
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            if(document.getElementById('vio_date')) document.getElementById('vio_date').value = today;
            if(document.getElementById('pos_date')) document.getElementById('pos_date').value = today;

            // Populate Datalist
            const list = document.getElementById('studentList');
            STUDENT_DATABASE.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                list.appendChild(opt);
            });

            // Auto-fill Grade
            ['vio_student_name', 'pos_student_name'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('input', function() {
                        const student = STUDENT_DATABASE.find(s => s.name === this.value);
                        if(student) {
                            const gradeId = id.startsWith('vio') ? 'vio_grade' : 'pos_grade';
                            document.getElementById(gradeId).value = student.grade;
                        }
                    });
                }
            });

            // Form Submissions
            const vioForm = document.getElementById('violationForm');
            if(vioForm) {
                vioForm.onsubmit = function(e) {
                    e.preventDefault();
                    const data = getData();
                    data.push({
                        type: 'violation',
                        timestamp: Date.now(),
                        date: document.getElementById('vio_date').value,
                        studentName: document.getElementById('vio_student_name').value,
                        grade: document.getElementById('vio_grade').value,
                        violationType: document.getElementById('vio_type').value,
                        points: -2,
                        status: 'makhsouma'
                    });
                    saveData(data);
                    alert('تم تسجيل المخالفة بنجاح');
                    this.reset();
                    document.getElementById('vio_date').value = today;
                    showSection('dashboard');
                };
            }

            const posForm = document.getElementById('positiveForm');
            if(posForm) {
                posForm.onsubmit = function(e) {
                    e.preventDefault();
                    const cat = document.getElementById('pos_category').value;
                    const points = cat === 'cat4' ? parseInt(document.getElementById('pos_custom_points').value) : BEHAVIOR_MAP[cat].points;
                    
                    const data = getData();
                    data.push({
                        type: 'positive',
                        timestamp: Date.now(),
                        date: document.getElementById('pos_date').value,
                        studentName: document.getElementById('pos_student_name').value,
                        grade: document.getElementById('pos_grade').value,
                        category: document.getElementById('pos_sub_category').value,
                        points: points,
                        impact: document.getElementById('pos_impact').value,
                        nominator: document.getElementById('pos_nominator').value
                    });
                    saveData(data);
                    alert('تم توثيق السلوك المتميز بنجاح');
                    this.reset();
                    document.getElementById('pos_date').value = today;
                    document.getElementById('sub_category_group').style.display = 'none';
                    document.getElementById('custom_points_group').style.display = 'none';
                    showSection('dashboard');
                };
            }

            showSection('dashboard');
        });

        function updateDashboard() {
            let data = getData();
            data = processRecoveries(data);
            const grid = document.getElementById('dashboard-grid');
            const violations = data.filter(r => r.type === 'violation').length;
            const positives = data.filter(r => r.type === 'positive').length;
            const recoveries = data.filter(r => r.status === 'mustaradda').length;
            
            grid.innerHTML = `
                <div class="stat-card violations"><div class="value">${violations}</div><div class="label">مخالفات مسجلة</div></div>
                <div class="stat-card positives"><div class="value">${positives}</div><div class="label">سلوكيات متميزة</div></div>
                <div class="stat-card recoveries"><div class="value">${recoveries}</div><div class="label">حالات استرداد</div></div>
                <div class="stat-card commitment"><div class="value">${Math.max(0, 100 - (violations-recoveries)*2)}%</div><div class="label">مؤشر الانضباط</div></div>
            `;
        }

        function generateMainReport() {
            let data = getData();
            data = processRecoveries(data);
            const tbody = document.getElementById('reports-tbody');
            const studentStats = {};

            data.forEach(r => {
                if(!studentStats[r.studentName]) {
                    studentStats[r.studentName] = { 
                        name: r.studentName, 
                        grade: r.grade, 
                        netPoints: 0, 
                        totalDeduction: 0 
                    };
                }
                studentStats[r.studentName].netPoints += r.points;
                if (r.type === 'violation') {
                    // We count the original deduction even if recovered for the "total deduction" alert logic
                    studentStats[r.studentName].totalDeduction += 2; 
                }
            });

            const students = Object.values(studentStats).sort((a,b) => b.netPoints - a.netPoints);
            tbody.innerHTML = students.map((s, i) => `
                <tr>
                    <td>${i+1}</td>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.grade}</td>
                    <td style="color: ${s.netPoints >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">${s.netPoints}</td>
                    <td>${s.totalDeduction} درجة</td>
                    <td>
                        <button class="btn btn-info" style="padding: 8px 15px; font-size: 0.85em;" onclick="viewStudentReport('${s.name}')">عرض التقرير</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6" style="text-align:center">لا توجد بيانات مسجلة</td></tr>';
        }

        function viewStudentReport(studentName) {
            const data = getData();
            const studentData = data.filter(r => r.studentName === studentName).sort((a, b) => new Date(a.date) - new Date(b.date));
            const student = STUDENT_DATABASE.find(s => s.name === studentName) || { name: studentName, grade: 'غير محدد' };
            
            let netPoints = 0;
            let totalDeduction = 0;
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3 style="font-size: 1.5em; color: var(--primary-color);">${student.name}</h3>
                    <p>الصف: ${student.grade} | تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>النوع</th>
                                <th>التفاصيل</th>
                                <th>النقاط</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            studentData.forEach(r => {
                netPoints += r.points;
                const isViolation = r.type === 'violation';
                if (isViolation) totalDeduction += 2;

                html += `
                    <tr>
                        <td>${r.date}</td>
                        <td>${isViolation ? 'مخالفة' : 'سلوك إيجابي'}</td>
                        <td>${isViolation ? r.violationType : r.category}</td>
                        <td style="color: ${r.points >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">${r.points > 0 ? '+' + r.points : r.points}</td>
                        <td>${isViolation ? (r.status === 'mustaradda' ? '<span style="color:var(--success-color)">مستردة</span>' : '<span style="color:var(--danger-color)">مخصومة</span>') : '-'}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div><strong>صافي نقاط السلوك:</strong> <span style="font-size: 1.2em; color: ${netPoints >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">${netPoints}</span></div>
                    <div><strong>إجمالي الخصومات:</strong> <span style="font-size: 1.2em; color: var(--danger-color)">${totalDeduction} درجة</span></div>
                </div>
            `;

            if (totalDeduction > 15) {
                html += `
                    <div class="alert alert-danger" style="margin-top: 20px;">
                        <strong>تنبيه هام:</strong> تجاوز الطالب الحد المسموح به من الخصومات (15 درجة). يجب إشعار ولي الأمر فوراً.
                    </div>
                `;
                document.getElementById('sendToParentBtn').style.display = 'block';
            } else {
                document.getElementById('sendToParentBtn').style.display = 'none';
            }

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('studentModal').style.display = "block";
        }

        function closeModal() {
            document.getElementById('studentModal').style.display = "none";
        }

        window.onclick = function(event) {
            const modal = document.getElementById('studentModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>


