<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة السلوك الطلابي | متوسطة المنذر بن عمرو الأنصاري</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* [نفس كود الـ CSS السابق بدون تغيير] */
        :root {
            --primary-color: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --warning-color: #f39c12;
            --light-bg: #f4f7f9;
            --white-bg: #ffffff;
            --border-color: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--light-bg );
            color: var(--secondary-color);
            line-height: 1.8;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: var(--white-bg);
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #3498db 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .school-info {
            background-color: #ecf0f1;
            padding: 15px 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .info-item { font-size: 0.9em; }
        .info-item strong { color: var(--primary-color); }
        .nav {
            background: var(--white-bg);
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            padding: 5px 0;
        }
        .nav button {
            background: transparent;
            border: none;
            color: var(--secondary-color);
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .nav button:hover { color: var(--primary-color); }
        .nav button.active {
            color: var(--primary-color);
            font-weight: 700;
            border-bottom-color: var(--primary-color);
        }
        .content { padding: 30px; }
        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .card {
            background: var(--white-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .card h2 {
            font-size: 1.7em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: #f8f9fa;
        }
        .form-group input:focus, .form-group select:focus { outline: 2px solid var(--primary-color); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.05em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn:hover { filter: brightness(110%); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-bottom: 4px solid;
        }
        .stat-card .value { font-size: 2.5em; font-weight: 800; }
        .stat-card .label { font-size: 1em; margin-top: 5px; }
        .stat-card.violations { border-color: var(--danger-color); } .stat-card.violations .value { color: var(--danger-color); }
        .stat-card.positives { border-color: var(--success-color); } .stat-card.positives .value { color: var(--success-color); }
        .stat-card.recoveries { border-color: var(--primary-color); } .stat-card.recoveries .value { color: var(--primary-color); }
        .stat-card.commitment { border-color: var(--warning-color); } .stat-card.commitment .value { color: var(--warning-color); }
        .alert { padding: 15px; border-radius: 8px; margin: 20px 0; border-right: 5px solid; }
        .alert-info { background-color: #eaf5fc; border-color: var(--primary-color); color: #084298; }
        .alert-success { background-color: #eafaf1; border-color: var(--success-color); color: #0f5132; }
        #governance h3 { font-size: 1.4em; color: var(--primary-color); margin-top: 25px; margin-bottom: 10px; }
        #governance ul { padding-right: 25px; }
        #governance li { margin-bottom: 10px; }
        
        /* --- New Styles for Reports Page --- */
        #reports-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #reports-table th, #reports-table td { padding: 12px; border: 1px solid var(--border-color); text-align: right; }
        #reports-table th { background-color: #f2f2f2; font-weight: 700; }
        #reports-table tr:nth-child(even) { background-color: #f8f9fa; }
        .points-positive { color: var(--success-color); font-weight: bold; }
        .points-negative { color: var(--danger-color); }
        .no-records { color: #777; }
        .report-controls { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .btn-print { background-color: var(--warning-color); }

        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
        @media print {
            body { background-color: var(--white-bg); }
            .nav, .btn, .form-group, .report-controls, .content > .card:not(#printable-area) { display: none; }
            .container { box-shadow: none; border: none; margin: 0; }
            .content { padding: 0; }
            #printable-area { display: block !important; border: none; box-shadow: none; }
            .section.active { display: block !important; }
            #reports-table th, #reports-table td { font-size: 10pt; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>منصة السلوك الطلابي المطورة</h1>
            <p>متوسطة المنذر بن عمرو الأنصاري - المدينة المنورة</p>
        </header>

        <div class="school-info">
            <div class="info-item"><strong>مدير المدرسة:</strong> الأستاذ خالد المطيري</div>
            <div class="info-item"><strong>وكيل شؤون الطلاب:</strong> الأستاذ نواف الصبحي</div>
            <div class="info-item"><strong>العام الدراسي:</strong> 1447-1448 هـ</div>
        </div>

        <nav class="nav">
            <button class="active" onclick="showSection('dashboard')">لوحة المتابعة</button>
            <button onclick="showSection('violation')">رصد مخالفة</button>
            <button onclick="showSection('positive')">رصد سلوك إيجابي</button>
            <button onclick="showSection('reports')">تقارير الأداء</button> <!-- New Button -->
            <button onclick="showSection('governance')">الحوكمة والشفافية</button>
        </nav>

        <main class="content">
            <!-- ... [الأقسام السابقة: dashboard, violation, positive] ... -->
            <section id="dashboard" class="section active">
                <!-- نفس محتوى لوحة المتابعة -->
            </section>
            <section id="violation" class="section">
                <!-- نفس محتوى رصد مخالفة -->
            </section>
            <section id="positive" class="section">
                <!-- نفس محتوى رصد سلوك إيجابي -->
            </section>

            <!-- 5. صفحة تقارير الأداء (الجديدة) -->
            <section id="reports" class="section">
                <div class="card" id="printable-area">
                    <h2>تقارير الأداء الشهري (مساعد رصد درجات نظام نور)</h2>
                    <div class="report-controls">
                        <label for="month-selector">اختر الشهر لعرض التقرير:</label>
                        <select id="month-selector"></select>
                        <button class="btn btn-print" onclick="window.print()">طباعة التقرير</button>
                    </div>
                    <div class="alert alert-info">
                        <strong>كيفية الاستخدام:</strong> هذه الصفحة تساعدك في نهاية كل شهر على تحديد الطلاب المرشحين لدرجات السلوك الإيجابي في نظام نور. التقرير يرتب الطلاب تنازليًا بناءً على "مؤشر التميز السلوكي".
                    </div>
                    <table id="reports-table">
                        <thead>
                            <tr>
                                <th>الترتيب</th>
                                <th>اسم الطالب</th>
                                <th>الصف</th>
                                <th>مؤشر التميز</th>
                                <th>تفاصيل المؤشر</th>
                                <th>درجة نور المقترحة (من 20)</th>
                            </tr>
                        </thead>
                        <tbody id="reports-tbody">
                            <!-- سيتم ملء التقرير هنا عبر JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="governance" class="section">
                <!-- نفس محتوى صفحة الحوكمة -->
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- [نفس الـ CONFIGURATION و DOM ELEMENTS من الكود السابق] ---
        const POSITIVE_BEHAVIOR_POINTS = { 'مبادرة شخصية': 2, 'سلوك داعم': 3, 'إنجاز مركزي': 5 };
        const VIOLATION_POINTS = { 'تأخر صباحي': -2, 'مخالفة زي مدرسي': -1, 'إخلال بنظام الحصة': -3, 'إهمال الواجبات': -1, 'أخرى': -2 };
        const POSITIVE_BEHAVIOR_CAP = 10;
        const RECOVERY_PERIOD_DAYS = 7;
        const STORAGE_KEY = 'student_behavior_data_v2';

        const sections = document.querySelectorAll('.section');
        const navButtons = document.querySelectorAll('.nav button');
        const dashboardGrid = document.getElementById('dashboard-grid');
        const violationForm = document.getElementById('violationForm');
        const positiveForm = document.getElementById('positiveForm');
        // --- New DOM Elements for Reports ---
        const monthSelector = document.getElementById('month-selector');
        const reportsTbody = document.getElementById('reports-tbody');

        const getData = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const saveData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        function showSection(sectionId) {
            sections.forEach(section => section.classList.remove('active'));
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`.nav button[onclick="showSection('${sectionId}')"]`).classList.add('active');

            if (sectionId === 'dashboard') updateDashboard();
            if (sectionId === 'reports') generateReport(); // Generate report when section is shown
        }
        window.showSection = showSection;

        // --- [نفس دالة processRecoveries و updateDashboard من الكود السابق] ---
        function processRecoveries() { /* ... */ return getData(); }
        function updateDashboard() { /* ... */ }

        // --- NEW: Reports Page Logic ---

        /**
         * Populates the month selector based on available data.
         */
        function populateMonthSelector() {
            const data = getData();
            const months = new Set();
            data.forEach(r => {
                const date = new Date(r.timestamp);
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                months.add(monthKey);
            });

            monthSelector.innerHTML = '';
            const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            months.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = `${monthNames[parseInt(month)]} ${year}`;
                monthSelector.appendChild(option);
            });
            // Add current month if no data exists
            if (months.size === 0) {
                const now = new Date();
                const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
                monthSelector.appendChild(option);
            }
        }

        /**
         * Generates and displays the monthly performance report.
         */
        function generateReport() {
            populateMonthSelector();
            const selectedMonthKey = monthSelector.value;
            if (!selectedMonthKey) {
                reportsTbody.innerHTML = `<tr><td colspan="6">لا توجد بيانات لعرضها.</td></tr>`;
                return;
            }

            const [year, month] = selectedMonthKey.split('-').map(Number);
            const data = processRecoveries();
            const monthlyData = data.filter(r => {
                const date = new Date(r.timestamp);
                return date.getFullYear() === year && date.getMonth() === month;
            });

            const studentScores = {};

            // 1. Calculate scores for all students with records in the month
            monthlyData.forEach(r => {
                if (!studentScores[r.studentName]) {
                    studentScores[r.studentName] = {
                        name: r.studentName,
                        grade: r.grade,
                        positivePoints: 0,
                        violationCount: 0,
                        recoveredCount: 0,
                        excellenceIndex: 0
                    };
                }
                const student = studentScores[r.studentName];
                if (r.type === 'positive') {
                    student.positivePoints += r.points;
                } else if (r.type === 'violation') {
                    student.violationCount++;
                    if (r.status === 'mustaradda') {
                        student.recoveredCount++;
                    }
                }
            });

            // 2. Calculate Excellence Index and sort
            const rankedStudents = Object.values(studentScores).map(student => {
                // Excellence Index Formula: (Positive Points * 2) + (Recovered Violations) - (Unrecovered Violations)
                const unrecoveredViolations = student.violationCount - student.recoveredCount;
                student.excellenceIndex = (student.positivePoints * 2) + student.recoveredCount - unrecoveredViolations;
                return student;
            }).sort((a, b) => b.excellenceIndex - a.excellenceIndex);

            // 3. Render the report table
            renderReportTable(rankedStudents);
        }

        /**
         * Renders the student data into the report table.
         * @param {Array} rankedStudents - The sorted array of student objects.
         */
        function renderReportTable(rankedStudents) {
            if (rankedStudents.length === 0) {
                reportsTbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لا توجد سجلات لهذا الشهر. جميع الطلاب ملتزمون افتراضيًا.</td></tr>`;
                return;
            }

            reportsTbody.innerHTML = rankedStudents.map((student, index) => {
                const unrecoveredViolations = student.violationCount - student.recoveredCount;
                const details = `
                    <span class="points-positive">+${student.positivePoints} نقاط إيجابية</span>, 
                    <span class="no-records">${student.recoveredCount} استرداد</span>, 
                    <span class="points-negative">${unrecoveredViolations} مخالفات</span>
                `;
                
                // Logic to suggest Noor grade (example)
                let noorGrade = 15; // Base for any student with positive interaction
                if (student.excellenceIndex > 10) noorGrade = 20;
                else if (student.excellenceIndex > 5) noorGrade = 18;
                else if (student.excellenceIndex <= 0) noorGrade = 10; // Lower grade for students with net negative index

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${student.name}</strong></td>
                        <td>${student.grade}</td>
                        <td>${student.excellenceIndex}</td>
                        <td>${details}</td>
                        <td><strong>${noorGrade}</strong></td>
                    </tr>
                `;
            }).join('');
        }

        // --- Event Listeners ---
        monthSelector.addEventListener('change', generateReport);
        // [Add other form event listeners here...]
        violationForm.addEventListener('submit', (e) => { /*...*/ });
        positiveForm.addEventListener('submit', (e) => { /*...*/ });

        // --- INITIALIZATION ---
        showSection('dashboard');
    });
    </script>
</body>
</html>

