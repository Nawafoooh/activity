<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة السلوك الطلابي | متوسطة المنذر بن عمرو الأنصاري</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Reset & Base Styles --- */
        :root {
            --primary-color: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --warning-color: #f39c12;
            --light-bg: #f4f7f9;
            --white-bg: #ffffff;
            --border-color: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--light-bg);
            color: var(--secondary-color);
            line-height: 1.8;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: var(--white-bg);
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* --- Header & School Info --- */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #3498db 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .school-info {
            background-color: #ecf0f1;
            padding: 15px 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .info-item { font-size: 0.9em; }
        .info-item strong { color: var(--primary-color); }

        /* --- Navigation --- */
        .nav {
            background: var(--white-bg);
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            padding: 5px 0;
        }
        .nav button {
            background: transparent;
            border: none;
            color: var(--secondary-color);
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .nav button:hover { color: var(--primary-color); }
        .nav button.active {
            color: var(--primary-color);
            font-weight: 700;
            border-bottom-color: var(--primary-color);
        }

        /* --- Content & Sections --- */
        .content { padding: 30px; }
        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .card {
            background: var(--white-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .card h2 {
            font-size: 1.7em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- Forms --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: #f8f9fa;
            font-family: 'Tajawal', sans-serif;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: 2px solid var(--primary-color); 
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.05em;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: 'Tajawal', sans-serif;
        }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn:hover { filter: brightness(110%); }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Dashboard --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-bottom: 4px solid;
        }
        .stat-card .value { font-size: 2.5em; font-weight: 800; }
        .stat-card .label { font-size: 1em; margin-top: 5px; }
        .stat-card.violations { border-color: var(--danger-color); } 
        .stat-card.violations .value { color: var(--danger-color); }
        .stat-card.positives { border-color: var(--success-color); } 
        .stat-card.positives .value { color: var(--success-color); }
        .stat-card.recoveries { border-color: var(--primary-color); } 
        .stat-card.recoveries .value { color: var(--primary-color); }
        .stat-card.commitment { border-color: var(--warning-color); } 
        .stat-card.commitment .value { color: var(--warning-color); }

        /* --- Alerts & Governance Page --- */
        .alert { padding: 15px; border-radius: 8px; margin: 20px 0; border-right: 5px solid; }
        .alert-info { background-color: #eaf5fc; border-color: var(--primary-color); color: #084298; }
        .alert-success { background-color: #eafaf1; border-color: var(--success-color); color: #0f5132; }
        .alert-warning { background-color: #fff3cd; border-color: var(--warning-color); color: #856404; }
        #governance h3 { font-size: 1.4em; color: var(--primary-color); margin-top: 25px; margin-bottom: 10px; }
        #governance ul { padding-right: 25px; }
        #governance li { margin-bottom: 10px; }

        /* --- Reports Page --- */
        #reports-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #reports-table th, #reports-table td { padding: 12px; border: 1px solid var(--border-color); text-align: right; }
        #reports-table th { background-color: #f2f2f2; font-weight: 700; }
        #reports-table tr:nth-child(even) { background-color: #f8f9fa; }
        .points-positive { color: var(--success-color); font-weight: bold; }
        .points-negative { color: var(--danger-color); }
        .no-records { color: #777; }
        .report-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; }
        .btn-print { background-color: var(--warning-color); }

        /* --- Success Message --- */
        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        /* --- Loading Spinner --- */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Responsive & Print --- */
        @media (max-width: 768px) { 
            .form-row { grid-template-columns: 1fr; } 
            .header h1 { font-size: 1.5em; }
        }
        @media print {
            body { background-color: var(--white-bg); }
            .nav, .btn, .form-group, .report-controls, .content > .card:not(#printable-area) { display: none; }
            .container { box-shadow: none; border: none; margin: 0; }
            .content { padding: 0; }
            #printable-area { display: block !important; border: none; box-shadow: none; }
            .section.active { display: block !important; }
            #reports-table th, #reports-table td { font-size: 10pt; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>منصة السلوك الطلابي المطورة</h1>
            <p>متوسطة المنذر بن عمرو الأنصاري - المدينة المنورة</p>
        </header>

        <div class="school-info">
            <div class="info-item"><strong>مدير المدرسة:</strong> الأستاذ خالد المطيري</div>
            <div class="info-item"><strong>وكيل شؤون الطلاب:</strong> الأستاذ نواف الصبحي</div>
            <div class="info-item"><strong>العام الدراسي:</strong> 1447-1448 هـ</div>
        </div>

        <nav class="nav">
            <button class="active" onclick="showSection('dashboard')">لوحة المتابعة</button>
            <button onclick="showSection('violation')">رصد مخالفة</button>
            <button onclick="showSection('positive')">رصد سلوك إيجابي</button>
            <button onclick="showSection('reports')">تقارير الأداء</button>
            <button onclick="showSection('governance')">الحوكمة والشفافية</button>
        </nav>

        <main class="content">
            <!-- Loading Alert -->
            <div class="alert alert-warning" id="loading-alert" style="display:none;">
                جاري تحميل البيانات من Firebase...
            </div>

            <!-- 1. لوحة المتابعة الذكية (Dashboard) -->
            <section id="dashboard" class="section active">
                <div class="card">
                    <h2>لوحة المتابعة الأسبوعية الذكية</h2>
                    <div class="alert alert-info">
                        <strong>مبدأ الرصد:</strong> هذه اللوحة تعرض "الاستثناءات" المسجلة فقط (المخالفات والسلوكيات الإيجابية المميزة)، ولا تعرض بيانات الطلاب الملتزمين افتراضيًا.
                    </div>
                    <div class="dashboard-grid" id="dashboard-grid"></div>
                </div>
            </section>

            <!-- 2. رصد مخالفة (سلوك سلبي) -->
            <section id="violation" class="section">
                <div class="card">
                    <h2>رصد مخالفة سلوكية</h2>
                    <div class="success-message" id="violation-success"></div>
                    <form id="violationForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vio_student_name">اسم الطالب *</label>
                                <input type="text" id="vio_student_name" required placeholder="الاسم الثلاثي للطالب">
                            </div>
                            <div class="form-group">
                                <label for="vio_grade">الصف *</label>
                                <select id="vio_grade" required>
                                    <option value="" disabled selected>اختر الصف</option>
                                    <option value="أول متوسط">أول متوسط</option>
                                    <option value="ثاني متوسط">ثاني متوسط</option>
                                    <option value="ثالث متوسط">ثالث متوسط</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="vio_type">نوع المخالفة (الاستثناء) *</label>
                            <select id="vio_type" required>
                                <option value="" disabled selected>اختر نوع المخالفة</option>
                                <option value="تأخر صباحي">تأخر صباحي</option>
                                <option value="مخالفة زي مدرسي">مخالفة زي مدرسي</option>
                                <option value="إخلال بنظام الحصة">إخلال بنظام الحصة</option>
                                <option value="إهمال الواجبات">إهمال الواجبات المدرسية</option>
                                <option value="أخرى">أخرى (تتطلب توضيح)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vio_recorder">اسم المسجل (المعتمد) *</label>
                            <input type="text" id="vio_recorder" value="أ. نواف الصبحي" required readonly>
                        </div>
                        <button type="submit" class="btn btn-danger" id="violation-submit-btn">تسجيل المخالفة</button>
                    </form>
                </div>
            </section>

            <!-- 3. رصد سلوك إيجابي مميز (حدثي) -->
            <section id="positive" class="section">
                <div class="card">
                    <h2>رصد سلوك إيجابي مميز (حدثي)</h2>
                    <div class="success-message" id="positive-success"></div>
                    <form id="positiveForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pos_student_name">اسم الطالب *</label>
                                <input type="text" id="pos_student_name" required placeholder="الاسم الثلاثي للطالب">
                            </div>
                            <div class="form-group">
                                <label for="pos_grade">الصف *</label>
                                <select id="pos_grade" required>
                                    <option value="" disabled selected>اختر الصف</option>
                                    <option value="أول متوسط">أول متوسط</option>
                                    <option value="ثاني متوسط">ثاني متوسط</option>
                                    <option value="ثالث متوسط">ثالث متوسط</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pos_category">تصنيف السلوك *</label>
                            <select id="pos_category" required>
                                <option value="" disabled selected>اختر التصنيف</option>
                                <option value="مبادرة شخصية">مبادرة شخصية (مثل مساعدة زميل، نظافة)</option>
                                <option value="سلوك داعم">سلوك داعم (مثل المشاركة في تنظيم فعالية)</option>
                                <option value="إنجاز مركزي">إنجاز مركزي (مثل تمثيل المدرسة، الفوز بمسابقة)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pos_impact">وصف الحدث وأثره (التوثيق) *</label>
                            <textarea id="pos_impact" rows="3" required placeholder="مثال: بادر الطالب بتنظيم المكتبة بعد الفسحة، مما سهل على زملائه إيجاد الكتب."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pos_nominator">من رشّح الطالب؟ *</label>
                                <input type="text" id="pos_nominator" required placeholder="اسم المعلم أو الموظف">
                            </div>
                            <div class="form-group">
                                <label for="pos_approver">من اعتمد التسجيل؟ *</label>
                                <input type="text" id="pos_approver" value="أ. نواف الصبحي" required readonly>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" id="positive-submit-btn">توثيق السلوك الإيجابي</button>
                    </form>
                </div>
            </section>

            <!-- 4. صفحة تقارير الأداء -->
            <section id="reports" class="section">
                <div class="card" id="printable-area">
                    <h2>تقارير الأداء الشهري (مساعد رصد درجات نظام نور)</h2>
                    <div class="report-controls">
                        <label for="month-selector">اختر الشهر لعرض التقرير:</label>
                        <select id="month-selector"></select>
                        <button class="btn btn-print" onclick="window.print()">طباعة التقرير</button>
                    </div>
                    <div class="alert alert-info">
                        <strong>كيفية الاستخدام:</strong> هذه الصفحة تساعدك في نهاية كل شهر على تحديد الطلاب المرشحين لدرجات السلوك الإيجابي في نظام نور. التقرير يرتب الطلاب تنازليًا بناءً على "مؤشر التميز السلوكي".
                    </div>
                    <table id="reports-table">
                        <thead>
                            <tr>
                                <th>الترتيب</th>
                                <th>اسم الطالب</th>
                                <th>الصف</th>
                                <th>مؤشر التميز</th>
                                <th>تفاصيل المؤشر</th>
                                <th>درجة نور المقترحة (من 20)</th>
                            </tr>
                        </thead>
                        <tbody id="reports-tbody"></tbody>
                    </table>
                </div>
            </section>

            <!-- 5. صفحة الحوكمة والشفافية -->
            <section id="governance" class="section">
                <div class="card">
                    <h2>فلسفة وحوكمة نظام السلوك الطلابي</h2>
                    <div class="alert alert-info">
                        <strong>للمشرف التربوي وولي الأمر:</strong> هذه الصفحة توضح المبادئ التي يقوم عليها النظام لضمان العدالة والشفافية وتقليل العبء الإداري.
                    </div>

                    <h3>1. فلسفة النظام: رصد الاستثناءات</h3>
                    <p>يقوم النظام على مبدأ "الثقة والالتزام الافتراضي". نحن نفترض أن جميع طلابنا ملتزمون ومنضبطون، وهذا هو الأصل. لذلك، لا يتم إدخال أسماء جميع الطلاب يوميًا، بل يتم رصد وتوثيق "الاستثناءات" فقط، سواء كانت مخالفات سلوكية أو سلوكيات إيجابية مميزة.</p>
                    <ul>
                        <li><strong>لماذا لا يتم إدخال جميع الأسماء؟</strong> لتقليل العبء الإداري، وتركيز جهود وكيل شؤون الطلاب على المتابعة التربوية للحالات التي تتطلب ذلك، بدلاً من إضاعة الوقت في إدخال بيانات روتينية.</li>
                        <li><strong>الطالب غير المسجل:</strong> أي طالب لا يوجد له سجل مخالفة في النظام، يعتبر تلقائيًا حاصلاً على الدرجة الكاملة في بنود الالتزام والانضباط.</li>
                    </ul>

                    <h3>2. آلية احتساب الدرجات</h3>
                    <p>الدرجات هي أداة تحفيزية وليست عقابية. يتم منحها أو خصمها بناءً على أحداث موثقة.</p>
                    <ul>
                        <li><strong>الالتزام والانضباط:</strong> درجة كاملة للجميع افتراضيًا. يُخصم منها فقط عند تسجيل مخالفة (مثل تأخر أو مخالفة زي).</li>
                        <li><strong>السلوك الإيجابي المميز (الحدثي):</strong> هي درجات إضافية تُمنح للأعمال الاستثنائية والمبادرات التي تتجاوز السلوك اليومي المتوقع. لها سقف أعلى (10 درجات شهريًا) لمنع التضخم، وتتطلب توثيقًا واضحًا للحدث وأثره.</li>
                    </ul>

                    <h3>3. آلية استرداد الدرجات (التعويض الأسبوعي)</h3>
                    <p>إيمانًا بالجانب الإصلاحي، يمكن للطالب استرداد درجة المخالفة. آلية الاسترداد تجيب على سؤال "هل تحسن سلوك الطالب؟".</p>
                    <ul>
                        <li>عند تسجيل مخالفة، يتم خصم الدرجة وتصبح حالتها <strong>"مخصومة"</strong>.</li>
                        <li>إذا مر أسبوع كامل دون أن يكرر الطالب نفس المخالفة، يتم استرداد الدرجة تلقائيًا وتصبح حالتها <strong>"مستردة"</strong>.</li>
                        <li>هذا المنطق يطبق تلقائيًا عبر النظام، مما يعزز فرصة الطالب للتحسن دون الحاجة لإجراء إداري إضافي.</li>
                    </ul>

                    <h3>4. الفرق بين الإجراء النظامي والتحفيزي</h3>
                    <ul>
                        <li><strong>الإجراء التحفيزي (هذا النظام):</strong> هو نظام درجات داخلي يهدف للتشجيع والإصلاح. نتائجه تظهر في شكل شهادات شكر، تكريم، وأولوية في الأنشطة.</li>
                        <li><strong>الإجراء النظامي (لائحة الوزارة):</strong> هي الإجراءات الرسمية المتبعة في المخالفات الجسيمة (مثل استدعاء ولي الأمر، التعهد، ...إلخ) وتُطبق بشكل مستقل عن هذا النظام التحفيزي.</li>
                    </ul>

                    <h3>5. آلية الاعتماد والشفافية</h3>
                    <p>لضمان الموثوقية أمام الإشراف المدرسي وأولياء الأمور، كل عملية رصد في النظام تجيب على الأسئلة التالية:</p>
                    <ul>
                        <li><strong>ماذا حدث؟</strong> (نوع المخالفة أو السلوك الإيجابي)</li>
                        <li><strong>متى حدث؟</strong> (تاريخ ووقت التسجيل)</li>
                        <li><strong>من الطالب؟</strong> (الاسم والصف)</li>
                        <li><strong>على أي أساس تم التسجيل؟</strong> (توثيق الحدث وأثره، ومن رشح الطالب)</li>
                        <li><strong>من اعتمد التسجيل؟</strong> (اسم الموظف المسؤول، وهو وكيل شؤون الطلاب افتراضيًا)</li>
                    </ul>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Global data cache
        let allRecords = [];

        // --- FIREBASE DATA FUNCTIONS ---
        async function loadDataFromFirebase() {
            try {
                loadingAlert.style.display = 'block';
                const q = query(collection(db, 'behavior_records'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                allRecords = [];
                querySnapshot.forEach((doc) => {
                    allRecords.push({ id: doc.id, ...doc.data() });
                });
                
                loadingAlert.style.display = 'none';
                return allRecords;
            } catch (error) {
                console.error("خطأ في تحميل البيانات:", error);
                loadingAlert.style.display = 'none';
                alert('حدث خطأ في تحميل البيانات من Firebase');
                return [];
            }
        }

        async function saveToFirebase(record) {
            try {
                const docRef = await addDoc(collection(db, 'behavior_records'), record);
                console.log("تم حفظ السجل بنجاح:", docRef.id);
                return true;
            } catch (error) {
                console.error("خطأ في حفظ البيانات:", error);
                alert('حدث خطأ في حفظ البيانات');
                return false;
            }
        }

        // Real-time listener for data updates
        function setupRealtimeListener() {
            const q = query(collection(db, 'behavior_records'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                allRecords = [];
                snapshot.forEach((doc) => {
                    allRecords.push({ id: doc.id, ...doc.data() });
                });
                updateDashboard();
            });
        }

        // --- NAVIGATION ---
        function showSection(sectionId) {
            sections.forEach(section => section.classList.remove('active'));
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            const el = document.getElementById(sectionId);
            if (el) el.classList.add('active');
            
            const btnEl = document.querySelector(`.nav button[onclick="showSection('${sectionId}')"]`);
            if (btnEl) btnEl.classList.add('active');

            if (sectionId === 'dashboard') updateDashboard();
            if (sectionId === 'reports') generateReport();
        }
        window.showSection = showSection;

        // --- CORE LOGIC ---
        function processRecoveries() {
            const now = Date.now();
            const recoveryMillis = RECOVERY_PERIOD_DAYS * 24 * 60 * 60 * 1000;

            allRecords.forEach(record => {
                if (record.type === 'violation' && record.status === 'makhsouma') {
                    if (now - record.timestamp > recoveryMillis) {
                        const hasRepeated = allRecords.some(r => 
                            r.type === 'violation' &&
                            r.studentName === record.studentName &&
                            r.violationType === record.violationType &&
                            r.timestamp > record.timestamp &&
                            r.timestamp <= now
                        );
                        if (!hasRepeated) {
                            record.status = 'mustaradda';
                        }
                    }
                }
            });
            return allRecords;
        }

        function updateDashboard() {
            const data = processRecoveries();
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            startOfWeek.setHours(0, 0, 0, 0);

            const weeklyData = data.filter(r => r.timestamp >= startOfWeek.getTime());
            const weeklyViolations = weeklyData.filter(r => r.type === 'violation');
            const weeklyPositives = weeklyData.filter(r => r.type === 'positive');
            const weeklyRecoveries = data.filter(r => r.status === 'mustaradda' && new Date(r.timestamp) >= startOfWeek).length;

            const violationTypes = {};
            weeklyViolations.forEach(v => { 
                violationTypes[v.violationType] = (violationTypes[v.violationType] || 0) + 1; 
            });
            const mostCommonViolation = Object.keys(violationTypes).length > 0 ? 
                Object.keys(violationTypes).reduce((a, b) => violationTypes[a] > violationTypes[b] ? a : b) : 'لا يوجد';

            const positiveCategories = {};
            weeklyPositives.forEach(p => { 
                positiveCategories[p.category] = (positiveCategories[p.category] || 0) + 1; 
            });
            const mostCommonPositive = Object.keys(positiveCategories).length > 0 ? 
                Object.keys(positiveCategories).reduce((a, b) => positiveCategories[a] > positiveCategories[b] ? a : b) : 'لا يوجد';

            dashboardGrid.innerHTML = `
                <div class="stat-card violations">
                    <div class="value">${weeklyViolations.length}</div>
                    <div class="label">مخالفة مسجلة هذا الأسبوع</div>
                </div>
                <div class="stat-card positives">
                    <div class="value">${weeklyPositives.length}</div>
                    <div class="label">سلوك إيجابي مميز هذا الأسبوع</div>
                </div>
                <div class="stat-card recoveries">
                    <div class="value">${weeklyRecoveries}</div>
                    <div class="label">حالة استرداد درجات هذا الأسبوع</div>
                </div>
                <div class="stat-card commitment">
                    <div class="value">${mostCommonViolation}</div>
                    <div class="label">أكثر المخالفات تكرارًا</div>
                </div>
                <div class="stat-card commitment" style="border-color: var(--success-color);">
                    <div class="value" style="color: var(--success-color);">${mostCommonPositive}</div>
                    <div class="label">أكثر السلوكيات الإيجابية ظهورًا</div>
                </div>
            `;
        }

        // --- Reports Page Logic ---
        function populateMonthSelector() {
            const months = new Set();
            allRecords.forEach(r => {
                const date = new Date(r.timestamp);
                months.add(`${date.getFullYear()}-${date.getMonth()}`);
            });

            monthSelector.innerHTML = '';
            const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            
            if (months.size === 0) {
                const now = new Date();
                months.add(`${now.getFullYear()}-${now.getMonth()}`);
            }

            Array.from(months).sort().reverse().forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = `${monthNames[parseInt(month)]} ${year}`;
                monthSelector.appendChild(option);
            });
        }

        function generateReport() {
            populateMonthSelector();
            const selectedMonthKey = monthSelector.value;
            if (!selectedMonthKey) {
                reportsTbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لا توجد بيانات لعرضها.</td></tr>`;
                return;
            }

            const [year, month] = selectedMonthKey.split('-').map(Number);
            const data = processRecoveries();
            const monthlyData = data.filter(r => {
                const date = new Date(r.timestamp);
                return date.getFullYear() === year && date.getMonth() === month;
            });

            const studentScores = {};
            monthlyData.forEach(r => {
                if (!studentScores[r.studentName]) {
                    studentScores[r.studentName] = { 
                        name: r.studentName, 
                        grade: r.grade, 
                        positivePoints: 0, 
                        violationCount: 0, 
                        recoveredCount: 0 
                    };
                }
                const student = studentScores[r.studentName];
                if (r.type === 'positive') {
                    student.positivePoints += r.points;
                } else if (r.type === 'violation') {
                    student.violationCount++;
                    if (r.status === 'mustaradda') student.recoveredCount++;
                }
            });

            const rankedStudents = Object.values(studentScores).map(student => {
                const unrecoveredViolations = student.violationCount - student.recoveredCount;
                student.excellenceIndex = (student.positivePoints * 2) + student.recoveredCount - unrecoveredViolations;
                return student;
            }).sort((a, b) => b.excellenceIndex - a.excellenceIndex);

            renderReportTable(rankedStudents);
        }

        function renderReportTable(rankedStudents) {
            if (rankedStudents.length === 0) {
                reportsTbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">لا توجد سجلات لهذا الشهر. جميع الطلاب ملتزمون افتراضيًا.</td></tr>`;
                return;
            }
            reportsTbody.innerHTML = rankedStudents.map((student, index) => {
                const unrecoveredViolations = student.violationCount - student.recoveredCount;
                const details = `<span class="points-positive">+${student.positivePoints} إيجابي</span>, <span class="no-records">${student.recoveredCount} استرداد</span>, <span class="points-negative">${unrecoveredViolations} مخالفات</span>`;
                
                let noorGrade = 15;
                if (student.excellenceIndex > 10) noorGrade = 20;
                else if (student.excellenceIndex > 5) noorGrade = 18;
                else if (student.excellenceIndex > 0) noorGrade = 16;
                else if (student.excellenceIndex <= 0 && student.violationCount === 0) noorGrade = 15;
                else noorGrade = 10;

                return `<tr>
                    <td>${index + 1}</td>
                    <td><strong>${student.name}</strong></td>
                    <td>${student.grade}</td>
                    <td>${student.excellenceIndex}</td>
                    <td>${details}</td>
                    <td><strong>${noorGrade}</strong></td>
                </tr>`;
            }).join('');
        }

        // --- FORM SUBMISSIONS ---
        violationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('violation-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> جاري الحفظ...';
            
            const newViolation = {
                type: 'violation',
                studentName: document.getElementById('vio_student_name').value.trim(),
                grade: document.getElementById('vio_grade').value,
                violationType: document.getElementById('vio_type').value,
                points: VIOLATION_POINTS[document.getElementById('vio_type').value] || -2,
                recorder: document.getElementById('vio_recorder').value,
                timestamp: Date.now(),
                status: 'makhsouma'
            };
            
            const success = await saveToFirebase(newViolation);
            
            if (success) {
                const successMsg = document.getElementById('violation-success');
                successMsg.textContent = `تم تسجيل المخالفة للطالب: ${newViolation.studentName} بنجاح`;
                successMsg.style.display = 'block';
                
                violationForm.reset();
                
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'تسجيل المخالفة';
        });

        positiveForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('positive-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> جاري الحفظ...';
            
            const category = document.getElementById('pos_category').value;
            const newPositive = {
                type: 'positive',
                studentName: document.getElementById('pos_student_name').value.trim(),
                grade: document.getElementById('pos_grade').value,
                category: category,
                impact: document.getElementById('pos_impact').value.trim(),
                nominator: document.getElementById('pos_nominator').value.trim(),
                approver: document.getElementById('pos_approver').value,
                points: POSITIVE_BEHAVIOR_POINTS[category] || 2,
                timestamp: Date.now()
            };
            
            const success = await saveToFirebase(newPositive);
            
            if (success) {
                const successMsg = document.getElementById('positive-success');
                successMsg.textContent = `تم توثيق السلوك الإيجابي للطالب: ${newPositive.studentName} بنجاح`;
                successMsg.style.display = 'block';
                
                positiveForm.reset();
                
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 5000);
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'توثيق السلوك الإيجابي';
        });

        // --- EVENT LISTENERS ---
        monthSelector.addEventListener('change', generateReport);

        // --- INITIAL LOAD ---
        async function initialize() {
            await loadDataFromFirebase();
            setupRealtimeListener();
            updateDashboard();
        }

        initialize();
    </script>
</body>
</html> Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7mn5gg8LDOwnYsqmxd2UwdiDWNRPuoAQ",
            authDomain: "top10-a6e0e.firebaseapp.com",
            projectId: "top10-a6e0e",
            storageBucket: "top10-a6e0e.firebasestorage.app",
            messagingSenderId: "985038639156",
            appId: "1:985038639156:web:af5c4031f50ddfc85b3a61",
            measurementId: "G-LXG3X6WXEE"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CONFIGURATION ---
        const POSITIVE_BEHAVIOR_POINTS = { 
            'مبادرة شخصية': 2, 
            'سلوك داعم': 3, 
            'إنجاز مركزي': 5 
        };
        const VIOLATION_POINTS = { 
            'تأخر صباحي': -2, 
            'مخالفة زي مدرسي': -1, 
            'إخلال بنظام الحصة': -3, 
            'إهمال الواجبات': -1, 
            'أخرى': -2 
        };
        const RECOVERY_PERIOD_DAYS = 7;

        // --- DOM ELEMENTS ---
        const sections = document.querySelectorAll('.section');
        const navButtons = document.querySelectorAll('.nav button');
        const dashboardGrid = document.getElementById('dashboard-grid');
        const violationForm = document.getElementById('violationForm');
        const positiveForm = document.getElementById('positiveForm');
        const monthSelector = document.getElementById('month-selector');
        const reportsTbody = document.getElementById('reports-tbody');
        const loadingAlert = document.getElementById('loading-alert');

        //
