<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة مؤشرات التقويم المدرسي</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .domain-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .domain-header {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
            padding: 20px;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .progress-indicator {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .table-container {
            padding: 0;
        }
        
        .custom-table {
            margin: 0;
            font-size: 0.9rem;
        }
        
        .custom-table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 15px 10px;
        }
        
        .custom-table td {
            padding: 12px 10px;
            border-top: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-complete {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-incomplete {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .btn-view-docs {
            padding: 5px 12px;
            font-size: 0.8rem;
            border-radius: 15px;
        }
        
        .btn-export {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            margin: 20px;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
        }
        
        .documents-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .document-item {
            background: white;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 5px;
            border-right: 3px solid #28a745;
        }
        
        .comments-section {
            margin-top: 20px;
        }
        
        .progress-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .school-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-field {
            margin-bottom: 15px;
        }
        
        .info-field label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            display: block;
        }
        
        .info-field input {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="text-center">
                <h1><i class="fas fa-school"></i> نظام متابعة مؤشرات التقويم المدرسي</h1>
                <p class="mb-0">وفقاً للدليل الإسترشادي لأخصائي التقويم المدرسي - هيئة تقويم التعليم والتدريب</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- School Information -->
        <div class="school-info">
            <h4><i class="fas fa-info-circle"></i> معلومات المدرسة</h4>
            <div class="row">
                <div class="col-md-4">
                    <div class="info-field">
                        <label>اسم المدرسة:</label>
                        <input type="text" id="schoolName" placeholder="أدخل اسم المدرسة">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-field">
                        <label>اسم المدير:</label>
                        <input type="text" id="principalName" placeholder="أدخل اسم المدير">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-field">
                        <label>تاريخ التقرير:</label>
                        <input type="date" id="reportDate">
                    </div>
                </div>
            </div>
        </div>

        <!-- Domain 1: School Management -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-cogs"></i> مجال الإدارة المدرسية
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-1" style="width: 0%"></div>
                </div>
                <small id="progress-text-1">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="15%">المؤشر</th>
                            <th width="20%">المسؤول</th>
                            <th width="15%">تاريخ المتابعة</th>
                            <th width="15%">الحالة</th>
                            <th width="10%">نسبة الإنجاز</th>
                            <th width="15%">الوثائق</th>
                            <th width="10%">الملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-1-body">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(1)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 2: Teaching and Learning -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-chalkboard-teacher"></i> مجال التعليم والتعلم
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-2" style="width: 0%"></div>
                </div>
                <small id="progress-text-2">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="15%">المؤشر</th>
                            <th width="20%">المسؤول</th>
                            <th width="15%">تاريخ المتابعة</th>
                            <th width="15%">الحالة</th>
                            <th width="10%">نسبة الإنجاز</th>
                            <th width="15%">الوثائق</th>
                            <th width="10%">الملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-2-body">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(2)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 3: Learning Outcomes -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-graduation-cap"></i> مجال نواتج التعلم
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-3" style="width: 0%"></div>
                </div>
                <small id="progress-text-3">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="15%">المؤشر</th>
                            <th width="20%">المسؤول</th>
                            <th width="15%">تاريخ المتابعة</th>
                            <th width="15%">الحالة</th>
                            <th width="10%">نسبة الإنجاز</th>
                            <th width="15%">الوثائق</th>
                            <th width="10%">الملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-3-body">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(3)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 4: School Environment -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-shield-alt"></i> مجال البيئة المدرسية
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-4" style="width: 0%"></div>
                </div>
                <small id="progress-text-4">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="15%">المؤشر</th>
                            <th width="20%">المسؤول</th>
                            <th width="15%">تاريخ المتابعة</th>
                            <th width="15%">الحالة</th>
                            <th width="10%">نسبة الإنجاز</th>
                            <th width="15%">الوثائق</th>
                            <th width="10%">الملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-4-body">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(4)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Documents Modal -->
    <div class="modal fade" id="documentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">الوثائق والسجلات المطلوبة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="documents-section">
                        <h6><i class="fas fa-file-alt"></i> الوثائق المطلوبة:</h6>
                        <div id="requiredDocuments">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="comments-section">
                        <h6><i class="fas fa-comments"></i> مرئيات وملاحظات المسؤول:</h6>
                        <textarea class="form-control" id="modalComments" rows="4" placeholder="أضف ملاحظاتك هنا..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-success" onclick="saveComments()">حفظ الملاحظات</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data structure for indicators
        const indicatorsData = {
            1: { // School Management
                title: "مجال الإدارة المدرسية",
                indicators: [
                    {
                        code: "1-1-1-1",
                        title: "تضع المدرسة خطة تشغيلية مكتملة العناصر",
                        documents: ["سجل الخطة التشغيلية", "سجل برامج الخطة التشغيلية", "سجل اللجان المدرسية", "سجل التكليفات"]
                    },
                    {
                        code: "1-1-1-2", 
                        title: "تتابع المدرسة تنفيذ خطتها وتطورها",
                        documents: ["سجل الخطة التشغيلية (قسم المتابعة والتقويم)", "سجل برامج النشاط", "سجل برامج الإرشاد", "سجل اللجنة الإدارية", "سجل توثيق البرامج", "سجل تطوير وتحسين الخطة التشغيلية"]
                    },
                    {
                        code: "1-2-1-1",
                        title: "تعزز المدرسة القيم الإسلامية والهوية الوطنية",
                        documents: ["سجل لجنة التوجيه والإرشاد", "سجل التوجيه والإرشاد", "سجل الأنشطة والبرامج"]
                    },
                    {
                        code: "1-2-1-2",
                        title: "تلتزم المدرسة بقيم مهنة التعليم وأخلاقياتها",
                        documents: ["سجل الاجتماعات", "سجل التبليغات", "سجل البرامج والأنشطة", "نشرات", "خطة متابعة السلوك الوظيفي", "سجل التحفيز والتكريم", "سجل المخالفات", "سجل حصر الغياب والتأخر", "سجل استئذان الموظفين"]
                    },
                    {
                        code: "1-2-1-3",
                        title: "توفر المدرسة مناخًا آمنًا للتعلم والنمو",
                        documents: ["سجل البرامج الوقائية والعلاجية", "سجل التوجيه والإرشاد", "سجل مجالس الحوار الطلابي", "سجل المخالفات السلوكية", "سجل الحالات الطارئة"]
                    },
                    {
                        code: "1-2-1-4",
                        title: "تنشر المدرسة قواعد السلوك والمواظبة",
                        documents: ["سجل التوجيه والإرشاد", "سجل الانضباط المدرسي", "سجل التوقيع على قواعد السلوك والمواظبة", "سجل الحالات الطارئة", "سجل المخالفات السلوكية", "سجل البرامج الوقائية والعلاجية", "سجل تعزيز السلوك الإيجابي"]
                    },
                    {
                        code: "1-2-1-5",
                        title: "توفر المدرسة برامج وأنشطة تربوية داعمة للسلوك الإيجابي",
                        documents: ["سجل تعزيز السلوك الإيجابي", "سجل لجنة التوجيه والإرشاد", "سجل التوجيه والإرشاد", "سجل المخالفات السلوكية"]
                    },
                    {
                        code: "1-2-1-6",
                        title: "توفر المدرسة برامج وأنشطة إثرائية لتطوير مواهب المتعلمين",
                        documents: ["سجل الأنشطة الإثرائية", "سجل الأنشطة والبرامج", "سجل لجنة التوجيه والإرشاد", "سجل الموهوبين", "سجل لجنة التميز", "سجل المسابقات"]
                    },
                    {
                        code: "1-3-1-1",
                        title: "تعزز المدرسة العمل التعاوني والعلاقات الإيجابية",
                        documents: ["سجل الخطة التشغيلية", "سجل البرامج والأنشطة", "سجل النمو المهني"]
                    },
                    {
                        code: "1-3-1-2",
                        title: "تعزز المدرسة مشاركة الأسرة في تعلم أبنائها",
                        documents: ["سجل استطلاع الرأي والاستبانات", "سجل التواصل مع أولياء الأمور", "ملف البرامج والأنشطة", "سجل التوجيه والإرشاد", "سجل مجالس أولياء الأمور"]
                    },
                    {
                        code: "1-3-1-3",
                        title: "تعزز المدرسة الشراكة المجتمعية لدعم التعلم",
                        documents: ["سجل الخطة التشغيلية", "سجل البرامج والأنشطة", "سجل الشراكة المجتمعية", "سجل التوجيه والإرشاد"]
                    },
                    {
                        code: "1-4-1-1",
                        title: "توفر المدرسة كادرًا تعليميًا مكتملًا ومؤهلًا",
                        documents: ["سجل أحوال الموظفين", "سجل التكاليف", "سجل اللجنة الإدارية", "سجل توزيع الأنصبة", "الجدول المدرسي", "بيانات الكادر التعليمي من نظام نور"]
                    },
                    {
                        code: "1-4-1-2",
                        title: "توفر المدرسة كادرًا إداريًا مكتملًا ومؤهلًا",
                        documents: ["سجل أحوال الموظفين", "سجل التكاليف", "سجل اللجنة الإدارية", "بيانات الكادر الإداري من نظام نور", "سجل الوصف الوظيفي"]
                    },
                    {
                        code: "1-4-1-3",
                        title: "تظهر المدرسة ثباتًا واستدامة مالية",
                        documents: ["سجل الخطة المالية", "سجل الموازنة المالية", "سجل فريق الصندوق المدرسي", "سجل السياسات المالية", "سجل تحصيل الرسوم", "استمارة الرسوم الدراسية", "الموقع الإلكتروني للمدرسة"]
                    },
                    {
                        code: "1-4-1-4",
                        title: "تشجع المدرسة منسوبيها للحصول على الرخصة المهنية",
                        documents: ["سجل الرخصة المهنية", "سجل النمو المهني"]
                    },
                    {
                        code: "1-4-1-5",
                        title: "تدعم المدرسة التطوير المهني لمنسوبيها",
                        documents: ["سجل النمو المهني"]
                    },
                    {
                        code: "1-4-1-6",
                        title: "تطبق المدرسة التقويم الذاتي المبني على المعايير",
                        documents: ["سجل لجنة التميز", "سجل التقويم الذاتي"]
                    },
                    {
                        code: "1-4-1-7",
                        title: "تنفذ المدرسة خطة للتحسين بناءً على نتائج التقويم",
                        documents: ["سجل تطوير وتحسين الخطة التشغيلية", "سجل اللجنة الإدارية"]
                    }
                ]
            },
            2: { // Teaching and Learning
                title: "مجال التعليم والتعلم",
                indicators: [
                    {
                        code: "2-1-1-2",
                        title: "تدعم المدرسة تنفيذ المناهج لتحقيق نواتج التعلم",
                        documents: ["عينة من ملفات إنجاز المعلمين", "عينة من الأنشطة الصفية", "عينة من خطة توزيع المناهج", "ملف متابعة تنفيذ المنهج"]
                    },
                    {
                        code: "2-1-1-6",
                        title: "تنمي المدرسة المهارات القرائية والعددية الأساسية",
                        documents: ["سجل الأنشطة الإثرائية", "سجل الأنشطة العلاجية", "سجل المسابقات", "نتائج الاختبارات الوطنية", "سجل تحدي القراءة", "سجل سد الفجوة (للرياضيات)"]
                    },
                    {
                        code: "2-1-1-7",
                        title: "تنمي المدرسة مهارات التفكير العليا لدى المتعلمين",
                        documents: ["عينة من الأنشطة الصفية الخاصة بالمتعلمين"]
                    },
                    {
                        code: "2-2-1-1",
                        title: "تقيم المدرسة أداء المتعلمين باستخدام أساليب متنوعة",
                        documents: ["عينة من الأنشطة الصفية الخاصة بالمتعلمين", "سجل تحضير الدروس", "سجل النمو المهني"]
                    },
                    {
                        code: "2-2-1-2",
                        title: "تحلل المدرسة نتائج التقويم وتوظفها في تحسين التعلم",
                        documents: ["سجل تحليل النتائج (لمختلف التخصصات)", "سجل الأنشطة العلاجية", "سجل الأنشطة الإثرائية"]
                    },
                    {
                        code: "2-2-1-3",
                        title: "تقدم المدرسة التغذية الراجعة للمتعلمين بانتظام",
                        documents: ["سجل متابعة أداء المتعلمين", "سجل إنجاز المتعلمين / الكتب"]
                    }
                ]
            },
            3: { // Learning Outcomes
                title: "مجال نواتج التعلم",
                indicators: [
                    {
                        code: "3-2-1-4",
                        title: "يشارك المتعلمون في الأنشطة المجتمعية والأعمال التطوعية",
                        documents: ["سجل العمل التطوعي", "سجل التوجيه والإرشاد"]
                    },
                    {
                        code: "3-2-1-5",
                        title: "يلتزم المتعلمون بقواعد السلوك والانضباط المدرسي",
                        documents: ["سجل المخالفات السلوكية", "سجل الانضباط المدرسي", "سجل التوجيه والإرشاد", "سجل التكريم"]
                    }
                ]
            },
            4: { // School Environment
                title: "مجال البيئة المدرسية",
                indicators: [
                    {
                        code: "4-2-1-1",
                        title: "تتوافر متطلبات الأمن والسلامة في جميع مرافق المدرسة",
                        documents: ["سجل لجنة الأمن والسلامة", "شهادة الأمن والسلامة من الدفاع المدني (سارية)", "سجل الموجه الصحي", "الشهادات الصحية للعاملين سارية المفعول"]
                    },
                    {
                        code: "4-2-1-2",
                        title: "تعمل المدرسة على صيانة جميع مرافق المبنى بانتظام",
                        documents: ["سجل الصيانة الدورية", "سجل لجنة الأمن والسلامة"]
                    }
                ]
            }
        };

        // Initialize data structure for tracking
        let trackingData = {};
        let currentModalIndicator = null;

        // Initialize the application
        function initializeApp() {
            loadData();
            populateTables();
            updateProgress();
            setCurrentDate();
        }

        // Set current date
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
        }

        // Load data from localStorage
        function loadData() {
            const saved = JSON.parse(localStorage.getItem('schoolEvaluationData')) || {};
            
            // Initialize tracking data for all indicators
            for (let domainId in indicatorsData) {
                if (!trackingData[domainId]) {
                    trackingData[domainId] = {};
                }
                
                indicatorsData[domainId].indicators.forEach(indicator => {
                    if (!trackingData[domainId][indicator.code]) {
                        trackingData[domainId][indicator.code] = {
                            responsible: '',
                            followupDate: '',
                            status: 'incomplete',
                            progress: 0,
                            comments: ''
                        };
                    }
                });
            }
            
            // Merge with saved data
            Object.assign(trackingData, saved);
            
            // Load school info
            document.getElementById('schoolName').value = localStorage.getItem('schoolName') || '';
            document.getElementById('principalName').value = localStorage.getItem('principalName') || '';
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('schoolEvaluationData', JSON.stringify(trackingData));
            localStorage.setItem('schoolName', document.getElementById('schoolName').value);
            localStorage.setItem('principalName', document.getElementById('principalName').value);
        }

        // Populate tables with indicators
        function populateTables() {
            for (let domainId in indicatorsData) {
                const tbody = document.getElementById(`domain-${domainId}-body`);
                tbody.innerHTML = '';
                
                indicatorsData[domainId].indicators.forEach(indicator => {
                    const data = trackingData[domainId][indicator.code];
                    const row = createIndicatorRow(domainId, indicator, data);
                    tbody.appendChild(row);
                });
            }
        }

        // Create table row for indicator
        function createIndicatorRow(domainId, indicator, data) {
            const row = document.createElement('tr');
            
            const progressColor = data.progress >= 100 ? '#28a745' : data.progress >= 50 ? '#ffc107' : '#dc3545';
            
            row.innerHTML = `
                <td>
                    <strong>${indicator.code}</strong><br>
                    <small class="text-muted">${indicator.title}</small>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${data.responsible}" 
                           onchange="updateIndicatorData('${domainId}', '${indicator.code}', 'responsible', this.value)">
                </td>
                <td>
                    <input type="date" class="form-control form-control-sm" 
                           value="${data.followupDate}" 
                           onchange="updateIndicatorData('${domainId}', '${indicator.code}', 'followupDate', this.value)">
                </td>
                <td>
                    <select class="form-select form-select-sm" 
                            onchange="updateIndicatorData('${domainId}', '${indicator.code}', 'status', this.value)">
                        <option value="incomplete" ${data.status === 'incomplete' ? 'selected' : ''}>❌ غير مكتمل</option>
                        <option value="complete" ${data.status === 'complete' ? 'selected' : ''}>✅ مكتمل</option>
                    </select>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <input type="range" class="form-range me-2" min="0" max="100" 
                               value="${data.progress}" 
                               onchange="updateIndicatorData('${domainId}', '${indicator.code}', 'progress', this.value)"
                               style="width: 60px;">
                        <span class="badge" style="background-color: ${progressColor}; color: white; font-size: 0.8rem;">
                            ${data.progress}%
                        </span>
                    </div>
                </td>
                <td>
                    <button class="btn btn-outline-primary btn-view-docs" 
                            onclick="showDocuments('${domainId}', '${indicator.code}')">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </td>
                <td>
                    <button class="btn btn-outline-info btn-sm" 
                            onclick="showComments('${domainId}', '${indicator.code}')"
                            title="${data.comments || 'لا توجد ملاحظات'}">
                        <i class="fas fa-comment"></i>
                    </button>
                </td>
            `;
            
            return row;
        }

        // Update indicator data
        function updateIndicatorData(domainId, indicatorCode, field, value) {
            trackingData[domainId][indicatorCode][field] = value;
            
            // Auto-update status based on progress
            if (field === 'progress') {
                const progress = parseInt(value);
                trackingData[domainId][indicatorCode].status = progress >= 100 ? 'complete' : 'incomplete';
                populateTables();
            }
            
            updateProgress();
            saveData();
        }

        // Update progress indicators
        function updateProgress() {
            for (let domainId in indicatorsData) {
                const indicators = indicatorsData[domainId].indicators;
                let totalProgress = 0;
                
                indicators.forEach(indicator => {
                    const data = trackingData[domainId][indicator.code];
                    totalProgress += parseInt(data.progress || 0);
                });
                
                const averageProgress = Math.round(totalProgress / indicators.length);
                
                const progressBar = document.getElementById(`progress-${domainId}`);
                const progressText = document.getElementById(`progress-text-${domainId}`);
                
                if (progressBar && progressText) {
                    progressBar.style.width = `${averageProgress}%`;
                    progressText.textContent = `نسبة الإنجاز: ${averageProgress}%`;
                }
            }
        }

        // Show documents modal
        function showDocuments(domainId, indicatorCode) {
            const indicator = indicatorsData[domainId].indicators.find(ind => ind.code === indicatorCode);
            currentModalIndicator = {domainId, indicatorCode};
            
            document.getElementById('modalTitle').textContent = `الوثائق المطلوبة - المؤشر ${indicatorCode}`;
            
            const documentsContainer = document.getElementById('requiredDocuments');
            documentsContainer.innerHTML = '';
            
            indicator.documents.forEach(doc => {
                const docElement = document.createElement('div');
                docElement.className = 'document-item';
                docElement.innerHTML = `<i class="fas fa-file-alt me-2"></i>${doc}`;
                documentsContainer.appendChild(docElement);
            });
            
            // Load existing comments
            const comments = trackingData[domainId][indicatorCode].comments || '';
            document.getElementById('modalComments').value = comments;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('documentsModal'));
            modal.show();
        }

        // Show comments
        function showComments(domainId, indicatorCode) {
            showDocuments(domainId, indicatorCode);
        }

        // Save comments from modal
        function saveComments() {
            if (currentModalIndicator) {
                const comments = document.getElementById('modalComments').value;
                const {domainId, indicatorCode} = currentModalIndicator;
                
                trackingData[domainId][indicatorCode].comments = comments;
                saveData();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('documentsModal'));
                modal.hide();
                
                // Show success message
                showToast('تم حفظ الملاحظات بنجاح', 'success');
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 3000);
        }

        // Export to PDF
        function exportToPDF(domainId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get school info
            const schoolName = document.getElementById('schoolName').value || 'اسم المدرسة';
            const principalName = document.getElementById('principalName').value || 'اسم المدير';
            const reportDate = document.getElementById('reportDate').value || new Date().toISOString().split('T')[0];
            
            // Set font (Arabic support might be limited)
            doc.setFontSize(16);
            
            // Add header
            doc.text('Ministry of Education - Saudi Arabia', 20, 20);
            doc.text('School Evaluation Report', 20, 30);
            doc.setFontSize(12);
            doc.text(`School: ${schoolName}`, 20, 45);
            doc.text(`Principal: ${principalName}`, 20, 55);
            doc.text(`Date: ${reportDate}`, 20, 65);
            
            // Domain title
            const domainTitle = indicatorsData[domainId].title;
            doc.setFontSize(14);
            doc.text(`Domain: ${domainTitle}`, 20, 85);
            
            // Table headers
            let yPosition = 100;
            doc.setFontSize(10);
            doc.text('Indicator', 20, yPosition);
            doc.text('Responsible', 70, yPosition);
            doc.text('Date', 110, yPosition);
            doc.text('Status', 140, yPosition);
            doc.text('Progress', 170, yPosition);
            
            yPosition += 10;
            
            // Add indicators data
            indicatorsData[domainId].indicators.forEach(indicator => {
                const data = trackingData[domainId][indicator.code];
                
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(indicator.code, 20, yPosition);
                doc.text(data.responsible || '-', 70, yPosition);
                doc.text(data.followupDate || '-', 110, yPosition);
                doc.text(data.status === 'complete' ? 'Complete' : 'Incomplete', 140, yPosition);
                doc.text(`${data.progress}%`, 170, yPosition);
                
                yPosition += 8;
                
                // Add comments if available
                if (data.comments) {
                    doc.setFontSize(8);
                    doc.text(`Comments: ${data.comments.substring(0, 50)}...`, 20, yPosition);
                    yPosition += 6;
                    doc.setFontSize(10);
                }
            });
            
            // Calculate overall progress
            let totalProgress = 0;
            indicatorsData[domainId].indicators.forEach(indicator => {
                const data = trackingData[domainId][indicator.code];
                totalProgress += parseInt(data.progress || 0);
            });
            const averageProgress = Math.round(totalProgress / indicatorsData[domainId].indicators.length);
            
            // Add summary
            yPosition += 20;
            doc.setFontSize(12);
            doc.text(`Overall Progress: ${averageProgress}%`, 20, yPosition);
            
            // Save PDF
            const fileName = `${domainTitle.replace(/\s+/g, '_')}_Report_${reportDate}.pdf`;
            doc.save(fileName);
            
            showToast('تم تصدير التقرير بنجاح', 'success');
        }

        // Auto-save when school info changes
        document.getElementById('schoolName').addEventListener('change', saveData);
        document.getElementById('principalName').addEventListener('change', saveData);
        document.getElementById('reportDate').addEventListener('change', saveData);

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
    </script>
</body>
</html>
