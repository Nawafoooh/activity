<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة مؤشرات التقويم المدرسي</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            font-size: 14px;
        }
        
        .header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        .header h1 { font-size: 1.5rem; }
        .header h5, .header h6 { font-size: 0.9rem; }
        
        .domain-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .domain-header {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .responsible-input {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 250px;
            margin-top: 10px;
        }
        
        .responsible-input::placeholder {
            color: rgba(255,255,255,0.8);
        }
        
        .progress-indicator {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .table-container {
            padding: 0;
            overflow-x: auto;
        }
        
        .custom-table {
            margin: 0;
            font-size: 0.85rem;
            min-width: 700px;
        }
        
        .custom-table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 12px 10px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .custom-table td {
            padding: 10px 8px;
            border-top: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .custom-table input, .custom-table select {
            font-size: 0.8rem;
            padding: 6px 8px;
        }
        
        .btn-view-docs {
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: 15px;
        }
        
        .btn-export {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            margin: 20px;
            font-size: 0.95rem;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
        }
        
        .documents-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .document-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            border-right: 4px solid #28a745;
            font-size: 0.9rem;
        }
        
        .school-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-field {
            margin-bottom: 15px;
        }
        
        .info-field label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 6px;
            display: block;
            font-size: 0.95rem;
        }
        
        .info-field input {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            font-size: 0.95rem;
        }
        
        .footer {
            background-color: #2c5530;
            color: white;
            padding: 15px 0;
            margin-top: 40px;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header { padding: 10px 0; margin-bottom: 15px; }
            .header h1 { font-size: 1.2rem; }
            .header h5, .header h6 { font-size: 0.8rem; }
            .header p { font-size: 0.75rem; }
            .domain-card { margin-bottom: 15px; border-radius: 8px; }
            .domain-header { padding: 12px; font-size: 1rem; }
            .responsible-input { width: 180px; padding: 6px 8px; }
            .school-info { padding: 15px; margin-bottom: 20px; }
            .school-info h4 { font-size: 1.1rem; }
            .custom-table { font-size: 0.75rem; min-width: 600px; }
            .custom-table th { padding: 8px 6px; font-size: 0.7rem; }
            .custom-table td { padding: 8px 6px; }
            .custom-table input, .custom-table select { font-size: 0.7rem; padding: 4px 6px; }
            .btn-view-docs { padding: 4px 8px; font-size: 0.65rem; }
            .btn-export { padding: 8px 20px; font-size: 0.85rem; margin: 15px; }
            .modal-dialog { margin: 10px; }
            .document-item { padding: 6px 10px; font-size: 0.85rem; }
            .form-range { width: 50px !important; }
            .progress-indicator { height: 4px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 0 10px; }
            .header h1 { font-size: 1rem; }
            .domain-header { font-size: 0.9rem; padding: 10px; }
            .responsible-input { width: 150px; }
            .custom-table { min-width: 500px; font-size: 0.7rem; }
            .custom-table th, .custom-table td { padding: 6px 4px; }
            .btn-export { width: 90%; margin: 10px 5%; }
            .school-info .row { --bs-gutter-x: 0.5rem; }
            .modal-dialog { margin: 5px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="text-center">
                <h6 class="mb-1">المملكة العربية السعودية</h6>
                <h5 class="mb-1">وزارة التعليم</h5>
                <h6 class="mb-3">مكتب قطاع أحد والعوالي</h6>
                <h1><i class="fas fa-school"></i> نظام متابعة مؤشرات التقويم المدرسي</h1>
                <p class="mb-0">وفقاً للدليل الإسترشادي لأخصائي التقويم المدرسي - هيئة تقويم التعليم والتدريب</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- School Information -->
        <div class="school-info">
            <h4><i class="fas fa-info-circle"></i> معلومات المدرسة</h4>
            <div class="row">
                <div class="col-md-4">
                    <div class="info-field">
                        <label>اسم المدرسة:</label>
                        <input type="text" id="schoolName" value="متوسطة المنذر بن عمرو الأنصاري">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-field">
                        <label>اسم المدير:</label>
                        <input type="text" id="principalName" value="خالد سعود المطيري">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-field">
                        <label>تاريخ التقرير:</label>
                        <input type="date" id="reportDate">
                    </div>
                </div>
            </div>
        </div>

        <!-- Domain 1: School Management -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-cogs"></i> مجال الإدارة المدرسية
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.95rem; margin-left: 10px;">المسؤول:</label>
                    <input type="text" id="domain-1-responsible" placeholder="أدخل اسم المسؤول" 
                           class="responsible-input">
                </div>
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-1" style="width: 0%"></div>
                </div>
                <small id="progress-text-1">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="25%">المؤشر</th>
                            <th width="20%">الحالة</th>
                            <th width="15%">نسبة الإنجاز</th>
                            <th width="40%">الوثائق والملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-1-body"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(1)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 2: Teaching and Learning -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-chalkboard-teacher"></i> مجال التعليم والتعلم
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.95rem; margin-left: 10px;">المسؤول:</label>
                    <input type="text" id="domain-2-responsible" placeholder="أدخل اسم المسؤول" 
                           class="responsible-input">
                </div>
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-2" style="width: 0%"></div>
                </div>
                <small id="progress-text-2">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="25%">المؤشر</th>
                            <th width="20%">الحالة</th>
                            <th width="15%">نسبة الإنجاز</th>
                            <th width="40%">الوثائق والملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-2-body"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(2)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 3: Learning Outcomes -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-graduation-cap"></i> مجال نواتج التعلم
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.95rem; margin-left: 10px;">المسؤول:</label>
                    <input type="text" id="domain-3-responsible" placeholder="أدخل اسم المسؤول" 
                           class="responsible-input">
                </div>
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-3" style="width: 0%"></div>
                </div>
                <small id="progress-text-3">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="25%">المؤشر</th>
                            <th width="20%">الحالة</th>
                            <th width="15%">نسبة الإنجاز</th>
                            <th width="40%">الوثائق والملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-3-body"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(3)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 4: School Environment -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-shield-alt"></i> مجال البيئة المدرسية
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.95rem; margin-left: 10px;">المسؤول:</label>
                    <input type="text" id="domain-4-responsible" placeholder="أدخل اسم المسؤول" 
                           class="responsible-input">
                </div>
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-4" style="width: 0%"></div>
                </div>
                <small id="progress-text-4">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="25%">المؤشر</th>
                            <th width="20%">الحالة</th>
                            <th width="15%">نسبة الإنجاز</th>
                            <th width="40%">الوثائق والملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-4-body"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(4)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="text-center">
                <p class="mb-0">نُراقب • نُقيم • نُطور</p>
                <small class="text-light">تنفيذ: نواف الصبحي</small>
            </div>
        </div>
    </footer>

    <!-- Documents Modal -->
    <div class="modal fade" id="documentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">الوثائق والسجلات المطلوبة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="documents-section">
                        <h6><i class="fas fa-file-alt"></i> الوثائق المطلوبة:</h6>
                        <div id="requiredDocuments"></div>
                    </div>
                    <div class="comments-section">
                        <h6><i class="fas fa-comments"></i> مرئيات وملاحظات المسؤول:</h6>
                        <textarea class="form-control" id="modalComments" rows="4" placeholder="أضف ملاحظاتك هنا..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-success" onclick="saveComments()">حفظ الملاحظات</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data structure for indicators
        const indicatorsData = {
            1: {
                title: "مجال الإدارة المدرسية",
                indicators: [
                    { code: "1-1-1-1", title: "تضع المدرسة خطة تشغيلية مكتملة العناصر", documents: ["سجل الخطة التشغيلية", "سجل برامج الخطة التشغيلية", "سجل اللجان المدرسية", "سجل التكليفات"] },
                    { code: "1-1-1-2", title: "تتابع المدرسة تنفيذ خطتها وتطورها", documents: ["سجل الخطة التشغيلية (قسم المتابعة والتقويم)", "سجل برامج النشاط", "سجل برامج الإرشاد", "سجل اللجنة الإدارية", "سجل توثيق البرامج", "سجل تطوير وتحسين الخطة التشغيلية"] },
                    { code: "1-2-1-1", title: "تعزز المدرسة القيم الإسلامية والهوية الوطنية", documents: ["سجل لجنة التوجيه والإرشاد", "سجل التوجيه والإرشاد", "سجل الأنشطة والبرامج"] },
                    { code: "1-2-1-2", title: "تلتزم المدرسة بقيم مهنة التعليم وأخلاقياتها", documents: ["سجل الاجتماعات", "سجل التبليغات", "سجل البرامج والأنشطة", "نشرات", "خطة متابعة السلوك الوظيفي", "سجل التحفيز والتكريم", "سجل المخالفات", "سجل حصر الغياب والتأخر", "سجل استئذان الموظفين"] },
                    { code: "1-2-1-3", title: "توفر المدرسة مناخًا آمنًا للتعلم والنمو", documents: ["سجل البرامج الوقائية والعلاجية", "سجل التوجيه والإرشاد", "سجل مجالس الحوار الطلابي", "سجل المخالفات السلوكية", "سجل الحالات الطارئة"] },
                    { code: "1-2-1-4", title: "تنشر المدرسة قواعد السلوك والمواظبة", documents: ["سجل التوجيه والإرشاد", "سجل الانضباط المدرسي", "سجل التوقيع على قواعد السلوك والمواظبة", "سجل الحالات الطارئة", "سجل المخالفات السلوكية", "سجل البرامج الوقائية والعلاجية", "سجل تعزيز السلوك الإيجابي"] },
                    { code: "1-2-1-5", title: "توفر المدرسة برامج وأنشطة تربوية داعمة للسلوك الإيجابي", documents: ["سجل تعزيز السلوك الإيجابي", "سجل لجنة التوجيه والإرشاد", "سجل التوجيه والإرشاد", "سجل المخالفات السلوكية"] },
                    { code: "1-2-1-6", title: "توفر المدرسة برامج وأنشطة إثرائية لتطوير مواهب المتعلمين", documents: ["سجل الأنشطة الإثرائية", "سجل الأنشطة والبرامج", "سجل لجنة التوجيه والإرشاد", "سجل الموهوبين", "سجل لجنة التميز", "سجل المسابقات"] },
                    { code: "1-3-1-1", title: "تعزز المدرسة العمل التعاوني والعلاقات الإيجابية", documents: ["سجل الخطة التشغيلية", "سجل البرامج والأنشطة", "سجل النمو المهني"] },
                    { code: "1-3-1-2", title: "تعزز المدرسة مشاركة الأسرة في تعلم أبنائها", documents: ["سجل استطلاع الرأي والاستبانات", "سجل التواصل مع أولياء الأمور", "ملف البرامج والأنشطة", "سجل التوجيه والإرشاد", "سجل مجالس أولياء الأمور"] },
                    { code: "1-3-1-3", title: "تعزز المدرسة الشراكة المجتمعية لدعم التعلم", documents: ["سجل الخطة التشغيلية", "سجل البرامج والأنشطة", "سجل الشراكة المجتمعية", "سجل التوجيه والإرشاد"] },
                    { code: "1-4-1-1", title: "توفر المدرسة كادرًا تعليميًا مكتملًا ومؤهلًا", documents: ["سجل أحوال الموظفين", "سجل التكاليف", "سجل اللجنة الإدارية", "سجل توزيع الأنصبة", "الجدول المدرسي", "بيانات الكادر التعليمي من نظام نور"] },
                    { code: "1-4-1-2", title: "توفر المدرسة كادرًا إداريًا مكتملًا ومؤهلًا", documents: ["سجل أحوال الموظفين", "سجل التكاليف", "سجل اللجنة الإدارية", "بيانات الكادر الإداري من نظام نور", "سجل الوصف الوظيفي"] },
                    { code: "1-4-1-3", title: "تظهر المدرسة ثباتًا واستدامة مالية", documents: ["سجل الخطة المالية", "سجل الموازنة المالية", "سجل فريق الصندوق المدرسي", "سجل السياسات المالية", "سجل تحصيل الرسوم", "استمارة الرسوم الدراسية", "الموقع الإلكتروني للمدرسة"] },
                    { code: "1-4-1-4", title: "تشجع المدرسة منسوبيها للحصول على الرخصة المهنية", documents: ["سجل الرخصة المهنية", "سجل النمو المهني"] },
                    { code: "1-4-1-5", title: "تدعم المدرسة التطوير المهني لمنسوبيها", documents: ["سجل النمو المهني"] },
                    { code: "1-4-1-6", title: "تطبق المدرسة التقويم الذاتي المبني على المعايير", documents: ["سجل لجنة التميز", "سجل التقويم الذاتي"] },
                    { code: "1-4-1-7", title: "تنفذ المدرسة خطة للتحسين بناءً على نتائج التقويم", documents: ["سجل تطوير وتحسين الخطة التشغيلية", "سجل اللجنة الإدارية"] }
                ]
            },
            2: {
                title: "مجال التعليم والتعلم",
                indicators: [
                    { code: "2-1-1-2", title: "تدعم المدرسة تنفيذ المناهج لتحقيق نواتج التعلم", documents: ["عينة من ملفات إنجاز المعلمين", "عينة من الأنشطة الصفية", "عينة من خطة توزيع المناهج", "ملف متابعة تنفيذ المنهج"] },
                    { code: "2-1-1-6", title: "تنمي المدرسة المهارات القرائية والعددية الأساسية", documents: ["سجل الأنشطة الإثرائية", "سجل الأنشطة العلاجية", "سجل المسابقات", "نتائج الاختبارات الوطنية", "سجل تحدي القراءة", "سجل سد الفجوة (للرياضيات)"] },
                    { code: "2-1-1-7", title: "تنمي المدرسة مهارات التفكير العليا لدى المتعلمين", documents: ["عينة من الأنشطة الصفية الخاصة بالمتعلمين"] },
                    { code: "2-2-1-1", title: "تقيم المدرسة أداء المتعلمين باستخدام أساليب متنوعة", documents: ["عينة من الأنشطة الصفية الخاصة بالمتعلمين", "سجل تحضير الدروس", "سجل النمو المهني"] },
                    { code: "2-2-1-2", title: "تحلل المدرسة نتائج التقويم وتوظفها في تحسين التعلم", documents: ["سجل تحليل النتائج (لمختلف التخصصات)", "سجل الأنشطة العلاجية", "سجل الأنشطة الإثرائية"] },
                    { code: "2-2-1-3", title: "تقدم المدرسة التغذية الراجعة للمتعلمين بانتظام", documents: ["سجل متابعة أداء المتعلمين", "سجل إنجاز المتعلمين / الكتب"] }
                ]
            },
            3: {
                title: "مجال نواتج التعلم",
                indicators: [
                    { code: "3-2-1-4", title: "يشارك المتعلمون في الأنشطة المجتمعية والأعمال التطوعية", documents: ["سجل العمل التطوعي", "سجل التوجيه والإرشاد"] },
                    { code: "3-2-1-5", title: "يلتزم المتعلمون بقواعد السلوك والانضباط المدرسي", documents: ["سجل المخالفات السلوكية", "سجل الانضباط المدرسي", "سجل التوجيه والإرشاد", "سجل التكريم"] }
                ]
            },
            4: {
                title: "مجال البيئة المدرسية",
                indicators: [
                    { code: "4-2-1-1", title: "تتوافر متطلبات الأمن والسلامة في جميع مرافق المدرسة", documents: ["سجل لجنة الأمن والسلامة", "شهادة الأمن والسلامة من الدفاع المدني (سارية)", "سجل الموجه الصحي", "الشهادات الصحية للعاملين سارية المفعول"] },
                    { code: "4-2-1-2", title: "تعمل المدرسة على صيانة جميع مرافق المبنى بانتظام", documents: ["سجل الصيانة الدورية", "سجل لجنة الأمن والسلامة"] }
                ]
            }
        };

        // Initialize data
        let trackingData = {};
        let currentModalIndicator = null;

        function initializeApp() {
            loadData();
            populateTables();
            updateProgress();
            setCurrentDate();
        }

        function setCurrentDate() {
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
        }

        function loadData() {
            for (let domainId in indicatorsData) {
                if (!trackingData[domainId]) trackingData[domainId] = {};
                indicatorsData[domainId].indicators.forEach(indicator => {
                    if (!trackingData[domainId][indicator.code]) {
                        trackingData[domainId][indicator.code] = {
                            status: 'incomplete', progress: 0, comments: ''
                        };
                    }
                });
            }
        }

        function populateTables() {
            for (let domainId in indicatorsData) {
                const tbody = document.getElementById(`domain-${domainId}-body`);
                tbody.innerHTML = '';
                indicatorsData[domainId].indicators.forEach(indicator => {
                    const data = trackingData[domainId][indicator.code];
                    const row = createIndicatorRow(domainId, indicator, data);
                    tbody.appendChild(row);
                });
            }
        }

        function createIndicatorRow(domainId, indicator, data) {
            const row = document.createElement('tr');
            const progressColor = data.progress >= 100 ? '#28a745' : data.progress >= 50 ? '#ffc107' : '#dc3545';
            
            row.innerHTML = `
                <td>
                    <strong>${indicator.code}</strong><br>
                    <small class="text-muted">${indicator.title}</small>
                </td>
                <td>
                    <select class="form-select form-select-sm" 
                            onchange="updateIndicatorData('${domainId}', '${indicator.code}', 'status', this.value)">
                        <option value="incomplete" ${data.status === 'incomplete' ? 'selected' : ''}>❌ غير مكتمل</option>
                        <option value="complete" ${data.status === 'complete' ? 'selected' : ''}>✅ مكتمل</option>
                    </select>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <input type="range" class="form-range me-2" min="0" max="100" 
                               value="${data.progress}" 
                               onchange="updateIndicatorData('${domainId}', '${indicator.code}', 'progress', this.value)"
                               style="width: 80px;">
                        <span class="badge" style="background-color: ${progressColor}; color: white; font-size: 0.8rem;">
                            ${data.progress}%
                        </span>
                    </div>
                </td>
                <td>
                    <button class="btn btn-outline-primary btn-view-docs w-100" 
                            onclick="showDocuments('${domainId}', '${indicator.code}')">
                        <i class="fas fa-eye"></i> عرض الوثائق والملاحظات
                    </button>
                </td>
            `;
            return row;
        }

        function updateIndicatorData(domainId, indicatorCode, field, value) {
            trackingData[domainId][indicatorCode][field] = value;
            if (field === 'progress') {
                trackingData[domainId][indicatorCode].status = parseInt(value) >= 100 ? 'complete' : 'incomplete';
                populateTables();
            }
            updateProgress();
        }

        function updateProgress() {
            for (let domainId in indicatorsData) {
                const indicators = indicatorsData[domainId].indicators;
                let totalProgress = 0;
                indicators.forEach(indicator => {
                    totalProgress += parseInt(trackingData[domainId][indicator.code].progress || 0);
                });
                const averageProgress = Math.round(totalProgress / indicators.length);
                const progressBar = document.getElementById(`progress-${domainId}`);
                const progressText = document.getElementById(`progress-text-${domainId}`);
                if (progressBar && progressText) {
                    progressBar.style.width = `${averageProgress}%`;
                    progressText.textContent = `نسبة الإنجاز: ${averageProgress}%`;
                }
            }
        }

        function showDocuments(domainId, indicatorCode) {
            const indicator = indicatorsData[domainId].indicators.find(ind => ind.code === indicatorCode);
            currentModalIndicator = {domainId, indicatorCode};
            document.getElementById('modalTitle').textContent = `الوثائق المطلوبة - المؤشر ${indicatorCode}`;
            const documentsContainer = document.getElementById('requiredDocuments');
            documentsContainer.innerHTML = '';
            indicator.documents.forEach(doc => {
                const docElement = document.createElement('div');
                docElement.className = 'document-item';
                docElement.innerHTML = `<i class="fas fa-file-alt me-2"></i>${doc}`;
                documentsContainer.appendChild(docElement);
            });
            const comments = trackingData[domainId][indicatorCode].comments || '';
            document.getElementById('modalComments').value = comments;
            new bootstrap.Modal(document.getElementById('documentsModal')).show();
        }

        function saveComments() {
            if (currentModalIndicator) {
                const comments = document.getElementById('modalComments').value;
                const {domainId, indicatorCode} = currentModalIndicator;
                trackingData[domainId][indicatorCode].comments = comments;
                bootstrap.Modal.getInstance(document.getElementById('documentsModal')).hide();
                showToast('تم حفظ الملاحظات بنجاح', 'success');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `<div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>`;
            document.body.appendChild(toast);
            setTimeout(() => { if (toast.parentElement) toast.remove(); }, 3000);
        }

        // Professional PDF Export with Arabic Support
        async function exportToPDF(domainId) {
            try {
                showToast('جاري إنشاء التقرير...', 'info');
                
                // Import jsPDF
                const { jsPDF } = window.jspdf;
                
                // Create new PDF document with A4 size
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    putOnlyUsedFonts: true
                });
                
                // Set document properties
                pdf.setProperties({
                    title: `تقرير متابعة مؤشرات التقويم المدرسي - ${indicatorsData[domainId]?.title}`,
                    subject: 'تقرير متابعة مؤشرات التقويم المدرسي',
                    author: 'نواف الصبحي',
                    creator: 'نظام متابعة مؤشرات التقويم المدرسي',
                    producer: 'هيئة تقويم التعليم والتدريب'
                });
                
                await generateSinglePagePDFReport(pdf, domainId);
                
                // Generate filename
                const domainTitle = indicatorsData[domainId]?.title || 'مجال_غير_محدد';
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `تقرير_${domainTitle.replace(/\s+/g, '_')}_${timestamp}.pdf`;
                
                // Save the PDF
                pdf.save(filename);
                
                showToast('تم إنشاء التقرير بنجاح', 'success');
                
            } catch (error) {
                console.error('PDF Generation Error:', error);
                showToast('حدث خطأ في إنشاء التقرير. جاري المحاولة بطريقة بديلة...', 'warning');
                
                // Fallback to print method
                try {
                    await exportToPrint(domainId);
                } catch (fallbackError) {
                    showToast('عذراً، تعذر إنشاء التقرير. يرجى المحاولة مرة أخرى.', 'danger');
                }
            }
        }

        // Generate single-page PDF report with professional Arabic layout
        async function generateSinglePagePDFReport(pdf, domainId) {
            const pageWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const margin = 15;
            let currentY = margin;
            
            // Get data
            const schoolName = document.getElementById('schoolName')?.value || 'متوسطة المنذر بن عمرو الأنصاري';
            const principalName = document.getElementById('principalName')?.value || 'خالد سعود المطيري';
            const reportDate = document.getElementById('reportDate')?.value || new Date().toISOString().split('T')[0];
            const domainTitle = indicatorsData[domainId]?.title || 'مجال غير محدد';
            const domainResponsible = document.getElementById(`domain-${domainId}-responsible`)?.value || 'غير محدد';
            const arabicDate = new Date(reportDate).toLocaleDateString('ar-SA');
            
            // Calculate statistics
            let totalProgress = 0, completedCount = 0, totalIndicators = 0;
            if (indicatorsData[domainId]?.indicators) {
                totalIndicators = indicatorsData[domainId].indicators.length;
                indicatorsData[domainId].indicators.forEach(indicator => {
                    const data = trackingData[domainId]?.[indicator.code] || { progress: 0, status: 'incomplete' };
                    totalProgress += parseInt(data.progress || 0);
                    if (data.status === 'complete') completedCount++;
                });
            }
            const averageProgress = totalIndicators > 0 ? Math.round(totalProgress / totalIndicators) : 0;

            // Header Section with Gradient Effect
            pdf.setFillColor(44, 85, 48); // Dark green
            pdf.rect(0, 0, pageWidth, 45, 'F');
            
            // Saudi Arabia Emblem placeholder (you can add actual image if available)
            pdf.setFillColor(255, 255, 255);
            pdf.circle(pageWidth/2, 22, 8, 'F');
            
            // Header text
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(12);
            pdf.text('المملكة العربية السعودية', pageWidth/2, 10, { align: 'center' });
            pdf.setFontSize(14);
            pdf.text('وزارة التعليم', pageWidth/2, 17, { align: 'center' });
            pdf.setFontSize(10);
            pdf.text('مكتب قطاع أحد والعوالي', pageWidth/2, 24, { align: 'center' });
            pdf.setFontSize(16);
            pdf.text('تقرير متابعة مؤشرات التقويم المدرسي', pageWidth/2, 35, { align: 'center' });
            pdf.setFontSize(8);
            pdf.text('وفقاً للدليل الإسترشادي لأخصائي التقويم المدرسي - هيئة تقويم التعليم والتدريب', pageWidth/2, 41, { align: 'center' });
            
            currentY = 50;
            
            // School Information Section
            pdf.setFillColor(248, 249, 250);
            pdf.rect(margin, currentY, pageWidth - 2*margin, 25, 'F');
            pdf.setDrawColor(44, 85, 48);
            pdf.rect(margin, currentY, pageWidth - 2*margin, 25, 'S');
            
            pdf.setTextColor(44, 85, 48);
            pdf.setFontSize(12);
            pdf.text('معلومات المدرسة', margin + 5, currentY + 6);
            
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(9);
            pdf.text(`اسم المدرسة: ${schoolName}`, margin + 5, currentY + 12);
            pdf.text(`مدير المدرسة: ${principalName}`, margin + 5, currentY + 17);
            pdf.text(`تاريخ التقرير: ${arabicDate}`, pageWidth - margin - 60, currentY + 12);
            pdf.text(`تاريخ الإنشاء: ${new Date().toLocaleDateString('ar-SA')}`, pageWidth - margin - 60, currentY + 17);
            
            currentY += 30;
            
            // Domain Section
            pdf.setFillColor(44, 85, 48);
            pdf.rect(margin, currentY, pageWidth - 2*margin, 20, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(14);
            pdf.text(domainTitle, pageWidth/2, currentY + 8, { align: 'center' });
            pdf.setFontSize(10);
            pdf.text(`المسؤول: ${domainResponsible}`, pageWidth/2, currentY + 15, { align: 'center' });
            
            currentY += 25;
            
            // Progress Bar
            const progressBarWidth = pageWidth - 2*margin - 20;
            const progressBarHeight = 6;
            pdf.setFillColor(233, 236, 239); // Light gray background
            pdf.rect(margin + 10, currentY, progressBarWidth, progressBarHeight, 'F');
            pdf.setFillColor(40, 167, 69); // Green progress
            pdf.rect(margin + 10, currentY, (progressBarWidth * averageProgress / 100), progressBarHeight, 'F');
            
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(9);
            pdf.text(`نسبة الإنجاز الإجمالية: ${averageProgress}%`, pageWidth/2, currentY + 12, { align: 'center' });
            
            currentY += 20;
            
            // Table Header
            const tableStartY = currentY;
            const colWidths = [25, 90, 35, 30]; // Column widths
            const rowHeight = 8;
            
            pdf.setFillColor(44, 85, 48);
            pdf.rect(margin, currentY, pageWidth - 2*margin, rowHeight, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(9);
            let xPos = margin + 5;
            pdf.text('المؤشر', xPos, currentY + 5);
            xPos += colWidths[0];
            pdf.text('وصف المؤشر', xPos, currentY + 5);
            xPos += colWidths[1];
            pdf.text('الحالة', xPos, currentY + 5);
            xPos += colWidths[2];
            pdf.text('النسبة %', xPos, currentY + 5);
            
            currentY += rowHeight;
            
            // Table Rows - Compact layout for single page
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(7); // Smaller font for more content
            
            if (indicatorsData[domainId]?.indicators) {
                const maxRows = Math.floor((pageHeight - currentY - 40) / rowHeight); // Reserve space for footer
                const indicators = indicatorsData[domainId].indicators.slice(0, maxRows);
                
                indicators.forEach((indicator, index) => {
                    const data = trackingData[domainId]?.[indicator.code] || { status: 'incomplete', progress: 0 };
                    
                    // Alternate row colors
                    if (index % 2 === 0) {
                        pdf.setFillColor(248, 249, 250);
                        pdf.rect(margin, currentY, pageWidth - 2*margin, rowHeight, 'F');
                    }
                    
                    // Row border
                    pdf.setDrawColor(222, 226, 230);
                    pdf.rect(margin, currentY, pageWidth - 2*margin, rowHeight, 'S');
                    
                    xPos = margin + 2;
                    pdf.text(indicator.code, xPos, currentY + 5);
                    xPos += colWidths[0];
                    
                    // Truncate long titles for single page
                    let title = indicator.title;
                    if (title.length > 45) {
                        title = title.substring(0, 42) + '...';
                    }
                    pdf.text(title, xPos, currentY + 5);
                    xPos += colWidths[1];
                    
                    const statusText = data.status === 'complete' ? '✓ مكتمل' : '✗ غير مكتمل';
                    pdf.text(statusText, xPos, currentY + 5);
                    xPos += colWidths[2];
                    
                    pdf.text(`${data.progress}%`, xPos, currentY + 5);
                    
                    currentY += rowHeight;
                });
            }
            
            // Summary Statistics (Compact)
            currentY += 5;
            pdf.setFillColor(248, 249, 250);
            pdf.rect(margin, currentY, pageWidth - 2*margin, 15, 'F');
            pdf.setDrawColor(44, 85, 48);
            pdf.rect(margin, currentY, pageWidth - 2*margin, 15, 'S');
            
            pdf.setTextColor(44, 85, 48);
            pdf.setFontSize(10);
            pdf.text('الملخص الإحصائي', pageWidth/2, currentY + 5, { align: 'center' });
            
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(8);
            pdf.text(`إجمالي المؤشرات: ${totalIndicators}`, margin + 10, currentY + 10);
            pdf.text(`المكتملة: ${completedCount}`, margin + 60, currentY + 10);
            pdf.text(`المتبقية: ${totalIndicators - completedCount}`, margin + 100, currentY + 10);
            pdf.text(`النسبة الإجمالية: ${averageProgress}%`, margin + 140, currentY + 10);
            
            // Footer
            currentY = pageHeight - 20;
            pdf.setFillColor(44, 85, 48);
            pdf.rect(0, currentY, pageWidth, 20, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(12);
            pdf.text('نُراقب • نُقيم • نُطور', pageWidth/2, currentY + 8, { align: 'center' });
            pdf.setFontSize(8);
            pdf.text('تم إنشاء هذا التقرير بواسطة نظام متابعة مؤشرات التقويم المدرسي', pageWidth/2, currentY + 13, { align: 'center' });
            pdf.text('تنفيذ: نواف الصبحي', pageWidth/2, currentY + 17, { align: 'center' });
        }

        // Fallback print method
        async function exportToPrint(domainId) {
            const printWindow = window.open('', '_blank');
            const reportHTML = generateCompactPrintableReport(domainId);
            
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                setTimeout(() => printWindow.close(), 1000);
            }, 500);
        }

        // Generate compact HTML for single-page printing
        function generateCompactPrintableReport(domainId) {
            const schoolName = document.getElementById('schoolName')?.value || 'متوسطة المنذر بن عمرو الأنصاري';
            const principalName = document.getElementById('principalName')?.value || 'خالد سعود المطيري';
            const reportDate = document.getElementById('reportDate')?.value || new Date().toISOString().split('T')[0];
            const domainTitle = indicatorsData[domainId]?.title || 'مجال غير محدد';
            const domainResponsible = document.getElementById(`domain-${domainId}-responsible`)?.value || 'غير محدد';
            const arabicDate = new Date(reportDate).toLocaleDateString('ar-SA');
            
            // Calculate statistics
            let totalProgress = 0, completedCount = 0, totalIndicators = 0;
            if (indicatorsData[domainId]?.indicators) {
                totalIndicators = indicatorsData[domainId].indicators.length;
                indicatorsData[domainId].indicators.forEach(indicator => {
                    const data = trackingData[domainId]?.[indicator.code] || { progress: 0, status: 'incomplete' };
                    totalProgress += parseInt(data.progress || 0);
                    if (data.status === 'complete') completedCount++;
                });
            }
            const averageProgress = totalIndicators > 0 ? Math.round(totalProgress / totalIndicators) : 0;
            
            // Generate compact table rows
            let tableRows = '';
            if (indicatorsData[domainId]?.indicators) {
                indicatorsData[domainId].indicators.forEach((indicator, index) => {
                    const data = trackingData[domainId]?.[indicator.code] || { status: 'incomplete', progress: 0 };
                    const statusText = data.status === 'complete' ? '✓ مكتمل' : '✗ غير مكتمل';
                    const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                    
                    tableRows += `
                        <tr style="background-color: ${bgColor};">
                            <td style="padding: 3px 5px; font-size: 8px; font-weight: bold;">${indicator.code}</td>
                            <td style="padding: 3px 5px; font-size: 8px;">${indicator.title}</td>
                            <td style="padding: 3px 5px; font-size: 8px; text-align: center;">${statusText}</td>
                            <td style="padding: 3px 5px; font-size: 8px; text-align: center; font-weight: bold;">${data.progress}%</td>
                        </tr>
                    `;
                });
            }
            
            return `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير متابعة مؤشرات التقويم المدرسي</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 10mm;
                        }
                        body {
                            font-family: 'Arial', 'Tahoma', sans-serif;
                            font-size: 10px;
                            line-height: 1.2;
                            margin: 0;
                            padding: 0;
                            direction: rtl;
                        }
                        .header {
                            background: linear-gradient(135deg, #2c5530, #4a7c59);
                            color: white;
                            padding: 10px;
                            text-align: center;
                            margin-bottom: 10px;
                        }
                        .header h1 { margin: 2px 0; font-size: 14px; }
                        .header h2 { margin: 0; font-size: 12px; }
                        .header h3 { margin: 0; font-size: 10px; }
                        .school-info {
                            background: #f8f9fa;
                            border: 1px solid #2c5530;
                            padding: 8px;
                            margin-bottom: 10px;
                            font-size: 9px;
                        }
                        .domain-title {
                            background: #2c5530;
                            color: white;
                            padding: 8px;
                            text-align: center;
                            margin-bottom: 10px;
                            font-size: 12px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 10px;
                            font-size: 8px;
                        }
                        th {
                            background: #2c5530;
                            color: white;
                            padding: 4px;
                            text-align: center;
                            border: 1px solid #ddd;
                        }
                        td {
                            border: 1px solid #ddd;
                        }
                        .summary {
                            background: #f8f9fa;
                            border: 1px solid #2c5530;
                            padding: 8px;
                            margin-top: 10px;
                            font-size: 9px;
                        }
                        .footer {
                            background: #2c5530;
                            color: white;
                            padding: 8px;
                            text-align: center;
                            margin-top: 10px;
                            font-size: 9px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>المملكة العربية السعودية - وزارة التعليم - مكتب قطاع أحد والعوالي</h2>
                        <h1>تقرير متابعة مؤشرات التقويم المدرسي</h1>
                    </div>
                    
                    <div class="school-info">
                        <strong>اسم المدرسة:</strong> ${schoolName} | 
                        <strong>المدير:</strong> ${principalName} | 
                        <strong>التاريخ:</strong> ${arabicDate} | 
                        <strong>المسؤول:</strong> ${domainResponsible}
                    </div>
                    
                    <div class="domain-title">${domainTitle} - نسبة الإنجاز: ${averageProgress}%</div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 12%;">المؤشر</th>
                                <th style="width: 60%;">الوصف</th>
                                <th style="width: 18%;">الحالة</th>
                                <th style="width: 10%;">النسبة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <strong>الملخص:</strong> 
                        إجمالي المؤشرات: ${totalIndicators} | 
                        المكتملة: ${completedCount} | 
                        المتبقية: ${totalIndicators - completedCount} | 
                        النسبة الإجمالية: ${averageProgress}%
                    </div>
                    
                    <div class="footer">
                        <strong>نُراقب • نُقيم • نُطور</strong> | تنفيذ: نواف الصبحي
                    </div>
                </body>
                </html>
            `;
        }

        // Remove old functions that are no longer needed
        // generatePrintableReport and exportAsTextFile functions removed

        // Fallback: Export as text file
        async function exportAsTextFile(domainId) {
            const schoolName = document.getElementById('schoolName')?.value || 'متوسطة المنذر بن عمرو الأنصاري';
            const principalName = document.getElementById('principalName')?.value || 'خالد سعود المطيري';
            const domainTitle = indicatorsData[domainId]?.title || 'مجال غير محدد';
            const domainResponsible = document.getElementById(`domain-${domainId}-responsible`)?.value || 'غير محدد';
            const arabicDate = new Date().toLocaleDateString('ar-SA');
            
            let content = `تقرير متابعة مؤشرات التقويم المدرسي\n`;
            content += `المملكة العربية السعودية - وزارة التعليم\n`;
            content += `مكتب قطاع أحد والعوالي\n\n`;
            content += `اسم المدرسة: ${schoolName}\n`;
            content += `مدير المدرسة: ${principalName}\n`;
            content += `تاريخ التقرير: ${arabicDate}\n\n`;
            content += `${domainTitle}\n`;
            content += `المسؤول: ${domainResponsible}\n`;
            content += `${'='.repeat(50)}\n\n`;
            
            if (indicatorsData[domainId]?.indicators) {
                indicatorsData[domainId].indicators.forEach(indicator => {
                    const data = trackingData[domainId]?.[indicator.code] || { 
                        status: 'incomplete', progress: 0 
                    };
                    const status = data.status === 'complete' ? 'مكتمل' : 'غير مكتمل';
                    
                    content += `المؤشر: ${indicator.code}\n`;
                    content += `الوصف: ${indicator.title}\n`;
                    content += `الحالة: ${status}\n`;
                    content += `النسبة: ${data.progress}%\n`;
                    content += `${'-'.repeat(30)}\n`;
                });
            }
            
            content += `\nنُراقب • نُقيم • نُطور\n`;
            content += `تنفيذ: نواف الصبحي\n`;
            
            // Create and download text file
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `تقرير_${domainTitle.replace(/\s+/g, '_')}_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('تم تحميل التقرير كملف نصي', 'success');
        }gradient(135deg, #2c5530, #4a7c59);
                            color: white;
                            padding: 20px;
                            text-align: center;
                            margin: -20px -20px 20px -20px;
                            border-radius: 0 0 10px 10px;
                        }
                        
                        .header h1 { margin: 5px 0; font-size: 18px; }
                        .header h2 { margin: 0; font-size: 14px; }
                        .header h3 { margin: 0; font-size: 12px; }
                        
                        .school-info {
                            background: #f8f9fa;
                            border: 2px solid #2c5530;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                        }
                        
                        .domain-title {
                            background: #2c5530;
                            color: white;
                            padding: 15px;
                            text-align: center;
                            border-radius: 5px;
                            margin-bottom: 20px;
                            font-size: 16px;
                            font-weight: bold;
                        }
                        
                        .domain-responsible {
                            background: #e9ecef;
                            border: 1px solid #2c5530;
                            padding: 10px;
                            border-radius: 5px;
                            margin-bottom: 20px;
                            font-weight: bold;
                            color: #2c5530;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                            font-size: 10px;
                        }
                        
                        th {
                            background: #2c5530;
                            color: white;
                            padding: 8px;
                            text-align: center;
                            border: 1px solid #ddd;
                            font-weight: bold;
                        }
                        
                        .summary {
                            background: #f8f9fa;
                            border: 2px solid #2c5530;
                            border-radius: 8px;
                            padding: 15px;
                            margin-top: 20px;
                        }
                        
                        .summary h3 {
                            color: #2c5530;
                            text-align: center;
                            margin: 0 0 10px 0;
                        }
                        
                        .stats {
                            display: flex;
                            justify-content: space-between;
                            flex-wrap: wrap;
                        }
                        
                        .stats div {
                            flex: 1;
                            margin: 5px;
                        }
                        
                        .footer {
                            background: #2c5530;
                            color: white;
                            padding: 15px;
                            text-align: center;
                            margin: 20px -20px -20px -20px;
                            border-radius: 10px 10px 0 0;
                        }
                        
                        @media print {
                            body { margin: 0; padding: 10px; }
                            .header { margin: -10px -10px 15px -10px; }
                            .footer { margin: 15px -10px -10px -10px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>المملكة العربية السعودية</h2>
                        <h1>وزارة التعليم</h1>
                        <h3>مكتب قطاع أحد والعوالي</h3>
                        <h1>تقرير متابعة مؤشرات التقويم المدرسي</h1>
                    </div>
                    
                    <div class="school-info">
                        <h3 style="color: #2c5530; margin: 0 0 10px 0;">معلومات المدرسة</h3>
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                            <div style="flex: 1; margin-left: 20px;">
                                <p><strong>اسم المدرسة:</strong> ${schoolName}</p>
                                <p><strong>مدير المدرسة:</strong> ${principalName}</p>
                            </div>
                            <div style="flex: 1;">
                                <p><strong>تاريخ التقرير:</strong> ${arabicDate}</p>
                                <p><strong>تاريخ الإنشاء:</strong> ${new Date().toLocaleDateString('ar-SA')}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="domain-title">${domainTitle}</div>
                    
                    <div class="domain-responsible">
                        <i class="fas fa-user"></i> المسؤول عن المجال: ${domainResponsible}
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 15%;">رقم المؤشر</th>
                                <th style="width: 55%;">وصف المؤشر</th>
                                <th style="width: 15%;">الحالة</th>
                                <th style="width: 15%;">النسبة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <h3>ملخص إحصائي شامل</h3>
                        <div class="stats">
                            <div>
                                <p><strong>إجمالي المؤشرات:</strong> ${totalIndicators}</p>
                                <p><strong>المؤشرات المكتملة:</strong> ${completedCount}</p>
                            </div>
                            <div>
                                <p><strong>النسبة الإجمالية:</strong> ${averageProgress}%</p>
                                <p><strong>المؤشرات المتبقية:</strong> ${totalIndicators - completedCount}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p style="margin: 0; font-size: 14px; font-weight: bold;">نُراقب • نُقيم • نُطور</p>
                        <p style="margin: 5px 0 0 0;">تم إنشاء هذا التقرير بواسطة نظام متابعة مؤشرات التقويم المدرسي</p>
                        <p style="margin: 5px 0 0 0;">تنفيذ: نواف الصبحي</p>
                    </div>
                </body>
                </html>
            `;
        }

        // Fallback: Export as text file
        async function exportAsTextFile(domainId) {
            const schoolName = document.getElementById('schoolName')?.value || 'متوسطة المنذر بن عمرو الأنصاري';
            const principalName = document.getElementById('principalName')?.value || 'خالد سعود المطيري';
            const domainTitle = indicatorsData[domainId]?.title || 'مجال غير محدد';
            const domainResponsible = document.getElementById(`domain-${domainId}-responsible`)?.value || 'غير محدد';
            const arabicDate = new Date().toLocaleDateString('ar-SA');
            
            let content = `تقرير متابعة مؤشرات التقويم المدرسي\n`;
            content += `المملكة العربية السعودية - وزارة التعليم\n`;
            content += `مكتب قطاع أحد والعوالي\n\n`;
            content += `اسم المدرسة: ${schoolName}\n`;
            content += `مدير المدرسة: ${principalName}\n`;
            content += `تاريخ التقرير: ${arabicDate}\n\n`;
            content += `${domainTitle}\n`;
            content += `المسؤول: ${domainResponsible}\n`;
            content += `${'='.repeat(50)}\n\n`;
            
            if (indicatorsData[domainId]?.indicators) {
                indicatorsData[domainId].indicators.forEach(indicator => {
                    const data = trackingData[domainId]?.[indicator.code] || { 
                        status: 'incomplete', progress: 0 
                    };
                    const status = data.status === 'complete' ? 'مكتمل' : 'غير مكتمل';
                    
                    content += `المؤشر: ${indicator.code}\n`;
                    content += `الوصف: ${indicator.title}\n`;
                    content += `الحالة: ${status}\n`;
                    content += `النسبة: ${data.progress}%\n`;
                    content += `${'-'.repeat(30)}\n`;
                });
            }
            
            content += `\nنُراقب • نُقيم • نُطور\n`;
            content += `تنفيذ: نواف الصبحي\n`;
            
            // Create and download text file
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `تقرير_${domainTitle.replace(/\s+/g, '_')}_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('تم تحميل التقرير كملف نصي', 'success');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Mobile optimizations
        if ('ontouchstart' in window) {
            document.addEventListener('touchstart', function() {}, true);
        }
        
        window.addEventListener('orientationchange', function() {
            setTimeout(updateProgress, 100);
        });
    </script>
</body>
</html>
