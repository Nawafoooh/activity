<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة مؤشرات التقويم المدرسي</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            font-size: 14px;
        }
        
        .header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        .header h1 { font-size: 1.5rem; }
        .header h5, .header h6 { font-size: 0.9rem; }
        
        .domain-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .domain-header {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .responsible-input {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 250px;
            margin-top: 10px;
        }
        
        .responsible-input::placeholder {
            color: rgba(255,255,255,0.8);
        }
        
        .progress-indicator {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .table-container {
            padding: 0;
            overflow-x: auto;
        }
        
        .custom-table {
            margin: 0;
            font-size: 0.85rem;
            min-width: 700px;
        }
        
        .custom-table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
            padding: 12px 10px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .custom-table td {
            padding: 10px 8px;
            border-top: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .custom-table input, .custom-table select {
            font-size: 0.8rem;
            padding: 6px 8px;
        }
        
        .btn-view-docs {
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: 15px;
        }
        
        .btn-export {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            margin: 20px;
            font-size: 0.95rem;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #2c5530, #4a7c59);
            color: white;
        }
        
        .documents-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .document-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            border-right: 4px solid #28a745;
            font-size: 0.9rem;
        }
        
        .school-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-field {
            margin-bottom: 15px;
        }
        
        .info-field label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 6px;
            display: block;
            font-size: 0.95rem;
        }
        
        .info-field input {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            font-size: 0.95rem;
        }
        
        .footer {
            background-color: #2c5530;
            color: white;
            padding: 15px 0;
            margin-top: 40px;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header { padding: 10px 0; margin-bottom: 15px; }
            .header h1 { font-size: 1.2rem; }
            .header h5, .header h6 { font-size: 0.8rem; }
            .header p { font-size: 0.75rem; }
            .domain-card { margin-bottom: 15px; border-radius: 8px; }
            .domain-header { padding: 12px; font-size: 1rem; }
            .responsible-input { width: 180px; padding: 6px 8px; }
            .school-info { padding: 15px; margin-bottom: 20px; }
            .school-info h4 { font-size: 1.1rem; }
            .custom-table { font-size: 0.75rem; min-width: 600px; }
            .custom-table th { padding: 8px 6px; font-size: 0.7rem; }
            .custom-table td { padding: 8px 6px; }
            .custom-table input, .custom-table select { font-size: 0.7rem; padding: 4px 6px; }
            .btn-view-docs { padding: 4px 8px; font-size: 0.65rem; }
            .btn-export { padding: 8px 20px; font-size: 0.85rem; margin: 15px; }
            .modal-dialog { margin: 10px; }
            .document-item { padding: 6px 10px; font-size: 0.85rem; }
            .form-range { width: 50px !important; }
            .progress-indicator { height: 4px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 0 10px; }
            .header h1 { font-size: 1rem; }
            .domain-header { font-size: 0.9rem; padding: 10px; }
            .responsible-input { width: 150px; }
            .custom-table { min-width: 500px; font-size: 0.7rem; }
            .custom-table th, .custom-table td { padding: 6px 4px; }
            .btn-export { width: 90%; margin: 10px 5%; }
            .school-info .row { --bs-gutter-x: 0.5rem; }
            .modal-dialog { margin: 5px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="text-center">
                <h6 class="mb-1">المملكة العربية السعودية</h6>
                <h5 class="mb-1">وزارة التعليم</h5>
                <h6 class="mb-3">مكتب قطاع أحد والعوالي</h6>
                <h1><i class="fas fa-school"></i> نظام متابعة مؤشرات التقويم المدرسي</h1>
                <p class="mb-0">وفقاً للدليل الإسترشادي لأخصائي التقويم المدرسي - هيئة تقويم التعليم والتدريب</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- User Management Section -->
        <div class="school-info">
            <h4><i class="fas fa-users"></i> إدارة المستخدمين والصلاحيات</h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="info-field">
                        <label>المستخدم الحالي:</label>
                        <div class="d-flex gap-2">
                            <input type="text" id="currentUser" placeholder="أدخل اسمك" class="form-control">
                            <select id="userRole" class="form-select" style="width: 150px;">
                                <option value="admin">مدير النظام</option>
                                <option value="domain_manager">مسؤول مجال</option>
                                <option value="viewer">مشاهد فقط</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-field">
                        <label>آخر تحديث:</label>
                        <div id="lastUpdateInfo" class="text-muted small">لم يتم التحديث بعد</div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-primary btn-sm" onclick="saveUserProfile()">
                            <i class="fas fa-save"></i> حفظ المستخدم
                        </button>
                        <button class="btn btn-info btn-sm" onclick="showActiveUsers()">
                            <i class="fas fa-users"></i> المستخدمين النشطين
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="showActivityLog()">
                            <i class="fas fa-history"></i> سجل النشاطات
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- School Information -->
        <div class="school-info">
            <h4><i class="fas fa-info-circle"></i> معلومات المدرسة</h4>
            <div class="row">
                <div class="col-md-4">
                    <div class="info-field">
                        <label>اسم المدرسة:</label>
                        <input type="text" id="schoolName" value="متوسطة المنذر بن عمرو الأنصاري">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-field">
                        <label>اسم المدير:</label>
                        <input type="text" id="principalName" value="خالد سعود المطيري">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="info-field">
                        <label>تاريخ التقرير:</label>
                        <input type="date" id="reportDate">
                    </div>
                </div>
            </div>
        </div>

        <!-- Domain 1: School Management -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-cogs"></i> مجال الإدارة المدرسية
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.95rem; margin-left: 10px;">المسؤول:</label>
                    <input type="text" id="domain-1-responsible" placeholder="أدخل اسم المسؤول" 
                           class="responsible-input">
                </div>
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-1" style="width: 0%"></div>
                </div>
                <small id="progress-text-1">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="25%">المؤشر</th>
                            <th width="20%">الحالة</th>
                            <th width="15%">نسبة الإنجاز</th>
                            <th width="40%">الوثائق والملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-1-body"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(1)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 2: Teaching and Learning -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-chalkboard-teacher"></i> مجال التعليم والتعلم
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.95rem; margin-left: 10px;">المسؤول:</label>
                    <input type="text" id="domain-2-responsible" placeholder="أدخل اسم المسؤول" 
                           class="responsible-input">
                </div>
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-2" style="width: 0%"></div>
                </div>
                <small id="progress-text-2">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="25%">المؤشر</th>
                            <th width="20%">الحالة</th>
                            <th width="15%">نسبة الإنجاز</th>
                            <th width="40%">الوثائق والملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-2-body"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(2)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 3: Learning Outcomes -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-graduation-cap"></i> مجال نواتج التعلم
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.95rem; margin-left: 10px;">المسؤول:</label>
                    <input type="text" id="domain-3-responsible" placeholder="أدخل اسم المسؤول" 
                           class="responsible-input">
                </div>
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-3" style="width: 0%"></div>
                </div>
                <small id="progress-text-3">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="25%">المؤشر</th>
                            <th width="20%">الحالة</th>
                            <th width="15%">نسبة الإنجاز</th>
                            <th width="40%">الوثائق والملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-3-body"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(3)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>

        <!-- Domain 4: School Environment -->
        <div class="domain-card">
            <div class="domain-header">
                <i class="fas fa-shield-alt"></i> مجال البيئة المدرسية
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.95rem; margin-left: 10px;">المسؤول:</label>
                    <input type="text" id="domain-4-responsible" placeholder="أدخل اسم المسؤول" 
                           class="responsible-input">
                </div>
                <div class="progress-indicator">
                    <div class="progress-bar" id="progress-4" style="width: 0%"></div>
                </div>
                <small id="progress-text-4">نسبة الإنجاز: 0%</small>
            </div>
            <div class="table-container">
                <table class="table custom-table">
                    <thead>
                        <tr>
                            <th width="25%">المؤشر</th>
                            <th width="20%">الحالة</th>
                            <th width="15%">نسبة الإنجاز</th>
                            <th width="40%">الوثائق والملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="domain-4-body"></tbody>
                </table>
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-export" onclick="exportToPDF(4)">
                    <i class="fas fa-download"></i> تصدير تقرير PDF
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="text-center">
                <p class="mb-0">نُراقب • نُقيم • نُطور</p>
                <small class="text-light">تنفيذ: نواف الصبحي</small>
            </div>
        </div>
    </footer>

    <!-- Documents Modal -->
    <div class="modal fade" id="documentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">الوثائق والسجلات المطلوبة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="documents-section">
                        <h6><i class="fas fa-file-alt"></i> الوثائق المطلوبة:</h6>
                        <div id="requiredDocuments"></div>
                    </div>
                    <div class="comments-section">
                        <h6><i class="fas fa-comments"></i> مرئيات وملاحظات المسؤول:</h6>
                        <textarea class="form-control" id="modalComments" rows="4" placeholder="أضف ملاحظاتك هنا..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-success" onclick="saveComments()">حفظ الملاحظات</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase Configuration - إعدادات مشروعك
        const firebaseConfig = {
            apiKey: "AIzaSyB2hVGA367i2ZrtezTXITHuR6l84YTTS64",
            authDomain: "kpischool-52b95.firebaseapp.com",
            projectId: "kpischool-52b95",
            storageBucket: "kpischool-52b95.firebasestorage.app",
            messagingSenderId: "874100041787",
            appId: "1:874100041787:web:1daa1a5ab6e32a3e7e141e",
            measurementId: "G-P2HJ9T8YB4"
        };

        // Initialize Firebase
        let db = null;
        let currentSchoolId = null;

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                
                // تسجيل دخول مجهول للمدارس
                firebase.auth().signInAnonymously()
                    .then(() => {
                        console.log('تم الاتصال بـ Firebase بنجاح');
                        generateSchoolId();
                        loadDataFromFirebase();
                    })
                    .catch((error) => {
                        console.error('خطأ في الاتصال بـ Firebase:', error);
                        showToast('تعذر الاتصال بقاعدة البيانات. سيتم العمل بالوضع المحلي.', 'warning');
                        initializeApp();
                    });
            } catch (error) {
                console.error('خطأ في تهيئة Firebase:', error);
                showToast('تعذر تهيئة قاعدة البيانات. سيتم العمل بالوضع المحلي.', 'warning');
                initializeApp();
            }
        }

        // توليد معرف فريد للمدرسة
        function generateSchoolId() {
            // محاولة الحصول على المعرف المحفوظ محلياً
            currentSchoolId = localStorage.getItem('schoolId');
            
            if (!currentSchoolId) {
                // إنشاء معرف جديد باستخدام اسم المدرسة والتاريخ
                const schoolName = document.getElementById('schoolName')?.value || 'school';
                const timestamp = Date.now();
                currentSchoolId = `${schoolName.replace(/\s+/g, '_')}_${timestamp}`;
                localStorage.setItem('schoolId', currentSchoolId);
            }
            
            // عرض معرف المدرسة للمستخدم
            showSchoolId();
        }

        // عرض معرف المدرسة
        function showSchoolId() {
            const schoolInfo = document.querySelector('.school-info h4');
            if (schoolInfo && currentSchoolId) {
                schoolInfo.innerHTML = `
                    <i class="fas fa-info-circle"></i> معلومات المدرسة 
                    <small class="text-muted">(معرف المدرسة: ${currentSchoolId})</small>
                `;
            }
        }

        // حفظ البيانات إلى Firebase
        async function saveToFirebase() {
            if (!db || !currentSchoolId) return;

            try {
                const schoolData = {
                    schoolInfo: {
                        name: document.getElementById('schoolName')?.value || '',
                        principal: document.getElementById('principalName')?.value || '',
                        reportDate: document.getElementById('reportDate')?.value || '',
                        domain1Responsible: document.getElementById('domain-1-responsible')?.value || '',
                        domain2Responsible: document.getElementById('domain-2-responsible')?.value || '',
                        domain3Responsible: document.getElementById('domain-3-responsible')?.value || '',
                        domain4Responsible: document.getElementById('domain-4-responsible')?.value || ''
                    },
                    trackingData: trackingData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    version: '2.0'
                };

                await db.collection('schools').doc(currentSchoolId).set(schoolData, { merge: true });
                console.log('تم حفظ البيانات بنجاح');
                
                // إظهار مؤشر الحفظ
                showSaveIndicator();
                
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                showToast('تعذر حفظ البيانات في قاعدة البيانات', 'warning');
            }
        }

        // تحميل البيانات من Firebase
        async function loadDataFromFirebase() {
            if (!db || !currentSchoolId) {
                initializeApp();
                return;
            }

            try {
                const doc = await db.collection('schools').doc(currentSchoolId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // تحميل معلومات المدرسة
                    if (data.schoolInfo) {
                        document.getElementById('schoolName').value = data.schoolInfo.name || '';
                        document.getElementById('principalName').value = data.schoolInfo.principal || '';
                        document.getElementById('reportDate').value = data.schoolInfo.reportDate || '';
                        document.getElementById('domain-1-responsible').value = data.schoolInfo.domain1Responsible || '';
                        document.getElementById('domain-2-responsible').value = data.schoolInfo.domain2Responsible || '';
                        document.getElementById('domain-3-responsible').value = data.schoolInfo.domain3Responsible || '';
                        document.getElementById('domain-4-responsible').value = data.schoolInfo.domain4Responsible || '';
                    }
                    
                    // تحميل بيانات التتبع
                    if (data.trackingData) {
                        trackingData = data.trackingData;
                    }
                    
                    showToast('تم تحميل البيانات المحفوظة بنجاح', 'success');
                } else {
                    console.log('لا توجد بيانات محفوظة للمدرسة');
                }
                
                initializeApp();
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showToast('تعذر تحميل البيانات المحفوظة', 'warning');
                initializeApp();
            }
        }

        // مؤشر الحفظ التلقائي
        function showSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'position-fixed';
            indicator.style.cssText = 'top: 10px; left: 10px; z-index: 9999; background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;';
            indicator.innerHTML = '<i class="fas fa-check"></i> تم الحفظ';
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentElement) indicator.remove();
            }, 2000);
        }

        // حفظ تلقائي عند أي تغيير
        function enableAutoSave() {
            let saveTimeout;
            
            // مراقبة تغييرات الحقول
            const watchedFields = [
                'schoolName', 'principalName', 'reportDate',
                'domain-1-responsible', 'domain-2-responsible', 
                'domain-3-responsible', 'domain-4-responsible'
            ];
            
            watchedFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(saveToFirebase, 1000); // حفظ بعد ثانية من التوقف عن الكتابة
                    });
                }
            });
        }

        // User management and permissions system
        let currentUser = null;
        let userRole = 'viewer';
        let activeUsers = [];

        // Initialize user system
        function initializeUserSystem() {
            // تحميل بيانات المستخدم المحفوظة
            const savedUser = localStorage.getItem('currentUser');
            const savedRole = localStorage.getItem('userRole');
            
            if (savedUser) {
                document.getElementById('currentUser').value = savedUser;
                currentUser = savedUser;
            }
            
            if (savedRole) {
                document.getElementById('userRole').value = savedRole;
                userRole = savedRole;
            }
            
            // تطبيق الصلاحيات
            applyUserPermissions();
            
            // تحديث معلومات المستخدم في Firebase
            if (db && currentSchoolId && currentUser) {
                updateUserActivity();
            }
        }

        // حفظ ملف المستخدم
        function saveUserProfile() {
            const userName = document.getElementById('currentUser').value.trim();
            const role = document.getElementById('userRole').value;
            
            if (!userName) {
                showToast('يرجى إدخال اسم المستخدم', 'warning');
                return;
            }
            
            currentUser = userName;
            userRole = role;
            
            // حفظ محلياً
            localStorage.setItem('currentUser', currentUser);
            localStorage.setItem('userRole', userRole);
            
            // تطبيق الصلاحيات
            applyUserPermissions();
            
            // تحديث في Firebase
            if (db && currentSchoolId) {
                updateUserActivity();
            }
            
            showToast(`تم حفظ المستخدم: ${currentUser} (${getUserRoleText(userRole)})`, 'success');
        }

        // تطبيق صلاحيات المستخدم
        function applyUserPermissions() {
            const isAdmin = userRole === 'admin';
            const isDomainManager = userRole === 'domain_manager';
            const isViewer = userRole === 'viewer';
            
            // تعطيل التعديل للمشاهدين فقط
            if (isViewer) {
                // تعطيل جميع عناصر الإدخال
                document.querySelectorAll('input:not(#currentUser), select:not(#userRole), textarea').forEach(element => {
                    element.disabled = true;
                });
                
                // إخفاء أزرار التصدير للمشاهدين
                document.querySelectorAll('.btn-export').forEach(btn => {
                    btn.style.display = 'none';
                });
                
                showToast('أنت في وضع المشاهدة فقط', 'info');
            } else {
                // تمكين التعديل للمدراء ومسؤولي المجالات
                document.querySelectorAll('input, select, textarea').forEach(element => {
                    element.disabled = false;
                });
                
                document.querySelectorAll('.btn-export').forEach(btn => {
                    btn.style.display = 'inline-block';
                });
            }
            
            // إضافة مؤشر الصلاحية
            addPermissionIndicator();
        }

        // إضافة مؤشر الصلاحية
        function addPermissionIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'permission-indicator';
            indicator.className = 'position-fixed';
            indicator.style.cssText = `
                bottom: 20px; left: 20px; z-index: 9999; 
                background: ${getPermissionColor()}; color: white; 
                padding: 8px 15px; border-radius: 20px; font-size: 12px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            indicator.innerHTML = `
                <i class="fas ${getPermissionIcon()}"></i> 
                ${currentUser || 'غير محدد'} - ${getUserRoleText(userRole)}
            `;
            
            // إزالة المؤشر السابق إن وجد
            const oldIndicator = document.getElementById('permission-indicator');
            if (oldIndicator) oldIndicator.remove();
            
            document.body.appendChild(indicator);
        }

        // الحصول على لون الصلاحية
        function getPermissionColor() {
            switch(userRole) {
                case 'admin': return '#dc3545';      // أحمر للمدير
                case 'domain_manager': return '#ffc107'; // أصفر لمسؤول المجال
                case 'viewer': return '#6c757d';     // رمادي للمشاهد
                default: return '#6c757d';
            }
        }

        // الحصول على أيقونة الصلاحية
        function getPermissionIcon() {
            switch(userRole) {
                case 'admin': return 'fa-crown';
                case 'domain_manager': return 'fa-user-tie';
                case 'viewer': return 'fa-eye';
                default: return 'fa-user';
            }
        }

        // الحصول على نص الصلاحية
        function getUserRoleText(role) {
            switch(role) {
                case 'admin': return 'مدير النظام';
                case 'domain_manager': return 'مسؤول مجال';
                case 'viewer': return 'مشاهد فقط';
                default: return 'غير محدد';
            }
        }

        // تحديث نشاط المستخدم في Firebase
        async function updateUserActivity() {
            if (!db || !currentSchoolId || !currentUser) return;
            
            try {
                const userActivity = {
                    name: currentUser,
                    role: userRole,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    timestamp: Date.now()
                };
                
                await db.collection('schools').doc(currentSchoolId)
                    .collection('users').doc(currentUser).set(userActivity, { merge: true });
                
                // تحديث معلومات آخر تحديث
                updateLastUpdateInfo();
                
            } catch (error) {
                console.error('خطأ في تحديث نشاط المستخدم:', error);
            }
        }

        // عرض المستخدمين النشطين
        async function showActiveUsers() {
            if (!db || !currentSchoolId) {
                showToast('قاعدة البيانات غير متاحة', 'warning');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('schools').doc(currentSchoolId)
                    .collection('users').orderBy('lastActive', 'desc').limit(10).get();
                
                let usersList = '<div class="users-list">';
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const lastActive = user.lastActive ? 
                        new Date(user.lastActive.toDate()).toLocaleString('ar-SA') : 'غير محدد';
                    
                    usersList += `
                        <div class="user-item" style="padding: 8px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px;">
                            <strong><i class="fas ${getPermissionIcon(user.role)}"></i> ${user.name}</strong>
                            <br><small class="text-muted">${getUserRoleText(user.role)} - آخر نشاط: ${lastActive}</small>
                        </div>
                    `;
                });
                usersList += '</div>';
                
                showModal('المستخدمين النشطين', usersList);
                
            } catch (error) {
                console.error('خطأ في جلب المستخدمين:', error);
                showToast('تعذر جلب قائمة المستخدمين', 'danger');
            }
        }

        // عرض سجل النشاطات
        async function showActivityLog() {
            if (!db || !currentSchoolId) {
                showToast('قاعدة البيانات غير متاحة', 'warning');
                return;
            }
            
            try {
                const activitiesSnapshot = await db.collection('schools').doc(currentSchoolId)
                    .collection('activities').orderBy('timestamp', 'desc').limit(20).get();
                
                let activitiesList = '<div class="activities-list" style="max-height: 400px; overflow-y: auto;">';
                
                if (activitiesSnapshot.empty) {
                    activitiesList += '<p class="text-muted">لا توجد نشاطات مسجلة</p>';
                } else {
                    activitiesSnapshot.forEach(doc => {
                        const activity = doc.data();
                        const timestamp = new Date(activity.timestamp).toLocaleString('ar-SA');
                        
                        activitiesList += `
                            <div class="activity-item" style="padding: 8px; border-bottom: 1px solid #eee;">
                                <div class="d-flex justify-content-between">
                                    <strong>${activity.user || 'مستخدم غير معروف'}</strong>
                                    <small class="text-muted">${timestamp}</small>
                                </div>
                                <div class="text-muted">${activity.action || 'نشاط غير محدد'}</div>
                                ${activity.details ? `<small class="text-info">${activity.details}</small>` : ''}
                            </div>
                        `;
                    });
                }
                activitiesList += '</div>';
                
                showModal('سجل النشاطات', activitiesList);
                
            } catch (error) {
                console.error('خطأ في جلب سجل النشاطات:', error);
                showToast('تعذر جلب سجل النشاطات', 'danger');
            }
        }

        // تسجيل نشاط في السجل
        async function logActivity(action, details = '') {
            if (!db || !currentSchoolId || !currentUser) return;
            
            try {
                await db.collection('schools').doc(currentSchoolId)
                    .collection('activities').add({
                        user: currentUser,
                        role: userRole,
                        action: action,
                        details: details,
                        timestamp: Date.now(),
                        serverTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
            } catch (error) {
                console.error('خطأ في تسجيل النشاط:', error);
            }
        }

        // عرض نافذة منبثقة مخصصة
        function showModal(title, content) {
            const modalHtml = `
                <div class="modal fade" id="customModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(45deg, #2c5530, #4a7c59); color: white;">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${content}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // إزالة النافذة السابقة إن وجدت
            const oldModal = document.getElementById('customModal');
            if (oldModal) oldModal.remove();
            
            // إضافة النافذة الجديدة
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('customModal'));
            modal.show();
            
            // إزالة النافذة عند الإغلاق
            document.getElementById('customModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // تحديث معلومات آخر تحديث
        function updateLastUpdateInfo() {
            const lastUpdateElement = document.getElementById('lastUpdateInfo');
            if (lastUpdateElement) {
                const now = new Date().toLocaleString('ar-SA');
                lastUpdateElement.innerHTML = `
                    <i class="fas fa-clock"></i> ${now} بواسطة ${currentUser || 'مستخدم غير معروف'}
                `;
            }
        }
        function addShareButton() {
            const schoolInfo = document.querySelector('.school-info .row');
            if (schoolInfo && currentSchoolId) {
                const shareDiv = document.createElement('div');
                shareDiv.className = 'col-12 mt-3';
                shareDiv.innerHTML = `
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-primary btn-sm" onclick="copySchoolId()">
                            <i class="fas fa-copy"></i> نسخ معرف المدرسة
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="loadSchoolById()">
                            <i class="fas fa-download"></i> تحميل بيانات مدرسة أخرى
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportBackup()">
                            <i class="fas fa-file-export"></i> نسخة احتياطية
                        </button>
                    </div>
                `;
                schoolInfo.appendChild(shareDiv);
            }
        }

        // نسخ معرف المدرسة
        function copySchoolId() {
            if (currentSchoolId) {
                navigator.clipboard.writeText(currentSchoolId).then(() => {
                    showToast('تم نسخ معرف المدرسة', 'success');
                }).catch(() => {
                    showToast('تعذر نسخ المعرف', 'warning');
                });
            }
        }

        // تحميل بيانات مدرسة أخرى
        async function loadSchoolById() {
            const schoolId = prompt('أدخل معرف المدرسة:');
            if (!schoolId || !db) return;

            try {
                const doc = await db.collection('schools').doc(schoolId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    // تحديث المعرف الحالي
                    currentSchoolId = schoolId;
                    localStorage.setItem('schoolId', currentSchoolId);
                    
                    // تحميل البيانات
                    if (data.schoolInfo) {
                        document.getElementById('schoolName').value = data.schoolInfo.name || '';
                        document.getElementById('principalName').value = data.schoolInfo.principal || '';
                        document.getElementById('reportDate').value = data.schoolInfo.reportDate || '';
                        document.getElementById('domain-1-responsible').value = data.schoolInfo.domain1Responsible || '';
                        document.getElementById('domain-2-responsible').value = data.schoolInfo.domain2Responsible || '';
                        document.getElementById('domain-3-responsible').value = data.schoolInfo.domain3Responsible || '';
                        document.getElementById('domain-4-responsible').value = data.schoolInfo.domain4Responsible || '';
                    }
                    
                    if (data.trackingData) {
                        trackingData = data.trackingData;
                        populateTables();
                        updateProgress();
                    }
                    
                    showSchoolId();
                    showToast('تم تحميل بيانات المدرسة بنجاح', 'success');
                    
                } else {
                    showToast('لا توجد بيانات لهذا المعرف', 'warning');
                }
                
            } catch (error) {
                console.error('خطأ في تحميل بيانات المدرسة:', error);
                showToast('تعذر تحميل بيانات المدرسة', 'danger');
            }
        }

        // تصدير نسخة احتياطية
        function exportBackup() {
            const backupData = {
                schoolId: currentSchoolId,
                schoolInfo: {
                    name: document.getElementById('schoolName')?.value || '',
                    principal: document.getElementById('principalName')?.value || '',
                    reportDate: document.getElementById('reportDate')?.value || '',
                    domain1Responsible: document.getElementById('domain-1-responsible')?.value || '',
                    domain2Responsible: document.getElementById('domain-2-responsible')?.value || '',
                    domain3Responsible: document.getElementById('domain-3-responsible')?.value || '',
                    domain4Responsible: document.getElementById('domain-4-responsible')?.value || ''
                },
                trackingData: trackingData,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${currentSchoolId}_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('تم تصدير النسخة الاحتياطية', 'success');
        }
        // Data structure for indicators
        const indicatorsData = {
            1: {
                title: "مجال الإدارة المدرسية",
                indicators: [
                    { code: "1-1-1-1", title: "تضع المدرسة خطة تشغيلية مكتملة العناصر", documents: ["سجل الخطة التشغيلية", "سجل برامج الخطة التشغيلية", "سجل اللجان المدرسية", "سجل التكليفات"] },
                    { code: "1-1-1-2", title: "تتابع المدرسة تنفيذ خطتها وتطورها", documents: ["سجل الخطة التشغيلية (قسم المتابعة والتقويم)", "سجل برامج النشاط", "سجل برامج الإرشاد", "سجل اللجنة الإدارية", "سجل توثيق البرامج", "سجل تطوير وتحسين الخطة التشغيلية"] },
                    { code: "1-2-1-1", title: "تعزز المدرسة القيم الإسلامية والهوية الوطنية", documents: ["سجل لجنة التوجيه والإرشاد", "سجل التوجيه والإرشاد", "سجل الأنشطة والبرامج"] },
                    { code: "1-2-1-2", title: "تلتزم المدرسة بقيم مهنة التعليم وأخلاقياتها", documents: ["سجل الاجتماعات", "سجل التبليغات", "سجل البرامج والأنشطة", "نشرات", "خطة متابعة السلوك الوظيفي", "سجل التحفيز والتكريم", "سجل المخالفات", "سجل حصر الغياب والتأخر", "سجل استئذان الموظفين"] },
                    { code: "1-2-1-3", title: "توفر المدرسة مناخًا آمنًا للتعلم والنمو", documents: ["سجل البرامج الوقائية والعلاجية", "سجل التوجيه والإرشاد", "سجل مجالس الحوار الطلابي", "سجل المخالفات السلوكية", "سجل الحالات الطارئة"] },
                    { code: "1-2-1-4", title: "تنشر المدرسة قواعد السلوك والمواظبة", documents: ["سجل التوجيه والإرشاد", "سجل الانضباط المدرسي", "سجل التوقيع على قواعد السلوك والمواظبة", "سجل الحالات الطارئة", "سجل المخالفات السلوكية", "سجل البرامج الوقائية والعلاجية", "سجل تعزيز السلوك الإيجابي"] },
                    { code: "1-2-1-5", title: "توفر المدرسة برامج وأنشطة تربوية داعمة للسلوك الإيجابي", documents: ["سجل تعزيز السلوك الإيجابي", "سجل لجنة التوجيه والإرشاد", "سجل التوجيه والإرشاد", "سجل المخالفات السلوكية"] },
                    { code: "1-2-1-6", title: "توفر المدرسة برامج وأنشطة إثرائية لتطوير مواهب المتعلمين", documents: ["سجل الأنشطة الإثرائية", "سجل الأنشطة والبرامج", "سجل لجنة التوجيه والإرشاد", "سجل الموهوبين", "سجل لجنة التميز", "سجل المسابقات"] },
                    { code: "1-3-1-1", title: "تعزز المدرسة العمل التعاوني والعلاقات الإيجابية", documents: ["سجل الخطة التشغيلية", "سجل البرامج والأنشطة", "سجل النمو المهني"] },
                    { code: "1-3-1-2", title: "تعزز المدرسة مشاركة الأسرة في تعلم أبنائها", documents: ["سجل استطلاع الرأي والاستبانات", "سجل التواصل مع أولياء الأمور", "ملف البرامج والأنشطة", "سجل التوجيه والإرشاد", "سجل مجالس أولياء الأمور"] },
                    { code: "1-3-1-3", title: "تعزز المدرسة الشراكة المجتمعية لدعم التعلم", documents: ["سجل الخطة التشغيلية", "سجل البرامج والأنشطة", "سجل الشراكة المجتمعية", "سجل التوجيه والإرشاد"] },
                    { code: "1-4-1-1", title: "توفر المدرسة كادرًا تعليميًا مكتملًا ومؤهلًا", documents: ["سجل أحوال الموظفين", "سجل التكاليف", "سجل اللجنة الإدارية", "سجل توزيع الأنصبة", "الجدول المدرسي", "بيانات الكادر التعليمي من نظام نور"] },
                    { code: "1-4-1-2", title: "توفر المدرسة كادرًا إداريًا مكتملًا ومؤهلًا", documents: ["سجل أحوال الموظفين", "سجل التكاليف", "سجل اللجنة الإدارية", "بيانات الكادر الإداري من نظام نور", "سجل الوصف الوظيفي"] },
                    { code: "1-4-1-3", title: "تظهر المدرسة ثباتًا واستدامة مالية", documents: ["سجل الخطة المالية", "سجل الموازنة المالية", "سجل فريق الصندوق المدرسي", "سجل السياسات المالية", "سجل تحصيل الرسوم", "استمارة الرسوم الدراسية", "الموقع الإلكتروني للمدرسة"] },
                    { code: "1-4-1-4", title: "تشجع المدرسة منسوبيها للحصول على الرخصة المهنية", documents: ["سجل الرخصة المهنية", "سجل النمو المهني"] },
                    { code: "1-4-1-5", title: "تدعم المدرسة التطوير المهني لمنسوبيها", documents: ["سجل النمو المهني"] },
                    { code: "1-4-1-6", title: "تطبق المدرسة التقويم الذاتي المبني على المعايير", documents: ["سجل لجنة التميز", "سجل التقويم الذاتي"] },
                    { code: "1-4-1-7", title: "تنفذ المدرسة خطة للتحسين بناءً على نتائج التقويم", documents: ["سجل تطوير وتحسين الخطة التشغيلية", "سجل اللجنة الإدارية"] }
                ]
            },
            2: {
                title: "مجال التعليم والتعلم",
                indicators: [
                    { code: "2-1-1-2", title: "تدعم المدرسة تنفيذ المناهج لتحقيق نواتج التعلم", documents: ["عينة من ملفات إنجاز المعلمين", "عينة من الأنشطة الصفية", "عينة من خطة توزيع المناهج", "ملف متابعة تنفيذ المنهج"] },
                    { code: "2-1-1-6", title: "تنمي المدرسة المهارات القرائية والعددية الأساسية", documents: ["سجل الأنشطة الإثرائية", "سجل الأنشطة العلاجية", "سجل المسابقات", "نتائج الاختبارات الوطنية", "سجل تحدي القراءة", "سجل سد الفجوة (للرياضيات)"] },
                    { code: "2-1-1-7", title: "تنمي المدرسة مهارات التفكير العليا لدى المتعلمين", documents: ["عينة من الأنشطة الصفية الخاصة بالمتعلمين"] },
                    { code: "2-2-1-1", title: "تقيم المدرسة أداء المتعلمين باستخدام أساليب متنوعة", documents: ["عينة من الأنشطة الصفية الخاصة بالمتعلمين", "سجل تحضير الدروس", "سجل النمو المهني"] },
                    { code: "2-2-1-2", title: "تحلل المدرسة نتائج التقويم وتوظفها في تحسين التعلم", documents: ["سجل تحليل النتائج (لمختلف التخصصات)", "سجل الأنشطة العلاجية", "سجل الأنشطة الإثرائية"] },
                    { code: "2-2-1-3", title: "تقدم المدرسة التغذية الراجعة للمتعلمين بانتظام", documents: ["سجل متابعة أداء المتعلمين", "سجل إنجاز المتعلمين / الكتب"] }
                ]
            },
            3: {
                title: "مجال نواتج التعلم",
                indicators: [
                    { code: "3-2-1-4", title: "يشارك المتعلمون في الأنشطة المجتمعية والأعمال التطوعية", documents: ["سجل العمل التطوعي", "سجل التوجيه والإرشاد"] },
                    { code: "3-2-1-5", title: "يلتزم المتعلمون بقواعد السلوك والانضباط المدرسي", documents: ["سجل المخالفات السلوكية", "سجل الانضباط المدرسي", "سجل التوجيه والإرشاد", "سجل التكريم"] }
                ]
            },
            4: {
                title: "مجال البيئة المدرسية",
                indicators: [
                    { code: "4-2-1-1", title: "تتوافر متطلبات الأمن والسلامة في جميع مرافق المدرسة", documents: ["سجل لجنة الأمن والسلامة", "شهادة الأمن والسلامة من الدفاع المدني (سارية)", "سجل الموجه الصحي", "الشهادات الصحية للعاملين سارية المفعول"] },
                    { code: "4-2-1-2", title: "تعمل المدرسة على صيانة جميع مرافق المبنى بانتظام", documents: ["سجل الصيانة الدورية", "سجل لجنة الأمن والسلامة"] }
                ]
            }
        };

        // Initialize data
        let trackingData = {};
        let currentModalIndicator = null;

        // Initialize application when DOM is loaded
        function initializeApp() {
            loadData();
            populateTables();
            updateProgress();
            setCurrentDate();
        }

        // Set current date
        function setCurrentDate() {
            const dateInput = document.getElementById('reportDate');
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        // Load initial data structure
        function loadData() {
            for (let domainId in indicatorsData) {
                if (!trackingData[domainId]) trackingData[domainId] = {};
                indicatorsData[domainId].indicators.forEach(indicator => {
                    if (!trackingData[domainId][indicator.code]) {
                        trackingData[domainId][indicator.code] = {
                            status: 'incomplete', 
                            progress: 0, 
                            comments: ''
                        };
                    }
                });
            }
        }

        // Populate all tables with data
        function populateTables() {
            for (let domainId in indicatorsData) {
                const tbody = document.getElementById(`domain-${domainId}-body`);
                if (tbody) {
                    tbody.innerHTML = '';
                    indicatorsData[domainId].indicators.forEach(indicator => {
                        const data = trackingData[domainId][indicator.code];
                        const row = createIndicatorRow(domainId, indicator, data);
                        tbody.appendChild(row);
                    });
                }
            }
        }

        // Create table row for indicator
        function createIndicatorRow(domainId, indicator, data) {
            const row = document.createElement('tr');
            const progressColor = data.progress >= 100 ? '#28a745' : data.progress >= 50 ? '#ffc107' : '#dc3545';
            
            row.innerHTML = `
                <td>
                    <strong>${indicator.code}</strong><br>
                    <small class="text-muted">${indicator.title}</small>
                </td>
                <td>
                    <select class="form-select form-select-sm" 
                            onchange="updateIndicatorData('${domainId}', '${indicator.code}', 'status', this.value)">
                        <option value="incomplete" ${data.status === 'incomplete' ? 'selected' : ''}>❌ غير مكتمل</option>
                        <option value="complete" ${data.status === 'complete' ? 'selected' : ''}>✅ مكتمل</option>
                    </select>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <input type="range" class="form-range me-2" min="0" max="100" 
                               value="${data.progress}" 
                               onchange="updateIndicatorData('${domainId}', '${indicator.code}', 'progress', this.value)"
                               style="width: 80px;">
                        <span class="badge" style="background-color: ${progressColor}; color: white; font-size: 0.8rem;">
                            ${data.progress}%
                        </span>
                    </div>
                </td>
                <td>
                    <button class="btn btn-outline-primary btn-view-docs w-100" 
                            onclick="showDocuments('${domainId}', '${indicator.code}')">
                        <i class="fas fa-eye"></i> عرض الوثائق والملاحظات
                    </button>
                </td>
            `;
            return row;
        }

        // Update indicator data with activity logging
        function updateIndicatorData(domainId, indicatorCode, field, value) {
            if (trackingData[domainId] && trackingData[domainId][indicatorCode]) {
                const oldValue = trackingData[domainId][indicatorCode][field];
                trackingData[domainId][indicatorCode][field] = value;
                
                if (field === 'progress') {
                    trackingData[domainId][indicatorCode].status = parseInt(value) >= 100 ? 'complete' : 'incomplete';
                    populateTables();
                }
                updateProgress();
                
                // تسجيل النشاط
                if (currentUser) {
                    const indicator = indicatorsData[domainId].indicators.find(ind => ind.code === indicatorCode);
                    logActivity(
                        `تحديث المؤشر ${indicatorCode}`,
                        `${indicator?.title}: ${field} من ${oldValue} إلى ${value}`
                    );
                }
                
                // حفظ تلقائي بعد تحديث البيانات
                if (db && currentSchoolId) {
                    setTimeout(saveToFirebase, 500);
                }
            }
        }

        // Save comments with activity logging
        function saveComments() {
            if (currentModalIndicator) {
                const comments = document.getElementById('modalComments').value;
                const {domainId, indicatorCode} = currentModalIndicator;
                trackingData[domainId][indicatorCode].comments = comments;
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('documentsModal'));
                modal.hide();
                
                showToast('تم حفظ الملاحظات بنجاح', 'success');
                
                // تسجيل النشاط
                if (currentUser) {
                    logActivity(
                        `إضافة ملاحظة للمؤشر ${indicatorCode}`,
                        `تم حفظ ملاحظة جديدة`
                    );
                }
                
                // حفظ تلقائي
                if (db && currentSchoolId) {
                    setTimeout(saveToFirebase, 500);
                }
            }
        }

        // Enhanced PDF export with user tracking
        async function exportToPDF(domainId) {
            try {
                showToast('جاري إنشاء التقرير...', 'info');
                
                // تسجيل النشاط
                if (currentUser) {
                    const domainTitle = indicatorsData[domainId]?.title || 'مجال غير محدد';
                    logActivity('تصدير تقرير PDF', `تصدير تقرير ${domainTitle}`);
                }
                
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                
                // Create new PDF document
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                await generateSinglePagePDFReport(pdf, domainId);
                
                // Generate filename
                const domainTitle = indicatorsData[domainId]?.title || 'مجال_غير_محدد';
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `تقرير_${domainTitle.replace(/\s+/g, '_')}_${timestamp}.pdf`;
                
                // Save the PDF
                pdf.save(filename);
                showToast('تم إنشاء التقرير بنجاح', 'success');
                
            } catch (error) {
                console.error('PDF Generation Error:', error);
                showToast('حدث خطأ في إنشاء PDF. جاري المحاولة بطريقة بديلة...', 'warning');
                
                // Fallback to print method
                try {
                    await exportToPrint(domainId);
                } catch (fallbackError) {
                    showToast('عذراً، تعذر إنشاء التقرير. يرجى المحاولة مرة أخرى.', 'danger');
                }
            }
        }

        // Initialize application with user system
        function initializeApp() {
            loadData();
            populateTables();
            updateProgress();
            setCurrentDate();
            
            // تهيئة نظام المستخدمين
            initializeUserSystem();
            
            // تمكين الحفظ التلقائي إذا كان Firebase متاحاً
            if (db) {
                enableAutoSave();
                addShareButton();
            }
        }

        // Initialize application
        function initializeApp() {
            loadData();
            populateTables();
            updateProgress();
            setCurrentDate();
            
            // تمكين الحفظ التلقائي إذا كان Firebase متاحاً
            if (db) {
                enableAutoSave();
                addShareButton();
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // محاولة تهيئة Firebase أولاً
            if (typeof firebase !== 'undefined') {
                initializeFirebase();
            } else {
                console.log('Firebase غير متاح، سيتم العمل بالوضع المحلي');
                initializeApp();
            }
        });

        // Update progress bars
        function updateProgress() {
            for (let domainId in indicatorsData) {
                const indicators = indicatorsData[domainId].indicators;
                let totalProgress = 0;
                
                indicators.forEach(indicator => {
                    const data = trackingData[domainId][indicator.code];
                    totalProgress += parseInt(data ? data.progress : 0);
                });
                
                const averageProgress = Math.round(totalProgress / indicators.length);
                const progressBar = document.getElementById(`progress-${domainId}`);
                const progressText = document.getElementById(`progress-text-${domainId}`);
                
                if (progressBar && progressText) {
                    progressBar.style.width = `${averageProgress}%`;
                    progressText.textContent = `نسبة الإنجاز: ${averageProgress}%`;
                }
            }
        }

        // Show documents modal
        function showDocuments(domainId, indicatorCode) {
            const indicator = indicatorsData[domainId].indicators.find(ind => ind.code === indicatorCode);
            if (!indicator) return;
            
            currentModalIndicator = {domainId, indicatorCode};
            
            document.getElementById('modalTitle').textContent = `الوثائق المطلوبة - المؤشر ${indicatorCode}`;
            
            const documentsContainer = document.getElementById('requiredDocuments');
            documentsContainer.innerHTML = '';
            
            indicator.documents.forEach(doc => {
                const docElement = document.createElement('div');
                docElement.className = 'document-item';
                docElement.innerHTML = `<i class="fas fa-file-alt me-2"></i>${doc}`;
                documentsContainer.appendChild(docElement);
            });
            
            const comments = trackingData[domainId][indicatorCode].comments || '';
            document.getElementById('modalComments').value = comments;
            
            const modal = new bootstrap.Modal(document.getElementById('documentsModal'));
            modal.show();
        }

        // Save comments
        function saveComments() {
            if (currentModalIndicator) {
                const comments = document.getElementById('modalComments').value;
                const {domainId, indicatorCode} = currentModalIndicator;
                trackingData[domainId][indicatorCode].comments = comments;
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('documentsModal'));
                modal.hide();
                
                showToast('تم حفظ الملاحظات بنجاح', 'success');
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>${message}
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => { 
                if (toast.parentElement) toast.remove(); 
            }, 3000);
        }

        // Professional PDF Export with Arabic Support
        async function exportToPDF(domainId) {
            try {
                showToast('جاري إنشاء التقرير...', 'info');
                
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                
                // Create new PDF document
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                await generateSinglePagePDFReport(pdf, domainId);
                
                // Generate filename
                const domainTitle = indicatorsData[domainId]?.title || 'مجال_غير_محدد';
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `تقرير_${domainTitle.replace(/\s+/g, '_')}_${timestamp}.pdf`;
                
                // Save the PDF
                pdf.save(filename);
                showToast('تم إنشاء التقرير بنجاح', 'success');
                
            } catch (error) {
                console.error('PDF Generation Error:', error);
                showToast('حدث خطأ في إنشاء PDF. جاري المحاولة بطريقة بديلة...', 'warning');
                
                // Fallback to print method
                try {
                    await exportToPrint(domainId);
                } catch (fallbackError) {
                    showToast('عذراً، تعذر إنشاء التقرير. يرجى المحاولة مرة أخرى.', 'danger');
                }
            }
        }

        // Generate single-page PDF report
        async function generateSinglePagePDFReport(pdf, domainId) {
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            let currentY = margin;
            
            // Get data
            const schoolName = document.getElementById('schoolName')?.value || 'متوسطة المنذر بن عمرو الأنصاري';
            const principalName = document.getElementById('principalName')?.value || 'خالد سعود المطيري';
            const reportDate = document.getElementById('reportDate')?.value || new Date().toISOString().split('T')[0];
            const domainTitle = indicatorsData[domainId]?.title || 'مجال غير محدد';
            const domainResponsible = document.getElementById(`domain-${domainId}-responsible`)?.value || 'غير محدد';
            const arabicDate = new Date(reportDate).toLocaleDateString('ar-SA');
            
            // Calculate statistics
            let totalProgress = 0, completedCount = 0, totalIndicators = 0;
            if (indicatorsData[domainId]?.indicators) {
                totalIndicators = indicatorsData[domainId].indicators.length;
                indicatorsData[domainId].indicators.forEach(indicator => {
                    const data = trackingData[domainId]?.[indicator.code] || { progress: 0, status: 'incomplete' };
                    totalProgress += parseInt(data.progress || 0);
                    if (data.status === 'complete') completedCount++;
                });
            }
            const averageProgress = totalIndicators > 0 ? Math.round(totalProgress / totalIndicators) : 0;

            // Header Section
            pdf.setFillColor(44, 85, 48);
            pdf.rect(0, 0, pageWidth, 45, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(12);
            pdf.text('المملكة العربية السعودية', pageWidth/2, 10, { align: 'center' });
            pdf.setFontSize(14);
            pdf.text('وزارة التعليم', pageWidth/2, 17, { align: 'center' });
            pdf.setFontSize(10);
            pdf.text('مكتب قطاع أحد والعوالي', pageWidth/2, 24, { align: 'center' });
            pdf.setFontSize(16);
            pdf.text('تقرير متابعة مؤشرات التقويم المدرسي', pageWidth/2, 35, { align: 'center' });
            
            currentY = 50;
            
            // School Information
            pdf.setFillColor(248, 249, 250);
            pdf.rect(margin, currentY, pageWidth - 2*margin, 25, 'F');
            pdf.setDrawColor(44, 85, 48);
            pdf.rect(margin, currentY, pageWidth - 2*margin, 25, 'S');
            
            pdf.setTextColor(44, 85, 48);
            pdf.setFontSize(12);
            pdf.text('معلومات المدرسة', margin + 5, currentY + 6);
            
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(9);
            pdf.text(`اسم المدرسة: ${schoolName}`, margin + 5, currentY + 12);
            pdf.text(`مدير المدرسة: ${principalName}`, margin + 5, currentY + 17);
            pdf.text(`تاريخ التقرير: ${arabicDate}`, pageWidth - margin - 60, currentY + 12);
            pdf.text(`المسؤول: ${domainResponsible}`, pageWidth - margin - 60, currentY + 17);
            
            currentY += 30;
            
            // Domain Section
            pdf.setFillColor(44, 85, 48);
            pdf.rect(margin, currentY, pageWidth - 2*margin, 15, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(14);
            pdf.text(`${domainTitle} - نسبة الإنجاز: ${averageProgress}%`, pageWidth/2, currentY + 10, { align: 'center' });
            
            currentY += 20;
            
            // Table
            const tableData = [];
            if (indicatorsData[domainId]?.indicators) {
                indicatorsData[domainId].indicators.forEach(indicator => {
                    const data = trackingData[domainId]?.[indicator.code] || { status: 'incomplete', progress: 0 };
                    const statusText = data.status === 'complete' ? 'مكتمل' : 'غير مكتمل';
                    tableData.push([
                        indicator.code,
                        indicator.title.length > 40 ? indicator.title.substring(0, 37) + '...' : indicator.title,
                        statusText,
                        `${data.progress}%`
                    ]);
                });
            }
            
            pdf.autoTable({
                head: [['المؤشر', 'الوصف', 'الحالة', 'النسبة']],
                body: tableData,
                startY: currentY,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [44, 85, 48],
                    textColor: 255
                },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 90 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 30 }
                }
            });
            
            // Summary
            const finalY = pdf.lastAutoTable.finalY + 10;
            pdf.setFillColor(248, 249, 250);
            pdf.rect(margin, finalY, pageWidth - 2*margin, 15, 'F');
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(9);
            pdf.text(`الملخص: إجمالي: ${totalIndicators} | مكتمل: ${completedCount} | متبقي: ${totalIndicators - completedCount} | النسبة: ${averageProgress}%`, 
                     pageWidth/2, finalY + 8, { align: 'center' });
            
            // Footer
            pdf.setFillColor(44, 85, 48);
            pdf.rect(0, pageHeight - 20, pageWidth, 20, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(10);
            pdf.text('نُراقب • نُقيم • نُطور - تنفيذ: نواف الصبحي', pageWidth/2, pageHeight - 10, { align: 'center' });
        }

        // Fallback print method
        async function exportToPrint(domainId) {
            const printWindow = window.open('', '_blank');
            const reportHTML = generateCompactPrintableReport(domainId);
            
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                setTimeout(() => printWindow.close(), 1000);
            }, 500);
            
            showToast('تم فتح نافذة الطباعة', 'success');
        }

        // Generate compact HTML for printing
        function generateCompactPrintableReport(domainId) {
            const schoolName = document.getElementById('schoolName')?.value || 'متوسطة المنذر بن عمرو الأنصاري';
            const principalName = document.getElementById('principalName')?.value || 'خالد سعود المطيري';
            const domainTitle = indicatorsData[domainId]?.title || 'مجال غير محدد';
            const domainResponsible = document.getElementById(`domain-${domainId}-responsible`)?.value || 'غير محدد';
            const arabicDate = new Date().toLocaleDateString('ar-SA');
            
            let tableRows = '';
            if (indicatorsData[domainId]?.indicators) {
                indicatorsData[domainId].indicators.forEach((indicator, index) => {
                    const data = trackingData[domainId]?.[indicator.code] || { status: 'incomplete', progress: 0 };
                    const statusText = data.status === 'complete' ? '✓ مكتمل' : '✗ غير مكتمل';
                    const bgColor = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
                    
                    tableRows += `
                        <tr style="background-color: ${bgColor};">
                            <td style="padding: 3px; font-size: 8px;">${indicator.code}</td>
                            <td style="padding: 3px; font-size: 8px;">${indicator.title}</td>
                            <td style="padding: 3px; font-size: 8px; text-align: center;">${statusText}</td>
                            <td style="padding: 3px; font-size: 8px; text-align: center;">${data.progress}%</td>
                        </tr>
                    `;
                });
            }
            
            return `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير متابعة مؤشرات التقويم المدرسي</title>
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: Arial, sans-serif; font-size: 10px; direction: rtl; }
                        .header { background: #2c5530; color: white; padding: 10px; text-align: center; }
                        table { width: 100%; border-collapse: collapse; font-size: 8px; }
                        th, td { border: 1px solid #ddd; padding: 3px; }
                        th { background: #2c5530; color: white; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>المملكة العربية السعودية - وزارة التعليم</h2>
                        <h3>تقرير متابعة مؤشرات التقويم المدرسي</h3>
                        <p>المدرسة: ${schoolName} | المدير: ${principalName} | المسؤول: ${domainResponsible}</p>
                    </div>
                    <h3>${domainTitle}</h3>
                    <table>
                        <thead>
                            <tr><th>المؤشر</th><th>الوصف</th><th>الحالة</th><th>النسبة</th></tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </body>
                </html>
            `;
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Mobile optimizations
        if ('ontouchstart' in window) {
            document.addEventListener('touchstart', function() {}, true);
        }
        
        window.addEventListener('orientationchange', function() {
            setTimeout(updateProgress, 100);
        });
    </script>
</body>
</html>
