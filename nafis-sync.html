<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ - Ù†Ø§Ù‚Ø³ (Ù…ÙØµØ­Ø­)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .solution-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sync-indicator.active {
            background: #27ae60;
        }

        .sync-indicator.error {
            background: #e74c3c;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .status-item {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .status-item.success {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .status-item.error {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .test-results {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .log-entry.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .log-entry.error {
            background: #ffebee;
            color: #c62828;
        }

        .log-entry.warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .implementation-area {
            background: #1a202c;
            color: #e2e8f0;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .controls-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="sync-indicator" id="syncStatus">
        ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙØµØ­Ø­Ø©</h1>
            <p>Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ ÙˆÙ…ÙˆØ«ÙˆÙ‚ Ù„ØªØ²Ø§Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚Ø³</p>
        </div>

        <div class="solution-card">
            <h2>ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h2>
            
            <div class="status-grid">
                <div class="status-item" id="systemStatusCard">
                    <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:</strong>
                    <span id="systemStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</span>
                </div>
                <div class="status-item" id="dailyStatusCard">
                    <strong>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©:</strong>
                    <span id="testDailyCount">0</span>
                </div>
                <div class="status-item" id="weeklyStatusCard">
                    <strong>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©:</strong>
                    <span id="testWeeklyCount">0</span>
                </div>
                <div class="status-item" id="syncTimeCard">
                    <strong>Ø¢Ø®Ø± ØªØ²Ø§Ù…Ù†:</strong>
                    <span id="lastSyncTime">Ù„Ù… ÙŠØªÙ… Ø¨Ø¹Ø¯</span>
                </div>
            </div>

            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="controls-section">
                <button class="btn" onclick="testAddQuestion()">Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
                <button class="btn" onclick="testSync()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ²Ø§Ù…Ù†</button>
                <button class="btn" onclick="testLoadQuestions()">Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
                <button class="btn success" onclick="runFullTest()">Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„</button>
                <button class="btn danger" onclick="clearTestData()">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
                <button class="btn" onclick="exportDiagnostics()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ</button>
            </div>
            
            <div id="testResults" class="test-results" style="display: none;">
                <h4>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…:</h4>
                <div id="testOutput"></div>
            </div>
        </div>

        <div class="solution-card">
            <h2>ğŸ”§ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ</h2>
            
            <div class="controls-section">
                <button class="btn" onclick="checkDataIntegrity()">ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button class="btn" onclick="repairData()">Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©</button>
                <button class="btn" onclick="migrateOldData()">ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</button>
                <button class="btn" onclick="resetSystem()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            </div>
        </div>
    </div>

    <script>
        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ Ø§Ù„Ù…ÙØµØ­Ø­ ÙˆØ§Ù„ÙƒØ§Ù…Ù„
        class UnifiedSyncSystem {
            constructor() {
                this.STORAGE_KEYS = {
                    DAILY_QUESTIONS: 'nafis_unified_daily_questions',
                    WEEKLY_QUESTIONS: 'nafis_unified_weekly_questions',
                    LAST_UPDATE: 'nafis_unified_last_update',
                    SYNC_STATUS: 'nafis_unified_sync_status',
                    HEARTBEAT: 'nafis_unified_heartbeat'
                };
                
                this.channels = [];
                this.retryCount = 0;
                this.maxRetries = 5;
                this.heartbeatInterval = null;
                this.listeners = [];
                this.isInitialized = false;
                
                this.init();
            }
            
            init() {
                try {
                    this.log('Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…ÙˆØ­Ø¯...', 'info');
                    
                    this.setupChannels();
                    this.setupHeartbeat();
                    this.setupRetryMechanism();
                    this.bindStorageEvents();
                    this.migrateExistingData();
                    this.updateSystemStatus('Ù†Ø´Ø· ÙˆÙ…ØªØµÙ„');
                    this.updateQuestionCounts();
                    
                    this.isInitialized = true;
                    this.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                    // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø©
                    this.updateSyncIndicator('active', 'Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ù†Ø´Ø·');
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${error.message}`, 'error');
                    this.updateSyncIndicator('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
                }
            }
            
            setupChannels() {
                try {
                    // BroadcastChannel
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('nafis-unified-sync');
                        channel.onmessage = (e) => this.handleMessage(e.data);
                        this.channels.push(channel);
                        this.log('ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ BroadcastChannel', 'info');
                    }
                    
                    // Window Message Listener
                    window.addEventListener('message', (e) => {
                        if (e.data && e.data.source === 'nafis-sync') {
                            this.handleMessage(e.data);
                        }
                    });
                    
                    // Storage Events
                    window.addEventListener('storage', (e) => {
                        if (e.key && e.key.startsWith('nafis_unified_')) {
                            this.handleStorageChange(e);
                        }
                    });
                    
                    this.log('ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø§ØªØµØ§Ù„', 'success');
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª: ${error.message}`, 'error');
                }
            }
            
            setupHeartbeat() {
                try {
                    this.heartbeatInterval = setInterval(() => {
                        const heartbeat = {
                            timestamp: Date.now(),
                            source: 'sync-system',
                            questions: {
                                daily: this.getQuestionCount('daily'),
                                weekly: this.getQuestionCount('weekly')
                            },
                            status: this.isInitialized ? 'active' : 'initializing'
                        };
                        
                        localStorage.setItem(this.STORAGE_KEYS.HEARTBEAT, JSON.stringify(heartbeat));
                        this.broadcast({
                            type: 'HEARTBEAT',
                            data: heartbeat
                        });
                    }, 5000);
                    
                    this.log('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¢Ù„ÙŠØ© Heartbeat', 'info');
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Heartbeat: ${error.message}`, 'error');
                }
            }
            
            setupRetryMechanism() {
                setInterval(() => {
                    try {
                        const lastHeartbeat = localStorage.getItem(this.STORAGE_KEYS.HEARTBEAT);
                        if (lastHeartbeat) {
                            const heartbeat = JSON.parse(lastHeartbeat);
                            const timeDiff = Date.now() - heartbeat.timestamp;
                            
                            if (timeDiff > 15000) { // 15 Ø«Ø§Ù†ÙŠØ©
                                this.log('Ø§Ù†Ù‚Ø·Ø§Ø¹ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†...', 'warning');
                                this.forceSync();
                            }
                        }
                    } catch (error) {
                        this.log(`Ø®Ø·Ø£ ÙÙŠ Ø¢Ù„ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: ${error.message}`, 'error');
                    }
                }, 10000);
            }
            
            bindStorageEvents() {
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª localStorage
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = (...args) => {
                    originalSetItem.apply(localStorage, args);
                    if (args[0].startsWith('nafis_unified_')) {
                        setTimeout(() => this.handleLocalStorageUpdate(args[0], args[1]), 100);
                    }
                };
            }
            
            migrateExistingData() {
                try {
                    this.log('Ø¨Ø¯Ø¡ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©...', 'info');
                    
                    // ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                    const oldDaily = localStorage.getItem('adminDailyQuestions');
                    if (oldDaily && !localStorage.getItem(this.STORAGE_KEYS.DAILY_QUESTIONS)) {
                        const questions = JSON.parse(oldDaily);
                        this.saveQuestions('daily', questions, false);
                        this.log(`ØªÙ… ØªØ±Ø­ÙŠÙ„ ${questions.length} Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ`, 'success');
                    }
                    
                    // ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                    const oldWeekly = localStorage.getItem('adminWeeklyQuestions');
                    if (oldWeekly && !localStorage.getItem(this.STORAGE_KEYS.WEEKLY_QUESTIONS)) {
                        const questions = JSON.parse(oldWeekly);
                        this.saveQuestions('weekly', questions, false);
                        this.log(`ØªÙ… ØªØ±Ø­ÙŠÙ„ ${questions.length} Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ`, 'success');
                    }
                    
                    this.log('Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ±Ø­ÙŠÙ„', 'info');
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                }
            }
            
            broadcast(message) {
                const payload = {
                    ...message,
                    source: 'nafis-sync',
                    timestamp: Date.now(),
                    id: Math.random().toString(36).substr(2, 9)
                };
                
                try {
                    // BroadcastChannel
                    this.channels.forEach(channel => {
                        try {
                            channel.postMessage(payload);
                        } catch (e) {
                            this.log('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± BroadcastChannel', 'warning');
                        }
                    });
                    
                    // PostMessage
                    window.postMessage(payload, '*');
                    
                    // Storage Event Trigger
                    const tempKey = `nafis_temp_${payload.id}`;
                    localStorage.setItem(tempKey, JSON.stringify(payload));
                    localStorage.removeItem(tempKey);
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø«: ${error.message}`, 'error');
                }
            }
            
            saveQuestions(type, questions, shouldBroadcast = true) {
                try {
                    const key = type === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    const data = {
                        questions: questions,
                        timestamp: Date.now(),
                        checksum: this.calculateChecksum(questions),
                        version: '2.0'
                    };
                    
                    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯
                    localStorage.setItem(key, JSON.stringify(data));
                    
                    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„ØªÙˆØ§ÙÙ‚
                    const oldKey = type === 'daily' ? 'adminDailyQuestions' : 'adminWeeklyQuestions';
                    localStorage.setItem(oldKey, JSON.stringify(questions));
                    localStorage.setItem(`nafisMain${type === 'daily' ? 'Daily' : 'Weekly'}Questions`, JSON.stringify(questions));
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
                    localStorage.setItem(this.STORAGE_KEYS.LAST_UPDATE, Date.now().toString());
                    localStorage.setItem(this.STORAGE_KEYS.SYNC_STATUS, 'success');
                    
                    if (shouldBroadcast) {
                        this.broadcast({
                            type: 'QUESTIONS_UPDATED',
                            questionType: type,
                            data: data,
                            count: questions.length
                        });
                    }
                    
                    this.updateQuestionCounts();
                    this.updateLastSyncTime();
                    
                    this.log(`ØªÙ… Ø­ÙØ¸ ${questions.length} Ø³Ø¤Ø§Ù„ ${type}`, 'success');
                    return true;
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${error.message}`, 'error');
                    localStorage.setItem(this.STORAGE_KEYS.SYNC_STATUS, 'error');
                    return false;
                }
            }
            
            loadQuestions(type) {
                try {
                    const key = type === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    const stored = localStorage.getItem(key);
                    if (!stored) {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
                        const oldKey = type === 'daily' ? 'adminDailyQuestions' : 'adminWeeklyQuestions';
                        const oldData = localStorage.getItem(oldKey);
                        return oldData ? JSON.parse(oldData) : [];
                    }
                    
                    const data = JSON.parse(stored);
                    
                    if (this.validateData(data)) {
                        return data.questions || [];
                    } else {
                        this.log(`Ø¨ÙŠØ§Ù†Ø§Øª ${type} ØªØ§Ù„ÙØ©ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©`, 'warning');
                        return [];
                    }
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¦Ù„Ø© ${type}: ${error.message}`, 'error');
                    return [];
                }
            }
            
            calculateChecksum(data) {
                try {
                    const str = JSON.stringify(data);
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        const char = str.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return hash.toString();
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Checksum: ${error.message}`, 'error');
                    return '';
                }
            }
            
            validateData(data) {
                if (!data || !data.questions || !Array.isArray(data.questions)) {
                    return false;
                }
                
                if (data.checksum && this.calculateChecksum(data.questions) !== data.checksum) {
                    this.log('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Checksum', 'warning');
                    return false;
                }
                
                return true;
            }
            
            handleMessage(message) {
                if (!message || message.source !== 'nafis-sync') return;
                
                try {
                    switch (message.type) {
                        case 'QUESTIONS_UPDATED':
                            this.handleQuestionsUpdate(message);
                            break;
                        case 'HEARTBEAT':
                            this.handleHeartbeat(message);
                            break;
                        case 'SYNC_REQUEST':
                            this.handleSyncRequest(message);
                            break;
                        default:
                            this.log(`Ù†ÙˆØ¹ Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ${message.type}`, 'warning');
                    }
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${error.message}`, 'error');
                }
            }
            
            handleQuestionsUpdate(message) {
                const { questionType, data } = message;
                
                if (this.validateData(data)) {
                    const key = questionType === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    localStorage.setItem(key, JSON.stringify(data));
                    this.updateQuestionCounts();
                    
                    this.log(`ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ« ${questionType}: ${data.questions.length} Ø³Ø¤Ø§Ù„`, 'success');
                }
            }
            
            handleHeartbeat(message) {
                this.log(`Ù†Ø¨Ø¶Ø© Ù…Ù† ${message.data?.source || 'Ù…ØµØ¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`, 'info');
                this.updateSyncIndicator('active', 'Ù…ØªØµÙ„ ÙˆÙ†Ø´Ø·');
            }
            
            handleSyncRequest(message) {
                this.log('Ø·Ù„Ø¨ ØªØ²Ø§Ù…Ù† ÙˆØ§Ø±Ø¯', 'info');
                this.forceSync();
            }
            
            handleStorageChange(e) {
                this.log(`ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†: ${e.key}`, 'info');
                setTimeout(() => this.updateQuestionCounts(), 500);
            }
            
            handleLocalStorageUpdate(key, value) {
                this.log(`ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ: ${key}`, 'info');
                setTimeout(() => this.updateQuestionCounts(), 100);
            }
            
            forceSync() {
                this.log('ÙØ±Ø¶ Ø§Ù„ØªØ²Ø§Ù…Ù†...', 'info');
                this.broadcast({
                    type: 'SYNC_REQUEST',
                    timestamp: Date.now()
                });
            }
            
            getQuestionCount(type) {
                const questions = this.loadQuestions(type);
                return questions.length;
            }
            
            updateSystemStatus(status) {
                const element = document.getElementById('systemStatus');
                const card = document.getElementById('systemStatusCard');
                if (element) {
                    element.textContent = status;
                    if (card) {
                        card.className = status.includes('Ù†Ø´Ø·') ? 'status-item success' : 'status-item';
                    }
                }
            }
            
            updateQuestionCounts() {
                const dailyCount = this.getQuestionCount('daily');
                const weeklyCount = this.getQuestionCount('weekly');
                
                const dailyElement = document.getElementById('testDailyCount');
                const weeklyElement = document.getElementById('testWeeklyCount');
                const dailyCard = document.getElementById('dailyStatusCard');
                const weeklyCard = document.getElementById('weeklyStatusCard');
                
                if (dailyElement) {
                    dailyElement.textContent = dailyCount;
                    if (dailyCard) {
                        dailyCard.className = dailyCount > 0 ? 'status-item success' : 'status-item';
                    }
                }
                
                if (weeklyElement) {
                    weeklyElement.textContent = weeklyCount;
                    if (weeklyCard) {
                        weeklyCard.className = weeklyCount > 0 ? 'status-item success' : 'status-item';
                    }
                }
            }
            
            updateLastSyncTime() {
                const element = document.getElementById('lastSyncTime');
                const card = document.getElementById('syncTimeCard');
                if (element) {
                    element.textContent = new Date().toLocaleString('ar-SA');
                    if (card) {
                        card.className = 'status-item success';
                    }
                }
            }
            
            updateSyncIndicator(status, text) {
                const indicator = document.getElementById('syncStatus');
                if (indicator) {
                    indicator.className = `sync-indicator ${status}`;
                    indicator.textContent = text;
                }
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                console.log(`[${timestamp}] ${message}`);
                
                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
                const output = document.getElementById('testOutput');
                if (output) {
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry ${type}`;
                    logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                    output.insertBefore(logEntry, output.firstChild);
                    
                    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 50 Ø¥Ø¯Ø®Ø§Ù„ ÙÙ‚Ø·
                    while (output.children.length > 50) {
                        output.removeChild(output.lastChild);
                    }
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    document.getElementById('testResults').style.display = 'block';
                }
            }
            
            destroy() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                }
                
                this.channels.forEach(channel => {
                    try {
                        channel.close();
                    } catch (e) {}
                });
                
                this.listeners = [];
                this.log('ØªÙ… ØªÙ†Ø¸ÙŠÙ Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…', 'info');
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø«ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
        window.unifiedSync = new UnifiedSyncSystem();

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        function testAddQuestion() {
            showProgress(0);
            window.unifiedSync.log('Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„...', 'info');
            
            const testQuestion = {
                id: Date.now(),
                subject: 'Ø§Ø®ØªØ¨Ø§Ø±',
                question: 'Ù‡Ø°Ø§ Ø³Ø¤Ø§Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„ØªØ²Ø§Ù…Ù† - ' + new Date().toLocaleTimeString('ar-SA'),
                options: ['Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹'],
                correct: Math.floor(Math.random() * 4),
                explanation: 'ØªÙØ³ÙŠØ± ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±',
                type: 'daily',
                createdAt: new Date().toLocaleString('ar-SA')
            };
            
            showProgress(30);
            
            setTimeout(() => {
                const currentQuestions = window.unifiedSync.loadQuestions('daily');
                currentQuestions.push(testQuestion);
                
                showProgress(60);
                
                const success = window.unifiedSync.saveQuestions('daily', currentQuestions);
                
                showProgress(100);
                
                if (success) {
                    window.unifiedSync.log('âœ… Ù†Ø¬Ø­ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„', 'success');
                } else {
                    window.unifiedSync.log('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„', 'error');
                }
                
                hideProgress();
            }, 1000);
        }

        function testSync() {
            window.unifiedSync.log('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„ÙÙˆØ±ÙŠ...', 'info');
            window.unifiedSync.forceSync();
            
            setTimeout(() => {
                window.unifiedSync.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†', 'success');
            }, 500);
        }

        function testLoadQuestions() {
            window.unifiedSync.log('Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...', 'info');
            
            const dailyQuestions = window.unifiedSync.loadQuestions('daily');
            const weeklyQuestions = window.unifiedSync.loadQuestions('weekly');
            
            window.unifiedSync.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${dailyQuestions.length} Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ`, 'success');
            window.unifiedSync.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${weeklyQuestions.length} Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ`, 'success');
            
            // Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            let validDaily = 0;
            let validWeekly = 0;
            
            dailyQuestions.forEach(q => {
                if (q.question && q.options && q.options.length === 4) {
                    validDaily++;
                }
            });
            
            weeklyQuestions.forEach(q => {
                if (q.question && q.options && q.options.length === 4) {
                    validWeekly++;
                }
            });
            
            window.unifiedSync.log(`ØµØ§Ù„Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${validDaily} ÙŠÙˆÙ…ÙŠØŒ ${validWeekly} Ø£Ø³Ø¨ÙˆØ¹ÙŠ`, 'info');
        }

        function runFullTest() {
            window.unifiedSync.log('Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ù†Ø¸Ø§Ù…...', 'info');
            showProgress(0);
            
            let testStep = 1;
            const totalSteps = 6;
            
            function nextStep() {
                showProgress((testStep / totalSteps) * 100);
                
                switch(testStep) {
                    case 1:
                        window.unifiedSync.log(`Ø§Ù„Ø®Ø·ÙˆØ© ${testStep}: ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ø¸Ø§Ù…`, 'info');
                        checkDataIntegrity();
                        break;
                    case 2:
                        window.unifiedSync.log(`Ø§Ù„Ø®Ø·ÙˆØ© ${testStep}: Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„`, 'info');
                        testAddQuestion();
                        break;
                    case 3:
                        window.unifiedSync.log(`Ø§Ù„Ø®Ø·ÙˆØ© ${testStep}: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ²Ø§Ù…Ù†`, 'info');
                        testSync();
                        break;
                    case 4:
                        window.unifiedSync.log(`Ø§Ù„Ø®Ø·ÙˆØ© ${testStep}: Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`, 'info');
                        testLoadQuestions();
                        break;
                    case 5:
                        window.unifiedSync.log(`Ø§Ù„Ø®Ø·ÙˆØ© ${testStep}: ÙØ­Øµ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…`, 'info');
                        testBackwardCompatibility();
                        break;
                    case 6:
                        window.unifiedSync.log(`Ø§Ù„Ø®Ø·ÙˆØ© ${testStep}: ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©`, 'success');
                        generateTestReport();
                        hideProgress();
                        return;
                }
                
                testStep++;
                setTimeout(nextStep, 2000);
            }
            
            nextStep();
        }

        function testBackwardCompatibility() {
            window.unifiedSync.log('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…...', 'info');
            
            // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
            const oldDaily = localStorage.getItem('adminDailyQuestions');
            const oldWeekly = localStorage.getItem('adminWeeklyQuestions');
            const oldMain = localStorage.getItem('nafisMainDailyQuestions');
            
            if (oldDaily) {
                window.unifiedSync.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠÙˆÙ…ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©', 'info');
            }
            if (oldWeekly) {
                window.unifiedSync.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©', 'info');
            }
            if (oldMain) {
                window.unifiedSync.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'info');
            }
            
            // ÙØ­Øµ Ø§Ù„ØªØ²Ø§Ù…Ù†
            const unifiedDaily = window.unifiedSync.loadQuestions('daily');
            if (oldDaily) {
                const oldDailyParsed = JSON.parse(oldDaily);
                if (unifiedDaily.length === oldDailyParsed.length) {
                    window.unifiedSync.log('âœ… Ø§Ù„ØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø³Ù„ÙŠÙ…', 'success');
                } else {
                    window.unifiedSync.log('âš ï¸ Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'warning');
                }
            }
        }

        function generateTestReport() {
            const dailyCount = window.unifiedSync.getQuestionCount('daily');
            const weeklyCount = window.unifiedSync.getQuestionCount('weekly');
            const totalCount = dailyCount + weeklyCount;
            
            window.unifiedSync.log('===== ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ =====', 'info');
            window.unifiedSync.log(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${totalCount}`, 'info');
            window.unifiedSync.log(`Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ${dailyCount}`, 'info');
            window.unifiedSync.log(`Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: ${weeklyCount}`, 'info');
            window.unifiedSync.log(`Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: ${window.unifiedSync.isInitialized ? 'Ù†Ø´Ø·' : 'Ø®Ø·Ø£'}`, 'info');
            window.unifiedSync.log(`Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleString('ar-SA')}`, 'info');
            window.unifiedSync.log('===== Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± =====', 'info');
            
            if (totalCount > 0 && window.unifiedSync.isInitialized) {
                window.unifiedSync.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'success');
            } else {
                window.unifiedSync.log('âŒ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'error');
            }
        }

        function checkDataIntegrity() {
            window.unifiedSync.log('ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            const dailyQuestions = window.unifiedSync.loadQuestions('daily');
            const weeklyQuestions = window.unifiedSync.loadQuestions('weekly');
            
            let issues = [];
            
            // ÙØ­Øµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            dailyQuestions.forEach((q, index) => {
                if (!q.question || q.question.trim().length < 5) {
                    issues.push(`Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ ${index + 1}: Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙØ§Ø±Øº Ø£Ùˆ Ù‚ØµÙŠØ±`);
                }
                if (!q.options || q.options.length !== 4) {
                    issues.push(`Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ ${index + 1}: Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­`);
                }
                if (typeof q.correct !== 'number' || q.correct < 0 || q.correct > 3) {
                    issues.push(`Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ ${index + 1}: Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©`);
                }
            });
            
            // ÙØ­Øµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
            weeklyQuestions.forEach((q, index) => {
                if (!q.question || q.question.trim().length < 5) {
                    issues.push(`Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ ${index + 1}: Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙØ§Ø±Øº Ø£Ùˆ Ù‚ØµÙŠØ±`);
                }
                if (!q.options || q.options.length !== 4) {
                    issues.push(`Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ ${index + 1}: Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­`);
                }
                if (typeof q.correct !== 'number' || q.correct < 0 || q.correct > 3) {
                    issues.push(`Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ ${index + 1}: Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©`);
                }
            });
            
            if (issues.length === 0) {
                window.unifiedSync.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù„ÙŠÙ…Ø©', 'success');
            } else {
                window.unifiedSync.log(`âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${issues.length} Ù…Ø´ÙƒÙ„Ø©:`, 'warning');
                issues.forEach(issue => {
                    window.unifiedSync.log(`- ${issue}`, 'warning');
                });
            }
        }

        function repairData() {
            window.unifiedSync.log('Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙØ©...', 'info');
            
            let repairedCount = 0;
            
            // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            const dailyQuestions = window.unifiedSync.loadQuestions('daily');
            const repairedDaily = dailyQuestions.filter(q => {
                if (!q.question || !q.options || q.options.length !== 4) {
                    repairedCount++;
                    return false;
                }
                return true;
            });
            
            // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
            const weeklyQuestions = window.unifiedSync.loadQuestions('weekly');
            const repairedWeekly = weeklyQuestions.filter(q => {
                if (!q.question || !q.options || q.options.length !== 4) {
                    repairedCount++;
                    return false;
                }
                return true;
            });
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØµØ­Ø­Ø©
            window.unifiedSync.saveQuestions('daily', repairedDaily, false);
            window.unifiedSync.saveQuestions('weekly', repairedWeekly, false);
            
            window.unifiedSync.log(`ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${repairedCount} Ø¹Ù†ØµØ± ØªØ§Ù„Ù`, 'success');
        }

        function migrateOldData() {
            window.unifiedSync.log('Ø¨Ø¯Ø¡ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…...', 'info');
            
            let migratedCount = 0;
            
            // ØªØ±Ø­ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
            const oldKeys = [
                'adminDailyQuestions',
                'adminWeeklyQuestions',
                'nafisMainDailyQuestions',
                'nafisMainWeeklyQuestions'
            ];
            
            oldKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const questions = JSON.parse(data);
                        if (Array.isArray(questions) && questions.length > 0) {
                            const type = key.includes('Daily') ? 'daily' : 'weekly';
                            
                            // Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                            const existing = window.unifiedSync.loadQuestions(type);
                            const existingIds = existing.map(q => q.id);
                            const newQuestions = questions.filter(q => !existingIds.includes(q.id));
                            
                            if (newQuestions.length > 0) {
                                const merged = [...existing, ...newQuestions];
                                window.unifiedSync.saveQuestions(type, merged, false);
                                migratedCount += newQuestions.length;
                                window.unifiedSync.log(`ØªÙ… ØªØ±Ø­ÙŠÙ„ ${newQuestions.length} Ø³Ø¤Ø§Ù„ Ù…Ù† ${key}`, 'info');
                            }
                        }
                    } catch (e) {
                        window.unifiedSync.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ±Ø­ÙŠÙ„ ${key}: ${e.message}`, 'error');
                    }
                }
            });
            
            window.unifiedSync.log(`ØªÙ… ØªØ±Ø­ÙŠÙ„ ${migratedCount} Ø³Ø¤Ø§Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ`, 'success');
        }

        function resetSystem() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ù‚Ø§Ù‹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!')) {
                return;
            }
            
            window.unifiedSync.log('Ø¨Ø¯Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…...', 'warning');
            
            // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            Object.values(window.unifiedSync.STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£ÙŠØ¶Ø§Ù‹
            const oldKeys = [
                'adminDailyQuestions',
                'adminWeeklyQuestions',
                'nafisMainDailyQuestions',
                'nafisMainWeeklyQuestions',
                'nafisLastUpdate',
                'nafisResults'
            ];
            
            oldKeys.forEach(key => localStorage.removeItem(key));
            
            window.unifiedSync.log('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        function clearTestData() {
            window.unifiedSync.log('Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©...', 'info');
            
            const dailyQuestions = window.unifiedSync.loadQuestions('daily');
            const weeklyQuestions = window.unifiedSync.loadQuestions('weekly');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "ØªØ¬Ø±ÙŠØ¨ÙŠ" Ø£Ùˆ "Ø§Ø®ØªØ¨Ø§Ø±"
            const cleanDaily = dailyQuestions.filter(q => 
                !q.question.includes('ØªØ¬Ø±ÙŠØ¨ÙŠ') && !q.question.includes('Ø§Ø®ØªØ¨Ø§Ø±')
            );
            const cleanWeekly = weeklyQuestions.filter(q => 
                !q.question.includes('ØªØ¬Ø±ÙŠØ¨ÙŠ') && !q.question.includes('Ø§Ø®ØªØ¨Ø§Ø±')
            );
            
            const removedDaily = dailyQuestions.length - cleanDaily.length;
            const removedWeekly = weeklyQuestions.length - cleanWeekly.length;
            
            if (removedDaily > 0 || removedWeekly > 0) {
                window.unifiedSync.saveQuestions('daily', cleanDaily, false);
                window.unifiedSync.saveQuestions('weekly', cleanWeekly, false);
                window.unifiedSync.log(`ØªÙ… Ø­Ø°Ù ${removedDaily + removedWeekly} Ø³Ø¤Ø§Ù„ ØªØ¬Ø±ÙŠØ¨ÙŠ`, 'success');
            } else {
                window.unifiedSync.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø­Ø°Ù', 'info');
            }
        }

        function exportDiagnostics() {
            window.unifiedSync.log('ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ...', 'info');
            
            const diagnostics = {
                timestamp: new Date().toISOString(),
                systemInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                },
                browserSupport: {
                    localStorage: typeof Storage !== 'undefined',
                    broadcastChannel: typeof BroadcastChannel !== 'undefined',
                    postMessage: typeof postMessage !== 'undefined'
                },
                syncSystemStatus: {
                    isInitialized: window.unifiedSync.isInitialized,
                    channelsCount: window.unifiedSync.channels.length,
                    lastHeartbeat: localStorage.getItem(window.unifiedSync.STORAGE_KEYS.HEARTBEAT)
                },
                dataStatus: {
                    dailyQuestions: window.unifiedSync.getQuestionCount('daily'),
                    weeklyQuestions: window.unifiedSync.getQuestionCount('weekly'),
                    lastUpdate: localStorage.getItem(window.unifiedSync.STORAGE_KEYS.LAST_UPDATE),
                    syncStatus: localStorage.getItem(window.unifiedSync.STORAGE_KEYS.SYNC_STATUS)
                },
                storageKeys: {}
            };
            
            // ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
            Object.entries(window.unifiedSync.STORAGE_KEYS).forEach(([name, key]) => {
                const data = localStorage.getItem(key);
                diagnostics.storageKeys[name] = {
                    exists: !!data,
                    size: data ? data.length : 0
                };
            });
            
            // ØªØµØ¯ÙŠØ± ÙƒÙ…Ù„Ù JSON
            const blob = new Blob([JSON.stringify(diagnostics, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nafis-diagnostics-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            window.unifiedSync.log('ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ', 'success');
        }

        function showProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (progressBar && progressFill) {
                progressBar.style.display = 'block';
                progressFill.style.width = percent + '%';
            }
        }

        function hideProgress() {
            setTimeout(() => {
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.display = 'none';
                }
            }, 1000);
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            window.unifiedSync.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†', 'info');
            
            // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
            setInterval(() => {
                if (window.unifiedSync.isInitialized) {
                    window.unifiedSync.updateQuestionCounts();
                }
            }, 10000);
        });

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', function() {
            if (window.unifiedSync) {
                window.unifiedSync.destroy();
            }
        });

        // ØªØµØ¯ÙŠØ± Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        window.testFunctions = {
            testAddQuestion,
            testSync,
            testLoadQuestions,
            runFullTest,
            checkDataIntegrity,
            repairData,
            migrateOldData,
            resetSystem,
            clearTestData,
            exportDiagnostics
        };

        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ Ø§Ù„Ù…ÙØµØ­Ø­ Ø¨Ù†Ø¬Ø§Ø­');
    </script>
</body>
</html>
