<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التزامن الموحد - ناقس (مُصحح)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .solution-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sync-indicator.active {
            background: #27ae60;
        }

        .sync-indicator.error {
            background: #e74c3c;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .status-item {
            background: #f7fafc;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .status-item.success {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .status-item.error {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .test-results {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .log-entry.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .log-entry.error {
            background: #ffebee;
            color: #c62828;
        }

        .log-entry.warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .implementation-area {
            background: #1a202c;
            color: #e2e8f0;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .controls-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="sync-indicator" id="syncStatus">
        🔄 جاري التهيئة...
    </div>

    <div class="container">
        <div class="header">
            <h1>🎯 نظام التزامن الموحد - النسخة المُصححة</h1>
            <p>نظام متكامل وموثوق لتزامن بيانات ناقس</p>
        </div>

        <div class="solution-card">
            <h2>📊 حالة النظام المباشرة</h2>
            
            <div class="status-grid">
                <div class="status-item" id="systemStatusCard">
                    <strong>حالة النظام:</strong>
                    <span id="systemStatus">جاري التهيئة...</span>
                </div>
                <div class="status-item" id="dailyStatusCard">
                    <strong>الأسئلة اليومية:</strong>
                    <span id="testDailyCount">0</span>
                </div>
                <div class="status-item" id="weeklyStatusCard">
                    <strong>الأسئلة الأسبوعية:</strong>
                    <span id="testWeeklyCount">0</span>
                </div>
                <div class="status-item" id="syncTimeCard">
                    <strong>آخر تزامن:</strong>
                    <span id="lastSyncTime">لم يتم بعد</span>
                </div>
            </div>

            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="controls-section">
                <button class="btn" onclick="testAddQuestion()">اختبار إضافة سؤال</button>
                <button class="btn" onclick="testSync()">اختبار التزامن</button>
                <button class="btn" onclick="testLoadQuestions()">اختبار تحميل الأسئلة</button>
                <button class="btn success" onclick="runFullTest()">اختبار شامل</button>
                <button class="btn danger" onclick="clearTestData()">مسح البيانات التجريبية</button>
                <button class="btn" onclick="exportDiagnostics()">تصدير التشخيص</button>
            </div>
            
            <div id="testResults" class="test-results" style="display: none;">
                <h4>سجل النظام:</h4>
                <div id="testOutput"></div>
            </div>
        </div>

        <div class="solution-card">
            <h2>🔧 أدوات الصيانة والتشخيص</h2>
            
            <div class="controls-section">
                <button class="btn" onclick="checkDataIntegrity()">فحص سلامة البيانات</button>
                <button class="btn" onclick="repairData()">إصلاح البيانات التالفة</button>
                <button class="btn" onclick="migrateOldData()">ترحيل البيانات القديمة</button>
                <button class="btn" onclick="resetSystem()">إعادة تعيين النظام</button>
            </div>
        </div>
    </div>

    <script>
        // نظام التزامن الموحد المُصحح والكامل
        class UnifiedSyncSystem {
            constructor() {
                this.STORAGE_KEYS = {
                    DAILY_QUESTIONS: 'nafis_unified_daily_questions',
                    WEEKLY_QUESTIONS: 'nafis_unified_weekly_questions',
                    LAST_UPDATE: 'nafis_unified_last_update',
                    SYNC_STATUS: 'nafis_unified_sync_status',
                    HEARTBEAT: 'nafis_unified_heartbeat'
                };
                
                this.channels = [];
                this.retryCount = 0;
                this.maxRetries = 5;
                this.heartbeatInterval = null;
                this.listeners = [];
                this.isInitialized = false;
                
                this.init();
            }
            
            init() {
                try {
                    this.log('بدء تهيئة نظام التزامن الموحد...', 'info');
                    
                    this.setupChannels();
                    this.setupHeartbeat();
                    this.setupRetryMechanism();
                    this.bindStorageEvents();
                    this.migrateExistingData();
                    this.updateSystemStatus('نشط ومتصل');
                    this.updateQuestionCounts();
                    
                    this.isInitialized = true;
                    this.log('✅ تم تهيئة نظام التزامن بنجاح', 'success');
                    
                    // تحديث مؤشر الحالة
                    this.updateSyncIndicator('active', 'نظام التزامن نشط');
                    
                } catch (error) {
                    this.log(`❌ خطأ في التهيئة: ${error.message}`, 'error');
                    this.updateSyncIndicator('error', 'خطأ في النظام');
                }
            }
            
            setupChannels() {
                try {
                    // BroadcastChannel
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('nafis-unified-sync');
                        channel.onmessage = (e) => this.handleMessage(e.data);
                        this.channels.push(channel);
                        this.log('تم إعداد BroadcastChannel', 'info');
                    }
                    
                    // Window Message Listener
                    window.addEventListener('message', (e) => {
                        if (e.data && e.data.source === 'nafis-sync') {
                            this.handleMessage(e.data);
                        }
                    });
                    
                    // Storage Events
                    window.addEventListener('storage', (e) => {
                        if (e.key && e.key.startsWith('nafis_unified_')) {
                            this.handleStorageChange(e);
                        }
                    });
                    
                    this.log('تم إعداد قنوات الاتصال', 'success');
                    
                } catch (error) {
                    this.log(`خطأ في إعداد القنوات: ${error.message}`, 'error');
                }
            }
            
            setupHeartbeat() {
                try {
                    this.heartbeatInterval = setInterval(() => {
                        const heartbeat = {
                            timestamp: Date.now(),
                            source: 'sync-system',
                            questions: {
                                daily: this.getQuestionCount('daily'),
                                weekly: this.getQuestionCount('weekly')
                            },
                            status: this.isInitialized ? 'active' : 'initializing'
                        };
                        
                        localStorage.setItem(this.STORAGE_KEYS.HEARTBEAT, JSON.stringify(heartbeat));
                        this.broadcast({
                            type: 'HEARTBEAT',
                            data: heartbeat
                        });
                    }, 5000);
                    
                    this.log('تم تفعيل آلية Heartbeat', 'info');
                    
                } catch (error) {
                    this.log(`خطأ في Heartbeat: ${error.message}`, 'error');
                }
            }
            
            setupRetryMechanism() {
                setInterval(() => {
                    try {
                        const lastHeartbeat = localStorage.getItem(this.STORAGE_KEYS.HEARTBEAT);
                        if (lastHeartbeat) {
                            const heartbeat = JSON.parse(lastHeartbeat);
                            const timeDiff = Date.now() - heartbeat.timestamp;
                            
                            if (timeDiff > 15000) { // 15 ثانية
                                this.log('انقطاع في الاتصال، محاولة إعادة التزامن...', 'warning');
                                this.forceSync();
                            }
                        }
                    } catch (error) {
                        this.log(`خطأ في آلية إعادة المحاولة: ${error.message}`, 'error');
                    }
                }, 10000);
            }
            
            bindStorageEvents() {
                // إعداد مراقبة تغييرات localStorage
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = (...args) => {
                    originalSetItem.apply(localStorage, args);
                    if (args[0].startsWith('nafis_unified_')) {
                        setTimeout(() => this.handleLocalStorageUpdate(args[0], args[1]), 100);
                    }
                };
            }
            
            migrateExistingData() {
                try {
                    this.log('بدء ترحيل البيانات الموجودة...', 'info');
                    
                    // ترحيل الأسئلة اليومية
                    const oldDaily = localStorage.getItem('adminDailyQuestions');
                    if (oldDaily && !localStorage.getItem(this.STORAGE_KEYS.DAILY_QUESTIONS)) {
                        const questions = JSON.parse(oldDaily);
                        this.saveQuestions('daily', questions, false);
                        this.log(`تم ترحيل ${questions.length} سؤال يومي`, 'success');
                    }
                    
                    // ترحيل الأسئلة الأسبوعية
                    const oldWeekly = localStorage.getItem('adminWeeklyQuestions');
                    if (oldWeekly && !localStorage.getItem(this.STORAGE_KEYS.WEEKLY_QUESTIONS)) {
                        const questions = JSON.parse(oldWeekly);
                        this.saveQuestions('weekly', questions, false);
                        this.log(`تم ترحيل ${questions.length} سؤال أسبوعي`, 'success');
                    }
                    
                    this.log('انتهاء عملية الترحيل', 'info');
                    
                } catch (error) {
                    this.log(`خطأ في ترحيل البيانات: ${error.message}`, 'error');
                }
            }
            
            broadcast(message) {
                const payload = {
                    ...message,
                    source: 'nafis-sync',
                    timestamp: Date.now(),
                    id: Math.random().toString(36).substr(2, 9)
                };
                
                try {
                    // BroadcastChannel
                    this.channels.forEach(channel => {
                        try {
                            channel.postMessage(payload);
                        } catch (e) {
                            this.log('فشل في إرسال عبر BroadcastChannel', 'warning');
                        }
                    });
                    
                    // PostMessage
                    window.postMessage(payload, '*');
                    
                    // Storage Event Trigger
                    const tempKey = `nafis_temp_${payload.id}`;
                    localStorage.setItem(tempKey, JSON.stringify(payload));
                    localStorage.removeItem(tempKey);
                    
                } catch (error) {
                    this.log(`خطأ في البث: ${error.message}`, 'error');
                }
            }
            
            saveQuestions(type, questions, shouldBroadcast = true) {
                try {
                    const key = type === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    const data = {
                        questions: questions,
                        timestamp: Date.now(),
                        checksum: this.calculateChecksum(questions),
                        version: '2.0'
                    };
                    
                    // حفظ في النظام الموحد
                    localStorage.setItem(key, JSON.stringify(data));
                    
                    // حفظ في النظام القديم للتوافق
                    const oldKey = type === 'daily' ? 'adminDailyQuestions' : 'adminWeeklyQuestions';
                    localStorage.setItem(oldKey, JSON.stringify(questions));
                    localStorage.setItem(`nafisMain${type === 'daily' ? 'Daily' : 'Weekly'}Questions`, JSON.stringify(questions));
                    
                    // تحديث الحالة
                    localStorage.setItem(this.STORAGE_KEYS.LAST_UPDATE, Date.now().toString());
                    localStorage.setItem(this.STORAGE_KEYS.SYNC_STATUS, 'success');
                    
                    if (shouldBroadcast) {
                        this.broadcast({
                            type: 'QUESTIONS_UPDATED',
                            questionType: type,
                            data: data,
                            count: questions.length
                        });
                    }
                    
                    this.updateQuestionCounts();
                    this.updateLastSyncTime();
                    
                    this.log(`تم حفظ ${questions.length} سؤال ${type}`, 'success');
                    return true;
                    
                } catch (error) {
                    this.log(`خطأ في حفظ الأسئلة: ${error.message}`, 'error');
                    localStorage.setItem(this.STORAGE_KEYS.SYNC_STATUS, 'error');
                    return false;
                }
            }
            
            loadQuestions(type) {
                try {
                    const key = type === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    const stored = localStorage.getItem(key);
                    if (!stored) {
                        // محاولة تحميل من النظام القديم
                        const oldKey = type === 'daily' ? 'adminDailyQuestions' : 'adminWeeklyQuestions';
                        const oldData = localStorage.getItem(oldKey);
                        return oldData ? JSON.parse(oldData) : [];
                    }
                    
                    const data = JSON.parse(stored);
                    
                    if (this.validateData(data)) {
                        return data.questions || [];
                    } else {
                        this.log(`بيانات ${type} تالفة، محاولة الاستعادة`, 'warning');
                        return [];
                    }
                    
                } catch (error) {
                    this.log(`خطأ في تحميل أسئلة ${type}: ${error.message}`, 'error');
                    return [];
                }
            }
            
            calculateChecksum(data) {
                try {
                    const str = JSON.stringify(data);
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        const char = str.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return hash.toString();
                } catch (error) {
                    this.log(`خطأ في حساب Checksum: ${error.message}`, 'error');
                    return '';
                }
            }
            
            validateData(data) {
                if (!data || !data.questions || !Array.isArray(data.questions)) {
                    return false;
                }
                
                if (data.checksum && this.calculateChecksum(data.questions) !== data.checksum) {
                    this.log('فشل في التحقق من Checksum', 'warning');
                    return false;
                }
                
                return true;
            }
            
            handleMessage(message) {
                if (!message || message.source !== 'nafis-sync') return;
                
                try {
                    switch (message.type) {
                        case 'QUESTIONS_UPDATED':
                            this.handleQuestionsUpdate(message);
                            break;
                        case 'HEARTBEAT':
                            this.handleHeartbeat(message);
                            break;
                        case 'SYNC_REQUEST':
                            this.handleSyncRequest(message);
                            break;
                        default:
                            this.log(`نوع رسالة غير معروف: ${message.type}`, 'warning');
                    }
                } catch (error) {
                    this.log(`خطأ في معالجة الرسالة: ${error.message}`, 'error');
                }
            }
            
            handleQuestionsUpdate(message) {
                const { questionType, data } = message;
                
                if (this.validateData(data)) {
                    const key = questionType === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    localStorage.setItem(key, JSON.stringify(data));
                    this.updateQuestionCounts();
                    
                    this.log(`تم استقبال تحديث ${questionType}: ${data.questions.length} سؤال`, 'success');
                }
            }
            
            handleHeartbeat(message) {
                this.log(`نبضة من ${message.data?.source || 'مصدر غير معروف'}`, 'info');
                this.updateSyncIndicator('active', 'متصل ونشط');
            }
            
            handleSyncRequest(message) {
                this.log('طلب تزامن وارد', 'info');
                this.forceSync();
            }
            
            handleStorageChange(e) {
                this.log(`تغيير في التخزين: ${e.key}`, 'info');
                setTimeout(() => this.updateQuestionCounts(), 500);
            }
            
            handleLocalStorageUpdate(key, value) {
                this.log(`تحديث محلي: ${key}`, 'info');
                setTimeout(() => this.updateQuestionCounts(), 100);
            }
            
            forceSync() {
                this.log('فرض التزامن...', 'info');
                this.broadcast({
                    type: 'SYNC_REQUEST',
                    timestamp: Date.now()
                });
            }
            
            getQuestionCount(type) {
                const questions = this.loadQuestions(type);
                return questions.length;
            }
            
            updateSystemStatus(status) {
                const element = document.getElementById('systemStatus');
                const card = document.getElementById('systemStatusCard');
                if (element) {
                    element.textContent = status;
                    if (card) {
                        card.className = status.includes('نشط') ? 'status-item success' : 'status-item';
                    }
                }
            }
            
            updateQuestionCounts() {
                const dailyCount = this.getQuestionCount('daily');
                const weeklyCount = this.getQuestionCount('weekly');
                
                const dailyElement = document.getElementById('testDailyCount');
                const weeklyElement = document.getElementById('testWeeklyCount');
                const dailyCard = document.getElementById('dailyStatusCard');
                const weeklyCard = document.getElementById('weeklyStatusCard');
                
                if (dailyElement) {
                    dailyElement.textContent = dailyCount;
                    if (dailyCard) {
                        dailyCard.className = dailyCount > 0 ? 'status-item success' : 'status-item';
                    }
                }
                
                if (weeklyElement) {
                    weeklyElement.textContent = weeklyCount;
                    if (weeklyCard) {
                        weeklyCard.className = weeklyCount > 0 ? 'status-item success' : 'status-item';
                    }
                }
            }
            
            updateLastSyncTime() {
                const element = document.getElementById('lastSyncTime');
                const card = document.getElementById('syncTimeCard');
                if (element) {
                    element.textContent = new Date().toLocaleString('ar-SA');
                    if (card) {
                        card.className = 'status-item success';
                    }
                }
            }
            
            updateSyncIndicator(status, text) {
                const indicator = document.getElementById('syncStatus');
                if (indicator) {
                    indicator.className = `sync-indicator ${status}`;
                    indicator.textContent = text;
                }
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                console.log(`[${timestamp}] ${message}`);
                
                // إضافة للواجهة
                const output = document.getElementById('testOutput');
                if (output) {
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry ${type}`;
                    logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                    output.insertBefore(logEntry, output.firstChild);
                    
                    // الاحتفاظ بآخر 50 إدخال فقط
                    while (output.children.length > 50) {
                        output.removeChild(output.lastChild);
                    }
                    
                    // إظهار منطقة النتائج
                    document.getElementById('testResults').style.display = 'block';
                }
            }
            
            destroy() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                }
                
                this.channels.forEach(channel => {
                    try {
                        channel.close();
                    } catch (e) {}
                });
                
                this.listeners = [];
                this.log('تم تنظيف موارد النظام', 'info');
            }
        }

        // إنشاء مثيل النظام
        window.unifiedSync = new UnifiedSyncSystem();

        // دوال الاختبار
        function testAddQuestion() {
            showProgress(0);
            window.unifiedSync.log('بدء اختبار إضافة سؤال...', 'info');
            
            const testQuestion = {
                id: Date.now(),
                subject: 'اختبار',
                question: 'هذا سؤال تجريبي للتزامن - ' + new Date().toLocaleTimeString('ar-SA'),
                options: ['الخيار الأول', 'الخيار الثاني', 'الخيار الثالث', 'الخيار الرابع'],
                correct: Math.floor(Math.random() * 4),
                explanation: 'تفسير تجريبي للاختبار',
                type: 'daily',
                createdAt: new Date().toLocaleString('ar-SA')
            };
            
            showProgress(30);
            
            setTimeout(() => {
                const currentQuestions = window.unifiedSync.loadQuestions('daily');
                currentQuestions.push(testQuestion);
                
                showProgress(60);
                
                const success = window.unifiedSync.saveQuestions('daily', currentQuestions);
                
                showProgress(100);
                
                if (success) {
                    window.unifiedSync.log('✅ نجح اختبار إضافة السؤال', 'success');
                } else {
                    window.unifiedSync.log('❌ فشل اختبار إضافة السؤال', 'error');
                }
                
                hideProgress();
            }, 1000);
        }

        function testSync() {
            window.unifiedSync.log('اختبار التزامن الفوري...', 'info');
            window.unifiedSync.forceSync();
            
            setTimeout(() => {
                window.unifiedSync.log('✅ تم إرسال إشارة التزامن', 'success');
            }, 500);
        }

        function testLoadQuestions() {
            window.unifiedSync.log('اختبار تحميل الأسئلة...', 'info');
            
            const dailyQuestions = window.unifiedSync.loadQuestions('daily');
            const weeklyQuestions = window.unifiedSync.loadQuestions('weekly');
            
            window.unifiedSync.log(`تم تحميل ${dailyQuestions.length} سؤال يومي`, 'success');
            window.unifiedSync.log(`تم تحميل ${weeklyQuestions.length} سؤال أسبوعي`, 'success');
            
            // اختبار صحة البيانات
            let validDaily = 0;
            let validWeekly = 0;
            
            dailyQuestions.forEach(q => {
                if (q.question && q.options && q.options.length === 4) {
                    validDaily++;
                }
            });
            
            weeklyQuestions.forEach(q => {
                if (q.question && q.options && q.options.length === 4) {
                    validWeekly++;
                }
            });
            
            window.unifiedSync.log(`صالح للاستخدام: ${validDaily} يومي، ${validWeekly} أسبوعي`, 'info');
        }

        function runFullTest() {
            window.unifiedSync.log('بدء الاختبار الشامل للنظام...', 'info');
            showProgress(0);
            
            let testStep = 1;
            const totalSteps = 6;
            
            function nextStep() {
                showProgress((testStep / totalSteps) * 100);
                
                switch(testStep) {
                    case 1:
                        window.unifiedSync.log(`الخطوة ${testStep}: فحص سلامة النظام`, 'info');
                        checkDataIntegrity();
                        break;
                    case 2:
                        window.unifiedSync.log(`الخطوة ${testStep}: اختبار إضافة سؤال`, 'info');
                        testAddQuestion();
                        break;
                    case 3:
                        window.unifiedSync.log(`الخطوة ${testStep}: اختبار التزامن`, 'info');
                        testSync();
                        break;
                    case 4:
                        window.unifiedSync.log(`الخطوة ${testStep}: اختبار تحميل البيانات`, 'info');
                        testLoadQuestions();
                        break;
                    case 5:
                        window.unifiedSync.log(`الخطوة ${testStep}: فحص التوافق مع النظام القديم`, 'info');
                        testBackwardCompatibility();
                        break;
                    case 6:
                        window.unifiedSync.log(`الخطوة ${testStep}: تقرير النتائج النهائية`, 'success');
                        generateTestReport();
                        hideProgress();
                        return;
                }
                
                testStep++;
                setTimeout(nextStep, 2000);
            }
            
            nextStep();
        }

        function testBackwardCompatibility() {
            window.unifiedSync.log('اختبار التوافق مع النظام القديم...', 'info');
            
            // فحص وجود البيانات في النظام القديم
            const oldDaily = localStorage.getItem('adminDailyQuestions');
            const oldWeekly = localStorage.getItem('adminWeeklyQuestions');
            const oldMain = localStorage.getItem('nafisMainDailyQuestions');
            
            if (oldDaily) {
                window.unifiedSync.log('تم العثور على بيانات يومية قديمة', 'info');
            }
            if (oldWeekly) {
                window.unifiedSync.log('تم العثور على بيانات أسبوعية قديمة', 'info');
            }
            if (oldMain) {
                window.unifiedSync.log('تم العثور على بيانات المنصة الرئيسية', 'info');
            }
            
            // فحص التزامن
            const unifiedDaily = window.unifiedSync.loadQuestions('daily');
            if (oldDaily) {
                const oldDailyParsed = JSON.parse(oldDaily);
                if (unifiedDaily.length === oldDailyParsed.length) {
                    window.unifiedSync.log('✅ التزامن مع النظام القديم سليم', 'success');
                } else {
                    window.unifiedSync.log('⚠️ عدم تطابق في عدد الأسئلة', 'warning');
                }
            }
        }

        function generateTestReport() {
            const dailyCount = window.unifiedSync.getQuestionCount('daily');
            const weeklyCount = window.unifiedSync.getQuestionCount('weekly');
            const totalCount = dailyCount + weeklyCount;
            
            window.unifiedSync.log('===== تقرير الاختبار الشامل =====', 'info');
            window.unifiedSync.log(`إجمالي الأسئلة: ${totalCount}`, 'info');
            window.unifiedSync.log(`الأسئلة اليومية: ${dailyCount}`, 'info');
            window.unifiedSync.log(`الأسئلة الأسبوعية: ${weeklyCount}`, 'info');
            window.unifiedSync.log(`حالة النظام: ${window.unifiedSync.isInitialized ? 'نشط' : 'خطأ'}`, 'info');
            window.unifiedSync.log(`آخر تحديث: ${new Date().toLocaleString('ar-SA')}`, 'info');
            window.unifiedSync.log('===== انتهاء التقرير =====', 'info');
            
            if (totalCount > 0 && window.unifiedSync.isInitialized) {
                window.unifiedSync.log('✅ النظام يعمل بشكل صحيح', 'success');
            } else {
                window.unifiedSync.log('❌ توجد مشاكل في النظام', 'error');
            }
        }

        function checkDataIntegrity() {
            window.unifiedSync.log('فحص سلامة البيانات...', 'info');
            
            const dailyQuestions = window.unifiedSync.loadQuestions('daily');
            const weeklyQuestions = window.unifiedSync.loadQuestions('weekly');
            
            let issues = [];
            
            // فحص الأسئلة اليومية
            dailyQuestions.forEach((q, index) => {
                if (!q.question || q.question.trim().length < 5) {
                    issues.push(`سؤال يومي ${index + 1}: نص السؤال فارغ أو قصير`);
                }
                if (!q.options || q.options.length !== 4) {
                    issues.push(`سؤال يومي ${index + 1}: عدد الخيارات غير صحيح`);
                }
                if (typeof q.correct !== 'number' || q.correct < 0 || q.correct > 3) {
                    issues.push(`سؤال يومي ${index + 1}: الإجابة الصحيحة غير صالحة`);
                }
            });
            
            // فحص الأسئلة الأسبوعية
            weeklyQuestions.forEach((q, index) => {
                if (!q.question || q.question.trim().length < 5) {
                    issues.push(`سؤال أسبوعي ${index + 1}: نص السؤال فارغ أو قصير`);
                }
                if (!q.options || q.options.length !== 4) {
                    issues.push(`سؤال أسبوعي ${index + 1}: عدد الخيارات غير صحيح`);
                }
                if (typeof q.correct !== 'number' || q.correct < 0 || q.correct > 3) {
                    issues.push(`سؤال أسبوعي ${index + 1}: الإجابة الصحيحة غير صالحة`);
                }
            });
            
            if (issues.length === 0) {
                window.unifiedSync.log('✅ جميع البيانات سليمة', 'success');
            } else {
                window.unifiedSync.log(`⚠️ تم اكتشاف ${issues.length} مشكلة:`, 'warning');
                issues.forEach(issue => {
                    window.unifiedSync.log(`- ${issue}`, 'warning');
                });
            }
        }

        function repairData() {
            window.unifiedSync.log('بدء إصلاح البيانات التالفة...', 'info');
            
            let repairedCount = 0;
            
            // إصلاح الأسئلة اليومية
            const dailyQuestions = window.unifiedSync.loadQuestions('daily');
            const repairedDaily = dailyQuestions.filter(q => {
                if (!q.question || !q.options || q.options.length !== 4) {
                    repairedCount++;
                    return false;
                }
                return true;
            });
            
            // إصلاح الأسئلة الأسبوعية
            const weeklyQuestions = window.unifiedSync.loadQuestions('weekly');
            const repairedWeekly = weeklyQuestions.filter(q => {
                if (!q.question || !q.options || q.options.length !== 4) {
                    repairedCount++;
                    return false;
                }
                return true;
            });
            
            // حفظ البيانات المُصححة
            window.unifiedSync.saveQuestions('daily', repairedDaily, false);
            window.unifiedSync.saveQuestions('weekly', repairedWeekly, false);
            
            window.unifiedSync.log(`تم إصلاح ${repairedCount} عنصر تالف`, 'success');
        }

        function migrateOldData() {
            window.unifiedSync.log('بدء ترحيل البيانات من النظام القديم...', 'info');
            
            let migratedCount = 0;
            
            // ترحيل من النظام القديم
            const oldKeys = [
                'adminDailyQuestions',
                'adminWeeklyQuestions',
                'nafisMainDailyQuestions',
                'nafisMainWeeklyQuestions'
            ];
            
            oldKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const questions = JSON.parse(data);
                        if (Array.isArray(questions) && questions.length > 0) {
                            const type = key.includes('Daily') ? 'daily' : 'weekly';
                            
                            // دمج مع البيانات الموجودة
                            const existing = window.unifiedSync.loadQuestions(type);
                            const existingIds = existing.map(q => q.id);
                            const newQuestions = questions.filter(q => !existingIds.includes(q.id));
                            
                            if (newQuestions.length > 0) {
                                const merged = [...existing, ...newQuestions];
                                window.unifiedSync.saveQuestions(type, merged, false);
                                migratedCount += newQuestions.length;
                                window.unifiedSync.log(`تم ترحيل ${newQuestions.length} سؤال من ${key}`, 'info');
                            }
                        }
                    } catch (e) {
                        window.unifiedSync.log(`خطأ في ترحيل ${key}: ${e.message}`, 'error');
                    }
                }
            });
            
            window.unifiedSync.log(`تم ترحيل ${migratedCount} سؤال إجمالي`, 'success');
        }

        function resetSystem() {
            if (!confirm('هل تريد حقاً إعادة تعيين النظام؟ سيتم حذف جميع البيانات!')) {
                return;
            }
            
            window.unifiedSync.log('بدء إعادة تعيين النظام...', 'warning');
            
            // حذف جميع البيانات
            Object.values(window.unifiedSync.STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });
            
            // حذف البيانات القديمة أيضاً
            const oldKeys = [
                'adminDailyQuestions',
                'adminWeeklyQuestions',
                'nafisMainDailyQuestions',
                'nafisMainWeeklyQuestions',
                'nafisLastUpdate',
                'nafisResults'
            ];
            
            oldKeys.forEach(key => localStorage.removeItem(key));
            
            window.unifiedSync.log('تم حذف جميع البيانات', 'info');
            
            // إعادة تهيئة النظام
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        function clearTestData() {
            window.unifiedSync.log('مسح البيانات التجريبية...', 'info');
            
            const dailyQuestions = window.unifiedSync.loadQuestions('daily');
            const weeklyQuestions = window.unifiedSync.loadQuestions('weekly');
            
            // إزالة الأسئلة التي تحتوي على "تجريبي" أو "اختبار"
            const cleanDaily = dailyQuestions.filter(q => 
                !q.question.includes('تجريبي') && !q.question.includes('اختبار')
            );
            const cleanWeekly = weeklyQuestions.filter(q => 
                !q.question.includes('تجريبي') && !q.question.includes('اختبار')
            );
            
            const removedDaily = dailyQuestions.length - cleanDaily.length;
            const removedWeekly = weeklyQuestions.length - cleanWeekly.length;
            
            if (removedDaily > 0 || removedWeekly > 0) {
                window.unifiedSync.saveQuestions('daily', cleanDaily, false);
                window.unifiedSync.saveQuestions('weekly', cleanWeekly, false);
                window.unifiedSync.log(`تم حذف ${removedDaily + removedWeekly} سؤال تجريبي`, 'success');
            } else {
                window.unifiedSync.log('لا توجد بيانات تجريبية للحذف', 'info');
            }
        }

        function exportDiagnostics() {
            window.unifiedSync.log('تصدير تقرير التشخيص...', 'info');
            
            const diagnostics = {
                timestamp: new Date().toISOString(),
                systemInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                },
                browserSupport: {
                    localStorage: typeof Storage !== 'undefined',
                    broadcastChannel: typeof BroadcastChannel !== 'undefined',
                    postMessage: typeof postMessage !== 'undefined'
                },
                syncSystemStatus: {
                    isInitialized: window.unifiedSync.isInitialized,
                    channelsCount: window.unifiedSync.channels.length,
                    lastHeartbeat: localStorage.getItem(window.unifiedSync.STORAGE_KEYS.HEARTBEAT)
                },
                dataStatus: {
                    dailyQuestions: window.unifiedSync.getQuestionCount('daily'),
                    weeklyQuestions: window.unifiedSync.getQuestionCount('weekly'),
                    lastUpdate: localStorage.getItem(window.unifiedSync.STORAGE_KEYS.LAST_UPDATE),
                    syncStatus: localStorage.getItem(window.unifiedSync.STORAGE_KEYS.SYNC_STATUS)
                },
                storageKeys: {}
            };
            
            // فحص جميع مفاتيح التخزين
            Object.entries(window.unifiedSync.STORAGE_KEYS).forEach(([name, key]) => {
                const data = localStorage.getItem(key);
                diagnostics.storageKeys[name] = {
                    exists: !!data,
                    size: data ? data.length : 0
                };
            });
            
            // تصدير كملف JSON
            const blob = new Blob([JSON.stringify(diagnostics, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nafis-diagnostics-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            window.unifiedSync.log('تم تصدير تقرير التشخيص', 'success');
        }

        function showProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (progressBar && progressFill) {
                progressBar.style.display = 'block';
                progressFill.style.width = percent + '%';
            }
        }

        function hideProgress() {
            setTimeout(() => {
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.display = 'none';
                }
            }, 1000);
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            window.unifiedSync.log('تم تحميل صفحة التزامن', 'info');
            
            // تحديث دوري للواجهة
            setInterval(() => {
                if (window.unifiedSync.isInitialized) {
                    window.unifiedSync.updateQuestionCounts();
                }
            }, 10000);
        });

        // تنظيف الموارد عند إغلاق الصفحة
        window.addEventListener('beforeunload', function() {
            if (window.unifiedSync) {
                window.unifiedSync.destroy();
            }
        });

        // تصدير للنطاق العام للاختبار
        window.testFunctions = {
            testAddQuestion,
            testSync,
            testLoadQuestions,
            runFullTest,
            checkDataIntegrity,
            repairData,
            migrateOldData,
            resetSystem,
            clearTestData,
            exportDiagnostics
        };

        console.log('تم تحميل نظام التزامن الموحد المُصحح بنجاح');
    </script>
</body>
</html>
