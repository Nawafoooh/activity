<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إصلاح نظام التزامن - ناقس</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .fix-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-indicator.fixed {
            background: #27ae60;
        }

        .log-output {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        .log-entry.error {
            color: #dc3545;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.warning {
            color: #ffc107;
        }

        .problem-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .solution-box {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="statusIndicator">
        جاري الإصلاح...
    </div>

    <div class="container">
        <div class="header">
            <h1>🔧 إصلاح حلقة التزامن اللا نهائية</h1>
            <p>حل المشكلة المكتشفة في نظام التزامن</p>
        </div>

        <div class="fix-card">
            <h2>📋 المشكلة المكتشفة</h2>
            
            <div class="problem-box">
                <h3>🔴 المشكلة:</h3>
                <p>النظام يحاول فرض التزامن بشكل مستمر مما يسبب:</p>
                <ul>
                    <li>حلقة لا نهائية من طلبات التزامن</li>
                    <li>استهلاك غير ضروري للموارد</li>
                    <li>عدم استقرار في النظام</li>
                    <li>تكرار الرسائل في السجل</li>
                </ul>
            </div>

            <div class="solution-box">
                <h3>✅ الحل:</h3>
                <p>تطبيق آلية ذكية لمنع التكرار مع:</p>
                <ul>
                    <li>فترات انتظار متدرجة</li>
                    <li>تحديد عدد المحاولات القصوى</li>
                    <li>فحص أكثر دقة لحالة التزامن</li>
                    <li>آلية إيقاف تلقائية عند النجاح</li>
                </ul>
            </div>

            <div style="text-align: center; margin: 2rem 0;">
                <button class="btn" onclick="applyFix()">تطبيق الإصلاح</button>
                <button class="btn danger" onclick="stopAllSync()">إيقاف التزامن</button>
                <button class="btn" onclick="resetAndRestart()">إعادة تشغيل النظام</button>
            </div>

            <div id="logOutput" class="log-output">
                <div class="log-entry">جاري تحليل المشكلة...</div>
            </div>
        </div>
    </div>

    <script>
        // نظام التزامن المُصحح مع منع الحلقات اللا نهائية
        class FixedSyncSystem {
            constructor() {
                this.STORAGE_KEYS = {
                    DAILY_QUESTIONS: 'nafis_unified_daily_questions',
                    WEEKLY_QUESTIONS: 'nafis_unified_weekly_questions',
                    LAST_UPDATE: 'nafis_unified_last_update',
                    SYNC_STATUS: 'nafis_unified_sync_status',
                    HEARTBEAT: 'nafis_unified_heartbeat',
                    LAST_SYNC_ATTEMPT: 'nafis_last_sync_attempt',
                    SYNC_ATTEMPTS_COUNT: 'nafis_sync_attempts_count'
                };
                
                this.channels = [];
                this.heartbeatInterval = null;
                this.retryInterval = null;
                this.isInitialized = false;
                this.isSyncing = false;
                
                // إعدادات منع الحلقة اللا نهائية
                this.MAX_RETRY_ATTEMPTS = 3;
                this.RETRY_DELAY = 10000; // 10 ثوان
                this.HEARTBEAT_INTERVAL = 30000; // 30 ثانية
                this.SYNC_TIMEOUT = 5000; // 5 ثوان
                
                this.init();
            }
            
            init() {
                this.log('بدء تهيئة النظام المُصحح...', 'info');
                
                // إيقاف أي عمليات تزامن سابقة
                this.stopAllIntervals();
                
                // مسح العدادات القديمة
                this.resetSyncCounters();
                
                // إعداد النظام الجديد
                this.setupChannels();
                this.setupImprovedHeartbeat();
                this.setupSmartRetryMechanism();
                
                this.isInitialized = true;
                this.updateStatus('تم الإصلاح', 'fixed');
                this.log('✅ تم إصلاح النظام بنجاح', 'success');
            }
            
            stopAllIntervals() {
                // إيقاف جميع الفترات الزمنية الموجودة
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
                
                if (this.retryInterval) {
                    clearInterval(this.retryInterval);
                    this.retryInterval = null;
                }
                
                // إيقاف أي intervals أخرى قد تكون موجودة
                for (let i = 1; i < 10000; i++) {
                    clearInterval(i);
                }
                
                this.log('تم إيقاف جميع العمليات السابقة', 'info');
            }
            
            resetSyncCounters() {
                localStorage.removeItem(this.STORAGE_KEYS.LAST_SYNC_ATTEMPT);
                localStorage.removeItem(this.STORAGE_KEYS.SYNC_ATTEMPTS_COUNT);
                localStorage.setItem(this.STORAGE_KEYS.SYNC_STATUS, 'idle');
                this.isSyncing = false;
                
                this.log('تم إعادة تعيين العدادات', 'info');
            }
            
            setupChannels() {
                try {
                    // إعداد BroadcastChannel مع معالجة محسنة
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('nafis-unified-sync');
                        channel.onmessage = (e) => this.handleMessage(e.data);
                        this.channels.push(channel);
                    }
                    
                    // مستمع النوافذ مع فلترة
                    window.addEventListener('message', (e) => {
                        if (e.data && e.data.source === 'nafis-sync' && !this.isSyncing) {
                            this.handleMessage(e.data);
                        }
                    });
                    
                    this.log('تم إعداد قنوات الاتصال', 'success');
                    
                } catch (error) {
                    this.log(`خطأ في إعداد القنوات: ${error.message}`, 'error');
                }
            }
            
            setupImprovedHeartbeat() {
                // نبضة أقل تكراراً وأكثر ذكاءً
                this.heartbeatInterval = setInterval(() => {
                    if (!this.isSyncing) {
                        const heartbeat = {
                            timestamp: Date.now(),
                            source: 'fixed-sync-system',
                            status: 'stable',
                            questionsCount: {
                                daily: this.getQuestionCount('daily'),
                                weekly: this.getQuestionCount('weekly')
                            }
                        };
                        
                        localStorage.setItem(this.STORAGE_KEYS.HEARTBEAT, JSON.stringify(heartbeat));
                        this.log('نبضة نظام ثابت', 'info');
                    }
                }, this.HEARTBEAT_INTERVAL);
            }
            
            setupSmartRetryMechanism() {
                // آلية إعادة محاولة ذكية مع منع التكرار
                this.retryInterval = setInterval(() => {
                    this.checkAndRepairIfNeeded();
                }, this.RETRY_DELAY);
            }
            
            checkAndRepairIfNeeded() {
                if (this.isSyncing) {
                    this.log('تم تجاهل الفحص - التزامن جاري', 'warning');
                    return;
                }
                
                const lastAttempt = localStorage.getItem(this.STORAGE_KEYS.LAST_SYNC_ATTEMPT);
                const attemptsCount = parseInt(localStorage.getItem(this.STORAGE_KEYS.SYNC_ATTEMPTS_COUNT) || '0');
                
                // فحص الحاجة للتزامن
                const needsSync = this.checkIfSyncNeeded();
                
                if (needsSync && attemptsCount < this.MAX_RETRY_ATTEMPTS) {
                    const now = Date.now();
                    const lastAttemptTime = lastAttempt ? parseInt(lastAttempt) : 0;
                    
                    // التأكد من مرور وقت كافي منذ آخر محاولة
                    if (now - lastAttemptTime > this.RETRY_DELAY) {
                        this.performControlledSync();
                    }
                } else if (attemptsCount >= this.MAX_RETRY_ATTEMPTS) {
                    this.log('تم الوصول للحد الأقصى من المحاولات - التوقف', 'warning');
                    this.resetSyncCounters();
                }
            }
            
            checkIfSyncNeeded() {
                try {
                    // فحص أكثر دقة للحاجة للتزامن
                    const dailyQuestions = this.loadQuestions('daily');
                    const weeklyQuestions = this.loadQuestions('weekly');
                    
                    // فحص وجود البيانات في النظام القديم
                    const oldDaily = localStorage.getItem('adminDailyQuestions');
                    const oldWeekly = localStorage.getItem('adminWeeklyQuestions');
                    
                    if (oldDaily || oldWeekly) {
                        const oldDailyCount = oldDaily ? JSON.parse(oldDaily).length : 0;
                        const oldWeeklyCount = oldWeekly ? JSON.parse(oldWeekly).length : 0;
                        
                        if (oldDailyCount !== dailyQuestions.length || oldWeeklyCount !== weeklyQuestions.length) {
                            this.log('تم اكتشاف عدم تطابق في البيانات', 'info');
                            return true;
                        }
                    }
                    
                    return false;
                    
                } catch (error) {
                    this.log(`خطأ في فحص الحاجة للتزامن: ${error.message}`, 'error');
                    return false;
                }
            }
            
            performControlledSync() {
                if (this.isSyncing) {
                    this.log('تزامن جاري بالفعل - تجاهل الطلب', 'warning');
                    return;
                }
                
                this.isSyncing = true;
                this.updateStatus('جاري التزامن المُتحكم به...', 'syncing');
                
                const now = Date.now();
                const attemptsCount = parseInt(localStorage.getItem(this.STORAGE_KEYS.SYNC_ATTEMPTS_COUNT) || '0') + 1;
                
                localStorage.setItem(this.STORAGE_KEYS.LAST_SYNC_ATTEMPT, now.toString());
                localStorage.setItem(this.STORAGE_KEYS.SYNC_ATTEMPTS_COUNT, attemptsCount.toString());
                
                this.log(`محاولة تزامن رقم ${attemptsCount}`, 'info');
                
                // تنفيذ التزامن مع timeout
                const syncTimeout = setTimeout(() => {
                    this.log('انتهت مهلة التزامن', 'warning');
                    this.completeSyncProcess(false);
                }, this.SYNC_TIMEOUT);
                
                try {
                    // تنفيذ التزامن الفعلي
                    const success = this.executeSyncOperation();
                    
                    clearTimeout(syncTimeout);
                    this.completeSyncProcess(success);
                    
                } catch (error) {
                    clearTimeout(syncTimeout);
                    this.log(`خطأ في التزامن: ${error.message}`, 'error');
                    this.completeSyncProcess(false);
                }
            }
            
            executeSyncOperation() {
                try {
                    // تحميل البيانات من النظام القديم
                    const oldDaily = localStorage.getItem('adminDailyQuestions');
                    const oldWeekly = localStorage.getItem('adminWeeklyQuestions');
                    
                    let synced = false;
                    
                    if (oldDaily) {
                        const questions = JSON.parse(oldDaily);
                        this.saveQuestions('daily', questions, false);
                        synced = true;
                        this.log(`تم مزامنة ${questions.length} سؤال يومي`, 'success');
                    }
                    
                    if (oldWeekly) {
                        const questions = JSON.parse(oldWeekly);
                        this.saveQuestions('weekly', questions, false);
                        synced = true;
                        this.log(`تم مزامنة ${questions.length} سؤال أسبوعي`, 'success');
                    }
                    
                    return synced;
                    
                } catch (error) {
                    this.log(`خطأ في تنفيذ التزامن: ${error.message}`, 'error');
                    return false;
                }
            }
            
            completeSyncProcess(success) {
                this.isSyncing = false;
                
                if (success) {
                    this.log('✅ تم التزامن بنجاح', 'success');
                    this.resetSyncCounters();
                    this.updateStatus('مُزامن', 'fixed');
                } else {
                    this.log('❌ فشل التزامن', 'error');
                    this.updateStatus('خطأ في التزامن', 'error');
                }
            }
            
            saveQuestions(type, questions, shouldBroadcast = false) {
                try {
                    const key = type === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    const data = {
                        questions: questions,
                        timestamp: Date.now(),
                        version: '2.0-fixed'
                    };
                    
                    localStorage.setItem(key, JSON.stringify(data));
                    localStorage.setItem(this.STORAGE_KEYS.LAST_UPDATE, Date.now().toString());
                    
                    // تحديث النظام القديم أيضاً
                    const mainKey = type === 'daily' ? 'nafisMainDailyQuestions' : 'nafisMainWeeklyQuestions';
                    localStorage.setItem(mainKey, JSON.stringify(questions));
                    
                    return true;
                    
                } catch (error) {
                    this.log(`خطأ في حفظ الأسئلة: ${error.message}`, 'error');
                    return false;
                }
            }
            
            loadQuestions(type) {
                try {
                    const key = type === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        const data = JSON.parse(stored);
                        return data.questions || [];
                    }
                    
                    return [];
                    
                } catch (error) {
                    this.log(`خطأ في تحميل الأسئلة: ${error.message}`, 'error');
                    return [];
                }
            }
            
            getQuestionCount(type) {
                return this.loadQuestions(type).length;
            }
            
            handleMessage(message) {
                if (!message || message.source !== 'nafis-sync' || this.isSyncing) return;
                
                this.log(`رسالة واردة: ${message.type}`, 'info');
                
                // معالجة الرسائل دون تشغيل تزامن إضافي
                if (message.type === 'HEARTBEAT') {
                    this.log('نبضة مستقبلة', 'info');
                }
            }
            
            updateStatus(text, type = 'info') {
                const indicator = document.getElementById('statusIndicator');
                if (indicator) {
                    indicator.textContent = text;
                    indicator.className = `status-indicator ${type}`;
                }
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                console.log(`[${timestamp}] ${message}`);
                
                const output = document.getElementById('logOutput');
                if (output) {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${type}`;
                    entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                    output.insertBefore(entry, output.firstChild);
                    
                    // الاحتفاظ بآخر 20 إدخال فقط
                    while (output.children.length > 20) {
                        output.removeChild(output.lastChild);
                    }
                }
            }
            
            destroy() {
                this.stopAllIntervals();
                this.channels.forEach(channel => {
                    try {
                        channel.close();
                    } catch (e) {}
                });
                this.log('تم تنظيف النظام', 'info');
            }
        }

        // إنشاء النظام المُصحح
        let fixedSync = null;

        function applyFix() {
            log('بدء تطبيق الإصلاح...', 'info');
            
            // إيقاف النظام القديم
            if (window.unifiedSync) {
                window.unifiedSync.destroy();
                delete window.unifiedSync;
            }
            
            // تنظيف شامل
            for (let i = 1; i < 10000; i++) {
                clearInterval(i);
                clearTimeout(i);
            }
            
            // إنشاء النظام الجديد
            fixedSync = new FixedSyncSystem();
            window.unifiedSync = fixedSync;
            
            log('✅ تم تطبيق الإصلاح بنجاح', 'success');
        }

        function stopAllSync() {
            log('إيقاف جميع عمليات التزامن...', 'warning');
            
            // إيقاف شامل
            for (let i = 1; i < 10000; i++) {
                clearInterval(i);
                clearTimeout(i);
            }
            
            if (fixedSync) {
                fixedSync.destroy();
            }
            
            if (window.unifiedSync) {
                window.unifiedSync.destroy();
            }
            
            // مسح البيانات المؤقتة
            localStorage.removeItem('nafis_last_sync_attempt');
            localStorage.removeItem('nafis_sync_attempts_count');
            localStorage.setItem('nafis_unified_sync_status', 'stopped');
            
            document.getElementById('statusIndicator').textContent = 'تم الإيقاف';
            document.getElementById('statusIndicator').className = 'status-indicator';
            
            log('✅ تم إيقاف جميع العمليات', 'success');
        }

        function resetAndRestart() {
            log('إعادة تشغيل النظام...', 'info');
            
            stopAllSync();
            
            setTimeout(() => {
                applyFix();
                log('✅ تم إعادة تشغيل النظام', 'success');
            }, 2000);
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            console.log(`[${timestamp}] ${message}`);
            
            const output = document.getElementById('logOutput');
            if (output) {
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                output.insertBefore(entry, output.firstChild);
                
                while (output.children.length > 20) {
                    output.removeChild(output.lastChild);
                }
            }
        }

        // تطبيق الإصلاح تلقائياً عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            log('تم تحميل صفحة الإصلاح', 'info');
            log('اضغط "تطبيق الإصلاح" لحل المشكلة', 'warning');
        });

        console.log('نظام إصلاح التزامن جاهز');
    </script>
</body>
</html>
