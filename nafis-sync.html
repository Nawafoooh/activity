<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥ØµÙ„Ø§Ø­ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† - Ù†Ø§Ù‚Ø³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .fix-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-indicator.fixed {
            background: #27ae60;
        }

        .log-output {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        .log-entry.error {
            color: #dc3545;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.warning {
            color: #ffc107;
        }

        .problem-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .solution-box {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="statusIndicator">
        Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­...
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ©</h1>
            <p>Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ÙƒØªØ´ÙØ© ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†</p>
        </div>

        <div class="fix-card">
            <h2>ğŸ“‹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h2>
            
            <div class="problem-box">
                <h3>ğŸ”´ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</h3>
                <p>Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­Ø§ÙˆÙ„ ÙØ±Ø¶ Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ…Ø± Ù…Ù…Ø§ ÙŠØ³Ø¨Ø¨:</p>
                <ul>
                    <li>Ø­Ù„Ù‚Ø© Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ© Ù…Ù† Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ²Ø§Ù…Ù†</li>
                    <li>Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ù…ÙˆØ§Ø±Ø¯</li>
                    <li>Ø¹Ø¯Ù… Ø§Ø³ØªÙ‚Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</li>
                    <li>ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„</li>
                </ul>
            </div>

            <div class="solution-box">
                <h3>âœ… Ø§Ù„Ø­Ù„:</h3>
                <p>ØªØ·Ø¨ÙŠÙ‚ Ø¢Ù„ÙŠØ© Ø°ÙƒÙŠØ© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…Ø¹:</p>
                <ul>
                    <li>ÙØªØ±Ø§Øª Ø§Ù†ØªØ¸Ø§Ø± Ù…ØªØ¯Ø±Ø¬Ø©</li>
                    <li>ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù‚ØµÙˆÙ‰</li>
                    <li>ÙØ­Øµ Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†</li>
                    <li>Ø¢Ù„ÙŠØ© Ø¥ÙŠÙ‚Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­</li>
                </ul>
            </div>

            <div style="text-align: center; margin: 2rem 0;">
                <button class="btn" onclick="applyFix()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</button>
                <button class="btn danger" onclick="stopAllSync()">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ²Ø§Ù…Ù†</button>
                <button class="btn" onclick="resetAndRestart()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
            </div>

            <div id="logOutput" class="log-output">
                <div class="log-entry">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©...</div>
            </div>
        </div>
    </div>

    <script>
        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…ÙØµØ­Ø­ Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ©
        class FixedSyncSystem {
            constructor() {
                this.STORAGE_KEYS = {
                    DAILY_QUESTIONS: 'nafis_unified_daily_questions',
                    WEEKLY_QUESTIONS: 'nafis_unified_weekly_questions',
                    LAST_UPDATE: 'nafis_unified_last_update',
                    SYNC_STATUS: 'nafis_unified_sync_status',
                    HEARTBEAT: 'nafis_unified_heartbeat',
                    LAST_SYNC_ATTEMPT: 'nafis_last_sync_attempt',
                    SYNC_ATTEMPTS_COUNT: 'nafis_sync_attempts_count'
                };
                
                this.channels = [];
                this.heartbeatInterval = null;
                this.retryInterval = null;
                this.isInitialized = false;
                this.isSyncing = false;
                
                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù†Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ©
                this.MAX_RETRY_ATTEMPTS = 3;
                this.RETRY_DELAY = 10000; // 10 Ø«ÙˆØ§Ù†
                this.HEARTBEAT_INTERVAL = 30000; // 30 Ø«Ø§Ù†ÙŠØ©
                this.SYNC_TIMEOUT = 5000; // 5 Ø«ÙˆØ§Ù†
                
                this.init();
            }
            
            init() {
                this.log('Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØµØ­Ø­...', 'info');
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ²Ø§Ù…Ù† Ø³Ø§Ø¨Ù‚Ø©
                this.stopAllIntervals();
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                this.resetSyncCounters();
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                this.setupChannels();
                this.setupImprovedHeartbeat();
                this.setupSmartRetryMechanism();
                
                this.isInitialized = true;
                this.updateStatus('ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', 'fixed');
                this.log('âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
            
            stopAllIntervals() {
                // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
                
                if (this.retryInterval) {
                    clearInterval(this.retryInterval);
                    this.retryInterval = null;
                }
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ intervals Ø£Ø®Ø±Ù‰ Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                for (let i = 1; i < 10000; i++) {
                    clearInterval(i);
                }
                
                this.log('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 'info');
            }
            
            resetSyncCounters() {
                localStorage.removeItem(this.STORAGE_KEYS.LAST_SYNC_ATTEMPT);
                localStorage.removeItem(this.STORAGE_KEYS.SYNC_ATTEMPTS_COUNT);
                localStorage.setItem(this.STORAGE_KEYS.SYNC_STATUS, 'idle');
                this.isSyncing = false;
                
                this.log('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª', 'info');
            }
            
            setupChannels() {
                try {
                    // Ø¥Ø¹Ø¯Ø§Ø¯ BroadcastChannel Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø©
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('nafis-unified-sync');
                        channel.onmessage = (e) => this.handleMessage(e.data);
                        this.channels.push(channel);
                    }
                    
                    // Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ù…Ø¹ ÙÙ„ØªØ±Ø©
                    window.addEventListener('message', (e) => {
                        if (e.data && e.data.source === 'nafis-sync' && !this.isSyncing) {
                            this.handleMessage(e.data);
                        }
                    });
                    
                    this.log('ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø§ØªØµØ§Ù„', 'success');
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª: ${error.message}`, 'error');
                }
            }
            
            setupImprovedHeartbeat() {
                // Ù†Ø¨Ø¶Ø© Ø£Ù‚Ù„ ØªÙƒØ±Ø§Ø±Ø§Ù‹ ÙˆØ£ÙƒØ«Ø± Ø°ÙƒØ§Ø¡Ù‹
                this.heartbeatInterval = setInterval(() => {
                    if (!this.isSyncing) {
                        const heartbeat = {
                            timestamp: Date.now(),
                            source: 'fixed-sync-system',
                            status: 'stable',
                            questionsCount: {
                                daily: this.getQuestionCount('daily'),
                                weekly: this.getQuestionCount('weekly')
                            }
                        };
                        
                        localStorage.setItem(this.STORAGE_KEYS.HEARTBEAT, JSON.stringify(heartbeat));
                        this.log('Ù†Ø¨Ø¶Ø© Ù†Ø¸Ø§Ù… Ø«Ø§Ø¨Øª', 'info');
                    }
                }, this.HEARTBEAT_INTERVAL);
            }
            
            setupSmartRetryMechanism() {
                // Ø¢Ù„ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø°ÙƒÙŠØ© Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                this.retryInterval = setInterval(() => {
                    this.checkAndRepairIfNeeded();
                }, this.RETRY_DELAY);
            }
            
            checkAndRepairIfNeeded() {
                if (this.isSyncing) {
                    this.log('ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØ­Øµ - Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¬Ø§Ø±ÙŠ', 'warning');
                    return;
                }
                
                const lastAttempt = localStorage.getItem(this.STORAGE_KEYS.LAST_SYNC_ATTEMPT);
                const attemptsCount = parseInt(localStorage.getItem(this.STORAGE_KEYS.SYNC_ATTEMPTS_COUNT) || '0');
                
                // ÙØ­Øµ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ²Ø§Ù…Ù†
                const needsSync = this.checkIfSyncNeeded();
                
                if (needsSync && attemptsCount < this.MAX_RETRY_ATTEMPTS) {
                    const now = Date.now();
                    const lastAttemptTime = lastAttempt ? parseInt(lastAttempt) : 0;
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø±ÙˆØ± ÙˆÙ‚Øª ÙƒØ§ÙÙŠ Ù…Ù†Ø° Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø©
                    if (now - lastAttemptTime > this.RETRY_DELAY) {
                        this.performControlledSync();
                    }
                } else if (attemptsCount >= this.MAX_RETRY_ATTEMPTS) {
                    this.log('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª - Ø§Ù„ØªÙˆÙ‚Ù', 'warning');
                    this.resetSyncCounters();
                }
            }
            
            checkIfSyncNeeded() {
                try {
                    // ÙØ­Øµ Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© Ù„Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ²Ø§Ù…Ù†
                    const dailyQuestions = this.loadQuestions('daily');
                    const weeklyQuestions = this.loadQuestions('weekly');
                    
                    // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    const oldDaily = localStorage.getItem('adminDailyQuestions');
                    const oldWeekly = localStorage.getItem('adminWeeklyQuestions');
                    
                    if (oldDaily || oldWeekly) {
                        const oldDailyCount = oldDaily ? JSON.parse(oldDaily).length : 0;
                        const oldWeeklyCount = oldWeekly ? JSON.parse(oldWeekly).length : 0;
                        
                        if (oldDailyCount !== dailyQuestions.length || oldWeeklyCount !== weeklyQuestions.length) {
                            this.log('ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
                            return true;
                        }
                    }
                    
                    return false;
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ²Ø§Ù…Ù†: ${error.message}`, 'error');
                    return false;
                }
            }
            
            performControlledSync() {
                if (this.isSyncing) {
                    this.log('ØªØ²Ø§Ù…Ù† Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„ - ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨', 'warning');
                    return;
                }
                
                this.isSyncing = true;
                this.updateStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…ÙØªØ­ÙƒÙ… Ø¨Ù‡...', 'syncing');
                
                const now = Date.now();
                const attemptsCount = parseInt(localStorage.getItem(this.STORAGE_KEYS.SYNC_ATTEMPTS_COUNT) || '0') + 1;
                
                localStorage.setItem(this.STORAGE_KEYS.LAST_SYNC_ATTEMPT, now.toString());
                localStorage.setItem(this.STORAGE_KEYS.SYNC_ATTEMPTS_COUNT, attemptsCount.toString());
                
                this.log(`Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ²Ø§Ù…Ù† Ø±Ù‚Ù… ${attemptsCount}`, 'info');
                
                // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ²Ø§Ù…Ù† Ù…Ø¹ timeout
                const syncTimeout = setTimeout(() => {
                    this.log('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†', 'warning');
                    this.completeSyncProcess(false);
                }, this.SYNC_TIMEOUT);
                
                try {
                    // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„ÙØ¹Ù„ÙŠ
                    const success = this.executeSyncOperation();
                    
                    clearTimeout(syncTimeout);
                    this.completeSyncProcess(success);
                    
                } catch (error) {
                    clearTimeout(syncTimeout);
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ²Ø§Ù…Ù†: ${error.message}`, 'error');
                    this.completeSyncProcess(false);
                }
            }
            
            executeSyncOperation() {
                try {
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    const oldDaily = localStorage.getItem('adminDailyQuestions');
                    const oldWeekly = localStorage.getItem('adminWeeklyQuestions');
                    
                    let synced = false;
                    
                    if (oldDaily) {
                        const questions = JSON.parse(oldDaily);
                        this.saveQuestions('daily', questions, false);
                        synced = true;
                        this.log(`ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${questions.length} Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ`, 'success');
                    }
                    
                    if (oldWeekly) {
                        const questions = JSON.parse(oldWeekly);
                        this.saveQuestions('weekly', questions, false);
                        synced = true;
                        this.log(`ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${questions.length} Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ`, 'success');
                    }
                    
                    return synced;
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ²Ø§Ù…Ù†: ${error.message}`, 'error');
                    return false;
                }
            }
            
            completeSyncProcess(success) {
                this.isSyncing = false;
                
                if (success) {
                    this.log('âœ… ØªÙ… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    this.resetSyncCounters();
                    this.updateStatus('Ù…ÙØ²Ø§Ù…Ù†', 'fixed');
                } else {
                    this.log('âŒ ÙØ´Ù„ Ø§Ù„ØªØ²Ø§Ù…Ù†', 'error');
                    this.updateStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ²Ø§Ù…Ù†', 'error');
                }
            }
            
            saveQuestions(type, questions, shouldBroadcast = false) {
                try {
                    const key = type === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    const data = {
                        questions: questions,
                        timestamp: Date.now(),
                        version: '2.0-fixed'
                    };
                    
                    localStorage.setItem(key, JSON.stringify(data));
                    localStorage.setItem(this.STORAGE_KEYS.LAST_UPDATE, Date.now().toString());
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙŠØ¶Ø§Ù‹
                    const mainKey = type === 'daily' ? 'nafisMainDailyQuestions' : 'nafisMainWeeklyQuestions';
                    localStorage.setItem(mainKey, JSON.stringify(questions));
                    
                    return true;
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${error.message}`, 'error');
                    return false;
                }
            }
            
            loadQuestions(type) {
                try {
                    const key = type === 'daily' ? 
                        this.STORAGE_KEYS.DAILY_QUESTIONS : 
                        this.STORAGE_KEYS.WEEKLY_QUESTIONS;
                    
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        const data = JSON.parse(stored);
                        return data.questions || [];
                    }
                    
                    return [];
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${error.message}`, 'error');
                    return [];
                }
            }
            
            getQuestionCount(type) {
                return this.loadQuestions(type).length;
            }
            
            handleMessage(message) {
                if (!message || message.source !== 'nafis-sync' || this.isSyncing) return;
                
                this.log(`Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©: ${message.type}`, 'info');
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¯ÙˆÙ† ØªØ´ØºÙŠÙ„ ØªØ²Ø§Ù…Ù† Ø¥Ø¶Ø§ÙÙŠ
                if (message.type === 'HEARTBEAT') {
                    this.log('Ù†Ø¨Ø¶Ø© Ù…Ø³ØªÙ‚Ø¨Ù„Ø©', 'info');
                }
            }
            
            updateStatus(text, type = 'info') {
                const indicator = document.getElementById('statusIndicator');
                if (indicator) {
                    indicator.textContent = text;
                    indicator.className = `status-indicator ${type}`;
                }
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                console.log(`[${timestamp}] ${message}`);
                
                const output = document.getElementById('logOutput');
                if (output) {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${type}`;
                    entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                    output.insertBefore(entry, output.firstChild);
                    
                    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 20 Ø¥Ø¯Ø®Ø§Ù„ ÙÙ‚Ø·
                    while (output.children.length > 20) {
                        output.removeChild(output.lastChild);
                    }
                }
            }
            
            destroy() {
                this.stopAllIntervals();
                this.channels.forEach(channel => {
                    try {
                        channel.close();
                    } catch (e) {}
                });
                this.log('ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù…', 'info');
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØµØ­Ø­
        let fixedSync = null;

        function applyFix() {
            log('Ø¨Ø¯Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­...', 'info');
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (window.unifiedSync) {
                window.unifiedSync.destroy();
                delete window.unifiedSync;
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„
            for (let i = 1; i < 10000; i++) {
                clearInterval(i);
                clearTimeout(i);
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            fixedSync = new FixedSyncSystem();
            window.unifiedSync = fixedSync;
            
            log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function stopAllSync() {
            log('Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ²Ø§Ù…Ù†...', 'warning');
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø´Ø§Ù…Ù„
            for (let i = 1; i < 10000; i++) {
                clearInterval(i);
                clearTimeout(i);
            }
            
            if (fixedSync) {
                fixedSync.destroy();
            }
            
            if (window.unifiedSync) {
                window.unifiedSync.destroy();
            }
            
            // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
            localStorage.removeItem('nafis_last_sync_attempt');
            localStorage.removeItem('nafis_sync_attempts_count');
            localStorage.setItem('nafis_unified_sync_status', 'stopped');
            
            document.getElementById('statusIndicator').textContent = 'ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù';
            document.getElementById('statusIndicator').className = 'status-indicator';
            
            log('âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', 'success');
        }

        function resetAndRestart() {
            log('Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...', 'info');
            
            stopAllSync();
            
            setTimeout(() => {
                applyFix();
                log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…', 'success');
            }, 2000);
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            console.log(`[${timestamp}] ${message}`);
            
            const output = document.getElementById('logOutput');
            if (output) {
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
                output.insertBefore(entry, output.firstChild);
                
                while (output.children.length > 20) {
                    output.removeChild(output.lastChild);
                }
            }
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            log('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­', 'info');
            log('Ø§Ø¶ØºØ· "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­" Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©', 'warning');
        });

        console.log('Ù†Ø¸Ø§Ù… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¬Ø§Ù‡Ø²');
    </script>
</body>
</html>
