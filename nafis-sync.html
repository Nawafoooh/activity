<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التزامن الاحترافي - ناقس</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #8e44ad;
            --light-bg: #ecf0f1;
            --dark-bg: #34495e;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #bdc3c7;
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-bg));
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .status-icon.success { background: var(--success-color); }
        .status-icon.warning { background: var(--warning-color); }
        .status-icon.danger { background: var(--danger-color); }
        .status-icon.info { background: var(--info-color); }

        .sync-log {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border-left: 4px solid;
        }

        .log-entry.success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }

        .log-entry.error {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }

        .log-entry.info {
            background: #cce7ff;
            border-color: var(--info-color);
            color: #0c5460;
        }

        .btn {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            min-height: 48px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn.danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }

        .btn.success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .data-viewer {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-top: 2rem;
        }

        .data-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--light-bg);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .tab.active {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-content {
            display: none;
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .question-card {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary-color);
        }

        .question-meta {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .badge.subject { background: var(--secondary-color); }
        .badge.type { background: var(--info-color); }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .data-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>نظام التزامن الاحترافي - ناقس</h1>
            <p>مراقبة ومزامنة البيانات بين لوحة تحكم المعلم ومنصة الطلاب</p>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <div class="status-header">
                    <div class="status-icon info" id="teacherStatus">👨‍🏫</div>
                    <div>
                        <h3>لوحة تحكم المعلم</h3>
                        <p id="teacherStatusText">جاري الفحص...</p>
                    </div>
                </div>
                <div>
                    <small>آخر تحديث: <span id="teacherLastUpdate">غير محدد</span></small>
                </div>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <div class="status-icon info" id="studentStatus">👨‍🎓</div>
                    <div>
                        <h3>منصة الطلاب</h3>
                        <p id="studentStatusText">جاري الفحص...</p>
                    </div>
                </div>
                <div>
                    <small>آخر تحديث: <span id="studentLastUpdate">غير محدد</span></small>
                </div>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <div class="status-icon info" id="syncStatus">🔄</div>
                    <div>
                        <h3>حالة التزامن</h3>
                        <p id="syncStatusText">جاري الفحص...</p>
                    </div>
                </div>
                <div>
                    <small>معدل التحديث: <span id="syncRate">كل 5 ثوان</span></small>
                </div>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <div class="status-icon info" id="dataStatus">📊</div>
                    <div>
                        <h3>إحصائيات البيانات</h3>
                        <p id="dataStatusText">يومي: 0 | أسبوعي: 0</p>
                    </div>
                </div>
                <div>
                    <small>إجمالي: <span id="totalQuestions">0</span> سؤال</small>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn success" onclick="forceSync()">
                🔄 فرض المزامنة
            </button>
            <button class="btn" onclick="checkDataIntegrity()">
                🔍 فحص سلامة البيانات
            </button>
            <button class="btn danger" onclick="clearAllData()">
                🗑️ مسح جميع البيانات
            </button>
            <button class="btn" onclick="exportDiagnostics()">
                📋 تصدير تقرير التشخيص
            </button>
        </div>

        <div class="sync-log">
            <h3 style="margin-bottom: 1rem;">سجل التزامن المباشر</h3>
            <div id="logContainer">
                <div class="log-entry info">
                    <strong>تم تهيئة نظام التزامن</strong>
                    <br><small>النظام جاهز لمراقبة التحديثات</small>
                </div>
            </div>
        </div>

        <div class="data-viewer">
            <h3>عارض البيانات</h3>
            <div class="data-tabs">
                <button class="tab active" onclick="showTab('daily')">الأسئلة اليومية</button>
                <button class="tab" onclick="showTab('weekly')">الأسئلة الأسبوعية</button>
                <button class="tab" onclick="showTab('storage')">تفاصيل التخزين</button>
            </div>
            
            <div id="daily-tab" class="tab-content active">
                <div id="dailyQuestions">جاري تحميل الأسئلة اليومية...</div>
            </div>
            
            <div id="weekly-tab" class="tab-content">
                <div id="weeklyQuestions">جاري تحميل الأسئلة الأسبوعية...</div>
            </div>
            
            <div id="storage-tab" class="tab-content">
                <div id="storageDetails">جاري تحميل تفاصيل التخزين...</div>
            </div>
        </div>
    </div>

    <script>
        /**
         * نظام التزامن الاحترافي لناقس
         * يوفر مزامنة شاملة وموثوقة بين جميع أجزاء النظام
         */
        class NafisProfessionalSyncSystem {
            constructor() {
                this.isInitialized = false;
                this.syncInterval = null;
                this.lastSync = 0;
                this.syncRate = 5000; // 5 ثوان
                this.logContainer = document.getElementById('logContainer');
                this.channels = [];
                this.storageKeys = [
                    'adminDailyQuestions',
                    'adminWeeklyQuestions',
                    'nafisMainDailyQuestions', 
                    'nafisMainWeeklyQuestions',
                    'nafisLastUpdate',
                    'nafisLastDailyUpdate',
                    'nafisLastWeeklyUpdate'
                ];
                
                this.init();
            }

            init() {
                this.log('تهيئة نظام التزامن الاحترافي...', 'info');
                
                try {
                    this.setupBroadcastChannels();
                    this.setupStorageListener();
                    this.setupWindowListener();
                    this.startSyncLoop();
                    this.loadInitialData();
                    this.updateUI();
                    
                    this.isInitialized = true;
                    this.log('تم تهيئة نظام التزامن بنجاح', 'success');
                    
                } catch (error) {
                    this.log(`خطأ في التهيئة: ${error.message}`, 'error');
                    console.error('خطأ في تهيئة نظام التزامن:', error);
                }
            }

            setupBroadcastChannels() {
                if (typeof BroadcastChannel === 'undefined') {
                    this.log('BroadcastChannel غير مدعوم في هذا المتصفح', 'error');
                    return;
                }

                const channelNames = [
                    'nafis-teacher-updates',
                    'nafis-student-updates', 
                    'nafis-sync-updates',
                    'nafis-main-updates'
                ];

                channelNames.forEach(channelName => {
                    try {
                        const channel = new BroadcastChannel(channelName);
                        
                        channel.addEventListener('message', (event) => {
                            this.handleBroadcastMessage(event.data, channelName);
                        });
                        
                        channel.addEventListener('error', (error) => {
                            this.log(`خطأ في قناة ${channelName}: ${error.message}`, 'error');
                        });
                        
                        this.channels.push({ name: channelName, channel });
                        
                    } catch (error) {
                        this.log(`فشل في إنشاء قناة ${channelName}: ${error.message}`, 'error');
                    }
                });

                this.log(`تم إعداد ${this.channels.length} قناة broadcast`, 'success');
            }

            setupStorageListener() {
                window.addEventListener('storage', (event) => {
                    if (this.storageKeys.includes(event.key)) {
                        this.log(`تغيير في localStorage: ${event.key}`, 'info');
                        this.handleStorageChange(event);
                    }
                });

                // مراقبة تغييرات localStorage في نفس التبويب
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = (...args) => {
                    originalSetItem.apply(localStorage, args);
                    if (this.storageKeys.includes(args[0])) {
                        this.handleLocalStorageUpdate(args[0], args[1]);
                    }
                };
            }

            setupWindowListener() {
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type && event.data.type.startsWith('NAFIS_')) {
                        this.handleWindowMessage(event.data);
                    }
                });
            }

            startSyncLoop() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                this.syncInterval = setInterval(() => {
                    this.performSync();
                }, this.syncRate);

                this.log(`بدء دورة المزامنة (كل ${this.syncRate / 1000} ثانية)`, 'info');
            }

            handleBroadcastMessage(data, channelName) {
                if (!data || !data.type) return;

                this.log(`رسالة من ${channelName}: ${data.type}`, 'info');

                switch (data.type) {
                    case 'QUESTIONS_UPDATED':
                        this.handleQuestionsUpdate(data);
                        break;
                    case 'HEARTBEAT':
                        this.handleHeartbeat(data);
                        break;
                    case 'SYNC_REQUEST':
                        this.handleSyncRequest(data);
                        break;
                    case 'DATA_CORRUPTION_DETECTED':
                        this.handleDataCorruption(data);
                        break;
                    default:
                        this.log(`نوع رسالة غير معروف: ${data.type}`, 'error');
                }
            }

            handleStorageChange(event) {
                this.log(`تغيير localStorage: ${event.key}`, 'info');
                this.loadDataFromStorage();
                this.updateUI();
                this.broadcastUpdate('STORAGE_CHANGED', {
                    key: event.key,
                    oldValue: event.oldValue,
                    newValue: event.newValue
                });
            }

            handleLocalStorageUpdate(key, value) {
                this.log(`تحديث localStorage محلي: ${key}`, 'info');
                setTimeout(() => {
                    this.loadDataFromStorage();
                    this.updateUI();
                }, 100);
            }

            handleWindowMessage(data) {
                this.log(`رسالة window: ${data.type}`, 'info');
                
                switch (data.type) {
                    case 'NAFIS_FORCE_SYNC':
                        this.forceSync();
                        break;
                    case 'NAFIS_UPDATE_ALL':
                        this.loadDataFromStorage();
                        this.updateUI();
                        break;
                }
            }

            handleQuestionsUpdate(data) {
                const { questionType, questions, source, timestamp } = data;
                
                this.log(`تحديث أسئلة ${questionType} من ${source}`, 'success');
                
                try {
                    if (questionType === 'daily') {
                        this.dailyQuestions = questions || [];
                        localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(this.dailyQuestions));
                    } else if (questionType === 'weekly') {
                        this.weeklyQuestions = questions || [];
                        localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(this.weeklyQuestions));
                    }
                    
                    localStorage.setItem('nafisLastUpdate', timestamp.toString());
                    localStorage.setItem(`nafisLast${questionType}Update`, timestamp.toString());
                    
                    this.updateUI();
                    this.broadcastUpdate('DATA_SYNCHRONIZED', {
                        questionType,
                        count: questions ? questions.length : 0,
                        timestamp
                    });
                    
                } catch (error) {
                    this.log(`خطأ في معالجة تحديث الأسئلة: ${error.message}`, 'error');
                }
            }

            handleHeartbeat(data) {
                const { source, dailyCount, weeklyCount, timestamp } = data;
                this.log(`نبضة من ${source}: يومي ${dailyCount}, أسبوعي ${weeklyCount}`, 'info');
            }

            handleSyncRequest(data) {
                this.log('طلب مزامنة وارد', 'info');
                this.performSync();
            }

            handleDataCorruption(data) {
                this.log(`تم اكتشاف تلف في البيانات: ${data.details}`, 'error');
                this.repairData();
            }

            loadInitialData() {
                this.loadDataFromStorage();
                this.log('تم تحميل البيانات الأولية', 'success');
            }

            loadDataFromStorage() {
                try {
                    // تحميل الأسئلة اليومية
                    const adminDaily = this.getFromStorage('adminDailyQuestions');
                    const mainDaily = this.getFromStorage('nafisMainDailyQuestions');
                    
                    if (adminDaily && adminDaily.length > 0) {
                        this.dailyQuestions = adminDaily;
                        // مزامنة مع المصدر الرئيسي
                        localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(adminDaily));
                    } else if (mainDaily && mainDaily.length > 0) {
                        this.dailyQuestions = mainDaily;
                    } else {
                        this.dailyQuestions = [];
                    }

                    // تحميل الأسئلة الأسبوعية
                    const adminWeekly = this.getFromStorage('adminWeeklyQuestions');
                    const mainWeekly = this.getFromStorage('nafisMainWeeklyQuestions');
                    
                    if (adminWeekly && adminWeekly.length > 0) {
                        this.weeklyQuestions = adminWeekly;
                        // مزامنة مع المصدر الرئيسي
                        localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(adminWeekly));
                    } else if (mainWeekly && mainWeekly.length > 0) {
                        this.weeklyQuestions = mainWeekly;
                    } else {
                        this.weeklyQuestions = [];
                    }

                    this.log(`تم تحميل البيانات: يومي ${this.dailyQuestions.length}, أسبوعي ${this.weeklyQuestions.length}`, 'success');

                } catch (error) {
                    this.log(`خطأ في تحميل البيانات: ${error.message}`, 'error');
                    this.dailyQuestions = [];
                    this.weeklyQuestions = [];
                }
            }

            getFromStorage(key) {
                try {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const parsed = JSON.parse(data);
                        return Array.isArray(parsed) ? parsed.filter(item => item && typeof item === 'object') : [];
                    }
                    return [];
                } catch (error) {
                    this.log(`خطأ في قراءة ${key}: ${error.message}`, 'error');
                    return [];
                }
            }

            performSync() {
                try {
                    const oldDailyCount = this.dailyQuestions ? this.dailyQuestions.length : 0;
                    const oldWeeklyCount = this.weeklyQuestions ? this.weeklyQuestions.length : 0;

                    this.loadDataFromStorage();

                    const newDailyCount = this.dailyQuestions ? this.dailyQuestions.length : 0;
                    const newWeeklyCount = this.weeklyQuestions ? this.weeklyQuestions.length : 0;

                    if (newDailyCount !== oldDailyCount || newWeeklyCount !== oldWeeklyCount) {
                        this.log(`تم اكتشاف تغيير: يومي ${oldDailyCount}→${newDailyCount}, أسبوعي ${oldWeeklyCount}→${newWeeklyCount}`, 'success');
                        this.updateUI();
                        
                        this.broadcastUpdate('AUTO_SYNC_COMPLETED', {
                            dailyCount: newDailyCount,
                            weeklyCount: newWeeklyCount,
                            timestamp: Date.now()
                        });
                    }

                    this.lastSync = Date.now();
                    document.getElementById('syncStatus').className = 'status-icon success';

                } catch (error) {
                    this.log(`خطأ في المزامنة التلقائية: ${error.message}`, 'error');
                    document.getElementById('syncStatus').className = 'status-icon danger';
                }
            }

            forceSync() {
                this.log('بدء المزامنة القسرية...', 'info');
                
                try {
                    // إعادة تحميل شاملة للبيانات
                    this.loadDataFromStorage();
                    
                    // التأكد من وجود البيانات في جميع المواقع
                    if (this.dailyQuestions.length > 0) {
                        localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(this.dailyQuestions));
                        localStorage.setItem('adminDailyQuestions', JSON.stringify(this.dailyQuestions));
                    }
                    
                    if (this.weeklyQuestions.length > 0) {
                        localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(this.weeklyQuestions));
                        localStorage.setItem('adminWeeklyQuestions', JSON.stringify(this.weeklyQuestions));
                    }
                    
                    // تحديث الطوابع الزمنية
                    const timestamp = Date.now();
                    localStorage.setItem('nafisLastUpdate', timestamp.toString());
                    localStorage.setItem('nafisLastDailyUpdate', timestamp.toString());
                    localStorage.setItem('nafisLastWeeklyUpdate', timestamp.toString());
                    
                    // إرسال إشعار للجميع
                    this.broadcastUpdate('FORCE_SYNC_COMPLETED', {
                        dailyCount: this.dailyQuestions.length,
                        weeklyCount: this.weeklyQuestions.length,
                        timestamp
                    });
                    
                    // تحديث الواجهة
                    this.updateUI();
                    
                    this.log('تمت المزامنة القسرية بنجاح', 'success');
                    
                } catch (error) {
                    this.log(`خطأ في المزامنة القسرية: ${error.message}`, 'error');
                }
            }

            broadcastUpdate(type, data) {
                const message = {
                    type,
                    ...data,
                    source: 'sync-system',
                    timestamp: Date.now()
                };

                // إرسال عبر جميع القنوات
                this.channels.forEach(({ name, channel }) => {
                    try {
                        channel.postMessage(message);
                    } catch (error) {
                        this.log(`خطأ في إرسال رسالة عبر ${name}: ${error.message}`, 'error');
                    }
                });

                // إرسال عبر window.postMessage أيضاً
                try {
                    window.postMessage(message, '*');
                } catch (error) {
                    this.log(`خطأ في إرسال window message: ${error.message}`, 'error');
                }
            }

            updateUI() {
                try {
                    // تحديث إحصائيات البيانات
                    const dailyCount = this.dailyQuestions ? this.dailyQuestions.length : 0;
                    const weeklyCount = this.weeklyQuestions ? this.weeklyQuestions.length : 0;
                    const totalCount = dailyCount + weeklyCount;

                    document.getElementById('dataStatusText').textContent = `يومي: ${dailyCount} | أسبوعي: ${weeklyCount}`;
                    document.getElementById('totalQuestions').textContent = totalCount;

                    // تحديث حالة المعلم
                    const teacherDaily = this.getFromStorage('adminDailyQuestions').length;
                    const teacherWeekly = this.getFromStorage('adminWeeklyQuestions').length;
                    const teacherTotal = teacherDaily + teacherWeekly;
                    
                    if (teacherTotal > 0) {
                        document.getElementById('teacherStatus').className = 'status-icon success';
                        document.getElementById('teacherStatusText').textContent = `${teacherTotal} سؤال متاح`;
                    } else {
                        document.getElementById('teacherStatus').className = 'status-icon warning';
                        document.getElementById('teacherStatusText').textContent = 'لا توجد أسئلة';
                    }

                    // تحديث حالة الطلاب
                    const studentDaily = this.getFromStorage('nafisMainDailyQuestions').length;
                    const studentWeekly = this.getFromStorage('nafisMainWeeklyQuestions').length;
                    const studentTotal = studentDaily + studentWeekly;
                    
                    if (studentTotal > 0) {
                        document.getElementById('studentStatus').className = 'status-icon success';
                        document.getElementById('studentStatusText').textContent = `${studentTotal} سؤال متزامن`;
                    } else {
                        document.getElementById('studentStatus').className = 'status-icon danger';
                        document.getElementById('studentStatusText').textContent = 'لا توجد أسئلة متزامنة';
                    }

                    // تحديث حالة التزامن
                    const isInSync = (teacherDaily === studentDaily && teacherWeekly === studentWeekly);
                    if (isInSync && studentTotal > 0) {
                        document.getElementById('syncStatus').className = 'status-icon success';
                        document.getElementById('syncStatusText').textContent = 'متزامن بالكامل';
                    } else if (studentTotal === 0) {
                        document.getElementById('syncStatus').className = 'status-icon warning';
                        document.getElementById('syncStatusText').textContent = 'لا توجد بيانات للمزامنة';
                    } else {
                        document.getElementById('syncStatus').className = 'status-icon danger';
                        document.getElementById('syncStatusText').textContent = 'غير متزامن';
                    }

                    // تحديث أوقات آخر تحديث
                    const teacherUpdate = localStorage.getItem('nafisLastUpdate');
                    const studentUpdate = localStorage.getItem('nafisLastUpdate');
                    
                    document.getElementById('teacherLastUpdate').textContent = 
                        teacherUpdate ? new Date(parseInt(teacherUpdate)).toLocaleString('ar-SA') : 'غير محدد';
                    document.getElementById('studentLastUpdate').textContent = 
                        studentUpdate ? new Date(parseInt(studentUpdate)).toLocaleString('ar-SA') : 'غير محدد';

                    // تحديث عارض البيانات
                    this.updateDataViewer();

                } catch (error) {
                    this.log(`خطأ في تحديث الواجهة: ${error.message}`, 'error');
                }
            }

            updateDataViewer() {
                try {
                    // عرض الأسئلة اليومية
                    const dailyContainer = document.getElementById('dailyQuestions');
                    if (this.dailyQuestions && this.dailyQuestions.length > 0) {
                        dailyContainer.innerHTML = this.dailyQuestions.map((q, index) => `
                            <div class="question-card">
                                <div class="question-meta">
                                    <span class="badge subject">${q.subject || 'غير محدد'}</span>
                                    <span class="badge type">يومي</span>
                                </div>
                                <strong>السؤال ${index + 1}:</strong> ${q.question || 'نص السؤال غير متوفر'}
                                <br><small>تاريخ الإنشاء: ${q.createdAt || 'غير محدد'}</small>
                            </div>
                        `).join('');
                    } else {
                        dailyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">لا توجد أسئلة يومية</p>';
                    }

                    // عرض الأسئلة الأسبوعية
                    const weeklyContainer = document.getElementById('weeklyQuestions');
                    if (this.weeklyQuestions && this.weeklyQuestions.length > 0) {
                        weeklyContainer.innerHTML = this.weeklyQuestions.map((q, index) => `
                            <div class="question-card">
                                <div class="question-meta">
                                    <span class="badge subject">${q.subject || 'غير محدد'}</span>
                                    <span class="badge type">أسبوعي</span>
                                </div>
                                <strong>السؤال ${index + 1}:</strong> ${q.question || 'نص السؤال غير متوفر'}
                                <br><small>تاريخ الإنشاء: ${q.createdAt || 'غير محدد'}</small>
                            </div>
                        `).join('');
                    } else {
                        weeklyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">لا توجد أسئلة أسبوعية</p>';
                    }

                    // عرض تفاصيل التخزين
                    const storageContainer = document.getElementById('storageDetails');
                    const storageInfo = this.storageKeys.map(key => {
                        const data = localStorage.getItem(key);
                        let info = `<strong>${key}:</strong> `;
                        
                        if (data) {
                            if (key.includes('Last') || key.includes('Update')) {
                                const timestamp = parseInt(data);
                                info += isNaN(timestamp) ? 'قيمة غير صحيحة' : new Date(timestamp).toLocaleString('ar-SA');
                            } else {
                                try {
                                    const parsed = JSON.parse(data);
                                    info += Array.isArray(parsed) ? `${parsed.length} عنصر` : 'بيانات غير صحيحة';
                                } catch {
                                    info += 'بيانات تالفة';
                                }
                            }
                        } else {
                            info += 'غير موجود';
                        }
                        
                        return `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">${info}</div>`;
                    }).join('');
                    
                    storageContainer.innerHTML = storageInfo;

                } catch (error) {
                    this.log(`خطأ في تحديث عارض البيانات: ${error.message}`, 'error');
                }
            }

            checkDataIntegrity() {
                this.log('بدء فحص سلامة البيانات...', 'info');
                
                let issues = [];

                try {
                    // فحص الأسئلة اليومية
                    const adminDaily = this.getFromStorage('adminDailyQuestions');
                    const mainDaily = this.getFromStorage('nafisMainDailyQuestions');
                    
                    if (adminDaily.length !== mainDaily.length) {
                        issues.push(`عدم تطابق الأسئلة اليومية: معلم ${adminDaily.length}, رئيسي ${mainDaily.length}`);
                    }

                    // فحص الأسئلة الأسبوعية
                    const adminWeekly = this.getFromStorage('adminWeeklyQuestions');
                    const mainWeekly = this.getFromStorage('nafisMainWeeklyQuestions');
                    
                    if (adminWeekly.length !== mainWeekly.length) {
                        issues.push(`عدم تطابق الأسئلة الأسبوعية: معلم ${adminWeekly.length}, رئيسي ${mainWeekly.length}`);
                    }

                    // فحص صحة بنية البيانات
                    [...adminDaily, ...adminWeekly, ...mainDaily, ...mainWeekly].forEach((question, index) => {
                        if (!question || typeof question !== 'object') {
                            issues.push(`سؤال تالف في الفهرس ${index}`);
                        } else {
                            if (!question.id) issues.push(`سؤال بدون معرف في الفهرس ${index}`);
                            if (!question.question) issues.push(`سؤال بدون نص في الفهرس ${index}`);
                            if (!question.options || !Array.isArray(question.options)) {
                                issues.push(`خيارات تالفة في السؤال ${index}`);
                            }
                            if (typeof question.correct !== 'number') {
                                issues.push(`إجابة صحيحة غير صحيحة في السؤال ${index}`);
                            }
                        }
                    });

                    // تقرير النتائج
                    if (issues.length === 0) {
                        this.log('فحص سلامة البيانات: جميع البيانات سليمة', 'success');
                    } else {
                        this.log(`تم اكتشاف ${issues.length} مشكلة في البيانات`, 'error');
                        issues.forEach(issue => this.log(`- ${issue}`, 'error'));
                        
                        if (confirm('تم اكتشاف مشاكل في البيانات. هل تريد محاولة إصلاحها؟')) {
                            this.repairData();
                        }
                    }

                } catch (error) {
                    this.log(`خطأ في فحص سلامة البيانات: ${error.message}`, 'error');
                }
            }

            repairData() {
                this.log('بدء إصلاح البيانات...', 'info');
                
                try {
                    // إصلاح الأسئلة اليومية
                    let adminDaily = this.getFromStorage('adminDailyQuestions');
                    let mainDaily = this.getFromStorage('nafisMainWeeklyQuestions');
                    
                    // استخدام البيانات الأكثر حداثة
                    const validDaily = adminDaily.length > mainDaily.length ? adminDaily : mainDaily;
                    const cleanDaily = validDaily.filter(q => q && typeof q === 'object' && q.id && q.question);
                    
                    localStorage.setItem('adminDailyQuestions', JSON.stringify(cleanDaily));
                    localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(cleanDaily));

                    // إصلاح الأسئلة الأسبوعية
                    let adminWeekly = this.getFromStorage('adminWeeklyQuestions');
                    let mainWeekly = this.getFromStorage('nafisMainWeeklyQuestions');
                    
                    const validWeekly = adminWeekly.length > mainWeekly.length ? adminWeekly : mainWeekly;
                    const cleanWeekly = validWeekly.filter(q => q && typeof q === 'object' && q.id && q.question);
                    
                    localStorage.setItem('adminWeeklyQuestions', JSON.stringify(cleanWeekly));
                    localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(cleanWeekly));

                    // تحديث الطوابع الزمنية
                    const timestamp = Date.now();
                    localStorage.setItem('nafisLastUpdate', timestamp.toString());
                    localStorage.setItem('nafisLastDailyUpdate', timestamp.toString());
                    localStorage.setItem('nafisLastWeeklyUpdate', timestamp.toString());

                    this.loadDataFromStorage();
                    this.updateUI();

                    this.log(`تم إصلاح البيانات: يومي ${cleanDaily.length}, أسبوعي ${cleanWeekly.length}`, 'success');

                } catch (error) {
                    this.log(`خطأ في إصلاح البيانات: ${error.message}`, 'error');
                }
            }

            clearAllData() {
                if (!confirm('هل أنت متأكد من حذف جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء.')) {
                    return;
                }

                this.log('بدء مسح جميع البيانات...', 'info');

                try {
                    this.storageKeys.forEach(key => {
                        localStorage.removeItem(key);
                    });

                    // مسح البيانات المحلية
                    this.dailyQuestions = [];
                    this.weeklyQuestions = [];

                    // إشعار جميع المكونات
                    this.broadcastUpdate('ALL_DATA_CLEARED', {
                        timestamp: Date.now()
                    });

                    this.updateUI();
                    this.log('تم مسح جميع البيانات بنجاح', 'success');

                } catch (error) {
                    this.log(`خطأ في مسح البيانات: ${error.message}`, 'error');
                }
            }

            exportDiagnostics() {
                this.log('تصدير تقرير التشخيص...', 'info');

                try {
                    const diagnostics = {
                        timestamp: new Date().toISOString(),
                        systemInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            cookieEnabled: navigator.cookieEnabled,
                            onLine: navigator.onLine
                        },
                        storageData: {},
                        dataIntegrity: {
                            dailyQuestions: this.dailyQuestions ? this.dailyQuestions.length : 0,
                            weeklyQuestions: this.weeklyQuestions ? this.weeklyQuestions.length : 0,
                            hasCorruption: false
                        },
                        syncStatus: {
                            isInitialized: this.isInitialized,
                            lastSync: this.lastSync,
                            syncRate: this.syncRate,
                            channelsCount: this.channels.length
                        },
                        logs: Array.from(this.logContainer.children).map(entry => ({
                            type: entry.className.split(' ')[1],
                            content: entry.textContent
                        }))
                    };

                    // جمع بيانات التخزين
                    this.storageKeys.forEach(key => {
                        const data = localStorage.getItem(key);
                        diagnostics.storageData[key] = {
                            exists: !!data,
                            size: data ? data.length : 0,
                            type: key.includes('Last') ? 'timestamp' : 'array'
                        };
                    });

                    // تصدير كملف JSON
                    const blob = new Blob([JSON.stringify(diagnostics, null, 2)], { 
                        type: 'application/json' 
                    });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nafis-diagnostics-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.log('تم تصدير تقرير التشخيص بنجاح', 'success');

                } catch (error) {
                    this.log(`خطأ في تصدير التشخيص: ${error.message}`, 'error');
                }
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.innerHTML = `
                    <strong>[${timestamp}]</strong> ${message}
                `;

                this.logContainer.insertBefore(logEntry, this.logContainer.firstChild);

                // الحفاظ على آخر 100 إدخال فقط
                while (this.logContainer.children.length > 100) {
                    this.logContainer.removeChild(this.logContainer.lastChild);
                }

                // تسجيل في وحدة التحكم أيضاً
                console.log(`[Nafis Sync] ${message}`);
            }

            destroy() {
                this.log('إيقاف نظام التزامن...', 'info');
                
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                this.channels.forEach(({ channel }) => {
                    try {
                        channel.close();
                    } catch (error) {
                        console.error('خطأ في إغلاق القناة:', error);
                    }
                });

                this.isInitialized = false;
                this.log('تم إيقاف نظام التزامن', 'info');
            }
        }

        // إنشاء مثيل من نظام التزامن
        let syncSystem = null;

        // الوظائف العامة
        function forceSync() {
            if (syncSystem) {
                syncSystem.forceSync();
            }
        }

        function checkDataIntegrity() {
            if (syncSystem) {
                syncSystem.checkDataIntegrity();
            }
        }

        function clearAllData() {
            if (syncSystem) {
                syncSystem.clearAllData();
            }
        }

        function exportDiagnostics() {
            if (syncSystem) {
                syncSystem.exportDiagnostics();
            }
        }

        function showTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // إظهار التبويب المحدد
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // تهيئة النظام عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            try {
                syncSystem = new NafisProfessionalSyncSystem();
                console.log('تم تهيئة نظام التزامن الاحترافي لناقس');
            } catch (error) {
                console.error('خطأ في تهيئة نظام التزامن:', error);
            }
        });

        // تنظيف النظام عند إغلاق النافذة
        window.addEventListener('beforeunload', function() {
            if (syncSystem) {
                syncSystem.destroy();
            }
        });

        // إتاحة النظام للاستخدام الخارجي
        window.nafisSyncSystem = syncSystem;
    </script>
</body>
</html>
