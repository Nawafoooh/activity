<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ù†Ø§Ù‚Ø³</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #8e44ad;
            --light-bg: #ecf0f1;
            --dark-bg: #34495e;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #bdc3c7;
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-bg));
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .status-icon.success { background: var(--success-color); }
        .status-icon.warning { background: var(--warning-color); }
        .status-icon.danger { background: var(--danger-color); }
        .status-icon.info { background: var(--info-color); }

        .sync-log {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border-left: 4px solid;
        }

        .log-entry.success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }

        .log-entry.error {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }

        .log-entry.info {
            background: #cce7ff;
            border-color: var(--info-color);
            color: #0c5460;
        }

        .btn {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            min-height: 48px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn.danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }

        .btn.success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .data-viewer {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-top: 2rem;
        }

        .data-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--light-bg);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .tab.active {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-content {
            display: none;
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .question-card {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary-color);
        }

        .question-meta {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .badge.subject { background: var(--secondary-color); }
        .badge.type { background: var(--info-color); }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .data-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ù†Ø§Ù‚Ø³</h1>
            <p>Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù… ÙˆÙ…Ù†ØµØ© Ø§Ù„Ø·Ù„Ø§Ø¨</p>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <div class="status-header">
                    <div class="status-icon info" id="teacherStatus">ğŸ‘¨â€ğŸ«</div>
                    <div>
                        <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
                        <p id="teacherStatusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</p>
                    </div>
                </div>
                <div>
                    <small>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="teacherLastUpdate">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span></small>
                </div>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <div class="status-icon info" id="studentStatus">ğŸ‘¨â€ğŸ“</div>
                    <div>
                        <h3>Ù…Ù†ØµØ© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <p id="studentStatusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</p>
                    </div>
                </div>
                <div>
                    <small>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="studentLastUpdate">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span></small>
                </div>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <div class="status-icon info" id="syncStatus">ğŸ”„</div>
                    <div>
                        <h3>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†</h3>
                        <p id="syncStatusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</p>
                    </div>
                </div>
                <div>
                    <small>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: <span id="syncRate">ÙƒÙ„ 5 Ø«ÙˆØ§Ù†</span></small>
                </div>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <div class="status-icon info" id="dataStatus">ğŸ“Š</div>
                    <div>
                        <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                        <p id="dataStatusText">ÙŠÙˆÙ…ÙŠ: 0 | Ø£Ø³Ø¨ÙˆØ¹ÙŠ: 0</p>
                    </div>
                </div>
                <div>
                    <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="totalQuestions">0</span> Ø³Ø¤Ø§Ù„</small>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn success" onclick="forceSync()">
                ğŸ”„ ÙØ±Ø¶ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            </button>
            <button class="btn" onclick="checkDataIntegrity()">
                ğŸ” ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button class="btn danger" onclick="clearAllData()">
                ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button class="btn" onclick="exportDiagnostics()">
                ğŸ“‹ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ
            </button>
        </div>

        <div class="sync-log">
            <h3 style="margin-bottom: 1rem;">Ø³Ø¬Ù„ Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
            <div id="logContainer">
                <div class="log-entry info">
                    <strong>ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†</strong>
                    <br><small>Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</small>
                </div>
            </div>
        </div>

        <div class="data-viewer">
            <h3>Ø¹Ø§Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <div class="data-tabs">
                <button class="tab active" onclick="showTab('daily')">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
                <button class="tab" onclick="showTab('weekly')">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</button>
                <button class="tab" onclick="showTab('storage')">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ†</button>
            </div>
            
            <div id="daily-tab" class="tab-content active">
                <div id="dailyQuestions">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©...</div>
            </div>
            
            <div id="weekly-tab" class="tab-content">
                <div id="weeklyQuestions">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©...</div>
            </div>
            
            <div id="storage-tab" class="tab-content">
                <div id="storageDetails">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ†...</div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù†Ø§Ù‚Ø³
         * ÙŠÙˆÙØ± Ù…Ø²Ø§Ù…Ù†Ø© Ø´Ø§Ù…Ù„Ø© ÙˆÙ…ÙˆØ«ÙˆÙ‚Ø© Ø¨ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
         */
        class NafisProfessionalSyncSystem {
            constructor() {
                this.isInitialized = false;
                this.syncInterval = null;
                this.lastSync = 0;
                this.syncRate = 5000; // 5 Ø«ÙˆØ§Ù†
                this.logContainer = document.getElementById('logContainer');
                this.channels = [];
                this.storageKeys = [
                    'adminDailyQuestions',
                    'adminWeeklyQuestions',
                    'nafisMainDailyQuestions', 
                    'nafisMainWeeklyQuestions',
                    'nafisLastUpdate',
                    'nafisLastDailyUpdate',
                    'nafisLastWeeklyUpdate'
                ];
                
                this.init();
            }

            init() {
                this.log('ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ...', 'info');
                
                try {
                    this.setupBroadcastChannels();
                    this.setupStorageListener();
                    this.setupWindowListener();
                    this.startSyncLoop();
                    this.loadInitialData();
                    this.updateUI();
                    
                    this.isInitialized = true;
                    this.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${error.message}`, 'error');
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†:', error);
                }
            }

            setupBroadcastChannels() {
                if (typeof BroadcastChannel === 'undefined') {
                    this.log('BroadcastChannel ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­', 'error');
                    return;
                }

                const channelNames = [
                    'nafis-teacher-updates',
                    'nafis-student-updates', 
                    'nafis-sync-updates',
                    'nafis-main-updates'
                ];

                channelNames.forEach(channelName => {
                    try {
                        const channel = new BroadcastChannel(channelName);
                        
                        channel.addEventListener('message', (event) => {
                            this.handleBroadcastMessage(event.data, channelName);
                        });
                        
                        channel.addEventListener('error', (error) => {
                            this.log(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ù†Ø§Ø© ${channelName}: ${error.message}`, 'error');
                        });
                        
                        this.channels.push({ name: channelName, channel });
                        
                    } catch (error) {
                        this.log(`ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ù†Ø§Ø© ${channelName}: ${error.message}`, 'error');
                    }
                });

                this.log(`ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ ${this.channels.length} Ù‚Ù†Ø§Ø© broadcast`, 'success');
            }

            setupStorageListener() {
                window.addEventListener('storage', (event) => {
                    if (this.storageKeys.includes(event.key)) {
                        this.log(`ØªØºÙŠÙŠØ± ÙÙŠ localStorage: ${event.key}`, 'info');
                        this.handleStorageChange(event);
                    }
                });

                // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª localStorage ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = (...args) => {
                    originalSetItem.apply(localStorage, args);
                    if (this.storageKeys.includes(args[0])) {
                        this.handleLocalStorageUpdate(args[0], args[1]);
                    }
                };
            }

            setupWindowListener() {
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type && event.data.type.startsWith('NAFIS_')) {
                        this.handleWindowMessage(event.data);
                    }
                });
            }

            startSyncLoop() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                this.syncInterval = setInterval(() => {
                    this.performSync();
                }, this.syncRate);

                this.log(`Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (ÙƒÙ„ ${this.syncRate / 1000} Ø«Ø§Ù†ÙŠØ©)`, 'info');
            }

            handleBroadcastMessage(data, channelName) {
                if (!data || !data.type) return;

                this.log(`Ø±Ø³Ø§Ù„Ø© Ù…Ù† ${channelName}: ${data.type}`, 'info');

                switch (data.type) {
                    case 'QUESTIONS_UPDATED':
                        this.handleQuestionsUpdate(data);
                        break;
                    case 'HEARTBEAT':
                        this.handleHeartbeat(data);
                        break;
                    case 'SYNC_REQUEST':
                        this.handleSyncRequest(data);
                        break;
                    case 'DATA_CORRUPTION_DETECTED':
                        this.handleDataCorruption(data);
                        break;
                    default:
                        this.log(`Ù†ÙˆØ¹ Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ${data.type}`, 'error');
                }
            }

            handleStorageChange(event) {
                this.log(`ØªØºÙŠÙŠØ± localStorage: ${event.key}`, 'info');
                this.loadDataFromStorage();
                this.updateUI();
                this.broadcastUpdate('STORAGE_CHANGED', {
                    key: event.key,
                    oldValue: event.oldValue,
                    newValue: event.newValue
                });
            }

            handleLocalStorageUpdate(key, value) {
                this.log(`ØªØ­Ø¯ÙŠØ« localStorage Ù…Ø­Ù„ÙŠ: ${key}`, 'info');
                setTimeout(() => {
                    this.loadDataFromStorage();
                    this.updateUI();
                }, 100);
            }

            handleWindowMessage(data) {
                this.log(`Ø±Ø³Ø§Ù„Ø© window: ${data.type}`, 'info');
                
                switch (data.type) {
                    case 'NAFIS_FORCE_SYNC':
                        this.forceSync();
                        break;
                    case 'NAFIS_UPDATE_ALL':
                        this.loadDataFromStorage();
                        this.updateUI();
                        break;
                }
            }

            handleQuestionsUpdate(data) {
                const { questionType, questions, source, timestamp } = data;
                
                this.log(`ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¦Ù„Ø© ${questionType} Ù…Ù† ${source}`, 'success');
                
                try {
                    if (questionType === 'daily') {
                        this.dailyQuestions = questions || [];
                        localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(this.dailyQuestions));
                    } else if (questionType === 'weekly') {
                        this.weeklyQuestions = questions || [];
                        localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(this.weeklyQuestions));
                    }
                    
                    localStorage.setItem('nafisLastUpdate', timestamp.toString());
                    localStorage.setItem(`nafisLast${questionType}Update`, timestamp.toString());
                    
                    this.updateUI();
                    this.broadcastUpdate('DATA_SYNCHRONIZED', {
                        questionType,
                        count: questions ? questions.length : 0,
                        timestamp
                    });
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${error.message}`, 'error');
                }
            }

            handleHeartbeat(data) {
                const { source, dailyCount, weeklyCount, timestamp } = data;
                this.log(`Ù†Ø¨Ø¶Ø© Ù…Ù† ${source}: ÙŠÙˆÙ…ÙŠ ${dailyCount}, Ø£Ø³Ø¨ÙˆØ¹ÙŠ ${weeklyCount}`, 'info');
            }

            handleSyncRequest(data) {
                this.log('Ø·Ù„Ø¨ Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ø±Ø¯', 'info');
                this.performSync();
            }

            handleDataCorruption(data) {
                this.log(`ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªÙ„Ù ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${data.details}`, 'error');
                this.repairData();
            }

            loadInitialData() {
                this.loadDataFromStorage();
                this.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©', 'success');
            }

            loadDataFromStorage() {
                try {
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                    const adminDaily = this.getFromStorage('adminDailyQuestions');
                    const mainDaily = this.getFromStorage('nafisMainDailyQuestions');
                    
                    if (adminDaily && adminDaily.length > 0) {
                        this.dailyQuestions = adminDaily;
                        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                        localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(adminDaily));
                    } else if (mainDaily && mainDaily.length > 0) {
                        this.dailyQuestions = mainDaily;
                    } else {
                        this.dailyQuestions = [];
                    }

                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                    const adminWeekly = this.getFromStorage('adminWeeklyQuestions');
                    const mainWeekly = this.getFromStorage('nafisMainWeeklyQuestions');
                    
                    if (adminWeekly && adminWeekly.length > 0) {
                        this.weeklyQuestions = adminWeekly;
                        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                        localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(adminWeekly));
                    } else if (mainWeekly && mainWeekly.length > 0) {
                        this.weeklyQuestions = mainWeekly;
                    } else {
                        this.weeklyQuestions = [];
                    }

                    this.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ÙŠÙˆÙ…ÙŠ ${this.dailyQuestions.length}, Ø£Ø³Ø¨ÙˆØ¹ÙŠ ${this.weeklyQuestions.length}`, 'success');

                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                    this.dailyQuestions = [];
                    this.weeklyQuestions = [];
                }
            }

            getFromStorage(key) {
                try {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const parsed = JSON.parse(data);
                        return Array.isArray(parsed) ? parsed.filter(item => item && typeof item === 'object') : [];
                    }
                    return [];
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ${key}: ${error.message}`, 'error');
                    return [];
                }
            }

            performSync() {
                try {
                    const oldDailyCount = this.dailyQuestions ? this.dailyQuestions.length : 0;
                    const oldWeeklyCount = this.weeklyQuestions ? this.weeklyQuestions.length : 0;

                    this.loadDataFromStorage();

                    const newDailyCount = this.dailyQuestions ? this.dailyQuestions.length : 0;
                    const newWeeklyCount = this.weeklyQuestions ? this.weeklyQuestions.length : 0;

                    if (newDailyCount !== oldDailyCount || newWeeklyCount !== oldWeeklyCount) {
                        this.log(`ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØºÙŠÙŠØ±: ÙŠÙˆÙ…ÙŠ ${oldDailyCount}â†’${newDailyCount}, Ø£Ø³Ø¨ÙˆØ¹ÙŠ ${oldWeeklyCount}â†’${newWeeklyCount}`, 'success');
                        this.updateUI();
                        
                        this.broadcastUpdate('AUTO_SYNC_COMPLETED', {
                            dailyCount: newDailyCount,
                            weeklyCount: newWeeklyCount,
                            timestamp: Date.now()
                        });
                    }

                    this.lastSync = Date.now();
                    document.getElementById('syncStatus').className = 'status-icon success';

                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: ${error.message}`, 'error');
                    document.getElementById('syncStatus').className = 'status-icon danger';
                }
            }

            forceSync() {
                this.log('Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ©...', 'info');
                
                try {
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    this.loadDataFromStorage();
                    
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
                    if (this.dailyQuestions.length > 0) {
                        localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(this.dailyQuestions));
                        localStorage.setItem('adminDailyQuestions', JSON.stringify(this.dailyQuestions));
                    }
                    
                    if (this.weeklyQuestions.length > 0) {
                        localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(this.weeklyQuestions));
                        localStorage.setItem('adminWeeklyQuestions', JSON.stringify(this.weeklyQuestions));
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·ÙˆØ§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠØ©
                    const timestamp = Date.now();
                    localStorage.setItem('nafisLastUpdate', timestamp.toString());
                    localStorage.setItem('nafisLastDailyUpdate', timestamp.toString());
                    localStorage.setItem('nafisLastWeeklyUpdate', timestamp.toString());
                    
                    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹
                    this.broadcastUpdate('FORCE_SYNC_COMPLETED', {
                        dailyCount: this.dailyQuestions.length,
                        weeklyCount: this.weeklyQuestions.length,
                        timestamp
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    this.updateUI();
                    
                    this.log('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù‚Ø³Ø±ÙŠØ©: ${error.message}`, 'error');
                }
            }

            broadcastUpdate(type, data) {
                const message = {
                    type,
                    ...data,
                    source: 'sync-system',
                    timestamp: Date.now()
                };

                // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª
                this.channels.forEach(({ name, channel }) => {
                    try {
                        channel.postMessage(message);
                    } catch (error) {
                        this.log(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± ${name}: ${error.message}`, 'error');
                    }
                });

                // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± window.postMessage Ø£ÙŠØ¶Ø§Ù‹
                try {
                    window.postMessage(message, '*');
                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ window message: ${error.message}`, 'error');
                }
            }

            updateUI() {
                try {
                    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const dailyCount = this.dailyQuestions ? this.dailyQuestions.length : 0;
                    const weeklyCount = this.weeklyQuestions ? this.weeklyQuestions.length : 0;
                    const totalCount = dailyCount + weeklyCount;

                    document.getElementById('dataStatusText').textContent = `ÙŠÙˆÙ…ÙŠ: ${dailyCount} | Ø£Ø³Ø¨ÙˆØ¹ÙŠ: ${weeklyCount}`;
                    document.getElementById('totalQuestions').textContent = totalCount;

                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
                    const teacherDaily = this.getFromStorage('adminDailyQuestions').length;
                    const teacherWeekly = this.getFromStorage('adminWeeklyQuestions').length;
                    const teacherTotal = teacherDaily + teacherWeekly;
                    
                    if (teacherTotal > 0) {
                        document.getElementById('teacherStatus').className = 'status-icon success';
                        document.getElementById('teacherStatusText').textContent = `${teacherTotal} Ø³Ø¤Ø§Ù„ Ù…ØªØ§Ø­`;
                    } else {
                        document.getElementById('teacherStatus').className = 'status-icon warning';
                        document.getElementById('teacherStatusText').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©';
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                    const studentDaily = this.getFromStorage('nafisMainDailyQuestions').length;
                    const studentWeekly = this.getFromStorage('nafisMainWeeklyQuestions').length;
                    const studentTotal = studentDaily + studentWeekly;
                    
                    if (studentTotal > 0) {
                        document.getElementById('studentStatus').className = 'status-icon success';
                        document.getElementById('studentStatusText').textContent = `${studentTotal} Ø³Ø¤Ø§Ù„ Ù…ØªØ²Ø§Ù…Ù†`;
                    } else {
                        document.getElementById('studentStatus').className = 'status-icon danger';
                        document.getElementById('studentStatusText').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ²Ø§Ù…Ù†Ø©';
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†
                    const isInSync = (teacherDaily === studentDaily && teacherWeekly === studentWeekly);
                    if (isInSync && studentTotal > 0) {
                        document.getElementById('syncStatus').className = 'status-icon success';
                        document.getElementById('syncStatusText').textContent = 'Ù…ØªØ²Ø§Ù…Ù† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
                    } else if (studentTotal === 0) {
                        document.getElementById('syncStatus').className = 'status-icon warning';
                        document.getElementById('syncStatusText').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©';
                    } else {
                        document.getElementById('syncStatus').className = 'status-icon danger';
                        document.getElementById('syncStatusText').textContent = 'ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†';
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ‚Ø§Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
                    const teacherUpdate = localStorage.getItem('nafisLastUpdate');
                    const studentUpdate = localStorage.getItem('nafisLastUpdate');
                    
                    document.getElementById('teacherLastUpdate').textContent = 
                        teacherUpdate ? new Date(parseInt(teacherUpdate)).toLocaleString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    document.getElementById('studentLastUpdate').textContent = 
                        studentUpdate ? new Date(parseInt(studentUpdate)).toLocaleString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø§Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    this.updateDataViewer();

                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: ${error.message}`, 'error');
                }
            }

            updateDataViewer() {
                try {
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                    const dailyContainer = document.getElementById('dailyQuestions');
                    if (this.dailyQuestions && this.dailyQuestions.length > 0) {
                        dailyContainer.innerHTML = this.dailyQuestions.map((q, index) => `
                            <div class="question-card">
                                <div class="question-meta">
                                    <span class="badge subject">${q.subject || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                    <span class="badge type">ÙŠÙˆÙ…ÙŠ</span>
                                </div>
                                <strong>Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}:</strong> ${q.question || 'Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                                <br><small>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${q.createdAt || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
                            </div>
                        `).join('');
                    } else {
                        dailyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙŠÙˆÙ…ÙŠØ©</p>';
                    }

                    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                    const weeklyContainer = document.getElementById('weeklyQuestions');
                    if (this.weeklyQuestions && this.weeklyQuestions.length > 0) {
                        weeklyContainer.innerHTML = this.weeklyQuestions.map((q, index) => `
                            <div class="question-card">
                                <div class="question-meta">
                                    <span class="badge subject">${q.subject || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                                    <span class="badge type">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</span>
                                </div>
                                <strong>Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}:</strong> ${q.question || 'Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±'}
                                <br><small>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${q.createdAt || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
                            </div>
                        `).join('');
                    } else {
                        weeklyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</p>';
                    }

                    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ†
                    const storageContainer = document.getElementById('storageDetails');
                    const storageInfo = this.storageKeys.map(key => {
                        const data = localStorage.getItem(key);
                        let info = `<strong>${key}:</strong> `;
                        
                        if (data) {
                            if (key.includes('Last') || key.includes('Update')) {
                                const timestamp = parseInt(data);
                                info += isNaN(timestamp) ? 'Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©' : new Date(timestamp).toLocaleString('ar-SA');
                            } else {
                                try {
                                    const parsed = JSON.parse(data);
                                    info += Array.isArray(parsed) ? `${parsed.length} Ø¹Ù†ØµØ±` : 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                                } catch {
                                    info += 'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ù„ÙØ©';
                                }
                            }
                        } else {
                            info += 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                        }
                        
                        return `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px;">${info}</div>`;
                    }).join('');
                    
                    storageContainer.innerHTML = storageInfo;

                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¹Ø§Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                }
            }

            checkDataIntegrity() {
                this.log('Ø¨Ø¯Ø¡ ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
                
                let issues = [];

                try {
                    // ÙØ­Øµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                    const adminDaily = this.getFromStorage('adminDailyQuestions');
                    const mainDaily = this.getFromStorage('nafisMainDailyQuestions');
                    
                    if (adminDaily.length !== mainDaily.length) {
                        issues.push(`Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: Ù…Ø¹Ù„Ù… ${adminDaily.length}, Ø±Ø¦ÙŠØ³ÙŠ ${mainDaily.length}`);
                    }

                    // ÙØ­Øµ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                    const adminWeekly = this.getFromStorage('adminWeeklyQuestions');
                    const mainWeekly = this.getFromStorage('nafisMainWeeklyQuestions');
                    
                    if (adminWeekly.length !== mainWeekly.length) {
                        issues.push(`Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: Ù…Ø¹Ù„Ù… ${adminWeekly.length}, Ø±Ø¦ÙŠØ³ÙŠ ${mainWeekly.length}`);
                    }

                    // ÙØ­Øµ ØµØ­Ø© Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    [...adminDaily, ...adminWeekly, ...mainDaily, ...mainWeekly].forEach((question, index) => {
                        if (!question || typeof question !== 'object') {
                            issues.push(`Ø³Ø¤Ø§Ù„ ØªØ§Ù„Ù ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ ${index}`);
                        } else {
                            if (!question.id) issues.push(`Ø³Ø¤Ø§Ù„ Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ ${index}`);
                            if (!question.question) issues.push(`Ø³Ø¤Ø§Ù„ Ø¨Ø¯ÙˆÙ† Ù†Øµ ÙÙŠ Ø§Ù„ÙÙ‡Ø±Ø³ ${index}`);
                            if (!question.options || !Array.isArray(question.options)) {
                                issues.push(`Ø®ÙŠØ§Ø±Ø§Øª ØªØ§Ù„ÙØ© ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${index}`);
                            }
                            if (typeof question.correct !== 'number') {
                                issues.push(`Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${index}`);
                            }
                        }
                    });

                    // ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    if (issues.length === 0) {
                        this.log('ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ù„ÙŠÙ…Ø©', 'success');
                    } else {
                        this.log(`ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${issues.length} Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`, 'error');
                        issues.forEach(issue => this.log(`- ${issue}`, 'error'));
                        
                        if (confirm('ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ØŸ')) {
                            this.repairData();
                        }
                    }

                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                }
            }

            repairData() {
                this.log('Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
                
                try {
                    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                    let adminDaily = this.getFromStorage('adminDailyQuestions');
                    let mainDaily = this.getFromStorage('nafisMainWeeklyQuestions');
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø­Ø¯Ø§Ø«Ø©
                    const validDaily = adminDaily.length > mainDaily.length ? adminDaily : mainDaily;
                    const cleanDaily = validDaily.filter(q => q && typeof q === 'object' && q.id && q.question);
                    
                    localStorage.setItem('adminDailyQuestions', JSON.stringify(cleanDaily));
                    localStorage.setItem('nafisMainDailyQuestions', JSON.stringify(cleanDaily));

                    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                    let adminWeekly = this.getFromStorage('adminWeeklyQuestions');
                    let mainWeekly = this.getFromStorage('nafisMainWeeklyQuestions');
                    
                    const validWeekly = adminWeekly.length > mainWeekly.length ? adminWeekly : mainWeekly;
                    const cleanWeekly = validWeekly.filter(q => q && typeof q === 'object' && q.id && q.question);
                    
                    localStorage.setItem('adminWeeklyQuestions', JSON.stringify(cleanWeekly));
                    localStorage.setItem('nafisMainWeeklyQuestions', JSON.stringify(cleanWeekly));

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·ÙˆØ§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠØ©
                    const timestamp = Date.now();
                    localStorage.setItem('nafisLastUpdate', timestamp.toString());
                    localStorage.setItem('nafisLastDailyUpdate', timestamp.toString());
                    localStorage.setItem('nafisLastWeeklyUpdate', timestamp.toString());

                    this.loadDataFromStorage();
                    this.updateUI();

                    this.log(`ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ÙŠÙˆÙ…ÙŠ ${cleanDaily.length}, Ø£Ø³Ø¨ÙˆØ¹ÙŠ ${cleanWeekly.length}`, 'success');

                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                }
            }

            clearAllData() {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                    return;
                }

                this.log('Ø¨Ø¯Ø¡ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');

                try {
                    this.storageKeys.forEach(key => {
                        localStorage.removeItem(key);
                    });

                    // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    this.dailyQuestions = [];
                    this.weeklyQuestions = [];

                    // Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
                    this.broadcastUpdate('ALL_DATA_CLEARED', {
                        timestamp: Date.now()
                    });

                    this.updateUI();
                    this.log('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');

                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                }
            }

            exportDiagnostics() {
                this.log('ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ...', 'info');

                try {
                    const diagnostics = {
                        timestamp: new Date().toISOString(),
                        systemInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            cookieEnabled: navigator.cookieEnabled,
                            onLine: navigator.onLine
                        },
                        storageData: {},
                        dataIntegrity: {
                            dailyQuestions: this.dailyQuestions ? this.dailyQuestions.length : 0,
                            weeklyQuestions: this.weeklyQuestions ? this.weeklyQuestions.length : 0,
                            hasCorruption: false
                        },
                        syncStatus: {
                            isInitialized: this.isInitialized,
                            lastSync: this.lastSync,
                            syncRate: this.syncRate,
                            channelsCount: this.channels.length
                        },
                        logs: Array.from(this.logContainer.children).map(entry => ({
                            type: entry.className.split(' ')[1],
                            content: entry.textContent
                        }))
                    };

                    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
                    this.storageKeys.forEach(key => {
                        const data = localStorage.getItem(key);
                        diagnostics.storageData[key] = {
                            exists: !!data,
                            size: data ? data.length : 0,
                            type: key.includes('Last') ? 'timestamp' : 'array'
                        };
                    });

                    // ØªØµØ¯ÙŠØ± ÙƒÙ…Ù„Ù JSON
                    const blob = new Blob([JSON.stringify(diagnostics, null, 2)], { 
                        type: 'application/json' 
                    });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `nafis-diagnostics-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.log('ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¨Ù†Ø¬Ø§Ø­', 'success');

                } catch (error) {
                    this.log(`Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ: ${error.message}`, 'error');
                }
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.innerHTML = `
                    <strong>[${timestamp}]</strong> ${message}
                `;

                this.logContainer.insertBefore(logEntry, this.logContainer.firstChild);

                // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 100 Ø¥Ø¯Ø®Ø§Ù„ ÙÙ‚Ø·
                while (this.logContainer.children.length > 100) {
                    this.logContainer.removeChild(this.logContainer.lastChild);
                }

                // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø£ÙŠØ¶Ø§Ù‹
                console.log(`[Nafis Sync] ${message}`);
            }

            destroy() {
                this.log('Ø¥ÙŠÙ‚Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†...', 'info');
                
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                this.channels.forEach(({ channel }) => {
                    try {
                        channel.close();
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ù†Ø§Ø©:', error);
                    }
                });

                this.isInitialized = false;
                this.log('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†', 'info');
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø«ÙŠÙ„ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†
        let syncSystem = null;

        // Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø§Ù…Ø©
        function forceSync() {
            if (syncSystem) {
                syncSystem.forceSync();
            }
        }

        function checkDataIntegrity() {
            if (syncSystem) {
                syncSystem.checkDataIntegrity();
            }
        }

        function clearAllData() {
            if (syncSystem) {
                syncSystem.clearAllData();
            }
        }

        function exportDiagnostics() {
            if (syncSystem) {
                syncSystem.exportDiagnostics();
            }
        }

        function showTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            try {
                syncSystem = new NafisProfessionalSyncSystem();
                console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù†Ø§Ù‚Ø³');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†:', error);
            }
        });

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.addEventListener('beforeunload', function() {
            if (syncSystem) {
                syncSystem.destroy();
            }
        });

        // Ø¥ØªØ§Ø­Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
        window.nafisSyncSystem = syncSystem;
    </script>
</body>
</html>
