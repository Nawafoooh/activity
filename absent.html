<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الغياب - متوسطة المنذر بن عمرو الأنصاري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .modal-backdrop { backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex items-center justify-center h-screen">
            <div class="text-center">
                <div class="text-6xl mb-4">⏳</div>
                <p class="text-xl text-gray-600">جاري التحميل...</p>
            </div>
        </div>
    </div>

    <script>
        const teachersList = ['عبدالله بن مطر بن مصلح العمري','محمد بن عماري راضي الزهراني','موفق مرزوق سويرح السحيمي','فواز زايد لافي المهيمزي الرشيدي','فيصل عطالله حويمد الصاعدي','ابراهيم عياد عيد العلوي','عبدالله حمود حامد الحربي','ساير فيصل سعد الله العضيله المطيري','نافع شعوي نافع المطيري','اسامه منور مشعل العوفي','محمد عياد عليثه العوفي','أحمد إبراهيم فخري التركي','أحمد حامد هلال الحربي','نميان علي نميان الحربي','عبدالله صلاح صالح الرحيلى','مشعل بن هليل بن غالب العمري الحربي','علي متعب ناصر العلوي الحربي','سيف عبدالمنعم حمدان العارضي','محمد بن ذعار بن صالح العوفي','فؤاد بن محمد بن حماد العتيبي','حمزة صدقة حمزة اسلام','سلمان صالح أحمد الحارثي','عبيد بن دخيل بن دويهيس العياضي الحربي','عبدالعزيز مفلح نويعم الرويثي','فيصل عواد محمد أبو سلمي','عبدالله بن محمد بن سعيد ال بحران القرني','كاتب مفلح سليمان الرشيدى','حبيب علي نعيس العمري الحربي','ابراهيم عايض عوض الجابري','سلطان عويض معيض السحيمي','عبدالهادي معيض معلا الشاماني','عبدالعزيز عبدالرحمن غلاب المخلفي','سعد طالع حمود الحربي','ناهر مشعل عويد المطيري','موسى غازي سفر الحربي','موسى مسعود عايض الحيسوني','نواف منصور عواد الصبحي','بدر عبدالعزيز شائد السحيمي','فهد عويض عوض الشاماني الحربي','عبدالمجيد عايد خضران الرشيدي','أحمد مطر سليمان الرشيدي'];

        const classCapacities = {
            'أول متوسط': {'1': 30, '2': 31, '3': 31, '4': 30, '5': 30, '6': 30},
            'ثاني متوسط': {'1': 29, '2': 27, '3': 27, '4': 26, '5': 27, '6': 26},
            'ثالث متوسط': {'1': 3, '2': 29, '3': 30, '4': 30, '5': 30, '6': 30}
        };

        const config = {
            schoolInfo: {name: 'متوسطة المنذر بن عمرو الأنصاري', principal: 'خالد المطيري', assistant: 'محمد الجابري', counselor: 'محمد القحطاني', type: 'بنين'},
            grades: ['أول متوسط', 'ثاني متوسط', 'ثالث متوسط'],
            sections: ['1', '2', '3', '4', '5', '6'],
            periods: ['1', '2', '3', '4', '5', '6', '7']
        };

        let state = {
            currentUser: {name: teachersList[0]},
            attendance: [],
            filters: {filterGrade: '', filterSection: '', filterPeriod: '', dateFrom: '', dateTo: ''},
            modals: {showAttendanceModal: false, showEditModal: false, editingAttendance: null},
            newAttendance: {grade: '', section: '', period: '1', date: new Date().toISOString().split('T')[0], absentStudents: []}
        };

        function getFirstPeriodAttendance(grade, section, date) {
            return state.attendance.find(a => a.grade === grade && a.section === section && a.date === date && a.period === '1');
        }

        function isAttendanceRecorded(grade, section, period, date) {
            return state.attendance.some(a => a.grade === grade && a.section === section && a.period === period && a.date === date);
        }

        function getFilteredAttendance() {
            let filtered = state.attendance.slice();
            if (state.filters.filterGrade) filtered = filtered.filter(a => a.grade === state.filters.filterGrade);
            if (state.filters.filterSection) filtered = filtered.filter(a => a.section === state.filters.filterSection);
            if (state.filters.filterPeriod) filtered = filtered.filter(a => a.period === state.filters.filterPeriod);
            if (state.filters.dateFrom) filtered = filtered.filter(a => a.date >= state.filters.dateFrom);
            if (state.filters.dateTo) filtered = filtered.filter(a => a.date <= state.filters.dateTo);
            return filtered;
        }

        function getStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = state.attendance.filter(a => a.date === today);
            return {
                totalRecords: state.attendance.length,
                todayRecords: todayAttendance.length,
                totalAbsent: todayAttendance.reduce((sum, a) => sum + a.absentCount, 0),
                classesRecorded: new Set(state.attendance.map(a => a.grade + '-' + a.section)).size
            };
        }

        function setFilter(key, value) {
            state.filters[key] = value;
            render();
        }

        function clearFilters() {
            state.filters = {filterGrade: '', filterSection: '', filterPeriod: '', dateFrom: '', dateTo: ''};
            render();
        }

        function openAttendanceModal() {
            state.modals.showAttendanceModal = true;
            state.newAttendance = {grade: '', section: '', period: '1', date: new Date().toISOString().split('T')[0], absentStudents: []};
            render();
        }

        function closeAttendanceModal() {
            state.modals.showAttendanceModal = false;
            render();
        }

        function addAbsentStudent() {
            const input = document.getElementById('newStudentNameInput');
            const studentName = input ? input.value.trim() : '';
            if (studentName) {
                state.newAttendance.absentStudents.push(studentName);
                input.value = '';
                render();
            }
        }

        function removeAbsentStudent(index) {
            state.newAttendance.absentStudents.splice(index, 1);
            render();
        }

        function saveAttendance() {
            const {grade, section, period, date, absentStudents} = state.newAttendance;
            
            if (!grade || !section) {
                alert('⚠️ يرجى اختيار الصف والشعبة');
                return;
            }

            if (period === '1') {
                if (isAttendanceRecorded(grade, section, period, date)) {
                    if (!confirm('⚠️ تم تسجيل الغياب للحصة الأولى مسبقاً. هل تريد التعديل؟')) return;
                    state.attendance = state.attendance.filter(a => !(a.grade === grade && a.section === section && a.period === period && a.date === date));
                }

                state.attendance.push({
                    id: Math.max(0, ...state.attendance.map(a => a.id || 0)) + 1,
                    grade, section, period, date,
                    absentCount: absentStudents.length,
                    absentStudents: absentStudents.slice(),
                    totalStudents: classCapacities[grade][section],
                    teacherName: state.currentUser.name,
                    recordedAt: new Date().toISOString(),
                    isFirstPeriod: true
                });

                alert('✅ تم تسجيل الغياب للحصة الأولى بنجاح!');
                closeAttendanceModal();
            } else {
                const firstPeriod = getFirstPeriodAttendance(grade, section, date);
                if (!firstPeriod) {
                    alert('⚠️ يجب تسجيل الغياب للحصة الأولى أولاً!');
                    return;
                }

                if (isAttendanceRecorded(grade, section, period, date)) {
                    if (!confirm('⚠️ تم تسجيل الغياب لهذه الحصة مسبقاً. هل تريد التعديل؟')) return;
                    state.attendance = state.attendance.filter(a => !(a.grade === grade && a.section === section && a.period === period && a.date === date));
                }

                const allStudents = Array.from(new Set([...firstPeriod.absentStudents, ...absentStudents]));
                const additionalAbsent = allStudents.length - firstPeriod.absentStudents.length;

                state.attendance.push({
                    id: Math.max(0, ...state.attendance.map(a => a.id || 0)) + 1,
                    grade, section, period, date,
                    absentCount: allStudents.length,
                    absentStudents: allStudents,
                    totalStudents: classCapacities[grade][section],
                    teacherName: state.currentUser.name,
                    recordedAt: new Date().toISOString(),
                    isFirstPeriod: false,
                    copiedFromFirstPeriod: firstPeriod.absentStudents.length,
                    additionalAbsent
                });

                alert('✅ تم تسجيل الغياب للحصة ' + period + ' بنجاح!' + (additionalAbsent > 0 ? '\n\nمنسوخ من الحصة الأولى: ' + firstPeriod.absentStudents.length + '\nإضافات جديدة: ' + additionalAbsent : ''));
                closeAttendanceModal();
            }
        }

        function openEditModalSafe(attendanceId) {
            const attendance = state.attendance.find(a => a.id === attendanceId);
            if (attendance) {
                state.modals.showEditModal = true;
                state.modals.editingAttendance = JSON.parse(JSON.stringify(attendance));
                if (!state.modals.editingAttendance.absentStudents) {
                    state.modals.editingAttendance.absentStudents = [];
                }
                render();
            }
        }

        function closeEditModal() {
            state.modals.showEditModal = false;
            state.modals.editingAttendance = null;
            render();
        }

        function updateStudentName(index, newName) {
            if (newName.trim() && state.modals.editingAttendance) {
                state.modals.editingAttendance.absentStudents[index] = newName.trim();
            }
        }

        function addStudentToEdit() {
            const input = document.getElementById('editStudentNameInput');
            const studentName = input ? input.value.trim() : '';
            if (studentName && state.modals.editingAttendance) {
                state.modals.editingAttendance.absentStudents.push(studentName);
                state.modals.editingAttendance.absentCount = state.modals.editingAttendance.absentStudents.length;
                input.value = '';
                render();
            }
        }

        function removeStudentFromEdit(index) {
            if (state.modals.editingAttendance) {
                state.modals.editingAttendance.absentStudents.splice(index, 1);
                state.modals.editingAttendance.absentCount = state.modals.editingAttendance.absentStudents.length;
                render();
            }
        }

        function saveEditedAttendance() {
            const index = state.attendance.findIndex(att => att.id === state.modals.editingAttendance.id);
            if (index !== -1) {
                state.attendance[index] = state.modals.editingAttendance;
                alert('✅ تم تحديث السجل بنجاح!');
                closeEditModal();
            }
        }

        function exportToCSV() {
            const filtered = getFilteredAttendance();
            const rows = [['#', 'الصف', 'الشعبة', 'الحصة', 'التاريخ', 'عدد الغياب', 'إجمالي الطلاب', 'نسبة الحضور', 'المعلم']];
            filtered.forEach((a, i) => {
                const attendanceRate = ((a.totalStudents - a.absentCount) / a.totalStudents * 100).toFixed(1);
                rows.push([i + 1, a.grade, a.section, 'الحصة ' + a.period, a.date, a.absentCount, a.totalStudents, attendanceRate + '%', a.teacherName]);
            });
            const csvContent = rows.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'سجل_الغياب_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function render() {
            try {
                const stats = getStats();
                const filtered = getFilteredAttendance();
                document.getElementById('app').innerHTML = buildHTML(stats, filtered);
            } catch(e) {
                document.getElementById('app').innerHTML = '<div class="p-8 text-center"><h1 class="text-2xl text-red-600">خطأ في التحميل</h1><p class="text-gray-600 mt-2">' + e.message + '</p></div>';
                console.error(e);
            }
        }

        function buildHTML(stats, filtered) {
            let html = '';
            
            html += '<div class="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 text-white shadow-2xl">';
            html += '<div class="max-w-7xl mx-auto px-6 py-8">';
            html += '<div class="flex items-center justify-between mb-6">';
            html += '<div><h1 class="text-4xl font-bold mb-2">📋 ' + config.schoolInfo.name + '</h1>';
            html += '<p class="text-blue-100 text-lg">نظام تسجيل الغياب - ' + config.schoolInfo.type + '</p></div>';
            html += '<div class="text-left bg-blue-800 bg-opacity-50 rounded-lg p-4 backdrop-blur-sm">';
            html += '<p class="text-sm text-blue-100 mb-1">👤 مدير المدرسة: ' + config.schoolInfo.principal + '</p>';
            html += '<p class="text-sm text-blue-100 mb-1">👤 الوكيل: ' + config.schoolInfo.assistant + '</p>';
            html += '<p class="text-sm text-blue-100">👤 الموجه الطلابي: ' + config.schoolInfo.counselor + '</p>';
            html += '</div></div></div></div>';

            html += '<div class="bg-white border-b shadow-sm sticky top-0 z-40">';
            html += '<div class="max-w-7xl mx-auto px-6 py-4">';
            html += '<div class="flex items-center justify-between flex-wrap gap-4">';
            html += '<div class="flex items-center gap-4">';
            html += '<select onchange="state.currentUser.name = this.value; render();" class="px-4 py-3 border-2 border-blue-600 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium text-blue-900 bg-blue-50">';
            teachersList.forEach(teacher => {
                html += '<option value="' + teacher + '" ' + (state.currentUser.name === teacher ? 'selected' : '') + '>👨‍🏫 ' + teacher + '</option>';
            });
            html += '</select>';
            html += '<a href="https://nawafoooh.github.io/activity/shahid.html" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium">← الرجوع للصفحة الرئيسية</a>';
            html += '</div>';
            html += '<div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">';
            html += '<p class="text-sm text-blue-900"><span class="font-bold">المعلم:</span> ' + state.currentUser.name + '</p>';
            html += '</div></div></div></div>';

            html += '<div class="max-w-7xl mx-auto px-6 py-6">';
            
            html += '<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">';
            html += '<div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-blue-500">';
            html += '<div class="flex items-center justify-between mb-3"><span class="text-4xl">📝</span><div class="text-3xl font-bold text-blue-600">' + stats.totalRecords + '</div></div>';
            html += '<div class="text-gray-600 font-medium">إجمالي السجلات</div></div>';
            
            html += '<div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-green-500">';
            html += '<div class="flex items-center justify-between mb-3"><span class="text-4xl">📅</span><div class="text-3xl font-bold text-green-600">' + stats.todayRecords + '</div></div>';
            html += '<div class="text-gray-600 font-medium">سجلات اليوم</div></div>';
            
            html += '<div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-red-500">';
            html += '<div class="flex items-center justify-between mb-3"><span class="text-4xl">👥</span><div class="text-3xl font-bold text-red-600">' + stats.totalAbsent + '</div></div>';
            html += '<div class="text-gray-600 font-medium">إجمالي الغياب اليوم</div></div>';
            
            html += '<div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-t-4 border-purple-500">';
            html += '<div class="flex items-center justify-between mb-3"><span class="text-4xl">🏫</span><div class="text-3xl font-bold text-purple-600">' + stats.classesRecorded + '</div></div>';
            html += '<div class="text-gray-600 font-medium">الفصول المسجلة</div></div>';
            html += '</div>';

            html += buildAttendanceSection(filtered);
            html += '</div>';

            if (state.modals.showAttendanceModal) html += buildAttendanceModal();
            if (state.modals.showEditModal) html += buildEditModal();

            return html;
        }

        function buildAttendanceSection(filtered) {
            let html = '<div class="bg-white rounded-xl shadow-lg mb-6">';
            html += '<div class="border-b px-6 py-4">';
            html += '<div class="flex items-center justify-between flex-wrap gap-4">';
            html += '<h2 class="text-2xl font-bold text-gray-900">📋 سجل الغياب</h2>';
            html += '<div class="flex gap-3">';
            if (state.attendance.length > 0) {
                html += '<button onclick="exportToCSV()" class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-md">📥 تصدير Excel</button>';
            }
            html += '<button onclick="openAttendanceModal()" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">➕ تسجيل غياب جديد</button>';
            html += '</div></div></div>';

            html += buildFilters();
            html += buildAttendanceTable(filtered);
            html += '</div>';

            return html;
        }

        function buildFilters() {
            const hasFilters = state.filters.filterGrade || state.filters.filterSection || state.filters.filterPeriod || state.filters.dateFrom || state.filters.dateTo;
            
            let html = '<div class="p-6 bg-gray-50 border-b">';
            html += '<div class="grid grid-cols-1 md:grid-cols-5 gap-4">';
            
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">📊 الصف</label>';
            html += '<select onchange="setFilter(\'filterGrade\', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">';
            html += '<option value="">الكل</option>';
            config.grades.forEach(g => {
                html += '<option value="' + g + '" ' + (state.filters.filterGrade === g ? 'selected' : '') + '>' + g + '</option>';
            });
            html += '</select></div>';
            
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">الشعبة</label>';
            html += '<select onchange="setFilter(\'filterSection\', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">';
            html += '<option value="">الكل</option>';
            config.sections.forEach(s => {
                html += '<option value="' + s + '" ' + (state.filters.filterSection === s ? 'selected' : '') + '>' + s + '</option>';
            });
            html += '</select></div>';
            
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">الحصة</label>';
            html += '<select onchange="setFilter(\'filterPeriod\', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">';
            html += '<option value="">الكل</option>';
            config.periods.forEach(p => {
                html += '<option value="' + p + '" ' + (state.filters.filterPeriod === p ? 'selected' : '') + '>الحصة ' + p + '</option>';
            });
            html += '</select></div>';
            
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">من تاريخ</label>';
            html += '<input type="date" value="' + state.filters.dateFrom + '" onchange="setFilter(\'dateFrom\', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>';
            
            html += '<div><label class="block text-sm font-medium text-gray-700 mb-2">إلى تاريخ</label>';
            html += '<input type="date" value="' + state.filters.dateTo + '" onchange="setFilter(\'dateTo\', this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></div>';
            
            html += '</div>';
            
            if (hasFilters) {
                html += '<button onclick="clearFilters()" class="mt-4 text-sm text-blue-600 hover:text-blue-800 font-medium">مسح جميع الفلاتر</button>';
            }
            
            html += '</div>';
            return html;
        }

        function buildAttendanceTable(filtered) {
            if (filtered.length === 0) {
                return '<div class="p-16 text-center"><div class="text-6xl mb-4">📋</div><p class="text-xl text-gray-500 mb-2">لم يتم تسجيل أي غياب بعد</p><p class="text-sm text-gray-400">ابدأ بتسجيل الغياب للحصة الأولى</p></div>';
            }
            
            let html = '<div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">#</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">الصف</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">الشعبة</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">الحصة</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">التاريخ</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">عدد الغياب</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">أسماء الطلاب</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">إجمالي</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">الحضور</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">المعلم</th>';
            html += '<th class="px-4 py-3 text-right text-sm font-bold text-gray-700">إجراءات</th>';
            html += '</tr></thead><tbody class="divide-y">';
            
            filtered.forEach((a, index) => {
                const attendanceRate = ((a.totalStudents - a.absentCount) / a.totalStudents * 100).toFixed(1);
                const isAdditional = a.additionalAbsent && a.additionalAbsent > 0;
                
                let studentsNames = '<span class="text-gray-400 text-sm">لا توجد أسماء</span>';
                if (a.absentStudents && a.absentStudents.length > 0) {
                    if (a.absentStudents.length <= 3) {
                        studentsNames = '<div class="text-sm">';
                        a.absentStudents.forEach((s, i) => {
                            studentsNames += (i + 1) + '. ' + s + '<br>';
                        });
                        studentsNames += '</div>';
                    } else {
                        studentsNames = '<div class="text-sm">';
                        for (let i = 0; i < 3; i++) {
                            studentsNames += (i + 1) + '. ' + a.absentStudents[i] + '<br>';
                        }
                        studentsNames += '<div class="text-blue-600 font-bold mt-1">... و ' + (a.absentStudents.length - 3) + ' طالب آخر</div></div>';
                    }
                }
                
                html += '<tr class="hover:bg-gray-50 ' + (isAdditional ? 'bg-red-50' : '') + '">';
                html += '<td class="px-4 py-3 text-sm">' + (index + 1) + '</td>';
                html += '<td class="px-4 py-3 text-sm font-medium">' + a.grade + '</td>';
                html += '<td class="px-4 py-3 text-sm">' + a.section + '</td>';
                html += '<td class="px-4 py-3 text-sm">';
                html += '<span class="px-3 py-1 rounded-full text-xs font-bold ' + (a.period === '1' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800') + '">الحصة ' + a.period + '</span>';
                if (isAdditional) {
                    html += '<span class="mr-2 px-2 py-1 rounded-full text-xs font-bold bg-red-600 text-white">+' + a.additionalAbsent + ' جديد</span>';
                }
                html += '</td>';
                html += '<td class="px-4 py-3 text-sm">' + a.date + '</td>';
                html += '<td class="px-4 py-3 text-sm font-bold ' + (a.absentCount > 0 ? 'text-red-600' : 'text-green-600') + '">' + a.absentCount + '</td>';
                html += '<td class="px-4 py-3 text-sm max-w-xs"><div class="bg-yellow-50 border border-yellow-200 rounded p-2">' + studentsNames + '</div></td>';
                html += '<td class="px-4 py-3 text-sm">' + a.totalStudents + '</td>';
                html += '<td class="px-4 py-3 text-sm"><span class="px-3 py-1 rounded-full text-xs font-bold ' + (attendanceRate >= 90 ? 'bg-green-100 text-green-800' : attendanceRate >= 75 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800') + '">' + attendanceRate + '%</span></td>';
                html += '<td class="px-4 py-3 text-sm">' + a.teacherName + '</td>';
                html += '<td class="px-4 py-3 text-sm"><button onclick="openEditModalSafe(' + a.id + ')" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-medium">✏️ عرض</button></td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            html += '<div class="p-4 bg-gray-50 border-t text-center text-sm text-gray-600">عرض ' + filtered.length + ' سجل</div>';
            
            return html;
        }

        function buildAttendanceModal() {
            const {grade, section, period, date, absentStudents} = state.newAttendance;
            const totalStudents = grade && section ? classCapacities[grade][section] : 0;
            const firstPeriod = period !== '1' && grade && section ? getFirstPeriodAttendance(grade, section, date) : null;
            
            let html = '<div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeAttendanceModal()">';
            html += '<div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">';
            html += '<div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-xl">';
            html += '<h2 class="text-2xl font-bold">📋 تسجيل الغياب</h2>';
            html += '<p class="text-blue-100 text-sm mt-1">يرجى ملء البيانات المطلوبة</p></div>';
            
            html += '<div class="p-6 space-y-5">';
            html += '<div class="grid grid-cols-2 gap-4">';
            html += '<div><label class="block text-sm font-bold text-gray-700 mb-2">الصف <span class="text-red-500">*</span></label>';
            html += '<select onchange="state.newAttendance.grade=this.value;render()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">';
            html += '<option value="">اختر الصف</option>';
            config.grades.forEach(g => {
                html += '<option value="' + g + '" ' + (grade === g ? 'selected' : '') + '>' + g + '</option>';
            });
            html += '</select></div>';
            
            html += '<div><label class="block text-sm font-bold text-gray-700 mb-2">الشعبة <span class="text-red-500">*</span></label>';
            html += '<select onchange="state.newAttendance.section=this.value;render()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">';
            html += '<option value="">اختر الشعبة</option>';
            config.sections.forEach(s => {
                html += '<option value="' + s + '" ' + (section === s ? 'selected' : '') + '>' + s + '</option>';
            });
            html += '</select></div></div>';
            
            if (grade && section) {
                html += '<div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">';
                html += '<p class="text-sm font-bold text-blue-900">📊 إجمالي عدد الطلاب: <span class="text-lg">' + totalStudents + ' طالب</span></p></div>';
            }
            
            html += '<div class="grid grid-cols-2 gap-4">';
            html += '<div><label class="block text-sm font-bold text-gray-700 mb-2">الحصة</label>';
            html += '<select onchange="state.newAttendance.period=this.value;render()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg">';
            config.periods.forEach(p => {
                html += '<option value="' + p + '" ' + (period === p ? 'selected' : '') + '>الحصة ' + p + '</option>';
            });
            html += '</select></div>';
            
            html += '<div><label class="block text-sm font-bold text-gray-700 mb-2">التاريخ</label>';
            html += '<input type="date" value="' + date + '" onchange="state.newAttendance.date=this.value;render()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"></div></div>';
            
            if (period !== '1' && firstPeriod) {
                html += '<div class="bg-green-50 border-2 border-green-300 rounded-lg p-4">';
                html += '<p class="text-sm font-bold text-green-900 mb-2">✅ تم تسجيل الحصة الأولى</p>';
                html += '<p class="text-sm text-green-800">عدد الغياب: ' + firstPeriod.absentCount + '</p></div>';
            } else if (period !== '1' && grade && section) {
                html += '<div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">';
                html += '<p class="text-sm font-bold text-red-900">⚠️ يجب تسجيل الحصة الأولى أولاً!</p></div>';
            }
            
            if (period === '1' || (period !== '1' && firstPeriod)) {
                html += '<div><label class="block text-sm font-bold text-gray-700 mb-2">أسماء الطلاب الغائبين</label>';
                html += '<div class="space-y-2 mb-3">';
                
                if (absentStudents.length > 0) {
                    absentStudents.forEach((student, i) => {
                        html += '<div class="flex items-center gap-2 bg-gray-50 p-2 rounded">';
                        html += '<span class="flex-1">' + (i + 1) + '. ' + student + '</span>';
                        html += '<button onclick="removeAbsentStudent(' + i + ')" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">حذف</button></div>';
                    });
                } else {
                    html += '<p class="text-gray-500 text-sm text-center py-4">لم يتم إضافة أي طالب غائب</p>';
                }
                
                html += '</div><div class="flex gap-2">';
                html += '<input type="text" id="newStudentNameInput" class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg" placeholder="أدخل اسم الطالب" onkeypress="if(event.key===\'Enter\'){event.preventDefault();addAbsentStudent()}">';
                html += '<button onclick="addAbsentStudent()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">➕ إضافة</button></div>';
                html += '<p class="text-xs text-gray-600 mt-2">الطلاب الغائبين: <span class="font-bold">' + absentStudents.length + '</span></p></div>';
            }
            
            html += '</div>';
            
            const isDisabled = !grade || !section || (period !== '1' && !firstPeriod);
            html += '<div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">';
            html += '<button onclick="closeAttendanceModal()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100">إلغاء</button>';
            html += '<button onclick="saveAttendance()" ' + (isDisabled ? 'disabled' : '') + ' class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 ' + (isDisabled ? 'opacity-50 cursor-not-allowed' : '') + '">✓ حفظ</button>';
            html += '</div></div></div>';
            
            return html;
        }

        function buildEditModal() {
            const a = state.modals.editingAttendance;
            if (!a) return '';
            
            const currentCount = a.absentStudents ? a.absentStudents.length : 0;
            
            let html = '<div class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeEditModal()">';
            html += '<div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">';
            html += '<div class="sticky top-0 bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-xl">';
            html += '<h2 class="text-2xl font-bold">✏️ تعديل سجل الغياب</h2>';
            html += '<p class="text-green-100 text-sm mt-1">' + a.grade + ' - الشعبة ' + a.section + ' | الحصة ' + a.period + ' | ' + a.date + '</p></div>';
            
            html += '<div class="p-6 space-y-5">';
            html += '<div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">';
            html += '<p class="text-sm font-bold text-blue-900">📊 إجمالي: ' + a.totalStudents + ' طالب | الغياب: ' + currentCount + '</p></div>';
            
            html += '<div><label class="block text-sm font-bold text-gray-700 mb-3">أسماء الطلاب الغائبين</label>';
            html += '<div class="space-y-2 mb-3 max-h-96 overflow-y-auto">';
            
            if (a.absentStudents && a.absentStudents.length > 0) {
                a.absentStudents.forEach((student, i) => {
                    html += '<div class="flex items-center gap-2 bg-gray-50 p-3 rounded border">';
                    html += '<span class="text-sm font-medium w-8">' + (i + 1) + '.</span>';
                    html += '<input type="text" id="studentName' + i + '" value="' + student + '" onblur="updateStudentName(' + i + ',this.value)" class="flex-1 px-3 py-2 border rounded">';
                    html += '<button onclick="removeStudentFromEdit(' + i + ')" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">🗑️</button></div>';
                });
            } else {
                html += '<p class="text-gray-500 text-center py-8 bg-gray-50 rounded">لا يوجد طلاب</p>';
            }
            
            html += '</div><div class="flex gap-2 mt-4">';
            html += '<input type="text" id="editStudentNameInput" class="flex-1 px-4 py-3 border-2 rounded-lg" placeholder="أضف طالب جديد" onkeypress="if(event.key===\'Enter\'){event.preventDefault();addStudentToEdit()}">';
            html += '<button onclick="addStudentToEdit()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">➕ إضافة</button></div></div>';
            
            html += '</div>';
            html += '<div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 justify-end">';
            html += '<button onclick="closeEditModal()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100">إلغاء</button>';
            html += '<button onclick="saveEditedAttendance()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">✓ حفظ التعديلات</button>';
            html += '</div></div></div>';
            
            return html;
        }

        setTimeout(render, 100);
    </script>
</body>
</html>
