// ==========================================
// حل شامل لمشكلة الأداء والضغط
// ==========================================

// 1. تحسين وظيفة التسجيل - بدون قراءة جميع الطلاب
window.registerStudent = async function() {
    const nameInput = document.getElementById('studentName');
    const gradeInput = document.getElementById('studentGrade');
    const registerBtn = event.target;
    
    const name = nameInput.value.trim().replace(/\s+/g, ' ');
    const grade = gradeInput.value;

    if (!name || !grade) {
        showNotification('يرجى إدخال جميع البيانات المطلوبة', 'error');
        return;
    }

    const nameParts = name.split(' ').filter(part => part.length > 0);
    if (nameParts.length < 3) {
        showNotification('يرجى إدخال الاسم الرباعي كاملاً (على الأقل 3 أجزاء)', 'error');
        return;
    }

    try {
        // تعطيل الزر ووضع مؤشر التحميل
        registerBtn.disabled = true;
        registerBtn.innerHTML = 'جاري التسجيل...';
        registerBtn.style.opacity = '0.6';

        // ✅ استخدام query بدلاً من قراءة جميع السجلات
        const nameQuery = query(
            collection(db, 'students'), 
            where('name', '==', name),
            limit(1) // نحتاج سجل واحد فقط للتحقق
        );
        const existingStudents = await getDocs(nameQuery);

        if (!existingStudents.empty) {
            const existingData = existingStudents.docs[0].data();
            showNotification('هذا الاسم مسجل مسبقاً برقم: ' + existingData.code, 'error');
            
            setTimeout(() => {
                if (confirm(`هذا الاسم مسجل مسبقاً\nرقم الطالب: ${existingData.code}\n\nهل تريد تسجيل الدخول؟`)) {
                    document.getElementById('loginCode').value = existingData.code;
                    switchToLogin();
                }
            }, 500);
            return;
        }

        // ✅ توليد رقم فريد مع التحقق من عدم التكرار
        let studentCode;
        let codeExists = true;
        let attempts = 0;
        
        while (codeExists && attempts < 5) {
            studentCode = generateStudentCode();
            const codeQuery = query(
                collection(db, 'students'),
                where('code', '==', studentCode),
                limit(1)
            );
            const codeCheck = await getDocs(codeQuery);
            codeExists = !codeCheck.empty;
            attempts++;
        }

        if (codeExists) {
            showNotification('خطأ في توليد رقم الطالب. يرجى المحاولة مرة أخرى', 'error');
            return;
        }

        // ✅ التسجيل في قاعدة البيانات
        const studentData = {
            name: name,
            grade: grade,
            code: studentCode,
            score: 0,
            questionsAnswered: 0,
            createdAt: new Date(),
            lastActive: new Date()
        };

        const docRef = await addDoc(collection(db, 'students'), studentData);

        // حفظ معلومات إضافية
        currentStudent = { ...studentData, id: docRef.id };
        localStorage.setItem('nafis_student', JSON.stringify({
            code: studentCode,
            name: name,
            timestamp: Date.now()
        }));

        // عرض رقم الطالب
        showNotification('تم التسجيل بنجاح! رقمك: ' + studentCode, 'success');
        
        const studentInfo = document.getElementById('studentInfo');
        studentInfo.innerHTML = `
            <div class="student-code">
                <h3>✅ تم التسجيل بنجاح!</h3>
                <p>رقم الطالب الخاص بك:</p>
                <div class="code-display" id="generatedCode">${studentCode}</div>
                <p style="font-size: 0.9em; margin-top: 10px; color: rgba(255,255,255,0.9);">
                    ⚠️ <strong>احفظ هذا الرقم جيداً!</strong><br>
                    ستحتاجه لتسجيل الدخول في المرات القادمة
                </p>
                <button class="btn" onclick="copyCode('${studentCode}')" 
                        style="background: rgba(255,255,255,0.2); margin-top: 15px;">
                    📋 نسخ الرقم
                </button>
            </div>
        `;

        document.getElementById('currentScore').textContent = '0';
        showSection('dashboard');

    } catch (error) {
        console.error('Registration error:', error);
        let errorMsg = 'حدث خطأ أثناء التسجيل. ';
        
        if (error.code === 'permission-denied') {
            errorMsg += 'مشكلة في صلاحيات قاعدة البيانات.';
        } else if (error.message.includes('quota')) {
            errorMsg += 'تم تجاوز حد الاستخدام اليومي. يرجى المحاولة لاحقاً.';
        } else {
            errorMsg += 'يرجى المحاولة مرة أخرى.';
        }
        
        showNotification(errorMsg, 'error');
    } finally {
        registerBtn.disabled = false;
        registerBtn.innerHTML = 'تسجيل';
        registerBtn.style.opacity = '1';
    }
};

// 2. تحسين وظيفة تسجيل الدخول
window.loginStudent = async function() {
    const codeInput = document.getElementById('loginCode');
    const code = codeInput.value.trim();

    if (!code || code.length !== 6) {
        showNotification('يرجى إدخال رقم صحيح مكون من 6 أرقام', 'error');
        codeInput.focus();
        return;
    }

    const loginBtn = event.target;
    
    try {
        loginBtn.disabled = true;
        loginBtn.innerHTML = 'جاري تسجيل الدخول...';
        
        // ✅ استعلام محسّن
        const studentsQuery = query(
            collection(db, 'students'), 
            where('code', '==', code),
            limit(1)
        );
        const querySnapshot = await getDocs(studentsQuery);

        if (querySnapshot.empty) {
            showNotification('رقم الطالب غير موجود. تحقق من الرقم أو سجّل حساب جديد', 'error');
            codeInput.value = '';
            codeInput.focus();
            return;
        }

        const studentDoc = querySnapshot.docs[0];
        currentStudent = { id: studentDoc.id, ...studentDoc.data() };

        // استعادة التقدم المحفوظ
        if (currentStudent.lastQuestion !== undefined) {
            currentQuestion = currentStudent.lastQuestion;
            studentAnswers = currentStudent.lastAnswers || [];
        }

        // تحديث آخر نشاط (بدون انتظار)
        updateDoc(doc(db, 'students', studentDoc.id), {
            lastActive: new Date()
        }).catch(e => console.log('Update lastActive failed:', e));

        // حفظ محلي
        localStorage.setItem('nafis_student', JSON.stringify({
            code: code,
            name: currentStudent.name,
            timestamp: Date.now()
        }));

        updateDashboardInfo();
        showNotification(`مرحباً ${currentStudent.name}!`, 'success');
        showSection('dashboard');

    } catch (error) {
        console.error('Login error:', error);
        showNotification('حدث خطأ في تسجيل الدخول. حاول مرة أخرى', 'error');
    } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = 'دخول بالرقم';
    }
};

// 3. تحسين البحث بالاسم - مع Throttling
let searchTimeout;
window.searchByName = async function() {
    clearTimeout(searchTimeout);
    
    const searchName = document.getElementById('loginName').value.trim();
    const searchResults = document.getElementById('searchResults');

    if (!searchName || searchName.length < 3) {
        showNotification('يرجى إدخال 3 أحرف على الأقل للبحث', 'error');
        return;
    }

    searchResults.innerHTML = '<p style="text-align:center;color:#666;">جاري البحث...</p>';

    // ✅ تأخير البحث لتقليل الضغط
    searchTimeout = setTimeout(async () => {
        try {
            // البحث المحسّن - نأخذ فقط 20 نتيجة
            const studentsQuery = query(
                collection(db, 'students'),
                orderBy('name'),
                limit(50) // حد أقصى
            );
            const snapshot = await getDocs(studentsQuery);
            
            const matches = [];
            const searchLower = searchName.toLowerCase();
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.name.toLowerCase().includes(searchLower)) {
                    matches.push(data);
                }
            });

            if (matches.length === 0) {
                searchResults.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#666;">
                        <p>❌ لم يتم العثور على نتائج</p>
                        <p style="font-size:0.9em;">جرب البحث باسم مختلف أو سجّل حساب جديد</p>
                    </div>
                `;
                return;
            }

            searchResults.innerHTML = `
                <div style="margin-bottom:15px;">
                    <h4 style="color:#333;margin-bottom:10px;">
                        نتائج البحث (${matches.length}):
                    </h4>
                    ${matches.slice(0, 10).map(student => `
                        <div class="search-result" onclick="selectStudent('${student.code}')">
                            <div class="student-info">
                                <div class="student-details">
                                    <h4>${student.name}</h4>
                                    <p>الصف ${student.grade} - النقاط: ${student.score || 0}</p>
                                </div>
                                <div class="student-code-badge">${student.code}</div>
                            </div>
                        </div>
                    `).join('')}
                    ${matches.length > 10 ? 
                        `<p style="text-align:center;color:#666;margin-top:10px;">
                            عرض أول 10 نتائج من ${matches.length}
                        </p>` : ''
                    }
                </div>
            `;

        } catch (error) {
            console.error('Search error:', error);
            searchResults.innerHTML = `
                <div style="text-align:center;padding:20px;color:#e74c3c;">
                    <p>حدث خطأ في البحث</p>
                    <p style="font-size:0.9em;">حاول مرة أخرى</p>
                </div>
            `;
        }
    }, 800); // تأخير 800ms
};

// 4. اختيار طالب من نتائج البحث
window.selectStudent = function(code) {
    if (confirm('تسجيل الدخول بهذا الحساب؟')) {
        document.getElementById('loginCode').value = code;
        loginStudent();
    }
};

// 5. نسخ الرقم
window.copyCode = function(code) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
            showNotification('✅ تم نسخ الرقم بنجاح', 'success');
        }).catch(() => {
            prompt('انسخ هذا الرقم:', code);
        });
    } else {
        prompt('انسخ هذا الرقم:', code);
    }
};

// 6. تعطيل التحقق الفوري من الاسم (يسبب ضغط)
function setupNameChecking() {
    const nameInput = document.getElementById('studentName');
    const nameCheckResult = document.getElementById('nameCheckResult');
    
    if (!nameInput || !nameCheckResult) return;
    
    let checkTimeout;
    
    nameInput.addEventListener('input', function() {
        clearTimeout(checkTimeout);
        const name = this.value.trim();
        
        if (name.length < 3) {
            nameCheckResult.innerHTML = '';
            return;
        }
        
        const nameParts = name.split(' ').filter(p => p.length > 0);
        
        if (nameParts.length < 3) {
            nameCheckResult.innerHTML = 
                '<span class="name-check-warning">⚠️ أدخل الاسم الرباعي كاملاً</span>';
        } else {
            nameCheckResult.innerHTML = 
                '<span class="name-check-success">✅ الاسم بصيغة صحيحة</span>';
        }
    });
}

// 7. تحسين Auto-save - كل دقيقة بدلاً من 30 ثانية
let autoSaveInterval;
function startAutoSave() {
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    
    autoSaveInterval = setInterval(async () => {
        if (!currentStudent || document.getElementById('testSection').classList.contains('hidden')) {
            return;
        }
        
        try {
            const studentQuery = query(
                collection(db, 'students'),
                where('code', '==', currentStudent.code),
                limit(1)
            );
            const snapshot = await getDocs(studentQuery);
            
            if (!snapshot.empty) {
                const docRef = doc(db, 'students', snapshot.docs[0].id);
                await updateDoc(docRef, {
                    lastQuestion: currentQuestion,
                    lastAnswers: studentAnswers,
                    score: currentStudent.score,
                    lastActive: new Date()
                });
                
                // مؤشر بصري بسيط
                console.log('💾 Auto-saved');
            }
        } catch (error) {
            console.error('Auto-save error:', error);
        }
    }, 60000); // كل دقيقة بدلاً من 30 ثانية
}

// 8. تحميل تلقائي من localStorage
function autoLogin() {
    try {
        const saved = localStorage.getItem('nafis_student');
        if (!saved) return;
        
        const data = JSON.parse(saved);
        const hoursPassed = (Date.now() - data.timestamp) / (1000 * 60 * 60);
        
        // تسجيل دخول تلقائي إذا كان أقل من 24 ساعة
        if (hoursPassed < 24 && data.code) {
            document.getElementById('loginCode').value = data.code;
            showNotification('تم العثور على حساب محفوظ: ' + data.name, 'info');
        }
    } catch (error) {
        console.error('Auto-login error:', error);
    }
}

// 9. تعطيل تحديث الإحصائيات المستمر
async function updateHeaderStats() {
    try {
        // فقط عند تحميل الصفحة - ليس بشكل مستمر
        const studentsCount = localStorage.getItem('nafis_stats_count') || '0';
        const questionsCount = localStorage.getItem('nafis_questions_count') || '5';
        
        document.getElementById('headerActiveStudents').textContent = studentsCount;
        document.getElementById('headerTotalQuestions').textContent = questionsCount;
        
        // تحديث خفيف مرة واحدة
        const studentsSnapshot = await getDocs(query(collection(db, 'students'), limit(1)));
        // لا نحسب الكل - فقط نعرض رقم تقريبي
        
    } catch (error) {
        console.error('Stats error:', error);
    }
}

// 10. تهيئة محسّنة
function initApp() {
    showSection('registration');
    setupNameChecking();
    autoLogin();
    updateHeaderStats();
    
    // بدء Auto-save عند بدء الاختبار
    window.startTest = (function(original) {
        return async function() {
            await original.apply(this, arguments);
            startAutoSave();
        };
    })(window.startTest);
}

// تشغيل التطبيق
document.addEventListener('DOMContentLoaded', initApp);
initApp();

console.log('✅ Nafis Performance Optimization Loaded');
