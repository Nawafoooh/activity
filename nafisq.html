// ==========================================
// Ù†Ø¸Ø§Ù… Ù†Ø§Ø§ÙØ³ - Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø­Ø³Ù‘Ù† ÙˆØ§Ù„Ù…Ø­ØªØ±Ù
// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø¶ØºØ·
// ==========================================

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    query, 
    where, 
    orderBy, 
    limit,
    updateDoc, 
    doc 
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

// ==========================================
// 1. ØªÙ‡ÙŠØ¦Ø© Firebase
// ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyD28cfba2NmXlsfBci9jgbne21U9rZLJ2M",
    authDomain: "nafis-new.firebaseapp.com",
    projectId: "nafis-new",
    storageBucket: "nafis-new.firebasestorage.app",
    messagingSenderId: "366381122504",
    appId: "1:366381122504:web:b76107c74d7d7ec82df6fd",
    measurementId: "G-ZD3Z9LEGGM"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ==========================================
// 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
// ==========================================
let currentStudent = null;
let currentQuestion = 0;
let questions = [];
let studentAnswers = [];
let autoSaveInterval = null;

// Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
const questionBank = [
    {
        id: 1,
        question: "Ù…Ø§ Ù‡Ùˆ Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ 7 Ã— 8ØŸ",
        options: ["54", "56", "58", "60"],
        correct: 1,
        subject: "Ø±ÙŠØ§Ø¶ÙŠØ§Øª",
        active: true
    },
    {
        id: 2,
        question: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ",
        options: ["Ø¬Ø¯Ø©", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ø§Ù„Ø¯Ù…Ø§Ù…", "Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©"],
        correct: 1,
        subject: "Ø¬ØºØ±Ø§ÙÙŠØ§",
        active: true
    },
    {
        id: 3,
        question: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ",
        options: ["4", "5", "6", "7"],
        correct: 1,
        subject: "ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©",
        active: true
    },
    {
        id: 4,
        question: "Ù…Ø§ Ù‡Ùˆ Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠØŸ",
        options: ["Ø§Ù„Ø£Ø±Ø¶", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø²Ø­Ù„", "Ø§Ù„Ù…Ø±ÙŠØ®"],
        correct: 1,
        subject: "Ø¹Ù„ÙˆÙ…",
        active: true
    },
    {
        id: 5,
        question: "Ù…Ù† Ù‡Ùˆ Ø£ÙˆÙ„ Ø®Ù„ÙŠÙØ© Ø±Ø§Ø´Ø¯ØŸ",
        options: ["Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø®Ø·Ø§Ø¨", "Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„ØµØ¯ÙŠÙ‚", "Ø¹Ø«Ù…Ø§Ù† Ø¨Ù† Ø¹ÙØ§Ù†", "Ø¹Ù„ÙŠ Ø¨Ù† Ø£Ø¨ÙŠ Ø·Ø§Ù„Ø¨"],
        correct: 1,
        subject: "ØªØ§Ø±ÙŠØ®",
        active: true
    }
];

// ==========================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© (Utility Functions)
// ==========================================

// ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø·Ø§Ù„Ø¨ ÙØ±ÙŠØ¯
function generateStudentCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

// Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    
    if (!notification || !notificationText) return;
    
    notificationText.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
function showSection(sectionId) {
    const sections = ['registration', 'login', 'dashboard', 'testSection', 'resultsSection'];
    sections.forEach(section => {
        const element = document.getElementById(section);
        if (element) {
            element.classList.add('hidden');
        }
    });
    
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.remove('hidden');
    }
}

// Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
function setLoading(button, isLoading, originalText = '') {
    if (!button) return;
    
    if (isLoading) {
        button.disabled = true;
        button.setAttribute('data-original-text', button.textContent);
        button.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        button.style.opacity = '0.6';
        button.style.cursor = 'not-allowed';
    } else {
        button.disabled = false;
        const savedText = button.getAttribute('data-original-text');
        button.textContent = savedText || originalText;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
        button.removeAttribute('data-original-text');
    }
}

// ==========================================
// 4. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©
// ==========================================
window.registerStudent = async function() {
    const nameInput = document.getElementById('studentName');
    const gradeSelect = document.getElementById('studentGrade');
    const registerBtn = document.querySelector('#registration .btn');
    
    if (!nameInput || !gradeSelect || !registerBtn) {
        console.error('Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        return;
    }
    
    const name = nameInput.value.trim().replace(/\s+/g, ' ');
    const grade = gradeSelect.value;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!name || !grade) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        if (!name) nameInput.focus();
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ø§Ø³Ù…
    const nameParts = name.split(' ').filter(part => part.length > 0);
    if (nameParts.length < 3) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹ (3 Ø£Ø¬Ø²Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)', 'error');
        nameInput.focus();
        return;
    }

    setLoading(registerBtn, true);

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø§Ø³Ù… (Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø­Ø³Ù‘Ù†)
        const nameQuery = query(
            collection(db, 'students'), 
            where('name', '==', name),
            limit(1)
        );
        
        const existingStudents = await getDocs(nameQuery);

        if (!existingStudents.empty) {
            const existingData = existingStudents.docs[0].data();
            showNotification(`Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨Ø±Ù‚Ù…: ${existingData.code}`, 'error');
            
            setTimeout(() => {
                const confirmLogin = confirm(
                    `Ø§Ù„Ø§Ø³Ù… "${name}" Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹\n` +
                    `Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${existingData.code}\n` +
                    `Ø§Ù„ØµÙ: ${existingData.grade}\n\n` +
                    `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ`
                );
                
                if (confirmLogin) {
                    document.getElementById('loginCode').value = existingData.code;
                    switchToLogin();
                }
            }, 500);
            
            return;
        }

        // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø·Ø§Ù„Ø¨ ÙØ±ÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
        let studentCode;
        let isUnique = false;
        let attempts = 0;
        const maxAttempts = 5;
        
        while (!isUnique && attempts < maxAttempts) {
            studentCode = generateStudentCode();
            
            const codeQuery = query(
                collection(db, 'students'),
                where('code', '==', studentCode),
                limit(1)
            );
            
            const codeCheck = await getDocs(codeQuery);
            isUnique = codeCheck.empty;
            attempts++;
        }

        if (!isUnique) {
            showNotification('Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ÙØ±ÙŠØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨
        const studentData = {
            name: name,
            grade: grade,
            code: studentCode,
            score: 0,
            questionsAnswered: 0,
            createdAt: new Date(),
            lastActive: new Date()
        };

        const docRef = await addDoc(collection(db, 'students'), studentData);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        currentStudent = {
            ...studentData,
            id: docRef.id
        };

        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        localStorage.setItem('nafis_last_login', JSON.stringify({
            code: studentCode,
            name: name,
            timestamp: Date.now()
        }));

        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        const studentInfo = document.getElementById('studentInfo');
        if (studentInfo) {
            studentInfo.innerHTML = `
                <div class="student-code">
                    <h3>âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                    <p style="margin: 10px 0;">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
                    <div class="code-display">${studentCode}</div>
                    <p style="font-size: 0.9em; margin-top: 15px; color: rgba(255,255,255,0.9);">
                        âš ï¸ <strong>Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¬ÙŠØ¯Ø§Ù‹!</strong><br>
                        Ø³ØªØ­ØªØ§Ø¬Ù‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                    </p>
                    <button class="btn" onclick="copyStudentCode('${studentCode}')" 
                            style="background: rgba(255,255,255,0.2); margin-top: 15px;">
                        ğŸ“‹ Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
                    </button>
                </div>
            `;
        }

        const scoreElement = document.getElementById('currentScore');
        if (scoreElement) {
            scoreElement.textContent = '0';
        }

        showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}! Ø±Ù‚Ù…Ùƒ: ${studentCode}`, 'success');
        showSection('dashboard');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateHeaderStats();

    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', error);
        
        let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ';
        
        if (error.code === 'permission-denied') {
            errorMessage += 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
        } else if (error.code === 'unavailable') {
            errorMessage += 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
        } else if (error.message && error.message.includes('quota')) {
            errorMessage += 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.';
        } else {
            errorMessage += 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        }
        
        showNotification(errorMessage, 'error');
        
    } finally {
        setLoading(registerBtn, false, 'ØªØ³Ø¬ÙŠÙ„');
    }
};

// ==========================================
// 5. ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©
// ==========================================
window.loginStudent = async function() {
    const codeInput = document.getElementById('loginCode');
    const loginBtns = document.querySelectorAll('#login .btn');
    const loginBtn = loginBtns[0]; // Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙˆÙ„
    
    if (!codeInput || !loginBtn) {
        console.error('Ø¹Ù†Ø§ØµØ± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        return;
    }
    
    const code = codeInput.value.trim();

    if (!code) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
        codeInput.focus();
        return;
    }

    if (code.length !== 6 || !/^\d{6}$/.test(code)) {
        showNotification('Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 6 Ø£Ø±Ù‚Ø§Ù…', 'error');
        codeInput.focus();
        return;
    }

    setLoading(loginBtn, true);

    try {
        const studentsQuery = query(
            collection(db, 'students'), 
            where('code', '==', code),
            limit(1)
        );
        
        const querySnapshot = await getDocs(studentsQuery);

        if (querySnapshot.empty) {
            showNotification('Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø³Ø¬Ù‘Ù„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯', 'error');
            codeInput.value = '';
            codeInput.focus();
            return;
        }

        const studentDoc = querySnapshot.docs[0];
        currentStudent = {
            id: studentDoc.id,
            ...studentDoc.data()
        };

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
        if (currentStudent.lastQuestion !== undefined && currentStudent.lastQuestion < questions.length) {
            currentQuestion = currentStudent.lastQuestion;
            studentAnswers = currentStudent.lastAnswers || [];
        } else {
            currentQuestion = 0;
            studentAnswers = [];
        }

        // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ù†Ø´Ø§Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±)
        updateDoc(doc(db, 'students', studentDoc.id), {
            lastActive: new Date()
        }).catch(e => console.log('ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ù†Ø´Ø§Ø· ÙØ´Ù„:', e));

        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        localStorage.setItem('nafis_last_login', JSON.stringify({
            code: code,
            name: currentStudent.name,
            timestamp: Date.now()
        }));

        updateDashboardInfo();
        showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentStudent.name}!`, 'success');
        showSection('dashboard');

    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
        
    } finally {
        setLoading(loginBtn, false, 'Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù‚Ù…');
    }
};

// ==========================================
// 6. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø©
// ==========================================
let searchTimeout = null;

window.searchByName = async function() {
    const nameInput = document.getElementById('loginName');
    const searchResults = document.getElementById('searchResults');
    const searchBtn = document.querySelectorAll('#login .btn')[1]; // Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ
    
    if (!nameInput || !searchResults) {
        console.error('Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø­Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        return;
    }
    
    clearTimeout(searchTimeout);
    
    const searchName = nameInput.value.trim();

    if (!searchName || searchName.length < 3) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«', 'error');
        nameInput.focus();
        return;
    }

    searchResults.innerHTML = '<p style="text-align:center;color:#666;padding:15px;">ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
    
    if (searchBtn) setLoading(searchBtn, true);

    searchTimeout = setTimeout(async () => {
        try {
            // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†ØªØ§Ø¦Ø¬
            const studentsQuery = query(
                collection(db, 'students'),
                orderBy('name'),
                limit(100)
            );
            
            const snapshot = await getDocs(studentsQuery);
            
            const matches = [];
            const searchLower = searchName.toLowerCase();
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const nameLower = data.name.toLowerCase();
                
                if (nameLower.includes(searchLower)) {
                    matches.push(data);
                }
            });

            if (matches.length === 0) {
                searchResults.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#666;">
                        <p style="font-size:1.2em;">âŒ</p>
                        <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</p>
                        <p style="font-size:0.9em;margin-top:5px;">
                            Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø¢Ø®Ø± Ø£Ùˆ 
                            <span style="color:#667eea;cursor:pointer;" onclick="switchToRegister()">
                                Ø³Ø¬Ù‘Ù„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                            </span>
                        </p>
                    </div>
                `;
                return;
            }

            const maxDisplay = 15;
            searchResults.innerHTML = `
                <div style="margin-bottom:15px;">
                    <h4 style="color:#333;margin-bottom:10px;padding:10px;background:#f8f9fa;border-radius:8px;">
                        ğŸ“‹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: ${matches.length} ${matches.length > maxDisplay ? `(Ø¹Ø±Ø¶ Ø£ÙˆÙ„ ${maxDisplay})` : ''}
                    </h4>
                    ${matches.slice(0, maxDisplay).map(student => `
                        <div class="search-result" onclick="selectStudentFromSearch('${student.code}', '${student.name}')">
                            <div class="student-info">
                                <div class="student-details">
                                    <h4>${student.name}</h4>
                                    <p>Ø§Ù„ØµÙ ${student.grade} â€¢ Ø§Ù„Ù†Ù‚Ø§Ø·: ${student.score || 0}</p>
                                </div>
                                <div class="student-code-badge">${student.code}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            showNotification(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${matches.length} Ù†ØªÙŠØ¬Ø©`, 'success');

        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
            searchResults.innerHTML = `
                <div style="text-align:center;padding:20px;color:#e74c3c;">
                    <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«</p>
                    <p style="font-size:0.9em;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>
                </div>
            `;
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«', 'error');
        } finally {
            if (searchBtn) setLoading(searchBtn, false, 'Ø§Ù„Ø¨Ø­Ø«');
        }
    }, 800);
};

// ==========================================
// 7. Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
// ==========================================
window.selectStudentFromSearch = function(code, name) {
    const searchResults = document.querySelectorAll('.search-result');
    searchResults.forEach(result => result.classList.remove('selected'));
    
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('selected');
    }
    
    const confirmLogin = confirm(
        `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ€:\n\n` +
        `${name}\n` +
        `Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${code}ØŸ`
    );
    
    if (confirmLogin) {
        document.getElementById('loginCode').value = code;
        loginStudent();
    }
};

// ==========================================
// 8. Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
// ==========================================
window.switchToLogin = function() {
    showSection('login');
    const codeInput = document.getElementById('loginCode');
    if (codeInput) codeInput.focus();
    showNotification('Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…', 'info');
};

window.switchToRegister = function() {
    showSection('registration');
    const nameInput = document.getElementById('studentName');
    if (nameInput) nameInput.focus();
    showNotification('Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ', 'info');
};

// ==========================================
// 9. ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
// ==========================================
function updateDashboardInfo() {
    if (!currentStudent) return;
    
    const studentInfo = document.getElementById('studentInfo');
    const currentScore = document.getElementById('currentScore');
    
    if (!studentInfo) return;
    
    let progressInfo = '';
    
    if (currentStudent.lastQuestion !== undefined && currentStudent.lastQuestion < questions.length) {
        const progressPercent = Math.round(((currentStudent.lastQuestion + 1) / questions.length) * 100);
        progressInfo = `
            <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <h4 style="margin:0 0 10px 0;">ğŸ“š ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚ÙØª</h4>
                <p style="margin:5px 0;">Ø§Ù„Ø³Ø¤Ø§Ù„: ${currentStudent.lastQuestion + 1} Ù…Ù† ${questions.length}</p>
                <p style="margin:5px 0;">Ø§Ù„ØªÙ‚Ø¯Ù…: ${progressPercent}%</p>
                <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px; margin: 10px 0; overflow: hidden;">
                    <div style="background: #27ae60; height: 100%; border-radius: 10px; width: ${progressPercent}%;"></div>
                </div>
            </div>
        `;
    } else if (currentStudent.lastQuestion >= questions.length) {
        progressInfo = `
            <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <h4 style="margin:0 0 10px 0;">ğŸ‰ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!</h4>
                <p style="margin:0;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>
            </div>
        `;
    }

    studentInfo.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; margin-bottom: 15px;">
                <h3 style="margin: 0 0 10px 0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentStudent.name}</h3>
                <p style="margin: 5px 0; opacity: 0.9;">Ø§Ù„ØµÙ ${currentStudent.grade}</p>
                <p style="margin: 5px 0; opacity: 0.9;">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${currentStudent.code}</p>
            </div>
            ${progressInfo}
        </div>
    `;

    if (currentScore) {
        currentScore.textContent = currentStudent.score || 0;
    }
}

// ==========================================
// 10. Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
// ==========================================
window.startTest = async function() {
    if (!currentStudent) {
        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
    }

    try {
        showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...', 'info');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const questionsQuery = query(
            collection(db, 'questions'),
            where('active', '==', true)
        );
        const questionsSnapshot = await getDocs(questionsQuery);
        
        if (!questionsSnapshot.empty) {
            questions = [];
            questionsSnapshot.forEach((doc) => {
                questions.push({ id: doc.id, ...doc.data() });
            });
        }
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£Ø³Ø¦Ù„Ø©
        if (questions.length === 0) {
            questions = [...questionBank];
            showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ', 'info');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªÙ‚Ø¯Ù… Ù…Ø­ÙÙˆØ¸
        if (currentStudent.lastQuestion !== undefined && currentStudent.lastQuestion < questions.length) {
            const resumeConfirm = confirm(
                `Ù„Ø¯ÙŠÙƒ ØªÙ‚Ø¯Ù… Ù…Ø­ÙÙˆØ¸:\n\n` +
                `Ø§Ù„Ø³Ø¤Ø§Ù„: ${currentStudent.lastQuestion + 1} Ù…Ù† ${questions.length}\n` +
                `Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${currentStudent.score || 0}\n\n` +
                `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚ÙØªØŸ\n` +
                `(Ù…ÙˆØ§ÙÙ‚ = Ù…ØªØ§Ø¨Ø¹Ø© | Ø¥Ù„ØºØ§Ø¡ = Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯)`
            );
            
            if (resumeConfirm) {
                currentQuestion = currentStudent.lastQuestion;
                studentAnswers = currentStudent.lastAnswers || [];
                showNotification('ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚ÙØª', 'success');
            } else {
                currentQuestion = 0;
                studentAnswers = [];
                showNotification('Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯', 'info');
            }
        } else {
            currentQuestion = 0;
            studentAnswers = [];
        }

        showSection('testSection');
        displayQuestion();
        startAutoSave();

    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
    }
};

// ==========================================
// 11. Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„
// ==========================================
function displayQuestion() {
    if (currentQuestion >= questions.length) {
        showNotification('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!', 'success');
        clearSavedProgress();
        stopAutoSave();
        showSection('dashboard');
        return;
    }

    const question = questions[currentQuestion];
    const container = document.getElementById('questionContainer');
    const previousAnswer = studentAnswers[currentQuestion];
    
    if (!container) return;
    
    container.innerHTML = `
        <div class="question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9em;">
                    ${question.subject}
                </span>
                <span style="color: #666; font-size: 0.9em; font-weight: 500;">
                    Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestion + 1} Ù…Ù† ${questions.length}
                </span>
            </div>
            ${previousAnswer !== undefined ? 
                '<div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin: 10px 0; color: #1565c0; font-size: 0.9em;">âœ“ ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹</div>' : 
                ''
            }
            <div class="question-text">
                <strong>Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestion + 1}:</strong> ${question.question}
            </div>
            <div class="options">
                ${question.options.map((option, index) => `
                    <div class="option ${previousAnswer === index ? 'selected' : ''}" 
                         onclick="selectOption(${index})" 
                         data-index="${index}">
                        ${String.fromCharCode(65 + index)}) ${option}
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    const progress = ((currentQuestion + 1) / questions.length) * 100;
    const progressFill = document.getElementById('progressFill');
    if (progressFill) {
        progressFill.style.width = progress + '%';
    }

    const nextBtn = document.getElementById('nextBtn');
    if (nextBtn) {
        if (currentQuestion === questions.length - 1) {
            nextBtn.textContent = 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
            nextBtn.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
        } else {
            nextBtn.textContent = 'Ø§Ù„ØªØ§Ù„ÙŠ';
            nextBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        }
    }
}

// ==========================================
// 12. Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø©
// ==========================================
window.selectOption = function(index) {
    const options = document.querySelectorAll('.option');
    options.forEach(option => option.classList.remove('selected'));
    
    if (options[index]) {
        options[index].classList.add('selected');
    }
    
    studentAnswers[currentQuestion] = index;
};

// ==========================================
// 13. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
// ==========================================
window.nextQuestion = async function() {
    if (studentAnswers[currentQuestion] === undefined) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ', 'error');
        return;
    }

    const question = questions[currentQuestion];
    const selectedAnswer = studentAnswers[currentQuestion];
    const isCorrect = selectedAnswer === question.correct;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„Ø®Ø§Ø·Ø¦Ø©
    const options = document.querySelectorAll('.option');
    if (options[question.correct]) {
        options[question.correct].classList.add('correct');
    }
    if (!isCorrect && options[selectedAnswer]) {
        options[selectedAnswer].classList.add('wrong');
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
    if (isCorrect) {
        currentStudent.score = (currentStudent.score || 0) + 1;
        showNotification('Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! +1 Ù†Ù‚Ø·Ø©', 'success');
    } else {
        currentStudent.score = Math.max(0, (currentStudent.score || 0) - 1);
        showNotification('Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! -1 Ù†Ù‚Ø·Ø©', 'error');
    }

    // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    try {
        const studentQuery = query(
            collection(db, 'students'),
            where('code', '==', currentStudent.code),
            limit(1)
        );
        const querySnapshot = await getDocs(studentQuery);
        
        if (!querySnapshot.empty) {
            const studentDocRef = doc(db, 'students', querySnapshot.docs[0].id);
            await updateDoc(studentDocRef, {
                score: currentStudent.score,
                questionsAnswered: (currentStudent.questionsAnswered || 0) + 1,
                lastActive: new Date()
            });
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·:', error);
    }

    const scoreElement = document.getElementById('currentScore');
    if (scoreElement) {
        scoreElement.textContent = currentStudent.score;
    }

    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
    setTimeout(() => {
        currentQuestion++;
        displayQuestion();
    }, 2000);
};

// ==========================================
// 14. Ø­ÙØ¸ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
// ==========================================
window.saveAndExit = async function() {
    if (!currentStudent) {
        showNotification('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
        return;
    }

    const saveBtn = document.querySelector('#testSection .btn.secondary');
    if (saveBtn) setLoading(saveBtn, true);

    try {
        const studentQuery = query(
            collection(db, 'students'),
            where('code', '==', currentStudent.code),
            limit(1)
        );
        const querySnapshot = await getDocs(studentQuery);
        
        if (!querySnapshot.empty) {
            const studentDocRef = doc(db, 'students', querySnapshot.docs[0].id);
            
            await updateDoc(studentDocRef, {
                lastQuestion: currentQuestion,
                lastAnswers: studentAnswers,
                score: currentStudent.score,
                lastActive: new Date(),
                savedAt: new Date()
            });
            
            currentStudent.lastQuestion = currentQuestion;
            currentStudent.lastAnswers = studentAnswers;
            
            showNotification(
                `ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentQuestion + 1} Ù…Ù† ${questions.length}\nØ§Ù„Ù†Ù‚Ø§Ø·: ${currentStudent.score}`, 
                'success'
            );
            
            stopAutoSave();
            updateDashboardInfo();
            showSection('dashboard');
        } else {
            showNotification('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
    } finally {
        if (saveBtn) setLoading(saveBtn, false, 'Ø­ÙØ¸ ÙˆØ®Ø±ÙˆØ¬');
    }
};

// ==========================================
// 15. Ù…Ø³Ø­ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
// ==========================================
async function clearSavedProgress() {
    if (!currentStudent) return;
    
    try {
        const studentQuery = query(
            collection(db, 'students'),
            where('code', '==', currentStudent.code),
            limit(1)
        );
        const querySnapshot = await getDocs(studentQuery);
        
        if (!querySnapshot.empty) {
            const studentDocRef = doc(db, 'students', querySnapshot.docs[0].id);
            await updateDoc(studentDocRef, {
                lastQuestion: questions.length,
                lastAnswers: [],
                completedAt: new Date(),
                lastActive: new Date()
            });
            
            currentStudent.lastQuestion = questions.length;
            currentStudent.lastAnswers = [];
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„ØªÙ‚Ø¯Ù…:', error);
    }
}

// ==========================================
// 16. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
// ==========================================
window.showResults = async function() {
    try {
        showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬...', 'info');
        
        const studentsSnapshot = await getDocs(collection(db, 'students'));
        const allStudents = studentsSnapshot.docs.map(doc => ({ 
            id: doc.id, 
            ...doc.data() 
        }));

        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
        allStudents.sort((a, b) => (b.score || 0) - (a.score || 0));

        // Ø·Ù„Ø§Ø¨ Ù†ÙØ³ Ø§Ù„ØµÙ
        const classStudents = allStudents.filter(student => 
            student.grade === currentStudent.grade
        );
        
        // Ø¹Ø±Ø¶ ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙ
        const classLeaderboard = document.getElementById('classLeaderboard');
        if (classLeaderboard) {
            if (classStudents.length === 0) {
                classLeaderboard.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#666;">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
                    </div>
                `;
            } else {
                classLeaderboard.innerHTML = classStudents.slice(0, 10).map((student, index) => {
                    const isCurrentStudent = student.code === currentStudent.code;
                    const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                    
                    return `
                        <div class="leaderboard-item ${rankClass}" 
                             style="${isCurrentStudent ? 'border: 3px solid #667eea; box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);' : ''}">
                            <div class="rank">${index + 1}</div>
                            <div class="student-name">
                                ${student.name} ${isCurrentStudent ? '(Ø£Ù†Øª)' : ''}
                            </div>
                            <div class="student-score">${student.score || 0} Ù†Ù‚Ø·Ø©</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Ø¹Ø±Ø¶ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
        const schoolLeaderboard = document.getElementById('schoolLeaderboard');
        if (schoolLeaderboard) {
            if (allStudents.length === 0) {
                schoolLeaderboard.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#666;">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>
                    </div>
                `;
            } else {
                schoolLeaderboard.innerHTML = allStudents.slice(0, 10).map((student, index) => {
                    const isCurrentStudent = student.code === currentStudent.code;
                    const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                    
                    return `
                        <div class="leaderboard-item ${rankClass}"
                             style="${isCurrentStudent ? 'border: 3px solid #667eea; box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);' : ''}">
                            <div class="rank">${index + 1}</div>
                            <div class="student-name">
                                ${student.name} - Ø§Ù„ØµÙ ${student.grade} ${isCurrentStudent ? '(Ø£Ù†Øª)' : ''}
                            </div>
                            <div class="student-score">${student.score || 0} Ù†Ù‚Ø·Ø©</div>
                        </div>
                    `;
                }).join('');
            }
        }

        showSection('resultsSection');
        showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');

    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'error');
    }
};

// ==========================================
// 17. Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
// ==========================================
window.backToDashboard = function() {
    updateDashboardInfo();
    showSection('dashboard');
};

// ==========================================
// 18. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
// ==========================================
window.logout = function() {
    if (currentStudent && !document.getElementById('testSection').classList.contains('hidden')) {
        const saveBeforeLogout = confirm(
            'Ù„Ø¯ÙŠÙƒ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø§Ø±ÙŠ.\n\n' +
            'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ\n\n' +
            '(Ù…ÙˆØ§ÙÙ‚ = Ø­ÙØ¸ ÙˆØ®Ø±ÙˆØ¬ | Ø¥Ù„ØºØ§Ø¡ = Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸)'
        );
        
        if (saveBeforeLogout) {
            saveAndExit().then(() => {
                performLogout();
            });
            return;
        }
    }
    
    performLogout();
};

function performLogout() {
    currentStudent = null;
    currentQuestion = 0;
    studentAnswers = [];
    
    // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    const studentName = document.getElementById('studentName');
    const studentGrade = document.getElementById('studentGrade');
    const loginCode = document.getElementById('loginCode');
    const loginName = document.getElementById('loginName');
    const nameCheckResult = document.getElementById('nameCheckResult');
    const searchResults = document.getElementById('searchResults');
    
    if (studentName) studentName.value = '';
    if (studentGrade) studentGrade.value = '';
    if (loginCode) loginCode.value = '';
    if (loginName) loginName.value = '';
    if (nameCheckResult) nameCheckResult.innerHTML = '';
    if (searchResults) searchResults.innerHTML = '';
    
    // Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    localStorage.removeItem('nafis_last_login');
    
    stopAutoSave();
    showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'info');
    showSection('registration');
}

// ==========================================
// 19. Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
// ==========================================
window.copyStudentCode = function(code) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(() => {
            showNotification('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­: ' + code, 'success');
        }).catch(() => {
            fallbackCopy(code);
        });
    } else {
        fallbackCopy(code);
    }
};

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ' + text, 'success');
    } catch (err) {
        prompt('Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹:', text);
    }
    
    document.body.removeChild(textArea);
}

// ==========================================
// 20. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù… (Ù…Ø­Ø³Ù‘Ù†)
// ==========================================
function setupNameChecking() {
    const nameInput = document.getElementById('studentName');
    const nameCheckResult = document.getElementById('nameCheckResult');
    
    if (!nameInput || !nameCheckResult) return;
    
    nameInput.addEventListener('input', function() {
        const name = this.value.trim().replace(/\s+/g, ' ');
        
        if (name.length < 3) {
            nameCheckResult.innerHTML = '';
            return;
        }
        
        const nameParts = name.split(' ').filter(p => p.length > 0);
        
        if (nameParts.length < 3) {
            nameCheckResult.innerHTML = 
                '<span class="name-check-warning">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹ (3 Ø£Ø¬Ø²Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</span>';
        } else {
            nameCheckResult.innerHTML = 
                '<span class="name-check-success">âœ… Ø§Ù„Ø§Ø³Ù… Ø¨ØµÙŠØºØ© ØµØ­ÙŠØ­Ø©</span>';
        }
    });
}

// ==========================================
// 21. Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
// ==========================================
function startAutoSave() {
    stopAutoSave(); // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø³Ø§Ø¨Ù‚
    
    autoSaveInterval = setInterval(async () => {
        if (!currentStudent || document.getElementById('testSection').classList.contains('hidden')) {
            return;
        }
        
        try {
            const studentQuery = query(
                collection(db, 'students'),
                where('code', '==', currentStudent.code),
                limit(1)
            );
            const snapshot = await getDocs(studentQuery);
            
            if (!snapshot.empty) {
                const docRef = doc(db, 'students', snapshot.docs[0].id);
                await updateDoc(docRef, {
                    lastQuestion: currentQuestion,
                    lastAnswers: studentAnswers,
                    score: currentStudent.score,
                    lastActive: new Date(),
                    autoSavedAt: new Date()
                });
                
                console.log('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', new Date().toLocaleTimeString('ar-SA'));
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
        }
    }, 60000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
}

function stopAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
    }
}

// ==========================================
// 22. ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø£Ø³
// ==========================================
async function updateHeaderStats() {
    try {
        const headerTotalQuestions = document.getElementById('headerTotalQuestions');
        const headerActiveStudents = document.getElementById('headerActiveStudents');
        const headerTotalPoints = document.getElementById('headerTotalPoints');
        
        if (!headerTotalQuestions || !headerActiveStudents || !headerTotalPoints) return;
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const cachedStats = localStorage.getItem('nafis_stats_cache');
        const cacheTime = localStorage.getItem('nafis_stats_cache_time');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ÙƒØ§Ø´ Ø­Ø¯ÙŠØ« (Ø£Ù‚Ù„ Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚)
        if (cachedStats && cacheTime) {
            const timeDiff = Date.now() - parseInt(cacheTime);
            if (timeDiff < 5 * 60 * 1000) { // 5 Ø¯Ù‚Ø§Ø¦Ù‚
                const stats = JSON.parse(cachedStats);
                headerTotalQuestions.textContent = stats.questions || 5;
                headerActiveStudents.textContent = stats.students || 0;
                headerTotalPoints.textContent = stats.points || 0;
                return;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const questionsQuery = query(
            collection(db, 'questions'),
            where('active', '==', true)
        );
        const questionsSnapshot = await getDocs(questionsQuery);
        
        const studentsQuery = query(
            collection(db, 'students'),
            limit(200)
        );
        const studentsSnapshot = await getDocs(studentsQuery);
        
        let totalPoints = 0;
        studentsSnapshot.forEach(doc => {
            const data = doc.data();
            totalPoints += data.score || 0;
        });
        
        const stats = {
            questions: questionsSnapshot.size || 5,
            students: studentsSnapshot.size || 0,
            points: totalPoints
        };
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
        localStorage.setItem('nafis_stats_cache', JSON.stringify(stats));
        localStorage.setItem('nafis_stats_cache_time', Date.now().toString());
        
        headerTotalQuestions.textContent = stats.questions;
        headerActiveStudents.textContent = stats.students;
        headerTotalPoints.textContent = stats.points;
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
    }
}

// ==========================================
// 23. ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
// ==========================================
function autoLogin() {
    try {
        const saved = localStorage.getItem('nafis_last_login');
        if (!saved) return;
        
        const data = JSON.parse(saved);
        const hoursPassed = (Date.now() - data.timestamp) / (1000 * 60 * 60);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† 24 Ø³Ø§Ø¹Ø©
        if (hoursPassed < 24 && data.code && data.name) {
            const loginCode = document.getElementById('loginCode');
            if (loginCode) {
                loginCode.value = data.code;
            }
            
            showNotification(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: ${data.name}`, 'info');
            
            // Ø¹Ø±Ø¶ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹
            const loginSection = document.getElementById('login');
            if (loginSection) {
                const quickLoginBtn = document.createElement('button');
                quickLoginBtn.className = 'btn success';
                quickLoginBtn.textContent = `ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹ ÙƒÙ€ ${data.name}`;
                quickLoginBtn.onclick = loginStudent;
                quickLoginBtn.style.marginTop = '10px';
                
                const loginWithCode = document.getElementById('loginWithCode');
                if (loginWithCode) {
                    loginWithCode.appendChild(quickLoginBtn);
                }
            }
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
    }
}

// ==========================================
// 24. ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
// ==========================================
async function initializeQuestions() {
    try {
        const questionsSnapshot = await getDocs(collection(db, 'questions'));
        
        if (questionsSnapshot.empty) {
            console.log('Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...');
            
            for (const question of questionBank) {
                await addDoc(collection(db, 'questions'), question);
            }
            
            console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:', error);
    }
}

// ==========================================
// 25. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
// ==========================================

// Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
document.addEventListener('keydown', (event) => {
    // Enter Ù„Ù„ØªØ³Ø¬ÙŠÙ„/Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (event.key === 'Enter') {
        if (!document.getElementById('login').classList.contains('hidden')) {
            const loginCode = document.getElementById('loginCode');
            const loginName = document.getElementById('loginName');
            
            if (document.activeElement === loginCode && loginCode.value) {
                loginStudent();
            } else if (document.activeElement === loginName && loginName.value) {
                searchByName();
            }
        }
        
        if (!document.getElementById('registration').classList.contains('hidden')) {
            const studentName = document.getElementById('studentName');
            const studentGrade = document.getElementById('studentGrade');
            
            if (studentName.value && studentGrade.value) {
                registerStudent();
            }
        }
    }
    
    // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    if (!document.getElementById('testSection').classList.contains('hidden')) {
        // Ø£Ø±Ù‚Ø§Ù… 1-4 Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        if (event.key >= '1' && event.key <= '4') {
            const optionIndex = parseInt(event.key) - 1;
            const options = document.querySelectorAll('.option');
            if (options[optionIndex]) {
                selectOption(optionIndex);
            }
        }
        
        // Enter Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        if (event.key === 'Enter') {
            nextQuestion();
        }
        
        // Escape Ù„Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
        if (event.key === 'Escape') {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                saveAndExit();
            }
        }
    }
});

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
window.addEventListener('online', () => {
    showNotification('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
});

window.addEventListener('offline', () => {
    showNotification('âš ï¸ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
});

// Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
window.addEventListener('beforeunload', (event) => {
    if (currentStudent && !document.getElementById('testSection').classList.contains('hidden')) {
        event.preventDefault();
        event.returnValue = 'Ù„Ø¯ÙŠÙƒ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø§Ø±Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ';
        return event.returnValue;
    }
});

// ==========================================
// 26. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ==========================================
function initApp() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ù†Ø§Ø§ÙØ³...');
    
    showSection('registration');
    setupNameChecking();
    autoLogin();
    initializeQuestions();
    updateHeaderStats();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
    setInterval(updateHeaderStats, 5 * 60 * 1000);
    
    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ù†Ø§Ø§ÙØ³ Ø¨Ù†Ø¬Ø§Ø­');
}

// ==========================================
// 27. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
// ==========================================
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}

// Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„ØªØ´ØºÙŠÙ„
setTimeout(initApp, 1000);
