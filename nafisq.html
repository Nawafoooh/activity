<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام اختبار نافس - NAFIS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .logo {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .school-info {
            background: white;
            padding: 15px;
            margin: 20px auto;
            border-radius: 10px;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .school-info h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .school-info p {
            color: #666;
            margin: 5px 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-section, .exam-section, .results-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: none;
        }

        .login-section.active, .exam-section.active, .results-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        }

        .exam-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .exam-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }

        .exam-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .exam-card h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .exam-card .details {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .question-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
        }

        .question-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .question-number {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 50%;
            font-weight: bold;
            margin-left: 15px;
        }

        .subject-tag {
            background: #74b9ff;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .options {
            display: grid;
            gap: 15px;
        }

        .option {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .option:hover {
            background: #f0f4ff;
            border-color: #667eea;
        }

        .option.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .option.correct {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .option.wrong {
            background: #ffebee;
            border-color: #f44336;
        }

        .option-letter {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-weight: bold;
        }

        .progress-bar {
            background: #e1e5e9;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .timer {
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .results-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(#4caf50 0deg, #4caf50 252deg, #e0e0e0 252deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }

        .score-circle::before {
            content: '';
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .score-text {
            font-size: 2rem;
            font-weight: bold;
            color: #4caf50;
            z-index: 1;
        }

        .leaderboard {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .leaderboard h3 {
            text-align: center;
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.5rem;
        }

        .rank-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .rank-item:hover {
            transform: translateX(-5px);
        }

        .rank-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 15px;
        }

        .rank-1 { background: #ffd700; color: #fff; }
        .rank-2 { background: #c0c0c0; color: #fff; }
        .rank-3 { background: #cd7f32; color: #fff; }
        .rank-other { background: #667eea; color: #fff; }

        .student-info {
            flex: 1;
            margin-left: 15px;
        }

        .student-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
        }

        .student-details {
            color: #666;
            font-size: 0.9rem;
        }

        .student-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .footer {
            background: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 50px;
        }

        .explanation {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .explanation.show {
            display: block;
        }

        .explanation h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .explanation p {
            color: #856404;
            line-height: 1.5;
        }

        .hidden {
            display: none;
        }

        .navbar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .student-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #333;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .exam-types {
                grid-template-columns: 1fr;
            }
            
            .question-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>نظام اختبار نافس</h1>
        <div class="logo">NAFIS Examination System</div>
    </div>

    <!-- School Info -->
    <div class="school-info">
        <h2>المملكة العربية السعودية</h2>
        <p>وزارة التعليم</p>
        <p>قطاع أحد والعوالي</p>
        <p><strong>متوسطة المنذر بن عمرو الأنصاري</strong></p>
        <p>مدير المدرسة: خالد المطيري</p>
    </div>

    <div class="container">
        <!-- Navigation -->
        <div class="navbar">
            <div class="nav-btn active" onclick="showSection('login')">تسجيل الدخول</div>
            <div class="nav-btn" onclick="showSection('results')">النتائج العامة</div>
        </div>

        <!-- Student Login Section -->
        <div class="login-section active" id="loginSection">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">مرحباً بك في نظام اختبار نافس</h2>
            
            <!-- Previous Student Login -->
            <div id="previousStudentCard" class="student-card hidden">
                <h3>مرحباً بعودتك!</h3>
                <p><strong>رقم الطالب:</strong> <span id="prevStudentId"></span></p>
                <p><strong>الاسم:</strong> <span id="prevDisplayName"></span></p>
                <p><strong>الصف والشعبة:</strong> <span id="prevDisplayGradeSection"></span></p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
                    <button class="btn btn-success" onclick="continueWithPreviousStudent()">الدخول بحسابك السابق</button>
                    <button class="btn" onclick="showNewStudentForm()">تسجيل حساب جديد</button>
                </div>
            </div>

            <!-- New Student Registration -->
            <div id="newStudentForm">
                <div class="form-group">
                    <label for="studentName">الاسم الثلاثي:</label>
                    <input type="text" id="studentName" placeholder="أدخل اسمك الثلاثي" />
                </div>

                <div class="form-group">
                    <label for="studentGrade">الصف:</label>
                    <select id="studentGrade">
                        <option value="">اختر الصف</option>
                        <option value="first">الأول متوسط</option>
                        <option value="second">الثاني متوسط</option>
                        <option value="third">الثالث متوسط</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="studentSection">الشعبة:</label>
                    <select id="studentSection">
                        <option value="">اختر الشعبة</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>

                <button class="btn" onclick="registerStudent()">إنشاء حساب والدخول</button>
            </div>

            <div id="studentCard" class="student-card hidden">
                <h3>أهلاً بك!</h3>
                <p><strong>رقم الطالب:</strong> <span id="studentId"></span></p>
                <p><strong>الاسم:</strong> <span id="displayName"></span></p>
                <p><strong>الصف والشعبة:</strong> <span id="displayGradeSection"></span></p>
                <button class="btn btn-success" onclick="showExams()">ابدأ الاختبار</button>
            </div>
        </div>

        <!-- Exam Selection Section -->
        <div class="exam-section" id="examSection">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">اختر نوع الاختبار</h2>
            
            <div class="exam-types">
                <div class="exam-card" onclick="startExam('daily')">
                    <h3>الاختبار اليومي</h3>
                    <div class="details">
                        <p>7 أسئلة متنوعة</p>
                        <p>الوقت: 10 دقائق</p>
                        <p>المواد: رياضيات، علوم، قراءة</p>
                    </div>
                    <div class="btn btn-secondary" style="width: auto; padding: 10px 20px;">ابدأ الآن</div>
                </div>

                <div class="exam-card" onclick="startExam('weekly')">
                    <h3>الاختبار الأسبوعي</h3>
                    <div class="details">
                        <p>40 سؤال شامل</p>
                        <p>الوقت: 60 دقيقة</p>
                        <p>إمكانية الحفظ والمتابعة</p>
                    </div>
                    <div class="btn btn-secondary" style="width: auto; padding: 10px 20px;">ابدأ الآن</div>
                </div>
            </div>

            <button class="btn" onclick="showSection('login')">العودة للصفحة الرئيسية</button>
        </div>

        <!-- Question Section -->
        <div class="exam-section" id="questionSection">
            <div class="question-container">
                <div class="question-header">
                    <div style="display: flex; align-items: center;">
                        <div class="question-number" id="questionNumber">1</div>
                        <div>
                            <div class="subject-tag" id="questionSubject">رياضيات</div>
                        </div>
                    </div>
                    <div class="timer" id="timer">10:00</div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="question-text" id="questionText">
                    ما قيمة 7 × (3 + 2) ؟
                </div>

                <div class="options" id="optionsContainer">
                    <div class="option" onclick="selectOption(0)">
                        <div class="option-letter">أ</div>
                        <span>21</span>
                    </div>
                    <div class="option" onclick="selectOption(1)">
                        <div class="option-letter">ب</div>
                        <span>35</span>
                    </div>
                    <div class="option" onclick="selectOption(2)">
                        <div class="option-letter">ج</div>
                        <span>14</span>
                    </div>
                    <div class="option" onclick="selectOption(3)">
                        <div class="option-letter">د</div>
                        <span>10</span>
                    </div>
                </div>

                <div class="explanation" id="explanation">
                    <h4>التفسير:</h4>
                    <p id="explanationText">نحسب داخل القوس أولاً 3+2=5، ثم 7×5=35.</p>
                </div>

                <div class="navigation">
                    <button class="btn" id="prevBtn" onclick="previousQuestion()" disabled>السؤال السابق</button>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <span id="questionProgress">السؤال 1 من 7</span>
                        <button class="btn btn-secondary" onclick="showResults()">عرض النتيجة</button>
                    </div>
                    <button class="btn" id="nextBtn" onclick="nextQuestion()">السؤال التالي</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <div class="results-card">
                <h2 style="color: #667eea; margin-bottom: 30px;">نتيجة الاختبار</h2>
                
                <div class="score-circle" id="scoreCircle">
                    <div class="score-text" id="scoreText">85%</div>
                </div>

                <div style="margin: 30px 0;">
                    <h3 id="scoreDetails">لقد أجبت على 6 من أصل 7 أسئلة بشكل صحيح</h3>
                    <p style="color: #666; margin: 15px 0;">درجتك: <span id="totalScore">85/100</span></p>
                    <p style="color: #666;">ترتيبك على الصف: <span id="classRank">3</span></p>
                    <p style="color: #666;">ترتيبك على المدرسة: <span id="schoolRank">15</span></p>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="startExam('daily')">إعادة الاختبار</button>
                    <button class="btn" onclick="showExams()">اختبار آخر</button>
                </div>
            </div>

            <!-- Class Leaderboard -->
            <div class="leaderboard">
                <h3>أوائل الصف</h3>
                <div id="classLeaderboard">
                    <div class="rank-item">
                        <div class="rank-number rank-1">1</div>
                        <div class="student-info">
                            <div class="student-name">أحمد محمد العلي</div>
                            <div class="student-details">الأول متوسط - شعبة 1</div>
                        </div>
                        <div class="student-score">95</div>
                    </div>
                    <div class="rank-item">
                        <div class="rank-number rank-2">2</div>
                        <div class="student-info">
                            <div class="student-name">فاطمة سعد الغامدي</div>
                            <div class="student-details">الأول متوسط - شعبة 1</div>
                        </div>
                        <div class="student-score">92</div>
                    </div>
                    <div class="rank-item">
                        <div class="rank-number rank-3">3</div>
                        <div class="student-info">
                            <div class="student-name">عبدالله خالد السعدي</div>
                            <div class="student-details">الأول متوسط - شعبة 1</div>
                        </div>
                        <div class="student-score">85</div>
                    </div>
                </div>
            </div>

            <!-- School Leaderboard -->
            <div class="leaderboard">
                <h3>أوائل المدرسة</h3>
                <div id="schoolLeaderboard">
                    <div class="rank-item">
                        <div class="rank-number rank-1">1</div>
                        <div class="student-info">
                            <div class="student-name">محمد عبدالرحمن الأحمد</div>
                            <div class="student-details">الثالث متوسط - شعبة 2</div>
                        </div>
                        <div class="student-score">98</div>
                    </div>
                    <div class="rank-item">
                        <div class="rank-number rank-2">2</div>
                        <div class="student-info">
                            <div class="student-name">نورا صالح القحطاني</div>
                            <div class="student-details">الثاني متوسط - شعبة 3</div>
                        </div>
                        <div class="student-score">96</div>
                    </div>
                    <div class="rank-item">
                        <div class="rank-number rank-3">3</div>
                        <div class="student-info">
                            <div class="student-name">يوسف أحمد المطيري</div>
                            <div class="student-details">الثالث متوسط - شعبة 1</div>
                        </div>
                        <div class="student-score">94</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>إشراف وتنفيذ: نواف الصبحي</p>
        <p>نظام اختبار نافس - NAFIS Exam System © 2025</p>
    </div>

    <script type="module">
        // Firebase Configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCaobeGSq0ra52WWNHIUgVZyoTg_NME5DY",
            authDomain: "nafis-exam.firebaseapp.com",
            projectId: "nafis-exam",
            storageBucket: "nafis-exam.firebasestorage.app",
            messagingSenderId: "985354903005",
            appId: "1:985354903005:web:d0d028d80d47bd30392a34",
            measurementId: "G-MME7J94SRN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let currentStudent = null;
        let currentExamType = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let studentAnswers = [];
        let examTimer = null;
        let timeLeft = 0;

        // Sample questions data (will be replaced with Firebase data)
        const sampleQuestions = {
            daily: [
                {
                    subject: "علوم",
                    question: "أي مما يلي يعد من مصادر الطاقة المتجددة؟",
                    options: ["الفحم", "النفط", "الرياح", "الغاز الطبيعي"],
                    correct: 2,
                    explanation: "الرياح مصدر طاقة متجددة لأنها لا تنفد."
                },
                {
                    subject: "علوم",
                    question: "العضو المسؤول عن تنقية الدم من الفضلات هو:",
                    options: ["القلب", "الكبد", "الكلى", "الرئة"],
                    correct: 2,
                    explanation: "الكليتان تقومان بتنقية الدم من الفضلات وإخراجها في البول."
                },
                {
                    subject: "قراءة",
                    question: "نوع الأسلوب في: (ليت الشباب يعود يوماً) هو:",
                    options: ["تمني", "نداء", "أمر", "استفهام"],
                    correct: 0,
                    explanation: "الجملة تبدأ بأداة التمني (ليت)."
                },
                {
                    subject: "قراءة",
                    question: "جمع كلمة (مدينة) هو:",
                    options: ["مدن", "مدائن", "مدونات", "مديون"],
                    correct: 0,
                    explanation: "جمع كلمة مدينة هو مدن."
                },
                {
                    subject: "رياضيات",
                    question: "احسب: 8 × 7",
                    options: ["54", "56", "64", "72"],
                    correct: 1,
                    explanation: "8 × 7 = 56."
                },
                {
                    subject: "رياضيات",
                    question: "إذا كان طول المستطيل 10 سم وعرضه 4 سم، فما مساحته؟",
                    options: ["14", "20", "30", "40"],
                    correct: 3,
                    explanation: "المساحة = الطول × العرض = 10 × 4 = 40."
                },
                {
                    subject: "رياضيات",
                    question: "الناتج النهائي لـ 3² + 4² هو:",
                    options: ["12", "17", "25", "49"],
                    correct: 2,
                    explanation: "3²=9 و 4²=16 → المجموع = 25."
                }
            ],
            weekly: [
                {
                    subject: "رياضيات",
                    question: "ما قيمة 7 × (3 + 2) ؟",
                    options: ["21", "35", "14", "10"],
                    correct: 1,
                    explanation: "نحسب داخل القوس أولاً 3+2=5، ثم 7×5=35."
                },
                {
                    subject: "رياضيات",
                    question: "إذا كان محيط المربع 36 سم، فما طول ضلعه؟",
                    options: ["6", "8", "9", "12"],
                    correct: 2,
                    explanation: "محيط المربع = 4 × الضلع → 36 ÷ 4 = 9."
                },
                {
                    subject: "رياضيات",
                    question: "الكسر المكافئ لـ 2/3 هو:",
                    options: ["4/5", "6/9", "8/10", "10/18"],
                    correct: 1,
                    explanation: "2/3 × 3 = 6/9، إذن الكسر المكافئ 6/9."
                },
                {
                    subject: "رياضيات",
                    question: "إذا اشترى طالب 3 دفاتر سعر الواحد 5 ريالات، فكم دفع؟",
                    options: ["8", "10", "12", "15"],
                    correct: 3,
                    explanation: "3 × 5 = 15 ريال."
                },
                {
                    subject: "رياضيات",
                    question: "ناتج 2/5 + 3/5 يساوي:",
                    options: ["1/5", "5/5", "4/5", "2/10"],
                    correct: 1,
                    explanation: "المقام نفسه، نجمع البسط: 2+3=5، الناتج 5/5 = 1."
                }
            ]
        };

        // Functions
        window.showSection = function(section) {
            // Hide all sections
            document.querySelectorAll('.login-section, .exam-section, .results-section').forEach(s => {
                s.classList.remove('active');
            });
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            if (section === 'login') {
                document.getElementById('loginSection').classList.add('active');
                document.querySelector('.nav-btn').classList.add('active');
            } else if (section === 'results') {
                document.getElementById('resultsSection').classList.add('active');
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                loadLeaderboards();
            }
        };

        window.showNewStudentForm = function() {
            document.getElementById('previousStudentCard').classList.add('hidden');
            document.getElementById('newStudentForm').style.display = 'block';
        };

        window.continueWithPreviousStudent = function() {
            const savedStudent = localStorage.getItem('nafisStudent');
            if (savedStudent) {
                try {
                    currentStudent = JSON.parse(savedStudent);
                    document.getElementById('studentId').textContent = currentStudent.id;
                    document.getElementById('displayName').textContent = currentStudent.name;
                    document.getElementById('displayGradeSection').textContent = 
                        getGradeName(currentStudent.grade) + ' - شعبة ' + currentStudent.section;
                    document.getElementById('studentCard').classList.remove('hidden');
                    document.getElementById('previousStudentCard').classList.add('hidden');
                    document.getElementById('newStudentForm').style.display = 'none';
                } catch (error) {
                    console.error('خطأ في تحميل بيانات الطالب:', error);
                    alert('حدث خطأ في تحميل بيانات الطالب. الرجاء المحاولة مرة أخرى.');
                }
            }
        };

        window.registerStudent = async function() {
            const name = document.getElementById('studentName').value.trim();
            const grade = document.getElementById('studentGrade').value;
            const section = document.getElementById('studentSection').value;

            if (!name || !grade || !section) {
                alert('الرجاء ملء جميع البيانات');
                return;
            }

            try {
                // Generate student ID
                const studentId = 'STU' + Date.now().toString().slice(-6);
                
                // Save student to Firebase
                const studentData = {
                    id: studentId,
                    name: name,
                    grade: grade,
                    section: section,
                    createdAt: new Date(),
                    totalScore: 0,
                    examsTaken: 0
                };

                await addDoc(collection(db, 'students'), studentData);
                
                currentStudent = studentData;
                
                // Show student card
                document.getElementById('studentId').textContent = studentId;
                document.getElementById('displayName').textContent = name;
                document.getElementById('displayGradeSection').textContent = 
                    getGradeName(grade) + ' - شعبة ' + section;
                document.getElementById('studentCard').classList.remove('hidden');
                
                // Hide form and previous student card
                document.getElementById('newStudentForm').style.display = 'none';
                document.getElementById('previousStudentCard').classList.add('hidden');
                
                // Save to localStorage for future visits
                localStorage.setItem('nafisStudent', JSON.stringify(studentData));
                
            } catch (error) {
                console.error('خطأ في التسجيل:', error);
                alert('حدث خطأ أثناء التسجيل. الرجاء المحاولة مرة أخرى.');
            }
        };

        window.showExams = function() {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('examSection').classList.add('active');
        };

        window.startExam = function(type) {
            currentExamType = type;
            currentQuestions = [...sampleQuestions[type]];
            currentQuestionIndex = 0;
            studentAnswers = new Array(currentQuestions.length).fill(-1);
            
            // Set timer
            timeLeft = type === 'daily' ? 600 : 3600; // 10 min for daily, 60 min for weekly
            
            document.getElementById('examSection').classList.remove('active');
            document.getElementById('questionSection').classList.add('active');
            
            startTimer();
            loadQuestion();
        };

        function startTimer() {
            examTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(examTimer);
                    finishExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function loadQuestion() {
            const question = currentQuestions[currentQuestionIndex];
            
            document.getElementById('questionNumber').textContent = currentQuestionIndex + 1;
            document.getElementById('questionSubject').textContent = question.subject;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('explanationText').textContent = question.explanation;
            
            // Load options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            const optionLetters = ['أ', 'ب', 'ج', 'د'];
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.onclick = () => selectOption(index);
                
                if (studentAnswers[currentQuestionIndex] === index) {
                    optionDiv.classList.add('selected');
                }
                
                optionDiv.innerHTML = `
                    <div class="option-letter">${optionLetters[index]}</div>
                    <span>${option}</span>
                `;
                
                optionsContainer.appendChild(optionDiv);
            });
            
            // Update progress
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('questionProgress').textContent = 
                `السؤال ${currentQuestionIndex + 1} من ${currentQuestions.length}`;
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').textContent = 
                currentQuestionIndex === currentQuestions.length - 1 ? 'إنهاء الاختبار' : 'السؤال التالي';
            
            // Hide explanation
            document.getElementById('explanation').classList.remove('show');
        }

        window.selectOption = function(optionIndex) {
            studentAnswers[currentQuestionIndex] = optionIndex;
            
            // Update visual selection
            document.querySelectorAll('.option').forEach((option, index) => {
                option.classList.remove('selected');
                if (index === optionIndex) {
                    option.classList.add('selected');
                }
            });
        };

        window.previousQuestion = function() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        };

        window.nextQuestion = function() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                finishExam();
            }
        };

        window.showResults = function() {
            finishExam();
        };

        function finishExam() {
            clearInterval(examTimer);
            
            // Calculate score
            let correctAnswers = 0;
            currentQuestions.forEach((question, index) => {
                if (studentAnswers[index] === question.correct) {
                    correctAnswers++;
                }
            });
            
            const percentage = Math.round((correctAnswers / currentQuestions.length) * 100);
            const score = Math.round((correctAnswers / currentQuestions.length) * 100);
            
            // Save result to Firebase
            saveExamResult(correctAnswers, currentQuestions.length, percentage);
            
            // Calculate and display student rankings
            calculateStudentRanking(percentage);
            
            // Update UI
            document.getElementById('scoreText').textContent = percentage + '%';
            document.getElementById('scoreDetails').textContent = 
                `لقد أجبت على ${correctAnswers} من أصل ${currentQuestions.length} أسئلة بشكل صحيح`;
            document.getElementById('totalScore').textContent = `${score}/100`;
            
            // Update score circle
            const circle = document.getElementById('scoreCircle');
            const degrees = (percentage / 100) * 360;
            circle.style.background = `conic-gradient(#4caf50 0deg, #4caf50 ${degrees}deg, #e0e0e0 ${degrees}deg)`;
            
            // Show results section
            document.getElementById('questionSection').classList.remove('active');
            document.getElementById('resultsSection').classList.add('active');
            
            // Load rankings
            loadLeaderboards();
        }

        async function calculateStudentRanking(studentScore) {
            try {
                if (!currentStudent) return;

                // Get all results for the same class
                const classQuery = query(
                    collection(db, 'testResults'),
                    where('grade', '==', currentStudent.grade),
                    where('section', '==', currentStudent.section),
                    orderBy('percentage', 'desc')
                );
                
                const classResults = await getDocs(classQuery);
                const classScores = [];
                const seenStudents = new Set();
                
                classResults.forEach(doc => {
                    const data = doc.data();
                    if (!seenStudents.has(data.studentId)) {
                        classScores.push(data.percentage);
                        seenStudents.add(data.studentId);
                    }
                });

                // Calculate class rank
                const higherClassScores = classScores.filter(score => score > studentScore);
                const classRank = higherClassScores.length + 1;

                // Get all results for the school
                const schoolQuery = query(
                    collection(db, 'testResults'),
                    orderBy('percentage', 'desc')
                );
                
                const schoolResults = await getDocs(schoolQuery);
                const schoolScores = [];
                const seenSchoolStudents = new Set();
                
                schoolResults.forEach(doc => {
                    const data = doc.data();
                    if (!seenSchoolStudents.has(data.studentId)) {
                        schoolScores.push(data.percentage);
                        seenSchoolStudents.add(data.studentId);
                    }
                });

                // Calculate school rank
                const higherSchoolScores = schoolScores.filter(score => score > studentScore);
                const schoolRank = higherSchoolScores.length + 1;

                // Update UI
                document.getElementById('classRank').textContent = classRank;
                document.getElementById('schoolRank').textContent = schoolRank;

            } catch (error) {
                console.error('خطأ في حساب الترتيب:', error);
                document.getElementById('classRank').textContent = 'غير متاح';
                document.getElementById('schoolRank').textContent = 'غير متاح';
            }
        }
            try {
                const result = {
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    grade: currentStudent.grade,
                    section: currentStudent.section,
                    examType: currentExamType,
                    correctAnswers: correct,
                    totalQuestions: total,
                    percentage: percentage,
                    answers: studentAnswers,
                    timestamp: new Date()
                };
                
                await addDoc(collection(db, 'testResults'), result);
                console.log('تم حفظ النتيجة بنجاح');
            } catch (error) {
                console.error('خطأ في حفظ النتيجة:', error);
            }
        }

        async function loadLeaderboards() {
            try {
                // Load class leaderboard
                if (currentStudent) {
                    const classQuery = query(
                        collection(db, 'testResults'),
                        where('grade', '==', currentStudent.grade),
                        where('section', '==', currentStudent.section),
                        orderBy('percentage', 'desc')
                    );
                    
                    const classResults = await getDocs(classQuery);
                    displayLeaderboard('classLeaderboard', classResults, true);
                }
                
                // Load school leaderboard
                const schoolQuery = query(
                    collection(db, 'testResults'),
                    orderBy('percentage', 'desc')
                );
                
                const schoolResults = await getDocs(schoolQuery);
                displayLeaderboard('schoolLeaderboard', schoolResults, false);
                
            } catch (error) {
                console.error('خطأ في تحميل النتائج:', error);
            }
        }

        function displayLeaderboard(containerId, results, isClass) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const topStudents = [];
            const seenStudents = new Set();
            
            results.forEach(doc => {
                const data = doc.data();
                if (!seenStudents.has(data.studentId) && topStudents.length < 3) {
                    topStudents.push(data);
                    seenStudents.add(data.studentId);
                }
            });
            
            topStudents.forEach((student, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'rank-item';
                
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : 'rank-3';
                const gradeText = getGradeName(student.grade);
                
                rankItem.innerHTML = `
                    <div class="rank-number ${rankClass}">${index + 1}</div>
                    <div class="student-info">
                        <div class="student-name">${student.studentName}</div>
                        <div class="student-details">${gradeText} - شعبة ${student.section}</div>
                    </div>
                    <div class="student-score">${student.percentage}</div>
                `;
                
                container.appendChild(rankItem);
            });
        }

        function getGradeName(grade) {
            const gradeNames = {
                'first': 'الأول متوسط',
                'second': 'الثاني متوسط',
                'third': 'الثالث متوسط'
            };
            return gradeNames[grade] || grade;
        }

        // Debug function to check if elements exist
        function checkElements() {
            const elements = [
                'studentName', 'studentGrade', 'studentSection',
                'prevStudentId', 'prevDisplayName', 'prevDisplayGradeSection',
                'studentId', 'displayName', 'displayGradeSection',
                'previousStudentCard', 'newStudentForm', 'studentCard'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (!element) {
                    console.error(`Element with ID '${id}' not found`);
                } else {
                    console.log(`Element '${id}' found`);
                }
            });
        }

        // Call debug function on load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            checkElements();
        });

        // Check for existing student on page load
        window.addEventListener('load', () => {
            const savedStudent = localStorage.getItem('nafisStudent');
            if (savedStudent) {
                try {
                    currentStudent = JSON.parse(savedStudent);
                    
                    // Show previous student card
                    document.getElementById('prevStudentId').textContent = currentStudent.id;
                    document.getElementById('prevDisplayName').textContent = currentStudent.name;
                    document.getElementById('prevDisplayGradeSection').textContent = 
                        getGradeName(currentStudent.grade) + ' - شعبة ' + currentStudent.section;
                    document.getElementById('previousStudentCard').classList.remove('hidden');
                    document.getElementById('newStudentForm').style.display = 'none';
                } catch (error) {
                    console.error('خطأ في تحميل بيانات الطالب المحفوظة:', error);
                    document.getElementById('newStudentForm').style.display = 'block';
                }
            } else {
                document.getElementById('newStudentForm').style.display = 'block';
            }
        });

        // Auto-save progress for weekly exams
        setInterval(() => {
            if (currentExamType === 'weekly' && studentAnswers.some(answer => answer !== -1)) {
                // Save progress to localStorage
                const progress = {
                    examType: currentExamType,
                    questionIndex: currentQuestionIndex,
                    answers: studentAnswers,
                    timeLeft: timeLeft,
                    timestamp: Date.now()
                };
                localStorage.setItem('examProgress', JSON.stringify(progress));
            }
        }, 30000); // Save every 30 seconds

        // Make functions globally available
        window.db = db;
        window.addDoc = addDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
    </script>
</body>
</html>
