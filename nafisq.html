<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø§ÙØ³ - NAFIS Exam System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            color: #333;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }

        .connection-indicator {
            position: absolute;
            top: 15px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 5px 12px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .connection-indicator.online {
            background: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }

        .connection-indicator.offline {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        .sync-indicator {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-indicator.active {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .sync-indicator.success {
            background: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
        }

        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            max-width: 300px;
            z-index: 9999;
            font-family: monospace;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .school-info h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .school-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .section-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: block;
            margin: 10px auto;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f5f99);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #e67e22, #d35400);
        }

        .btn-secondary:hover {
            background: linear-gradient(45deg, #d35400, #a04000);
        }

        .test-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .test-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-card:hover {
            transform: scale(1.05);
        }

        .test-card.weekly {
            background: linear-gradient(135deg, #fd79a8, #e84393);
        }

        .student-code-display {
            text-align: center;
            padding: 30px;
        }

        .generated-code {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 32px;
            font-weight: bold;
        }

        .question-container {
            display: none;
            text-align: center;
        }

        .question {
            font-size: 18px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .options {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }

        .option {
            padding: 15px;
            background: #e8f4fd;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: #d1ecf1;
            border-color: #3498db;
        }

        .option.selected {
            background: #3498db;
            color: white;
        }

        .option.correct {
            background: #27ae60;
            color: white;
        }

        .option.wrong {
            background: #e74c3c;
            color: white;
        }

        .progress {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .nav-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .score-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            font-weight: bold;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .warning-box {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .rank-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .rank-item.current-student {
            background: #fff5f5;
            border: 2px solid #e74c3c;
        }

        .footer {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            margin-top: 40px;
            border-radius: 15px;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .test-sections {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="connection-indicator offline" id="connectionStatus">
            <div class="connection-dot"></div>
            <span>ØºÙŠØ± Ù…ØªØµÙ„</span>
        </div>
        <div class="sync-indicator" id="syncStatus">
            <div class="connection-dot"></div>
            <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <div class="logo">
            <div class="logo-icon">Ù†Ø§ÙØ³</div>
            <div class="school-info">
                <h1>Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</h1>
                <p>Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</p>
                <p>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… - Ù‚Ø·Ø§Ø¹ Ø£Ø­Ø¯ ÙˆØ§Ù„Ø¹ÙˆØ§Ù„ÙŠÙ…</p>
                <p>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø®Ø§Ù„Ø¯ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
        <div class="card" id="studentForm">
            <h2 class="section-title">ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
                    <input type="text" id="firstName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„">
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø¨</label>
                    <input type="text" id="fatherName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø£Ø¨">
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯</label>
                    <input type="text" id="grandFatherName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯">
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
                    <input type="text" id="familyName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØµÙ</label>
                    <select id="grade">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                        <option value="Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·">Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option>
                        <option value="Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·">Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option>
                        <option value="Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·">Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
                    <select id="section">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="registerStudent()">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù…ÙŠ Ø§Ù„Ø®Ø§Øµ</button>
            <button class="btn btn-secondary" onclick="showLoginForm()">Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹</button>
        </div>

        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø®Ø§Øµ -->
        <div class="card" id="studentCodeDisplay" style="display: none;">
            <h2 class="section-title">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø¬Ø§Ø­</h2>
            <div class="student-code-display">
                <div class="generated-code">
                    <h3>Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ Ù‡Ùˆ:</h3>
                    <div id="generatedCode" style="margin-top: 15px;"></div>
                </div>
                <button class="btn" onclick="proceedToLogin()">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            </div>
        </div>

        <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div class="card" id="loginForm" style="display: none;">
            <h2 class="section-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="loginFullName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ</label>
                    <input type="text" id="studentCode" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ (6 Ø£Ø±Ù‚Ø§Ù…)" maxlength="6">
                </div>
            </div>
            <button class="btn" onclick="loginStudent()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            <button class="btn btn-secondary" onclick="backToRegistration()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„</button>
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
        <div class="card" id="testSelection" style="display: none;">
            <h2 class="section-title">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            
            <div class="warning-box">
                <h4>ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…</h4>
                <p><strong>ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø¬Ø±Ø§Ø¡ ÙƒÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·!</strong></p>
            </div>
            
            <div class="test-sections">
                <div class="test-card" onclick="confirmAndStartTest('daily')">
                    <h3>Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
                    <p id="dailyQuestionsCount">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>
                    <p><strong>Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª - Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© - Ø§Ù„Ø¹Ù„ÙˆÙ…</strong></p>
                </div>
                <div class="test-card weekly" onclick="confirmAndStartTest('weekly')">
                    <h3>Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
                    <p id="weeklyQuestionsCount">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>
                    <p><strong>Ø§Ø®ØªØ¨Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠ Ø£Ø³Ø¨ÙˆØ¹ÙŠ</strong></p>
                </div>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
        <div class="card question-container" id="questionArea">
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn" id="prevBtn" onclick="previousQuestion()" disabled>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <span id="questionNumber">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 7</span>
                <button class="nav-btn" id="nextBtn" onclick="nextQuestion()">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>

            <div class="question" id="questionText">
                <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø§ÙØ³!</p>
            </div>

            <div class="options" id="optionsContainer">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§ -->
            </div>

            <div class="score-display" id="scoreDisplay">
                <p>Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span id="finalScore">0</span> Ù…Ù† <span id="totalQuestions">7</span></p>
                <p>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: <span id="percentage">0%</span></p>
                <div class="rank-display" id="rankDisplay">
                    <h4>ØªØ±ØªÙŠØ¨Ùƒ:</h4>
                    <p>ØªØ±ØªÙŠØ¨Ùƒ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ: <span id="classRank">-</span></p>
                    <p>ØªØ±ØªÙŠØ¨Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <span id="schoolRank">-</span></p>
                </div>
            </div>

            <button class="btn" id="submitBtn" onclick="submitAnswer()" style="display: none;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
            <button class="btn" id="finishBtn" onclick="handleFinishTest()" style="display: none;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            <button class="btn" id="homeBtn" onclick="goHome()" style="display: none;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>

        <!-- Ù…Ø±ØªØ¨Ø© Ø§Ù„Ø´Ø±Ù -->
        <div class="card" id="leaderboardCard" style="display: none;">
            <h2 class="section-title">Ù…Ø±ØªØ¨Ø© Ø§Ù„Ø´Ø±Ù</h2>
            <div id="leaderboard">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‡Ù†Ø§ -->
            </div>
        </div>
    </div>

    <div class="footer">
        <p><strong>Ø¥Ø´Ø±Ø§Ù ÙˆØªÙ†ÙÙŠØ°: Ø§Ù„Ø£Ø³ØªØ§Ø° Ù†ÙˆØ§Ù Ø§Ù„ØµØ¨Ø­ÙŠ</strong></p>
        <p>Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ - Ù…ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ</p>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div id="debugInfo">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
    </div>

    <script>
        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ²Ø§Ù…Ù† Ø§Ù„Ù…Ø­Ø³Ù† Ù„ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
        class StudentSyncReceiver {
            constructor() {
                this.isListening = false;
                this.receivedData = false;
                this.broadcastChannel = null;
                this.debugLog = [];
                
                this.initializeSystem();
                this.startListening();
                this.loadInitialData();
            }

            initializeSystem() {
                this.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...');
                
                // Ø¥Ù†Ø´Ø§Ø¡ BroadcastChannel Ù„Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
                try {
                    this.broadcastChannel = new BroadcastChannel('nafis-sync-channel');
                    this.broadcastChannel.onmessage = (event) => this.handleBroadcastMessage(event);
                    this.log('âœ… BroadcastChannel Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„');
                } catch (error) {
                    this.log('âš ï¸ BroadcastChannel ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage ÙÙ‚Ø·');
                }

                this.updateSyncStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...');
            }

            startListening() {
                if (this.isListening) return;
                this.isListening = true;

                // Ù…Ø±Ø§Ù‚Ø¨Ø© localStorage events
                window.addEventListener('storage', (event) => this.handleStorageEvent(event));
                
                // Ù…Ø±Ø§Ù‚Ø¨Ø© postMessage events
                window.addEventListener('message', (event) => this.handleMessageEvent(event));

                // ÙØ­Øµ Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                this.startPeriodicCheck();
                
                this.log('ğŸ‘‚ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªØ²Ø§Ù…Ù†');
            }

            handleBroadcastMessage(event) {
                const { type, data, timestamp, source } = event.data;
                this.log(`ğŸ“¨ Ø±Ø³Ø§Ù„Ø© BroadcastChannel: ${type} Ù…Ù† ${source}`);
                
                if (type === 'QUESTIONS_SYNC' || type === 'FORCE_REFRESH') {
                    this.processQuestionsUpdate(data);
                }
            }

            handleStorageEvent(event) {
                if (!event.key) return;
                
                this.log(`ğŸ’¾ ØªØ­Ø¯ÙŠØ« localStorage: ${event.key}`);
                
                if (event.key.includes('Questions') || event.key.includes('nafis')) {
                    this.checkForNewQuestions();
                }
            }

            handleMessageEvent(event) {
                if (!event.data || typeof event.data !== 'object') return;
                
                const { type, data } = event.data;
                if (type && type.includes('QUESTIONS') || type.includes('NAFIS')) {
                    this.log(`ğŸ“¬ Ø±Ø³Ø§Ù„Ø© PostMessage: ${type}`);
                    this.checkForNewQuestions();
                }
            }

            loadInitialData() {
                this.log('ğŸ“‹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©...');
                this.checkForNewQuestions();
                
                // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => {
                    if (!this.receivedData) {
                        this.log('â° ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                        this.checkForNewQuestions();
                    }
                }, 2000);
            }

            checkForNewQuestions() {
                try {
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                    const dailyData = localStorage.getItem('nafisMainDailyQuestions');
                    if (dailyData) {
                        const dailyQuestions = JSON.parse(dailyData);
                        if (dailyQuestions && dailyQuestions.length > 0) {
                            window.dailyQuestions = dailyQuestions;
                            this.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${dailyQuestions.length} Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠ`);
                            this.receivedData = true;
                        }
                    }

                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©
                    const weeklyData = localStorage.getItem('nafisMainWeeklyQuestions');
                    if (weeklyData) {
                        const weeklyQuestions = JSON.parse(weeklyData);
                        if (weeklyQuestions && weeklyQuestions.length > 0) {
                            window.weeklyQuestions = weeklyQuestions;
                            this.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${weeklyQuestions.length} Ø³Ø¤Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ`);
                            this.receivedData = true;
                        }
                    }

                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù…ÙØ§ØªÙŠØ­ Ø¨Ø¯ÙŠÙ„Ø©
                    this.tryAlternativeKeys();

                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    this.updateQuestionsDisplay();

                    if (this.receivedData) {
                        this.updateSyncStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        this.showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¦Ù„Ø©!');
                    } else {
                        this.updateSyncStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'error');
                    }

                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${error.message}`);
                    this.updateSyncStatus('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
                }
            }

            tryAlternativeKeys() {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
                const possibleKeys = [
                    'adminDailyQuestions',
                    'adminWeeklyQuestions',
                    'nafes_exam',
                    'daily',
                    'weekly'
                ];

                possibleKeys.forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const questions = JSON.parse(data);
                            if (Array.isArray(questions) && questions.length > 0) {
                                this.log(`ğŸ” Ø¹Ø«Ø± Ø¹Ù„Ù‰ ${questions.length} Ø³Ø¤Ø§Ù„ ÙÙŠ Ø§Ù„Ù…ÙØªØ§Ø­: ${key}`);
                                
                                if (key.includes('daily') || key.includes('Daily')) {
                                    window.dailyQuestions = questions;
                                } else {
                                    window.weeklyQuestions = questions;
                                }
                                this.receivedData = true;
                            }
                        } catch (e) {
                            this.log(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ${key}: ${e.message}`);
                        }
                    }
                });
            }

            startPeriodicCheck() {
                // ÙØ­Øµ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
                setInterval(() => {
                    if (!this.receivedData) {
                        this.log('ğŸ”„ ÙØ­Øµ Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...');
                        this.checkForNewQuestions();
                    }
                }, 10000);
            }

            processQuestionsUpdate(data) {
                if (data && data.questions) {
                    const { questionType, questions } = data;
                    
                    if (questionType === 'daily') {
                        window.dailyQuestions = questions;
                        this.log(`ğŸ“¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ${questions.length} Ø³Ø¤Ø§Ù„`);
                    } else {
                        window.weeklyQuestions = questions;
                        this.log(`ğŸ“¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: ${questions.length} Ø³Ø¤Ø§Ù„`);
                    }
                    
                    this.receivedData = true;
                    this.updateQuestionsDisplay();
                }
            }

            updateQuestionsDisplay() {
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                const dailyCount = window.dailyQuestions ? window.dailyQuestions.length : 0;
                const weeklyCount = window.weeklyQuestions ? window.weeklyQuestions.length : 0;

                const dailyCountEl = document.getElementById('dailyQuestionsCount');
                const weeklyCountEl = document.getElementById('weeklyQuestionsCount');

                if (dailyCountEl) {
                    dailyCountEl.textContent = dailyCount > 0 ? 
                        `${dailyCount} Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ†ÙˆØ¹Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø«Ù„Ø§Ø«` : 
                        'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹';
                }

                if (weeklyCountEl) {
                    weeklyCountEl.textContent = weeklyCount > 0 ? 
                        `${weeklyCount} Ø³Ø¤Ø§Ù„ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯` : 
                        'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹';
                }

                this.log(`ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶: ÙŠÙˆÙ…ÙŠ=${dailyCount}, Ø£Ø³Ø¨ÙˆØ¹ÙŠ=${weeklyCount}`);
            }

            updateSyncStatus(message, type = 'info') {
                const syncElement = document.getElementById('syncStatus');
                if (syncElement) {
                    syncElement.className = `sync-indicator ${type}`;
                    syncElement.innerHTML = `<div class="connection-dot"></div><span>${message}</span>`;
                }
                this.log(`ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„ØªØ²Ø§Ù…Ù†: ${message}`);
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString('ar-SA');
                const logEntry = `[${timestamp}] ${message}`;
                
                this.debugLog.push(logEntry);
                if (this.debugLog.length > 20) {
                    this.debugLog.shift();
                }

                const debugElement = document.getElementById('debugInfo');
                if (debugElement) {
                    debugElement.innerHTML = this.debugLog.join('<br>');
                }

                console.log(`[Nafis Student] ${logEntry}`);
            }
        }

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        let currentStudent = {};
        let currentTest = {};
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let testType = '';
        let questionStartTime = 0;
        let questionTimes = [];
        let studentDatabase = JSON.parse(localStorage.getItem('nafisStudentDB') || '{}');

        // Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…)
        let dailyQuestions = [
            {
                subject: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
                question: 'Ù…Ø§ Ù†Ø§ØªØ¬ 15 + 28ØŸ',
                options: ['43', '42', '44', '41'],
                correct: 0,
                explanation: 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ 43'
            },
            {
                subject: 'Ù‚Ø±Ø§Ø¡Ø©',
                question: 'Ø£ÙŠ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ø±Ø§Ø¯Ù Ù„ÙƒÙ„Ù…Ø© "Ø³Ø¹ÙŠØ¯"ØŸ',
                options: ['Ø­Ø²ÙŠÙ†', 'Ù…Ø³Ø±ÙˆØ±', 'ØºØ§Ø¶Ø¨', 'Ø®Ø§Ø¦Ù'],
                correct: 1,
                explanation: 'Ù…Ø³Ø±ÙˆØ± Ù‡Ùˆ Ù…Ø±Ø§Ø¯Ù Ø³Ø¹ÙŠØ¯'
            }
        ];

        let weeklyQuestions = [...dailyQuestions];

        // ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
        const syncReceiver = new StudentSyncReceiver();

        // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        function updateConnectionStatus(isOnline) {
            const indicator = document.getElementById('connectionStatus');
            
            if (isOnline) {
                indicator.className = 'connection-indicator online';
                indicator.innerHTML = '<div class="connection-dot"></div><span>Ù…ØªØµÙ„</span>';
            } else {
                indicator.className = 'connection-indicator offline';
                indicator.innerHTML = '<div class="connection-dot"></div><span>ØºÙŠØ± Ù…ØªØµÙ„</span>';
            }
        }

        function showLoginForm() {
            document.getElementById('studentForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        function registerStudent() {
            const firstName = document.getElementById('firstName').value.trim();
            const fatherName = document.getElementById('fatherName').value.trim();
            const grandFatherName = document.getElementById('grandFatherName').value.trim();
            const familyName = document.getElementById('familyName').value.trim();
            const grade = document.getElementById('grade').value;
            const section = document.getElementById('section').value;

            if (!firstName || !fatherName || !grandFatherName || !familyName || !grade || !section) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }

            const fullName = `${firstName} ${fatherName} ${grandFatherName} ${familyName}`;
            const studentKey = `${fullName}_${grade}_${section}`;
            
            if (studentDatabase[studentKey]) {
                alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ Ù…Ø³Ø¨Ù‚Ø§Ù‹! Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ Ù‡Ùˆ: ' + studentDatabase[studentKey].code);
                return;
            }

            const studentCode = generateStudentCode();
            const studentData = {
                fullName: fullName,
                firstName, fatherName, grandFatherName, familyName,
                grade: grade,
                section: section,
                code: studentCode,
                registrationDate: new Date().toISOString()
            };
            
            studentDatabase[studentKey] = studentData;
            localStorage.setItem('nafisStudentDB', JSON.stringify(studentDatabase));
            
            document.getElementById('generatedCode').textContent = studentCode;
            document.getElementById('studentForm').style.display = 'none';
            document.getElementById('studentCodeDisplay').style.display = 'block';
        }

        function generateStudentCode() {
            let code;
            do {
                code = Math.floor(Math.random() * 900000) + 100000;
            } while (Object.values(studentDatabase).some(student => student.code === code.toString()));
            
            return code.toString();
        }

        function proceedToLogin() {
            document.getElementById('studentCodeDisplay').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        function backToRegistration() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('studentForm').style.display = 'block';
            document.getElementById('loginFullName').value = '';
            document.getElementById('studentCode').value = '';
        }

        function loginStudent() {
            const fullName = document.getElementById('loginFullName').value.trim();
            const code = document.getElementById('studentCode').value.trim();

            if (!fullName || !code) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø®Ø§Øµ');
                return;
            }

            if (code.length !== 6 || !/^\d{6}$/.test(code)) {
                alert('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø®Ø§Øµ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 6 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·');
                return;
            }

            const student = Object.values(studentDatabase).find(s => 
                s.fullName.toLowerCase() === fullName.toLowerCase() && s.code === code
            );

            if (!student) {
                alert('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø®Ø§Øµ ØºÙŠØ± ØµØ­ÙŠØ­!');
                return;
            }

            const existingResults = JSON.parse(localStorage.getItem('nafisResults') || '[]');
            const hasCompletedDaily = existingResults.some(result => 
                result.studentName === student.fullName && 
                result.testType === 'daily'
            );
            const hasCompletedWeekly = existingResults.some(result => 
                result.studentName === student.fullName && 
                result.testType === 'weekly'
            );

            if (hasCompletedDaily && hasCompletedWeekly) {
                alert('Ù„Ù‚Ø¯ Ø£Ø¬Ø±ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹!');
                return;
            }

            currentStudent = student;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('testSelection').style.display = 'block';
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            syncReceiver.updateQuestionsDisplay();
        }

        function confirmAndStartTest(type) {
            const testName = type === 'daily' ? 'Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…' : 'Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹';
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            const questions = type === 'daily' ? dailyQuestions : weeklyQuestions;
            if (!questions || questions.length === 0) {
                alert(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± "${testName}" Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.`);
                return;
            }
            
            // Check if already completed
            const existingResults = JSON.parse(localStorage.getItem('nafisResults') || '[]');
            const hasCompleted = existingResults.some(result => 
                result.studentName === currentStudent.fullName && 
                result.testType === type
            );

            if (hasCompleted) {
                alert(`Ù„Ù‚Ø¯ Ø£Ø¬Ø±ÙŠØª Ø§Ø®ØªØ¨Ø§Ø± "${testName}" Ù…Ø³Ø¨Ù‚Ø§Ù‹!`);
                return;
            }

            const confirmation = confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± "${testName}"ØŸ\n\nØªØ°ÙƒØ±: ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø¬Ø±Ø§Ø¡ ÙƒÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·!`);
            
            if (confirmation) {
                startTest(type);
            }
        }

        function startTest(type) {
            testType = type;
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            questionTimes = [];

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…
            currentTest = {
                questions: type === 'daily' ? dailyQuestions : weeklyQuestions,
                title: type === 'daily' ? 'Ø³Ø¤Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…' : 'Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹'
            };

            if (!currentTest.questions || currentTest.questions.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.');
                return;
            }

            syncReceiver.log(`ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ${currentTest.title} - ${currentTest.questions.length} Ø³Ø¤Ø§Ù„`);

            document.getElementById('testSelection').style.display = 'none';
            document.getElementById('questionArea').style.display = 'block';
            showQuestion();
        }

        function showQuestion() {
            const question = currentTest.questions[currentQuestionIndex];
            const totalQuestions = currentTest.questions.length;

            questionStartTime = Date.now();

            document.getElementById('questionNumber').textContent = 
                `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${totalQuestions} - ${question.subject}`;

            let questionHTML = `<p><strong>${question.subject}:</strong> ${question.question}</p>`;
            if (question.image) {
                questionHTML += `<img src="${question.image}" style="max-width: 100%; height: auto; margin: 15px 0;" alt="ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„">`;
            }

            document.getElementById('questionText').innerHTML = questionHTML;

            const optionsHtml = question.options.map((option, index) => 
                `<div class="option" onclick="selectOption(${index})">${option}</div>`
            ).join('');

            document.getElementById('optionsContainer').innerHTML = optionsHtml;

            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 
                currentQuestionIndex === totalQuestions - 1 ? 'inline-block' : 'none';
            
            document.getElementById('submitBtn').style.display = 'none';
        }

        function selectOption(optionIndex) {
            const options = document.querySelectorAll('.option');
            options.forEach(option => option.classList.remove('selected'));
            options[optionIndex].classList.add('selected');

            userAnswers[currentQuestionIndex] = optionIndex;
            document.getElementById('submitBtn').style.display = 'block';
        }

        function submitAnswer() {
            const question = currentTest.questions[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            const options = document.querySelectorAll('.option');

            const timeSpent = Math.round((Date.now() - questionStartTime) / 1000);
            questionTimes[currentQuestionIndex] = timeSpent;

            options.forEach((option, index) => {
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === userAnswer && index !== question.correct) {
                    option.classList.add('wrong');
                }
                option.style.pointerEvents = 'none';
            });

            if (userAnswer === question.correct) {
                score++;
            }

            document.getElementById('questionText').innerHTML += 
                `<div style="margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                    <strong>Ø§Ù„ØªÙØ³ÙŠØ±:</strong> ${question.explanation}<br>
                    <small style="color: #666;">Ø§Ù„ÙˆÙ‚Øª: ${timeSpent} Ø«Ø§Ù†ÙŠØ©</small>
                </div>`;

            document.getElementById('submitBtn').style.display = 'none';
            
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                document.getElementById('nextBtn').style.display = 'inline-block';
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function handleFinishTest() {
            if (userAnswers[currentQuestionIndex] !== undefined) {
                submitAnswer();
                setTimeout(() => finishTest(), 1500);
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹');
            }
        }

        async function finishTest() {
            const totalQuestions = currentTest.questions.length;
            const percentage = Math.round((score / totalQuestions) * 100);
            const totalTime = questionTimes.reduce((sum, time) => sum + (time || 0), 0);

            document.getElementById('finalScore').textContent = score;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('percentage').textContent = percentage + '%';
            document.getElementById('scoreDisplay').style.display = 'block';

            // Calculate rankings
            await calculateRankings(percentage);

            // Save result
            saveResult();

            document.getElementById('optionsContainer').style.display = 'none';
            document.getElementById('questionText').style.display = 'none';
            document.querySelector('.nav-buttons').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('homeBtn').style.display = 'block';

            syncReceiver.log(`ğŸ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${score}/${totalQuestions} (${percentage}%)`);
            
            showLeaderboard();
        }

        async function calculateRankings(studentPercentage) {
            try {
                const results = JSON.parse(localStorage.getItem('nafisResults') || '[]');
                
                // Calculate class ranking
                const classResults = results.filter(r => 
                    r.grade === currentStudent.grade && 
                    r.section === currentStudent.section &&
                    r.testType === testType
                );
                
                const higherClassScores = classResults.filter(r => r.percentage > studentPercentage);
                const classRank = higherClassScores.length + 1;
                
                // Calculate school ranking
                const schoolResults = results.filter(r => r.testType === testType);
                const higherSchoolScores = schoolResults.filter(r => r.percentage > studentPercentage);
                const schoolRank = higherSchoolScores.length + 1;
                
                document.getElementById('classRank').textContent = classRank;
                document.getElementById('schoolRank').textContent = schoolRank;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨:', error);
                document.getElementById('classRank').textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
                document.getElementById('schoolRank').textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
            }
        }

        function saveResult() {
            const results = JSON.parse(localStorage.getItem('nafisResults') || '[]');
            const totalTime = questionTimes.reduce((sum, time) => sum + (time || 0), 0);
            
            const result = {
                studentName: currentStudent.fullName,
                studentId: currentStudent.code,
                grade: currentStudent.grade,
                section: currentStudent.section,
                testType: testType,
                score: score,
                totalQuestions: currentTest.questions.length,
                percentage: Math.round((score / currentTest.questions.length) * 100),
                totalTime: totalTime,
                date: new Date().toLocaleDateString('ar-SA'),
                timestamp: Date.now()
            };

            results.push(result);
            localStorage.setItem('nafisResults', JSON.stringify(results));
            
            syncReceiver.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${result.percentage}%`);
        }

        function showLeaderboard() {
            const results = JSON.parse(localStorage.getItem('nafisResults') || '[]');
            const filteredResults = results.filter(r => r.testType === testType);
            
            const sortedResults = filteredResults.sort((a, b) => {
                if (b.percentage !== a.percentage) {
                    return b.percentage - a.percentage;
                }
                return a.totalTime - b.totalTime;
            });

            const displayResults = sortedResults.slice(0, 10);
            
            if (displayResults.length === 0) {
                document.getElementById('leaderboard').innerHTML = 
                    '<p style="text-align: center; color: #666; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>';
            } else {
                const leaderboardHtml = displayResults.map((result, index) => {
                    const isCurrentStudent = result.studentName === currentStudent.fullName;
                    const highlightClass = isCurrentStudent ? 'current-student' : '';
                    
                    return `
                        <div class="rank-item ${highlightClass}">
                            <div>
                                <strong>${index + 1}. ${result.studentName}</strong>
                                ${isCurrentStudent ? '<span style="color: #e74c3c;"> (Ø£Ù†Øª)</span>' : ''}
                                <br><small>${result.grade} - Ø´Ø¹Ø¨Ø© ${result.section}</small>
                            </div>
                            <div style="text-align: left;">
                                <strong>${result.percentage}%</strong>
                                <br><small>${result.totalTime}Ø«</small>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('leaderboard').innerHTML = leaderboardHtml;
            }
            
            document.getElementById('leaderboardCard').style.display = 'block';
        }

        function goHome() {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            currentStudent = {};
            currentTest = {};
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            testType = '';
            questionTimes = [];

            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            document.getElementById('questionArea').style.display = 'none';
            document.getElementById('leaderboardCard').style.display = 'none';
            document.getElementById('testSelection').style.display = 'none';
            document.getElementById('studentCodeDisplay').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('studentForm').style.display = 'block';
            
            // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
            document.getElementById('firstName').value = '';
            document.getElementById('fatherName').value = '';
            document.getElementById('grandFatherName').value = '';
            document.getElementById('familyName').value = '';
            document.getElementById('grade').value = '';
            document.getElementById('section').value = '';
            document.getElementById('loginFullName').value = '';
            document.getElementById('studentCode').value = '';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            document.getElementById('optionsContainer').style.display = 'block';
            document.getElementById('questionText').style.display = 'block';
            document.querySelector('.nav-buttons').style.display = 'flex';
            document.getElementById('scoreDisplay').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            
            syncReceiver.log('ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
        }

        // Ù…Ù†Ø¹ Ø§Ù„ØºØ´ ÙˆØ§Ù„Ù†Ø³Ø®
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && (e.keyCode === 67 || e.keyCode === 65 || e.keyCode === 86 || e.keyCode === 83 || e.keyCode === 85)) {
                e.preventDefault();
            }
            if (e.keyCode === 123) e.preventDefault();
        });
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', function() {
            syncReceiver.log('ğŸš€ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØµØ© Ù†Ø§ÙØ³ Ù„Ù„Ø·Ù„Ø§Ø¨');
            updateConnectionStatus(navigator.onLine);
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
            setTimeout(() => {
                syncReceiver.checkForNewQuestions();
            }, 2000);
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));
        
        console.log('âœ… Ù†Ø¸Ø§Ù… Ù†Ø§ÙØ³ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø¬Ø§Ù‡Ø² Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø­Ø³Ù†');
    </script>
</body>
</html>
