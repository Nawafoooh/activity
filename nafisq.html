// ==========================================
// Ø­Ù„ Ø´Ø§Ù…Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø¶ØºØ·
// ==========================================

// 1. ØªØ­Ø³ÙŠÙ† ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - Ø¨Ø¯ÙˆÙ† Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨
window.registerStudent = async function() {
    const nameInput = document.getElementById('studentName');
    const gradeInput = document.getElementById('studentGrade');
    const registerBtn = event.target;
    
    const name = nameInput.value.trim().replace(/\s+/g, ' ');
    const grade = gradeInput.value;

    if (!name || !grade) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }

    const nameParts = name.split(' ').filter(part => part.length > 0);
    if (nameParts.length < 3) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹ (Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 3 Ø£Ø¬Ø²Ø§Ø¡)', 'error');
        return;
    }

    try {
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆÙˆØ¶Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        registerBtn.disabled = true;
        registerBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
        registerBtn.style.opacity = '0.6';

        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… query Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        const nameQuery = query(
            collection(db, 'students'), 
            where('name', '==', name),
            limit(1) // Ù†Ø­ØªØ§Ø¬ Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„Ù„ØªØ­Ù‚Ù‚
        );
        const existingStudents = await getDocs(nameQuery);

        if (!existingStudents.empty) {
            const existingData = existingStudents.docs[0].data();
            showNotification('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨Ø±Ù‚Ù…: ' + existingData.code, 'error');
            
            setTimeout(() => {
                if (confirm(`Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹\nØ±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${existingData.code}\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŸ`)) {
                    document.getElementById('loginCode').value = existingData.code;
                    switchToLogin();
                }
            }, 500);
            return;
        }

        // âœ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ÙØ±ÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
        let studentCode;
        let codeExists = true;
        let attempts = 0;
        
        while (codeExists && attempts < 5) {
            studentCode = generateStudentCode();
            const codeQuery = query(
                collection(db, 'students'),
                where('code', '==', studentCode),
                limit(1)
            );
            const codeCheck = await getDocs(codeQuery);
            codeExists = !codeCheck.empty;
            attempts++;
        }

        if (codeExists) {
            showNotification('Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
            return;
        }

        // âœ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const studentData = {
            name: name,
            grade: grade,
            code: studentCode,
            score: 0,
            questionsAnswered: 0,
            createdAt: new Date(),
            lastActive: new Date()
        };

        const docRef = await addDoc(collection(db, 'students'), studentData);

        // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        currentStudent = { ...studentData, id: docRef.id };
        localStorage.setItem('nafis_student', JSON.stringify({
            code: studentCode,
            name: name,
            timestamp: Date.now()
        }));

        // Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
        showNotification('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù…Ùƒ: ' + studentCode, 'success');
        
        const studentInfo = document.getElementById('studentInfo');
        studentInfo.innerHTML = `
            <div class="student-code">
                <h3>âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
                <div class="code-display" id="generatedCode">${studentCode}</div>
                <p style="font-size: 0.9em; margin-top: 10px; color: rgba(255,255,255,0.9);">
                    âš ï¸ <strong>Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¬ÙŠØ¯Ø§Ù‹!</strong><br>
                    Ø³ØªØ­ØªØ§Ø¬Ù‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                </p>
                <button class="btn" onclick="copyCode('${studentCode}')" 
                        style="background: rgba(255,255,255,0.2); margin-top: 15px;">
                    ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…
                </button>
            </div>
        `;

        document.getElementById('currentScore').textContent = '0';
        showSection('dashboard');

    } catch (error) {
        console.error('Registration error:', error);
        let errorMsg = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ';
        
        if (error.code === 'permission-denied') {
            errorMsg += 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
        } else if (error.message.includes('quota')) {
            errorMsg += 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
        } else {
            errorMsg += 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        }
        
        showNotification(errorMsg, 'error');
    } finally {
        registerBtn.disabled = false;
        registerBtn.innerHTML = 'ØªØ³Ø¬ÙŠÙ„';
        registerBtn.style.opacity = '1';
    }
};

// 2. ØªØ­Ø³ÙŠÙ† ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
window.loginStudent = async function() {
    const codeInput = document.getElementById('loginCode');
    const code = codeInput.value.trim();

    if (!code || code.length !== 6) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…', 'error');
        codeInput.focus();
        return;
    }

    const loginBtn = event.target;
    
    try {
        loginBtn.disabled = true;
        loginBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
        
        // âœ… Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø­Ø³Ù‘Ù†
        const studentsQuery = query(
            collection(db, 'students'), 
            where('code', '==', code),
            limit(1)
        );
        const querySnapshot = await getDocs(studentsQuery);

        if (querySnapshot.empty) {
            showNotification('Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø³Ø¬Ù‘Ù„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯', 'error');
            codeInput.value = '';
            codeInput.focus();
            return;
        }

        const studentDoc = querySnapshot.docs[0];
        currentStudent = { id: studentDoc.id, ...studentDoc.data() };

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
        if (currentStudent.lastQuestion !== undefined) {
            currentQuestion = currentStudent.lastQuestion;
            studentAnswers = currentStudent.lastAnswers || [];
        }

        // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ù†Ø´Ø§Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±)
        updateDoc(doc(db, 'students', studentDoc.id), {
            lastActive: new Date()
        }).catch(e => console.log('Update lastActive failed:', e));

        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
        localStorage.setItem('nafis_student', JSON.stringify({
            code: code,
            name: currentStudent.name,
            timestamp: Date.now()
        }));

        updateDashboardInfo();
        showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentStudent.name}!`, 'success');
        showSection('dashboard');

    } catch (error) {
        console.error('Login error:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
    } finally {
        loginBtn.disabled = false;
        loginBtn.innerHTML = 'Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù‚Ù…';
    }
};

// 3. ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… - Ù…Ø¹ Throttling
let searchTimeout;
window.searchByName = async function() {
    clearTimeout(searchTimeout);
    
    const searchName = document.getElementById('loginName').value.trim();
    const searchResults = document.getElementById('searchResults');

    if (!searchName || searchName.length < 3) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«', 'error');
        return;
    }

    searchResults.innerHTML = '<p style="text-align:center;color:#666;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';

    // âœ… ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ØºØ·
    searchTimeout = setTimeout(async () => {
        try {
            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù‘Ù† - Ù†Ø£Ø®Ø° ÙÙ‚Ø· 20 Ù†ØªÙŠØ¬Ø©
            const studentsQuery = query(
                collection(db, 'students'),
                orderBy('name'),
                limit(50) // Ø­Ø¯ Ø£Ù‚ØµÙ‰
            );
            const snapshot = await getDocs(studentsQuery);
            
            const matches = [];
            const searchLower = searchName.toLowerCase();
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.name.toLowerCase().includes(searchLower)) {
                    matches.push(data);
                }
            });

            if (matches.length === 0) {
                searchResults.innerHTML = `
                    <div style="text-align:center;padding:20px;color:#666;">
                        <p>âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬</p>
                        <p style="font-size:0.9em;">Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù Ø£Ùˆ Ø³Ø¬Ù‘Ù„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</p>
                    </div>
                `;
                return;
            }

            searchResults.innerHTML = `
                <div style="margin-bottom:15px;">
                    <h4 style="color:#333;margin-bottom:10px;">
                        Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (${matches.length}):
                    </h4>
                    ${matches.slice(0, 10).map(student => `
                        <div class="search-result" onclick="selectStudent('${student.code}')">
                            <div class="student-info">
                                <div class="student-details">
                                    <h4>${student.name}</h4>
                                    <p>Ø§Ù„ØµÙ ${student.grade} - Ø§Ù„Ù†Ù‚Ø§Ø·: ${student.score || 0}</p>
                                </div>
                                <div class="student-code-badge">${student.code}</div>
                            </div>
                        </div>
                    `).join('')}
                    ${matches.length > 10 ? 
                        `<p style="text-align:center;color:#666;margin-top:10px;">
                            Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 10 Ù†ØªØ§Ø¦Ø¬ Ù…Ù† ${matches.length}
                        </p>` : ''
                    }
                </div>
            `;

        } catch (error) {
            console.error('Search error:', error);
            searchResults.innerHTML = `
                <div style="text-align:center;padding:20px;color:#e74c3c;">
                    <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</p>
                    <p style="font-size:0.9em;">Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>
                </div>
            `;
        }
    }, 800); // ØªØ£Ø®ÙŠØ± 800ms
};

// 4. Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
window.selectStudent = function(code) {
    if (confirm('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) {
        document.getElementById('loginCode').value = code;
        loginStudent();
    }
};

// 5. Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…
window.copyCode = function(code) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
            showNotification('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }).catch(() => {
            prompt('Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…:', code);
        });
    } else {
        prompt('Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…:', code);
    }
};

// 6. ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ø§Ø³Ù… (ÙŠØ³Ø¨Ø¨ Ø¶ØºØ·)
function setupNameChecking() {
    const nameInput = document.getElementById('studentName');
    const nameCheckResult = document.getElementById('nameCheckResult');
    
    if (!nameInput || !nameCheckResult) return;
    
    let checkTimeout;
    
    nameInput.addEventListener('input', function() {
        clearTimeout(checkTimeout);
        const name = this.value.trim();
        
        if (name.length < 3) {
            nameCheckResult.innerHTML = '';
            return;
        }
        
        const nameParts = name.split(' ').filter(p => p.length > 0);
        
        if (nameParts.length < 3) {
            nameCheckResult.innerHTML = 
                '<span class="name-check-warning">âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹</span>';
        } else {
            nameCheckResult.innerHTML = 
                '<span class="name-check-success">âœ… Ø§Ù„Ø§Ø³Ù… Ø¨ØµÙŠØºØ© ØµØ­ÙŠØ­Ø©</span>';
        }
    });
}

// 7. ØªØ­Ø³ÙŠÙ† Auto-save - ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ©
let autoSaveInterval;
function startAutoSave() {
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    
    autoSaveInterval = setInterval(async () => {
        if (!currentStudent || document.getElementById('testSection').classList.contains('hidden')) {
            return;
        }
        
        try {
            const studentQuery = query(
                collection(db, 'students'),
                where('code', '==', currentStudent.code),
                limit(1)
            );
            const snapshot = await getDocs(studentQuery);
            
            if (!snapshot.empty) {
                const docRef = doc(db, 'students', snapshot.docs[0].id);
                await updateDoc(docRef, {
                    lastQuestion: currentQuestion,
                    lastAnswers: studentAnswers,
                    score: currentStudent.score,
                    lastActive: new Date()
                });
                
                // Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ Ø¨Ø³ÙŠØ·
                console.log('ğŸ’¾ Auto-saved');
            }
        } catch (error) {
            console.error('Auto-save error:', error);
        }
    }, 60000); // ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ©
}

// 8. ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† localStorage
function autoLogin() {
    try {
        const saved = localStorage.getItem('nafis_student');
        if (!saved) return;
        
        const data = JSON.parse(saved);
        const hoursPassed = (Date.now() - data.timestamp) / (1000 * 60 * 60);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† 24 Ø³Ø§Ø¹Ø©
        if (hoursPassed < 24 && data.code) {
            document.getElementById('loginCode').value = data.code;
            showNotification('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ù…Ø­ÙÙˆØ¸: ' + data.name, 'info');
        }
    } catch (error) {
        console.error('Auto-login error:', error);
    }
}

// 9. ØªØ¹Ø·ÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªÙ…Ø±
async function updateHeaderStats() {
    try {
        // ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - Ù„ÙŠØ³ Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ…Ø±
        const studentsCount = localStorage.getItem('nafis_stats_count') || '0';
        const questionsCount = localStorage.getItem('nafis_questions_count') || '5';
        
        document.getElementById('headerActiveStudents').textContent = studentsCount;
        document.getElementById('headerTotalQuestions').textContent = questionsCount;
        
        // ØªØ­Ø¯ÙŠØ« Ø®ÙÙŠÙ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        const studentsSnapshot = await getDocs(query(collection(db, 'students'), limit(1)));
        // Ù„Ø§ Ù†Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ„ - ÙÙ‚Ø· Ù†Ø¹Ø±Ø¶ Ø±Ù‚Ù… ØªÙ‚Ø±ÙŠØ¨ÙŠ
        
    } catch (error) {
        console.error('Stats error:', error);
    }
}

// 10. ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø³Ù‘Ù†Ø©
function initApp() {
    showSection('registration');
    setupNameChecking();
    autoLogin();
    updateHeaderStats();
    
    // Ø¨Ø¯Ø¡ Auto-save Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    window.startTest = (function(original) {
        return async function() {
            await original.apply(this, arguments);
            startAutoSave();
        };
    })(window.startTest);
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', initApp);
initApp();

console.log('âœ… Nafis Performance Optimization Loaded');
