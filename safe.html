<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الطالب - منصة تواصل آمن</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .user-info { text-align: right; }
        .user-id { background: linear-gradient(135deg, #20bf6b 0%, #26de81 100%); color: white; padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: 14px; margin-bottom: 5px; display: inline-block; }
        .btn-logout { background: #dc3545; color: white; padding: 8px 20px; border-radius: 20px; border: none; font-weight: 600; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 14px; margin-top: 10px; }
        .welcome-banner { background: white; padding: 40px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .welcome-banner h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .tabs { background: white; padding: 15px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; gap: 15px; overflow-x: auto; }
        .tab-btn { padding: 12px 30px; background: transparent; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; white-space: nowrap; }
        .tab-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; margin-bottom: 30px; }
        @media (max-width: 968px) { .dashboard-grid { grid-template-columns: 1fr; } }
        .card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card h2 { color: #667eea; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .action-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; transition: all 0.3s; border: none; width: 100%; cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 16px; text-align: right; }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .action-icon { font-size: 32px; width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .report-item { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-right: 4px solid #667eea; }
        .report-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .report-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-new { background: #d4edda; color: #155724; }
        .badge-progress { background: #fff3cd; color: #856404; }
        .badge-resolved { background: #cce5ff; color: #004085; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 40px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .modal-header h2 { color: #667eea; font-size: 24px; }
        .btn-close { background: #f0f0f0; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
        select, input, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; font-family: 'Tajawal', sans-serif; }
        textarea { min-height: 120px; resize: vertical; }
        .btn-submit { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer; font-family: 'Tajawal', sans-serif; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        #loginSection { max-width: 600px; margin: 50px auto; background: white; padding: 50px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        #loginSection h1 { color: #667eea; text-align: center; margin-bottom: 30px; }
        .logo-login { width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 20px; }
        .consent-box { background: #f8f9fa; padding: 25px; border-radius: 15px; margin: 25px 0; border: 2px solid #667eea; }
        .consent-box h3 { color: #667eea; margin-bottom: 15px; font-size: 20px; }
        .consent-box ul { margin: 15px 0 15px 25px; line-height: 2; }
        .consent-box ul li { margin: 10px 0; }
        .checkbox-group { display: flex; align-items: start; gap: 10px; margin: 15px 0; }
        .checkbox-group input[type="checkbox"] { width: auto; margin-top: 5px; min-width: 20px; min-height: 20px; }
        .checkbox-group label { margin: 0; font-size: 14px; line-height: 1.6; }
        .privacy-link { color: #667eea; text-decoration: underline; cursor: pointer; }
        .privacy-link:hover { color: #764ba2; }
        .alert-box { background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .alert-box strong { display: block; margin-bottom: 10px; font-size: 18px; }
        .signature-pad { border: 2px solid #e0e0e0; border-radius: 10px; margin: 15px 0; background: white; }
        .signature-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-clear { background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Tajawal', sans-serif; }
        .emergency-notice { background: #dc3545; color: white; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .emergency-notice h4 { margin-bottom: 10px; font-size: 18px; }
        .emergency-contacts { background: white; padding: 20px; border-radius: 10px; margin-top: 15px; }
        .emergency-contacts div { color: #333; margin: 8px 0; font-weight: 600; }
        .privacy-notice { background: #e7f3ff; border: 2px solid #667eea; padding: 25px; border-radius: 15px; margin: 20px 0; }
        .privacy-notice h3 { color: #667eea; margin-bottom: 15px; }
        .privacy-notice p { line-height: 1.8; margin: 10px 0; color: #333; }
        .step-indicator { display: flex; justify-content: center; gap: 10px; margin: 30px 0; }
        .step { width: 12px; height: 12px; border-radius: 50%; background: #e0e0e0; }
        .step.active { background: #667eea; }
        .step.completed { background: #20bf6b; }
    </style>
</head>
<body>
    <!-- شاشة التسجيل مع موافقة ولي الأمر -->
    <div id="loginSection">
        <div class="logo-login">🛡️</div>
        <h1>منصة تواصل آمن</h1>
        <h2 style="text-align: center; color: #666; font-size: 18px; margin-bottom: 30px;">تسجيل الطالب</h2>
        
        <div class="step-indicator">
            <div class="step active" id="step1"></div>
            <div class="step" id="step2"></div>
            <div class="step" id="step3"></div>
        </div>
        
        <!-- المرحلة 1: معلومات الطالب -->
        <form id="studentInfoForm" style="display: block;">
            <div class="form-group">
                <label>الاسم الكامل للطالب *</label>
                <input type="text" id="studentName" required>
            </div>
            
            <div class="form-group">
                <label>الصف الدراسي *</label>
                <select id="grade" required>
                    <option value="">-- اختر الصف --</option>
                    <option value="الأول الابتدائي">الأول الابتدائي</option>
                    <option value="الثاني الابتدائي">الثاني الابتدائي</option>
                    <option value="الثالث الابتدائي">الثالث الابتدائي</option>
                    <option value="الرابع الابتدائي">الرابع الابتدائي</option>
                    <option value="الخامس الابتدائي">الخامس الابتدائي</option>
                    <option value="السادس الابتدائي">السادس الابتدائي</option>
                    <option value="الأول المتوسط">الأول المتوسط</option>
                    <option value="الثاني المتوسط">الثاني المتوسط</option>
                    <option value="الثالث المتوسط">الثالث المتوسط</option>
                    <option value="الأول الثانوي">الأول الثانوي</option>
                    <option value="الثاني الثانوي">الثاني الثانوي</option>
                    <option value="الثالث الثانوي">الثالث الثانوي</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>رقم الهوية الوطنية للطالب *</label>
                <input type="text" id="studentId" pattern="[0-9]{10}" maxlength="10" placeholder="10 أرقام" required>
            </div>
            
            <button type="submit" class="btn-submit">التالي</button>
        </form>
        
        <!-- المرحلة 2: معلومات ولي الأمر -->
        <form id="guardianInfoForm" style="display: none;">
            <div class="alert-box">
                <strong>⚠️ تنبيه مهم</strong>
                يجب على ولي الأمر إكمال هذا النموذج والموافقة على استخدام المنصة
            </div>
            
            <div class="form-group">
                <label>اسم ولي الأمر *</label>
                <input type="text" id="guardianName" required>
            </div>
            
            <div class="form-group">
                <label>رقم الهوية الوطنية لولي الأمر *</label>
                <input type="text" id="guardianId" pattern="[0-9]{10}" maxlength="10" placeholder="10 أرقام" required>
            </div>
            
            <div class="form-group">
                <label>رقم الجوال *</label>
                <input type="tel" id="guardianPhone" pattern="05[0-9]{8}" placeholder="05XXXXXXXX" required>
            </div>
            
            <div class="form-group">
                <label>البريد الإلكتروني</label>
                <input type="email" id="guardianEmail">
            </div>
            
            <div class="form-group">
                <label>صلة القرابة *</label>
                <select id="guardianRelation" required>
                    <option value="">-- اختر --</option>
                    <option value="والد">والد</option>
                    <option value="والدة">والدة</option>
                    <option value="وصي قانوني">وصي قانوني</option>
                </select>
            </div>
            
            <button type="submit" class="btn-submit">التالي</button>
            <button type="button" class="btn-submit" style="background: #6c757d; margin-top: 10px;" onclick="prevStep(1)">السابق</button>
        </form>
        
        <!-- المرحلة 3: الموافقة والخصوصية -->
        <div id="consentForm" style="display: none;">
            <div class="privacy-notice">
                <h3>📋 إشعار الخصوصية</h3>
                <p><strong>الجهة المسؤولة:</strong> وزارة التعليم - المملكة العربية السعودية</p>
                <p><strong>الغرض من جمع البيانات:</strong> توفير بيئة تعليمية آمنة، متابعة السلوك الطلابي، والتدخل المبكر لحماية الطلاب من التنمر والتحرش والمشاكل النفسية والاجتماعية.</p>
                <p><strong>مدة الاحتفاظ بالبيانات:</strong> طوال فترة الدراسة + 3 سنوات بعد التخرج وفقاً لسياسة وزارة التعليم.</p>
                <p><a href="#" class="privacy-link" onclick="showFullPrivacy(); return false;">اقرأ سياسة الخصوصية الكاملة</a></p>
            </div>
            
            <div class="consent-box">
                <h3>🔒 نطاق موافقة ولي الأمر</h3>
                <p><strong>أنا (ولي الأمر) أوافق على:</strong></p>
                <ul>
                    <li>جمع ومعالجة البيانات الشخصية التالية: (الاسم، رقم الهوية، الصف، معلومات الاتصال)</li>
                    <li>جمع البيانات الحساسة: (البلاغات السلوكية، الحالة النفسية، المشاكل الاجتماعية) بسرية تامة</li>
                    <li>مشاركة البيانات مع المرشد الطلابي المعتمد فقط</li>
                    <li>تصعيد الحالات الخطرة (إيذاء/تحرش) للجهات الرسمية (الشرطة 911، مركز البلاغات 1919، وزارة الموارد والتنمية الاجتماعية)</li>
                    <li>تشفير جميع البيانات وحمايتها وفق معايير الهيئة السعودية للبيانات والذكاء الاصطناعي (SDAIA)</li>
                </ul>
            </div>
            
            <div class="emergency-notice">
                <h4>🚨 إجراءات الحالات الطارئة</h4>
                <p style="margin: 10px 0;">في حالات الإيذاء، التحرش، أو الخطر الجسيم، سيتم:</p>
                <div class="emergency-contacts">
                    <div>• التصعيد الفوري للمرشد الطلابي وإدارة المدرسة</div>
                    <div>• الإبلاغ الفوري للشرطة: 911</div>
                    <div>• مركز البلاغات الوطني: 1919</div>
                    <div>• وزارة الموارد والتنمية الاجتماعية: 19911</div>
                    <div>• توثيق كامل للحالة في سجلات مشفرة</div>
                </div>
            </div>
            
            <div class="consent-box">
                <h3>✅ حقوق ولي الأمر والطالب</h3>
                <ul>
                    <li>الحق في الوصول إلى بيانات الطالب في أي وقت</li>
                    <li>الحق في تصحيح أو تحديث البيانات</li>
                    <li>الحق في سحب الموافقة وحذف البيانات (إلا ما تتطلبه الأنظمة القانونية)</li>
                    <li>الحق في تقديم شكوى لدى الهيئة السعودية للبيانات والذكاء الاصطناعي</li>
                    <li>الحق في معرفة من يطلع على بيانات الطالب</li>
                </ul>
            </div>
            
            <form id="finalConsentForm">
                <div class="checkbox-group">
                    <input type="checkbox" id="consentData" required>
                    <label for="consentData">أوافق على جمع ومعالجة بيانات ابني/ابنتي وفقاً للغرض المذكور أعلاه</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="consentSensitive" required>
                    <label for="consentSensitive">أوافق على جمع البيانات الحساسة (البلاغات السلوكية والنفسية) وأدرك أنها ستُحفظ بسرية تامة</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="consentEmergency" required>
                    <label for="consentEmergency">أوافق على تصعيد الحالات الخطرة للجهات الرسمية (الشرطة، مركز البلاغات، وزارة التنمية الاجتماعية) عند الحاجة</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="consentPrivacy" required>
                    <label for="consentPrivacy">قرأت وفهمت <a href="#" class="privacy-link" onclick="showFullPrivacy(); return false;">سياسة الخصوصية</a> وأوافق عليها</label>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <label>التوقيع الإلكتروني لولي الأمر (اكتب اسمك الكامل) *</label>
                    <input type="text" id="guardianSignature" placeholder="الاسم الكامل لولي الأمر" required>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        التاريخ: <span id="consentDate"></span>
                    </div>
                </div>
                
                <button type="submit" class="btn-submit">تأكيد الموافقة والتسجيل</button>
                <button type="button" class="btn-submit" style="background: #6c757d; margin-top: 10px;" onclick="prevStep(2)">السابق</button>
            </form>
        </div>
    </div>
    
    <!-- لوحة التحكم -->
    <div id="dashboardSection" style="display: none;">
        <div class="container">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">🛡️</div>
                    <div><strong style="color: #667eea; font-size: 18px;">منصة تواصل آمن</strong></div>
                </div>
                <div class="user-info">
                    <div class="user-id" id="userIdDisplay"></div>
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                        <strong id="userNameDisplay"></strong> - <span id="userGradeDisplay"></span>
                    </div>
                    <button class="btn-logout" onclick="logout()">تسجيل الخروج</button>
                </div>
            </div>
            
            <div class="welcome-banner">
                <h1>مرحباً بك في منصة تواصل آمن! 👋</h1>
                <p>نحن هنا لدعمك. لا تتردد في التواصل معنا في أي وقت.</p>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('dashboard')">🏠 الرئيسية</button>
                <button class="tab-btn" onclick="switchTab('privacy')">🔒 الخصوصية</button>
            </div>
            
            <div id="tabDashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="card">
                        <h2>⚡ إجراءات سريعة</h2>
                        <button class="action-btn" onclick="openReportModal()">
                            <div class="action-icon">📝</div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; font-size: 18px;">تقديم بلاغ جديد</div>
                                <div style="font-size: 14px; opacity: 0.9;">أبلغ عن أي مشكلة بسرية تامة</div>
                            </div>
                        </button>
                        
                        <button class="action-btn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);" onclick="alert('في حالة الطوارئ:\n🚨 الشرطة: 911\n📞 مركز البلاغات: 1919\n🏛️ وزارة التنمية: 19911')">
                            <div class="action-icon">🚨</div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; font-size: 18px;">حالة طوارئ</div>
                                <div style="font-size: 14px; opacity: 0.9;">أرقام الجهات الرسمية</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="card">
                        <h2>📋 بلاغاتي</h2>
                        <div id="reportsList"></div>
                    </div>
                </div>
            </div>
            
            <div id="tabPrivacy" class="tab-content">
                <div class="card">
                    <h2>🔒 إعدادات الخصوصية</h2>
                    <div class="privacy-notice">
                        <h3>معلومات حسابك</h3>
                        <p><strong>رقم الطالب:</strong> <span id="privacyStudentId"></span></p>
                        <p><strong>ولي الأمر:</strong> <span id="privacyGuardianName"></span></p>
                        <p><strong>تاريخ الموافقة:</strong> <span id="privacyConsentDate"></span></p>
                        <p><strong>حالة الموافقة:</strong> <span style="color: #20bf6b; font-weight: 700;">✓ نشط</span></p>
                    </div>
                    
                    <div class="consent-box">
                        <h3>حقوقك</h3>
                        <ul>
                            <li>الحق في الوصول إلى بياناتك</li>
                            <li>الحق في تصحيح البيانات</li>
                            <li>الحق في حذف البيانات (اتصل بالمرشد)</li>
                            <li>الحق في سحب الموافقة</li>
                        </ul>
                        <button class="btn-submit" style="margin-top: 20px; background: #6c757d;" onclick="alert('للاستفسارات عن الخصوصية:\nاتصل بالمرشد الطلابي\nأو راسل: privacy@studentcare.sa')">طلب معلومات عن بياناتي</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal البلاغ -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📝 تقديم بلاغ جديد</h2>
                <button class="btn-close" onclick="closeReportModal()">×</button>
            </div>
            
            <div class="alert-box">
                <strong>🔒 سرية تامة</strong>
                جميع بلاغاتك محمية ومشفرة. لن يطلع عليها إلا المرشد الطلابي المعتمد.
            </div>
            
            <form id="reportForm">
                <div class="form-group">
                    <label>نوع البلاغ *</label>
                    <select id="reportType" required>
                        <option value="">-- اختر نوع البلاغ --</option>
                        <option value="تنمر">🚨 تنمر (أولوية عالية)</option>
                        <option value="تحرش">⚠️ تحرش (أولوية عالية - تصعيد فوري)</option>
                        <option value="عنف">💥 عنف (أولوية عالية - تصعيد فوري)</option>
                        <option value="مشكلة أسرية">🏠 مشكلة أسرية</option>
                        <option value="فقر">💰 مشكلة مالية</option>
                        <option value="قلق نفسي">😟 قلق نفسي</option>
                        <option value="اكتئاب">😔 اكتئاب (أولوية عالية)</option>
                        <option value="مشكلة دراسية">📚 مشكلة دراسية</option>
                        <option value="أخرى">📌 أخرى</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>عنوان البلاغ *</label>
                    <input type="text" id="reportTitle" placeholder="مثال: أحتاج مساعدة" required>
                </div>
                
                <div class="form-group">
                    <label>تفاصيل البلاغ *</label>
                    <textarea id="reportDescription" placeholder="اشرح المشكلة بالتفصيل... كل ما تكتبه سيبقى سرياً ومشفراً" required></textarea>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="isAnonymous">
                    <label for="isAnonymous">أريد الإبلاغ بشكل مجهول (لن تظهر هويتي للمرشد)</label>
                </div>
                
                <div class="emergency-notice" id="emergencyWarning" style="display: none;">
                    <h4>⚠️ تنبيه: حالة طارئة</h4>
                    <p>هذا النوع من البلاغات سيتم تصعيده فوراً للمرشد الطلابي، وقد يتطلب إبلاغ الجهات الرسمية (الشرطة، مركز البلاغات) لحمايتك.</p>
                </div>
                
                <button type="submit" class="btn-submit">إرسال البلاغ</button>
            </form>
        </div>
    </div>
    
    <script>
        let userData = JSON.parse(localStorage.getItem('studentData')) || null;
        let reports = JSON.parse(localStorage.getItem('studentReports')) || [];
        let currentStep = 1;
        
        // عرض التاريخ الحالي
        document.getElementById('consentDate') && (document.getElementById('consentDate').textContent = new Date().toLocaleDateString('ar-SA'));
        
        // التحقق من تسجيل الدخول
        if (userData && userData.consentGiven) {
            showDashboard();
        }
        
        // المرحلة 1: معلومات الطالب
        document.getElementById('studentInfoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            nextStep(1);
        });
        
        // المرحلة 2: معلومات ولي الأمر
        document.getElementById('guardianInfoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            nextStep(2);
        });
        
        // المرحلة 3: الموافقة النهائية
        document.getElementById('finalConsentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const signature = document.getElementById('guardianSignature').value;
            const guardianName = document.getElementById('guardianName').value;
            
            if (signature.toLowerCase() !== guardianName.toLowerCase()) {
                alert('❌ التوقيع الإلكتروني يجب أن يطابق اسم ولي الأمر بالضبط');
                return;
            }
            
            const userId = 'ST' + Date.now().toString().slice(-8);
            
            userData = {
                id: userId,
                studentName: document.getElementById('studentName').value,
                studentId: document.getElementById('studentId').value,
                grade: document.getElementById('grade').value,
                guardianName: guardianName,
                guardianId: document.getElementById('guardianId').value,
                guardianPhone: document.getElementById('guardianPhone').value,
                guardianEmail: document.getElementById('guardianEmail').value,
                guardianRelation: document.getElementById('guardianRelation').value,
                guardianSignature: signature,
                consentDate: new Date().toISOString(),
                consentGiven: true,
                registeredAt: new Date().toISOString()
            };
            
            localStorage.setItem('studentData', JSON.stringify(userData));
            
            // تسجيل في سجل التدقيق
            logAudit('REGISTRATION', `Student registered: ${userId} with guardian consent`);
            
            alert('✅ تم التسجيل بنجاح!\n\nرقم الطالب: ' + userId + '\n\nاحتفظ بهذا الرقم للدخول مرة أخرى.\n\nتم توثيق موافقة ولي الأمر بتاريخ: ' + new Date().toLocaleDateString('ar-SA'));
            
            showDashboard();
        });
        
        function nextStep(step) {
            if (step === 1) {
                document.getElementById('studentInfoForm').style.display = 'none';
                document.getElementById('guardianInfoForm').style.display = 'block';
                document.getElementById('step1').classList.add('completed');
                document.getElementById('step2').classList.add('active');
                currentStep = 2;
            } else if (step === 2) {
                document.getElementById('guardianInfoForm').style.display = 'none';
                document.getElementById('consentForm').style.display = 'block';
                document.getElementById('step2').classList.add('completed');
                document.getElementById('step3').classList.add('active');
                currentStep = 3;
            }
        }
        
        function prevStep(step) {
            if (step === 1) {
                document.getElementById('guardianInfoForm').style.display = 'none';
                document.getElementById('studentInfoForm').style.display = 'block';
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step1').classList.remove('completed');
                currentStep = 1;
            } else if (step === 2) {
                document.getElementById('consentForm').style.display = 'none';
                document.getElementById('guardianInfoForm').style.display = 'block';
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step2').classList.remove('completed');
                currentStep = 2;
            }
        }
        
        function showFullPrivacy() {
            alert('سياسة الخصوصية الكاملة\n\n' +
                  '1. الجهة المسؤولة: وزارة التعليم - المملكة العربية السعودية\n\n' +
                  '2. البيانات المجمعة:\n' +
                  '   - بيانات شخصية: الاسم، رقم الهوية، الصف، معلومات الاتصال\n' +
                  '   - بيانات حساسة: البلاغات السلوكية والنفسية\n\n' +
                  '3. الغرض: حماية الطلاب وتوفير بيئة تعليمية آمنة\n\n' +
                  '4. مدة الاحتفاظ: طوال فترة الدراسة + 3 سنوات\n\n' +
                  '5. المشاركة: المرشد الطلابي المعتمد فقط\n\n' +
                  '6. الأمان: تشفير كامل وفق معايير SDAIA\n\n' +
                  '7. حقوقك: الوصول، التصحيح، الحذف، الشكوى\n\n' +
                  '8. الاتصال: privacy@studentcare.sa');
        }
        
        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            
            document.getElementById('userIdDisplay').textContent = 'رقمك: ' + userData.id;
            document.getElementById('userNameDisplay').textContent = userData.studentName;
            document.getElementById('userGradeDisplay').textContent = userData.grade;
            
            document.getElementById('privacyStudentId').textContent = userData.id;
            document.getElementById('privacyGuardianName').textContent = userData.guardianName;
            document.getElementById('privacyConsentDate').textContent = new Date(userData.consentDate).toLocaleDateString('ar-SA');
            
            loadReports();
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            if (tabName === 'dashboard') {
                document.getElementById('tabDashboard').classList.add('active');
                event.target.classList.add('active');
            } else if (tabName === 'privacy') {
                document.getElementById('tabPrivacy').classList.add('active');
                event.target.classList.add('active');
            }
        }
        
        function loadReports() {
            const reportsList = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                reportsList.innerHTML = '<div class="empty-state"><div style="font-size: 60px;">📭</div><p>لا توجد بلاغات حالياً</p></div>';
                return;
            }
            
            reportsList.innerHTML = reports.map(report => `
                <div class="report-item">
                    <div class="report-header">
                        <strong>${report.title}</strong>
                        <span class="report-badge badge-${report.status === 'جديد' ? 'new' : report.status === 'قيد المتابعة' ? 'progress' : 'resolved'}">
                            ${report.status}
                        </span>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        📌 ${report.type} | 🕐 ${new Date(report.date).toLocaleDateString('ar')} | ${report.priority}
                        ${report.escalated ? '<br>🚨 تم التصعيد للجهات المختصة' : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function openReportModal() {
            document.getElementById('reportModal').classList.add('active');
        }
        
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
            document.getElementById('reportForm').reset();
            document.getElementById('emergencyWarning').style.display = 'none';
        }
        
        // تحذير الحالات الطارئة
        document.getElementById('reportType').addEventListener('change', (e) => {
            const emergencyTypes = ['تحرش', 'عنف', 'اكتئاب'];
            const warning = document.getElementById('emergencyWarning');
            
            if (emergencyTypes.includes(e.target.value)) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        });
        
        // إرسال البلاغ
        document.getElementById('reportForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const reportType = document.getElementById('reportType').value;
            const emergencyTypes = ['تحرش', 'عنف'];
            const isEmergency = emergencyTypes.includes(reportType);
            
            const reportData = {
                id: 'RPT' + Date.now(),
                studentId: userData.id,
                studentName: document.getElementById('isAnonymous').checked ? 'مجهول' : userData.studentName,
                type: reportType,
                title: document.getElementById('reportTitle').value,
                description: document.getElementById('reportDescription').value,
                isAnonymous: document.getElementById('isAnonymous').checked,
                status: 'جديد',
                priority: ['تنمر', 'تحرش', 'عنف', 'اكتئاب'].includes(reportType) ? 'عالي' : 'متوسط',
                date: new Date().toISOString(),
                escalated: isEmergency,
                counselorNotes: ''
            };
            
            reports.push(reportData);
            localStorage.setItem('studentReports', JSON.stringify(reports));
            
            let allReports = JSON.parse(localStorage.getItem('allReports')) || [];
            allReports.push(reportData);
            localStorage.setItem('allReports', JSON.stringify(allReports));
            
            // تسجيل في سجل التدقيق
            logAudit('REPORT_CREATED', `Report ${reportData.id} created by ${userData.id} - Type: ${reportType} - Priority: ${reportData.priority}`);
            
            if (isEmergency) {
                logAudit('EMERGENCY_ESCALATION', `URGENT: Report ${reportData.id} escalated - Type: ${reportType} - Student: ${userData.id}`);
                alert('🚨 تم إرسال البلاغ وتصعيده فوراً!\n\nنوع الحالة: ' + reportType + '\n\nتم إشعار:\n✓ المرشد الطلابي\n✓ إدارة المدرسة\n' + 
                      (reportType === 'تحرش' || reportType === 'عنف' ? '✓ الجهات الأمنية المختصة\n' : '') +
                      '\nسيتم التواصل معك خلال 24 ساعة.\n\nفي حالة الخطر المباشر:\n🚨 الشرطة: 911\n📞 مركز البلاغات: 1919');
            } else {
                alert('✓ تم إرسال البلاغ بنجاح!\n\nسيتم مراجعته من قبل المرشد الطلابي والرد عليك قريباً.\n\nجميع بياناتك محمية ومشفرة.');
            }
            
            closeReportModal();
            loadReports();
        });
        
        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                logAudit('LOGOUT', `Student ${userData.id} logged out`);
                location.reload();
            }
        }
        
        // سجل التدقيق (Audit Log)
        function logAudit(action, details) {
            let auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];
            auditLog.push({
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                userId: userData ? userData.id : 'ANONYMOUS',
                ip: 'LOCAL' // في الإنتاج سيتم جلب IP الحقيقي
            });
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
        }
    </script>
</body>
</html>
