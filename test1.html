<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ - Ø³Ù‚Ù Ø§Ù„Ù€ 20 Ø­ØµØ©</title>
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…Ù„Ù */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; padding: 15px; }
        .container { max-width: 100%; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #4a5568; padding-bottom: 10px; }
        .buttons { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-auto { background: #2c7a7b; }
        .btn-auto:hover { background: #285e61; }
        .btn-clear { background: #e53e3e; }
        .btn-save { background: #3182ce; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #cbd5e0; padding: 5px; text-align: center; }
        th { background: #2d3748; color: white; }
        
        input[type="text"] { width: 100%; border: none; text-align: center; outline: none; padding: 3px; }
        .teacher-name { background: #edf2f7; font-weight: bold; }
        .waiting-cell-assigned { background-color: #ebf8ff !important; font-weight: bold; color: #2b6cb0; }
        
        /* ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        #statsContainer { margin-top: 30px; }
        .stats-ok { background: #c6f6d5 !important; }
        .stats-low { background: #fed7d7 !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Ù†Ø¸Ø§Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ (Ø¥ÙƒÙ…Ø§Ù„ Ù„Ù€ 20 Ø­ØµØ©)</h1>
    </div>

    <div class="buttons">
        <button class="btn btn-auto" onclick="smartDistributeToTwenty()">ğŸš€ ØªÙˆØ²ÙŠØ¹ Ø°ÙƒÙŠ (Ø¥ÙƒÙ…Ø§Ù„ Ù„Ù€ 20)</button>
        <button class="btn btn-clear" onclick="clearWaitingOnly()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
        <button class="btn btn-save" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="mainTable">
            <thead>
                <tr>
                    <th rowspan="2">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                    <th colspan="7">Ø§Ù„Ø£Ø­Ø¯</th>
                    <th colspan="7">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</th>
                    <th colspan="7">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</th>
                    <th colspan="7">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</th>
                    <th colspan="7">Ø§Ù„Ø®Ù…ÙŠØ³</th>
                </tr>
                <tr id="periodsHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="statsContainer">
        <h3>ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ù†ØµØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
        <div id="statsContent"></div>
    </div>
</div>

<script>
    const days = ['sun', 'mon', 'tue', 'wed', 'thu'];
    const MAX_TARGET = 20;

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    window.onload = () => {
        const headerRow = document.getElementById('periodsHeader');
        const tbody = document.getElementById('tableBody');
        
        // ØªÙˆÙ„ÙŠØ¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ØµØµ ÙÙŠ Ø§Ù„Ø±Ø£Ø³
        for(let i=0; i<5; i++) {
            for(let p=1; p<=7; p++) headerRow.innerHTML += `<th>${p}</th>`;
        }

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙÙˆÙ (42 Ù…Ø¹Ù„Ù…)
        for (let i = 0; i < 42; i++) {
            let row = `<tr><td><input type="text" id="teacher_${i}" class="teacher-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…"></td>`;
            days.forEach(day => {
                for (let p = 1; p <= 7; p++) {
                    row += `<td><input type="text" id="cell_${i}_${day}_${p}" onchange="updateStats()"></td>`;
                }
            });
            row += `</tr>`;
            tbody.innerHTML += row;
        }
        loadData();
    };

    // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ù„Ù€ 20 Ø­ØµØ©
    function smartDistributeToTwenty() {
        if(!confirm("Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù† Ø¨Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ù„Ø±ÙØ¹ Ù†ØµØ§Ø¨ ÙƒÙ„ Ù…Ø¹Ù„Ù… Ø¥Ù„Ù‰ 20 Ø­ØµØ©. Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ")) return;

        // 1. Ù…Ø³Ø­ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        clearWaitingOnly(false);

        // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµØ§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        let teachers = [];
        for (let i = 0; i < 42; i++) {
            let name = document.getElementById(`teacher_${i}`).value.trim();
            if (name) {
                let actual = 0;
                days.forEach(d => {
                    for(let p=1; p<=7; p++) {
                        let val = document.getElementById(`cell_${i}_${d}_${p}`).value;
                        if (val && val !== 'ÙˆÙ‡Ù…ÙŠ') actual++;
                    }
                });
                teachers.push({ id: i, name: name, total: actual });
            }
        }

        // 3. Ù…Ø­Ø±Ùƒ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØªÙƒØ±Ø±
        let changed = true;
        while (changed) {
            changed = false;
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†: Ø§Ù„Ø£Ù‚Ù„ Ù†ØµØ§Ø¨Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
            teachers.sort((a, b) => a.total - b.total);

            for (let t of teachers) {
                if (t.total >= MAX_TARGET) continue;

                let foundForTeacher = false;
                for (let d of days) {
                    for (let p = 1; p <= 7; p++) {
                        let cell = document.getElementById(`cell_${t.id}_${d}_${p}`);
                        
                        if (!cell.value) {
                            // Ø­Ø³Ø§Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (1-5) ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­ØµØ©
                            let currentWaitLevel = 1;
                            for (let otherI = 0; otherI < 42; otherI++) {
                                let otherVal = document.getElementById(`cell_${otherI}_${d}_${p}`).value;
                                if (otherVal.startsWith('Ø§Ù†ØªØ¸Ø§Ø±')) currentWaitLevel++;
                            }

                            if (currentWaitLevel <= 5) {
                                cell.value = `Ø§Ù†ØªØ¸Ø§Ø±${currentWaitLevel}`;
                                cell.classList.add('waiting-cell-assigned');
                                t.total++;
                                changed = true;
                                foundForTeacher = true;
                                break;
                            }
                        }
                    }
                    if (foundForTeacher) break;
                }
            }
        }
        updateStats();
        alert("ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ù†ØµØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¥Ù„Ù‰ 20 Ø­ØµØ© Ø¨Ù†Ø¬Ø§Ø­.");
    }

    function updateStats() {
        let html = `<table><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø­ØµØµ ÙØ¹Ù„ÙŠØ©</th><th>Ø§Ù†ØªØ¸Ø§Ø±</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>`;
        for (let i = 0; i < 42; i++) {
            let name = document.getElementById(`teacher_${i}`).value;
            if (!name) continue;

            let c = 0, w = 0;
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    let v = document.getElementById(`cell_${i}_${d}_${p}`).value;
                    if(v === 'ÙˆÙ‡Ù…ÙŠ') continue;
                    if(v.startsWith('Ø§Ù†ØªØ¸Ø§Ø±')) w++;
                    else if(v) c++;
                }
            });

            let total = c + w;
            let rowClass = total >= 20 ? 'stats-ok' : 'stats-low';
            html += `<tr class="${rowClass}">
                <td>${name}</td><td>${c}</td><td>${w}</td>
                <td style="font-weight:bold">${total}</td>
                <td>${total >= 20 ? 'âœ… Ù…ÙƒØªÙ…Ù„' : 'âš ï¸ Ù†Ø§Ù‚Øµ (' + (20-total) + ')'}</td>
            </tr>`;
        }
        html += `</table>`;
        document.getElementById('statsContent').innerHTML = html;
    }

    function clearWaitingOnly(confirmFlag = true) {
        if (confirmFlag && !confirm("Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŸ")) return;
        for (let i = 0; i < 42; i++) {
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    let cell = document.getElementById(`cell_${i}_${d}_${p}`);
                    if (cell.value.startsWith('Ø§Ù†ØªØ¸Ø§Ø±')) {
                        cell.value = '';
                        cell.classList.remove('waiting-cell-assigned');
                    }
                }
            });
        }
        updateStats();
    }

    function saveData() {
        let data = {};
        for (let i = 0; i < 42; i++) {
            data[`t_${i}`] = document.getElementById(`teacher_${i}`).value;
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    data[`c_${i}_${d}_${p}`] = document.getElementById(`cell_${i}_${d}_${p}`).value;
                }
            });
        }
        localStorage.setItem('smartTableData', JSON.stringify(data));
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­.");
    }

    function loadData() {
        let data = JSON.parse(localStorage.getItem('smartTableData'));
        if (!data) return;
        for (let i = 0; i < 42; i++) {
            document.getElementById(`teacher_${i}`).value = data[`t_${i}`] || '';
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    let val = data[`c_${i}_${d}_${p}`] || '';
                    let cell = document.getElementById(`cell_${i}_${d}_${p}`);
                    cell.value = val;
                    if (val.startsWith('Ø§Ù†ØªØ¸Ø§Ø±')) cell.classList.add('waiting-cell-assigned');
                }
            });
        }
        updateStats();
    }
</script>
</body>
</html>
