<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฌุฏูู ุงููุฏุฑุณุฉ ุงููุทูุฑ - ูุธุงู 20 ุญุตุฉ</title>
    <style>
        /* ... (ููุณ ุงูุชูุณููุงุช ุงูููุฌูุฏุฉ ูู ูููู ุงูุฃุตูู) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; padding: 15px; }
        .container { max-width: 100%; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 20px; }
        .schedule-table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1200px; }
        .schedule-table th, .schedule-table td { border: 1px solid #cbd5e0; padding: 6px 4px; text-align: center; }
        .waiting-cell-assigned { background-color: #ebf8ff !important; font-weight: bold; color: #2b6cb0; }
        .stats-ok { background-color: #c6f6d5 !important; } /* ููู ุฃุฎุถุฑ ูููุตุงุจ ุงูููุชูู */
        .stats-low { background-color: #fed7d7 !important; } /* ููู ุฃุญูุฑ ูููุตุงุจ ุงููุงูุต */
        /* (ุจููุฉ ุงูุชูุณููุงุช ุงูุฃุตููุฉ ูุญุชูุงุฉ ููุง) */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>๐ ุงูุฌุฏูู ุงููุฏุฑุณู ุงูุฃุณุจูุนู (ุชูุฒูุน ุฐูู 20 ุญุตุฉ)</h1>
        </div>

        <div class="buttons">
            <button class="btn btn-save" onclick="saveData()">๐พ ุญูุธ ูุญูุธ ููุณุญุงุจุฉ</button>
            <button class="btn btn-auto-assign" style="background:#2c7a7b" onclick="smartPopulateWaiting()">โก ุชูุฒูุน ุงูุงูุชุธุงุฑ ุงูุชููุงุฆู (ุณูู 20)</button>
            <button class="btn btn-clear" onclick="clearOnlyWaiting()">๐๏ธ ูุณุญ ุงูุงูุชุธุงุฑ ููุท</button>
            <button class="btn btn-print" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ</button>
        </div>

        <div class="schedule-wrapper">
            <table class="schedule-table">
                <thead>
                    </thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>

        <div id="statsSection" style="margin-top:20px; padding:15px; background:#edf2f7; border-radius:8px;">
            <h3>๐ ูุฑุงูุจุฉ ุงููุตุงุจ (ุญุตุต + ุงูุชุธุงุฑ)</h3>
            <div id="statsTableContainer"></div>
        </div>
    </div>

<script>
    // ุงูุฅุนุฏุงุฏุงุช ุงูุซุงุจุชุฉ
    const MAX_TARGET = 20;
    const days = ['sun', 'mon', 'tue', 'wed', 'thu'];
    
    // --- ุงููุธููุฉ ุงูุฌุฏูุฏุฉ: ุงูุชูุฒูุน ุงูุฐูู ููุงูุชุธุงุฑ ุญุชู 20 ุญุตุฉ ---
    function smartPopulateWaiting() {
        if(!confirm("ุณูุชู ููุก ุญุตุต ุงูุงูุชุธุงุฑ ูููุนูููู ุงูุฐูู ูู ูุตู ูุตุงุจูู ูู 20 ุญุตุฉ. ุงุณุชูุฑุงุฑุ")) return;
        
        // 1. ูุณุญ ุงูุงูุชุธุงุฑุงุช ุงููุฏููุฉ
        clearOnlyWaiting(false);

        // 2. ุชุญููู ุงูุจูุงูุงุช ุงูุญุงููุฉ
        let teacherData = [];
        for (let i = 0; i < 42; i++) {
            let name = document.getElementById(`teacher_${i}`).value.trim();
            if (name) {
                let actualClasses = 0;
                days.forEach(day => {
                    for (let p = 1; p <= 7; p++) {
                        let val = document.getElementById(`cell_${i}_${day}_${p}`).value;
                        if (val && val !== 'ูููู' && !val.startsWith('ุงูุชุธุงุฑ')) actualClasses++;
                    }
                });
                teacherData.push({ id: i, name: name, total: actualClasses });
            }
        }

        // 3. ุงูุชูุฒูุน ุงููุชูุงุฒู
        days.forEach(day => {
            for (let p = 1; p <= 7; p++) {
                // ุชุฑุชูุจ ุงููุนูููู ุชุตุงุนุฏูุงู ุญุณุจ ุงููุตุงุจ ุงูุญุงูู (ุงูุฃูู ูุฃุฎุฐ ุฃููุงู)
                teacherData.sort((a, b) => a.total - b.total);

                let waitingLevel = 1;
                for (let t of teacherData) {
                    if (waitingLevel > 5) break; // ุจุญุฏ ุฃูุตู 5 ุงูุชุธุงุฑุงุช ููู ุญุตุฉ

                    let cell = document.getElementById(`cell_${t.id}_${day}_${p}`);
                    if (t.total < MAX_TARGET && !cell.value) {
                        cell.value = `ุงูุชุธุงุฑ${waitingLevel}`;
                        cell.parentElement.classList.add('waiting-cell-assigned');
                        t.total++;
                        waitingLevel++;
                    }
                }
            }
        });

        updateClassCounts(); // ุชุญุฏูุซ ุงูุฃุฑูุงู ูู ุงูุฌุฏูู
        renderStatsTable(); // ุชุญุฏูุซ ุฌุฏูู ุงูุฅุญุตุงุฆูุงุช
        alert("ุชู ุงูุชูุฒูุน ุงูุฐูู ุจูุฌุงุญ!");
    }

    // --- ุงููุธููุฉ ุงูุฌุฏูุฏุฉ: ุชุญุฏูุซ ุฌุฏูู ุงูุฅุญุตุงุฆูุงุช ---
    function renderStatsTable() {
        let html = '<table style="width:100%; border-collapse:collapse; margin-top:10px;">';
        html += '<tr style="background:#2d3748; color:white;"><th>ุงููุนูู</th><th>ุญุตุต</th><th>ุงูุชุธุงุฑ</th><th>ุงููุฌููุน</th><th>ุงูุญุงูุฉ</th></tr>';
        
        for (let i = 0; i < 42; i++) {
            let name = document.getElementById(`teacher_${i}`).value;
            if (!name) continue;

            let c = 0, w = 0;
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    let v = document.getElementById(`cell_${i}_${d}_${p}`).value;
                    if(v === 'ูููู') continue;
                    if(v.startsWith('ุงูุชุธุงุฑ')) w++;
                    else if(v) c++;
                }
            });

            let total = c + w;
            let rowClass = total >= 20 ? 'stats-ok' : 'stats-low';
            html += `<tr class="${rowClass}"><td>${name}</td><td>${c}</td><td>${w}</td><td>${total}</td><td>${total >= 20 ? 'โ ููุชูู' : 'โ๏ธ ูุงูุต'}</td></tr>`;
        }
        html += '</table>';
        document.getElementById('statsTableContainer').innerHTML = html;
    }

    function clearOnlyWaiting(confirmAction = true) {
        if (confirmAction && !confirm("ูู ุชุฑูุฏ ูุณุญ ุฎุงูุงุช ุงูุงูุชุธุงุฑ ููุทุ")) return;
        for (let i = 0; i < 42; i++) {
            days.forEach(day => {
                for (let p = 1; p <= 7; p++) {
                    let cell = document.getElementById(`cell_${i}_${day}_${p}`);
                    if (cell.value.startsWith('ุงูุชุธุงุฑ')) {
                        cell.value = '';
                        cell.parentElement.classList.remove('waiting-cell-assigned');
                    }
                }
            });
        }
        renderStatsTable();
    }

    // ููุงุญุธุฉ: ุจููุฉ ุงูุฏูุงู ุงูุฃุตููุฉ (ุชูููุฏ ุงูุฌุฏููุ ุงูุญูุธุ Firebase) ุชุจูู ููุง ูู 
    // ูุถูุงู ุงุณุชูุฑุงุฑ ุงูููู.
</script>
</body>
</html>
