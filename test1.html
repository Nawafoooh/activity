<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ø³Ù‚Ù 20 Ø­ØµØ©</title>
    <style>
        :root { --primary: #2d3748; --accent: #3182ce; --success: #48bb78; --danger: #f56565; --bg: #f7fafc; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: var(--bg); padding: 20px; }
        .container { max-width: 100%; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        .toolbar { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-auto { background: #5a67d8; }
        .btn-clear { background: var(--danger); }
        .btn-save { background: var(--accent); }
        .btn-print { background: var(--success); }

        table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
        th, td { border: 1px solid #cbd5e0; padding: 4px; text-align: center; }
        th { background: var(--primary); color: white; height: 35px; }
        .day-header { background: #4a5568; font-size: 12px; }
        
        input[type="text"] { width: 100%; border: 1px solid transparent; text-align: center; padding: 4px; font-size: 11px; }
        input[type="text"]:focus { border-color: var(--accent); outline: none; background: #ebf8ff; }
        .teacher-name-cell { background: #edf2f7; font-weight: bold; width: 120px; }
        
        .waiting-cell { background-color: #ebf8ff !important; color: #2b6cb0; font-weight: bold; }
        .dummy-cell { background: #fed7d7 !important; color: #9b2c2c; }
        
        #statsContainer { margin-top: 30px; padding: 20px; background: #fdfdfd; border: 1px solid #e2e8f0; border-radius: 8px; }
        .stats-table { font-size: 13px; }
        .stats-ok { background: #c6f6d5 !important; }
        .stats-low { background: #fed7d7 !important; }

        @media print { .toolbar, .no-print { display: none !important; } .container { box-shadow: none; border: none; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p>ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„ Ù†ØµØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù… Ø¥Ù„Ù‰ 20 Ø­ØµØ©</p>
    </div>

    <div class="toolbar">
        <button class="btn btn-auto" onclick="smartDistribute()">âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø³Ù‚Ù 20)</button>
        <button class="btn btn-clear" onclick="clearWaiting()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
        <button class="btn btn-save" onclick="saveToLocal()">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­</button>
        <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="mainSchedule">
            <thead>
                <tr>
                    <th rowspan="2" width="120">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                    <th colspan="7" class="day-header">Ø§Ù„Ø£Ø­Ø¯</th>
                    <th colspan="7" class="day-header">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</th>
                    <th colspan="7" class="day-header">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</th>
                    <th colspan="7" class="day-header">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</th>
                    <th colspan="7" class="day-header">Ø§Ù„Ø®Ù…ÙŠØ³</th>
                </tr>
                <tr id="periodsRow"></tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
        </table>
    </div>

    <div id="statsContainer">
        <h3>ğŸ“Š Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†ØµØ§Ø¨ ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø§Ù„Ù‡Ø¯Ù 20)</h3>
        <div id="statsOutput"></div>
    </div>
</div>

<script>
    const days = ['sun', 'mon', 'tue', 'wed', 'thu'];
    const MAX_TEACHERS = 42;
    const TARGET_LOAD = 20;

    // 1. ØªÙˆÙ„ÙŠØ¯ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
    function initTable() {
        const periodsRow = document.getElementById('periodsRow');
        const body = document.getElementById('scheduleBody');
        
        // ØªÙˆÙ„ÙŠØ¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ØµØµ
        for(let d=0; d<5; d++) {
            for(let p=1; p<=7; p++) {
                periodsRow.innerHTML += `<th>${p}</th>`;
            }
        }

        // ØªÙˆÙ„ÙŠØ¯ ØµÙÙˆÙ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
        for(let i=0; i<MAX_TEACHERS; i++) {
            let row = `<tr><td><input type="text" id="t_name_${i}" class="teacher-name-cell" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… ${i+1}" onchange="updateLiveStats()"></td>`;
            days.forEach(day => {
                for(let p=1; p<=7; p++) {
                    row += `<td><input type="text" id="cell_${i}_${day}_${p}" onchange="updateLiveStats()"></td>`;
                }
            });
            row += `</tr>`;
            body.innerHTML += row;
        }
        loadFromLocal();
    }

    // 2. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø°ÙƒÙŠ (Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯)
    function smartDistribute() {
        if(!confirm("Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±Ø§Øª Ù„Ø¥ÙƒÙ…Ø§Ù„ Ù†ØµØ§Ø¨ ÙƒÙ„ Ù…Ø¹Ù„Ù… Ø¥Ù„Ù‰ 20 Ø­ØµØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
        
        clearWaiting(false); // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹

        let teachers = [];
        for(let i=0; i<MAX_TEACHERS; i++) {
            let name = document.getElementById(`t_name_${i}`).value.trim();
            if(name) {
                teachers.push({ id: i, name: name, load: countTeacherLoad(i) });
            }
        }

        let changesMade = true;
        while(changesMade) {
            changesMade = false;
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù†ØµØ§Ø¨Ø§Ù‹ Ù„Ù„Ø£Ø¹Ù„Ù‰
            teachers.sort((a, b) => a.load - b.load);

            for(let t of teachers) {
                if(t.load >= TARGET_LOAD) continue;

                let foundGap = false;
                for(let d of days) {
                    for(let p=1; p<=7; p++) {
                        let cell = document.getElementById(`cell_${t.id}_${d}_${p}`);
                        if(!cell.value) { // Ø§Ù„Ø®Ù„ÙŠØ© ÙØ§Ø±ØºØ©
                            
                            // ÙØ­Øµ ÙƒÙ… Ù…Ø¹Ù„Ù… Ø£Ø®Ø° Ø§Ù†ØªØ¸Ø§Ø± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­ØµØ© (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 5)
                            let currentWaitCount = 0;
                            for(let j=0; j<MAX_TEACHERS; j++) {
                                let otherVal = document.getElementById(`cell_${j}_${d}_${p}`).value;
                                if(otherVal.startsWith('Ø§Ù†ØªØ¸Ø§Ø±')) currentWaitCount++;
                            }

                            if(currentWaitCount < 5) {
                                cell.value = `Ø§Ù†ØªØ¸Ø§Ø±${currentWaitCount + 1}`;
                                cell.classList.add('waiting-cell');
                                t.load++;
                                changesMade = true;
                                foundGap = true;
                                break;
                            }
                        }
                    }
                    if(foundGap) break;
                }
            }
        }
        updateLiveStats();
        alert("ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
    }

    // 3. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    function countTeacherLoad(idx) {
        let count = 0;
        days.forEach(d => {
            for(let p=1; p<=7; p++) {
                let v = document.getElementById(`cell_${idx}_${d}_${p}`).value;
                if(v && v !== 'ÙˆÙ‡Ù…ÙŠ') count++;
            }
        });
        return count;
    }

    function updateLiveStats() {
        let html = `<table class="stats-table"><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø£Ø³Ø§Ø³ÙŠ</th><th>Ø§Ù†ØªØ¸Ø§Ø±</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>`;
        for(let i=0; i<MAX_TEACHERS; i++) {
            let name = document.getElementById(`t_name_${i}`).value;
            if(!name) continue;

            let basic = 0, wait = 0;
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    let v = document.getElementById(`cell_${i}_${d}_${p}`).value;
                    if(v === 'ÙˆÙ‡Ù…ÙŠ') continue;
                    if(v.startsWith('Ø§Ù†ØªØ¸Ø§Ø±')) wait++;
                    else if(v) basic++;
                }
            });

            let total = basic + wait;
            let rowClass = total >= TARGET_LOAD ? 'stats-ok' : 'stats-low';
            html += `<tr class="${rowClass}"><td>${name}</td><td>${basic}</td><td>${wait}</td><td><b>${total}</b></td><td>${total >= 20 ? 'âœ… Ù…ÙƒØªÙ…Ù„' : 'âš ï¸ Ù†Ø§Ù‚Øµ ('+(20-total)+')'}</td></tr>`;
        }
        html += `</table>`;
        document.getElementById('statsOutput').innerHTML = html;
    }

    function clearWaiting(confirmReq = true) {
        if(confirmReq && !confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙÙ‚Ø·ØŸ")) return;
        for(let i=0; i<MAX_TEACHERS; i++) {
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    let cell = document.getElementById(`cell_${i}_${d}_${p}`);
                    if(cell.value.startsWith('Ø§Ù†ØªØ¸Ø§Ø±')) {
                        cell.value = '';
                        cell.classList.remove('waiting-cell');
                    }
                }
            });
        }
        updateLiveStats();
    }

    function saveToLocal() {
        let data = {};
        for(let i=0; i<MAX_TEACHERS; i++) {
            data[`n_${i}`] = document.getElementById(`t_name_${i}`).value;
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    data[`c_${i}_${d}_${p}`] = document.getElementById(`cell_${i}_${d}_${p}`).value;
                }
            });
        }
        localStorage.setItem('school_data_v1', JSON.stringify(data));
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­!");
    }

    function loadFromLocal() {
        let raw = localStorage.getItem('school_data_v1');
        if(!raw) return;
        let data = JSON.parse(raw);
        for(let i=0; i<MAX_TEACHERS; i++) {
            document.getElementById(`t_name_${i}`).value = data[`n_${i}`] || '';
            days.forEach(d => {
                for(let p=1; p<=7; p++) {
                    let val = data[`c_${i}_${d}_${p}`] || '';
                    let cell = document.getElementById(`cell_${i}_${d}_${p}`);
                    cell.value = val;
                    if(val.startsWith('Ø§Ù†ØªØ¸Ø§Ø±')) cell.classList.add('waiting-cell');
                }
            });
        }
        updateLiveStats();
    }

    window.onload = initTable;
</script>

</body>
</html>
